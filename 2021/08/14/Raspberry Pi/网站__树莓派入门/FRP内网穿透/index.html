<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="地址："><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>FRP内网穿透 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Raspberry-Pi/" rel="tag">Raspberry Pi</a></div><div class="post-time">2021-08-14</div></div></div><div class="container post-header"><h1>FRP内网穿透</h1></div><div class="container post-content"><p>地址：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://learnku.com/articles/54013">https://learnku.com/articles/54013</a></li>
<li><a target="_blank" rel="noopener" href="https://chinsyo.com/2019/08/10/ssh-connect-raspberry-pi-anywhere/">https://chinsyo.com/2019/08/10/ssh-connect-raspberry-pi-anywhere/</a></li>
<li><a target="_blank" rel="noopener" href="https://mond.top/raspberrypi/shu-mei-pai-a-li-yun-zhu-ji-frp-nei-wang-chuan-tou/">https://mond.top/raspberrypi/shu-mei-pai-a-li-yun-zhu-ji-frp-nei-wang-chuan-tou/</a></li>
</ul>
<p>首先分别查看服务器和树莓派的系统架构。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Server</span></span><br><span class="line">$ uname -a</span><br><span class="line">Linux VM-0-2-ubuntu 4.4.0-148-generic <span class="comment">#174-Ubuntu SMP Tue May 7 12:20:14 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Raspberry Pi</span></span><br><span class="line">$ uname -a</span><br><span class="line">Linux raspberrypi 4.19.57-v7+ <span class="comment">#1244 SMP Thu Jul 4 18:45:25 BST 2019 armv7l GNU/Linux</span></span><br></pre></td></tr></table></figure>

<p>访问FRP的<a target="_blank" rel="noopener" href="https://github.com/fatedier/frp/releases">release页面</a>查看对应架构的最新版下载地址，在服务器和树莓派分别下载并解压。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p app/install &amp; <span class="built_in">cd</span> app/install</span><br><span class="line">$ wget https://github.com/fatedier/frp/releases/download/v0.28.2/frp_0.28.2_linux_arm.tar.gz</span><br><span class="line">$ tar -zxvf frp_0.28.2_linux_arm.tar.gz </span><br><span class="line">$ sudo mv frp_0.28.2_linux_arm /usr/<span class="built_in">local</span>/frp</span><br></pre></td></tr></table></figure>

<p>以上步骤服务器和树莓派一致，上面的示例是针对树莓派3B+的armv7l架构，服务器注意替换为amd64的下载链接。</p>
<p>接下来需要修改配置文件，树莓派配置文件为frpc.ini，服务器配置文件为frps.ini，对应C/S架构中的服务端和客户端。服务器采用默认配置，树莓派将表示服务器地址的<code>x.x.x.x</code>替换为实际地址。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># frps.ini</span></span><br><span class="line"><span class="section">[common]</span></span><br><span class="line"><span class="attr">bind_port</span> = <span class="number">7000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># frpc.ini</span></span><br><span class="line"><span class="section">[common]</span></span><br><span class="line"><span class="attr">server_addr</span> = x.x.x.x</span><br><span class="line"><span class="attr">server_port</span> = <span class="number">7000</span></span><br><span class="line"><span class="section">[ssh]</span></span><br><span class="line"><span class="attr">type</span> = tcp</span><br><span class="line"><span class="attr">local_ip</span> = <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">local_port</span> = <span class="number">22</span></span><br><span class="line"><span class="attr">remote_port</span> = <span class="number">6000</span></span><br></pre></td></tr></table></figure>

<p>树莓派开放端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ufw allow 6000</span><br><span class="line">sudo ufw allow 7000</span><br></pre></td></tr></table></figure>

<p>接着切换到上面的工作路径<code>/usr/local/frp</code>，服务端执行<code>./frps -c frps.ini</code>，树莓派执行<code>./frpc -c ./frpc.ini</code>。</p>
<p>电脑打开ZSH，或手机打开Termius，<code>ssh -oPort=6000 pi@x.x.x.x</code>测试我们的连接。注意这里pi代表在树莓派上的用户名，而x.x.x.x代表服务器的IP地址，正常情况下这个时候你会看到熟悉的Linux登录成功提示。</p>
<p>可我没有，转念一想，应该是防火墙的问题。前往腾讯云的控制台，在安全组中添加以下两条：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0.0.0.0/0 TCP:6000</span><br><span class="line">0.0.0.0/0 TCP:7000</span><br></pre></td></tr></table></figure>

<p>再次测试ssh连接，终于见到了熟悉的Linux登录成功提示。</p>
<p>到此为止已经实现了随时随地SSH连接家中的树莓派，通过下面的命令可以后台运行并记录日志。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Server</span></span><br><span class="line">nohup ./frps -c ./frps.ini &gt; frps.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Raspberry Pi</span></span><br><span class="line">nohup ./frpc -c ./frpc.ini &gt; frpc.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>



<p>出于安全考虑，可以在服务器和树莓派的配置文件中增加token字段，服务器和树莓派的token字段需要保持一致。建议生成随机数或伪随机数，我最终采用的是<code>date | md5 | head -c 8</code>的输出结果。</p>
<p>由于暴躁的我常常出于无法忍受树莓派的噪音而关机，有必要将FRP加入开机启动。</p>
<p>首先创建service：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/systemd/system/frpc.service</span><br><span class="line"><span class="comment"># /etc/systemd/system/frpc.service</span></span><br><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=frpc</span><br><span class="line"><span class="attr">After</span>=network.target</span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">TimeoutStartSec</span>=<span class="number">30</span></span><br><span class="line"><span class="attr">WorkingDirectory</span>=/usr/local/frp</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/frp/frpc -c /usr/local/frp/frpc.ini</span><br><span class="line"><span class="attr">Restart</span>=<span class="literal">on</span>-failure</span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>

<p>服务器和树莓派配置过程相同，服务器只需要将frpc替换为frps即可。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 刷新服务</span></span><br><span class="line">sudo systemctl deamon-reload</span><br><span class="line"><span class="comment"># 允许开机启动</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> frpc.service</span><br><span class="line"><span class="comment"># 运行服务</span></span><br><span class="line">sudo systemctl start frpc.service</span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">sudo systemctl status frpc.service</span><br></pre></td></tr></table></figure>

<p>到这里开机启动也设置完毕了，树莓派远程吃灰的玩法等你开发。:)</p>
<p>me:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -oPort=6000 pi@119.29.177.15</span><br></pre></td></tr></table></figure>

</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>