<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="gure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;go get github.com/fsnotify/fsnotify&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; main;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&amp;quot;github.com/fsnotify/fsnotify&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&amp;quot;log&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&amp;quot;fmt&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//创建一个监控对象&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    watch, err := fsnotify.NewWatcher();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        log.Fatal(err);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; watch.Close();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//添加要监控的对象，文件或文件夹&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    err = watch.Add(&lt;span class=&quot;string&quot;&gt;&amp;quot;./tmp&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        log.Fatal(err);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//我们另启一个goroutine来处理监控对象的事件&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;select&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; ev := &amp;lt;-watch.Events:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;comment&quot;&gt;//判断事件发生的类型，如下5种&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;comment&quot;&gt;// Create 创建&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;comment&quot;&gt;// Write 写入&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;comment&quot;&gt;// Remove 删除&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;comment&quot;&gt;// Rename 重命名&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;comment&quot;&gt;// Chmod 修改权限&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ev.Op&amp;amp;fsnotify.Create == fsnotify.Create &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        log.Println(&lt;span class=&quot;string&quot;&gt;&amp;quot;创建文件 : &amp;quot;&lt;/span&gt;, ev.Name);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ev.Op&amp;amp;fsnotify.Write == fsnotify.Write &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        log.Println(&lt;span class=&quot;string&quot;&gt;&amp;quot;写入文件 : &amp;quot;&lt;/span&gt;, ev.Name);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ev.Op&amp;amp;fsnotify.Remove == fsnotify.Remove &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        log.Println(&lt;span class=&quot;string&quot;&gt;&amp;quot;删除文件 : &amp;quot;&lt;/span&gt;, ev.Name);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ev.Op&amp;amp;fsnotify.Rename == fsnotify.Rename &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        log.Println(&lt;span class=&quot;string&quot;&gt;&amp;quot;重命名文件 : &amp;quot;&lt;/span&gt;, ev.Name);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ev.Op&amp;amp;fsnotify.Chmod == fsnotify.Chmod &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        log.Println(&lt;span class=&quot;string&quot;&gt;&amp;quot;修改权限 : &amp;quot;&lt;/span&gt;, ev.Name);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;case&lt;/span&gt; err := &amp;lt;-watch.Errors:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    log.Println(&lt;span class=&quot;string&quot;&gt;&amp;quot;error : &amp;quot;&lt;/span&gt;, err);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//循环&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;select&lt;/span&gt; &amp;#123;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;fsnotify有一个问题，它无法递归的帮我们捕捉子目录、孙子目录的操作事件，这需要我们自已来实现。"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>fsnotify | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Golang/" rel="tag">Golang</a></div><div class="post-time">2021-08-20</div></div></div><div class="container post-header"><h1>fsnotify</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E7%BA%A7%E7%9B%91%E6%8E%A7"><span class="toc-number">1.</span> <span class="toc-text">多级监控</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%86%99%E7%9A%84%E7%9B%91%E6%8E%A7%E5%92%8C%E5%9B%9E%E8%B0%83%E6%9C%BA%E5%88%B6"><span class="toc-number">2.</span> <span class="toc-text">自写的监控和回调机制</span></a></li></ol></details></div><div class="container post-content"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/fsnotify/fsnotify</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;github.com/fsnotify/fsnotify&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//创建一个监控对象</span></span><br><span class="line">    watch, err := fsnotify.NewWatcher();</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> watch.Close();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加要监控的对象，文件或文件夹</span></span><br><span class="line">    err = watch.Add(<span class="string">&quot;./tmp&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//我们另启一个goroutine来处理监控对象的事件</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> &#123;</span><br><span class="line">            <span class="keyword">select</span> &#123;</span><br><span class="line">            <span class="keyword">case</span> ev := &lt;-watch.Events:</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//判断事件发生的类型，如下5种</span></span><br><span class="line">                    <span class="comment">// Create 创建</span></span><br><span class="line">                    <span class="comment">// Write 写入</span></span><br><span class="line">                    <span class="comment">// Remove 删除</span></span><br><span class="line">                    <span class="comment">// Rename 重命名</span></span><br><span class="line">                    <span class="comment">// Chmod 修改权限</span></span><br><span class="line">                    <span class="keyword">if</span> ev.Op&amp;fsnotify.Create == fsnotify.Create &#123;</span><br><span class="line">                        log.Println(<span class="string">&quot;创建文件 : &quot;</span>, ev.Name);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ev.Op&amp;fsnotify.Write == fsnotify.Write &#123;</span><br><span class="line">                        log.Println(<span class="string">&quot;写入文件 : &quot;</span>, ev.Name);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ev.Op&amp;fsnotify.Remove == fsnotify.Remove &#123;</span><br><span class="line">                        log.Println(<span class="string">&quot;删除文件 : &quot;</span>, ev.Name);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ev.Op&amp;fsnotify.Rename == fsnotify.Rename &#123;</span><br><span class="line">                        log.Println(<span class="string">&quot;重命名文件 : &quot;</span>, ev.Name);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ev.Op&amp;fsnotify.Chmod == fsnotify.Chmod &#123;</span><br><span class="line">                        log.Println(<span class="string">&quot;修改权限 : &quot;</span>, ev.Name);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">case</span> err := &lt;-watch.Errors:</span><br><span class="line">                &#123;</span><br><span class="line">                    log.Println(<span class="string">&quot;error : &quot;</span>, err);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;();</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//循环</span></span><br><span class="line">    <span class="keyword">select</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>fsnotify有一个问题，它无法递归的帮我们捕捉子目录、孙子目录的操作事件，这需要我们自已来实现。</p>
<p>还有一个问题就是当们修改文件夹名称时，fsnotify中event.Name仍然是原来的文件名，这就需要我们在重命名事件中，先移除之前的监控，然后添加新的监控。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;github.com/fsnotify/fsnotify&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;path/filepath&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">type</span> Watch <span class="keyword">struct</span> &#123;</span><br><span class="line">    watch *fsnotify.Watcher;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//监控目录</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *Watch)</span> <span class="title">watchDir</span><span class="params">(dir <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">//通过Walk来遍历目录下的所有子目录</span></span><br><span class="line">    filepath.Walk(dir, <span class="function"><span class="keyword">func</span><span class="params">(path <span class="keyword">string</span>, info os.FileInfo, err error)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">        <span class="comment">//这里判断是否为目录，只需监控目录即可</span></span><br><span class="line">        <span class="comment">//目录下的文件也在监控范围内，不需要我们一个一个加</span></span><br><span class="line">        <span class="keyword">if</span> info.IsDir() &#123;</span><br><span class="line">            path, err := filepath.Abs(path);</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> err;</span><br><span class="line">            &#125;</span><br><span class="line">            err = w.watch.Add(path);</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> err;</span><br><span class="line">            &#125;</span><br><span class="line">            fmt.Println(<span class="string">&quot;监控 : &quot;</span>, path);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> &#123;</span><br><span class="line">            <span class="keyword">select</span> &#123;</span><br><span class="line">            <span class="keyword">case</span> ev := &lt;-w.watch.Events:</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> ev.Op&amp;fsnotify.Create == fsnotify.Create &#123;</span><br><span class="line">                        fmt.Println(<span class="string">&quot;创建文件 : &quot;</span>, ev.Name);</span><br><span class="line">                        <span class="comment">//这里获取新创建文件的信息，如果是目录，则加入监控中</span></span><br><span class="line">                        fi, err := os.Stat(ev.Name);</span><br><span class="line">                        <span class="keyword">if</span> err == <span class="literal">nil</span> &amp;&amp; fi.IsDir() &#123;</span><br><span class="line">                            w.watch.Add(ev.Name);</span><br><span class="line">                            fmt.Println(<span class="string">&quot;添加监控 : &quot;</span>, ev.Name);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ev.Op&amp;fsnotify.Write == fsnotify.Write &#123;</span><br><span class="line">                        fmt.Println(<span class="string">&quot;写入文件 : &quot;</span>, ev.Name);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ev.Op&amp;fsnotify.Remove == fsnotify.Remove &#123;</span><br><span class="line">                        fmt.Println(<span class="string">&quot;删除文件 : &quot;</span>, ev.Name);</span><br><span class="line">                        <span class="comment">//如果删除文件是目录，则移除监控</span></span><br><span class="line">                        fi, err := os.Stat(ev.Name);</span><br><span class="line">                        <span class="keyword">if</span> err == <span class="literal">nil</span> &amp;&amp; fi.IsDir() &#123;</span><br><span class="line">                            w.watch.Remove(ev.Name);</span><br><span class="line">                            fmt.Println(<span class="string">&quot;删除监控 : &quot;</span>, ev.Name);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ev.Op&amp;fsnotify.Rename == fsnotify.Rename &#123;</span><br><span class="line">                        fmt.Println(<span class="string">&quot;重命名文件 : &quot;</span>, ev.Name);</span><br><span class="line">                        <span class="comment">//如果重命名文件是目录，则移除监控</span></span><br><span class="line">                        <span class="comment">//注意这里无法使用os.Stat来判断是否是目录了</span></span><br><span class="line">                        <span class="comment">//因为重命名后，go已经无法找到原文件来获取信息了</span></span><br><span class="line">                        <span class="comment">//所以这里就简单粗爆的直接remove好了</span></span><br><span class="line">                        w.watch.Remove(ev.Name);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ev.Op&amp;fsnotify.Chmod == fsnotify.Chmod &#123;</span><br><span class="line">                        fmt.Println(<span class="string">&quot;修改权限 : &quot;</span>, ev.Name);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">case</span> err := &lt;-w.watch.Errors:</span><br><span class="line">                &#123;</span><br><span class="line">                    fmt.Println(<span class="string">&quot;error : &quot;</span>, err);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    watch, _ := fsnotify.NewWatcher()</span><br><span class="line">    w := Watch&#123;</span><br><span class="line">        watch: watch,</span><br><span class="line">    &#125;</span><br><span class="line">    w.watchDir(<span class="string">&quot;./tmp&quot;</span>);</span><br><span class="line">    <span class="keyword">select</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>server.go代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;github.com/fsnotify/fsnotify&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;os/exec&quot;</span></span><br><span class="line">    <span class="string">&quot;regexp&quot;</span></span><br><span class="line">    <span class="string">&quot;strconv&quot;</span></span><br><span class="line">    <span class="string">&quot;bytes&quot;</span></span><br><span class="line">    <span class="string">&quot;errors&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    <span class="string">&quot;path/filepath&quot;</span></span><br><span class="line">)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    confFilePath = <span class="string">&quot;./conf&quot;</span>;</span><br><span class="line">)</span><br><span class="line"> </span><br><span class="line"><span class="comment">//获取进程ID</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getPid</span><span class="params">(processName <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">//通过wmic process get name,processid | findstr server.exe获取进程ID</span></span><br><span class="line">    buf := bytes.Buffer&#123;&#125;;</span><br><span class="line">    cmd := exec.Command(<span class="string">&quot;wmic&quot;</span>, <span class="string">&quot;process&quot;</span>, <span class="string">&quot;get&quot;</span>, <span class="string">&quot;name,processid&quot;</span>);</span><br><span class="line">    cmd.Stdout = &amp;buf;</span><br><span class="line">    cmd.Run();</span><br><span class="line">    cmd2 := exec.Command(<span class="string">&quot;findstr&quot;</span>, processName);</span><br><span class="line">    cmd2.Stdin = &amp;buf;</span><br><span class="line">    data, _ := cmd2.CombinedOutput();</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(data) == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>, errors.New(<span class="string">&quot;not find&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    info := <span class="keyword">string</span>(data);</span><br><span class="line">    <span class="comment">//这里通过正则把进程id提取出来</span></span><br><span class="line">    reg := regexp.MustCompile(<span class="string">`[0-9]+`</span>);</span><br><span class="line">    pid := reg.FindString(info);</span><br><span class="line">    <span class="keyword">return</span> strconv.Atoi(pid);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//启动进程</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startProcess</span><span class="params">(exePath <span class="keyword">string</span>, args []<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    attr := &amp;os.ProcAttr&#123;</span><br><span class="line">        <span class="comment">//files指定新进程继承的活动文件对象</span></span><br><span class="line">        <span class="comment">//前三个分别为，标准输入、标准输出、标准错误输出</span></span><br><span class="line">        Files: []*os.File&#123;os.Stdin, os.Stdout, os.Stderr&#125;,</span><br><span class="line">        <span class="comment">//新进程的环境变量</span></span><br><span class="line">        Env: os.Environ(),</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    p, err := os.StartProcess(exePath, args, attr);</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(exePath, <span class="string">&quot;进程启动&quot;</span>);</span><br><span class="line">    p.Wait();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//创建一个监控对象</span></span><br><span class="line">    watch, err := fsnotify.NewWatcher();</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> watch.Close();</span><br><span class="line">    <span class="comment">//添加要监控的文件</span></span><br><span class="line">    err = watch.Add(confFilePath);</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//我们另启一个goroutine来处理监控对象的事件</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> &#123;</span><br><span class="line">            <span class="keyword">select</span> &#123;</span><br><span class="line">            <span class="keyword">case</span> ev := &lt;-watch.Events:</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//我们只需关心文件的修改</span></span><br><span class="line">                    <span class="keyword">if</span> ev.Op&amp;fsnotify.Write == fsnotify.Write &#123;</span><br><span class="line">                        fmt.Println(ev.Name, <span class="string">&quot;文件写入&quot;</span>);</span><br><span class="line">                        <span class="comment">//查找进程</span></span><br><span class="line">                        pid, err := getPid(<span class="string">&quot;server.exe&quot;</span>);</span><br><span class="line">                        <span class="comment">//获取运行文件的绝对路径</span></span><br><span class="line">                        exePath, _ := filepath.Abs(<span class="string">&quot;./server.exe&quot;</span>)</span><br><span class="line">                        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                            <span class="comment">//启动进程</span></span><br><span class="line">                            <span class="keyword">go</span> startProcess(exePath, []<span class="keyword">string</span>&#123;&#125;);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">//找到进程，并退出</span></span><br><span class="line">                            process, err := os.FindProcess(pid);</span><br><span class="line">                            <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">                                <span class="comment">//让进程退出</span></span><br><span class="line">                                process.Kill();</span><br><span class="line">                                fmt.Println(exePath, <span class="string">&quot;进程退出&quot;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">//启动进程</span></span><br><span class="line">                            <span class="keyword">go</span> startProcess(exePath, []<span class="keyword">string</span>&#123;&#125;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">case</span> err := &lt;-watch.Errors:</span><br><span class="line">                &#123;</span><br><span class="line">                    fmt.Println(<span class="string">&quot;error : &quot;</span>, err);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;();</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//循环</span></span><br><span class="line">    <span class="keyword">select</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="多级监控"><a href="#多级监控" class="headerlink" title="多级监控"></a>多级监控</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> FSNotify</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/fsnotify/fsnotify&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;path/filepath&quot;</span></span><br><span class="line">)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">type</span> NotifyFile <span class="keyword">struct</span> &#123;</span><br><span class="line">	watch *fsnotify.Watcher</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewNotifyFile</span><span class="params">()</span> *<span class="title">NotifyFile</span></span> &#123;</span><br><span class="line">	w := <span class="built_in">new</span>(NotifyFile)</span><br><span class="line">	w.watch, _ = fsnotify.NewWatcher()</span><br><span class="line">	<span class="keyword">return</span> w</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//监控目录</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *NotifyFile)</span> <span class="title">WatchDir</span><span class="params">(dir <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="comment">//通过Walk来遍历目录下的所有子目录</span></span><br><span class="line">	filepath.Walk(dir, <span class="function"><span class="keyword">func</span><span class="params">(path <span class="keyword">string</span>, info os.FileInfo, err error)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		<span class="comment">//判断是否为目录，监控目录,目录下文件也在监控范围内，不需要加</span></span><br><span class="line">		<span class="keyword">if</span> info.IsDir() &#123;</span><br><span class="line">			path, err := filepath.Abs(path)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">			err = this.watch.Add(path)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">			fmt.Println(<span class="string">&quot;监控 : &quot;</span>, path)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;)</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">go</span> this.WatchEvent()</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *NotifyFile)</span> <span class="title">WatchEvent</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> ev := &lt;-this.watch.Events:</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> ev.Op&amp;fsnotify.Create == fsnotify.Create &#123;</span><br><span class="line">					fmt.Println(<span class="string">&quot;创建文件 : &quot;</span>, ev.Name)</span><br><span class="line">					<span class="comment">//获取新创建文件的信息，如果是目录，则加入监控中</span></span><br><span class="line">					file, err := os.Stat(ev.Name)</span><br><span class="line">					<span class="keyword">if</span> err == <span class="literal">nil</span> &amp;&amp; file.IsDir() &#123;</span><br><span class="line">						this.watch.Add(ev.Name)</span><br><span class="line">						fmt.Println(<span class="string">&quot;添加监控 : &quot;</span>, ev.Name)</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line"> </span><br><span class="line">				<span class="keyword">if</span> ev.Op&amp;fsnotify.Write == fsnotify.Write &#123;</span><br><span class="line">					<span class="comment">//fmt.Println(&quot;写入文件 : &quot;, ev.Name)</span></span><br><span class="line">				&#125;</span><br><span class="line"> </span><br><span class="line">				<span class="keyword">if</span> ev.Op&amp;fsnotify.Remove == fsnotify.Remove &#123;</span><br><span class="line">					fmt.Println(<span class="string">&quot;删除文件 : &quot;</span>, ev.Name)</span><br><span class="line">					<span class="comment">//如果删除文件是目录，则移除监控</span></span><br><span class="line">					fi, err := os.Stat(ev.Name)</span><br><span class="line">					<span class="keyword">if</span> err == <span class="literal">nil</span> &amp;&amp; fi.IsDir() &#123;</span><br><span class="line">						this.watch.Remove(ev.Name)</span><br><span class="line">						fmt.Println(<span class="string">&quot;删除监控 : &quot;</span>, ev.Name)</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line"> </span><br><span class="line">				<span class="keyword">if</span> ev.Op&amp;fsnotify.Rename == fsnotify.Rename &#123;</span><br><span class="line">					<span class="comment">//如果重命名文件是目录，则移除监控 ,注意这里无法使用os.Stat来判断是否是目录了</span></span><br><span class="line">					<span class="comment">//因为重命名后，go已经无法找到原文件来获取信息了,所以简单粗爆直接remove</span></span><br><span class="line">					fmt.Println(<span class="string">&quot;重命名文件 : &quot;</span>, ev.Name)</span><br><span class="line">					this.watch.Remove(ev.Name)</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> ev.Op&amp;fsnotify.Chmod == fsnotify.Chmod &#123;</span><br><span class="line">					fmt.Println(<span class="string">&quot;修改权限 : &quot;</span>, ev.Name)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">case</span> err := &lt;-this.watch.Errors:</span><br><span class="line">			&#123;</span><br><span class="line">				fmt.Println(<span class="string">&quot;error : &quot;</span>, err)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;CGO/FSNotify&quot;</span></span><br><span class="line">)</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"> </span><br><span class="line">	watch := FSNotify.NewNotifyFile()</span><br><span class="line">	watch.WatchDir(<span class="string">&quot;G:\\Ferry&quot;</span>)</span><br><span class="line">	<span class="keyword">select</span> &#123;&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="自写的监控和回调机制"><a href="#自写的监控和回调机制" class="headerlink" title="自写的监控和回调机制"></a>自写的监控和回调机制</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> fsnotify_test</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;path/filepath&quot;</span></span><br><span class="line">	<span class="string">&quot;sync&quot;</span></span><br><span class="line">	<span class="string">&quot;testing&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/fsnotify/fsnotify&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> eventMap *EventMap</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> WatchEvents <span class="keyword">struct</span> &#123;</span><br><span class="line">	events []fsnotify.Event</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> EventMap <span class="keyword">struct</span> &#123;</span><br><span class="line">	*sync.Mutex</span><br><span class="line">	m <span class="keyword">map</span>[<span class="keyword">string</span>]*WatchEvents</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewEventMap</span><span class="params">()</span> *<span class="title">EventMap</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;EventMap&#123;</span><br><span class="line">		Mutex: &amp;sync.Mutex&#123;&#125;,</span><br><span class="line">		m:     <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*WatchEvents, <span class="number">5</span>),</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(em *EventMap)</span> <span class="title">Append</span><span class="params">(event fsnotify.Event)</span></span> &#123;</span><br><span class="line">	em.Lock()</span><br><span class="line">	<span class="keyword">defer</span> em.Unlock()</span><br><span class="line">	name := event.Op.String()</span><br><span class="line">	<span class="keyword">if</span> _, ok := em.m[name]; !ok &#123;</span><br><span class="line">		em.m[name] = <span class="built_in">new</span>(WatchEvents)</span><br><span class="line">	&#125;</span><br><span class="line">	em.m[name].events = <span class="built_in">append</span>(em.m[name].events, event)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(em *EventMap)</span> <span class="title">GetFileList</span><span class="params">()</span> []<span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> fileList []<span class="keyword">string</span></span><br><span class="line">	files := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">struct</span>&#123;&#125;, <span class="number">0</span>)</span><br><span class="line">	em.Lock()</span><br><span class="line">	<span class="keyword">defer</span> em.Unlock()</span><br><span class="line">	<span class="keyword">for</span> _, events := <span class="keyword">range</span> em.m &#123;</span><br><span class="line">		<span class="keyword">for</span> _, event := <span class="keyword">range</span> events.events &#123;</span><br><span class="line">			<span class="keyword">if</span> _, exist := files[event.Name]; !exist &#123;</span><br><span class="line">				files[event.Name] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">				fileList = <span class="built_in">append</span>(fileList, event.Name)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> fileList</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(em *EventMap)</span> <span class="title">Clear</span><span class="params">()</span></span> &#123;</span><br><span class="line">	em.Lock()</span><br><span class="line">	<span class="keyword">defer</span> em.Unlock()</span><br><span class="line">	em.m = <span class="keyword">map</span>[<span class="keyword">string</span>]*WatchEvents&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(em *EventMap)</span> <span class="title">Copy</span><span class="params">()</span> *<span class="title">EventMap</span></span> &#123;</span><br><span class="line">	ret := NewEventMap()</span><br><span class="line">	<span class="keyword">for</span> k, v := <span class="keyword">range</span> em.m &#123;</span><br><span class="line">		ret.m[k] = v</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> FileWatcher <span class="keyword">struct</span> &#123;</span><br><span class="line">	watch           *fsnotify.Watcher</span><br><span class="line">	eventInputChan  <span class="keyword">chan</span> fsnotify.Event</span><br><span class="line">	eventOutputChan <span class="keyword">chan</span> *EventMap <span class="comment">// 消息整合</span></span><br><span class="line"></span><br><span class="line">	path            <span class="keyword">string</span></span><br><span class="line">	waitingPushTime time.Duration</span><br><span class="line">	callbackFunc    <span class="function"><span class="keyword">func</span><span class="params">(ch <span class="keyword">chan</span> *EventMap)</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewNotifyFile</span><span class="params">(path <span class="keyword">string</span>, waitingPushTime time.Duration, callbackFunc <span class="keyword">func</span>(ch <span class="keyword">chan</span> *EventMap)</span>) *<span class="title">FileWatcher</span></span> &#123;</span><br><span class="line">	watch, err := fsnotify.NewWatcher()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fw := &amp;FileWatcher&#123;</span><br><span class="line">		watch:           watch,</span><br><span class="line">		eventInputChan:  <span class="built_in">make</span>(<span class="keyword">chan</span> fsnotify.Event, <span class="number">100</span>),</span><br><span class="line">		eventOutputChan: <span class="built_in">make</span>(<span class="keyword">chan</span> *EventMap, <span class="number">1</span>), <span class="comment">// 在waitingPushTime内只发一条event</span></span><br><span class="line"></span><br><span class="line">		path:            path,</span><br><span class="line">		waitingPushTime: waitingPushTime,</span><br><span class="line">		callbackFunc:    callbackFunc,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">go</span> fw.callback()</span><br><span class="line">	<span class="keyword">return</span> fw</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fw *FileWatcher)</span> <span class="title">callback</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fw.callbackFunc(fw.eventOutputChan)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fw *FileWatcher)</span> <span class="title">pushEventMapToOutputChan</span><span class="params">()</span></span> &#123;</span><br><span class="line">	ticker := time.NewTicker(fw.waitingPushTime)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> <span class="keyword">range</span> ticker.C &#123;</span><br><span class="line">			e := eventMap.Copy()</span><br><span class="line">			fw.eventOutputChan &lt;- e</span><br><span class="line">			eventMap.Clear()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fw *FileWatcher)</span> <span class="title">collectEventToMap</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> event := &lt;-fw.eventInputChan:</span><br><span class="line">			eventMap.Append(event)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fw *FileWatcher)</span> <span class="title">WatchDir</span><span class="params">()</span></span> &#123;</span><br><span class="line">	filepath.Walk(fw.path, <span class="function"><span class="keyword">func</span><span class="params">(path <span class="keyword">string</span>, info os.FileInfo, err error)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		<span class="comment">// 因为目录下文件也在监控范围内，不需要加文件</span></span><br><span class="line">		<span class="keyword">if</span> info.IsDir() &#123;</span><br><span class="line">			path, err := filepath.Abs(path)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">			err = fw.watch.Add(path)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">			log.Println(<span class="string">&quot;[INFO] add watch: &quot;</span>, path)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">go</span> fw.pushEventMapToOutputChan()</span><br><span class="line">	<span class="keyword">go</span> fw.collectEventToMap()</span><br><span class="line">	<span class="keyword">go</span> fw.watchEvent()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fw *FileWatcher)</span> <span class="title">watchEvent</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> ev := &lt;-fw.watch.Events:</span><br><span class="line">			fw.eventInputChan &lt;- ev</span><br><span class="line">			<span class="keyword">if</span> ev.Op&amp;fsnotify.Create == fsnotify.Create &#123;</span><br><span class="line">				fw.onCreate(ev)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> ev.Op&amp;fsnotify.Write == fsnotify.Write &#123;</span><br><span class="line">				fw.onWrite(ev)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> ev.Op&amp;fsnotify.Remove == fsnotify.Remove &#123;</span><br><span class="line">				fw.onRemove(ev)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> ev.Op&amp;fsnotify.Rename == fsnotify.Rename &#123;</span><br><span class="line">				fw.onRename(ev)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> ev.Op&amp;fsnotify.Chmod == fsnotify.Chmod &#123;</span><br><span class="line">				fw.onChmod(ev)</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">case</span> err := &lt;-fw.watch.Errors:</span><br><span class="line">			fw.onError(err)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fw *FileWatcher)</span> <span class="title">onCreate</span><span class="params">(event fsnotify.Event)</span></span> &#123;</span><br><span class="line">	log.Println(<span class="string">&quot;[INFO] create: &quot;</span>, event.Name)</span><br><span class="line">	<span class="comment">// 获取新创建文件的信息，如果是目录，则加入监控中</span></span><br><span class="line">	file, err := os.Stat(event.Name)</span><br><span class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &amp;&amp; file.IsDir() &#123;</span><br><span class="line">		<span class="keyword">if</span> err := fw.watch.Add(event.Name); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(<span class="string">&quot;[WARN] add watch failed: &quot;</span>, event.Name)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		log.Println(<span class="string">&quot;[INFO] add watch: &quot;</span>, event.Name)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fw *FileWatcher)</span> <span class="title">onWrite</span><span class="params">(event fsnotify.Event)</span></span> &#123;</span><br><span class="line">	log.Println(<span class="string">&quot;[INFO] write: &quot;</span>, event.Name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fw *FileWatcher)</span> <span class="title">onRemove</span><span class="params">(event fsnotify.Event)</span></span> &#123;</span><br><span class="line">	log.Println(<span class="string">&quot;[INFO] remove: &quot;</span>, event.Name)</span><br><span class="line">	<span class="comment">// 如果删除文件是目录，则移除监控</span></span><br><span class="line">	fi, err := os.Stat(event.Name)</span><br><span class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &amp;&amp; fi.IsDir() &#123;</span><br><span class="line">		<span class="keyword">if</span> err := fw.watch.Remove(event.Name); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(<span class="string">&quot;[WARN] delete watch failed: &quot;</span>, event.Name)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		log.Println(<span class="string">&quot;[INFO] delete watch: &quot;</span>, event.Name)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fw *FileWatcher)</span> <span class="title">onRename</span><span class="params">(event fsnotify.Event)</span></span> &#123;</span><br><span class="line">	log.Println(<span class="string">&quot;[INFO] rename: &quot;</span>, event.Name)</span><br><span class="line">	<span class="comment">// 如果重命名文件是目录，则移除监控 ,注意这里无法使用os.Stat来判断是否是目录了</span></span><br><span class="line">	<span class="comment">// 因为重命名后，go已经无法找到原文件来获取信息了,所以简单粗爆直接remove</span></span><br><span class="line">	<span class="keyword">if</span> err := fw.watch.Remove(event.Name); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(<span class="string">&quot;[WARN] delete watch failed: &quot;</span>, event.Name)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fw *FileWatcher)</span> <span class="title">onChmod</span><span class="params">(event fsnotify.Event)</span></span> &#123;</span><br><span class="line">	log.Println(<span class="string">&quot;[INFO] chmod: &quot;</span>, event.Name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fw *FileWatcher)</span> <span class="title">onError</span><span class="params">(err error)</span></span> &#123;</span><br><span class="line">	log.Println(<span class="string">&quot;[ERROR] watcher on error: &quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	eventMap = NewEventMap()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestFsNotify</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	waitingTime := <span class="number">10</span> * time.Second</span><br><span class="line">	path := <span class="string">&quot;/Users/heyingliang/Dropbox/root/md&quot;</span></span><br><span class="line">	f := <span class="function"><span class="keyword">func</span><span class="params">(ch <span class="keyword">chan</span> *EventMap)</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> em := <span class="keyword">range</span> ch &#123;</span><br><span class="line">			files := em.GetFileList()</span><br><span class="line">			fmt.Println(time.Now(), files)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	watcher := NewNotifyFile(path, waitingTime, f)</span><br><span class="line">	watcher.WatchDir()</span><br><span class="line">	<span class="keyword">select</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>