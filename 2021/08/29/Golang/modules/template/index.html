<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;模版语法&quot;&gt;&lt;a href=&quot;#模版语法&quot; class=&quot;headerlink&quot; title=&quot;模版语法&quot;&gt;&lt;/a&gt;模版语法&lt;/h1&gt;&lt;h2 id=&quot;变量&quot;&gt;&lt;a href=&quot;#变量&quot; class=&quot;headerlink&quot; title=&quot;变量&quot;&gt;&lt;/a&gt;变量&lt;/h2&gt;&lt;p&gt;渲染template的时候，有两个常用的传入参数的类型。"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>template | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Golang/" rel="tag">Golang</a></div><div class="post-time">2021-08-29</div></div></div><div class="container post-header"><h1>template</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A8%A1%E7%89%88%E8%AF%AD%E6%B3%95"><span class="toc-number">1.</span> <span class="toc-text">模版语法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%98%E9%87%8F"><span class="toc-number">1.1.</span> <span class="toc-text">变量</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F"><span class="toc-number">1.1.1.</span> <span class="toc-text">定义变量</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.</span> <span class="toc-text">函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.2.1.</span> <span class="toc-text">示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A4%E6%96%AD"><span class="toc-number">1.3.</span> <span class="toc-text">判断</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E7%9A%84%E6%A8%A1%E6%9D%BF%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.1.</span> <span class="toc-text">内置的模板函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AF"><span class="toc-number">1.4.</span> <span class="toc-text">循环</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%B4%A2%E5%BC%95%E5%80%BC"><span class="toc-number">1.4.1.</span> <span class="toc-text">获取索引值</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF%E7%9A%84%E5%B5%8C%E5%A5%97"><span class="toc-number">1.5.</span> <span class="toc-text">模板的嵌套</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E5%92%8C%E5%88%9B%E5%BB%BA%E6%A8%A1%E6%9D%BF"><span class="toc-number">2.</span> <span class="toc-text">解析和创建模板</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%A8%A1%E6%9D%BF"><span class="toc-number">2.0.1.</span> <span class="toc-text">创建模板</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E5%A4%9A%E4%B8%AA%E6%A8%A1%E6%9D%BF"><span class="toc-number">2.0.2.</span> <span class="toc-text">解析多个模板</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%A8%A1%E6%9D%BF"><span class="toc-number">2.0.3.</span> <span class="toc-text">解析字符串模板</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-1"><span class="toc-number">3.</span> <span class="toc-text">示例</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E7%82%B9%E2%80%9D-%E2%80%9D%E5%92%8C%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="toc-number">4.</span> <span class="toc-text">关于点”.”和作用域</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8E%BB%E9%99%A4%E7%A9%BA%E7%99%BD"><span class="toc-number">5.</span> <span class="toc-text">去除空白</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%A1%E9%81%93pipeline"><span class="toc-number">6.</span> <span class="toc-text">管道pipeline</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%98%E9%87%8F-1"><span class="toc-number">7.</span> <span class="toc-text">变量</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E5%88%A4%E6%96%AD"><span class="toc-number">8.</span> <span class="toc-text">条件判断</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#range%E2%80%A6end%E8%BF%AD%E4%BB%A3"><span class="toc-number">9.</span> <span class="toc-text">range…end迭代</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#with%E2%80%A6end"><span class="toc-number">10.</span> <span class="toc-text">with…end</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0"><span class="toc-number">11.</span> <span class="toc-text">内置函数</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%87%BD%E6%95%B0"><span class="toc-number">12.</span> <span class="toc-text">自定义函数</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B5%8C%E5%A5%97template%EF%BC%9Adefine%E5%92%8Ctemplate"><span class="toc-number">13.</span> <span class="toc-text">嵌套template：define和template</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#block%E5%9D%97"><span class="toc-number">14.</span> <span class="toc-text">block块</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#html-template%E7%9A%84%E4%B8%8A%E4%B8%8B%E6%96%87%E6%84%9F%E7%9F%A5"><span class="toc-number">15.</span> <span class="toc-text">html&#x2F;template的上下文感知</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%8D%E8%BD%AC%E4%B9%89"><span class="toc-number">16.</span> <span class="toc-text">不转义</span></a></li></ol></details></div><div class="container post-content"><h1 id="模版语法"><a href="#模版语法" class="headerlink" title="模版语法"></a>模版语法</h1><h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><p>渲染template的时候，有两个常用的传入参数的类型。</p>
<ul>
<li>一个是<code>struct</code>，在模板内可以读取该struct域的内容来进行渲染。</li>
<li>还有一个是<code>map[string]interface&#123;&#125;</code>，在模板内可以使用key来进行渲染。</li>
</ul>
<p>在模板文件内，<code>.</code>代表了当前变量，即在非循环体内，<code>.</code>就代表了传入的那个变量。</p>
<p>假设我们定义了一个结构体：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Article <span class="keyword">struct</span> &#123;</span><br><span class="line">    ArticleId <span class="keyword">int</span></span><br><span class="line">    ArticleContent <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么我们在模板内可以通过以下来获取并把变量的内容渲染到模板内。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;&#123;&#123;.ArticleContent&#125;&#125;&lt;span&gt;&#123;&#123;.ArticleId&#125;&#125;&lt;/span&gt;&lt;/p&gt;</span><br></pre></td></tr></table></figure>



<h3 id="定义变量"><a href="#定义变量" class="headerlink" title="定义变量"></a>定义变量</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;$article := &quot;hello&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>假设我们想要把传入值的内容赋值给article，则可以这样写：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;$article := .ArticleContent&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>这样我们只要使用则可以获取到这个变量的内容。</p>
<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><p><strong>golang的模板其实功能很有限，很多复杂的逻辑无法直接使用模板语法来表达，所以只能使用模板函数来绕过。</strong></p>
<p>template包创建新的模板的时候，支持.Funcs方法来将自定义的函数集合导入到该模板中，后续通过该模板渲染的文件均支持直接调用这些函数。</p>
<p>该函数集合的定义为：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> FuncMap <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>key为方法的名字，value则为函数。这里函数的参数个数没有限制，但是对于返回值有所限制。</p>
<p>有两种选择，</p>
<ul>
<li>一种是只有一个返回值，</li>
<li>一种是有两个返回值，但是<strong>第二个返回值必须是error类型</strong>的。</li>
</ul>
<blockquote>
<p>这两种函数的区别是第二个函数在模板中被调用的时候，假设模板函数的第二个参数的返回不为空，则该渲染步骤将会被打断并报错。</p>
</blockquote>
<p>在模板文件内，调用方法也非常的简单：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;funcname .arg1 .arg2&#125;&#125;</span><br></pre></td></tr></table></figure>



<p>示例：</p>
<p>定义了一个函数</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(left <span class="keyword">int</span>, right <span class="keyword">int</span>)</span> <span class="title">int</span></span></span><br></pre></td></tr></table></figure>

<p>则在模板文件内，通过调用以下即可</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;add <span class="number">1</span> <span class="number">2</span>&#125;&#125;</span><br></pre></td></tr></table></figure>



<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;text/template&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    Username, Password <span class="keyword">string</span></span><br><span class="line">    RegTime time.Time</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ShowTime</span><span class="params">(t time.Time, format <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> t.Format(format)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    u := User&#123;<span class="string">&quot;dotcoo&quot;</span>, <span class="string">&quot;dotcoopwd&quot;</span>, time.Now()&#125;</span><br><span class="line">    t, err := template.New(<span class="string">&quot;text&quot;</span>).Funcs(template.FuncMap&#123;<span class="string">&quot;showtime&quot;</span>:ShowTime&#125;).</span><br><span class="line">        Parse(<span class="string">`&lt;p&gt;&#123;&#123;.Username&#125;&#125;|&#123;&#123;.Password&#125;&#125;|&#123;&#123;.RegTime.Format &quot;2006-01-02 15:04:05&quot;&#125;&#125;&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;p&gt;&#123;&#123;.Username&#125;&#125;|&#123;&#123;.Password&#125;&#125;|&#123;&#123;showtime .RegTime &quot;2006-01-02 15:04:05&quot;&#125;&#125;&lt;/p&gt;</span></span><br><span class="line"><span class="string">`</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    t.Execute(os.Stdout, u)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="判断"><a href="#判断" class="headerlink" title="判断"></a>判断</h2><p>仅仅支持最简单的bool类型和字符串类型的判断</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;if .condition&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;if .condition1&#125;&#125;</span><br><span class="line">&#123;&#123;else if .contition2&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>当.condition为bool类型的时候，则为true表示执行，当.condition为string类型的时候，则非空表示执行。</p>
<h3 id="内置的模板函数"><a href="#内置的模板函数" class="headerlink" title="内置的模板函数"></a>内置的模板函数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;if not .condition&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;if and .condition1 .condition2&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;if or .condition1 .condition2&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;if eq .var1 .var2&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;if ne .var1 .var2&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;if lt .var1 .var2&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;if le .var1 .var2&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;if gt .var1 .var2&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;if ge .var1 .var2&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br></pre></td></tr></table></figure>



<h2 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h2><p>支持range循环来遍历map、slice内的内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;range $i, $v := .slice&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br></pre></td></tr></table></figure>



<p>还有一种遍历方式为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;range .slice&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>这种方式无法访问到index或者key的值，需要通过.来访问对应的value</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;range .slice&#125;&#125;</span><br><span class="line">&#123;&#123;.field&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>当然这里使用了.来访问遍历的值，那么我们想要在其中访问外部的变量怎么办？(比如渲染模板传入的变量)，在这里，我们需要使用<code>$.</code>来访问外部的变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;range .slice&#125;&#125;</span><br><span class="line">&#123;&#123;$.ArticleContent&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br></pre></td></tr></table></figure>



<p>模板提供<code>range</code>关键字来遍历数据。假如我们又下面的数据结构：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Item <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name  <span class="keyword">string</span></span><br><span class="line">	Price <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ViewData <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name  <span class="keyword">string</span></span><br><span class="line">	Items []Item</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ViewData</code>对象传给模板，模板如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="keyword">range</span> .Items&#125;&#125;</span><br><span class="line">  &lt;div class=<span class="string">&quot;item&quot;</span>&gt;</span><br><span class="line">    &lt;h3 class=<span class="string">&quot;name&quot;</span>&gt;&#123;&#123;.Name&#125;&#125;&lt;/h3&gt;</span><br><span class="line">    &lt;span class=<span class="string">&quot;price&quot;</span>&gt;$&#123;&#123;.Price&#125;&#125;&lt;/span&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>对于Items中的每个Item, 我们输出它的名称和价格。在range中当前的项目变成了<code>&#123;&#123;.&#125;&#125;</code>，它的属性是<code>&#123;&#123;.Name&#125;&#125;</code>和<code>&#123;&#123;.Price&#125;&#125;</code>。</p>
<h3 id="获取索引值"><a href="#获取索引值" class="headerlink" title="获取索引值"></a>获取索引值</h3><p>如果传给模板的数据是map、slice、数组，那么我们就可以使用它的索引值。我们使用<code>&#123;&#123;index x number&#125;&#125;</code>来访问<code>x</code>的第<code>number</code>个元素， <code>index</code>是关键字。比如<code>&#123;&#123;index names 2&#125;&#125;</code>等价于<code>names[2]</code>。<code>&#123;&#123;index names 2 3 4&#125;&#125;</code> 等价于 <code>names[2][3][4]</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;h1&gt; &#123;&#123; index .FavNums 2 &#125;&#125;&lt;/h1&gt;</span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> person <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name    <span class="keyword">string</span></span><br><span class="line">	FavNums []<span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	tpl := template.Must(template.ParseGlob(<span class="string">&quot;*.gohtml&quot;</span>))</span><br><span class="line">	tpl.Execute(os.Stdout, &amp;person&#123;<span class="string">&quot;Curtis&quot;</span>, []<span class="keyword">int</span>&#123;<span class="number">7</span>, <span class="number">11</span>, <span class="number">94</span>&#125;&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的例子传入一个person的数据结构，得到它的FavNums字段中的第三个值。</p>
<h2 id="模板的嵌套"><a href="#模板的嵌套" class="headerlink" title="模板的嵌套"></a>模板的嵌套</h2><p>当模板想要引入子模板的时候，我们使用以下语句：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;template &quot;navbar&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>这样子就会尝试载入名称为navbar的子模板，同时我们也得定义一个子模板来实现”navbar”这个子模板。</p>
<p>子模板的定义为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;define &quot;navbar&quot;&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>在定义之间的内容将会覆盖<code>&#123;&#123;template “navbar”&#125;&#125;</code></p>
<p>当然子模板是分离了，那么子模板能否获得父模板的变量呢？这是当然的，我们只需要使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;template &quot;navbar&quot; .&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>就可以将当前的变量传给子模板了，这个也是相当方便的。</p>
<h1 id="解析和创建模板"><a href="#解析和创建模板" class="headerlink" title="解析和创建模板"></a>解析和创建模板</h1><h3 id="创建模板"><a href="#创建模板" class="headerlink" title="创建模板"></a>创建模板</h3><p><code>tpl, err := template.Parse(filename)</code>得到文件名为名字的模板，并保存在<code>tpl</code>变量中。tpl可以被执行来显示模板。</p>
<h3 id="解析多个模板"><a href="#解析多个模板" class="headerlink" title="解析多个模板"></a>解析多个模板</h3><p><code>template.ParseFiles(filenames)</code>可以解析一组模板，使用文件名作为模板的名字。</p>
<p><code>template.ParseGlob(pattern)</code>会根据<code>pattern</code>解析所有匹配的模板并保存。</p>
<h3 id="解析字符串模板"><a href="#解析字符串模板" class="headerlink" title="解析字符串模板"></a>解析字符串模板</h3><p><code>t, err := template.New(&quot;foo&quot;).Parse(&#123;&#123;define "T"&#125;&#125;Hello, &#123;&#123;.&#125;&#125;!&#123;&#123;end&#125;&#125;)</code> 可以解析字符串模板，并设置它的名字</p>
<h1 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;html/template&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">tmpl</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	t1, err := template.ParseFiles(<span class="string">&quot;test.html&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	t1.Execute(w, <span class="string">&quot;hello world&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	server := http.Server&#123;</span><br><span class="line">		Addr: <span class="string">&quot;127.0.0.1:8080&quot;</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/tmpl&quot;</span>, tmpl)</span><br><span class="line">	server.ListenAndServe()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=utf-8&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span>Go Web<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">		&#123;&#123; . &#125;&#125;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在go程序中，handler函数中使用<code>template.ParseFiles(&quot;test.html&quot;)</code>，它会自动创建一个模板(关联到变量t1上)，并解析一个或多个文本文件(不仅仅是html文件)，</li>
<li>解析之后就可以使用<code>Execute(w,&quot;hello world&quot;)</code>去执行解析后的模板对象，执行过程是合并、替换的过程。</li>
<li>例如上面的<code>&#123;&#123;.&#125;&#125;</code>中的<code>.</code>会替换成当前对象”hello world”，并和其它纯字符串内容进行合并，最后写入w中，也就是发送到浏览器”hello world”。</li>
</ul>
<h1 id="关于点”-”和作用域"><a href="#关于点”-”和作用域" class="headerlink" title="关于点”.”和作用域"></a>关于点”.”和作用域</h1><p>在写template的时候，会经常用到”.”。比如<code>&#123;&#123;.&#125;&#125;</code>、<code>&#123;&#123;len .&#125;&#125;</code>、<code>&#123;&#123;.Name&#125;&#125;</code>、<code>&#123;&#123;$x.Name&#125;&#125;</code>等等。</p>
<p>在template中，点”.”代表<strong>当前作用域的当前对象</strong>。它类似于java/c++的this关键字，类似于perl/python的self。如果了解perl，它更可以简单地理解为默认变量<code>$_</code>。</p>
<p>例如，前面示例test.html中<code>&#123;&#123;.&#125;&#125;</code>，这个点是顶级作用域范围内的，它代表<code>Execute(w,&quot;hello worold&quot;)</code>的第二个参数”hello world”。也就是说它代表这个字符串对象。</p>
<p>再例如，有一个Person struct。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name <span class="keyword">string</span></span><br><span class="line">	Age  <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	p := Person&#123;<span class="string">&quot;longshuai&quot;</span>,<span class="number">23</span>&#125;</span><br><span class="line">	tmpl, _ := template.New(<span class="string">&quot;test&quot;</span>).Parse(<span class="string">&quot;Name: &#123;&#123;.Name&#125;&#125;, Age: &#123;&#123;.Age&#125;&#125;&quot;</span>)</span><br><span class="line">	_ = tmpl.Execute(os.Stdout, p)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里<code>&#123;&#123;.Name&#125;&#125;</code>和<code>&#123;&#123;.Age&#125;&#125;</code>中的点”.”代表的是顶级作用域的对象p，所以Execute()方法执行的时候，会将<code>&#123;&#123;.Name&#125;&#125;</code>替换成<code>p.Name</code>，同理<code>&#123;&#123;.Age&#125;&#125;</code>替换成<code>&#123;&#123;p.Age&#125;&#125;</code>。</p>
<p>但是并非只有一个顶级作用域，range、with、if等内置action都有自己的本地作用域。</p>
<p>例如下面的例子，如果看不懂也没关系，只要从中理解”.”即可。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;text/template&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Friend <span class="keyword">struct</span> &#123;</span><br><span class="line">	Fname <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">	UserName <span class="keyword">string</span></span><br><span class="line">	Emails   []<span class="keyword">string</span></span><br><span class="line">	Friends  []*Friend</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	f1 := Friend&#123;Fname: <span class="string">&quot;xiaofang&quot;</span>&#125;</span><br><span class="line">	f2 := Friend&#123;Fname: <span class="string">&quot;wugui&quot;</span>&#125;</span><br><span class="line">	t := template.New(<span class="string">&quot;test&quot;</span>)</span><br><span class="line">	t = template.Must(t.Parse(</span><br><span class="line"><span class="string">`hello &#123;&#123;.UserName&#125;&#125;!</span></span><br><span class="line"><span class="string">&#123;&#123; range .Emails &#125;&#125;</span></span><br><span class="line"><span class="string">	an email &#123;&#123; . &#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;- end &#125;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;&#123; with .Friends &#125;&#125;</span></span><br><span class="line"><span class="string">  &#123;&#123;- range . &#125;&#125;</span></span><br><span class="line"><span class="string">  	my friend name is &#123;&#123;.Fname&#125;&#125;</span></span><br><span class="line"><span class="string">  &#123;&#123;- end &#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123; end &#125;&#125;`</span>))</span><br><span class="line">	p := Person&#123;UserName: <span class="string">&quot;longshuai&quot;</span>,</span><br><span class="line">		Emails:  []<span class="keyword">string</span>&#123;<span class="string">&quot;a1@qq.com&quot;</span>, <span class="string">&quot;a2@gmail.com&quot;</span>&#125;,</span><br><span class="line">		Friends: []*Friend&#123;&amp;f1, &amp;f2&#125;&#125;</span><br><span class="line">  </span><br><span class="line">	t.Execute(os.Stdout, p)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hello longshuai!</span><br><span class="line"></span><br><span class="line">an email a1@qq.com</span><br><span class="line">an email a2@gmail.com</span><br><span class="line"></span><br><span class="line">my friend name is xiaofang</span><br><span class="line">my friend name is wugui</span><br></pre></td></tr></table></figure>

<p>这里定义了一个Person结构，它有两个slice结构的字段。在Parse()方法中：</p>
<ul>
<li>顶级作用域的<code>&#123;&#123;.UserName&#125;&#125;</code>、<code>&#123;&#123;.Emails&#125;&#125;</code>、<code>&#123;&#123;.Friends&#125;&#125;</code>中的点都代表Execute()的第二个参数，也就是Person对象p，它们在执行的时候会分别被替换成p.UserName、p.Emails、p.Friends。</li>
<li>因为Emails和Friend字段都是可迭代的，在<code>&#123;&#123;range .Emails&#125;&#125;...&#123;&#123;end&#125;&#125;</code>这一段结构内部<code>an email &#123;&#123;.&#125;&#125;</code>，这个”.”代表的是range迭代时的每个元素对象，也就是p.Emails这个slice中的每个元素。</li>
<li>同理，with结构内部<code>&#123;&#123;range .&#125;&#125;</code>的”.”代表的是p.Friends，也就是各个，再此range中又有一层迭代，此内层<code>&#123;&#123;.Fname&#125;&#125;</code>的点代表Friend结构的实例，分别是<code>&amp;f1</code>和<code>&amp;f2</code>，所以<code>&#123;&#123;.Fname&#125;&#125;</code>代表实例对象的Fname字段。</li>
</ul>
<h1 id="去除空白"><a href="#去除空白" class="headerlink" title="去除空白"></a>去除空白</h1><p>template引擎在进行替换的时候，是完全按照文本格式进行替换的。除了需要评估和替换的地方，所有的行分隔符、空格等等空白都原样保留。所以，<strong>对于要解析的内容，不要随意缩进、随意换行</strong>。</p>
<p>可以在<code>&#123;&#123;`符号的后面加上短横线并保留一个或多个空格"- "来去除它前面的空白(包括换行符、制表符、空格等)，即`&#123;&#123;- xxxx`。

在`&#125;&#125;</code>的前面加上一个或多个空格以及一个短横线”-“来去除它后面的空白，即<code>xxxx -&#125;&#125;</code>。</p>
<p>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;23&#125;&#125; &lt; &#123;&#123;45&#125;&#125;        -&gt; 23 &lt; 45</span><br><span class="line">&#123;&#123;23&#125;&#125; &lt; &#123;&#123;- 45&#125;&#125;      -&gt;  23 &lt;45</span><br><span class="line">&#123;&#123;23 -&#125;&#125; &lt; &#123;&#123;45&#125;&#125;      -&gt;  23&lt; 45</span><br><span class="line">&#123;&#123;23 -&#125;&#125; &lt; &#123;&#123;- 45&#125;&#125;    -&gt;  23&lt;45</span><br></pre></td></tr></table></figure>

<p>其中<code>&#123;&#123;23 -&#125;&#125;</code>中的短横线去除了这个替换结构后面的空格，即<code>&#125;&#125; &lt;</code>中间的空白。同理<code>&#123;&#123;- 45&#125;&#125;</code>的短横线去除了<code>&lt; &#123;&#123;`中间的空白。

再看上一节的例子中：

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">t.Parse(</span><br><span class="line">`hello &#123;&#123;.UserName&#125;&#125;!</span><br><span class="line">&#123;&#123; range .Emails &#125;&#125;</span><br><span class="line">an email &#123;&#123; . &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br><span class="line">&#123;&#123; with .Friends &#125;&#125;</span><br><span class="line">&#123;&#123;- range . &#125;&#125;</span><br><span class="line">my friend name is &#123;&#123;.Fname&#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br><span class="line">&#123;&#123; end &#125;&#125;`)</span><br></pre></td></tr></table></figure>

注意，上面没有进行缩进。因为缩进的制表符或空格在替换的时候会保留。

第一行和第二行之间输出时会换行输出，不仅如此，`range &#123;&#123;.Emails&#125;&#125;</code>自身也占一行，在替换的时候它会被保留为空行。除非range前面没加<code>&#123;&#123;-`。由于range的`&#123;&#123;- end`加上了去除前缀空白，所以每次迭代的时候，每个元素之间都换行输出但却不多一空行，如果这里的end去掉`&#123;&#123;-`，则每个迭代的元素之间输出的时候都会有空行。同理后面的with和range。



# 注释

注释方式：`&#123;&#123;/* a comment */&#125;&#125;</code>。</p>
<p>注释后的内容不会被引擎进行替换。但需要注意，注释行在替换的时候也会占用行，所以应该去除前缀和后缀空白，否则会多一空行。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;- /* a comment without prefix/suffix space */&#125;&#125;</span><br><span class="line">&#123;&#123;/* a comment without prefix/suffix space */ -&#125;&#125;</span><br><span class="line">&#123;&#123;- /* a comment without prefix/suffix space */ -&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>注意，应该只去除前缀或后缀空白，不要同时都去除，否则会破坏原有的格式。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">t.Parse(</span><br><span class="line">`hello &#123;&#123;.UserName&#125;&#125;!</span><br><span class="line">&#123;&#123;- /* this line is a comment */&#125;&#125;</span><br><span class="line">&#123;&#123; range .Emails &#125;&#125;</span><br><span class="line">an email &#123;&#123; . &#125;&#125;</span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br></pre></td></tr></table></figure>



<h1 id="管道pipeline"><a href="#管道pipeline" class="headerlink" title="管道pipeline"></a>管道pipeline</h1><p>pipeline是指产生数据的操作。比如<code>&#123;&#123;.&#125;&#125;</code>、<code>&#123;&#123;.Name&#125;&#125;</code>、<code>funcname args</code>等。</p>
<p>可以使用管道符号<code>|</code>链接多个命令，用法和unix下的管道类似：<code>|</code>前面的命令将运算结果(或返回值)传递给后一个命令的最后一个位置。</p>
<p>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;.&#125;&#125; | printf &quot;%s\n&quot; &quot;abcd&quot;</span><br></pre></td></tr></table></figure>

<p><code>&#123;&#123;.&#125;&#125;</code>的结果将传递给printf，且传递的参数位置是”abcd”之后。</p>
<p>命令可以有超过1个的返回值，这时第二个返回值必须为err类型。</p>
<p>需要注意的是，并非只有使用了<code>|</code>才是pipeline。Go template中，pipeline的概念是传递数据，只要能产生数据的，都是pipeline。这使得某些操作可以作为另一些操作内部的表达式先运行得到结果，就像是Unix下的命令替换一样。</p>
<p>例如，下面的<code>(len &quot;output&quot;)</code>是pipeline，它整体先运行。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;println (len &quot;output&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>下面是Pipeline的几种示例，它们都输出<code>&quot;output&quot;</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;`&quot;output&quot;`&#125;&#125;</span><br><span class="line">&#123;&#123;printf &quot;%q&quot; &quot;output&quot;&#125;&#125;</span><br><span class="line">&#123;&#123;&quot;output&quot; | printf &quot;%q&quot;&#125;&#125;</span><br><span class="line">&#123;&#123;printf &quot;%q&quot; (print &quot;out&quot; &quot;put&quot;)&#125;&#125;</span><br><span class="line">&#123;&#123;&quot;put&quot; | printf &quot;%s%s&quot; &quot;out&quot; | printf &quot;%q&quot;&#125;&#125;</span><br><span class="line">&#123;&#123;&quot;output&quot; | printf &quot;%s&quot; | printf &quot;%q&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>



<h1 id="变量-1"><a href="#变量-1" class="headerlink" title="变量"></a>变量</h1><p>可以在template中定义变量：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 未定义过的变量</span><br><span class="line">$var := pipeline</span><br><span class="line"></span><br><span class="line">// 已定义过的变量</span><br><span class="line">$var = pipeline</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;- $how_long :=(len &quot;output&quot;)&#125;&#125;</span><br><span class="line">&#123;&#123;- println $how_long&#125;&#125;   // 输出6</span><br></pre></td></tr></table></figure>

<p>再例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tx := template.Must(template.New(<span class="string">&quot;hh&quot;</span>).Parse(</span><br><span class="line"><span class="string">`&#123;&#123;range $x := . -&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;$y := 333&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;- if (gt $x 33)&#125;&#125;&#123;&#123;println $x $y ($z := 444)&#125;&#125;&#123;&#123;- end&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;- end&#125;&#125;</span></span><br><span class="line"><span class="string">`</span>))</span><br><span class="line">s := []<span class="keyword">int</span>&#123;<span class="number">11</span>, <span class="number">22</span>, <span class="number">33</span>, <span class="number">44</span>, <span class="number">55</span>&#125;</span><br><span class="line">_ = tx.Execute(os.Stdout, s)</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">44 333 444</span><br><span class="line">55 333 444</span><br></pre></td></tr></table></figure>

<p>上面的示例中，使用range迭代slice，每个元素都被赋值给变量<code>$x</code>，每次迭代过程中，都新设置一个变量<code>$y</code>，在内层嵌套的if结构中，可以使用这个两个外层的变量。在if的条件表达式中，使用了一个内置的比较函数gt，如果<code>$x</code>大于33，则为true。在println的参数中还定义了一个<code>$z</code>，之所以能定义，是因为<code>($z := 444)</code>的过程是一个Pipeline，可以先运行。</p>
<p>需要注意三点：</p>
<ol>
<li><strong>变量有作用域，只要出现end，则当前层次的作用域结束。内层可以访问外层变量，但外层不能访问内层变量</strong>。</li>
<li><strong>有一个特殊变量<code>$</code>，它代表模板的最顶级作用域对象(通俗地理解，是以模板为全局作用域的全局变量)，在Execute()执行的时候进行赋值，且一直不变</strong>。例如上面的示例中，<code>$ = [11 22 33 44 55]</code>。再例如，define定义了一个模板t1，则t1中的<code>$</code>作用域只属于这个t1。</li>
<li><strong>变量不可在模板之间继承</strong>。普通变量可能比较容易理解，但对于特殊变量”.”和”$”，比较容易搞混。见下面的例子。</li>
</ol>
<p>例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	t1 := template.New(<span class="string">&quot;test1&quot;</span>)</span><br><span class="line">	tmpl, _ := t1.Parse(</span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="string">&#123;&#123;- define &quot;T1&quot;&#125;&#125;ONE &#123;&#123;println .&#125;&#125;&#123;&#123;end&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;- define &quot;T2&quot;&#125;&#125;&#123;&#123;template &quot;T1&quot; $&#125;&#125;&#123;&#123;end&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;- template &quot;T2&quot; . -&#125;&#125;</span></span><br><span class="line"><span class="string">`</span>)</span><br><span class="line">	_ = tmpl.Execute(os.Stdout, <span class="string">&quot;hello world&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面使用define额外定义了T1和T2两个模板，T2中嵌套了T1。<code>&#123;&#123;template "T2" .&#125;&#125;</code>的点代表顶级作用域的”hello world”对象。在T2中使用了特殊变量<code>$</code>，这个<code>$</code>的范围是T2的，不会继承顶级作用域”hello world”。但因为执行T2的时候，传递的是”.”，所以这里的<code>$</code>的值仍然是”hello world”。</p>
<p>不仅<code>$</code>不会在模板之间继承，<code>.</code>也不会在模板之间继承(其它所有变量都不会继承)。实际上，<strong>template可以看作是一个函数，它的执行过程是<code>template(&quot;T2&quot;,.)</code>。如果把上面的<code>$</code>换成”.”，结果是一样的。</strong>如果换成<code>&#123;&#123;template "T2"&#125;&#125;</code>，则<code>$=nil</code></p>
<h1 id="条件判断"><a href="#条件判断" class="headerlink" title="条件判断"></a>条件判断</h1><p>有以下几种if条件判断语句，其中第三和第四是等价的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;if pipeline&#125;&#125; T1 &#123;&#123;end&#125;&#125;</span><br><span class="line">&#123;&#123;if pipeline&#125;&#125; T1 &#123;&#123;else&#125;&#125; T0 &#123;&#123;end&#125;&#125;</span><br><span class="line">&#123;&#123;if pipeline&#125;&#125; T1 &#123;&#123;else if pipeline&#125;&#125; T0 &#123;&#123;end&#125;&#125;</span><br><span class="line">&#123;&#123;if pipeline&#125;&#125; T1 &#123;&#123;else&#125;&#125;&#123;&#123;if pipeline&#125;&#125; T0 &#123;&#123;end&#125;&#125;&#123;&#123;end&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>需要注意的是，pipeline为false的情况是各种数据对象的0值：数值0，指针或接口是nil，数组、slice、map或string则是len为0。</p>
<h1 id="range…end迭代"><a href="#range…end迭代" class="headerlink" title="range…end迭代"></a>range…end迭代</h1><p>有两种迭代表达式类型：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;range pipeline&#125;&#125; T1 &#123;&#123;end&#125;&#125;</span><br><span class="line">&#123;&#123;range pipeline&#125;&#125; T1 &#123;&#123;else&#125;&#125; T0 &#123;&#123;end&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>range可以迭代slice、数组、map或channel。迭代的时候，会设置”.”为当前正在迭代的元素。</p>
<p>对于第一个表达式，当迭代对象的值为0值时，则range直接跳过，就像if一样。对于第二个表达式，则在迭代到0值时执行else语句。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tx := template.Must(template.New(<span class="string">&quot;hh&quot;</span>).Parse(</span><br><span class="line"><span class="string">`&#123;&#123;range $x := . -&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;println $x&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;- end&#125;&#125;</span></span><br><span class="line"><span class="string">`</span>))</span><br><span class="line">s := []<span class="keyword">int</span>&#123;<span class="number">11</span>, <span class="number">22</span>, <span class="number">33</span>, <span class="number">44</span>, <span class="number">55</span>&#125;</span><br><span class="line">_ = tx.Execute(os.Stdout, s)</span><br></pre></td></tr></table></figure>

<p>需注意的是，range的参数部分是pipeline，所以在迭代的过程中是可以进行赋值的。但有两种赋值情况：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;range $value := .&#125;&#125;</span><br><span class="line">&#123;&#123;range $key,$value := .&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>如果range中只赋值给一个变量，则这个变量是当前正在迭代元素的值。如果赋值给两个变量，则第一个变量是索引值(map/slice是数值，map是key)，第二个变量是当前正在迭代元素的值。</p>
<p>下面是在html中使用range的一个示例。test.html文件内容如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=utf-8&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span>Go Web<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">			&#123;&#123; range . &#125;&#125;</span><br><span class="line">				<span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;&#123; . &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">			&#123;&#123; else &#125;&#125;</span><br><span class="line">				<span class="tag">&lt;<span class="name">li</span>&gt;</span> Nothing to show <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">			&#123;&#123; end&#125;&#125;</span><br><span class="line">		<span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>以下是test.html同目录下的go程序文件：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;html/template&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	server := http.Server&#123;</span><br><span class="line">		Addr: <span class="string">&quot;127.0.0.1:8080&quot;</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/process&quot;</span>, process)</span><br><span class="line">	server.ListenAndServe()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">  <span class="comment">// template.Must这个方法用了判断返回的(t *Template, err error)是否有错误，如果有错误，引发panic，导致程序崩溃。</span></span><br><span class="line">  <span class="comment">// 说白了就是如果模板解析有问题，让程序直接挂掉。</span></span><br><span class="line">	t1 := template.Must(template.ParseFiles(<span class="string">&quot;test.html&quot;</span>))</span><br><span class="line">	s := []<span class="keyword">string</span>&#123;</span><br><span class="line">		<span class="string">&quot;星期一&quot;</span>,</span><br><span class="line">		<span class="string">&quot;星期二&quot;</span>,</span><br><span class="line">		<span class="string">&quot;星期三&quot;</span>,</span><br><span class="line">		<span class="string">&quot;星期四&quot;</span>,</span><br><span class="line">		<span class="string">&quot;星期五&quot;</span>,</span><br><span class="line">		<span class="string">&quot;星期六&quot;</span>,</span><br><span class="line">		<span class="string">&quot;星期日&quot;</span>,&#125;</span><br><span class="line">	t1.Execute(w, s)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="with…end"><a href="#with…end" class="headerlink" title="with…end"></a>with…end</h1><p><strong>with用来设置”.”的值</strong>。两种格式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;with pipeline&#125;&#125; T1 &#123;&#123;end&#125;&#125;</span><br><span class="line">&#123;&#123;with pipeline&#125;&#125; T1 &#123;&#123;else&#125;&#125; T0 &#123;&#123;end&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>对于第一种格式，当pipeline不为0值的时候，点”.”设置为pipeline运算的值，否则跳过。</p>
<p>对于第二种格式，当pipeline为0值时，执行else语句块，否则”.”设置为pipeline运算的值，并执行T1。</p>
<p>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;with &quot;xx&quot;&#125;&#125;&#123;&#123;println .&#125;&#125;&#123;&#123;end&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>上面将输出<code>xx</code>，因为”.”已经设置为”xx”。</p>
<h1 id="内置函数"><a href="#内置函数" class="headerlink" title="内置函数"></a>内置函数</h1><p>以下是内置的函数列表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">and</span><br><span class="line">    返回第一个为空的参数或最后一个参数。可以有任意多个参数。</span><br><span class="line">    and x y等价于if x then y else x</span><br><span class="line"></span><br><span class="line">not</span><br><span class="line">    布尔取反。只能一个参数。</span><br><span class="line"></span><br><span class="line">or</span><br><span class="line">    返回第一个不为空的参数或最后一个参数。可以有任意多个参数。</span><br><span class="line">    &quot;or x y&quot;等价于&quot;if x then x else y&quot;。</span><br><span class="line"></span><br><span class="line">print</span><br><span class="line">printf</span><br><span class="line">println</span><br><span class="line">    分别等价于fmt包中的Sprint、Sprintf、Sprintln</span><br><span class="line"></span><br><span class="line">len</span><br><span class="line">    返回参数的length。</span><br><span class="line"></span><br><span class="line">index</span><br><span class="line">    对可索引对象进行索引取值。第一个参数是索引对象，后面的参数是索引位。</span><br><span class="line">    &quot;index x 1 2 3&quot;代表的是x[1][2][3]。</span><br><span class="line">    可索引对象包括map、slice、array。</span><br><span class="line"></span><br><span class="line">call</span><br><span class="line">    显式调用函数。第一个参数必须是函数类型，且不是template中的函数，而是外部函数。</span><br><span class="line">    例如一个struct中的某个字段是func类型的。</span><br><span class="line">    &quot;call .X.Y 1 2&quot;表示调用dot.X.Y(1, 2)，Y必须是func类型，函数参数是1和2。</span><br><span class="line">    函数必须只能有一个或2个返回值，如果有第二个返回值，则必须为error类型。</span><br></pre></td></tr></table></figure>



<p>除此之外，还内置一些用于比较的函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">eq arg1 arg2：</span><br><span class="line">    arg1 == arg2时为true</span><br><span class="line">ne arg1 arg2：</span><br><span class="line">    arg1 != arg2时为true</span><br><span class="line">lt arg1 arg2：</span><br><span class="line">    arg1 &lt; arg2时为true</span><br><span class="line">le arg1 arg2：</span><br><span class="line">    arg1 &lt;= arg2时为true</span><br><span class="line">gt arg1 arg2：</span><br><span class="line">    arg1 &gt; arg2时为true</span><br><span class="line">ge arg1 arg2：</span><br><span class="line">    arg1 &gt;= arg2时为true</span><br></pre></td></tr></table></figure>

<p>对于eq函数，支持多个参数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eq arg1 arg2 arg3 arg4...</span><br></pre></td></tr></table></figure>

<p>它们都和第一个参数arg1进行比较。它等价于：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arg1==arg2 || arg1==arg3 || arg1==arg4 </span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; if (gt $x 33) &#125;&#125;&#123;&#123;println $x&#125;&#125;&#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure>



<h1 id="自定义函数"><a href="#自定义函数" class="headerlink" title="自定义函数"></a>自定义函数</h1><p>Go的模板支持自定义函数。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sayHello</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">    htmlByte, err := ioutil.ReadFile(<span class="string">&quot;./hello.html&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;read html failed, err:&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 自定义一个夸人的模板函数</span></span><br><span class="line">    kua := <span class="function"><span class="keyword">func</span><span class="params">(arg <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">        <span class="keyword">return</span> arg + <span class="string">&quot;真帅&quot;</span>, <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 采用链式操作在Parse之前调用Funcs添加自定义的kua函数</span></span><br><span class="line">    tmpl, err := template.New(<span class="string">&quot;hello&quot;</span>).Funcs(template.FuncMap&#123;<span class="string">&quot;kua&quot;</span>: kua&#125;).Parse(<span class="keyword">string</span>(htmlByte))</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;create template failed, err:&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    user := UserInfo&#123;</span><br><span class="line">        Name:   <span class="string">&quot;枯藤&quot;</span>,</span><br><span class="line">        Gender: <span class="string">&quot;男&quot;</span>,</span><br><span class="line">        Age:    <span class="number">18</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 使用user渲染模板，并将结果写入w</span></span><br><span class="line">    tmpl.Execute(w, user)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以在模板文件hello.html中使用我们自定义的kua函数了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;kua .Name&#125;&#125;</span><br></pre></td></tr></table></figure>





<h1 id="嵌套template：define和template"><a href="#嵌套template：define和template" class="headerlink" title="嵌套template：define和template"></a>嵌套template：define和template</h1><p>define可以直接在待解析内容中定义一个模板，这个模板会加入到common结构组中，并关联到关联名称上。</p>
<p>定义了模板之后，可以使用template这个action来执行模板。template有两种格式：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;template <span class="string">&quot;name&quot;</span>&#125;&#125;</span><br><span class="line">&#123;&#123;template <span class="string">&quot;name&quot;</span> pipeline&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>第一种是直接执行名为name的template，点设置为nil。第二种是点”.”设置为pipeline的值，并执行名为name的template。可以将template看作是函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">template(<span class="string">&quot;name)</span></span><br><span class="line"><span class="string">template(&quot;</span>name<span class="string">&quot;,pipeline)</span></span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	t1 := template.New(<span class="string">&quot;test1&quot;</span>)</span><br><span class="line">	tmpl, _ := t1.Parse(</span><br><span class="line"><span class="string">`&#123;&#123;- define &quot;T1&quot;&#125;&#125;ONE &#123;&#123;println .&#125;&#125;&#123;&#123;end&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;- define &quot;T2&quot;&#125;&#125;TWO &#123;&#123;println .&#125;&#125;&#123;&#123;end&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;- define &quot;T3&quot;&#125;&#125;&#123;&#123;template &quot;T1&quot;&#125;&#125;&#123;&#123;template &quot;T2&quot; &quot;haha&quot;&#125;&#125;&#123;&#123;end&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&#123;- template &quot;T3&quot; -&#125;&#125;</span></span><br><span class="line"><span class="string">`</span>)</span><br><span class="line">	_ = tmpl.Execute(os.Stdout, <span class="string">&quot;hello world&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ONE &lt;nil&gt;</span><br><span class="line">TWO haha</span><br></pre></td></tr></table></figure>

<p>上面定义了4个模板，一个是test1，另外三个是使用define来定义的T1、T2、T3，其中t1是test1模板的关联名称。T1、T2、T3和test1共享一个common结构。其中T3中包含了执行T1和T2的语句。最后只要<code>&#123;&#123;template T3&#125;&#125;</code>就可以执行T3，执行T3又会执行T1和T2。也就是实现了嵌套。此外，执行<code>&#123;&#123;template "T1"&#125;&#125;</code>时，点设置为nil，而<code>&#123;&#123;temlate "T2" "haha"&#125;&#125;</code>的点设置为了”haha”。</p>
<p>注意，<strong>模板之间的变量是不会继承的</strong>。</p>
<p>下面是html文件中嵌套模板的几个示例。</p>
<p>t1.html文件内容如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=9&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>Go Web Programming<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span>&gt;</span> This is t1.html before<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span>&gt;</span>This is the value of the dot in t1.html - [&#123;&#123; . &#125;&#125;]<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">hr</span> /&gt;</span></span><br><span class="line">	&#123;&#123; template &quot;t2.html&quot; &#125;&#125;</span><br><span class="line">	<span class="tag">&lt;<span class="name">hr</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span>&gt;</span> This is t1.html after<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>因为内部有<code>&#123;&#123;template "t2.html"&#125;&#125;</code>，且此处没有使用define去定义名为”t2.html”的模板，所以需要加载解析名为t2.html的文件。t2.html文件内容如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;background-color: yellow;&quot;</span>&gt;</span></span><br><span class="line">	This is t2.html<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">	This is the value of the dot in t2.html - [&#123;&#123; . &#125;&#125;]</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>处理这两个文件的handler函数如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	t, _ := template.ParseFiles(<span class="string">&quot;t1.html&quot;</span>, <span class="string">&quot;t2.html&quot;</span>)</span><br><span class="line">	t.Execute(w, <span class="string">&quot;Hello World!&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面也可以不额外定义t2.html文件，而是直接在t1.html文件中使用define定义一个模板。修改t1.html文件如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=9&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>Go Web Programming<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span>&gt;</span> This is t1.html before<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span>&gt;</span>This is the value of the dot in t1.html - [&#123;&#123; . &#125;&#125;]<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">hr</span> /&gt;</span></span><br><span class="line">	&#123;&#123; template &quot;t2.html&quot; &#125;&#125;</span><br><span class="line">	<span class="tag">&lt;<span class="name">hr</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span>&gt;</span> This is t1.html after<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line">&#123;&#123;define &quot;t2.html&quot;&#125;&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;background-color: yellow;&quot;</span>&gt;</span></span><br><span class="line">	This is t2.html<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">	This is the value of the dot in t2.html - [&#123;&#123; . &#125;&#125;]</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>然后在handler中，只需解析t1.html一个文件即可。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	t, _ := template.ParseFiles(<span class="string">&quot;t1.html&quot;</span>)</span><br><span class="line">	t.Execute(w, <span class="string">&quot;Hello World!&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="block块"><a href="#block块" class="headerlink" title="block块"></a>block块</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;block &quot;name&quot; pipeline&#125;&#125; T1 &#123;&#123;end&#125;&#125;</span><br><span class="line">	A block is shorthand for defining a template</span><br><span class="line">		&#123;&#123;define &quot;name&quot;&#125;&#125; T1 &#123;&#123;end&#125;&#125;</span><br><span class="line">	and then executing it in place</span><br><span class="line">		&#123;&#123;template &quot;name&quot; pipeline&#125;&#125;</span><br><span class="line">	The typical use is to define a set of root templates that are</span><br><span class="line">	then customized by redefining the block templates within.</span><br></pre></td></tr></table></figure>

<p>根据官方文档的解释：block等价于define定义一个名为name的模板，并在”有需要”的地方执行这个模板，执行时将”.”设置为pipeline的值。</p>
<p>但应该注意，<strong>block的第一个动作是执行名为name的模板，如果不存在，则在此处自动定义这个模板，并执行这个临时定义的模板。换句话说，block可以认为是设置一个默认模板</strong>。</p>
<p>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;block &quot;T1&quot; .&#125;&#125; one &#123;&#123;end&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>它首先表示<code>&#123;&#123;template "T1" .&#125;&#125;</code>，也就是说先找到T1模板，如果T1存在，则执行找到的T1，如果没找到T1，则临时定义一个<code>&#123;&#123;define "T1"&#125;&#125; one &#123;&#123;end&#125;&#125;</code>，并执行它。</p>
<p>下面是正常情况下不使用block的示例。</p>
<p>home.html文件内容如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=utf-8&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span>Go Web Programming<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">		&#123;&#123; template &quot;content&quot; &#125;&#125;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在此文件中指定了要执行一个名为”content”的模板，但此文件中没有使用define定义该模板，所以需要在其它文件中定义名为content的模板。现在分别在两个文件中定义两个content模板：</p>
<p>red.html文件内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; define &quot;content&quot; &#125;&#125;</span><br><span class="line">	&lt;h1 style=&quot;color: red;&quot;&gt;Hello World!&lt;/h1&gt;</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>blue.html文件内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; define &quot;content&quot; &#125;&#125;</span><br><span class="line">	&lt;h1 style=&quot;color: blue;&quot;&gt;Hello World!&lt;/h1&gt;</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>在handler中，除了解析home.html，还根据需要解析red.html或blue.html：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	rand.Seed(time.Now().Unix())</span><br><span class="line">	t := template.New(<span class="string">&quot;test&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> rand.Intn(<span class="number">10</span>) &gt; <span class="number">5</span> &#123;</span><br><span class="line">		t, _ = template.ParseFiles(<span class="string">&quot;home.html&quot;</span>, <span class="string">&quot;red.html&quot;</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		t, _ = template.ParseFiles(<span class="string">&quot;home.html&quot;</span>, <span class="string">&quot;blue.html&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	t.Execute(w,<span class="string">&quot;&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果使用block，那么可以设置默认的content模板。例如将原本定义在blue.html中的content设置为默认模板。</p>
<p>修改home.html：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=utf-8&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>Go Web Programming<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        &#123;&#123; block &quot;content&quot; . &#125;&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">h1</span> <span class="attr">style</span>=<span class="string">&quot;color: blue;&quot;</span>&gt;</span>Hello World!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        &#123;&#123; end &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后修改handler:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	rand.Seed(time.Now().Unix())</span><br><span class="line">	t := template.New(<span class="string">&quot;test&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> rand.Intn(<span class="number">10</span>) &gt; <span class="number">5</span> &#123;</span><br><span class="line">		t, _ = template.ParseFiles(<span class="string">&quot;home.html&quot;</span>, <span class="string">&quot;red.html&quot;</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		t, _ = template.ParseFiles(<span class="string">&quot;home.html&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	t.Execute(w,<span class="string">&quot;&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当执行else语句块的时候，发现home.html中要执行名为content的模板，但在ParseFiles()中并没有解析包含content模板的文件。于是执行block定义的content模板。而执行非else语句的时候，因为red.html中定义了content，会直接执行red.html中的content。</p>
<p>block通常设置在顶级的根文件中，例如上面的home.html中。</p>
<h1 id="html-template的上下文感知"><a href="#html-template的上下文感知" class="headerlink" title="html/template的上下文感知"></a>html/template的上下文感知</h1><p>对于html/template包，有一个很好用的功能：上下文感知。text/template没有该功能。</p>
<p>上下文感知具体指的是根据所处环境css、js、html、url的path、url的query，<strong>自动进行不同格式的转义。</strong></p>
<p>例如，一个handler函数的代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	t, _ := template.ParseFiles(<span class="string">&quot;test.html&quot;</span>)</span><br><span class="line">	content := <span class="string">`I asked: &lt;i&gt;&quot;What&#x27;s up?&quot;&lt;/i&gt;`</span></span><br><span class="line">	t.Execute(w, content)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面content是Execute的第二个参数，它的内容是包含了特殊符号的字符串。</p>
<p>下面是test.html文件的内容：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=utf-8&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span>Go Web Programming<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;&#123; . &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/&#123;&#123; . &#125;&#125;&quot;</span>&gt;</span>Path<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/?q=&#123;&#123; . &#125;&#125;&quot;</span>&gt;</span>Query<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">onclick</span>=<span class="string">&quot;f(&#x27;&#123;&#123; . &#125;&#125;&#x27;)&quot;</span>&gt;</span>Onclick<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>上面test.html中有4个不同的环境，分别是html环境、url的path环境、url的query环境以及js环境。虽然对象都是<code>&#123;&#123;.&#125;&#125;</code>，但解析执行后的值是不一样的。如果使用curl获取源代码，结果将如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=utf-8&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>Go Web Programming<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span>&gt;</span>I asked: <span class="symbol">&amp;lt;</span>i<span class="symbol">&amp;gt;</span><span class="symbol">&amp;#34;</span>What<span class="symbol">&amp;#39;</span>s up?<span class="symbol">&amp;#34;</span><span class="symbol">&amp;lt;</span>/i<span class="symbol">&amp;gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/I%20asked:%20%3ci%3e%22What%27s%20up?%22%3c/i%3e&quot;</span>&gt;</span></span><br><span class="line">			Path</span><br><span class="line">		<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/?q=I%20asked%3a%20%3ci%3e%22What%27s%20up%3f%22%3c%2fi%3e&quot;</span>&gt;</span></span><br><span class="line">			Query</span><br><span class="line">		<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">a</span> <span class="attr">onclick</span>=<span class="string">&quot;f(&#x27;I asked: \x3ci\x3e\x22What\x27s up?\x22\x3c\/i\x3e&#x27;)&quot;</span>&gt;</span></span><br><span class="line">			Onclick</span><br><span class="line">		<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h1 id="不转义"><a href="#不转义" class="headerlink" title="不转义"></a>不转义</h1><p>上下文感知的自动转义能让程序更加安全，比如防止XSS攻击(例如在表单中输入带有<code>&lt;script&gt;...&lt;/script&gt;</code>的内容并提交，会使得用户提交的这部分script被执行)。</p>
<p>如果确实不想转义，可以进行类型转换。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">type CSS</span><br><span class="line">type HTML</span><br><span class="line">type JS</span><br><span class="line">type URL</span><br></pre></td></tr></table></figure>

<p>转换成指定个时候，字符都将是字面意义。</p>
<p>例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	t, _ := template.ParseFiles(<span class="string">&quot;tmpl.html&quot;</span>)</span><br><span class="line">	t.Execute(w, template.HTML(r.FormValue(<span class="string">&quot;comment&quot;</span>)))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>