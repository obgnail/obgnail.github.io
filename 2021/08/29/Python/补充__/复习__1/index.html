<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="装饰器复习"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>1 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Python/" rel="tag">Python</a></div><div class="post-time">2021-08-29</div></div></div><div class="container post-header"><h1>1</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="toc-number">1.</span> <span class="toc-text">函数装饰器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%87%BD%E6%95%B0%E8%A3%85%E9%A5%B0%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.</span> <span class="toc-text">1.函数装饰函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%87%BD%E6%95%B0%E8%A3%85%E9%A5%B0%E7%B1%BB%E6%96%B9%E6%B3%95"><span class="toc-number">1.2.</span> <span class="toc-text">2.函数装饰类方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E7%B1%BB%E8%A3%85%E9%A5%B0%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.</span> <span class="toc-text">3.类装饰函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E7%B1%BB%E8%A3%85%E9%A5%B0%E7%B1%BB%E6%96%B9%E6%B3%95"><span class="toc-number">1.4.</span> <span class="toc-text">4.类装饰类方法</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="toc-number">2.</span> <span class="toc-text">类装饰器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%87%BD%E6%95%B0%E8%A3%85%E9%A5%B0%E7%B1%BB"><span class="toc-number">2.1.</span> <span class="toc-text">1.函数装饰类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E7%B1%BB%E8%A3%85%E9%A5%B0%E7%B1%BB"><span class="toc-number">2.2.</span> <span class="toc-text">2.类装饰类</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A3%85%E9%A5%B0%E5%99%A8%E7%9A%84%E5%B5%8C%E5%A5%97"><span class="toc-number">3.</span> <span class="toc-text">装饰器的嵌套</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%A6%E5%8F%82%E6%95%B0%E7%9A%84%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="toc-number">4.</span> <span class="toc-text">带参数的装饰器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%87%BD%E6%95%B0%E8%A3%85%E9%A5%B0%E5%87%BD%E6%95%B0-1"><span class="toc-number">4.1.</span> <span class="toc-text">1.函数装饰函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E7%B1%BB%E8%A3%85%E9%A5%B0%E5%87%BD%E6%95%B0"><span class="toc-number">4.2.</span> <span class="toc-text">2.类装饰函数</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%A4%8D%E4%B9%A0"><span class="toc-number"></span> <span class="toc-text">正则表达式复习</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E9%9D%A2%E5%AD%97%E7%AC%A6%E5%87%BA%E7%8E%B0%E7%9A%84%E6%AC%A1%E6%95%B0%E4%B8%BA1%E6%88%960"><span class="toc-number">1.</span> <span class="toc-text">?前面字符出现的次数为1或0</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%98%AF%E8%B4%AA%E5%A9%AA%E7%9A%84"><span class="toc-number">2.</span> <span class="toc-text">|是贪婪的</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%84%E4%B8%AA%E5%88%86%E7%BB%84"><span class="toc-number">3.</span> <span class="toc-text">各个分组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Python%E9%87%8C%E7%9A%84%E6%AD%A3%E5%88%99"><span class="toc-number">4.</span> <span class="toc-text">Python里的正则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%87%E5%BF%97%E7%AC%A6"><span class="toc-number">5.</span> <span class="toc-text">标志符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8D%95%E8%8E%B7%E5%88%86%E7%BB%84-%E5%8E%BB%E9%87%8D%E5%A4%84%E7%90%86"><span class="toc-number">6.</span> <span class="toc-text">捕获分组(去重处理)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Xpath%E5%A4%8D%E4%B9%A0"><span class="toc-number"></span> <span class="toc-text">Xpath复习</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8and%E5%87%BD%E6%95%B0%E6%9D%A5%E8%8E%B7%E5%8F%96%E5%A4%9A%E5%B1%9E%E6%80%A7%E7%9A%84%E6%A0%87%E7%AD%BE"><span class="toc-number">1.</span> <span class="toc-text">使用and函数来获取多属性的标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E5%80%BC%E5%B1%9E%E6%80%A7%E8%8E%B7%E5%8F%96"><span class="toc-number">2.</span> <span class="toc-text">多值属性获取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%AA%E7%B1%BB%E9%80%89%E6%8B%A9%E5%99%A8"><span class="toc-number">3.</span> <span class="toc-text">伪类选择器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E7%B3%BB%E8%8A%82%E7%82%B9"><span class="toc-number">4.</span> <span class="toc-text">关系节点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Celery%E5%A4%8D%E4%B9%A0"><span class="toc-number"></span> <span class="toc-text">Celery复习</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">使用流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.</span> <span class="toc-text">示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E5%B7%A5%E4%BD%9C%E6%B5%81"><span class="toc-number">4.</span> <span class="toc-text">设计工作流</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#signature"><span class="toc-number">4.1.</span> <span class="toc-text">signature</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Group"><span class="toc-number">4.2.</span> <span class="toc-text">Group</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Chains"><span class="toc-number">4.3.</span> <span class="toc-text">Chains</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Chords"><span class="toc-number">4.4.</span> <span class="toc-text">Chords</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%93%BE%E5%BC%8F%E4%BB%BB%E5%8A%A1"><span class="toc-number">5.</span> <span class="toc-text">链式任务</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Django%E5%A4%8D%E4%B9%A0"><span class="toc-number"></span> <span class="toc-text">Django复习</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-N%E9%97%AE%E9%A2%98"><span class="toc-number">1.</span> <span class="toc-text">1+N问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E5%AF%B9%E5%A4%9A%E6%9F%A5%E6%89%BE-%E9%98%B2%E6%AD%A21-N%E9%97%AE%E9%A2%98"><span class="toc-number">2.</span> <span class="toc-text">一对多查找(防止1+N问题)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E5%AF%B9%E5%A4%9A%E6%9F%A5%E6%89%BE-%E9%98%B2%E6%AD%A21-N%E9%97%AE%E9%A2%98"><span class="toc-number">3.</span> <span class="toc-text">多对多查找(防止1+N问题)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-N%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93"><span class="toc-number">4.</span> <span class="toc-text">1+N问题总结</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0"><span class="toc-number">5.</span> <span class="toc-text">聚合函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#groupby%E8%A6%81%E4%BD%BF%E7%94%A8annotate"><span class="toc-number">6.</span> <span class="toc-text">groupby要使用annotate</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A8%A1%E5%9E%8B%E7%AE%A1%E7%90%86%E5%99%A8"><span class="toc-number">7.</span> <span class="toc-text">自定义模型管理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A0%87%E7%AD%BE%E5%92%8C%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">8.</span> <span class="toc-text">自定义标签和过滤器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E6%A0%87%E7%AD%BE%E7%A4%BA%E4%BE%8B"><span class="toc-number">8.1.</span> <span class="toc-text">定义标签示例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E8%BF%87%E6%BB%A4%E5%99%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">8.2.</span> <span class="toc-text">定义过滤器示例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#session"><span class="toc-number">9.</span> <span class="toc-text">session</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF"><span class="toc-number">10.</span> <span class="toc-text">模板</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6"><span class="toc-number">11.</span> <span class="toc-text">静态文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%89%E6%9C%88%E5%BD%92%E6%A1%A3"><span class="toc-number">12.</span> <span class="toc-text">按月归档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AbstractUser"><span class="toc-number">13.</span> <span class="toc-text">AbstractUser</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#form"><span class="toc-number">14.</span> <span class="toc-text">form</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E7%A0%81%E5%85%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">15.</span> <span class="toc-text">验证码全流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%85%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">16.</span> <span class="toc-text">用户全流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E9%A1%B5"><span class="toc-number">17.</span> <span class="toc-text">分页</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ListView"><span class="toc-number">18.</span> <span class="toc-text">ListView</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DetailView"><span class="toc-number">19.</span> <span class="toc-text">DetailView</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Django-rest-framework"><span class="toc-number"></span> <span class="toc-text">Django rest framework</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81"><span class="toc-number">1.</span> <span class="toc-text">认证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%83%E9%99%90"><span class="toc-number">2.</span> <span class="toc-text">权限</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E6%B5%81"><span class="toc-number">3.</span> <span class="toc-text">节流</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%88%E6%9C%AC"><span class="toc-number">4.</span> <span class="toc-text">版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E5%99%A8"><span class="toc-number">5.</span> <span class="toc-text">解析器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">6.</span> <span class="toc-text">序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AF%B9%E8%AF%B7%E6%B1%82%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E6%A0%A1%E9%AA%8C"><span class="toc-number">6.1.</span> <span class="toc-text">对请求数据进行校验</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AF%B9QuerySet%E8%BF%9B%E8%A1%8C%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">6.2.</span> <span class="toc-text">对QuerySet进行序列化</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E9%A1%B5-1"><span class="toc-number">7.</span> <span class="toc-text">分页</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9C%8B%E7%AC%ACn%E9%A1%B5%EF%BC%8C%E6%AF%8F%E9%A1%B5%E6%98%BE%E7%A4%BAn%E6%9D%A1%E6%95%B0%E6%8D%AE%EF%BC%8C"><span class="toc-number">7.1.</span> <span class="toc-text">看第n页，每页显示n条数据，</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9C%A8%E6%9F%90%E4%B8%AA%E4%BD%8D%E7%BD%AE%EF%BC%8C%E5%90%91%E5%90%8E%E6%9F%A5%E7%9C%8Bn%E6%9D%A1%E6%95%B0%E6%8D%AE"><span class="toc-number">7.2.</span> <span class="toc-text">在某个位置，向后查看n条数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A0%E5%AF%86%E5%88%86%E9%A1%B5%EF%BC%8C%E5%8F%AA%E8%83%BD%E7%9C%8B%E4%B8%8A%E4%B8%80%E9%A1%B5%E5%92%8C%E4%B8%8B%E4%B8%80%E9%A1%B5"><span class="toc-number">7.3.</span> <span class="toc-text">加密分页，只能看上一页和下一页</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%86%E5%9B%BE"><span class="toc-number">8.</span> <span class="toc-text">视图</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#GenericAPIView"><span class="toc-number">8.1.</span> <span class="toc-text">GenericAPIView</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#GenericViewSet"><span class="toc-number">8.2.</span> <span class="toc-text">GenericViewSet</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ModelViewSet"><span class="toc-number">8.3.</span> <span class="toc-text">ModelViewSet</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1"><span class="toc-number">9.</span> <span class="toc-text">路由</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B8%B2%E6%9F%93%E5%99%A8"><span class="toc-number">10.</span> <span class="toc-text">渲染器</span></a></li></ol></details></div><div class="container post-content"><p>装饰器复习</p>
<blockquote>
<p>函数装饰器有4种，类装饰器有2种</p>
</blockquote>
<h4 id="函数装饰器"><a href="#函数装饰器" class="headerlink" title="函数装饰器"></a>函数装饰器</h4><h5 id="1-函数装饰函数"><a href="#1-函数装饰函数" class="headerlink" title="1.函数装饰函数"></a>1.函数装饰函数</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> perf_counter</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">time_counter</span>(<span class="params">func</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args,**kwargs</span>):</span></span><br><span class="line">        start = perf_counter()</span><br><span class="line">        func(*args,**kwargs)</span><br><span class="line">        <span class="built_in">print</span>(perf_counter() - start)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@time_counter</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span>():</span></span><br><span class="line">    [num <span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">55555</span>)]</span><br><span class="line"></span><br><span class="line">foo()</span><br></pre></td></tr></table></figure>

<h5 id="2-函数装饰类方法"><a href="#2-函数装饰类方法" class="headerlink" title="2.函数装饰类方法"></a>2.函数装饰类方法</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> perf_counter</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">time_counter</span>(<span class="params">func</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args,**kwargs</span>):</span></span><br><span class="line">        start = perf_counter()</span><br><span class="line">        func(*args,**kwargs)</span><br><span class="line">        <span class="built_in">print</span>(perf_counter() - start)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line"><span class="meta">    @time_counter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">foo</span>(<span class="params">self</span>):</span></span><br><span class="line">        [num <span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">55555</span>)]</span><br><span class="line"></span><br><span class="line">a = A()</span><br><span class="line">a.foo()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上面两个装饰器一模一样 , 也就是说,<strong>函数装饰器能无差别的运用于函数和类方法</strong></p>
</blockquote>
<h5 id="3-类装饰函数"><a href="#3-类装饰函数" class="headerlink" title="3.类装饰函数"></a>3.类装饰函数</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> perf_counter</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimeCounter</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,func</span>):</span></span><br><span class="line">        self.func = func</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self,*args,**kwargs</span>):</span></span><br><span class="line">        start = perf_counter()</span><br><span class="line">        self.func(*args,**kwargs)</span><br><span class="line">        <span class="built_in">print</span>(perf_counter() - start)</span><br><span class="line"></span><br><span class="line"><span class="meta">@TimeCounter</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span>():</span></span><br><span class="line">    [num <span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">55555</span>)]</span><br><span class="line"></span><br><span class="line">foo()</span><br></pre></td></tr></table></figure>

<h5 id="4-类装饰类方法"><a href="#4-类装饰类方法" class="headerlink" title="4.类装饰类方法"></a>4.类装饰类方法</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> perf_counter</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimeCounter</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,func</span>):</span></span><br><span class="line">        self.func = func</span><br><span class="line">        self.cls = self.__class__</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self,*args,**kwargs</span>):</span></span><br><span class="line">        start = perf_counter()</span><br><span class="line">        <span class="comment"># 需要添加一个self.cls参数</span></span><br><span class="line">        self.func(self.cls,*args,**kwargs)</span><br><span class="line">        <span class="built_in">print</span>(perf_counter() - start)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line"><span class="meta">    @TimeCounter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">foo</span>(<span class="params">self</span>):</span></span><br><span class="line">        [num <span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">55555</span>)]</span><br><span class="line"></span><br><span class="line">a = A()</span><br><span class="line">a.foo()</span><br></pre></td></tr></table></figure>



<h4 id="类装饰器"><a href="#类装饰器" class="headerlink" title="类装饰器"></a>类装饰器</h4><p><strong>类装饰器要返回另外一个类</strong></p>
<h5 id="1-函数装饰类"><a href="#1-函数装饰类" class="headerlink" title="1.函数装饰类"></a>1.函数装饰类</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deco</span>(<span class="params">cls</span>):</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Wrapper</span>:</span></span><br><span class="line">		<span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,*args,**kwargs</span>):</span></span><br><span class="line">			self.wrapped = cls(*args,**kwargs)</span><br><span class="line">		<span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span>(<span class="params">self,name</span>):</span></span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">getattr</span>(self.wrapped,name)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> Wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@deco</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,x,y</span>):</span></span><br><span class="line">		self.attr = <span class="string">&#x27;spam&#x27;</span></span><br><span class="line"></span><br><span class="line">c = C(<span class="number">6</span>,<span class="number">7</span>)</span><br><span class="line"><span class="built_in">print</span>(c.attr)  <span class="comment"># spam</span></span><br></pre></td></tr></table></figure>

<h5 id="2-类装饰类"><a href="#2-类装饰类" class="headerlink" title="2.类装饰类"></a>2.类装饰类</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Deco</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,cls</span>):</span></span><br><span class="line">        self.cls = cls</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self,*args,**kwargs</span>):</span></span><br><span class="line">        self.wrapped = self.cls(*args,**kwargs)</span><br><span class="line">        <span class="keyword">return</span> self.wrapped</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span>(<span class="params">self,name</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">getattr</span>(self.wrapped,name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Deco</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,name</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line"></span><br><span class="line">c = C(<span class="string">&#x27;heyingliang&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(c.name)   <span class="comment"># heyingliang</span></span><br></pre></td></tr></table></figure>



<h4 id="装饰器的嵌套"><a href="#装饰器的嵌套" class="headerlink" title="装饰器的嵌套"></a>装饰器的嵌套</h4><p>装饰器的进入顺序 : <strong>由上到下</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deco1</span>(<span class="params">func</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args,**kwargs</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;deco1&#x27;</span>)</span><br><span class="line">        func(*args,**kwargs)</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deco2</span>(<span class="params">func</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args,**kwargs</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;deco2&#x27;</span>)</span><br><span class="line">        func(*args,**kwargs)</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@deco1</span></span><br><span class="line"><span class="meta">@deco2</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>():</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">func()</span><br><span class="line"><span class="comment"># deco1</span></span><br><span class="line"><span class="comment"># deco2</span></span><br></pre></td></tr></table></figure>



<h4 id="带参数的装饰器"><a href="#带参数的装饰器" class="headerlink" title="带参数的装饰器"></a>带参数的装饰器</h4><h5 id="1-函数装饰函数-1"><a href="#1-函数装饰函数-1" class="headerlink" title="1.函数装饰函数"></a>1.函数装饰函数</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deco</span>(<span class="params">func_name</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">func</span>):</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapped</span>(<span class="params">*args,**kwargs</span>):</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;--- in deco : <span class="subst">&#123;func_name&#125;</span>---&#x27;</span>)</span><br><span class="line">            func(*args,**kwargs)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;--- end deco: <span class="subst">&#123;func_name&#125;</span> ---&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> wrapped</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@deco(<span class="params"><span class="string">&#x27;foo&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>():</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">func()</span><br></pre></td></tr></table></figure>

<h5 id="2-类装饰函数"><a href="#2-类装饰函数" class="headerlink" title="2.类装饰函数"></a>2.类装饰函数</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deco</span>(<span class="params">func_name</span>):</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">wrapped</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,func</span>):</span></span><br><span class="line">            self.func = func</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self,*args,**kwargs</span>):</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;--- in deco : <span class="subst">&#123;func_name&#125;</span>---&#x27;</span>)</span><br><span class="line">            self.func(*args,**kwargs)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;--- end deco: <span class="subst">&#123;func_name&#125;</span> ---&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapped</span><br><span class="line"></span><br><span class="line"><span class="meta">@deco(<span class="params"><span class="string">&#x27;foo&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>():</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">func()</span><br></pre></td></tr></table></figure>



<h2 id="正则表达式复习"><a href="#正则表达式复习" class="headerlink" title="正则表达式复习"></a>正则表达式复习</h2><h4 id="前面字符出现的次数为1或0"><a href="#前面字符出现的次数为1或0" class="headerlink" title="?前面字符出现的次数为1或0"></a>?前面字符出现的次数为1或0</h4><p><code>?</code> : <strong>前面字符</strong>出现的次数为1或者为0</p>
<blockquote>
<p>注意,是前面字符出现的次数,不是后面字符出现的次数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">x = <span class="string">r&#x27;\(?0\d&#123;2&#125;[) -]?\d&#123;8&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(re.search(x,<span class="string">&#x27;(010)88886666&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(re.search(x,<span class="string">&#x27;022-22334455&#x27;</span>))</span><br><span class="line"><span class="comment"># &lt;re.Match object; span=(0, 13), match=&#x27;(010)88886666&#x27;&gt;</span></span><br><span class="line"><span class="comment"># &lt;re.Match object; span=(0, 12), match=&#x27;022-22334455&#x27;&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="是贪婪的"><a href="#是贪婪的" class="headerlink" title="|是贪婪的"></a>|是贪婪的</h4><p>x|y : 匹配x或y。</p>
<blockquote>
<p><code>z|food</code>能匹配 z 或 food。<code>(z|f)ood</code>则匹配 zood 或 food 。</p>
</blockquote>
<p>也就是说 : <code>|</code>是贪婪的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">x = <span class="string">r&#x27;0\d&#123;4&#125;-\d&#123;5&#125;|\d&#123;5&#125;&#x27;</span></span><br><span class="line">y = <span class="string">r&#x27;\d&#123;4&#125;-\d&#123;5&#125;|\d&#123;5&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(re.search(y,<span class="string">&#x27;4444-12345&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(re.search(y,<span class="string">&#x27;12345&#x27;</span>))</span><br><span class="line"><span class="comment"># &lt;re.Match object; span=(0, 10), match=&#x27;4444-12345&#x27;&gt;</span></span><br><span class="line"><span class="comment"># &lt;re.Match object; span=(0, 5), match=&#x27;12345&#x27;&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(re.search(x,<span class="string">&#x27;4444-12345&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(re.search(x,<span class="string">&#x27;12345&#x27;</span>))</span><br><span class="line"><span class="comment"># &lt;re.Match object; span=(5, 10), match=&#x27;12345&#x27;&gt;</span></span><br><span class="line"><span class="comment"># &lt;re.Match object; span=(0, 5), match=&#x27;12345&#x27;&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="各个分组"><a href="#各个分组" class="headerlink" title="各个分组"></a>各个分组</h4><p>注意 :<br>这些<strong>分组的括号都是加在最前面</strong></p>
<table>
<thead>
<tr>
<th align="left">(pattern)</th>
<th>匹配pattern并获取这一匹配。所获取的匹配可以从产生的Matches集合得到，在VBScript中使用SubMatches集合，在JScript中则使用$0…$9属性。要匹配圆括号字符，请使用“<code>\(</code>”或“<code>\)</code>”。</th>
</tr>
</thead>
<tbody><tr>
<td align="left">(?:pattern)</td>
<td>匹配pattern但不获取匹配结果，也就是说这是一个非获取匹配，不进行存储供以后使用。这在使用或字符“`(</td>
</tr>
<tr>
<td align="left">(?=pattern)</td>
<td>正向肯定预查，在任何匹配pattern的字符串开始处匹配查找字符串。这是一个非获取匹配，也就是说，该匹配不需要获取供以后使用。例如，“`Windows(?=95</td>
</tr>
<tr>
<td align="left">(?!pattern)</td>
<td>正向否定预查，在任何不匹配pattern的字符串开始处匹配查找字符串。这是一个非获取匹配，也就是说，该匹配不需要获取供以后使用。例如“`Windows(?!95</td>
</tr>
<tr>
<td align="left">(?&lt;=pattern)</td>
<td>反向肯定预查，与正向肯定预查类拟，只是方向相反。例如，“`(?&lt;=95</td>
</tr>
<tr>
<td align="left">(?&lt;!pattern)</td>
<td>反向否定预查，与正向否定预查类拟，只是方向相反。例如“`(?&lt;!95</td>
</tr>
</tbody></table>
<h4 id="Python里的正则"><a href="#Python里的正则" class="headerlink" title="Python里的正则"></a>Python里的正则</h4><table>
<thead>
<tr>
<th align="left">方法</th>
<th align="left">功能</th>
</tr>
</thead>
<tbody><tr>
<td align="left">match()</td>
<td align="left">判断一个正则表达式是否从开始处匹配一个字符串</td>
</tr>
<tr>
<td align="left">search()</td>
<td align="left">遍历字符串，找到正则表达式匹配的第一个位置</td>
</tr>
<tr>
<td align="left">findall()</td>
<td align="left">遍历字符串，找到正则表达式匹配的所有位置，并以列表的形式返回</td>
</tr>
<tr>
<td align="left">finditer()</td>
<td align="left">遍历字符串，找到正则表达式匹配的所有位置，并以迭代器的形式返回</td>
</tr>
</tbody></table>
<p>匹配对象的属性方法</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>group()</td>
<td>返回匹配的字符串</td>
</tr>
<tr>
<td>start()</td>
<td>返回匹配的开始位置</td>
</tr>
<tr>
<td>end()</td>
<td>返回匹配的结束位置</td>
</tr>
<tr>
<td>span()</td>
<td>返回一个元组表示匹配位置（开始，结束）</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>方法</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>split()</td>
<td>在正则表达式匹配的地方进行分割，并返回一个列表</td>
</tr>
<tr>
<td>sub()</td>
<td>找到所有匹配的子字符串，并替换为新的内容</td>
</tr>
<tr>
<td>subn()</td>
<td>跟 sub() 干一样的勾当，但返回新的字符串以及替换的数目</td>
</tr>
</tbody></table>
<h4 id="标志符"><a href="#标志符" class="headerlink" title="标志符"></a>标志符</h4><table>
<thead>
<tr>
<th>标志</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>ASCII,A</td>
<td>使得转义符号如\w，\b，\s和\d只能匹配ASCII字符</td>
</tr>
<tr>
<td>DOTALL,S</td>
<td>使得.匹配任何符号，包括换行符</td>
</tr>
<tr>
<td>IGNORECASE,I</td>
<td>匹配的时候不区分大小写</td>
</tr>
<tr>
<td>LOCALE,L</td>
<td>支持当前的语言（区域）设置</td>
</tr>
<tr>
<td>MULTILINE,M</td>
<td>多行匹配，影响^和$</td>
</tr>
<tr>
<td>VERBOSE,X(for’extended’)</td>
<td>启用详细的正则表达式</td>
</tr>
</tbody></table>
<h4 id="捕获分组-去重处理"><a href="#捕获分组-去重处理" class="headerlink" title="捕获分组(去重处理)"></a>捕获分组(去重处理)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">s = <span class="string">&quot;我..我我.我.....要..要要要要要.....学..学学学........编..编.编........程.程.程程&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">regex</span>(<span class="params">s</span>):</span></span><br><span class="line">    s = re.sub(<span class="string">r&#x27;\.&#x27;</span>,<span class="string">&#x27;&#x27;</span>,s)</span><br><span class="line">    <span class="comment"># 注意&#x27;\1&#x27;前面必须添加一个r</span></span><br><span class="line">    s = re.sub(<span class="string">r&#x27;(.)\1+&#x27;</span>,<span class="string">r&#x27;\1&#x27;</span>,s)</span><br><span class="line">    <span class="built_in">print</span>(s)</span><br><span class="line"></span><br><span class="line">regex(s)  <span class="comment"># 我要学编程</span></span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li><code>(.)</code>匹配一个字符</li>
<li><code>(.)\1</code>匹配两个相同的字符</li>
<li><code>(.)\1+</code>匹配多个相同的字符</li>
</ul>
</blockquote>
<h2 id="Xpath复习"><a href="#Xpath复习" class="headerlink" title="Xpath复习"></a>Xpath复习</h2><table>
<thead>
<tr>
<th>表达式</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>nodename</td>
<td>选取此节点的所有子节点。</td>
</tr>
<tr>
<td>/</td>
<td>从根节点选取。</td>
</tr>
<tr>
<td>//</td>
<td>从匹配选择的当前节点选择文档中的节点，而不考虑它们的位置。</td>
</tr>
<tr>
<td>.</td>
<td>选取当前节点。</td>
</tr>
<tr>
<td>..</td>
<td>选取当前节点的父节点。</td>
</tr>
<tr>
<td>@</td>
<td>选取属性。</td>
</tr>
</tbody></table>
<blockquote>
<p>简单来说：**/是直接子节点，//是非直接子节点**。注意，这两个都是子节点。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"></span><br><span class="line">html = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;div class=&#x27;content&#x27;&gt;</span></span><br><span class="line"><span class="string">    &lt;ul id=&#x27;haha&#x27;&gt;</span></span><br><span class="line"><span class="string">        &lt;li class=&quot;item-1&quot;&gt;&lt;a href=&quot;link2.html&quot;&gt;first item&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">    &lt;/ul&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">x = etree.HTML(html)</span><br><span class="line">result = x.xpath(<span class="string">&#x27;//div[@class=&quot;content&quot;]//li/a/text()&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(result)  <span class="comment"># [&#x27;first item&#x27;]</span></span><br></pre></td></tr></table></figure>

<h4 id="使用and函数来获取多属性的标签"><a href="#使用and函数来获取多属性的标签" class="headerlink" title="使用and函数来获取多属性的标签"></a>使用and函数来获取多属性的标签</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"></span><br><span class="line">html = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;div class=&#x27;content&#x27;&gt;</span></span><br><span class="line"><span class="string">    &lt;ul id=&#x27;haha&#x27;&gt;</span></span><br><span class="line"><span class="string">        &lt;li class=&quot;item-1&quot; name=&quot;hyl&quot;&gt;&lt;a href=&quot;link2.html&quot;&gt;first item&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">    &lt;/ul&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">x = etree.HTML(html)</span><br><span class="line">result = x.xpath(<span class="string">&#x27;//div//li[@class=&quot;item-1&quot; and @name=&quot;hyl&quot;]/a/text()&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(result)  <span class="comment"># [&#x27;first item&#x27;]</span></span><br></pre></td></tr></table></figure>

<h4 id="多值属性获取"><a href="#多值属性获取" class="headerlink" title="多值属性获取"></a>多值属性获取</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"></span><br><span class="line">html = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;div class=&#x27;content&#x27;&gt;</span></span><br><span class="line"><span class="string">    &lt;ul id=&#x27;haha&#x27;&gt;</span></span><br><span class="line"><span class="string">        &lt;li class=&quot;item hyl&quot; &gt;&lt;a href=&quot;link2.html&quot;&gt;first item&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">    &lt;/ul&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">x = etree.HTML(html)</span><br><span class="line">result = x.xpath(<span class="string">&#x27;//div//li[contains(@class,&quot;item hyl&quot;)]/a/text()&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(result)  <span class="comment"># [&#x27;first item&#x27;]</span></span><br></pre></td></tr></table></figure>

<h4 id="伪类选择器"><a href="#伪类选择器" class="headerlink" title="伪类选择器"></a>伪类选择器</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"></span><br><span class="line">html = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;div class=&#x27;content&#x27;&gt;</span></span><br><span class="line"><span class="string">    &lt;ul id=&#x27;haha&#x27;&gt;</span></span><br><span class="line"><span class="string">        &lt;li class=&quot;item-0&quot; &gt;&lt;a href=&quot;link2.html&quot;&gt;1&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">        &lt;li class=&quot;item-1&quot; &gt;&lt;a href=&quot;link2.html&quot;&gt;2&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">        &lt;li class=&quot;item-1&quot; &gt;&lt;a href=&quot;link2.html&quot;&gt;3&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">        &lt;li class=&quot;item-0&quot; &gt;&lt;a href=&quot;link2.html&quot;&gt;4&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">    &lt;/ul&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">x = etree.HTML(html)</span><br><span class="line">result1 = x.xpath(<span class="string">&#x27;//div//li&#x27;</span>)      <span class="comment"># 返回列表</span></span><br><span class="line">result2 = x.xpath(<span class="string">&#x27;//div//li[1]&#x27;</span>)   <span class="comment"># 索引从1开始</span></span><br><span class="line">result3 = x.xpath(<span class="string">&#x27;//div//li[last()]&#x27;</span>) </span><br><span class="line">result4 = x.xpath(<span class="string">&#x27;//div//li[position()&lt;3]&#x27;</span>)</span><br><span class="line">result5 = x.xpath(<span class="string">&#x27;//div//li[last()-2]&#x27;</span>) </span><br></pre></td></tr></table></figure>

<h4 id="关系节点"><a href="#关系节点" class="headerlink" title="关系节点"></a>关系节点</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"></span><br><span class="line">html = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;div class=&#x27;content&#x27;&gt;</span></span><br><span class="line"><span class="string">    &lt;ul id=&#x27;haha&#x27;&gt;</span></span><br><span class="line"><span class="string">        &lt;li class=&quot;item-0&quot; &gt;&lt;a href=&quot;link2.html&quot;&gt;1&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">        &lt;li class=&quot;item-1&quot; &gt;&lt;a href=&quot;link2.html&quot;&gt;2&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">        &lt;li class=&quot;item-1&quot; &gt;&lt;a href=&quot;link2.html&quot;&gt;3&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">        &lt;li class=&quot;item-0&quot; &gt;&lt;a href=&quot;link2.html&quot;&gt;4&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">    &lt;/ul&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">x = etree.HTML(html)</span><br><span class="line">result1 = x.xpath(<span class="string">&#x27;//li/ancestor::*&#x27;</span>)             <span class="comment"># 所有的祖先节点</span></span><br><span class="line">result2 = x.xpath(<span class="string">&#x27;//li[1]/ancestor::ul&#x27;</span>)         <span class="comment"># 所有标签为ul的祖先节点</span></span><br><span class="line">result3 = x.xpath(<span class="string">&#x27;//li[1]/attribute::*&#x27;</span>)         <span class="comment"># li结点的所有属性 </span></span><br><span class="line">result4 = x.xpath(<span class="string">&#x27;//li[2]/child::a&#x27;</span>)             <span class="comment"># 标签为a的子节点</span></span><br><span class="line">result5 = x.xpath(<span class="string">&#x27;//li[2]/descendant::a&#x27;</span>)        <span class="comment"># 标签为a的后裔节点 </span></span><br><span class="line">result6 = x.xpath(<span class="string">&#x27;//li[2]/following::*[2]&#x27;</span>)      <span class="comment"># li节点的后续所有节点,然后再索引第二个节点 </span></span><br><span class="line">result7 = x.xpath(<span class="string">&#x27;//li[2]/following-sibling::*&#x27;</span>) <span class="comment"># li节点的后续同级节点</span></span><br></pre></td></tr></table></figure>



<h2 id="Celery复习"><a href="#Celery复习" class="headerlink" title="Celery复习"></a>Celery复习</h2><h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><ol>
<li><p>任务生产者 ：产生任务并交给任务队列</p>
</li>
<li><p>任务调度 Beat：周期性的产生任务发送给任务队列</p>
</li>
<li><p>中间人（Broker）：消息通信</p>
</li>
<li><p>执行单元 worker：worker监控任务队列，当队列中有新地任务时，它便取出来执行</p>
</li>
<li><p>任务结果存储backend：持久存储 Worker 执行任务的结果</p>
</li>
</ol>
<p><img src="/images/feab0ba5-v2-b59a38b663c3f51d682d5a7528cc680d_r.jpg" alt="v2-b59a38b663c3f51d682d5a7528cc680d_r"></p>
<h4 id="使用流程"><a href="#使用流程" class="headerlink" title="使用流程"></a>使用流程</h4><ol>
<li>创建APP</li>
<li>APP加载配置</li>
<li>使用APP去装饰一个函数</li>
<li>使用命令行启动Celery</li>
<li>外部使用delay调用这个函数</li>
</ol>
<blockquote>
<ul>
<li>使用<code>定时任务</code>只需要修改<code>celery_config.py</code>即可</li>
<li>启动 Celery Beat 进程</li>
</ul>
</blockquote>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">celery_demo                    # 项目根目录</span><br><span class="line">    ├── celery_app             # 存放 celery 相关文件</span><br><span class="line">    │   ├── __init__.py       # 创建app,初始化配置</span><br><span class="line">    │   ├── celeryconfig.py    # 配置文件</span><br><span class="line">    │   └── task.py           # 任务文件 </span><br><span class="line">    └── client.py              # 应用程序</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># __init__.py</span></span><br><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery</span><br><span class="line"></span><br><span class="line">app = Celery(<span class="string">&#x27;demo&#x27;</span>)                                <span class="comment"># 创建 Celery 实例</span></span><br><span class="line">app.config_from_object(<span class="string">&#x27;celery_app.celeryconfig&#x27;</span>)   <span class="comment"># 通过 Celery 实例加载配置模块</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># celeryconfig.py</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> timedelta</span><br><span class="line"></span><br><span class="line">BROKER_URL = <span class="string">&#x27;redis://127.0.0.1:6379&#x27;</span>               <span class="comment"># 指定 Broker</span></span><br><span class="line">CELERY_RESULT_BACKEND = <span class="string">&#x27;redis://127.0.0.1:6379/0&#x27;</span>  <span class="comment"># 指定 Backend</span></span><br><span class="line"></span><br><span class="line">CELERY_TIMEZONE=<span class="string">&#x27;Asia/Shanghai&#x27;</span>                     <span class="comment"># 指定时区，默认是 UTC</span></span><br><span class="line"><span class="comment"># CELERY_TIMEZONE=&#x27;UTC&#x27;                             </span></span><br><span class="line"></span><br><span class="line">CELERY_IMPORTS = (                                  <span class="comment"># 指定导入的任务模块</span></span><br><span class="line">    <span class="string">&#x27;celery_app.task&#x27;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">CELERYBEAT_SCHEDULE = &#123;</span><br><span class="line">    <span class="string">&#x27;add-every-3-seconds&#x27;</span>: &#123;</span><br><span class="line">         <span class="string">&#x27;task&#x27;</span>: <span class="string">&#x27;celery_app.task.printer&#x27;</span>,</span><br><span class="line">         <span class="string">&#x27;schedule&#x27;</span>: timedelta(seconds=<span class="number">3</span>),       <span class="comment"># 每 3 秒执行一次</span></span><br><span class="line">         <span class="string">&#x27;args&#x27;</span>: (<span class="number">5</span>,)                             <span class="comment"># 任务函数参数</span></span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># task.py</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> celery_app <span class="keyword">import</span> app</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.task</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printer</span>(<span class="params">num</span>):</span></span><br><span class="line">	time.sleep(<span class="number">2</span>)</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&#x27;--------------&#x27;</span>,num)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># client.py</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> celery_app.task <span class="keyword">import</span> printer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	now = time.time()</span><br><span class="line">	printer.delay(<span class="number">5</span>)</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&#x27;----&#x27;</span>,time.time()-now)</span><br></pre></td></tr></table></figure>

<p>启动worker</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">celery -A celery_app worker -l info -P eventlet</span><br></pre></td></tr></table></figure>

<p>启动beat</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">celery beat -A celery_app</span><br></pre></td></tr></table></figure>



<h4 id="设计工作流"><a href="#设计工作流" class="headerlink" title="设计工作流"></a>设计工作流</h4><p>签名包装了一个任务的<strong>调用参数</strong>和<strong>执行参数</strong></p>
<h5 id="signature"><a href="#signature" class="headerlink" title="signature"></a>signature</h5><p>当成偏函数使用:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># def add(num1,num2)为被app.task装饰的函数</span></span><br><span class="line">s1 = add.s(<span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">res = s1.delay()</span><br><span class="line">res.get()</span><br><span class="line"><span class="comment"># 4</span></span><br></pre></td></tr></table></figure>

<h5 id="Group"><a href="#Group" class="headerlink" title="Group"></a>Group</h5><p>group并行地执行一个任务列表，按顺序返回一个特殊的<strong>结果实例</strong>(GroupResult对象)(所以可以使用<code>.get()</code>获取值)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> group</span><br><span class="line"><span class="keyword">from</span> proj.tasks <span class="keyword">import</span> add</span><br><span class="line"></span><br><span class="line"> group(add.s(i, i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>))().get()</span><br><span class="line"><span class="comment"># [0, 2, 4, 6, 8, 10, 12, 14, 16, 18]</span></span><br></pre></td></tr></table></figure>

<ul>
<li>group(add.s(i, i) for i in range(10) : 返回<code>&lt;class &#39;celery.canvas.group&#39;&gt;</code></li>
<li>group(add.s(i, i) for i in range(10)() : 返回<code>&lt;class &#39;celery.result.GroupResult&#39;&gt;</code></li>
<li>group(add.s(i, i) for i in range(10))().get() : 返回 <code>[0, 2, 4, 6, 8, 10, 12, 14, 16, 18]</code></li>
</ul>
<h5 id="Chains"><a href="#Chains" class="headerlink" title="Chains"></a>Chains</h5><p>任务可以像使用管道一样连接在一起，前一个执行完成后会执行下一个：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> chain</span><br><span class="line"><span class="keyword">from</span> proj.tasks <span class="keyword">import</span> add, mul</span><br><span class="line"></span><br><span class="line"><span class="comment"># (4 + 4) * 8</span></span><br><span class="line"><span class="comment"># add.s(4, 4)的值当成是 mul.s()的第二个参数</span></span><br><span class="line">chain(add.s(<span class="number">4</span>, <span class="number">4</span>) | mul.s(<span class="number">8</span>))().get()</span><br><span class="line"><span class="comment"># 64</span></span><br></pre></td></tr></table></figure>



<h5 id="Chords"><a href="#Chords" class="headerlink" title="Chords"></a>Chords</h5><p>chord是一个带回调函数的group</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> chord</span><br><span class="line"><span class="keyword">from</span> proj.tasks <span class="keyword">import</span> add, xsum</span><br><span class="line"></span><br><span class="line">chord((add.s(i, i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)), <span class="built_in">sum</span>.s())().get()</span><br><span class="line"><span class="comment">#90</span></span><br></pre></td></tr></table></figure>



<h4 id="链式任务"><a href="#链式任务" class="headerlink" title="链式任务"></a>链式任务</h4><p>尽量使用异步回调的方式进行链式任务的调用</p>
<p>错误示范</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.task</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fetch_page</span>(<span class="params">url</span>):</span></span><br><span class="line">    <span class="keyword">return</span> myhttplib.get(url)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.task</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_page</span>(<span class="params">url, page</span>):</span></span><br><span class="line">    <span class="keyword">return</span> myparser.parse_document(page)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.task</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">store_page_info</span>(<span class="params">url, info</span>):</span></span><br><span class="line">    <span class="keyword">return</span> PageInfo.objects.create(url, info)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.task</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">url</span>):</span></span><br><span class="line">    <span class="comment"># fetch_page -&gt; parse_page -&gt; store_page</span></span><br><span class="line">    page = fetch_page.delay(url).get()</span><br><span class="line">    info = parse_page.delay(url, page).get()</span><br><span class="line">    store_page_info.delay(url, info)</span><br></pre></td></tr></table></figure>

<p>正确示范:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.task()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fetch_page</span>(<span class="params">url</span>):</span></span><br><span class="line">    <span class="keyword">return</span> myhttplib.get(url)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.task()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_page</span>(<span class="params">page</span>):</span></span><br><span class="line">    <span class="keyword">return</span> myparser.parse_document(page)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.task(<span class="params">ignore_result=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">store_page_info</span>(<span class="params">info, url</span>):</span></span><br><span class="line">    PageInfo.objects.create(url=url, info=info)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">url</span>):</span></span><br><span class="line">    <span class="comment"># fetch_page -&gt; parse_page -&gt; store_page</span></span><br><span class="line">    <span class="comment"># fetch_page的返回值当成parse_page的参数,parse_page的返回值当成store_page_info的参数</span></span><br><span class="line">    chain = fetch_page.s(url) | parse_page.s() | store_page_info.s(url)</span><br><span class="line">    chain()</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li><strong>链式任务中前一个任务的返回值默认是下一个任务的输入值之一</strong></li>
<li>不想让返回值做默认参数可以用 si() 或者 s(immutable=True) 的方式调用 。</li>
</ul>
</blockquote>
<h2 id="Django复习"><a href="#Django复习" class="headerlink" title="Django复习"></a>Django复习</h2><h4 id="1-N问题"><a href="#1-N问题" class="headerlink" title="1+N问题"></a>1+N问题</h4><blockquote>
<ul>
<li>1+N问题是针对于外键的</li>
<li>1+N问题是针对<code>多条数据</code>查找的</li>
</ul>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># User和Post是一对多的关系，也就是User是Post的外键。</span></span><br><span class="line"></span><br><span class="line">posts = Post.objects.<span class="built_in">all</span>()  <span class="comment">#  获取所有的文章数据，注意此时不会执行sql语句  by the5fire</span></span><br><span class="line">result = []</span><br><span class="line"><span class="keyword">for</span> post <span class="keyword">in</span> posts:   <span class="comment"># 此时会执行select * from post的查询</span></span><br><span class="line">    result.append(&#123;</span><br><span class="line">        <span class="string">&#x27;title&#x27;</span>: post.title,</span><br><span class="line">        <span class="string">&#x27;owner&#x27;</span>: post.owner.name,  <span class="comment"># 此时会执行  select * from user where user_id = &lt;post.user_id&gt;</span></span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<p>上面代码中,我们是<strong>查找所有文章的作者</strong>,这样肯定会带来1+N问题,这时候就可以使用select_related</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Post.objects.select_related(<span class="string">&#x27;user&#x27;</span>).<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure>

<p>但是针对于单个查找,比如说<strong>查找文章名为”a”的文章的作者</strong>,就可以直接使用<code>.外键字段</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 .外键字段</span></span><br><span class="line">Post.objects.<span class="built_in">filter</span>(title__exact=<span class="string">&#x27;a&#x27;</span>).owner.name</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>Post.objects.select_related(&#39;user&#39;).all()</code>和<code>Post.objects.filter(title__exact=&#39;a&#39;).owner.name</code>的关系有点像</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from post join user on post.owner = user.user_id</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select name from user where user_id in (</span><br><span class="line">	select owner from  post where post.title=&#x27;a&#x27;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="一对多查找-防止1-N问题"><a href="#一对多查找-防止1-N问题" class="headerlink" title="一对多查找(防止1+N问题)"></a>一对多查找(防止1+N问题)</h4><p>连接两个表 : <code>User.objects.all().select_related(&#39;外键字段&#39;)</code></p>
<p>连接三个表 : <code>User.objects.all().select_related(&#39;外键字段__外键字段&#39;)</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">########### 连接两个表 ########### </span></span><br><span class="line"><span class="comment"># category是Article模型的一个字段</span></span><br><span class="line">articles = Article.objects.<span class="built_in">all</span>().select_related(<span class="string">&#x27;category&#x27;</span>)</span><br><span class="line"><span class="comment"># category__name__exact=&#x27;Life&#x27;:category表的name字典=Life</span></span><br><span class="line">Life_article = articles.<span class="built_in">filter</span>(category__name__exact=<span class="string">&#x27;Life&#x27;</span>).order_by(<span class="string">&#x27;-create_time&#x27;</span>)[:<span class="number">6</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">########### 连接三个表 ########### </span></span><br><span class="line"><span class="comment"># ArticleComment表根据自己的from_user字段连接User表,</span></span><br><span class="line"><span class="comment"># 再根据User表的icon字段连接Icon表</span></span><br><span class="line">comments = ArticleComment.objects.select_related(<span class="string">&#x27;from_user__icon&#x27;</span>).<span class="built_in">filter</span>(article=art).<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure>



<h4 id="多对多查找-防止1-N问题"><a href="#多对多查找-防止1-N问题" class="headerlink" title="多对多查找(防止1+N问题)"></a>多对多查找(防止1+N问题)</h4><blockquote>
<p>对于一张表来说,定义了foreignKey和ManyToManyField其实是一件好事,因为这样就可以使用<code>filter(外键字段__字段__操作符=&#39;XXX&#39;)</code>很轻易的获取它的值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Article定义了foreignkey(category)</span></span><br><span class="line">Life_article = Article.objects.<span class="built_in">filter</span>(category__name__exact=<span class="string">&#x27;Life&#x27;</span>).order_by(<span class="string">&#x27;-create_time&#x27;</span>)[:<span class="number">6</span>]</span><br></pre></td></tr></table></figure>

<p>不过如果是大量查找的话会造成1+N问题,</p>
<p>解决方案:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Article表根据tags字段连接Tag表</span></span><br><span class="line"><span class="comment"># 然后使用filter查找tags字段的engname</span></span><br><span class="line"></span><br><span class="line">articles = (Article.objects.prefetch_related(<span class="string">&#x27;tags&#x27;</span>).<span class="built_in">filter</span>(tags__engname__exact=<span class="string">&#x27;hyl&#x27;</span>))</span><br></pre></td></tr></table></figure>
</blockquote>
<p>单个查找所有(已知某个作者,查找该作者的全部出版书籍)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="comment"># 一本书有多个作者,一个作者有多本书</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Author</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">	name = models.CharField()</span><br><span class="line">	email = models.EmailField()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">	title = models.CharField()</span><br><span class="line">	authors = models.ManyToManyField(Author)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># 1.一本书的所有作者</span></span><br><span class="line"> b = Book.objects.get(<span class="built_in">id</span>=<span class="number">1</span>) </span><br><span class="line"> b.author.<span class="built_in">all</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.一个作者的所有书籍</span></span><br><span class="line">a = Author.objects.get(<span class="built_in">id</span>=<span class="number">1</span>)</span><br><span class="line">a.book_set.<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure>

<p><strong><code>没有的一方</code>调用<code>有的一方</code>,就要使用_set</strong><br>(没有定义ManyToMany的一方调用有ManyToMany的的一方时,需要使用_set)</p>
<h4 id="1-N问题总结"><a href="#1-N问题总结" class="headerlink" title="1+N问题总结"></a>1+N问题总结</h4><p>前面的细节部分不用看了,直接看这个</p>
<ol>
<li><p>适用范围</p>
<blockquote>
<ul>
<li>1+N问题是针对于外键的</li>
<li>1+N问题是针对<code>多条数据</code>查找的</li>
</ul>
<p>也就是说:<br>如果是单条数据的查找,可以不使用<code>select_related</code>和<code>prefetch_related</code></p>
</blockquote>
</li>
<li><p>一对多单条数据查询:</p>
<ul>
<li><p>Article和category是一对多关系. 查找category为a的文章</p>
</li>
<li><p>不使用select_related</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">articles = Article.objects.<span class="built_in">filter</span>(category__name__exact=<span class="string">&#x27;a&#x27;</span>).<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure></li>
<li><p>使用select_related</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">articles = Article.objects.select_related(<span class="string">&#x27;category&#x27;</span>).<span class="built_in">filter</span>(category__name__exact=<span class="string">&#x27;a&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>多对多单条数据查询:</p>
<ul>
<li><p>Article和tag是多对多关系 . 查找标签为a的所有文章</p>
</li>
<li><p>不使用prefetch_related</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">articles = Article.objects.<span class="built_in">filter</span>(tags__engname__exact=<span class="string">&#x27;a&#x27;</span>).<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure></li>
<li><p>使用prefetch_related</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">articles = Article.objects.prefetch_related(<span class="string">&#x27;tags&#x27;</span>).<span class="built_in">filter</span>(tags__engname__exact=<span class="string">&#x27;a&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>获取</p>
<ul>
<li><p>一对多 : 获取某个分类的所有文章:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Article.objects.<span class="built_in">filter</span>(category__name__exact=<span class="string">&#x27;a&#x27;</span>).<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure></li>
<li><p>一对多 : 获取某个文章的分类:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Article.objects.<span class="built_in">filter</span>(<span class="built_in">id</span>=<span class="number">1</span>).category</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">Category.objects.article_set.first()</span><br></pre></td></tr></table></figure></li>
<li><p>多对多 : 获取某个文章的所有标签:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Article.objects.<span class="built_in">filter</span>(<span class="built_in">id</span>=<span class="number">1</span>).tags.<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure></li>
<li><p>多对多 : 获取某个标签的所有文章:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Article.objects.<span class="built_in">filter</span>(tags__name__exact=<span class="string">&#x27;a&#x27;</span>).<span class="built_in">all</span>()</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">Tag.objects.get(<span class="built_in">id</span>=<span class="number">1</span>).article_set.<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<h4 id="聚合函数"><a href="#聚合函数" class="headerlink" title="聚合函数"></a>聚合函数</h4><p>使用aggregate()函数返回聚合函数的值<br>Avg,Count,Max,Min,Sum</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Max</span><br><span class="line">maxAge = Students.objects.aggregate(Max(<span class="string">&#x27;sage&#x27;</span>))</span><br></pre></td></tr></table></figure>



<h4 id="groupby要使用annotate"><a href="#groupby要使用annotate" class="headerlink" title="groupby要使用annotate"></a>groupby要使用annotate</h4><p>annotate用于添加一列:</p>
<ul>
<li>先<code>Article.objects.values(&quot;category&quot;)</code>查取category列</li>
<li>使用<code>Count(&quot;category&quot;)</code>计算数量</li>
<li>然后添加Count列</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">articles_num = Article.objects.values(<span class="string">&quot;category&quot;</span>).annotate(Count=Count(<span class="string">&quot;category&quot;</span>))</span><br></pre></td></tr></table></figure>

<p>示例 : </p>
<p>Count 接受的参数为需要计数的<strong>模型的名称</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Count 接受的参数为需要计数的模型的名称</span></span><br><span class="line">Category.objects.annotate(num_posts=Count(<span class="string">&#x27;post&#x27;</span>))</span><br></pre></td></tr></table></figure>

<ul>
<li><p>统计返回的 Category 记录的集合中每条记录下的文章数</p>
</li>
<li><p>代码中的 <code>Count</code> 方法为我们做了这个事，它接收一个和 Categoty 相关联的模型参数名（这里是 <code>Post</code>，通过 ForeignKey 关联的），然后它便会统计 Category 记录的集合中每条记录下的与之关联的 Post 记录的行数，也就是文章数，最后把这个值保存到 <code>num_posts</code> 属性中。</p>
</li>
<li><p>现在在 Category 列表中每一项都新增了一个 <code>num_posts</code> 属性记录该 Category 下的文章数量，我们就可以在模板中引用这个属性来显示分类下的文章数量了。</p>
</li>
</ul>
<blockquote>
<p>==只要是两个 model 类通过 ForeignKey 或者 ManyToMany 关联起来，那么就可以使用 annotate 方法来统计数量。==</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">70</span>)</span><br><span class="line">    body = models.TextField()</span><br><span class="line">    Tags = models.ManyToManyField(<span class="string">&#x27;Tag&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.title</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tag</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<p>统计标签下的文章数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models.aggregates <span class="keyword">import</span> Count</span><br><span class="line"><span class="keyword">from</span> blog.models <span class="keyword">import</span> Tag</span><br><span class="line"></span><br><span class="line"><span class="comment"># Count 计算分类下的文章数，其接受的参数为需要计数的模型的名称</span></span><br><span class="line">tag_list = Tag.objects.annotate(num_posts=Count(<span class="string">&#x27;post&#x27;</span>))</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="自定义模型管理器"><a href="#自定义模型管理器" class="headerlink" title="自定义模型管理器"></a>自定义模型管理器</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IsDeleteManager</span>(<span class="params">models.Manager</span>):</span></span><br><span class="line">    <span class="string">&#x27;去除删除Manager&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().get_queryset().<span class="built_in">filter</span>(isDelete=<span class="literal">False</span>)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">&#x27;文章&#x27;</span></span><br><span class="line">    objects = IsDeleteManager()</span><br></pre></td></tr></table></figure>



<h4 id="自定义标签和过滤器"><a href="#自定义标签和过滤器" class="headerlink" title="自定义标签和过滤器"></a>自定义标签和过滤器</h4><ol>
<li>在app中创建templatetags模块(模块名只能是templatetags)</li>
<li>在templatetags里面创建任意 .py 文件</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> template</span><br><span class="line"><span class="keyword">from</span> django.utils.safestring <span class="keyword">import</span> mark_safe</span><br><span class="line"> </span><br><span class="line">register = template.Library()   <span class="comment">#register的名字是固定的,不可改变</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 过滤器</span></span><br><span class="line"><span class="meta">@register.filter</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">multi</span>(<span class="params">x,y</span>):</span></span><br><span class="line">    <span class="keyword">return</span> x*y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 标签</span></span><br><span class="line"><span class="meta">@register.simple_tag  </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">multitag</span>(<span class="params">x,y,z</span>):</span></span><br><span class="line">    <span class="keyword">return</span> x*y*z</span><br><span class="line"></span><br><span class="line"><span class="comment"># 标签</span></span><br><span class="line"><span class="meta">@register.simple_tag  </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_input</span>(<span class="params"><span class="built_in">id</span>,arg</span>):</span></span><br><span class="line">　　 result = <span class="string">&quot;&lt;input type=&#x27;text&#x27; id=&#x27;%s&#x27; class=&#x27;%s&#x27; /&gt;&quot;</span> %(<span class="built_in">id</span>,arg,)</span><br><span class="line">　　 <span class="keyword">return</span> mark_safe(result)</span><br></pre></td></tr></table></figure>

<p>在使用自定义simple_tag和filter的html文件中导入之前创建的 my_tags.py</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">load</span></span> my_tags %&#125;</span><span class="xml">　</span></span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;# 过滤器 #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123; var|filter_name:参数 &#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="comment">&#123;# 标签 #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">simple_tag</span> 参数1 参数2 ... %&#125;</span></span><br></pre></td></tr></table></figure>



<h5 id="定义标签示例"><a href="#定义标签示例" class="headerlink" title="定义标签示例"></a>定义标签示例</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># get_data.py</span></span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> template</span><br><span class="line"></span><br><span class="line">register = template.Library()</span><br><span class="line"></span><br><span class="line"><span class="meta">@register.simple_tag</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data_age</span>():</span></span><br><span class="line">    age = <span class="number">10</span></span><br><span class="line">    <span class="keyword">return</span> age</span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="comment">&lt;!--导入自定义模板标签--&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">load</span></span> get_data %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="comment">&lt;!--将函数获取的值取名--&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">get_data_age</span> <span class="keyword">as</span> age %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>我的第一个HTML页面<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!--使用--&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>我的年纪</span><span class="template-variable">&#123;&#123; age &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p><code>&#123;% get_data_age as age %&#125;</code> : 给函数获取的值取名</p>
<h5 id="定义过滤器示例"><a href="#定义过滤器示例" class="headerlink" title="定义过滤器示例"></a>定义过滤器示例</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># get_data.py</span></span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> template</span><br><span class="line"></span><br><span class="line">register = template.Library()</span><br><span class="line"></span><br><span class="line"><span class="meta">@register.filter(<span class="params">name=<span class="string">&#x27;truncate_filter&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">truncate_chars</span>(<span class="params">value</span>):</span></span><br><span class="line">    <span class="keyword">if</span> value.__len__() &gt; <span class="number">5</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;%s......&#x27;</span>% value[<span class="number">0</span>:<span class="number">5</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> value</span><br></pre></td></tr></table></figure>

<p>如果没有使用name参数，django默认会将函数名作为name参数的值，所以下面的代码和上面的代码作用相同。</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="comment">&lt;!--导入自定义模板标签--&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">load</span></span> get_data %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>我的第一个HTML页面<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!--使用--&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>我的年纪</span><span class="template-variable">&#123;&#123; &quot;123456789&quot;|truncate_chars &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br></pre></td></tr></table></figure>



<p>如果tempaltetags无法调用,很有可能是load放错位置:</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">extends</span></span> &#x27;base.html&#x27; %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">load</span></span> staticfiles %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> title %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">工具 | 凉薄</span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> title %&#125;</span><span class="xml"> </span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> content %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="comment">&#123;# 注意要放在content里面 #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">load</span></span> saveposts %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">install_posts_from_net</span> <span class="keyword">as</span> msg %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> content %&#125;</span></span><br></pre></td></tr></table></figure>





<h4 id="session"><a href="#session" class="headerlink" title="session"></a>session</h4><p>设置session过期时间</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showmain</span>(<span class="params">request</span>):</span></span><br><span class="line">    username = reqeust.POST.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">    <span class="comment"># 设置10秒寿命</span></span><br><span class="line">    request.sessionn.set_expiry(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>

<p>清除session</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 退出登录的视图</span></span><br><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> logout</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quit</span>(<span class="params">request</span>):</span></span><br><span class="line">	logout(request)</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>



<h4 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h4><p>在模板中使用点语法</p>
<ul>
<li>字典查询</li>
<li>属性或者方法</li>
<li>数字索引</li>
</ul>
<p>模板里使用session:<br><code>&#123;&#123; request.session.username &#125;&#125;</code> : 取出session里的username</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> request.session.username %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    欢迎 <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span></span><span class="template-variable">&#123;&#123; request.session.username &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span>注销<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">else</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;user:login&#x27; %&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;user:register&#x27; %&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span>注册<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span></span><br></pre></td></tr></table></figure>

<p>del request.session[key]:删除指定的key</p>
<h4 id="静态文件"><a href="#静态文件" class="headerlink" title="静态文件"></a>静态文件</h4><p>导入静态文件:</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">load</span></span> staticfiles %&#125;</span></span><br></pre></td></tr></table></figure>



<h4 id="按月归档"><a href="#按月归档" class="headerlink" title="按月归档"></a>按月归档</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Post.objects.dates(<span class="string">&#x27;created_time&#x27;</span>, <span class="string">&#x27;month&#x27;</span>, order=<span class="string">&#x27;DESC&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>这里 <code>dates</code> 方法会返回一个<strong>列表</strong>，列表中的元素为每一篇文章（Post）的创建时间，且是 Python 的 <code>date</code> 对象，精确到月份，降序排列。</li>
<li>接受的三个参数值表明了这些含义，一个是 <code>created_time</code> ，即 <code>Post</code> 的创建时间，<code>month</code> 是精度，<code>order=&#39;DESC&#39;</code> 表明降序排列（即离当前越近的时间越排在前面）。</li>
<li>例如我们写了 3 篇文章，分别发布于 2017 年 2 月 21 日、2017 年 3 月 25 日、2017 年 3 月 28 日，那么 <code>dates</code> 函数将返回 2017 年 3 月 和 2017 年 2 月这样一个时间列表，且降序排列，从而帮助我们实现按月归档的目的。</li>
</ul>
<h4 id="AbstractUser"><a href="#AbstractUser" class="headerlink" title="AbstractUser"></a>AbstractUser</h4><p>系统默认用户的继承使用:</p>
<ul>
<li>继承AbstractUser</li>
<li>修改setting.py里的AUTH_USER_MODEL = ‘user.UserProfile’</li>
<li>重新执行迁移同步.</li>
</ul>
<p><strong>只有继承了abstractuser类的用户模型才能使用logout,login和authenticate</strong>.</p>
<p>authenticate和login是一起使用的<strong>先验证后登录</strong>:</p>
<ul>
<li>先使用authenticate进行用户的数据库查询判断，如果有则返回用户对象</li>
<li>login(request,user):类似于<code>request.session</code>,但是不是使用session属性了,而是使用<code>request.user</code></li>
</ul>
<h4 id="form"><a href="#form" class="headerlink" title="form"></a>form</h4><p>Django会处理涉及表单的三个不同部分：</p>
<ul>
<li>准备并重组数据，以便下一步的渲染</li>
<li>为数据创建HTML表单</li>
<li>接收并处理客户端提交的表单及数据</li>
</ul>
<p>form.is_valid()返回false的原因一般是</p>
<ul>
<li><strong>form中的每个field默认都是required的，如果没有填，form.is_valid()就会返回false</strong>。</li>
<li>html中的form中的各个field的name一定要和对应的form类的各个field的name保持一致，这也是一个易错点。</li>
<li>慎用自定义form的互相继承,很容易造成form.is_valid()返回false</li>
</ul>
<p>使用 lform.errors 获取 forms.ValidationError</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lform = UserLoginForm(request.POST)</span><br><span class="line">content = &#123;<span class="string">&#x27;msg&#x27;</span>:lform.errors&#125;</span><br></pre></td></tr></table></figure>



<h4 id="验证码全流程"><a href="#验证码全流程" class="headerlink" title="验证码全流程"></a>验证码全流程</h4><p><img src="/images/%E9%AA%8C%E8%AF%81%E7%A0%81%E5%85%A8%E6%B5%81%E7%A8%8B.png" alt="验证码全流程"></p>
<h4 id="用户全流程"><a href="#用户全流程" class="headerlink" title="用户全流程"></a>用户全流程</h4><p><img src="/images/%E7%94%A8%E6%88%B7%E7%9B%B8%E5%85%B3%E5%85%A8%E6%B5%81%E7%A8%8B.png" alt="用户相关全流程"></p>
<h4 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.core.paginator <span class="keyword">import</span> Paginator, EmptyPage, PageNotAnInteger</span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">listing</span>(<span class="params">request</span>):</span></span><br><span class="line">    contact_list = Contacts.objects.<span class="built_in">all</span>()</span><br><span class="line">    paginator = Paginator(contact_list, <span class="number">25</span>) <span class="comment"># 每页显示 25 个联系人</span></span><br><span class="line"></span><br><span class="line">    page = request.GET.get(<span class="string">&#x27;page&#x27;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        contacts = paginator.page(page)</span><br><span class="line">    <span class="keyword">except</span> PageNotAnInteger:</span><br><span class="line">        <span class="comment"># 如果用户请求的页码号不是整数，显示第一页</span></span><br><span class="line">        contacts = paginator.page(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span> EmptyPage:</span><br><span class="line">        <span class="comment"># 如果用户请求的页码号超过了最大页码号，显示最后一页</span></span><br><span class="line">        contacts = paginator.page(paginator.num_pages)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">&#x27;list.html&#x27;</span>, &#123;<span class="string">&#x27;contacts&#x27;</span>: contacts&#125;)</span><br></pre></td></tr></table></figure>



<h4 id="ListView"><a href="#ListView" class="headerlink" title="ListView"></a>ListView</h4><ul>
<li>ListView : 用来获取<strong>某个 model</strong> 中的所有数据</li>
<li>DetailView : 从数据库获取模型的一条记录数据</li>
</ul>
<ul>
<li>ListView 主要用在获取某个 model 列表中</li>
<li>通过 template_name 属性来指定需要渲染的模板，<br>通过 context_object_name 属性来指定获取的 model 列表的名字，否则只能通过默认的 object_list 获取</li>
<li>复写 get_queryset 方法以增加获取 model 列表的其他逻辑</li>
<li>复写 get_context_data 方法来为上下文对象添加<strong>额外的变量</strong>以便在模板中访问</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    获取 Article 列表以渲染首页模板</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    article_list = Article.objects.<span class="built_in">all</span>()   <span class="comment"># 获取文章列表</span></span><br><span class="line">    category_list = Category.objects.<span class="built_in">all</span>() <span class="comment"># 获取分类列表</span></span><br><span class="line">    context = &#123; <span class="string">&#x27;article_list&#x27;</span> : article_list , <span class="string">&#x27;category_list&#x27;</span> : category_list &#125;</span><br><span class="line">    <span class="keyword">return</span> render_to_response(<span class="string">&#x27;blog/index.html&#x27;</span>,context)</span><br></pre></td></tr></table></figure>

<p>一个应用中可能会重复书写下面代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">article_list = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">context = &#123; <span class="string">&#x27;article_list&#x27;</span> : article_list &#125;</span><br><span class="line"><span class="keyword">return</span> render_to_response(<span class="string">&#x27;blog/index.html&#x27;</span>,context)</span><br></pre></td></tr></table></figure>

<p>这些逻辑抽象出来放到一个类里,于是 Django 帮我们写好了一个类，专门用于处理上面的情况，这就是 <strong>ListView</strong>，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexView</span>(<span class="params">ListView</span>):</span></span><br><span class="line">    <span class="comment"># 将 model 指定为 Post，告诉 Django 我要获取的模型是 Post。</span></span><br><span class="line">    model = Post</span><br><span class="line">    <span class="comment"># 指定需要渲染的模板</span></span><br><span class="line">    template_name = <span class="string">&quot;blog/index.html&quot;</span></span><br><span class="line">    <span class="comment"># 指定获取的模型列表数据保存的变量名。这个变量会被传递给模板。</span></span><br><span class="line">    context_object_name = <span class="string">&quot;article_list&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 复写get_queryset方法:增加获取 model 列表的其他逻辑</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        article_list = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">        <span class="comment"># 修改article的body属性</span></span><br><span class="line">        <span class="keyword">for</span> article <span class="keyword">in</span> article_list:</span><br><span class="line">            article.body = markdown2.markdown(article.body, extras=[<span class="string">&#x27;fenced-code-blocks&#x27;</span>], )</span><br><span class="line">        <span class="keyword">return</span> article_list</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 复写get_context_data方法:给 context 增加额外的变量</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_context_data</span>(<span class="params">self, **kwargs</span>):</span></span><br><span class="line">        kwargs[<span class="string">&#x27;category_list&#x27;</span>] = Category.objects.<span class="built_in">all</span>().order_by(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>(IndexView, self).get_context_data(**kwargs) </span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryView</span>(<span class="params">ListView</span>):</span></span><br><span class="line">    model = Post</span><br><span class="line">    template_name = <span class="string">&#x27;blog/index.html&#x27;</span></span><br><span class="line">    context_object_name = <span class="string">&#x27;post_list&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ListView默认的get_queryset是取得全部的数据</span></span><br><span class="line">    <span class="comment"># 覆写了get_queryset 方法进行筛选</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        cate = get_object_or_404(Category, pk=self.kwargs.get(<span class="string">&#x27;pk&#x27;</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().get_queryset().<span class="built_in">filter</span>(category=cate)</span><br></pre></td></tr></table></figure>



<p>ListView分页技术</p>
<p><strong>类视图 ListView 已经帮我们写好了上述的分页逻辑，我们只需通过指定 paginate_by 属性来开启分页功能即可</strong></p>
<p><code>ListView</code> 传递了以下和分页有关的模板变量供我们在模板中使用：</p>
<ul>
<li><code>paginator</code> ，即 <code>Paginator</code> 的实例。</li>
<li><code>page_obj</code> ，当前请求页面分页对象。</li>
<li><code>is_paginated</code>，是否已分页。只有当分页后页面超过两页时才算已分页。</li>
<li><code>object_list</code>，请求页面的对象列表，和 <code>post_list</code> 等价。所以在模板中循环文章列表时可以选 <code>post_list</code> ，也可以选 <code>object_list</code>。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> ListView</span><br><span class="line"><span class="keyword">from</span> msg_board.models <span class="keyword">import</span> Msg</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MsgList</span>(<span class="params">ListView</span>):</span></span><br><span class="line">    model = Msg<span class="comment">#数据模型</span></span><br><span class="line">    context_object_name = <span class="string">&#x27;msg_list&#x27;</span><span class="comment">#模板中变量</span></span><br><span class="line">    template_name = <span class="string">&#x27;index.html&#x27;</span><span class="comment">#模板文件</span></span><br><span class="line">    paginate_by = <span class="number">3</span> <span class="comment">#一个页面显示的条目</span></span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> msg_list %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">id</span> = <span class="string">&quot;msgs&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">th</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">th</span>&gt;</span>Content<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">th</span>&gt;</span>Author<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">th</span>&gt;</span>Ip<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">th</span>&gt;</span>Time<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">th</span>&gt;</span>Click<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;%<span class="name"><span class="name">for</span></span> msg <span class="keyword">in</span> msg_list %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><span class="template-variable">&#123;&#123;msg.title&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><span class="template-variable">&#123;&#123;msg.content&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><span class="template-variable">&#123;&#123;msg.user&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><span class="template-variable">&#123;&#123;msg.ip&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><span class="template-variable">&#123;&#123;msg.datetime&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><span class="template-variable">&#123;&#123;msg.click_count&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span>%&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> is_paginated %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;pagination&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;page-links&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">            </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> page_obj.has_previous %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/mysite?page=</span></span></span><span class="template-variable">&#123;&#123; page_obj.previous_page_number &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span>上一页<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">            </span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">            </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> page_obj.has_next %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/mysite?page=</span></span></span><span class="template-variable">&#123;&#123; page_obj.next_page_number &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span>下一页<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">            </span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;page-current&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                第</span><span class="template-variable">&#123;&#123; page_obj.number &#125;&#125;</span><span class="xml">页 ，共</span><span class="template-variable">&#123;&#123; page_obj.paginator.num_pages &#125;&#125;</span><span class="xml">页。</span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;%<span class="name"><span class="name">endif</span></span>%&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">else</span></span> %&#125;</span></span><br></pre></td></tr></table></figure>



<h4 id="DetailView"><a href="#DetailView" class="headerlink" title="DetailView"></a>DetailView</h4><ul>
<li>DetailView主要用在获取某个 model 的单个对象中</li>
<li>通过 template_name 属性来指定需要渲染的模板，通过 context_object_name 属性来指定获取的 model 对象的名字，否则只能通过默认的 object 获取</li>
<li>复写 get_object 方法以增加获取单个 model 对象的其他逻辑</li>
<li>复写 get_context_data 方法来为上下文对象添加额外的变量以便在模板中访问</li>
</ul>
<p>获取单个 mdoel 对象是很常见的，比如 Blog 里点击某篇文章后进入文章的详情页，这里获取的就是点击这篇文章。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">detail</span>(<span class="params">request,article_id</span>):</span></span><br><span class="line">    article = get_object_or_404(Article,pk=article_id)</span><br><span class="line">    context = &#123; <span class="string">&#x27;article&#x27;</span> : article &#125;</span><br><span class="line">    <span class="keyword">return</span> render_to_response(<span class="string">&#x27;blog/detail.html&#x27;</span>,context)</span><br></pre></td></tr></table></figure>

<p>会重复写:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">article = get_object_or_404(Article,pk=article_id) </span><br></pre></td></tr></table></figure>

<p>Django 通过 DetailView 来把这种逻辑抽象出来，把上面的视图函数转成类视图：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleDetailView</span>(<span class="params">DetailView</span>):</span></span><br><span class="line">    <span class="comment"># 将 model 指定为 Article，告诉 Django 我要获取的模型是 Article。</span></span><br><span class="line">    model = Article</span><br><span class="line">    <span class="comment"># 指定需要渲染的模板</span></span><br><span class="line">    template_name = <span class="string">&quot;blog/detail.html&quot;</span></span><br><span class="line">    <span class="comment"># 指定获取的模型列表数据保存的变量名。这个变量会被传递给模板。</span></span><br><span class="line">    context_object_name = <span class="string">&quot;article&quot;</span></span><br><span class="line">    <span class="comment"># pk_url_kwarg用于接收一个来自url中的主键，然后会根据这个主键进行查询</span></span><br><span class="line">    <span class="comment"># 这里的article_id就是url(r&#x27;^blog/article/(?P&lt;article_id&gt;\d+)$&#x27;)中的article_id</span></span><br><span class="line">    pk_url_kwarg = <span class="string">&#x27;article_id&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 返回该视图要显示的对象</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_object</span>(<span class="params">self, queryset=<span class="literal">None</span></span>):</span></span><br><span class="line">        obj = <span class="built_in">super</span>().get_object()</span><br><span class="line">        obj.body = markdown2.markdown(obj.body, extras=[<span class="string">&#x27;fenced-code-blocks&#x27;</span>], )</span><br><span class="line">        <span class="keyword">return</span> obj</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment"># urls.py</span></span><br><span class="line">url(<span class="string">r&#x27;^blog/article/(?P&lt;article_id&gt;\d+)$&#x27;</span>, views.ArticleDetailView.as_view(), name=<span class="string">&#x27;detail&#x27;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<ol>
<li>假设用户点击了第三篇文章，那么该 url 会被解析成：/blog/article/3，其中 3 被传递给了详情页面视图函数。</li>
<li>现在视图函数被调用，它首先根据传给它的参数获自动调用 get_object 方法取到文章的 model，然后根据 context_object_name = “article” 把 article 加入到上下文中</li>
<li>之后渲染 template_name = “blog/detail.html” 指定的模板文件，至此用户就跳转到了文章详情页</li>
</ol>
</blockquote>
<h2 id="Django-rest-framework"><a href="#Django-rest-framework" class="headerlink" title="Django rest framework"></a>Django rest framework</h2><h4 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h4><p><img src="/images/78f4e5d9-django_rest_framework%E8%AE%A4%E8%AF%81%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B.jpg" alt="django_rest_framework认证源码流程"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView,exceptions</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> exceptions</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Authtication</span>(<span class="params">BaseAuthentication</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        token = request._request.GET.get(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">        token_obj = UserToken.objects.<span class="built_in">filter</span>(token=token).first()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> token_obj:</span><br><span class="line">            <span class="keyword">raise</span> exceptions.AuthenticationFailed(<span class="string">&#x27;用户认证失败&#x27;</span>)</span><br><span class="line">        <span class="comment"># 在rest framework内部会将这两个字段赋值给request,以供后续操作使用</span></span><br><span class="line">        <span class="comment"># 这两个参数分别为request.user和request.auth</span></span><br><span class="line">        <span class="keyword">return</span> (token_obj.user,token_obj)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    authentication_classes = [Authtication,]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 先定义好返回值ret</span></span><br><span class="line">        ret = &#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">1000</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="literal">None</span>,<span class="string">&#x27;date&#x27;</span>:<span class="literal">None</span>&#125;</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 然后再对ret进行补充修改</span></span><br><span class="line">            ret[<span class="string">&#x27;date&#x27;</span>] = ORDER_DICT</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(ret)</span><br></pre></td></tr></table></figure>

<p>流程 : </p>
<ol>
<li>创建类,继承<code>BaseAithentication</code>,实现<code>authenticate()</code>方法</li>
<li>返回值:<ul>
<li>None : 不做处理,执行下一个认证</li>
<li>raise exception.AuthenticationFailed(‘用户认证失败’)</li>
<li>(元素1,元素2) : 元素1赋值给request.user , 元素2赋值给request.auth</li>
</ul>
</li>
</ol>
<h4 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h4><p><img src="/images/e8d6647a-django_rest_framework%E6%9D%83%E9%99%90%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B.jpg" alt="django_rest_framework权限源码流程"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> BasePermission</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SVIPPermission</span>(<span class="params">BasePermission</span>):</span></span><br><span class="line">    <span class="comment"># 使用messag控制拒绝访问返回的message</span></span><br><span class="line">    message = <span class="string">&#x27;必须是SVIP才能访问&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">has_permission</span>(<span class="params">self,request,view</span>):</span></span><br><span class="line">        <span class="keyword">if</span> request.user.user_type != <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderView</span>(<span class="params">APIView</span>):</span></span><br><span class="line"> <span class="comment"># 添加一个permission_classes: 控制权限的类 组成的列表</span></span><br><span class="line"> permission_classes = [SVIPPermission,]</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">     ret = &#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">1000</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="literal">None</span>,<span class="string">&#x27;date&#x27;</span>:<span class="literal">None</span>&#125;</span><br><span class="line">     <span class="keyword">try</span>:</span><br><span class="line">         ret[<span class="string">&#x27;date&#x27;</span>] = ORDER_DICT</span><br><span class="line">     <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">         <span class="keyword">pass</span></span><br><span class="line">     <span class="keyword">return</span> JsonResponse(ret)</span><br></pre></td></tr></table></figure>

<p>实现流程 :</p>
<ol>
<li>创建类,继承<code>BasePermission</code>,实现<code>has_permission()</code>方法</li>
<li>返回值:<ul>
<li>True</li>
<li>False</li>
</ul>
</li>
</ol>
<h4 id="节流"><a href="#节流" class="headerlink" title="节流"></a>节流</h4><p><img src="/images/9bcd9d78-django_rest_framework%E9%98%88%E5%80%BC%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B.jpg" alt="django_rest_framework阈值源码流程"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> rest_framework.throttling <span class="keyword">import</span> BaseThrottle</span><br><span class="line"></span><br><span class="line">VISIT_RECORD = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VisitThrottle</span>(<span class="params">BaseThrottle</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.history = <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">allow_request</span>(<span class="params">self,request,view</span>):</span></span><br><span class="line">        <span class="comment"># 获取用户IP</span></span><br><span class="line">        remote_addr = request.META.get(<span class="string">&#x27;REMOTE_ADDR&#x27;</span>)</span><br><span class="line">        ctime = time.time()</span><br><span class="line">        <span class="keyword">if</span> remote_addr <span class="keyword">not</span> <span class="keyword">in</span> VISIT_RECORD:</span><br><span class="line">            VISIT_RECORD[remote_addr] = [ctime,]</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        self.history = VISIT_RECORD.get(remote_addr)</span><br><span class="line">        <span class="keyword">while</span> self.history <span class="keyword">and</span> self.history[-<span class="number">1</span>] &lt; ctime - <span class="number">10</span>:</span><br><span class="line">            self.history.pop()</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.history) &lt; <span class="number">3</span>:</span><br><span class="line">            self.history.insert(<span class="number">0</span>,ctime)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 还需要等待多少秒后,才能访问</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">10</span> - (time.time() - self.history[-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    throttle_classes = [VisitThrottle,]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        ret = &#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">1000</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="literal">None</span>,<span class="string">&#x27;date&#x27;</span>:<span class="literal">None</span>&#125;</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            ret[<span class="string">&#x27;date&#x27;</span>] = ORDER_DICT</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(ret)</span><br></pre></td></tr></table></figure>

<p>实现流程</p>
<ol>
<li>创建类<ul>
<li>继承<code>BaseThrottle</code>,实现<code>allow_reques()</code>方法和<code>wait()</code>方法.</li>
<li>继承<code>SimpleRateThrottle</code>,实现<code>get_cache_key()</code>方法和<code>scope</code>类属性(settings.py中哦key)</li>
</ul>
</li>
<li>返回值:<ul>
<li>True</li>
<li>False</li>
</ul>
</li>
</ol>
<h4 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h4><p><img src="/images/dfd1f60b-django_rest_framework%E7%89%88%E6%9C%AC%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B.jpg" alt="django_rest_framework版本源码流程"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># urls.py</span></span><br><span class="line">url(<span class="string">r&#x27;api/(?P&lt;version&gt;[v1|v2]+)/user/$&#x27;</span>,views.UserView.as_view(),name=<span class="string">&#x27;user&#x27;</span>),</span><br><span class="line"></span><br><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.versioning <span class="keyword">import</span> BaseVersioning</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParamVersion</span>(<span class="params">BaseVersioning</span>):</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">determine_version</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">		<span class="comment"># 捕捉url中的version值</span></span><br><span class="line">		version = request.query_params.get(<span class="string">&#x27;version&#x27;</span>)</span><br><span class="line">		<span class="keyword">return</span> version</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="comment"># 注意:因为板块只要控制一个就行了,所以不是versioning_classes,也不用使用列表</span></span><br><span class="line">    versioning_class = ParamVersion</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 使用ParamVersion后,直接将version信息添加到request的version属性中</span></span><br><span class="line">        x = request.version</span><br><span class="line">        <span class="comment"># 处理版本的对象</span></span><br><span class="line">        y = request.versioning_scheme</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="built_in">str</span>(x))</span><br></pre></td></tr></table></figure>

<p>一般使用内置类,全局使用:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.versioning <span class="keyword">import</span> QueryParameterVersioning</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">APIView</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        x = request.version</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="built_in">str</span>(x))</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># settings.py</span></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_VERSIONING_CLASS&#x27;</span> : <span class="string">&#x27;rest_framework.versioning.URLPathVersioning&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;DEFAULT_VERSION&#x27;</span>  : <span class="string">&#x27;v1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ALLOWED_VERSIONS&#x27;</span> : [<span class="string">&#x27;v1&#x27;</span>,<span class="string">&#x27;v2&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;VERSION_PARAM&#x27;</span>    : <span class="string">&#x27;version&#x27;</span>,</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>实现流程:</p>
<ul>
<li><p>使用配置文件 :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line"> <span class="string">&#x27;DEFAULT_VERSIONING_CLASS&#x27;</span> : <span class="string">&#x27;rest_framework.versioning.URLPathVersioning&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;DEFAULT_VERSION&#x27;</span>  : <span class="string">&#x27;v1&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;ALLOWED_VERSIONS&#x27;</span> : [<span class="string">&#x27;v1&#x27;</span>,<span class="string">&#x27;v2&#x27;</span>],</span><br><span class="line"> <span class="string">&#x27;VERSION_PARAM&#x27;</span>    : <span class="string">&#x27;version&#x27;</span>,</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure></li>
<li><p>urls.py :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r&#x27;api/(?P&lt;version&gt;[v1|v2]+)/user/$&#x27;</span>,views.UserView.as_view(),name=<span class="string">&#x27;user&#x27;</span>),</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="解析器"><a href="#解析器" class="headerlink" title="解析器"></a>解析器</h4><ul>
<li><p>本质: 根据请求头中的<code>Content_Type</code>去找到合适的解析器类</p>
</li>
<li><p>对于request.body有值而request.POST取不到值的情况,我们可以使用rest_framework的解析器了</p>
</li>
<li><p><code>解析器</code>的源码流程和<code>权限</code>类似</p>
</li>
</ul>
<p><img src="/images/2c81978e-django_rest_framework%E8%A7%A3%E6%9E%90%E5%99%A8%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B.jpg" alt="django_rest_framework解析器源码流程"></p>
<p>简单来说就是</p>
<ol>
<li>在dispatch将各种解析器封装到request中</li>
<li>当我们想要使用数据的时候<code>request.data</code>触发<code>self._load_data_and_files()</code>,</li>
<li>然后使用<code>反射</code>找到合适的解析器类,</li>
<li>最后触发解析器类的parse()方法去解析数据</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># urls.py</span></span><br><span class="line">url(<span class="string">r&#x27;^api/(?P&lt;version&gt;[v1|v2]+)/user/$&#x27;</span>,views.UserView.as_view(),name=<span class="string">&#x27;user&#x27;</span>),</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.parsers <span class="keyword">import</span> JSONParser,FormParser</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="comment"># 只能解析请求头为 application/json和application/x-www-form-urlencoded的数据</span></span><br><span class="line">    parser_classes = [JSONParser,FormParser,]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 获取解析后的结果</span></span><br><span class="line">        <span class="built_in">print</span>(request.data)</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;hyl&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>一般使用内置类,全局使用:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_PARSER_CLASS&#x27;</span> : [<span class="string">&#x27;rest_framework.parsers.JSONParser&#x27;</span>,<span class="string">&#x27;rest_framework.parsers.FormParser&#x27;</span>]</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>



<h4 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h4><p><img src="/images/3325f6ce-django_rest_framework%E5%BA%8F%E5%88%97%E5%8C%96%E5%85%B6%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B.jpg" alt="django_rest_framework序列化其源码流程"></p>
<h5 id="对请求数据进行校验"><a href="#对请求数据进行校验" class="headerlink" title="对请求数据进行校验"></a>对请求数据进行校验</h5><p>使用方法和django form一模一样</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfoSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">	name = serializers.CharField(error_messages=&#123;<span class="string">&#x27;required&#x27;</span>:<span class="string">&#x27;标题不能为空&#x27;</span>&#125;)</span><br><span class="line">	age = serializers.IntegerField()</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 验证name的钩子函数</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">validate_name</span>(<span class="params">self,value</span>):</span> <span class="comment"># 验证的字段值</span></span><br><span class="line">		<span class="keyword">if</span> value.startswith(<span class="string">&quot;w&quot;</span>):</span><br><span class="line">			<span class="keyword">raise</span> serializers.ValidationError(<span class="string">&#x27;name字段不能以w开头&#x27;</span>)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			<span class="keyword">return</span> value <span class="comment">#注意通过验证，必须返回其值</span></span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        ser = UserInfoSerializer(data=request.data)</span><br><span class="line">        <span class="keyword">if</span> ser.is_valid():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;------------&#x27;</span>,ser.validated_data)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;------------&#x27;</span>,ser.errors)</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;******&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="对QuerySet进行序列化"><a href="#对QuerySet进行序列化" class="headerlink" title="对QuerySet进行序列化"></a>对QuerySet进行序列化</h5><p>使用方法很像<strong>Scrapy中的Item</strong>: </p>
<p>先定义字段,然后在实例化的时候传入数据就可以了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RolesSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">	<span class="built_in">id</span> = serializers.IntegerField()</span><br><span class="line">	title = serializers.CharField()</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RoleView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        roles = Role.objects.<span class="built_in">all</span>().values(<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;title&#x27;</span>)</span><br><span class="line">        <span class="comment"># 有多条数据,所以使用many=True</span></span><br><span class="line">        ser = RolesSerializer(instance=roles,many=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># 使用ser.data获取序列化后的值</span></span><br><span class="line">        res = json.dumps(ser.data,ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(res)</span><br><span class="line"><span class="comment"># # [&#123;&quot;id&quot;: 1, &quot;title&quot;: &quot;医生&quot;&#125;, &#123;&quot;id&quot;: 2, &quot;title&quot;: &quot;护士&quot;&#125;, &#123;&quot;id&quot;: 3, &quot;title&quot;: &quot;老师&quot;&#125;]</span></span><br></pre></td></tr></table></figure>



<p>source参数</p>
<ol>
<li>对于<code>field1 = serializers.IntegerField(source=&#39;id&#39;)</code>,其实是扫描每一行row,然后执行<code>row.source</code>(这里就是row.id)</li>
<li><strong>如果<code>row.source</code>是一个可执行对象,那么就会执行该对象</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfoSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    <span class="comment"># 使用get_XXX_display获取展示名</span></span><br><span class="line">    filed2 = serializers.CharField(source=<span class="string">&#x27;get_user_type_display&#x27;</span>)</span><br><span class="line">    <span class="comment"># 使用点号索引获取外键</span></span><br><span class="line">    group_title = serializers.CharField(source=<span class="string">&#x27;group.title&#x27;</span>)</span><br><span class="line">    <span class="comment"># 使用点号获取ManyToMany</span></span><br><span class="line">    roles = serializers.CharField(source=<span class="string">&#x27;roles.all&#x27;</span>)</span><br><span class="line">    <span class="comment"># 使用SerializerMethodField自定义返回</span></span><br><span class="line">    roles2 = serializers.SerializerMethodField()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 这里返回什么,roles就是什么</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_roles</span>(<span class="params">self,row</span>):</span></span><br><span class="line">        role_obj_list = row.roles.<span class="built_in">all</span>()</span><br><span class="line">        ret = [&#123;<span class="string">&#x27;id&#x27;</span>:item.<span class="built_in">id</span>,<span class="string">&#x27;title&#x27;</span>:item.title&#125; <span class="keyword">for</span> item <span class="keyword">in</span> role_obj_list]</span><br><span class="line">        <span class="keyword">return</span> ret</span><br></pre></td></tr></table></figure>



<p>ModelSerializer</p>
<p><code>ModelSerializer</code>和<code>Serializer</code>的关系,类似于<code>form</code>和<code>ModelForm</code>的关系:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># utils.serialize.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfoSerialier</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    field1 = serializers.CharField(source=<span class="string">&#x27;get_user_type_display&#x27;</span>)</span><br><span class="line">    rls = serializers.SerializerMethodField()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = UserInfo</span><br><span class="line">        <span class="comment"># model = &#x27;__all__&#x27;</span></span><br><span class="line">        fields = [<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;username&#x27;</span>,<span class="string">&#x27;field1&#x27;</span>,<span class="string">&#x27;rls&#x27;</span>,<span class="string">&#x27;group&#x27;</span>]</span><br><span class="line">        <span class="comment"># 获取的深度(默认为0)</span></span><br><span class="line">        depth = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 这里返回什么,roles就是什么</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_roles</span>(<span class="params">self,row</span>):</span></span><br><span class="line">        role_obj_list = row.roles.<span class="built_in">all</span>()</span><br><span class="line">        ret = [&#123;<span class="string">&#x27;id&#x27;</span>:item.<span class="built_in">id</span>,<span class="string">&#x27;title&#x27;</span>:item.title&#125; <span class="keyword">for</span> item <span class="keyword">in</span> role_obj_list]</span><br><span class="line">        <span class="keyword">return</span> ret</span><br></pre></td></tr></table></figure>

<blockquote>
<p>depth参数 :</p>
<p>当你获取的字段是外键获取<code>多对多</code>键的时候,depth就是获取外键或多对多键的数据.</p>
</blockquote>
<h4 id="分页-1"><a href="#分页-1" class="headerlink" title="分页"></a>分页</h4><ol>
<li>看第n页，每页显示n条数据，</li>
<li>在某个位置，向后查看n条数据；</li>
<li>加密分页，只能看上一页和下一页</li>
</ol>
<h5 id="看第n页，每页显示n条数据，"><a href="#看第n页，每页显示n条数据，" class="headerlink" title="看第n页，每页显示n条数据，"></a>看第n页，每页显示n条数据，</h5><p>如果我们想要自定义分页,只需继承<code>PageNumberPagination</code>即可:</p>
<ul>
<li>page_size : 每页的数据数量(默认)</li>
<li>page_size_query_param : 制定每页的数量(局部)</li>
<li>max_page_size : 每页最多的数据数量</li>
<li>page_query_param : url中表示页数的参数(默认是<code>page</code>)</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> PageNumberPagination</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPageNumberPagination</span>(<span class="params">PageNumberPagination</span>):</span></span><br><span class="line">    page_size = <span class="number">2</span></span><br><span class="line">    page_size_query_param = <span class="string">&#x27;size&#x27;</span></span><br><span class="line">    max_page_size = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">    page_query_param = <span class="string">&#x27;page&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 获取数据</span></span><br><span class="line">        users = UserInfo.objects.<span class="built_in">all</span>()</span><br><span class="line">        <span class="comment"># 创建分页对象</span></span><br><span class="line">        pg = MyPageNumberPagination()</span><br><span class="line">        <span class="comment"># 在数据库中获取分页的数据</span></span><br><span class="line">        pager = pg.paginate_queryset(queryset=users,request=request,view=self)</span><br><span class="line">        <span class="comment"># 对数据进行序列化</span></span><br><span class="line">        ser = UserInfoSerializer(instance=pager,many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br></pre></td></tr></table></figure>

<p>接下来就可以使用<code>page</code>和<code>size</code>控制数据了</p>
<h5 id="在某个位置，向后查看n条数据"><a href="#在某个位置，向后查看n条数据" class="headerlink" title="在某个位置，向后查看n条数据"></a>在某个位置，向后查看n条数据</h5><p>使用<code>LimitoffsetPagination</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> LimitOffsetPagination</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPageNumberPagination2</span>(<span class="params">LimitOffsetPagination</span>):</span></span><br><span class="line">	default_limit = <span class="number">2</span></span><br><span class="line">	limit_query_param = <span class="string">&#x27;limit&#x27;</span></span><br><span class="line">	offset_query_param = <span class="string">&#x27;offset&#x27;</span></span><br><span class="line"></span><br><span class="line">	max_limit = <span class="number">5</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 获取所有数据</span></span><br><span class="line">        users = UserInfo.objects.<span class="built_in">all</span>()</span><br><span class="line">        <span class="comment"># 创建分页对象</span></span><br><span class="line">        pg = MyPageNumberPagination2()</span><br><span class="line">        <span class="comment"># 在数据库中获取分页的数据 </span></span><br><span class="line">        pager = pg.paginate_queryset(queryset=users,request=request,view=self)</span><br><span class="line">        <span class="comment"># 对数据进行序列化</span></span><br><span class="line">        ser = UserInfoSerializer(instance=pager,many=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br></pre></td></tr></table></figure>

<p>接下来就可以使用<code>limit</code>和<code>offset</code>控制数据了</p>
<h5 id="加密分页，只能看上一页和下一页"><a href="#加密分页，只能看上一页和下一页" class="headerlink" title="加密分页，只能看上一页和下一页"></a>加密分页，只能看上一页和下一页</h5><p>使用<code>cursorPagination</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> cursorPagination</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPageNumberPagination3</span>(<span class="params">CursorPagination</span>):</span></span><br><span class="line">	cursor_query_param = <span class="string">&#x27;cursor&#x27;</span></span><br><span class="line">	page_size = <span class="number">2</span></span><br><span class="line">	<span class="comment"># 这个分页器是需要排序的,所以要提供排序的键</span></span><br><span class="line">	ordering = <span class="string">&#x27;id&#x27;</span></span><br><span class="line">	page_size_query_param = <span class="literal">None</span></span><br><span class="line">	max_page_size = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">APIView</span>):</span></span><br><span class="line"> <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">     <span class="comment"># 获取所有数据</span></span><br><span class="line">     users = UserInfo.objects.<span class="built_in">all</span>()</span><br><span class="line">     <span class="comment"># 创建分页对象</span></span><br><span class="line">     pg = MyPageNumberPagination3()</span><br><span class="line">     <span class="comment"># 在数据库中获取分页的数据 </span></span><br><span class="line">     pager = pg.paginate_queryset(queryset=users,request=request,view=self)</span><br><span class="line">     <span class="comment"># 对数据进行序列化</span></span><br><span class="line">     ser = UserInfoSerializer(instance=pager,many=<span class="literal">True</span>)</span><br><span class="line">     <span class="comment"># 返回get_paginated_response</span></span><br><span class="line">     <span class="keyword">return</span> pg.get_paginated_response(ser.data)</span><br></pre></td></tr></table></figure>



<h4 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h4><p><img src="/images/dca042f2-%E8%A7%86%E5%9B%BE%E7%B1%BB%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB-1565665206934.jpg" alt="视图类继承关系-1565665206934"></p>
<h5 id="GenericAPIView"><a href="#GenericAPIView" class="headerlink" title="GenericAPIView"></a>GenericAPIView</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Views.py</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> GenericAPIView</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">GenericAPIView</span>):</span></span><br><span class="line">    queryset = UserInfo.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = UserInfoSerializer</span><br><span class="line">    pagination_class = PageNumberPagination</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 获取所有数据</span></span><br><span class="line">        users = self.get_queryset()</span><br><span class="line">        <span class="comment"># 在数据库中获取分页的数据 </span></span><br><span class="line">        pager = self.paginate_queryset(users)</span><br><span class="line">        <span class="comment"># 对数据进行序列化</span></span><br><span class="line">        ser = self.get_serializer(instance=pager,many=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># 返回Response</span></span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br></pre></td></tr></table></figure>

<p>只是将定义变量提前了而已</p>
<h5 id="GenericViewSet"><a href="#GenericViewSet" class="headerlink" title="GenericViewSet"></a>GenericViewSet</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># urls.py</span></span><br><span class="line">url(<span class="string">r&#x27;^api/(?P&lt;version&gt;[v1|v2]+)/users/$&#x27;</span>,views.UserView.as_view(&#123;<span class="string">&#x27;get&#x27;</span>:<span class="string">&#x27;list&#x27;</span>,<span class="string">&#x27;post&#x27;</span>:<span class="string">&#x27;xxx&#x27;</span>&#125;),name=<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.viewsets <span class="keyword">import</span> GenericViewSet</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">GenericViewSet</span>):</span></span><br><span class="line">    serializer_class = UserInfoSerializer</span><br><span class="line">    queryset = UserInfo.objects.<span class="built_in">all</span>()</span><br><span class="line">    pagination_class = PageNumberPagination</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">list</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 获取所有数据</span></span><br><span class="line">        users = self.get_queryset()</span><br><span class="line">        <span class="comment"># 在数据库中获取分页的数据 </span></span><br><span class="line">        pager = self.paginate_queryset(users)</span><br><span class="line">        <span class="comment"># 对数据进行序列化</span></span><br><span class="line">        ser = self.get_serializer(instance=pager,many=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># 返回get_paginated_response</span></span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">xxx</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> Response(<span class="string">&#x27;post&#x27;</span>) </span><br></pre></td></tr></table></figure>

<p>GenericViewSet的唯一功能 :<code>as_view(&#123;&#39;get&#39;:&#39;list&#39;,&#39;post&#39;:&#39;xxx&#39;&#125;)</code></p>
<p>将get请求映射到list方法,让list方法处理.让post请求交给xxx方法处理</p>
<h5 id="ModelViewSet"><a href="#ModelViewSet" class="headerlink" title="ModelViewSet"></a>ModelViewSet</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># urls.py</span></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r&#x27;^api/(?P&lt;version&gt;[v1|v2]+)/users/$&#x27;</span>,views.UserView.as_view(&#123;<span class="string">&#x27;get&#x27;</span>:<span class="string">&#x27;list&#x27;</span>,<span class="string">&#x27;post&#x27;</span>:<span class="string">&#x27;create&#x27;</span>&#125;),name=<span class="string">&#x27;users&#x27;</span>),</span><br><span class="line">    </span><br><span class="line">    url(<span class="string">r&#x27;^api/(?P&lt;version&gt;[v1|v2]+)/users/(?P&lt;pk&gt;\d+)/$&#x27;</span>,views.UserView.as_view(&#123;<span class="string">&#x27;get&#x27;</span>:<span class="string">&#x27;retrieve&#x27;</span>,<span class="string">&#x27;delete&#x27;</span>:<span class="string">&#x27;destory&#x27;</span>,<span class="string">&#x27;put&#x27;</span>:<span class="string">&#x27;update&#x27;</span>,<span class="string">&#x27;patch&#x27;</span>:<span class="string">&#x27;partical_update&#x27;</span>&#125;),name=<span class="string">&#x27;users&#x27;</span>),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Views.py</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.viewsets <span class="keyword">import</span> ModelViewSet</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">ModelViewSet</span>):</span></span><br><span class="line">    serializer_class = UserInfoSerializer</span><br><span class="line">    queryset = UserInfo.objects.<span class="built_in">all</span>()</span><br><span class="line">    pagination_class = PageNumberPagination</span><br></pre></td></tr></table></figure>

<ul>
<li>get : list(获取全部数据)</li>
<li>get : retrieve (获取单条数据)</li>
<li>post : create</li>
<li>delete : destory</li>
<li>put : update (更新单条数据)</li>
<li>patch : partical_update (更新全部数据)</li>
</ul>
<h4 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> routers</span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url,include</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">router = routers.DefaultRouter()</span><br><span class="line"><span class="comment"># 第一个参数是前缀,第二个参数是调用的视图</span></span><br><span class="line"><span class="comment"># 这样就可以匹配api/(?P&lt;version&gt;[v1|v2]+)/users/...</span></span><br><span class="line">router.register(<span class="string">r&#x27;users&#x27;</span>,views.UserView)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># 一个代替4个</span></span><br><span class="line">    url(<span class="string">r&#x27;api/(?P&lt;version&gt;[v1|v2]+)/&#x27;</span>,include(router.urls))</span><br><span class="line">]</span><br></pre></td></tr></table></figure>



<h4 id="渲染器"><a href="#渲染器" class="headerlink" title="渲染器"></a>渲染器</h4><ul>
<li>渲染器定义了框架按照content_type来返回不同的响应。</li>
<li>解析器的classes一样,<code>renderer_classes</code>有什么,这个视图就支持怎么样的渲染</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># urls.py</span></span><br><span class="line">url(<span class="string">r&#x27;^api/(?P&lt;version&gt;[v1|v2]+)/role/$&#x27;</span>,views.RoleView.as_view(),name=<span class="string">&#x27;role&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.renderers <span class="keyword">import</span> JSONRenderer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RoleView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    renderer_classes = [JSONRenderer,]</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        roles = Role.objects.<span class="built_in">all</span>().values(<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;title&#x27;</span>)</span><br><span class="line">        ser = RolesSerializer(instance=roles,many=<span class="literal">True</span>)</span><br><span class="line">        res = json.dumps(ser.data,ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(res)</span><br></pre></td></tr></table></figure>



</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>