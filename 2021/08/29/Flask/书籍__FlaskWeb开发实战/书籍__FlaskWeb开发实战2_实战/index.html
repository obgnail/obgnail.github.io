<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;第七章-留言板&quot;&gt;&lt;a href=&quot;#第七章-留言板&quot; class=&quot;headerlink&quot; title=&quot;第七章 留言板&quot;&gt;&lt;/a&gt;第七章 留言板&lt;/h2&gt;&lt;h3 id=&quot;使用click创建虚拟数据&quot;&gt;&lt;a href=&quot;#使用click创建虚拟数据&quot; class=&quot;headerlink&quot; title=&quot;使用click创建虚拟数据&quot;&gt;&lt;/a&gt;使用click创建虚拟数据&lt;/h3&gt;&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@app.cli.command()&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@click.option(&lt;span class=&quot;params&quot;&gt;&lt;span class=&quot;string&quot;&gt;&amp;#x27;--count&amp;#x27;&lt;/span&gt;, default=&lt;span class=&quot;number&quot;&gt;20&lt;/span&gt;, &lt;span class=&quot;built_in&quot;&gt;help&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&amp;#x27;Quantity of messages, default is 20.&amp;#x27;&lt;/span&gt;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;forge&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;count&lt;/span&gt;):&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&amp;quot;&amp;quot;&amp;quot;Generate fake messages.&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; faker &lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; Faker&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    db.drop_all()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    db.create_all()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    fake = Faker()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    click.echo(&lt;span class=&quot;string&quot;&gt;&amp;#x27;Working...&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;range&lt;/span&gt;(count):&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        message = Message(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            name=fake.name(),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            body=fake.sentence(),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            timestamp=fake.date_time_this_year()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        )&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        db.session.add(message)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    db.session.commit()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    click.echo(&lt;span class=&quot;string&quot;&gt;&amp;#x27;Created %d fake messages.&amp;#x27;&lt;/span&gt; % count)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;



&lt;h3 id=&quot;Bootstrap-Flask-插件&quot;&gt;&lt;a href=&quot;#Bootstrap-Flask-插件&quot; class=&quot;headerlink&quot; title=&quot;Bootstrap-Flask 插件&quot;&gt;&lt;/a&gt;Bootstrap-Flask 插件&lt;/h3&gt;&lt;p&gt;注意 , 不是flask-Boostrap."><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>FlaskWeb开发实战2_实战 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-none-link" href="/tags/Flask/" rel="tag">Flask</a></div><div class="post-time">2021-08-29</div></div></div><div class="container post-header"><h1>FlaskWeb开发实战2_实战</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%83%E7%AB%A0-%E7%95%99%E8%A8%80%E6%9D%BF"><span class="toc-number">1.</span> <span class="toc-text">第七章 留言板</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8click%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%95%B0%E6%8D%AE"><span class="toc-number">1.1.</span> <span class="toc-text">使用click创建虚拟数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bootstrap-Flask-%E6%8F%92%E4%BB%B6"><span class="toc-number">1.2.</span> <span class="toc-text">Bootstrap-Flask 插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flask-Moment-%E6%9C%AC%E5%9C%B0%E5%8C%96%E6%97%A5%E6%9C%9F%E5%92%8C%E6%97%B6%E9%97%B4"><span class="toc-number">1.3.</span> <span class="toc-text">Flask-Moment 本地化日期和时间</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%85%AB%E7%AB%A0-%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2"><span class="toc-number">2.</span> <span class="toc-text">第八章 个人博客</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8Endpoint"><span class="toc-number">2.1.</span> <span class="toc-text">为什么使用Endpoint?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%82%BB%E6%8E%A5%E5%88%97%E8%A1%A8%E5%85%B3%E7%B3%BB"><span class="toc-number">2.2.</span> <span class="toc-text">邻接列表关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B8%B2%E6%9F%93%E5%AF%BC%E8%88%AA%E9%93%BE%E6%8E%A5"><span class="toc-number">2.3.</span> <span class="toc-text">渲染导航链接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%87%E6%8D%A2%E5%8D%9A%E5%AE%A2%E4%B8%BB%E9%A2%98-%E5%88%87%E6%8D%A2CSS"><span class="toc-number">2.4.</span> <span class="toc-text">切换博客主题(切换CSS)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flask-Login"><span class="toc-number">2.5.</span> <span class="toc-text">Flask-Login</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#login-user%E7%9A%84%E8%83%8C%E5%90%8E%E9%80%BB%E8%BE%91"><span class="toc-number">2.5.1.</span> <span class="toc-text">login_user的背后逻辑</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#currenr-user"><span class="toc-number">2.5.2.</span> <span class="toc-text">currenr_user</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%B8%80%E6%95%B4%E4%B8%AA%E8%93%9D%E5%9B%BE%E6%B7%BB%E5%8A%A0login-required"><span class="toc-number">2.5.3.</span> <span class="toc-text">为一整个蓝图添加login_required</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8CSRFProtect%E6%8B%93%E5%B1%95%E6%89%8B%E5%8A%A8%E5%AE%9E%E7%8E%B0CSRF%E9%98%B2%E5%BE%A1"><span class="toc-number">2.6.</span> <span class="toc-text">使用CSRFProtect拓展手动实现CSRF防御</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%96%E6%B6%88%E5%AF%B9%E6%9F%90%E4%B8%AA%E8%93%9D%E5%9B%BE%E7%9A%84CSRF%E9%98%B2%E5%BE%A1"><span class="toc-number">2.6.1.</span> <span class="toc-text">取消对某个蓝图的CSRF防御</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E5%9B%BE%E7%89%87%E7%A4%BE%E4%BA%A4%E7%BD%91%E7%AB%99"><span class="toc-number">3.</span> <span class="toc-text">第九章 图片社交网站</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%84%E7%BB%87%E6%9E%B6%E6%9E%84"><span class="toc-number">3.1.</span> <span class="toc-text">项目组织架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E7%BA%BF%E7%9A%84%E5%8D%A0%E4%BD%8D%E5%9B%BE%E7%89%87%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.2.</span> <span class="toc-text">在线的占位图片服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WTForm%E7%9A%84EqualTo%E5%92%8CRegexp%E6%A0%A1%E9%AA%8C%E5%99%A8"><span class="toc-number">3.3.</span> <span class="toc-text">WTForm的EqualTo和Regexp校验器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90JWS%EF%BC%88json-Web-Signature%EF%BC%89"><span class="toc-number">3.4.</span> <span class="toc-text">生成JWS（json Web Signature）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flask%E7%9A%84%E8%A3%85%E9%A5%B0%E5%99%A8%E5%BF%85%E9%A1%BB%E4%BD%BF%E7%94%A8wraps%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="toc-number">3.5.</span> <span class="toc-text">flask的装饰器必须使用wraps装饰器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flash%E5%87%BD%E6%95%B0%E4%B8%AD%E8%BF%94%E5%9B%9E%E5%8D%B1%E9%99%A9%E6%96%87%E6%9C%AC%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="toc-number">3.6.</span> <span class="toc-text">flash函数中返回危险文本的操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E7%94%A8%E6%88%B7%E8%A7%92%E8%89%B2%E7%9A%84%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86-RBAC-Role-Based-Access-Control"><span class="toc-number">3.7.</span> <span class="toc-text">基于用户角色的权限管理 RBAC (Role-Based Access Control)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%92%E8%89%B2%E5%92%8C%E6%9D%83%E9%99%90model%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.7.1.</span> <span class="toc-text">角色和权限model设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9B%BF%E6%8D%A2AnonymousUserMixin"><span class="toc-number">3.7.2.</span> <span class="toc-text">替换AnonymousUserMixin</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E8%A3%85%E9%A5%B0%E5%99%A8-%E5%8F%8A-%E8%A3%85%E9%A5%B0%E5%99%A8%E7%9A%84%E7%BB%A7%E6%89%BF-%E8%A3%85%E9%A5%B0%E5%99%A8%E9%87%8C%E8%B0%83%E7%94%A8%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="toc-number">3.7.3.</span> <span class="toc-text">权限装饰器 及 装饰器的继承(装饰器里调用装饰器)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flask-Dropzone-%E4%BC%98%E5%8C%96%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">3.8.</span> <span class="toc-text">Flask-Dropzone 优化文件上传</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E5%AE%8F"><span class="toc-number">3.8.1.</span> <span class="toc-text">相关宏</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E8%A6%81%E9%85%8D%E7%BD%AE"><span class="toc-number">3.8.2.</span> <span class="toc-text">重要配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.8.3.</span> <span class="toc-text">简单示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flask-Avatars-%E5%A4%84%E7%90%86%E7%94%A8%E6%88%B7%E5%A4%B4%E5%83%8F"><span class="toc-number">3.9.</span> <span class="toc-text">Flask-Avatars 处理用户头像</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E5%AE%8F-1"><span class="toc-number">3.9.1.</span> <span class="toc-text">相关宏</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%88%A0%E9%99%A4"><span class="toc-number">3.10.</span> <span class="toc-text">文件删除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BD%93%E9%A1%B5%E7%BC%96%E8%BE%91%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">3.11.</span> <span class="toc-text">当页编辑的最佳实践</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E5%85%A8%E5%B1%80Ajax%E9%94%99%E8%AF%AF"><span class="toc-number">3.12.</span> <span class="toc-text">注册全局Ajax错误</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flask-login%E7%9A%84fresh-login-required-%E9%87%8D%E6%96%B0%E7%99%BB%E5%BD%95"><span class="toc-number">3.13.</span> <span class="toc-text">flask-login的fresh_login_required : 重新登录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#subquery-%E4%B8%8E-in-%E4%B8%8E-join"><span class="toc-number">3.14.</span> <span class="toc-text">subquery 与 in_ 与 join</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sqlalchemy%E9%9A%8F%E6%9C%BA%E8%8E%B7%E5%8F%96%E5%86%85%E5%AE%B9"><span class="toc-number">3.15.</span> <span class="toc-text">sqlalchemy随机获取内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flask-Whooshee-%E5%AE%9E%E7%8E%B0%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2"><span class="toc-number">3.16.</span> <span class="toc-text">Flask Whooshee 实现全文搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.16.1.</span> <span class="toc-text">示例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E7%AB%A0-%E4%BB%A3%E5%8A%9E%E4%BA%8B%E9%A1%B9%E7%A8%8B%E5%BA%8F"><span class="toc-number">4.</span> <span class="toc-text">第十章 代办事项程序</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E9%A1%B5%E9%9D%A2%E5%BA%94%E7%94%A8%E5%B8%83%E5%B1%80"><span class="toc-number">4.1.</span> <span class="toc-text">单页面应用布局</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E6%A0%B9%E9%A1%B5%E9%9D%A2%E5%86%85%E5%88%87%E6%8D%A2%E5%AD%90%E9%A1%B5%E9%9D%A2"><span class="toc-number">4.1.1.</span> <span class="toc-text">在根页面内切换子页面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#template%E7%9A%84True-False%E8%BD%AC%E4%B8%BAtrue-false"><span class="toc-number">4.1.2.</span> <span class="toc-text">template的True,False转为true,false</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Flask-Babel-%E6%94%AF%E6%8C%81%E5%9B%BD%E9%99%85%E5%8C%96%E4%B8%8E%E6%9C%AC%E5%9C%B0%E5%8C%96"><span class="toc-number">4.2.</span> <span class="toc-text">使用 Flask-Babel 支持国际化与本地化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%BA%E5%9F%9F%E5%92%8C%E8%AF%AD%E8%A8%80"><span class="toc-number">4.2.1.</span> <span class="toc-text">区域和语言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E6%9C%AC%E7%9A%84%E5%9B%BD%E9%99%85%E5%8C%96"><span class="toc-number">4.2.2.</span> <span class="toc-text">文本的国际化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E5%AD%90%E5%9F%9F%E5%90%8D"><span class="toc-number">4.3.</span> <span class="toc-text">设置子域名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flask-cors-%E6%94%AF%E6%8C%81%E8%B7%A8%E5%9F%9F%E8%B5%84%E6%BA%90%E5%85%B1%E4%BA%AB"><span class="toc-number">4.4.</span> <span class="toc-text">flask-cors 支持跨域资源共享</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RESTfull-API"><span class="toc-number">4.5.</span> <span class="toc-text">RESTfull API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E7%AB%AF%E7%82%B9%E4%B8%8EHTTP%E6%96%B9%E6%B3%95%E7%9A%84%E6%93%8D%E4%BD%9C%E5%90%AB%E4%B9%89"><span class="toc-number">4.5.1.</span> <span class="toc-text">资源端点与HTTP方法的操作含义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MethodView"><span class="toc-number">4.5.2.</span> <span class="toc-text">MethodView</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#API%E7%9A%84-OAuth-%E8%AE%A4%E8%AF%81-%E5%8F%8A%E7%AC%AC%E4%B8%89%E6%96%B9%E8%AE%A4%E8%AF%81%E7%99%BB%E5%BD%95"><span class="toc-number">4.5.3.</span> <span class="toc-text">API的 OAuth 认证 及第三方认证登录</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Web-API%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">4.6.</span> <span class="toc-text">Web API的序列化与反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JSON%E6%95%B0%E6%8D%AE%E9%A3%8E%E6%A0%BC%E6%8C%87%E5%8D%97%E6%91%98%E8%A6%81"><span class="toc-number">4.6.1.</span> <span class="toc-text">JSON数据风格指南摘要</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Marshmallow-%E4%B8%8E-Webargs"><span class="toc-number">4.7.</span> <span class="toc-text">Marshmallow 与 Webargs</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#webargs%E7%9A%84422%E9%94%99%E8%AF%AF"><span class="toc-number">4.7.1.</span> <span class="toc-text">webargs的422错误</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#webargs%E8%A7%A3%E6%9E%90%E5%AD%97%E6%AE%B5%E4%B8%80%E8%A7%88"><span class="toc-number">4.7.2.</span> <span class="toc-text">webargs解析字段一览</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#webargs%E9%85%8D%E5%90%88marshmallow"><span class="toc-number">4.7.3.</span> <span class="toc-text">webargs配合marshmallow</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#webargs%E5%A4%9A%E5%AD%97%E6%AE%B5%E4%BD%8D%E7%BD%AE"><span class="toc-number">4.7.4.</span> <span class="toc-text">webargs多字段位置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0-%E5%9C%A8%E7%BA%BF%E8%81%8A%E5%A4%A9%E5%AE%A4"><span class="toc-number">5.</span> <span class="toc-text">第十一章 在线聊天室</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Flask-SocketIO-%E5%BB%BA%E7%AB%8B%E5%AE%9E%E6%97%B6%E5%8F%8C%E5%90%91%E9%80%9A%E4%BF%A1"><span class="toc-number">5.1.</span> <span class="toc-text">使用 Flask-SocketIO 建立实时双向通信</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8Socket-IO%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">5.1.1.</span> <span class="toc-text">启动Socket.IO服务器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SocketIO%E4%BA%8B%E4%BB%B6"><span class="toc-number">5.1.2.</span> <span class="toc-text">SocketIO事件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E7%A4%BA%E4%BE%8B-1"><span class="toc-number">5.1.3.</span> <span class="toc-text">简单示例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%82%A8%E5%AD%98global%E6%95%B0%E6%8D%AE"><span class="toc-number">5.1.4.</span> <span class="toc-text">储存global数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">5.1.5.</span> <span class="toc-text">异常处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gunicorn%E9%85%8D%E7%BD%AE"><span class="toc-number">5.1.6.</span> <span class="toc-text">gunicorn配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Socket-io%E9%80%9A%E4%BF%A1%E9%A2%91%E9%81%93%E5%88%86%E7%A6%BB"><span class="toc-number">5.2.</span> <span class="toc-text">Socket.io通信频道分离</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="toc-number">5.2.1.</span> <span class="toc-text">命名空间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%88%BF%E9%97%B4"><span class="toc-number">5.2.2.</span> <span class="toc-text">房间</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Flask-OAuthlib-%E5%AE%9E%E7%8E%B0%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95"><span class="toc-number">5.3.</span> <span class="toc-text">使用 Flask-OAuthlib 实现第三方登录</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8"><span class="toc-number">5.3.1.</span> <span class="toc-text">简单使用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bleach-markdown%E5%BA%93%E6%94%AF%E6%8C%81markdown"><span class="toc-number">5.4.</span> <span class="toc-text">bleach+markdown库支持markdown</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8-1"><span class="toc-number">5.4.1.</span> <span class="toc-text">简单使用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E8%AF%AD%E6%B3%95%E9%AB%98%E4%BA%AE"><span class="toc-number">5.5.</span> <span class="toc-text">代码语法高亮</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#desktop-notification-%E6%A1%8C%E9%9D%A2%E9%80%9A%E7%9F%A5"><span class="toc-number">5.6.</span> <span class="toc-text">desktop notification(桌面通知)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8-2"><span class="toc-number">5.6.1.</span> <span class="toc-text">简单使用</span></a></li></ol></li></ol></li></ol></details></div><div class="container post-content"><h2 id="第七章-留言板"><a href="#第七章-留言板" class="headerlink" title="第七章 留言板"></a>第七章 留言板</h2><h3 id="使用click创建虚拟数据"><a href="#使用click创建虚拟数据" class="headerlink" title="使用click创建虚拟数据"></a>使用click创建虚拟数据</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.cli.command()</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;--count&#x27;</span>, default=<span class="number">20</span>, <span class="built_in">help</span>=<span class="string">&#x27;Quantity of messages, default is 20.&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">forge</span>(<span class="params">count</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Generate fake messages.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">from</span> faker <span class="keyword">import</span> Faker</span><br><span class="line"></span><br><span class="line">    db.drop_all()</span><br><span class="line">    db.create_all()</span><br><span class="line"></span><br><span class="line">    fake = Faker()</span><br><span class="line">    click.echo(<span class="string">&#x27;Working...&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(count):</span><br><span class="line">        message = Message(</span><br><span class="line">            name=fake.name(),</span><br><span class="line">            body=fake.sentence(),</span><br><span class="line">            timestamp=fake.date_time_this_year()</span><br><span class="line">        )</span><br><span class="line">        db.session.add(message)</span><br><span class="line"></span><br><span class="line">    db.session.commit()</span><br><span class="line">    click.echo(<span class="string">&#x27;Created %d fake messages.&#x27;</span> % count)</span><br></pre></td></tr></table></figure>



<h3 id="Bootstrap-Flask-插件"><a href="#Bootstrap-Flask-插件" class="headerlink" title="Bootstrap-Flask 插件"></a>Bootstrap-Flask 插件</h3><p>注意 , 不是flask-Boostrap.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install bootstrap-flask </span><br></pre></td></tr></table></figure>

<p>Bootstrap-Flask插件最牛逼的地方就是内置了很多常用的宏</p>
<table>
<thead>
<tr>
<th>宏</th>
<th>所在模板路径</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>render_field</td>
<td>bootstrap/form.html</td>
<td>渲染单个 WTForms表单字段</td>
</tr>
<tr>
<td>render_form</td>
<td>bootstrap/form.html</td>
<td>渲染整个 WTForms表单类</td>
</tr>
<tr>
<td>render_pager</td>
<td>bootstrap/pagination.html</td>
<td>渲染一个基础分页导航，仅包含上一页、下一页按钮</td>
</tr>
<tr>
<td>render_pagination</td>
<td>bootstrap/pagination.html</td>
<td>渲染一个标准分页导航部件</td>
</tr>
<tr>
<td>render_nav_item</td>
<td>bootstrap/nav.html</td>
<td>渲染导航链接</td>
</tr>
<tr>
<td>render_breadcrumb_item</td>
<td>bootstrap/nav.html</td>
<td>渲染面包屑链接</td>
</tr>
</tbody></table>
<h3 id="Flask-Moment-本地化日期和时间"><a href="#Flask-Moment-本地化日期和时间" class="headerlink" title="Flask-Moment 本地化日期和时间"></a>Flask-Moment 本地化日期和时间</h3><ul>
<li>Moment.js是一个用于处理时间和日期的开源JavaScript库，它可以对时间和日期进行各种方式的处理。</li>
<li>它会根据用户电脑中的时区设置在客户端使用 Javascript来渲染时间和日期，</li>
<li>另外它还提供了丰富的时间渲染格式支持。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install flask-moment</span><br></pre></td></tr></table></figure>



<p>使用datetime.utcnow这个<code>纯正时间</code>替代 datetime.now这个<code>细致时间</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Message</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">20</span>))</span><br><span class="line">    body = db.Column(db.String(<span class="number">200</span>))</span><br><span class="line">    timestamp = db.Column(db.DateTime, default=datetime.utcnow, index=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>



<h2 id="第八章-个人博客"><a href="#第八章-个人博客" class="headerlink" title="第八章 个人博客"></a>第八章 个人博客</h2><h3 id="为什么使用Endpoint"><a href="#为什么使用Endpoint" class="headerlink" title="为什么使用Endpoint?"></a>为什么使用Endpoint?</h3><p>我们在使用url_for()的时候 , 定位的都是Endpoint , 而不是使用视图函数 . 为啥?</p>
<p>因为使用端点可以实现蓝本的视图函数命名空间。即<code>“蓝本名.视图函数名”</code> , 这样就支持视图函数重名了</p>
<h3 id="邻接列表关系"><a href="#邻接列表关系" class="headerlink" title="邻接列表关系"></a>邻接列表关系</h3><ul>
<li>楼中楼功能 : 给某条回复添加新的回复</li>
<li>方法:<ul>
<li>方法一 : 创建Cormment和Replay表 , 然后使用一对多关系将评论和回复关联起来。</li>
<li>方法二 : 因为回复本身也是评论，如果可以在评论模型内建立层级关系，那么就可以在一个模型中表示评论和回复。</li>
</ul>
</li>
<li>这种在同一个模型内的一对多关系在 SQLALchemy中被称为邻接列表关系</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    title = db.Column(db.String(<span class="number">60</span>))</span><br><span class="line">    body = db.Column(db.Text)</span><br><span class="line">    timestamp = db.Column(db.DateTime, default=datetime.utcnow, index=<span class="literal">True</span>)</span><br><span class="line">    comments = db.relationship(<span class="string">&#x27;Comment&#x27;</span>, back_populates=<span class="string">&#x27;post&#x27;</span>, cascade=<span class="string">&#x27;all, delete-orphan&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Comment</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    author = db.Column(db.String(<span class="number">30</span>))</span><br><span class="line">    body = db.Column(db.Text)</span><br><span class="line"></span><br><span class="line">    replied_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;comment.id&#x27;</span>))</span><br><span class="line">    post_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;post.id&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    post = db.relationship(<span class="string">&#x27;Post&#x27;</span>, back_populates=<span class="string">&#x27;comments&#x27;</span>)</span><br><span class="line">    <span class="comment"># 子回复</span></span><br><span class="line">    replies = db.relationship(<span class="string">&#x27;Comment&#x27;</span>, back_populates=<span class="string">&#x27;replied&#x27;</span>, cascade=<span class="string">&#x27;all, delete-orphan&#x27;</span>) </span><br><span class="line">    <span class="comment"># 父回复</span></span><br><span class="line">    replied = db.relationship(<span class="string">&#x27;Comment&#x27;</span>, back_populates=<span class="string">&#x27;replies&#x27;</span>, remote_side=[<span class="built_in">id</span>])</span><br></pre></td></tr></table></figure>

<p>在这个关系函数中，通过将 remote side参数设为id字段，我们就把id字段定义为关系的远程侧（Remote side），而 replied id就相应地变为本地侧（Local side），这样反向关系就被定义为多对一，即多个回复对应一个父评论。</p>
<h3 id="渲染导航链接"><a href="#渲染导航链接" class="headerlink" title="渲染导航链接"></a>渲染导航链接</h3><ul>
<li>因为请求是先经过View函数 , 此时已经有endpoint</li>
<li>所以可以使用<code>request.endpoint== &#39;blog.index&#39;</code> 来确定激活的sidebar</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;li &#123;% request.endpoint == &#x27;blog.index&#x27; %&#125;  class=&quot;active&quot; &#123;% endif %&#125;&gt;</span><br><span class="line">	&lt;a href=&quot;&#123;&#123; url_for(&#x27;blog.index&#x27;&#x27;&#x27;) &#125;&#125;&quot;&gt;Home&lt;/a&gt;</span><br><span class="line">&lt;/li&gt;</span><br></pre></td></tr></table></figure>



<h3 id="切换博客主题-切换CSS"><a href="#切换博客主题-切换CSS" class="headerlink" title="切换博客主题(切换CSS)"></a>切换博客主题(切换CSS)</h3><p>切换博客主题 , 其实就是切换CSS文件 , 一般的操作思路如下</p>
<ul>
<li><p>定义一个view专门来切换cookies . 前端按钮触发这个View</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BLUELOG_THEMES = &#123;<span class="string">&#x27;perfect_blue&#x27;</span>: <span class="string">&#x27;Perfect Blue&#x27;</span>, <span class="string">&#x27;black_swan&#x27;</span>: <span class="string">&#x27;Black Swan&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@blog_bp.route(<span class="params"><span class="string">&#x27;/change-theme/&lt;theme_name&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_theme</span>(<span class="params">theme_name</span>):</span></span><br><span class="line">    <span class="keyword">if</span> theme_name <span class="keyword">not</span> <span class="keyword">in</span> current_app.config[<span class="string">&#x27;BLUELOG_THEMES&#x27;</span>].keys():</span><br><span class="line">        abort(<span class="number">404</span>)</span><br><span class="line"></span><br><span class="line">    response = make_response(redirect(url_for(<span class="string">&#x27;blog.index&#x27;</span>)</span><br><span class="line">    response.set_cookie(<span class="string">&#x27;theme&#x27;</span>, theme_name, max_age=<span class="number">30</span> * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span>)</span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure></li>
<li><p>修改template</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;link rel=&quot;stylesheet&quot; href=&quot;&#123;&#123; url_for(&#x27;static&#x27;, filename=&#x27;css/%s.min.css&#x27; % request.cookies.get(&#x27;theme&#x27;, &#x27;perfect_blue&#x27;)) &#125;&#125;&quot; type=&quot;text/css&quot;&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>主题列表 : </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> &lt;div class=&quot;dropdown-menu&quot; aria-labelledby=&quot;dropdownMenuButton&quot;&gt;</span><br><span class="line"> &#123;% for theme_name, display_name in config.BLUELOG_THEMES.items() %&#125;</span><br><span class="line"> 	&lt;a class=&quot;dropdown-item&quot; href=&quot;&#123;&#123; url_for(&#x27;blog.change_theme&#x27;, theme_name=theme_name, next=request.full_path) &#125;&#125;&quot;&gt; &#123;&#123; display_name &#125;&#125;&lt;/a&gt;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"> &lt;/div&gt;</span><br></pre></td></tr></table></figure>



<h3 id="Flask-Login"><a href="#Flask-Login" class="headerlink" title="Flask-Login"></a>Flask-Login</h3><h4 id="login-user的背后逻辑"><a href="#login-user的背后逻辑" class="headerlink" title="login_user的背后逻辑"></a>login_user的背后逻辑</h4><ul>
<li><p>调用User模型的get_id()函数 (<strong>该函数返回User的唯一标识</strong> , 如果User继承UserMixin , 那么函数get_id返回primaryKey)</p>
</li>
<li><p>将get_id()的结果存入session</p>
</li>
<li><p>每次执行被<code>@login_required</code>装饰的View的时候 , 都会从session中拿到这个唯一标识 . 接着把这个唯一标识传入load_user函数(<strong>该函数就是根据唯一标识找到对应的User实例</strong>)</p>
</li>
<li><p>login user的remember参数 : 设为True时 Flask-Login会在用户浏览器中创建一个名为 remember token的 cookie，当通过 session设置的 user_id cookie因为用户关闭浏览器而失效时，它会重新恢复 user_id cookie的值。</p>
</li>
</ul>
<h4 id="currenr-user"><a href="#currenr-user" class="headerlink" title="currenr_user"></a>currenr_user</h4><ul>
<li><p>currenr_user是一个和 current app类似的<strong>代理对象</strong>（Proxy），表示当前用户。调用时会返回与当前用户对应的用户模型类对象。</p>
</li>
<li><p>因为<strong>session中只会存储登录用户的id</strong>，所以为了让它返回对应的用户对象，我们还需要设置一个用户加载函数。这个函数需要使用 login manager.user_loader装饰器，它接收用户id作为参数，返回对应的用户对象，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@loginmanager.user_loader</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_user</span>(<span class="params">user_id</span>):</span></span><br><span class="line">    <span class="keyword">return</span> User.query.filter_by(<span class="built_in">id</span>=user_id).first()</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="为一整个蓝图添加login-required"><a href="#为一整个蓝图添加login-required" class="headerlink" title="为一整个蓝图添加login_required"></a>为一整个蓝图添加login_required</h4><ul>
<li>为蓝本注册一个 before request处理函数，然后为这个函数附加 login required装饰器。</li>
<li>因为使用 before request钩子注册的函数会在每一个请求前运行，所以这样就可以为该蓝本下所有的视图函数添加保护，函数内容可以为空</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@bp.brefor_request</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login_protest</span>():</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>



<h3 id="使用CSRFProtect拓展手动实现CSRF防御"><a href="#使用CSRFProtect拓展手动实现CSRF防御" class="headerlink" title="使用CSRFProtect拓展手动实现CSRF防御"></a>使用CSRFProtect拓展手动实现CSRF防御</h3><p>CSRFProtect类内置于WTForm , 因此可以直接使用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_wtf <span class="keyword">import</span> CSRFProtect</span><br><span class="line">csrf = CSRFProtect()</span><br><span class="line"></span><br><span class="line">csrf.init_app(app)</span><br></pre></td></tr></table></figure>

<p>创建一个hidden的input字段 ,name为<code>csrf_token</code> , value为<code>&#123;&#123; csrf_token() &#125;&#125;</code> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;form class=&quot;inline&quot; method=&quot;post&quot;</span><br><span class="line">      action=&quot;&#123;&#123; url_for(&#x27;admin.delete_post&#x27;, post_id=post.id, next=url_for(&#x27;blog.index&#x27;)) &#125;&#125;&quot;&gt;</span><br><span class="line">    &lt;input type=&quot;hidden&quot; name=&quot;csrf_token&quot; value=&quot;&#123;&#123; csrf_token() &#125;&#125;&quot;/&gt;</span><br><span class="line">    &lt;button type=&quot;submit&quot; class=&quot;btn btn-danger btn-sm&quot; onclick=&quot;return confirm(&#x27;Are you sure?&#x27;);&quot;&gt;Delete</span><br><span class="line">    &lt;/button&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>CSRFProtect 会自动获取并验证csrf令牌</strong></li>
<li>默认情况下，当令牌验证出错或过期时，程序会返回400错误，也可以单独创建一个错误处理函数捕捉令牌出错时抛出的 CSRFError异常，</li>
<li>Werkzeug内置的HTTP异常类 , 都会将错误描述保存在异常对象的description属性中。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_wtf.csrf <span class="keyword">import</span> CSRFError</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register_errors</span>(<span class="params">app</span>):</span></span><br><span class="line"><span class="meta">    @app.errorhandler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">page_not_found</span>(<span class="params">e</span>):</span></span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;errors/404.html&#x27;</span>), <span class="number">404</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @app.errorhandler(<span class="params">CSRFError</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_csrf_error</span>(<span class="params">e</span>):</span></span><br><span class="line">        <span class="comment"># Werkzeug内置的HTTP异常类 , 都会将错误描述保存在异常对象的description属性中。</span></span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;errors/400.html&#x27;</span>, description=e.description), <span class="number">400</span></span><br></pre></td></tr></table></figure>

<h4 id="取消对某个蓝图的CSRF防御"><a href="#取消对某个蓝图的CSRF防御" class="headerlink" title="取消对某个蓝图的CSRF防御"></a>取消对某个蓝图的CSRF防御</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_wtf <span class="keyword">import</span> CSRFProtect</span><br><span class="line"></span><br><span class="line">api_v1 = Blueprint(<span class="string">&#x27;api_v1&#x27;</span>, __name__)</span><br><span class="line">csrf = CSRFProtect()</span><br><span class="line">csrf.exempt(api_v1)</span><br></pre></td></tr></table></figure>



<h2 id="第九章-图片社交网站"><a href="#第九章-图片社交网站" class="headerlink" title="第九章 图片社交网站"></a>第九章 图片社交网站</h2><h3 id="项目组织架构"><a href="#项目组织架构" class="headerlink" title="项目组织架构"></a>项目组织架构</h3><p>在大型 Flask项目中，主要有三种常见的项目组织架构：</p>
<ul>
<li><p>功能式架构</p>
<blockquote>
<p>在功能式架构中，程序包由各个代表程序组件（功能）的子包组成，比如 blueprints（蓝本）forms（表单）、templates（模板）、models（模型）等，在这些子包中，按照程序的板块分模块来组织代码，比如 forms子包下包含 front.py、auth,py和 dashboard py</p>
</blockquote>
</li>
<li><p>分区式架构</p>
<blockquote>
<p>在分区式架构中，程序被按照自身的板块分成不同的子包。myapp使用分区式架构可以分别创建 front、auth和 dashboard三个子包，这些子包直接在程序包的根目录下创建，子包中使用模块组织不同的程序组件，比如 vIews.py、forms。py等。这种分类自然决定了每一个子包都对应着一个蓝本，这时蓝本在每个子包的构造文件中创建。</p>
</blockquote>
</li>
<li><p>混合式架构</p>
<blockquote>
<p>混合式架构，顾名思义，就是不按照常规分类来组织。比如，采用类似分区式架构的子包来组织程序，但各个蓝本共用程序包根目录下的模板文件夹和静态文件文件夹</p>
</blockquote>
</li>
</ul>
<h3 id="在线的占位图片服务"><a href="#在线的占位图片服务" class="headerlink" title="在线的占位图片服务"></a>在线的占位图片服务</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;# id这个query-args是为了破环存缓 #&#125;</span><br><span class="line">&lt;img src=&quot;https://picsum.photos/800/?random&amp;id=&#123;&#123; photo .id &#125;&#125; &quot; &gt; </span><br></pre></td></tr></table></figure>

<ul>
<li>URL类似<a target="_blank" rel="noopener" href="https://picsum.photos/600/800.%E5%A6%82%E6%9E%9C%E6%83%B3%E8%8E%B7%E5%8F%96%E6%AD%A3%E6%96%B9%E5%BD%A2%E7%9A%84%E5%9B%BE%E7%89%87%EF%BC%8C%E9%82%A3%E4%B9%88%E5%8F%AA%E4%BC%A0%E9%80%92%E4%B8%80%E4%B8%AA%E5%B0%BA%E5%AF%B8%E6%95%B0%E5%AD%97%E5%B0%B1%E5%8F%AF%E4%BB%A5%E4%BA%86%E3%80%82">https://picsum.photos/600/800.如果想获取正方形的图片，那么只传递一个尺寸数字就可以了。</a></li>
<li>如果你想要每次请求都获得随机的图片，可以在URL后面附加?random。</li>
<li>不过这会有一点问题。因为当浏览器发现你有多个发往同一个URL的请求时，它会使用缓存的响应，这样你的图片就不再是随机的了。为了避免浏览器这个“好心”的缓存行为，我们可以在URL后附加一个无意义的查询字符串，使用数据库图片记录的id填充。这个查询字符串会被服务器忽略，但因为每个图片URL的参数都不同，浏览器会把它们都当作不同的请求来处理，</li>
<li>这种技术被称为 Cache Busting（缓存破坏）。</li>
</ul>
<h3 id="WTForm的EqualTo和Regexp校验器"><a href="#WTForm的EqualTo和Regexp校验器" class="headerlink" title="WTForm的EqualTo和Regexp校验器"></a>WTForm的EqualTo和Regexp校验器</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterForm</span>(<span class="params">FlaskForm</span>):</span></span><br><span class="line">    username = StringField(<span class="string">&#x27;Username&#x27;</span>, validators=[DataRequired(), Length(<span class="number">1</span>, <span class="number">20</span>),Regexp(<span class="string">&#x27;^[a-zA-Z0-9]*$&#x27;</span>)])</span><br><span class="line">    password = PasswordField(<span class="string">&#x27;Password&#x27;</span>, validators=[DataRequired(), Length(<span class="number">8</span>, <span class="number">128</span>), EqualTo(<span class="string">&#x27;password2&#x27;</span>)])</span><br><span class="line">    password2 = PasswordField(<span class="string">&#x27;Confirm password&#x27;</span>, validators=[DataRequired()])</span><br></pre></td></tr></table></figure>



<h3 id="生成JWS（json-Web-Signature）"><a href="#生成JWS（json-Web-Signature）" class="headerlink" title="生成JWS（json Web Signature）"></a>生成JWS（json Web Signature）</h3><ul>
<li>JWS由三部分组成，它们分别是存储签名所使用的算法、签名时间和过期时间的头部（Header）、存储数据的负载（Payload）和签名（Signature）。</li>
<li>序列化对象提供一个 dumps方法来写入数据，它接收包含数据的字典对象作为参数。它会根据过期时间创建头部（Header），然后将数据编码到JWS的负载（Payload）中，再使用密钥对令牌进行签名（Signature），最后将签名序列化后生成令牌值。</li>
<li>简单来说 , 只要为<code>TimedJSONWebSignatureSerializer</code>的dumps()函数传入query_args , 即可生成token</li>
<li>后端接受到token后 , 调用<code>TimedJSONWebSignatureSerializer(current_app.config[&#39;SECRET_KEY&#39;]).loads(token)</code> , 如果没有报错 , 即可证明验证通过</li>
<li>之后就可以通过data.get(‘operation’)来获取query_args</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itsdangerous <span class="keyword">import</span> TimedJSONWebSignatureSerializer <span class="keyword">as</span> Serializer</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_token</span>(<span class="params">user, operation, expire_in=<span class="literal">None</span>, **kwargs</span>):</span></span><br><span class="line">    s = Serializer(current_app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>], expire_in)</span><br><span class="line">    data = &#123;<span class="string">&#x27;id&#x27;</span>: user.<span class="built_in">id</span>, <span class="string">&#x27;operation&#x27;</span>: operation&#125;</span><br><span class="line">    data.update(**kwargs)</span><br><span class="line">    <span class="comment"># 根据data里的参数 , 生成token</span></span><br><span class="line">    <span class="keyword">return</span> s.dumps(data)</span><br><span class="line"></span><br><span class="line">token = generate_token(user=user, operation=<span class="string">&#x27;confirm&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>验证token : </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">validate_token</span>(<span class="params">user, token, operation, new_password=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = Serializer(current_app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>]).loads(token)</span><br><span class="line">    <span class="keyword">except</span> (SignatureExpired, BadSignature):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> operation != data.get(<span class="string">&#x27;operation&#x27;</span>) <span class="keyword">or</span> user.<span class="built_in">id</span> != data.get(<span class="string">&#x27;id&#x27;</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> operation == <span class="string">&#x27;confirm&#x27;</span>:</span><br><span class="line">        user.confirmed = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">elif</span> operation == <span class="string">&#x27;reset-password&#x27;</span>:</span><br><span class="line">        user.set_password(new_password)</span><br><span class="line">    <span class="keyword">elif</span> operation == <span class="string">&#x27;change-email&#x27;</span>:</span><br><span class="line">        new_email = data.get(<span class="string">&#x27;new_email&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> new_email <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> User.query.filter_by(email=new_email).first() <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        user.email = new_email</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    db.session.commit()</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@auth_bp.route(<span class="params"><span class="string">&#x27;/confirm/&lt;token&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">confirm</span>(<span class="params">token</span>):</span></span><br><span class="line">    <span class="keyword">if</span> current_user.confirmed:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;main.index&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> validate_token(user=current_user, token=token, operation=<span class="string">&#x27;confirm&#x27;</span>):</span><br><span class="line">        flash(<span class="string">&#x27;Account confirmed.&#x27;</span>, <span class="string">&#x27;success&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;main.index&#x27;</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        flash(<span class="string">&#x27;Invalid or expired token.&#x27;</span>, <span class="string">&#x27;danger&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;.resend_confirm_email&#x27;</span>))</span><br></pre></td></tr></table></figure>



<h3 id="flask的装饰器必须使用wraps装饰器"><a href="#flask的装饰器必须使用wraps装饰器" class="headerlink" title="flask的装饰器必须使用wraps装饰器"></a>flask的装饰器必须使用wraps装饰器</h3><ul>
<li>使用 functors模块提供的 wraps装饰器可以避免被装饰函数的特殊属性被更改，比如函数名称<code>__name__</code>被更改。</li>
<li>如果不使用该模块，则会导致函数名称被替换，从而导致端点（端点的默认值即函数名）出错</li>
</ul>
<h3 id="flash函数中返回危险文本的操作"><a href="#flash函数中返回危险文本的操作" class="headerlink" title="flash函数中返回危险文本的操作"></a>flash函数中返回危险文本的操作</h3><ul>
<li>flash函数发送的消息在模板中渲染，消息内容会被自动转义为普通文本。</li>
<li>可以在模板中使用safe过滤器来避免Jina2对变量转义，但对fash消息使用safe过滤器会造成安全隐患，因为攻击者可能会篡改消息内容。</li>
<li>更安全的做法是将传入flash函数的文本转换为 Markup对象。Flask提供的 Markup类可以将文本标记为安全文本，从而避免在渲染时对Jina2进行转义。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">message = Markup(</span><br><span class="line">    <span class="string">&#x27;Please confirm your account first.&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Not receive the email?&#x27;</span></span><br><span class="line">    <span class="string">&#x27;&lt;a class=&quot;alert-link&quot; href=&quot;%s&quot;&gt;Resend Confirm Email&lt;/a&gt;&#x27;</span> %</span><br><span class="line">    url_for(<span class="string">&#x27;auth.resend_confirm_email&#x27;</span>))</span><br><span class="line">flash(message, <span class="string">&#x27;warning&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h3 id="基于用户角色的权限管理-RBAC-Role-Based-Access-Control"><a href="#基于用户角色的权限管理-RBAC-Role-Based-Access-Control" class="headerlink" title="基于用户角色的权限管理 RBAC (Role-Based Access Control)"></a>基于用户角色的权限管理 RBAC (Role-Based Access Control)</h3><h4 id="角色和权限model设计"><a href="#角色和权限model设计" class="headerlink" title="角色和权限model设计"></a>角色和权限model设计</h4><ul>
<li><p>角色与权限模型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">roles_permissions = db.Table(<span class="string">&#x27;roles_permissions&#x27;</span>,</span><br><span class="line">                             db.Column(<span class="string">&#x27;role_id&#x27;</span>, db.Integer, db.ForeignKey(<span class="string">&#x27;role.id&#x27;</span>)),</span><br><span class="line">                             db.Column(<span class="string">&#x27;permission_id&#x27;</span>, db.Integer, db.ForeignKey(<span class="string">&#x27;permission.id&#x27;</span>))</span><br><span class="line">                             )</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Permission</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">30</span>), unique=<span class="literal">True</span>)</span><br><span class="line">    roles = db.relationship(<span class="string">&#x27;Role&#x27;</span>, secondary=roles_permissions, back_populates=<span class="string">&#x27;permissions&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Role</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">30</span>), unique=<span class="literal">True</span>)</span><br><span class="line">    users = db.relationship(<span class="string">&#x27;User&#x27;</span>, back_populates=<span class="string">&#x27;role&#x27;</span>)</span><br><span class="line">    permissions = db.relationship(<span class="string">&#x27;Permission&#x27;</span>, secondary=roles_permissions, back_populates=<span class="string">&#x27;roles&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">db.Model, UserMixin</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    username = db.Column(db.String(<span class="number">20</span>), unique=<span class="literal">True</span>, index=<span class="literal">True</span>)</span><br><span class="line">    password_hash = db.Column(db.String(<span class="number">128</span>))</span><br><span class="line">    role_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;role.id&#x27;</span>))</span><br><span class="line">    role = db.relationship(<span class="string">&#x27;Role&#x27;</span>, back_populates=<span class="string">&#x27;users&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>权限定义 示例</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>权限名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>关注用户</td>
<td>FOLLOW</td>
<td>关注其他用户</td>
</tr>
<tr>
<td>收藏图片</td>
<td>COLLECT</td>
<td>添加图片到自己的收藏</td>
</tr>
<tr>
<td>发表评论</td>
<td>COMMENT</td>
<td>在图片下添加评论</td>
</tr>
<tr>
<td>上传图片</td>
<td>UPLOAD</td>
<td>上传图片</td>
</tr>
<tr>
<td>协管员权限</td>
<td>MODERATE</td>
<td>管理资源权限，可以管理网站的用户、图片、评论、标签等资源</td>
</tr>
<tr>
<td>管理员权限</td>
<td>ADMINISTER</td>
<td>管理用户角色、编辑网站信息等</td>
</tr>
</tbody></table>
<p>角色定义 示例</p>
<table>
<thead>
<tr>
<th>角色名称</th>
<th>拥有的权限</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>访客（Guest）</td>
<td>仅可以浏览页面</td>
<td>未登录用户</td>
</tr>
<tr>
<td>被封禁用户（Blocked）</td>
<td>仅可以浏览页面</td>
<td>因违规行为被封禁账号，禁止登录的用户</td>
</tr>
<tr>
<td>被锁定用户（Locked）</td>
<td>FOLLOW、COLLECT</td>
<td>因违规行为被锁定的用户</td>
</tr>
<tr>
<td>普通用户（User）</td>
<td>FOLLOW、COLLECT、COMMENT、UPLOAD</td>
<td>注册后用户获得的默认角色</td>
</tr>
<tr>
<td>协管员（Moderator）</td>
<td>除了拥有普通用户具有的权限外，还拥有管理网站拥有 MODERATE权限</td>
<td>除了普通用户的权限外内容的权限，负责网站内容管理和维护</td>
</tr>
<tr>
<td>管理员（Administrator）</td>
<td>除了拥有普通用户和协管员的所有权限外，还拥有 ADMINISTER权限</td>
<td>拥有所有权限的网站管理员</td>
</tr>
</tbody></table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">roles_permissions_map = &#123;</span><br><span class="line">    <span class="string">&#x27;Locked&#x27;</span>: [<span class="string">&#x27;FOLLOW&#x27;</span>, <span class="string">&#x27;COLLECT&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;User&#x27;</span>: [<span class="string">&#x27;FOLLOW&#x27;</span>, <span class="string">&#x27;COLLECT&#x27;</span>, <span class="string">&#x27;COMMENT&#x27;</span>, <span class="string">&#x27;UPLOAD&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Moderator&#x27;</span>: [<span class="string">&#x27;FOLLOW&#x27;</span>, <span class="string">&#x27;COLLECT&#x27;</span>, <span class="string">&#x27;COMMENT&#x27;</span>, <span class="string">&#x27;UPLOAD&#x27;</span>, <span class="string">&#x27;MODERATE&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;Administrator&#x27;</span>: [<span class="string">&#x27;FOLLOW&#x27;</span>, <span class="string">&#x27;COLLECT&#x27;</span>, <span class="string">&#x27;COMMENT&#x27;</span>, <span class="string">&#x27;UPLOAD&#x27;</span>, <span class="string">&#x27;MODERATE&#x27;</span>, <span class="string">&#x27;ADMINISTER&#x27;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里只有四种角色，没有访客和被封禁用户。</p>
<ul>
<li>访客不需要写入数据库，因为访客的作用就是用来表示不在数据库中的用户。</li>
<li>而被封禁的用户不允许登录，虽然这类用户拥有账户，但是其权限状态和访客完全相同。</li>
</ul>
</li>
<li><p>填充角色权限表数据 :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Role</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">30</span>), unique=<span class="literal">True</span>)</span><br><span class="line">    users = db.relationship(<span class="string">&#x27;User&#x27;</span>, back_populates=<span class="string">&#x27;role&#x27;</span>)</span><br><span class="line">    permissions = db.relationship(<span class="string">&#x27;Permission&#x27;</span>, secondary=roles_permissions, back_populates=<span class="string">&#x27;roles&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">init_role</span>():</span></span><br><span class="line">        roles_permissions_map = &#123;</span><br><span class="line">            <span class="string">&#x27;Locked&#x27;</span>: [<span class="string">&#x27;FOLLOW&#x27;</span>, <span class="string">&#x27;COLLECT&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;User&#x27;</span>: [<span class="string">&#x27;FOLLOW&#x27;</span>, <span class="string">&#x27;COLLECT&#x27;</span>, <span class="string">&#x27;COMMENT&#x27;</span>, <span class="string">&#x27;UPLOAD&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;Moderator&#x27;</span>: [<span class="string">&#x27;FOLLOW&#x27;</span>, <span class="string">&#x27;COLLECT&#x27;</span>, <span class="string">&#x27;COMMENT&#x27;</span>, <span class="string">&#x27;UPLOAD&#x27;</span>, <span class="string">&#x27;MODERATE&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;Administrator&#x27;</span>: [<span class="string">&#x27;FOLLOW&#x27;</span>, <span class="string">&#x27;COLLECT&#x27;</span>, <span class="string">&#x27;COMMENT&#x27;</span>, <span class="string">&#x27;UPLOAD&#x27;</span>, <span class="string">&#x27;MODERATE&#x27;</span>, <span class="string">&#x27;ADMINISTER&#x27;</span>]</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> role_name <span class="keyword">in</span> roles_permissions_map:</span><br><span class="line">            role = Role.query.filter_by(name=role_name).first()</span><br><span class="line">            <span class="keyword">if</span> role <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                role = Role(name=role_name)</span><br><span class="line">                db.session.add(role)</span><br><span class="line">            role.permissions = []</span><br><span class="line">            <span class="keyword">for</span> permission_name <span class="keyword">in</span> roles_permissions_map[role_name]:</span><br><span class="line">                permission = Permission.query.filter_by(name=permission_name).first()</span><br><span class="line">                <span class="keyword">if</span> permission <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    permission = Permission(name=permission_name)</span><br><span class="line">                    db.session.add(permission)</span><br><span class="line">                role.permissions.append(permission)</span><br><span class="line">        db.session.commit()</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="替换AnonymousUserMixin"><a href="#替换AnonymousUserMixin" class="headerlink" title="替换AnonymousUserMixin"></a>替换AnonymousUserMixin</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">db.Model, UserMixin</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    username = db.Column(db.String(<span class="number">20</span>), unique=<span class="literal">True</span>, index=<span class="literal">True</span>)</span><br><span class="line">    role = db.relationship(<span class="string">&#x27;Role&#x27;</span>, back_populates=<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_admin</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.role.name == <span class="string">&#x27;Administrator&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>User模型如上 , 现在我们就可以使用<code>current_user</code>来代理User模型了 , 所以我们可以使用<code>current_user.is_admin</code>来判断是不是管理员</p>
</li>
<li><p>但是 , 如果current_user是AnonymousUserMixin的话就不行了 , 因为AnonymousUserMixin对象没有is_admin属性</p>
</li>
<li><p>此时的方法就是替换AnonymousUserMixin</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_login <span class="keyword">import</span> LoginManager, AnonymousUserMixin</span><br><span class="line"></span><br><span class="line">login_manager = LoginManager()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Guest</span>(<span class="params">AnonymousUserMixin</span>):</span></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_admin</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">login_manager.anonymous_user = Guest</span><br></pre></td></tr></table></figure></li>
<li><p>一般这个操作放到extensions 模块中创建</p>
</li>
</ul>
<h4 id="权限装饰器-及-装饰器的继承-装饰器里调用装饰器"><a href="#权限装饰器-及-装饰器的继承-装饰器里调用装饰器" class="headerlink" title="权限装饰器 及 装饰器的继承(装饰器里调用装饰器)"></a>权限装饰器 及 装饰器的继承(装饰器里调用装饰器)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">permission_required</span>(<span class="params">permission_name</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorator</span>(<span class="params">func</span>):</span></span><br><span class="line"><span class="meta">        @wraps(<span class="params">func</span>)</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">decorated_function</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> current_user.can(permission_name):</span><br><span class="line">                abort(<span class="number">403</span>)</span><br><span class="line">            <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> decorated_function</span><br><span class="line">    <span class="keyword">return</span> decorator</span><br><span class="line"></span><br><span class="line"><span class="comment"># 继承permission_required装饰器 , 生成新的admin_required装饰器</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">admin_required</span>(<span class="params">func</span>):</span></span><br><span class="line">    <span class="keyword">return</span> permission_required(<span class="string">&#x27;ADMINISTER&#x27;</span>)(func)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">moderator_required</span>(<span class="params">func</span>):</span></span><br><span class="line">    <span class="keyword">return</span> permission_required(<span class="string">&#x27;Moderator&#x27;</span>)(func)</span><br></pre></td></tr></table></figure>



<h3 id="Flask-Dropzone-优化文件上传"><a href="#Flask-Dropzone-优化文件上传" class="headerlink" title="Flask-Dropzone 优化文件上传"></a>Flask-Dropzone 优化文件上传</h3><p>Dropzone. js是一款优秀的文件上传插件</p>
<p>详情参考 : <a target="_blank" rel="noopener" href="http://greyli.com/flask-dropzone/">http://greyli.com/flask-dropzone/</a> , <a target="_blank" rel="noopener" href="https://www.dropzonejs.com/">https://www.dropzonejs.com/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install flask-dropzone</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_dropzone <span class="keyword">import</span> Dropzone</span><br><span class="line">dropzone = Dropzone()</span><br></pre></td></tr></table></figure>



<h4 id="相关宏"><a href="#相关宏" class="headerlink" title="相关宏"></a>相关宏</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; dropzone.load_css() &#125;&#125;</span><br><span class="line">&#123;&#123; dropzone.load_js() &#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123; dropzone.create(action=&#x27;处理上传文件的路由URL&#x27;) &#125;&#125;</span><br><span class="line">&#123;&#123; dropzone.style(&#x27;border: 2px dashed #0087F7; margin: 10%&#x27;) &#125;&#125;</span><br><span class="line">&#123;&#123; dropzone.config() &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>View注意是<code>request.files.get(&#39;file&#39;)</code> , 而不是<code>request.files.getlist(&#39;file&#39;)</code> : <strong>默认一个请求发送一个文件</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span>():</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        f = request.files.get(<span class="string">&#x27;file&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> f.filename.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">1</span>] != <span class="string">&#x27;png&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;PNG only!&#x27;</span>, <span class="number">400</span>  <span class="comment"># return the error message, with a proper 4XX code</span></span><br><span class="line">        f.save(os.path.join(<span class="string">&#x27;the/path/to/save&#x27;</span>, f.filename))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>当文件被拖拽到上传区域，或是点击上传区域选择上传文件后，这些文件会以AJAX请求的形式发送到你在dropzone.create()方法中使用action参数传入的URL。</li>
<li>因为Dropzone.js通过AJAX请求提交文件，所以你没法在保存文件后将页面重定向。对于这个问题，你可以使用配置变量DROPZONE_REDIRECT_VIEW设置上传完成后跳转到的目标端点，或是添加一个按钮让用户自己点击进行跳转。</li>
<li>尽管Dropzone.js可以在前端对用户提交的文件进行验证，但为了安全考虑，我们仍然需要在服务器端进行二次验证。在服务器端验证时，如果验证出错，我们<strong>不能像往常那样使用flash()函数“闪现”错误消息</strong>，因为AJAX请求接受到响应后并不会重载页面，所以不会显示通过flash()函数发送的消息。<strong>正确的做法是返回400错误响应，使用错误消息作为响应的主体。</strong>此时前端就会像flash一样显示错误提示</li>
</ul>
<h4 id="重要配置"><a href="#重要配置" class="headerlink" title="重要配置"></a>重要配置</h4><p>设置文件类型过滤</p>
<p>Flask-Dropzone内置了一些文件类型（通过MIME定义），可选的值和对应的文件类型如下所示：</p>
<ul>
<li>default：默认值，运行所有类型</li>
<li>image：图片</li>
<li>audio：音频</li>
<li>video：视频</li>
<li>text：文本</li>
<li>app：程序</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.config[<span class="string">&#x27;DROPZONE_ALLOWED_FILE_TYPE&#x27;</span>] = <span class="string">&#x27;image&#x27;</span></span><br></pre></td></tr></table></figure>

<p>如果你想要自己定义允许的文件类型列表，那么你需要将DROPZONE_ALLOWED_FILE_CUSTOM设置True，然后传入一个包含允许的文件后缀名列表组成的字符串给DROPZONE_ALLOWED_FILE_TYPE变量，使用逗号分隔多个后缀名，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app.config[<span class="string">&#x27;DROPZONE_ALLOWED_FILE_CUSTOM&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">app.config[<span class="string">&#x27;DROPZONE_ALLOWED_FILE_TYPE&#x27;</span>] = <span class="string">&#x27;image/*, .pdf, .txt&#x27;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 上传字段的name值 , 默认file</span></span><br><span class="line">DROPZONE_INPUT_NAME</span><br><span class="line"></span><br><span class="line"><span class="comment"># 一次可以上传的文件数量最大值 , 默认null’</span></span><br><span class="line">DROPZONE_MAX_FILES</span><br><span class="line"></span><br><span class="line"><span class="comment"># 是否在单个请求中发送多个文件，默认一个请求发送一个文件(False)</span></span><br><span class="line">DROPZONE_UPLOAD_MULTIPL</span><br><span class="line"></span><br><span class="line"><span class="comment"># 是否开启CSRF保护 , 默认False</span></span><br><span class="line">DROPZONE_ENABLE_CSRF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传完成后重定向的目标端点</span></span><br><span class="line">DROPZONE REDIRECT VIEW </span><br></pre></td></tr></table></figure>



<h4 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@main_bp.route(<span class="params"><span class="string">&#x27;/upload&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@permission_required(<span class="params"><span class="string">&#x27;UPLOAD&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span>():</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;file&#x27;</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        f = request.files.get(<span class="string">&#x27;file&#x27;</span>)</span><br><span class="line">        filename = rename_image(f.filename)</span><br><span class="line">        f.save(os.path.join(current_app.config[<span class="string">&#x27;ALBUMY_UPLOAD_PATH&#x27;</span>], filename))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;main/upload.html&#x27;</span>)</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;% block styles %&#125;</span><br><span class="line">    &#123;&#123; super() &#125;&#125;</span><br><span class="line">    &lt;link rel=&quot;stylesheet&quot; href=&quot;&#123;&#123; url_for(&#x27;static&#x27;, filename=&#x27;css/dropzone.min.css&#x27;) &#125;&#125;&quot; type=&quot;text/css&quot;&gt;</span><br><span class="line">    &#123;&#123; dropzone.style(&#x27;margin: 20px 0; border: 2px dashed #0087F7; min-height: 400px;&#x27;) &#125;&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    &lt;div class=&quot;row&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;col-md-12&quot;&gt;</span><br><span class="line">            &#123;&#123; dropzone.create(action=&#x27;main.upload&#x27;) &#125;&#125;</span><br><span class="line">            &lt;a class=&quot;btn btn-light float-right&quot; href=&quot;&#123;&#123; url_for(&#x27;user.index&#x27;, username=current_user.username) &#125;&#125;&quot;&gt;</span><br><span class="line">                Done</span><br><span class="line">            &lt;/a&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block scripts %&#125;</span><br><span class="line">    &#123;&#123; super() &#125;&#125;</span><br><span class="line">    &lt;script src=&quot;&#123;&#123; url_for(&#x27;static&#x27;, filename=&#x27;js/dropzone.min.js&#x27;) &#125;&#125;&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &#123;&#123; dropzone.config() &#125;&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Flask-Avatars-处理用户头像"><a href="#Flask-Avatars-处理用户头像" class="headerlink" title="Flask-Avatars 处理用户头像"></a>Flask-Avatars 处理用户头像</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip  install flask-avatars </span><br></pre></td></tr></table></figure>



<h4 id="相关宏-1"><a href="#相关宏-1" class="headerlink" title="相关宏"></a>相关宏</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;# 默认头像 #&#125;</span><br><span class="line">&lt;img src=&quot;&#123;&#123; avatars.default() &#125;&#125;&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;img class=&quot;avatar-xs&quot; src=&quot;&#123;&#123; url_for(&#x27;main.get_avatar&#x27;, filename=current_user.avatar_s) &#125;&#125;&quot;&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@main_bp.route(<span class="params"><span class="string">&#x27;/avatars/&lt;path:filename&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_avatar</span>(<span class="params">filename</span>):</span></span><br><span class="line">    <span class="keyword">return</span> send_from_directory(current_app.config[<span class="string">&#x27;AVATARS_SAVE_PATH&#x27;</span>], filename)</span><br></pre></td></tr></table></figure>



<h3 id="文件删除"><a href="#文件删除" class="headerlink" title="文件删除"></a>文件删除</h3><ul>
<li>按照一般的做法，在数据库中删除某张图片前，首先要在文件系统中删除对应的图片文件，但是有更好的实现方法</li>
<li>为Photo模型<strong>创建一个数据库事件监听函数</strong>。这个监听函数的作用是，当 Photo记录被删除时，自动删除对应的文件。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Photo</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    description = db.Column(db.String(<span class="number">500</span>))</span><br><span class="line">    filename = db.Column(db.String(<span class="number">64</span>))</span><br><span class="line">    filename_s = db.Column(db.String(<span class="number">64</span>))</span><br><span class="line">    filename_m = db.Column(db.String(<span class="number">64</span>))</span><br><span class="line">    </span><br><span class="line"><span class="meta">@db.event.listens_for(<span class="params">Photo, <span class="string">&#x27;after_delete&#x27;</span>, named=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_photos</span>(<span class="params">**kwargs</span>):</span></span><br><span class="line">    target = kwargs[<span class="string">&#x27;target&#x27;</span>]</span><br><span class="line">    <span class="keyword">for</span> filename <span class="keyword">in</span> [target.filename, target.filename_s, target.filename_m]:</span><br><span class="line">        path = os.path.join(current_app.config[<span class="string">&#x27;ALBUMY_UPLOAD_PATH&#x27;</span>], filename)</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(path):  <span class="comment"># not every filename map a unique file</span></span><br><span class="line">            os.remove(path)</span><br></pre></td></tr></table></figure>



<h3 id="当页编辑的最佳实践"><a href="#当页编辑的最佳实践" class="headerlink" title="当页编辑的最佳实践"></a>当页编辑的最佳实践</h3><ul>
<li>比如图片展示列表 , 点击时当页修改<code>图片描述</code></li>
<li>每个项目下面都渲染一个form , 但是form设置为<code>display:none</code> , 点击时show . </li>
<li>注意这个form应该添加一个<code>取消button</code> , 点击这个button时 , 重新让这个form<code>display:none</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=&quot;description-form&quot;&gt;</span><br><span class="line">    &lt;form action=&quot;&#123;&#123; url_for(&#x27;.edit_description&#x27;, photo_id=photo.id) &#125;&#125;&quot; method=&quot;post&quot;&gt;</span><br><span class="line">    &#123;&#123; description_form.csrf_token &#125;&#125;</span><br><span class="line">    &#123;&#123; render_field(description_form.description) &#125;&#125;</span><br><span class="line">    &lt;a class=&quot;btn btn-light btn-sm&quot; id=&quot;cancel-description&quot;&gt;Cancel&lt;/a&gt;</span><br><span class="line">    &#123;&#123; render_field(description_form.submit, class=&#x27;btn btn-success btn-sm&#x27;) &#125;&#125;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    $(&quot;#description-btn&quot;).click(function()&#123;</span><br><span class="line">        $(&quot;#description&quot;).hide();</span><br><span class="line">        $(&quot;#description-form&quot;).show();</span><br><span class="line">    &#125;)</span><br><span class="line">    $(&quot;#cancel-description&quot;).click(function()&#123;</span><br><span class="line">        $(&quot;#description-form&quot;).hide();</span><br><span class="line">        $(&quot;#description&quot;).show();</span><br><span class="line">    &#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>



<h3 id="注册全局Ajax错误"><a href="#注册全局Ajax错误" class="headerlink" title="注册全局Ajax错误"></a>注册全局Ajax错误</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="built_in">document</span>).ajaxError(<span class="function"><span class="keyword">function</span> (<span class="params">event, request, settings</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> message = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (request.responseJSON &amp;&amp; request.responseJSON.hasOwnProperty(<span class="string">&#x27;message&#x27;</span>)) &#123;</span><br><span class="line">        message = request.responseJSON.message;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (request.responseText) &#123;</span><br><span class="line">        <span class="keyword">var</span> IS_JSON = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> data = <span class="built_in">JSON</span>.parse(request.responseText);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            IS_JSON = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (IS_JSON &amp;&amp; data !== <span class="literal">undefined</span> &amp;&amp; data.hasOwnProperty(<span class="string">&#x27;message&#x27;</span>)) &#123;</span><br><span class="line">            message = <span class="built_in">JSON</span>.parse(request.responseText).message;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            message = default_error_message;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        message = default_error_message;</span><br><span class="line">    &#125;</span><br><span class="line">    toast(message, <span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<h3 id="flask-login的fresh-login-required-重新登录"><a href="#flask-login的fresh-login-required-重新登录" class="headerlink" title="flask-login的fresh_login_required : 重新登录"></a>flask-login的fresh_login_required : 重新登录</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_login <span class="keyword">import</span> fresh_login_required, login_fresh</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChangePasswordForm</span>(<span class="params">FlaskForm</span>):</span></span><br><span class="line">    old_password = PasswordField(<span class="string">&#x27;Old Password&#x27;</span>, validators=[DataRequired()])</span><br><span class="line">    password = PasswordField(<span class="string">&#x27;New Password&#x27;</span>, validators=[</span><br><span class="line">        DataRequired(), Length(<span class="number">8</span>, <span class="number">128</span>), EqualTo(<span class="string">&#x27;password2&#x27;</span>)])</span><br><span class="line">    password2 = PasswordField(<span class="string">&#x27;Confirm Password&#x27;</span>, validators=[DataRequired()])</span><br><span class="line">    submit = SubmitField()</span><br><span class="line"></span><br><span class="line"><span class="meta">@user_bp.route(<span class="params"><span class="string">&#x27;/settings/change-password&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@fresh_login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_password</span>():</span></span><br><span class="line">    form = ChangePasswordForm()</span><br><span class="line">    <span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">        <span class="keyword">if</span> current_user.validate_password(form.old_password.data):</span><br><span class="line">            current_user.set_password(form.password.data)</span><br><span class="line">            db.session.commit()</span><br><span class="line">            flash(<span class="string">&#x27;Password updated.&#x27;</span>, <span class="string">&#x27;success&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;.index&#x27;</span>, username=current_user.username))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            flash(<span class="string">&#x27;Old password is incorrect.&#x27;</span>, <span class="string">&#x27;warning&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;user/settings/change_password.html&#x27;</span>, form=form)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>fresh_login _required装饰器 : <strong>确保用户处于“活跃”的认证状态</strong>。</p>
</li>
<li><p>当用户登录账户时用户会话会被标记为“新鲜的（fresh）”，通过使用 session对象写人名为  fresh的 cookie实现。如果用户会话被销毁或过期了，而用户勾选了“记住我”选项。尽管这时用户仍然保持登录状态，但会话已经被标记为“不新鲜”。出于安全考虑，像修改密码这类敏感操作，应该在“新鲜”会话下进行。</p>
</li>
<li><p>编写一个重新验证视图函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@auth_bp.route(<span class="params"><span class="string">&#x27;/re-authenticate&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">re_authenticate</span>():</span></span><br><span class="line">    <span class="keyword">if</span> login_fresh():</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;main.index&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    form = LoginForm()</span><br><span class="line">    <span class="keyword">if</span> form.validate_on_submit() <span class="keyword">and</span> current_user.validate_password(form.password.data):</span><br><span class="line">        confirm_login()</span><br><span class="line">        <span class="keyword">return</span> redirect_back()</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;auth/login.html&#x27;</span>, form=form)</span><br><span class="line"></span><br><span class="line">login_manager.refresh_view =<span class="string">&#x27;auth re_authenticate&#x27;</span></span><br><span class="line">login_manager.needs_refresh_message_category=<span class="string">&#x27;warning&#x27;</span></span><br><span class="line">login_manager.needs_refresh_message=<span class="string">&#x27;为了保护你的账户安全，请重新登录。&#x27;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="subquery-与-in-与-join"><a href="#subquery-与-in-与-join" class="headerlink" title="subquery 与 in_ 与 join"></a>subquery 与 in_ 与 join</h3><p>以前的做法 :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">query = db.session.query(Follow.followed_id).<span class="built_in">filter</span>(Follow.follower_id == current_user.<span class="built_in">id</span>)</span><br><span class="line">followed_list = [f.followed_id <span class="keyword">for</span> f <span class="keyword">in</span> query.<span class="built_in">all</span>()]</span><br><span class="line"></span><br><span class="line">followed_photos = Photo.query.<span class="built_in">filter</span>(Photo.auther_id.in_(followed_list)).order_by(Photo.timestamp.desc()).<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure>

<p>直接使用subquery , 不必将其改成list</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">followed_ids = db.session.query(Follow.followed_id).<span class="built_in">filter</span>(Follow.follower_id == current_user.<span class="built_in">id</span>).subquery()</span><br><span class="line"></span><br><span class="line">followed_photos = Photo.query.<span class="built_in">filter</span>(Photo.auther_id.in_(followed_ids)).order_by(Photo.timestamp.desc()).<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>简单来说 , subquery的作用就是<strong>将query改成table</strong></p>
</blockquote>
<p>实际上 , in_ 操作的性能没有join好 , 最好使用join</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">followed_photos = Photo.query.join(Follow, Follow.followed_id == Photo.author_id).<span class="built_in">filter</span>(Follow.follower_id == self.<span class="built_in">id</span>)</span><br></pre></td></tr></table></figure>



<h3 id="sqlalchemy随机获取内容"><a href="#sqlalchemy随机获取内容" class="headerlink" title="sqlalchemy随机获取内容"></a>sqlalchemy随机获取内容</h3><ul>
<li>SQLALchemy通过 sqlalchemy.sql.expression模块的func属性提供了<strong>泛型函数</strong>（Generic Function）支持，使用这个属性可以调用对应的SQL函数。</li>
<li><code>func.random()</code> : 调用数据库引擎提供的随机函数</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.sql.expression <span class="keyword">import</span> func</span><br><span class="line"></span><br><span class="line">photos = Photo.query.order_by(func.random()).limit(<span class="number">12</span>)</span><br></pre></td></tr></table></figure>



<h3 id="Flask-Whooshee-实现全文搜索"><a href="#Flask-Whooshee-实现全文搜索" class="headerlink" title="Flask Whooshee 实现全文搜索"></a>Flask Whooshee 实现全文搜索</h3><p>全文搜索的原理是索引程序通过扫<strong>描数据库中的每一个词，对每一个词建立一个索引</strong>指明该词在数据库中出现的次数和位置，当用户查询时，检索程序通过索引进行查找，并返回匹配的数据。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip instaoll flask-whooshee</span><br></pre></td></tr></table></figure>



<ul>
<li>Flask-Whooshes默认在项目的根目录下建立名为 whooshes的索引文件夹，你可以通过配置变量 WHOOSHEE_DIR自定义这个位置。</li>
<li>使用 Flask-Whooshee提供的 <code>whooshes.register_model()</code>装饰器，即可对要索引的字段进行注册。</li>
<li>下面我们分别在这三个模型类前附加这个装饰器，传入要被索引的目标字段名称作为参数：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@whooshee.register_model(<span class="params"><span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;username&#x27;</span></span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">db.Model, UserMixin</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    username = db.Column(db.String(<span class="number">20</span>), unique=<span class="literal">True</span>, index=<span class="literal">True</span>)</span><br><span class="line">    password_hash = db.Column(db.String(<span class="number">128</span>))</span><br><span class="line">    name = db.Column(db.String(<span class="number">30</span>))</span><br></pre></td></tr></table></figure>

<blockquote>
<p>默认情况下，Flask-Whooshes在对这几个注册的字段执行写入操作后自动创建并更新索引。在下面这两种情况下，你需要重新生成索引：</p>
<ul>
<li>索引数据丢失，比如误删除索引文件夹；</li>
<li>在新的程序中使用扩展，这时数据库已经包含许多数据。</li>
</ul>
</blockquote>
<p>最后执行reindex方法来重新创建索引：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">flask shell </span><br><span class="line">&gt;&gt;&gt; from album.extensions import whooshee</span><br><span class="line">&gt;&gt;&gt; whooshe.reindex()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>所以我们可以编写一个Celery程序来执行<code>whooshe.reindex()</code></p>
</blockquote>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><ul>
<li>搜索请求通常会通过GET方法发出，这样可以支持用户对搜索URL进行收藏或分享，同时也可以避免浏览器对于POST请求重复提交问题。</li>
<li>Fask-Whooshes覆盖了 SQALchemy的 query对象，为其添加了一个 whooshes_search()查询方法，这个方法接收搜索关键字作为参数，返回包含所有匹配记录的查询对象。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@main_bp.route(<span class="params"><span class="string">&#x27;/search&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">search</span>():</span></span><br><span class="line">    q = request.args.get(<span class="string">&#x27;q&#x27;</span>, <span class="string">&#x27;&#x27;</span>).strip()</span><br><span class="line">    <span class="keyword">if</span> q == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        flash(<span class="string">&#x27;Enter keyword about photo, user or tag.&#x27;</span>, <span class="string">&#x27;warning&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect_back()</span><br><span class="line"></span><br><span class="line">    category = request.args.get(<span class="string">&#x27;category&#x27;</span>, <span class="string">&#x27;photo&#x27;</span>)</span><br><span class="line">    page = request.args.get(<span class="string">&#x27;page&#x27;</span>, <span class="number">1</span>, <span class="built_in">type</span>=<span class="built_in">int</span>)</span><br><span class="line">    per_page = current_app.config[<span class="string">&#x27;ALBUMY_SEARCH_RESULT_PER_PAGE&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> category == <span class="string">&#x27;user&#x27;</span>:</span><br><span class="line">        pagination = User.query.whooshee_search(q).paginate(page, per_page)</span><br><span class="line">    <span class="keyword">elif</span> category == <span class="string">&#x27;tag&#x27;</span>:</span><br><span class="line">        pagination = Tag.query.whooshee_search(q).paginate(page, per_page)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        pagination = Photo.query.whooshee_search(q).paginate(page, per_page)</span><br><span class="line">    results = pagination.items</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;main/search.html&#x27;</span>, q=q, results=results, pagination=pagination, category=category)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;form class=&quot;form-inline my-2 my-lg-0&quot; action=&quot;&#123;&#123; url_for(&#x27;main.search&#x27;) &#125;&#125;&quot;&gt;</span><br><span class="line">    &lt;input type=&quot;text&quot; name=&quot;q&quot; class=&quot;form-control mr-sm-1&quot; placeholder=&quot;Photo, tag or user&quot;</span><br><span class="line">           required&gt;</span><br><span class="line">    &lt;button class=&quot;btn btn-light my-2 my-sm-0&quot; type=&quot;submit&quot;&gt;</span><br><span class="line">        &lt;span class=&quot;oi oi-magnifying-glass&quot;&gt;&lt;/span&gt;</span><br><span class="line">    &lt;/button&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>



<h2 id="第十章-代办事项程序"><a href="#第十章-代办事项程序" class="headerlink" title="第十章 代办事项程序"></a>第十章 代办事项程序</h2><h3 id="单页面应用布局"><a href="#单页面应用布局" class="headerlink" title="单页面应用布局"></a>单页面应用布局</h3><ul>
<li>单页程序，并不意味着我们只能使用一个页面。程序中实际包含三个页面：介绍页、登录页和程序页，这三个页面分别在局部模板 <code>_intro.html</code>、<code>_login.html</code>和 <code>_app.html</code>中定义。</li>
<li>三个模板不会直接加载，而是通过AJAX请求获取并动态插到根页面中。</li>
<li>为了便于在AJAX中发送请求到对应的URL，我们在根页面中定义了多个 JavaScript变量，分别存储指向这三个页面的URL。另外，我们程序中的所有操作都通过 JavaScript发送AJAX请求实现，像登录、注册、注销等这类不包含URL变量的URL，也在这里定义：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#123;# base.html #&#125;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;/&gt;</span><br><span class="line">    &lt;meta charset=&quot;utf-8&quot;/&gt;</span><br><span class="line">    &lt;title&gt;Todoism&lt;/title&gt;</span><br><span class="line">    &lt;link href=&quot;&#123;&#123; url_for(&#x27;static&#x27;, filename=&#x27;css/materialize.min.css&#x27;) &#125;&#125;&quot; rel=&quot;stylesheet&quot;&gt;</span><br><span class="line">    &lt;link href=&quot;&#123;&#123; url_for(&#x27;static&#x27;, filename=&#x27;css/style.css&#x27;) &#125;&#125;&quot; rel=&quot;stylesheet&quot;&gt;</span><br><span class="line">    &lt;link rel=&quot;icon&quot; href=&quot;&#123;&#123; url_for(&#x27;static&#x27;, filename=&#x27;favicon.ico&#x27;) &#125;&#125;&quot; type=&quot;image/x-icon&quot;&gt;</span><br><span class="line">    &lt;link href=&quot;http://fonts.googleapis.com/icon?family=Material+Icons&quot; rel=&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div id=&quot;main&quot;&gt;&lt;/div&gt;</span><br><span class="line">&lt;script src=&quot;&#123;&#123; url_for(&#x27;static&#x27;, filename=&#x27;js/jquery.min.js&#x27;) &#125;&#125;&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src=&quot;&#123;&#123; url_for(&#x27;static&#x27;, filename=&#x27;js/materialize.min.js&#x27;) &#125;&#125;&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src=&quot;&#123;&#123; url_for(&#x27;static&#x27;, filename=&#x27;js/script.js&#x27;) &#125;&#125;&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">    var csrf_token = &quot;&#123;&#123; csrf_token() &#125;&#125;&quot;;</span><br><span class="line">    var login_page_url = &quot;&#123;&#123; url_for(&#x27;auth.login&#x27;) &#125;&#125;&quot;;</span><br><span class="line">    var app_page_url = &quot;&#123;&#123; url_for(&#x27;todo.app&#x27;) &#125;&#125;&quot;;</span><br><span class="line">    var intro_page_url = &quot;&#123;&#123; url_for(&#x27;home.intro&#x27;) &#125;&#125;&quot;;</span><br><span class="line">    var new_item_url = &quot;&#123;&#123; url_for(&#x27;todo.new_item&#x27;) &#125;&#125;&quot;;</span><br><span class="line">    var clear_item_url = &quot;&#123;&#123; url_for(&#x27;todo.clear_items&#x27;) &#125;&#125;&quot;;</span><br><span class="line">    var login_url = &quot;&#123;&#123; url_for(&#x27;auth.login&#x27;) &#125;&#125;&quot;;</span><br><span class="line">    var register_url = &quot;&#123;&#123; url_for(&#x27;auth.register&#x27;) &#125;&#125;&quot;;</span><br><span class="line">    var logout_url = &quot;&#123;&#123; url_for(&#x27;auth.logout&#x27;) &#125;&#125;&quot;;</span><br><span class="line">    var default_error_message = &quot;&#123;&#123; _(&#x27;Oops, something was wrong!&#x27;) &#125;&#125;&quot;;</span><br><span class="line">    var empty_body_error_message = &quot;&#123;&#123; _(&#x27;Your todo was empty!&#x27;) &#125;&#125;&quot;;</span><br><span class="line">    var login_error_message = &quot;&#123;&#123; _(&#x27;Empty username or password!&#x27;) &#125;&#125;&quot;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h4 id="在根页面内切换子页面"><a href="#在根页面内切换子页面" class="headerlink" title="在根页面内切换子页面"></a>在根页面内切换子页面</h4><ul>
<li><p>在单页面应用中 , Flask的视图函数的功能退化为提供数据的内部接口，而真正的视图处理则转移到了客户端JavaScript 中</p>
</li>
<li><p>在单页面中切换子页面时，我们希望这些子页面变化时也产生一个可以被保存为书签并且添加到浏览器历史的URL，而且使浏览器的前进、后退按钮发挥作用。为了让程序的状态在URL中表现出来，我们通过<strong>在URL后面添加hash（即URL中#后面的部分）来记录状态</strong>。程序中的三个主要页面使用对应的hash标签表示，比如导航栏上的登录按钮</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;waves-effect waves-light btn red&quot;</span> <span class="attr">href</span>=<span class="string">&quot;#login&quot;</span>&gt;</span>&#123;&#123; _(&#x27;Login&#x27;) &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>单击这个按钮，会访问#login产生的URL类似<a href="http://example.com/#login">http://example.com#login</a>表示登录页面。</p>
</li>
<li><p>在URL中添加hash不会产生请求，而我们可以<strong>通过监听hash的变化来设置回调函数来更新页面。</strong>我们创建一个<br>hashchange事件的监听函数，用于在hash值改变时执行对应的函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="built_in">window</span>).bind(<span class="string">&#x27;hashchange&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 有些浏览器不返回#，这里统一去掉#</span></span><br><span class="line">    <span class="keyword">var</span> hash = <span class="built_in">window</span>.location.hash.replace(<span class="string">&#x27;#&#x27;</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> url = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// 根据hash值的不同，选择对应的页面URL</span></span><br><span class="line">    <span class="keyword">if</span> (hash === <span class="string">&#x27;login&#x27;</span>) &#123;</span><br><span class="line">        url = login_page_url</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hash === <span class="string">&#x27;app&#x27;</span>) &#123;</span><br><span class="line">        url = app_page_url</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        url = intro_page_url</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 向对应的页面URL发送GET请求，服务器端会返回对应的局部模板</span></span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">        <span class="attr">url</span>: url,</span><br><span class="line">        <span class="attr">success</span>: <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">            $(<span class="string">&#x27;#main&#x27;</span>).hide().html(data).fadeIn(<span class="number">800</span>); <span class="comment">// 插入子页面</span></span><br><span class="line">            activeM(); <span class="comment">// 激活新插入的页面中的 Materia1ize组件</span></span><br><span class="line">        &#125; <span class="comment">// 错误回调已经统一设置，不需要定义 error回调</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">window</span>.location.hash === <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">    <span class="built_in">window</span>.location.hash = <span class="string">&#x27;#intro&#x27;</span>; <span class="comment">// home page, show the default view</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $(<span class="built_in">window</span>).trigger(<span class="string">&#x27;hashchange&#x27;</span>); <span class="comment">// 触发 hashchange事件，重新加载页面</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>所以 , 当我们执行其他操作后需要切换页面时，通过切换URL中的hash（通过 window,locationhash）即可切换页面。比如，当用户单击登录按钮时，如果验证通过，我们在发送AJAX请求的success回调函数中将hash设为对应程序页面的App，就可以切换到App页面：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">seccess: <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">window</span>.location.hash = <span class="string">&quot;#app&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>后端代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@todo_bp.route(<span class="params"><span class="string">&#x27;/items/new&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new_item</span>():</span></span><br><span class="line">    data = request.get_json()</span><br><span class="line">    <span class="keyword">if</span> data <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> data[<span class="string">&#x27;body&#x27;</span>].strip() == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> jsonify(message=_(<span class="string">&#x27;Invalid item body.&#x27;</span>)), <span class="number">400</span></span><br><span class="line">    item = Item(body=data[<span class="string">&#x27;body&#x27;</span>], author=current_user._get_current_object())</span><br><span class="line">    db.session.add(item)</span><br><span class="line">    db.session.commit()</span><br><span class="line">    <span class="keyword">return</span> jsonify(html=render_template(<span class="string">&#x27;_item.html&#x27;</span>, item=item), message=<span class="string">&#x27;+1&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="template的True-False转为true-false"><a href="#template的True-False转为true-false" class="headerlink" title="template的True,False转为true,false"></a>template的True,False转为true,false</h4><p>done属性后使用了 Flask内置的 tojson过滤器，因为 Python中的布尔值和 Javascript 中的布尔值（全小写形式的true和 false）不同，所以需要使用 tojson过滤器将变量值转换为JSON格式。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;row item card-panel hoverable&quot; data-href=&quot;&#123;&#123; url_for(&#x27;.edit_item&#x27;, item_id=item.id) &#125;&#125;&quot;</span><br><span class="line">     data-id=&quot;&#123;&#123; item.id &#125;&#125;&quot; data-body=&quot;&#123;&#123; item.body &#125;&#125;&quot; data-done=&#123;&#123; item.done|tojson &#125;&#125;&gt;</span><br></pre></td></tr></table></figure>



<h3 id="使用-Flask-Babel-支持国际化与本地化"><a href="#使用-Flask-Babel-支持国际化与本地化" class="headerlink" title="使用 Flask-Babel 支持国际化与本地化"></a>使用 Flask-Babel 支持国际化与本地化</h3><ul>
<li>国际化：国际化指设计和修改程序以便<strong>让程序支持多种语言或区域</strong>，而不是固定于某个语言或区域。国际化为本地化做了程序上的准备。</li>
<li>本地化：本地化指为程序添加某些资源（比如翻译文件）以便<strong>支持某个特定的语言或区域</strong>。本地化通常会进行多次，比如要支持10种语言，那么就要进行10次本地化处理。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install flask-babel</span><br></pre></td></tr></table></figure>



<h4 id="区域和语言"><a href="#区域和语言" class="headerlink" title="区域和语言"></a>区域和语言</h4><ul>
<li>我们使用语言代码（language code）和区域代码（locale code）来区分不同的区域和语言。</li>
<li>语言代码 : 我们最常见到的语言代码有zh和en，分别表示中文和英文。为了覆盖这些语言大类下的各种分支，通过添加各种子标签，我们可以更具体地描述某种语言。比如，添加语言的脚本（script）标签，zh-Hans和zh-Hant分别表示简体中文和繁体中文；通过添加国家/地区标签，en-US,en-GB分别表示美国英语和英国英语；类似的，zh-CN、zh-TW和zh-HK则分别表示中国大陆简体中文，中国台湾繁体中文和中国香港繁体中文。</li>
<li>区域代码（locale code）则用来表示某一个区域的语法形式和语言代码类似。比如zh、en等。另外一种常见的形式是附加了国家/地区代码的形式，其使用下划线将语言代码与国家/区域连接起来，比如en_US,zh_CN、zh_TW，另外还有添加语言脚本的形式，比如 zh_hans_cn、zh_hant_TW等</li>
</ul>
<blockquote>
<p>语言代码中添加国家/区域代码时的连接符是连接线，而区域代码使用下划线。</p>
</blockquote>
<h4 id="文本的国际化"><a href="#文本的国际化" class="headerlink" title="文本的国际化"></a>文本的国际化</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">flash(<span class="string">u&quot;文章发表成功&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 替换成</span></span><br><span class="line"><span class="keyword">from</span> flask_babel <span class="keyword">import</span> gettext</span><br><span class="line">flash(gettext(<span class="string">u&quot;文章发表成功&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者使用 _ 代替gettext</span></span><br><span class="line"><span class="keyword">from</span> flask_babel <span class="keyword">import</span> _</span><br><span class="line">flash(_(<span class="string">u&quot;文章发表成功&quot;</span>)) </span><br></pre></td></tr></table></figure>



<p>对于英文等单复数包含单词变化的语言，使用<code>ngettext</code></p>
<p>传入两个字符串，依次为单数形式和复数形式的字符串，其中包含用于区分单复数的变量num，第三个参数则传入代表num数值的变量。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flash(ngettext(<span class="string">u&quot;%(num)s Apple&quot;</span> , <span class="string">u&quot;%(num)s Apples&quot;</span> , num=number_of_apples))</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意 : <code>_</code>只会在请求上下文中执行 , 如果想在请求上下文外执行 , 使用lazy_gettext</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_babel <span class="keyword">import</span> Babel, lazy_gettext <span class="keyword">as</span> _l</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginForm</span>(<span class="params">FlaskForm</span>):</span></span><br><span class="line">    username = StringField(_l(<span class="string">&quot;Username&quot;</span>))</span><br></pre></td></tr></table></figure>
</blockquote>
<p>在模板中使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;h1&gt;Join now&lt;/h1&gt; </span><br><span class="line"></span><br><span class="line">&#123;# 替换成 #&#125;</span><br><span class="line">&lt;h1&gt;&#123;&#123; _(&quot;Join now&quot;) &#125;&#125;&lt;/h1&gt; </span><br><span class="line">&lt;h1&gt;&#123;&#123; _(&quot;Welcome , %(username)s&quot;, username=current_user.username) &#125;&#125;&lt;/h1&gt; </span><br></pre></td></tr></table></figure>



<h3 id="设置子域名"><a href="#设置子域名" class="headerlink" title="设置子域名"></a>设置子域名</h3><p>使用subdomain参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">api_v1 = Blueprint(<span class="string">&#x27;api_v1&#x27;</span>, __name__)</span><br><span class="line"></span><br><span class="line">app.register_blueprint(api_v1, url_prefix=<span class="string">&#x27;/api/v1&#x27;</span>)</span><br><span class="line">app.register_blueprint(api_v1, url_prefix=<span class="string">&#x27;/v1&#x27;</span>, subdomain=<span class="string">&#x27;api&#x27;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>用于注册路由的 routed装饰器也接收 subdomain参数，可以为某个视图定义子域。</p>
</blockquote>
<h3 id="flask-cors-支持跨域资源共享"><a href="#flask-cors-支持跨域资源共享" class="headerlink" title="flask-cors 支持跨域资源共享"></a>flask-cors 支持跨域资源共享</h3><p>同源策略（Same origin policy）: 出于安全考虑，浏览器会限制从脚本内发起的跨域请求。这里的跨域包括不同域名、不同端口、不同HTTP模式（HTTP、Https等）。</p>
<blockquote>
<p>在CORS流行之前，大多数AP都通过支持 JSONP（json with Padding）来支持跨域请求。和 JSONP相比，CORS更加方便灵活，支持更多的跨域请求方法，并且在2014年成为W3C的推荐标准，逐渐开始替代  JSONP。</p>
</blockquote>
<blockquote>
<p>CORS 原理简介: <a target="_blank" rel="noopener" href="https://www.ruanyifeng.com/blog/2016/04/cors.html">https://www.ruanyifeng.com/blog/2016/04/cors.html</a></p>
<ul>
<li>CORS需要浏览器和服务器同时支持。</li>
<li>整个CORS通信过程，都是浏览器自动完成，不需要用户参与。对于开发者来说，CORS通信与同源的AJAX通信没有差别，代码完全一样。浏览器一旦发现AJAX请求跨源，就会<strong>自动添加一些附加的头信息</strong>，有时还会多出一次附加的请求，但用户不会有感觉。</li>
<li>因此，实现CORS通信的关键是服务器。只要服务器实现了CORS接口，就可以跨源通信。</li>
</ul>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install flask-cors</span><br></pre></td></tr></table></figure>

<p>简单使用: </p>
<p>直接注册相关蓝图即可.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint</span><br><span class="line"><span class="keyword">from</span> flask_cors <span class="keyword">import</span> CORS</span><br><span class="line"></span><br><span class="line">api_v1 = Blueprint(<span class="string">&quot;api_v1&quot;</span>,__name__)</span><br><span class="line">CORS(api_v1)</span><br></pre></td></tr></table></figure>

<p>默认情况下，Flask-CORS会为蓝本下的所有路由添加跨域请求支持，并且允许来自任意源的跨域请求。</p>
<h3 id="RESTfull-API"><a href="#RESTfull-API" class="headerlink" title="RESTfull API"></a>RESTfull API</h3><ul>
<li>Resource Representational State Transfer。</li>
<li>这可以理解为“<strong>资源（Resource）在网络中以某种表现形式（Representation）进行状态转移（State Transfer）</strong>”。</li>
</ul>
<h4 id="资源端点与HTTP方法的操作含义"><a href="#资源端点与HTTP方法的操作含义" class="headerlink" title="资源端点与HTTP方法的操作含义"></a>资源端点与HTTP方法的操作含义</h4><ul>
<li>api.example.com/users：所有用户。</li>
<li>api.example.com/users/123/：id为123的用户。</li>
<li>api.example.com/users//123/posts：id为33的用户的所有文章。</li>
<li>api.example.com/posts：所有文章。</li>
<li>api.example.com/posts/23：id为23的文章。</li>
<li>api.example.com/posts/23/comments：id为23的文章的所有评论。</li>
</ul>
<table>
<thead>
<tr>
<th>URL</th>
<th>GET</th>
<th>PUT</th>
<th>PATCH</th>
<th>POST</th>
<th>DELETE</th>
</tr>
</thead>
<tbody><tr>
<td>资源集合<br />比如<a target="_blank" rel="noopener" href="http://api.example.com/posts">http://api.example.com/posts</a></td>
<td>列出集合成员的所有信息</td>
<td>替换整个集合的资源</td>
<td>一般不使用</td>
<td>在集合中创建个新条目，新条目的URL自动生成并包含在响应中返回</td>
<td>删除整个资源</td>
</tr>
<tr>
<td>单个元素<br />比如<a target="_blank" rel="noopener" href="http://api.example.com/posts/123">http://api.example.com/posts/123</a></td>
<td>获取指定资源的详细信息，采用XML或JSON等表现形式</td>
<td>替换指定的集合成员，如果不存在则创建</td>
<td>更新集合成员，仅提供更新的内容</td>
<td>一般不使用</td>
<td>删除指定的集合成员</td>
</tr>
</tbody></table>
<h4 id="MethodView"><a href="#MethodView" class="headerlink" title="MethodView"></a>MethodView</h4><p>类似于Django的Class View</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask.views <span class="keyword">import</span> MethodView</span><br><span class="line"></span><br><span class="line">api_v1 = Blueprint(<span class="string">&#x27;api_v1&#x27;</span>, __name__)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">auth_required</span>(<span class="params">f</span>):</span></span><br><span class="line"><span class="meta">    @wraps(<span class="params">f</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorated</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">        token_type, token = get_token()</span><br><span class="line">        <span class="keyword">if</span> request.method != <span class="string">&#x27;OPTIONS&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span> token_type <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> token_type.lower() != <span class="string">&#x27;bearer&#x27;</span>:</span><br><span class="line">                <span class="keyword">return</span> api_abort(<span class="number">400</span>, <span class="string">&#x27;The token type must be bearer.&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> token <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">return</span> token_missing()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> validate_token(token):</span><br><span class="line">                <span class="keyword">return</span> invalid_token()</span><br><span class="line">        <span class="keyword">return</span> f(*args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> decorated</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ItemAPI</span>(<span class="params">MethodView</span>):</span></span><br><span class="line">    decorators = [auth_required]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, item_id</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get item.&quot;&quot;&quot;</span></span><br><span class="line">        item = Item.query.get_or_404(item_id)</span><br><span class="line">        <span class="keyword">if</span> g.current_user != item.author:</span><br><span class="line">            <span class="keyword">return</span> api_abort(<span class="number">403</span>)</span><br><span class="line">        <span class="keyword">return</span> jsonify(item_schema(item))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span>(<span class="params">self, item_id</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Edit item.&quot;&quot;&quot;</span></span><br><span class="line">        item = Item.query.get_or_404(item_id)</span><br><span class="line">        <span class="keyword">if</span> g.current_user != item.author:</span><br><span class="line">            <span class="keyword">return</span> api_abort(<span class="number">403</span>)</span><br><span class="line">        item.body = get_item_body()</span><br><span class="line">        db.session.commit()</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>, <span class="number">204</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">patch</span>(<span class="params">self, item_id</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Toggle item.&quot;&quot;&quot;</span></span><br><span class="line">        item = Item.query.get_or_404(item_id)</span><br><span class="line">        <span class="keyword">if</span> g.current_user != item.author:</span><br><span class="line">            <span class="keyword">return</span> api_abort(<span class="number">403</span>)</span><br><span class="line">        item.done = <span class="keyword">not</span> item.done</span><br><span class="line">        db.session.commit()</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>, <span class="number">204</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">self, item_id</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Delete item.&quot;&quot;&quot;</span></span><br><span class="line">        item = Item.query.get_or_404(item_id)</span><br><span class="line">        <span class="keyword">if</span> g.current_user != item.author:</span><br><span class="line">            <span class="keyword">return</span> api_abort(<span class="number">403</span>)</span><br><span class="line">        db.session.delete(item)</span><br><span class="line">        db.session.commit()</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>, <span class="number">204</span></span><br><span class="line">    </span><br><span class="line">api_v1.add_url_rule(<span class="string">&#x27;/user/items&#x27;</span>, view_func=ItemsAPI.as_view(<span class="string">&#x27;items&#x27;</span>), methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>])</span><br></pre></td></tr></table></figure>



<h4 id="API的-OAuth-认证-及第三方认证登录"><a href="#API的-OAuth-认证-及第三方认证登录" class="headerlink" title="API的 OAuth 认证 及第三方认证登录"></a>API的 OAuth 认证 及第三方认证登录</h4><p>用户通过一次认证后，在服务器端为用户生成一个认证令牌，在之后的请求中，客户端可以通过认证令牌进行认证。出于安全的考虑，认证令牌还会设置过期时间。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itsdangerous <span class="keyword">import</span> TimedJSONWebSignatureSerializer <span class="keyword">as</span> Serializer, BadSignature, SignatureExpired</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_token</span>(<span class="params">user</span>):</span></span><br><span class="line">    expiration = <span class="number">3600</span></span><br><span class="line">    s = Serializer(current_app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>], expires_in=expiration)</span><br><span class="line">    token = s.dumps(&#123;<span class="string">&#x27;id&#x27;</span>: user.<span class="built_in">id</span>&#125;).decode(<span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> token, expiration</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthTokenAPI</span>(<span class="params">MethodView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self</span>):</span></span><br><span class="line">        grant_type = request.form.get(<span class="string">&#x27;grant_type&#x27;</span>)</span><br><span class="line">        username = request.form.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password = request.form.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> grant_type <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> grant_type.lower() != <span class="string">&#x27;password&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> api_abort(code=<span class="number">400</span>, message=<span class="string">&#x27;The grant type must be password.&#x27;</span>)</span><br><span class="line">        user = User.query.filter_by(username=username).first()</span><br><span class="line">        <span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="keyword">not</span> user.validate_password(password):</span><br><span class="line">            <span class="keyword">return</span> api_abort(code=<span class="number">400</span>, message=<span class="string">&#x27;Either the username or password was invalid.&#x27;</span>)</span><br><span class="line">        token, expiration = generate_token(user)</span><br><span class="line">        response = jsonify(&#123;</span><br><span class="line">            <span class="string">&#x27;access_token&#x27;</span>: token,</span><br><span class="line">            <span class="string">&#x27;token_type&#x27;</span>: <span class="string">&#x27;Bearer&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;expires_in&#x27;</span>: expiration</span><br><span class="line">        &#125;)</span><br><span class="line">        response.headers[<span class="string">&#x27;Cache-Control&#x27;</span>] = <span class="string">&#x27;no-store&#x27;</span></span><br><span class="line">        response.headers[<span class="string">&#x27;Pragma&#x27;</span>] = <span class="string">&#x27;no-cache&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>

<p>请求参数一般有4个:</p>
<ul>
<li>grant_ type</li>
<li>username</li>
<li>password</li>
<li>scope : 允许的权限范围（可选）</li>
</ul>
<p>返回的token_type : access令牌是客户端用于访问受登录保护时的认证凭证，令牌类型中的“Bearer”是RFC6750定义的令牌类型（常被翻译为不记名令牌）。</p>
<p>之后我们就可以使用View的装饰器了:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_token</span>():</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;Authorization&#x27;</span> <span class="keyword">in</span> request.headers:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            token_type, token = request.headers[<span class="string">&#x27;Authorization&#x27;</span>].split(<span class="literal">None</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">except</span> ValueError:</span><br><span class="line">            token_type = token = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        token_type = token = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> token_type, token</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">api_abort</span>(<span class="params">code, message=<span class="literal">None</span>, **kwargs</span>):</span></span><br><span class="line">    <span class="keyword">if</span> message <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        message = HTTP_STATUS_CODES.get(code, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    response = jsonify(code=code, message=message, **kwargs)</span><br><span class="line">    response.status_code = code</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">invalid_token</span>():</span></span><br><span class="line">    response = api_abort(<span class="number">401</span>, error=<span class="string">&#x27;invalid_token&#x27;</span>, error_description=<span class="string">&#x27;Either the token was expired or invalid.&#x27;</span>)</span><br><span class="line">    response.headers[<span class="string">&#x27;WWW-Authenticate&#x27;</span>] = <span class="string">&#x27;Bearer&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">token_missing</span>():</span></span><br><span class="line">    response = api_abort(<span class="number">401</span>)</span><br><span class="line">    response.headers[<span class="string">&#x27;WWW-Authenticate&#x27;</span>] = <span class="string">&#x27;Bearer&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">auth_required</span>(<span class="params">f</span>):</span></span><br><span class="line"><span class="meta">    @wraps(<span class="params">f</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorated</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">        token_type, token = get_token()</span><br><span class="line">        <span class="comment"># Flask通常单独处理OPTIONS请求，但在配置为将这些请求转发给应用程序的情况下，我们需要忽略身份验证头并让请求通过，以避免与CORS发生不必要的交互。</span></span><br><span class="line">        <span class="keyword">if</span> request.method != <span class="string">&#x27;OPTIONS&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span> token_type <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> token_type.lower() != <span class="string">&#x27;bearer&#x27;</span>:</span><br><span class="line">                <span class="keyword">return</span> api_abort(<span class="number">400</span>, <span class="string">&#x27;The token type must be bearer.&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> token <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">return</span> token_missing()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> validate_token(token):</span><br><span class="line">                <span class="keyword">return</span> invalid_token()</span><br><span class="line">        <span class="keyword">return</span> f(*args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> decorated</span><br></pre></td></tr></table></figure>

<p>发送请求时需要把认证令牌附加在请求首部的 Authorization字段中，并且在令牌前指定令牌类型（即Bearer）</p>
<h3 id="Web-API的序列化与反序列化"><a href="#Web-API的序列化与反序列化" class="headerlink" title="Web API的序列化与反序列化"></a>Web API的序列化与反序列化</h3><p>对于Web API来说，</p>
<ul>
<li>序列化（Serialize）就是把数据库模型对象转换成JSON数据。</li>
<li>反序列化（Deserialize）就是把JSON数据转换成数据库模型对象。</li>
</ul>
<h4 id="JSON数据风格指南摘要"><a href="#JSON数据风格指南摘要" class="headerlink" title="JSON数据风格指南摘要"></a>JSON数据风格指南摘要</h4><p><a target="_blank" rel="noopener" href="https://github.com/darcyliu/google-styleguide/blob/master/JSONStyleGuide.md">https://github.com/darcyliu/google-styleguide/blob/master/JSONStyleGuide.md</a></p>
<ul>
<li><p>数组类型应该是复数属性名。其它属性名都应该是单数。</p>
</li>
<li><p>日期应该使用RFC3339建议的格式 , 时间间隔应该使用ISO 8601建议的格式</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;lastUpdate&quot;</span>: <span class="string">&quot;2007-11-06T16:34:41.000Z&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;duration&quot;</span>: <span class="string">&quot;P3Y6M4DT12H30M5S&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Marshmallow-与-Webargs"><a href="#Marshmallow-与-Webargs" class="headerlink" title="Marshmallow 与 Webargs"></a>Marshmallow 与 Webargs</h3><ul>
<li>Marshmallow的用法和 WTForms类似，通过创建模式类事先定义好字段类型以及验证函数。</li>
<li>对模式类对象调用dump()方法和 load方法分别执行序列化和反序列化操作，同时对传入的对象进行验证，并返回验证后的数据字典和相应的错误消息字典。</li>
<li>Webargs可以解析请求中包含的表单、查询字符串、JSON、cookies、files、首部字段等系列数据，然后根据预定的样式进行验证，如果验证未通过会生成内置的错误消息。</li>
</ul>
<p>webargs文档 : <a target="_blank" rel="noopener" href="https://webargs.readthedocs.io/en/latest/">https://webargs.readthedocs.io/en/latest/</a></p>
<ul>
<li>默认情况下，webargs将以JSON形式从请求正文中搜索参数。</li>
<li>你也可以在 use_args裝饰器中使用 location参数显式指定一个数据位置，可用的值为 :<ul>
<li>querystring（等同于query，表示查询字符串）、</li>
<li>json（表示JSON）、</li>
<li>form（表示表单数据）、</li>
<li>headers（表示首部字段）、</li>
<li>cookies（表示Cookie）</li>
<li>files（表示文件）。</li>
</ul>
</li>
</ul>
<h4 id="webargs的422错误"><a href="#webargs的422错误" class="headerlink" title="webargs的422错误"></a>webargs的422错误</h4><p>当验证出错时，Webargs会返回422响应（Unprocessable  Entity，表示实体无法处理，即语义错误），我们可以注册一个对应的错误处理函数，如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.errorhandler(<span class="params"><span class="number">422</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_validation_error</span>(<span class="params">e</span>):</span></span><br><span class="line">    exc = e.exc</span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;errors&#x27;</span>:exc.messages&#125;) , <span class="number">422</span></span><br></pre></td></tr></table></figure>

<h4 id="webargs解析字段一览"><a href="#webargs解析字段一览" class="headerlink" title="webargs解析字段一览"></a>webargs解析字段一览</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> webargs <span class="keyword">import</span> fields, validate</span><br><span class="line"></span><br><span class="line">user_args = &#123;</span><br><span class="line">    <span class="comment"># Required arguments</span></span><br><span class="line">    <span class="string">&quot;username&quot;</span>: fields.Str(required=<span class="literal">True</span>),</span><br><span class="line">    <span class="comment"># Validation</span></span><br><span class="line">    <span class="string">&quot;password&quot;</span>: fields.Str(validate=<span class="keyword">lambda</span> p: <span class="built_in">len</span>(p) &gt;= <span class="number">6</span>),</span><br><span class="line">    <span class="comment"># OR use marshmallow&#x27;s built-in validators</span></span><br><span class="line">    <span class="string">&quot;password&quot;</span>: fields.Str(validate=validate.Length(<span class="built_in">min</span>=<span class="number">6</span>)),</span><br><span class="line">    <span class="comment"># Default value when argument is missing</span></span><br><span class="line">    <span class="string">&quot;display_per_page&quot;</span>: fields.Int(missing=<span class="number">10</span>),</span><br><span class="line">    <span class="comment"># Repeated parameter, e.g. &quot;/?nickname=Fred&amp;nickname=Freddie&quot;(重复字段)</span></span><br><span class="line">    <span class="string">&quot;nickname&quot;</span>: fields.<span class="type">List</span>(fields.Str()),</span><br><span class="line">    <span class="comment"># Delimited list, e.g. &quot;/?languages=python,javascript&quot;(带括号字段)</span></span><br><span class="line">    <span class="string">&quot;languages&quot;</span>: fields.DelimitedList(fields.Str()),</span><br><span class="line">    <span class="comment"># When value is keyed on a variable-unsafe name</span></span><br><span class="line">    <span class="comment"># or you want to rename a key(重命名字段)</span></span><br><span class="line">    <span class="string">&quot;user_type&quot;</span>: fields.Str(load_from=<span class="string">&quot;user-type&quot;</span>),</span><br><span class="line">    <span class="comment"># OR, on marshmallow 3</span></span><br><span class="line">    <span class="comment"># &quot;user_type&quot;: fields.Str(data_key=&quot;user-type&quot;),</span></span><br><span class="line">    <span class="comment"># 嵌套字段</span></span><br><span class="line">    <span class="string">&quot;name&quot;</span>: fields.Nested(</span><br><span class="line">        &#123;<span class="string">&quot;first&quot;</span>: fields.Str(required=<span class="literal">True</span>), <span class="string">&quot;last&quot;</span>: fields.Str(required=<span class="literal">True</span>)&#125;</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="webargs配合marshmallow"><a href="#webargs配合marshmallow" class="headerlink" title="webargs配合marshmallow"></a>webargs配合marshmallow</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> marshmallow <span class="keyword">import</span> Schema, fields</span><br><span class="line"><span class="keyword">from</span> webargs.flaskparser <span class="keyword">import</span> use_args</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSchema</span>(<span class="params">Schema</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = fields.Int(dump_only=<span class="literal">True</span>)  <span class="comment"># read-only (won&#x27;t be parsed by webargs)</span></span><br><span class="line">    username = fields.Str(required=<span class="literal">True</span>)</span><br><span class="line">    password = fields.Str(load_only=<span class="literal">True</span>)  <span class="comment"># write-only</span></span><br><span class="line">    first_name = fields.Str(missing=<span class="string">&quot;&quot;</span>)</span><br><span class="line">    last_name = fields.Str(missing=<span class="string">&quot;&quot;</span>)</span><br><span class="line">    date_registered = fields.DateTime(dump_only=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@use_args(<span class="params">UserSchema(<span class="params"></span>)</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">profile_view</span>(<span class="params">args</span>):</span></span><br><span class="line">    username = args[<span class="string">&quot;userame&quot;</span>]</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@use_kwargs(<span class="params">UserSchema(<span class="params"></span>)</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">profile_update</span>(<span class="params">username, password, first_name, last_name</span>):</span></span><br><span class="line">    update_profile(username, password, first_name, last_name)</span><br><span class="line">    <span class="comment"># ...</span></span><br></pre></td></tr></table></figure>


<h4 id="webargs多字段位置"><a href="#webargs多字段位置" class="headerlink" title="webargs多字段位置"></a>webargs多字段位置</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># webargs 5.x and older</span></span><br><span class="line"><span class="meta">@parser.use_args(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="meta">    &#123;</span></span></span><br><span class="line"><span class="params"><span class="meta">        <span class="string">&quot;q1&quot;</span>: ma.fields.Int(<span class="params">location=<span class="string">&quot;query&quot;</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">        <span class="string">&quot;q2&quot;</span>: ma.fields.Int(<span class="params">location=<span class="string">&quot;query&quot;</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">        <span class="string">&quot;h1&quot;</span>: ma.fields.Int(<span class="params">location=<span class="string">&quot;headers&quot;</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    &#125;,</span></span></span><br><span class="line"><span class="params"><span class="meta">    locations=(<span class="params"><span class="string">&quot;query&quot;</span>, <span class="string">&quot;headers&quot;</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta"></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span>(<span class="params">q1, q2, h1</span>):</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># webargs 6.x</span></span><br><span class="line"><span class="meta">@parser.use_args(<span class="params">&#123;<span class="string">&quot;q1&quot;</span>: ma.fields.Int(<span class="params"></span>), <span class="string">&quot;q2&quot;</span>: ma.fields.Int(<span class="params"></span>)&#125;, location=<span class="string">&quot;query&quot;</span></span>)</span></span><br><span class="line"><span class="meta">@parser.use_args(<span class="params">&#123;<span class="string">&quot;h1&quot;</span>: ma.fields.Int(<span class="params"></span>)&#125;, location=<span class="string">&quot;headers&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span>(<span class="params">q1, q2, h1</span>):</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>



<h2 id="第十一章-在线聊天室"><a href="#第十一章-在线聊天室" class="headerlink" title="第十一章 在线聊天室"></a>第十一章 在线聊天室</h2><h3 id="使用-Flask-SocketIO-建立实时双向通信"><a href="#使用-Flask-SocketIO-建立实时双向通信" class="headerlink" title="使用 Flask-SocketIO 建立实时双向通信"></a>使用 Flask-SocketIO 建立实时双向通信</h3><ul>
<li>Socket.IO（<a target="_blank" rel="noopener" href="http://socket.io)是一个基于/">http://socket.io）是一个基于</a> Web Socket实现实时通信的开源 JavaScript库，它可以简化实时web程序（real-time application,RTA）的开发过程。</li>
<li>它除了支持 Web Socket之外，还支持许多种轮询（Polling）机制以及其他模拟实时通信的方式。</li>
<li>SocketIO会根据浏览器对通信机制的支持情况自动选择最佳的方式来实现实时通信，实现了对浏览器的“降级支持”。</li>
<li>SocketIO为这些通信方式实现了统一的接口，因此使用起来非常简单。除此之外，SocketIO还提供了诸如广播、命名空间、房间、存储客户端数据、异步IO等非常方便的功能。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install flask-socketio</span><br><span class="line">pip install eventlet</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_socketio <span class="keyword">import</span> SocketIO</span><br><span class="line"></span><br><span class="line">socketio = SockerIO()</span><br><span class="line">socketio.init_app(app)</span><br></pre></td></tr></table></figure>



<h4 id="启动Socket-IO服务器"><a href="#启动Socket-IO服务器" class="headerlink" title="启动Socket.IO服务器"></a>启动Socket.IO服务器</h4><ul>
<li><p>为了正确启动 Socket.IO服务器，Flask-Socket覆写了 Flask提供的 flask run命令，我们可以像往常一样使用 flask run命令启动 SocketIO服务器</p>
</li>
<li><p>另外，我们也可以直接调用 socketio对象提供的run方法来启动服务器，传入程序实例app作为参数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_sockerio <span class="keyword">import</span> SocketIO</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="string">&#x27;serect string&#x27;</span></span><br><span class="line">socketio = SocketIO(app)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    socketio.run(app)</span><br></pre></td></tr></table></figure></li>
<li><p>在客户端，我们需要加载 Socket.IO资源并调用io()方法与我们在服务器端运行的 SocketIO服务器建立连接。首先我们需要加载对应的资源文件，你可以访问<a target="_blank" rel="noopener" href="https://cdnjs.com/libraries/socket.io%E5%B0%86%E8%B5%84%E6%BA%90%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E5%88%B0%E6%9C%AC%E5%9C%B0">https://cdnjs.com/libraries/socket.io将资源文件下载到本地</a> , 之后就可以使用io()了</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> socket = io(); </span></span><br><span class="line"><span class="javascript">    <span class="comment">// 如果不传入任何参数，会默认使用服务器的根URL，</span></span></span><br><span class="line"><span class="javascript">    <span class="comment">// 等价于下面</span></span></span><br><span class="line"><span class="javascript">    <span class="comment">// var socket = io(&#x27;/&#x27;);</span></span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="SocketIO事件"><a href="#SocketIO事件" class="headerlink" title="SocketIO事件"></a>SocketIO事件</h4><p>消息流程</p>
<ol>
<li>用户发送消息请求到服务器端。</li>
<li>服务器端接收消息请求并把消息广播给所有客户端。</li>
<li>所有客户端接收消息并显示。</li>
</ol>
<ul>
<li>在 SocketIO中，服务器端和客户端之间交流的数据被称为 <code>SocketIO事件</code>（event），这里的事件就是包含特定信息的数据，类似我们常说的请求/响应</li>
<li>简单来说，在 Socket.IO中，双向通信是这样实现的：<ol>
<li>客户端通过调用emit函数来将一个事件发送到服务器端，并传入数据作为参数，这会触发服务器端创建对应的事件处理函数。</li>
<li>而服务器端也可以通过调用 emit函数向客户端发送事件，并传人数据作为参数，类似地，这会触发客户端创建对应的事件处理函数。</li>
</ol>
</li>
</ul>
<h4 id="简单示例-1"><a href="#简单示例-1" class="headerlink" title="简单示例"></a>简单示例</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">rows</span>=<span class="string">&quot;2&quot;</span> <span class="attr">id</span>=<span class="string">&quot;message-textarea&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;Write your message here... Enter to send&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;&#123;&#123; url_for(&#x27;static&#x27;, filename=&#x27;js/jquery.min.js&#x27;) &#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;&#123;&#123; url_for(&#x27;static&#x27;, filename=&#x27;js/socket.io.min.js&#x27;) &#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> socket = io();</span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> ENTER_KEY = <span class="number">13</span> ;</span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">new_message</span>(<span class="params">e</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> $textarea = $(<span class="string">&#x27;#message-textarea&#x27;</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> message_body = $textarea.val().trim();</span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (e.which === ENTER_KEY &amp;&amp; !e.shiftKey &amp;&amp; message_body) &#123;</span></span><br><span class="line"><span class="javascript">            e.preventDefault();</span></span><br><span class="line"><span class="javascript">            socket.emit(<span class="string">&#x27;new message&#x27;</span>, message_body);</span></span><br><span class="line"><span class="javascript">            $textarea.val(<span class="string">&#x27;&#x27;</span>)</span></span><br><span class="line"><span class="javascript">        &#125;</span></span><br><span class="line"><span class="javascript">    &#125;</span></span><br><span class="line"><span class="javascript">    $(<span class="string">&#x27;#message-textarea&#x27;</span>).on(<span class="string">&#x27;keydown&#x27;</span>, new_message.bind(<span class="built_in">this</span>));</span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">    <span class="comment">// 接收</span></span></span><br><span class="line"><span class="javascript">    socket.on(<span class="string">&#x27;new message&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        $(<span class="string">&#x27;.messages&#x27;</span>).append(data.message_html);</span></span><br><span class="line"><span class="javascript">    &#125;);</span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Fask-SocketIo提供on()装饰器来注册用于接收客户端发来事件的事件处理函数。</li>
<li>创建<code>new message</code>事件处理函数，用来处理客户端发送的new message事件</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> catchat.extensions <span class="keyword">import</span> socketio, db</span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">&#x27;new message&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new_message</span>(<span class="params">message_body</span>):</span></span><br><span class="line">    sid = request.sid  <span class="comment"># io客户端的sid, socketio用此唯一标识客户端.</span></span><br><span class="line">    html_message = to_html(message_body)</span><br><span class="line">    message = Message(author=current_user._get_current_object(), body=html_message)</span><br><span class="line">    db.session.add(message)</span><br><span class="line">    db.session.commit()</span><br><span class="line">    emit(<span class="string">&#x27;new message&#x27;</span>,</span><br><span class="line">         &#123;<span class="string">&#x27;message_html&#x27;</span>: render_template(<span class="string">&#x27;chat/_message.html&#x27;</span>, message=message),</span><br><span class="line">          <span class="string">&#x27;message_body&#x27;</span>: html_message,</span><br><span class="line">          <span class="string">&#x27;gravatar&#x27;</span>: current_user.gravatar,</span><br><span class="line">          <span class="string">&#x27;nickname&#x27;</span>: current_user.nickname,</span><br><span class="line">          <span class="string">&#x27;user_id&#x27;</span>: current_user.<span class="built_in">id</span>&#125;,</span><br><span class="line">         broadcast=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>在emit()函数中，<ol>
<li>第一个参数用来指定<strong>事件名称</strong>，当服务器端的 emit函数被调用时，会触发已连接客户端中对应的事件处理函数。</li>
<li>第二个参数是我们要发送的数据，要发送的数据根据客户端的需要而定，这里我们使用 render<br>template函数渲染存储单个消息HTML代码的message。html模板，在客户端使用 JavaScript可以直接将这个数据插入到消息列表的HTML元素中。事件中包含的数据类型可以为字符串、列表或字典。当数据的类型为列表或字典时，会被序列化为JSON格式。</li>
<li>因为我们要把消息发送给所有已经连接的客户端，所以需要将broadcast参数设为True，这样就会广播这个事件，即将事件发送给所有已连接的客户端。</li>
</ol>
</li>
</ul>
<h4 id="储存global数据"><a href="#储存global数据" class="headerlink" title="储存global数据"></a>储存global数据</h4><p>如果不存入redis的话 , 使用global关键字</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">&#x27;connect&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">connect</span>():</span></span><br><span class="line">    <span class="keyword">global</span> online_users</span><br><span class="line">    <span class="keyword">if</span> current_user.is_authenticated <span class="keyword">and</span> current_user.<span class="built_in">id</span> <span class="keyword">not</span> <span class="keyword">in</span> online_users:</span><br><span class="line">        online_users.append(current_user.<span class="built_in">id</span>)</span><br><span class="line">    emit(<span class="string">&#x27;user count&#x27;</span>, &#123;<span class="string">&#x27;count&#x27;</span>: <span class="built_in">len</span>(online_users)&#125;, broadcast=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">&#x27;disconnect&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">disconnect</span>():</span></span><br><span class="line">    <span class="keyword">global</span> online_users</span><br><span class="line">    <span class="keyword">if</span> current_user.is_authenticated <span class="keyword">and</span> current_user.<span class="built_in">id</span> <span class="keyword">in</span> online_users:</span><br><span class="line">        online_users.remove(current_user.<span class="built_in">id</span>)</span><br><span class="line">    emit(<span class="string">&#x27;user count&#x27;</span>, &#123;<span class="string">&#x27;count&#x27;</span>: <span class="built_in">len</span>(online_users)&#125;, broadcast=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">socket.on(<span class="string">&#x27;user count&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">    $(<span class="string">&#x27;#user-count&#x27;</span>).html(data.count);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>connect连接事件处理程序可以选择返回<code>False</code>以拒绝连接。</strong>这样就可以在此时对客户端进行身份验证。</p>
<h4 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@socketio.on_error()        </span><span class="comment"># Handles the default namespace</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">error_handler</span>(<span class="params">e</span>):</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on_error(<span class="params"><span class="string">&#x27;/chat&#x27;</span></span>) </span><span class="comment"># handles the &#x27;/chat&#x27; namespace</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">error_handler_chat</span>(<span class="params">e</span>):</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on_error_default  </span><span class="comment"># handles all namespaces without an explicit error handler</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">default_error_handler</span>(<span class="params">e</span>):</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>



<h4 id="gunicorn配置"><a href="#gunicorn配置" class="headerlink" title="gunicorn配置"></a>gunicorn配置</h4><p>通过gunicorn启动eventlet服务器的命令行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gunicorn --worker-class eventlet -w 1 module:app</span><br></pre></td></tr></table></figure>

<p>使用gevent，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gunicorn -k gevent -w 1 module:app</span><br></pre></td></tr></table></figure>



<h3 id="Socket-io通信频道分离"><a href="#Socket-io通信频道分离" class="headerlink" title="Socket.io通信频道分离"></a>Socket.io通信频道分离</h3><h4 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h4><ul>
<li>简单地说，不同的命名空间就是不同的URL路径，比如/foo和/bar就是两个不同的命名空间。</li>
<li>可以把 SocketIo中的命名空间比作 Flask中的蓝本</li>
<li>可以通过<code>request.namesapce</code>获取</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">&#x27;my event&#x27;</span>,namespace=<span class="string">&#x27;/chat&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_my_custom_event</span>(<span class="params">json</span>):</span></span><br><span class="line">    emit(<span class="string">&#x27;my response&#x27;</span>, json, namespace=<span class="string">&#x27;/chat&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> socket = io.connect(<span class="string">&#x27;/anoymous&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h4 id="房间"><a href="#房间" class="headerlink" title="房间"></a>房间</h4><ul>
<li>对于许多应用程序，有必要将用户分组为可以一起寻址的子集。</li>
<li>最好的例子是具有多个房间的聊天应用程序，其中用户从他们所在的房间或房间接收消息，而不是从其他用户所在的其他房间接收消息。</li>
<li>SocketIO支持通过房间的概念<code>join_room()</code>和<code>leave_room()</code>功能：这两个函数分别用来把当前用户（客户端）加入和退出房间。你还可以使用 <code>close room</code>函数来删除个房间，并清空其中的用户。另外，rooms函数可以返回某个房间内的客户端列表。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_socketio <span class="keyword">import</span> join_room, leave_room</span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">&#x27;join&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_join</span>(<span class="params">data</span>):</span></span><br><span class="line">    username = data[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">    room = data[<span class="string">&#x27;room&#x27;</span>]</span><br><span class="line">    <span class="comment">## 传入房间的唯一标识</span></span><br><span class="line">    join_room(room)</span><br><span class="line">    send(username + <span class="string">&#x27; has entered the room.&#x27;</span>, room=room)</span><br><span class="line"></span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">&#x27;leave&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_leave</span>(<span class="params">data</span>):</span></span><br><span class="line">    username = data[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">    room = data[<span class="string">&#x27;room&#x27;</span>]</span><br><span class="line">    leave_room(room)</span><br><span class="line">    send(username + <span class="string">&#x27; has left the room.&#x27;</span>, room=room)</span><br><span class="line">    </span><br><span class="line"><span class="meta">@socketio.on(<span class="params"><span class="string">&#x27;room message&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new_room_message</span>(<span class="params">message_body</span>):</span></span><br><span class="line">    username = data[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">    room = data[<span class="string">&#x27;room&#x27;</span>]</span><br><span class="line">    <span class="comment">## 传入房间的唯一标识</span></span><br><span class="line">    join_room(room)</span><br><span class="line">    emit(<span class="string">&#x27;message&#x27;</span>, &#123;<span class="string">&#x27;message&#x27;</span>:current_user.username+<span class="string">&quot;:&quot;</span>+message_body&#125;, room=<span class="string">&#x27;current_user.room&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>基于房间你也可以实现私信私聊功能。只需要把room设为代表某个用户的唯一值，在发送事件时，就只有目标用户的客户端才能接收到事件。你可以把这种实现方法理解为“一个人的房间”。这个能代表用户的唯一值可以是主键值、username或是 Flask-SocketIo附加到 request对象上代表每个客户端id的 session id（request.sid）。</p>
<h3 id="使用-Flask-OAuthlib-实现第三方登录"><a href="#使用-Flask-OAuthlib-实现第三方登录" class="headerlink" title="使用 Flask-OAuthlib 实现第三方登录"></a>使用 Flask-OAuthlib 实现第三方登录</h3><p>第三方登录的实质是借助第三方服务开放的 Web APl进行 OAuth授权。授权成功后，我们就可以通过第三方服务的 Web api获取到用户的资料以及其他资源。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install flask-oauthlib</span><br></pre></td></tr></table></figure>

<p>在 OAuth认证中 : </p>
<ul>
<li>需要获取和使用资源的一方，即我们的程序，通常被称为资源消费者（Resource Consumer）或<code>客户端</code>（Client）。</li>
<li>拥有用户资源的各种在线服务提供方则被称为<code>资源提供者</code>（Resource provider）。</li>
<li>用户被称为资源拥有者（Resource Owner）。</li>
</ul>
<h4 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h4><p>流程:</p>
<ol>
<li>用户点击登录 , 调用oauth_login视图 , 该视图重定向到第三方登录页面</li>
<li>用户键入 , 点击登录 , 第三方应用会将用户重定向到我们注册 OAuth程序时提供的回调URL(例如<a target="_blank" rel="noopener" href="http://127.0.0.1/callback/github">http://127.0.0.1/callback/github</a>) , 并且返回access</li>
<li>视图接收到这个回调请求，获取code，发送一个POST请求到用于获取access 令牌的URL，进行验证 .</li>
<li>验证成功则说明登录成功</li>
</ol>
<p>在 OAuth认证中，</p>
<ul>
<li>我们开发的程序也被称为本地程序（local application），</li>
<li>我们要与之交互的第三方服务提供方则相应被称为远程程序（remote application）。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;ui message&quot;&gt;</span><br><span class="line">    &lt;a class=&quot;icon&quot; href=&quot;&#123;&#123; url_for(&#x27;oauth.oauth_login&#x27;, provider_name=&#x27;github&#x27;) &#125;&#125;&quot;&gt;</span><br><span class="line">        &lt;i class=&quot;github big icon black&quot;&gt;&lt;/i&gt;</span><br><span class="line">    &lt;/a&gt;</span><br><span class="line">    &lt;a class=&quot;icon&quot; href=&quot;&#123;&#123; url_for(&#x27;oauth.oauth_login&#x27;, provider_name=&#x27;google&#x27;) &#125;&#125;&quot;&gt;</span><br><span class="line">        &lt;i class=&quot;google big icon red&quot;&gt;&lt;/i&gt;</span><br><span class="line">    &lt;/a&gt;</span><br><span class="line">    &lt;a class=&quot;icon&quot; href=&quot;&#123;&#123; url_for(&#x27;oauth.oauth_login&#x27;, provider_name=&#x27;twitter&#x27;) &#125;&#125;&quot;&gt;</span><br><span class="line">        &lt;i class=&quot;twitter big icon blue&quot;&gt;&lt;/i&gt;</span><br><span class="line">    &lt;/a&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> catchat.extensions <span class="keyword">import</span> oauth</span><br><span class="line"></span><br><span class="line">github = oauth.remote_app(</span><br><span class="line">    <span class="comment"># 在这些参数中，不同服务提供方的各种URL可以在各自的开发文档中看到。</span></span><br><span class="line">    name=<span class="string">&#x27;github&#x27;</span>,</span><br><span class="line">    consumer_key=os.getenv(<span class="string">&#x27;GITHUB_CLIENT_ID&#x27;</span>),</span><br><span class="line">    consumer_secret=os.getenv(<span class="string">&#x27;GITHUB_CLIENT_SECRET&#x27;</span>),</span><br><span class="line">    request_token_params=&#123;<span class="string">&#x27;scope&#x27;</span>: <span class="string">&#x27;user&#x27;</span>&#125;,</span><br><span class="line">    base_url=<span class="string">&#x27;https://api.github.com/&#x27;</span>,</span><br><span class="line">    request_token_url=<span class="literal">None</span>,</span><br><span class="line">    access_token_method=<span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">    access_token_url=<span class="string">&#x27;https://github.com/login/oauth/access_token&#x27;</span>,</span><br><span class="line">    authorize_url=<span class="string">&#x27;https://github.com/login/oauth/authorize&#x27;</span>,</span><br><span class="line">)</span><br><span class="line">twtter = oauth.remote_app(...)</span><br><span class="line">google = oauth.remote_app(...)</span><br><span class="line">providers = &#123;</span><br><span class="line">    <span class="string">&#x27;github&#x27;</span>: github,</span><br><span class="line">    <span class="string">&#x27;google&#x27;</span>: google,</span><br><span class="line">    <span class="string">&#x27;twitter&#x27;</span>: twitter</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@oauth_bp.route(<span class="params"><span class="string">&#x27;/login/&lt;provider_name&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">oauth_login</span>(<span class="params">provider_name</span>):</span></span><br><span class="line">    <span class="keyword">if</span> provider_name <span class="keyword">not</span> <span class="keyword">in</span> providers.keys():</span><br><span class="line">        abort(<span class="number">404</span>)</span><br><span class="line">    <span class="keyword">if</span> current_user.is_authenticated:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;chat.home&#x27;</span>))</span><br><span class="line">    callback = url_for(<span class="string">&#x27;.oauth_callback&#x27;</span>, provider_name=provider_name, _external=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">return</span> providers[provider_name].authorize(callback=callback)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@oauth_bp.route(<span class="params"><span class="string">&#x27;/callback/&lt;provider_name&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">oauth_callback</span>(<span class="params">provider_name</span>):</span></span><br><span class="line">    <span class="keyword">if</span> provider_name <span class="keyword">not</span> <span class="keyword">in</span> providers.keys():</span><br><span class="line">        abort(<span class="number">404</span>)</span><br><span class="line">    provider = providers[provider_name]</span><br><span class="line">    <span class="comment"># 将access的数据POST到第三方应用进行验证 , 得到返回响应</span></span><br><span class="line">    response = provider.authorized_response()</span><br><span class="line">    <span class="keyword">if</span> response <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">if</span> provider_name == <span class="string">&#x27;twitter&#x27;</span>:</span><br><span class="line">            access_token = response.get(<span class="string">&#x27;oauth_token&#x27;</span>), response.get(<span class="string">&#x27;oauth_token_secret&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            access_token = response.get(<span class="string">&#x27;access_token&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        access_token = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> access_token <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        flash(<span class="string">&#x27;Access denied, please try again.&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;auth.login&#x27;</span>))</span><br><span class="line">    username, website, github, email, bio = get_social_profile(provider, access_token)</span><br><span class="line">    user = User.query.filter_by(email=email).first()</span><br><span class="line">    <span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        user = User(email=email, nickname=username, website=website,</span><br><span class="line">                    github=github, bio=bio)</span><br><span class="line">        db.session.add(user)</span><br><span class="line">        db.session.commit()</span><br><span class="line">        login_user(user, remember=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;chat.profile&#x27;</span>))</span><br><span class="line">    login_user(user, remember=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;chat.home&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># API的资源端点</span></span><br><span class="line">profile_endpoints = &#123;</span><br><span class="line">    <span class="string">&#x27;github&#x27;</span>: <span class="string">&#x27;user&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;google&#x27;</span>: <span class="string">&#x27;userinfo&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;twitter&#x27;</span>: <span class="string">&#x27;account/verify_credentials.json?include_email=true&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_social_profile</span>(<span class="params">provider, access_token</span>):</span></span><br><span class="line">    profile_endpoint = profile_endpoints[provider.name]</span><br><span class="line">    <span class="comment"># 对远程程序对象调用get方法来获取用户的部分信息</span></span><br><span class="line">    <span class="comment"># 第一个参数url是发送请求的URL，即API的资源端点。</span></span><br><span class="line">    <span class="comment"># 在github中 ,传入的资源URL为user，结合我们注册 github远程程序时传入的baseurl，最终生成的端点URL即http://api.github.com/user，这个端点用来获取GitHub用户的信息</span></span><br><span class="line">    response = provider.get(profile_endpoint, token=access_token)</span><br><span class="line">    <span class="keyword">if</span> provider.name == <span class="string">&#x27;twitter&#x27;</span>:</span><br><span class="line">        username = response.data.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">        website = response.data.get(<span class="string">&#x27;url&#x27;</span>)</span><br><span class="line">        github = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        email = response.data.get(<span class="string">&#x27;email&#x27;</span>)</span><br><span class="line">        bio = response.data.get(<span class="string">&#x27;description&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> provider.name == <span class="string">&#x27;google&#x27;</span>:</span><br><span class="line">        username = response.data.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">        website = response.data.get(<span class="string">&#x27;link&#x27;</span>)</span><br><span class="line">        github = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        email = response.data.get(<span class="string">&#x27;email&#x27;</span>)</span><br><span class="line">        bio = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        username = response.data.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">        website = response.data.get(<span class="string">&#x27;blog&#x27;</span>)</span><br><span class="line">        github = response.data.get(<span class="string">&#x27;html_url&#x27;</span>)</span><br><span class="line">        email = response.data.get(<span class="string">&#x27;email&#x27;</span>)</span><br><span class="line">        bio = response.data.get(<span class="string">&#x27;bio&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> username, website, github, email, bio</span><br></pre></td></tr></table></figure>

<ul>
<li><p>我们首先需要创建用于第三方登录的视图，在视图函数中使用redirect重定向到服务提供方的授权URL，并附加相应的查询参数。但我们不必手动做这个工作，因为 Flask-OAuthlib为每一个注册后的远程程序对象提供了 authorized方法，这个方法用来构建授权URL并生成重定向响应。</p>
<p><code>github.authorize(url_for(&#39;.github_callback&#39;,_external=True))</code></p>
</li>
<li><p><code>response = provider.authorized_response()</code>封装了POST验证access的一系列操作</p>
</li>
</ul>
<h3 id="bleach-markdown库支持markdown"><a href="#bleach-markdown库支持markdown" class="headerlink" title="bleach+markdown库支持markdown"></a>bleach+markdown库支持markdown</h3><ul>
<li>markdown : 文本转换</li>
<li>Bleach : HTML清理工具包 (防止恶意内容 , 比如 JavaScript脚本。)</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install markdown</span><br><span class="line">pip install bleach</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import markdown</span><br><span class="line">&gt;&gt;&gt; md = &quot;# hello markdown&quot;</span><br><span class="line">&gt;&gt;&gt; markdown.markdown(md)</span><br><span class="line">&#x27;&lt;h1&gt;hello markdown&lt;/h1&gt;&#x27;</span><br></pre></td></tr></table></figure>

<h4 id="简单使用-1"><a href="#简单使用-1" class="headerlink" title="简单使用"></a>简单使用</h4><p>Bleach的清理工作是基于白名单 (allowed_tags , allowed_attributes)进行的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bleach <span class="keyword">import</span> clean, linkify</span><br><span class="line"><span class="keyword">from</span> markdown <span class="keyword">import</span> markdown</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">to_html</span>(<span class="params">raw</span>):</span></span><br><span class="line">    allowed_tags = [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;abbr&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;br&#x27;</span>, <span class="string">&#x27;blockquote&#x27;</span>, <span class="string">&#x27;code&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;del&#x27;</span>, <span class="string">&#x27;div&#x27;</span>, <span class="string">&#x27;em&#x27;</span>, <span class="string">&#x27;img&#x27;</span>, <span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;pre&#x27;</span>, <span class="string">&#x27;strong&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;span&#x27;</span>, <span class="string">&#x27;ul&#x27;</span>, <span class="string">&#x27;li&#x27;</span>, <span class="string">&#x27;ol&#x27;</span>]</span><br><span class="line">    allowed_attributes = [<span class="string">&#x27;src&#x27;</span>, <span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;alt&#x27;</span>, <span class="string">&#x27;href&#x27;</span>, <span class="string">&#x27;class&#x27;</span>]</span><br><span class="line">    html = markdown(raw, output_format=<span class="string">&#x27;html&#x27;</span>,</span><br><span class="line">                    <span class="comment"># 使用fenced_code和codehilite插件进行代码语法高亮</span></span><br><span class="line">                    extensions=[<span class="string">&#x27;markdown.extensions.fenced_code&#x27;</span>,</span><br><span class="line">                                <span class="string">&#x27;markdown.extensions.codehilite&#x27;</span>])</span><br><span class="line">    clean_html = clean(html, tags=allowed_tags, attributes=allowed_attributes)</span><br><span class="line">    <span class="keyword">return</span> linkify(clean_html)</span><br></pre></td></tr></table></figure>



<ol>
<li>接收用户输入的包含 Markdown标记的源文本。</li>
<li>将 Markdown文本转换为HTML格式。</li>
<li>将转换好的HTML文本渲染到模板中。</li>
</ol>
<h3 id="代码语法高亮"><a href="#代码语法高亮" class="headerlink" title="代码语法高亮"></a>代码语法高亮</h3><p>Flask-CKEditor内置了代码语法高亮功能 , 这里我们使用<code>pyments</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pyments</span><br></pre></td></tr></table></figure>

<blockquote>
<p>原理 : 对于HTML格式来说，通过解析代码片段的语法结构，Payments会使用标签分隔每一个语法单元，并添加对应的样式类，最后通过加载对应的CSS文件即可实现代码“上色”。</p>
</blockquote>
<h3 id="desktop-notification-桌面通知"><a href="#desktop-notification-桌面通知" class="headerlink" title="desktop notification(桌面通知)"></a>desktop notification(桌面通知)</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.addEventListener(<span class="string">&#x27;DOMContentLoaded&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!Notification) &#123;</span><br><span class="line">        alert(<span class="string">&#x27;Desktop notifications not available in your browser.&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (Notification.permission !== <span class="string">&quot;granted&quot;</span>)</span><br><span class="line">        Notification.requestPermission();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Notification.permission</code>存储用户的许可状态值 : granted表示允许，denied表示拒绝，默认为 default（等同于 denied）。</li>
<li>如果 Notification. permission的值不是 granted,那么就调用  Notification.requestPermission()方法请求授权,这会在用户浏览器中弹出一个授权请求窗口.</li>
</ul>
<h4 id="简单使用-2"><a href="#简单使用-2" class="headerlink" title="简单使用"></a>简单使用</h4><ul>
<li>notification.onclick属性定义的函数会在提醒弹窗被单击时执行</li>
<li>notification.close()方法关闭弹窗。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> NotificationInstance = Notification || <span class="built_in">window</span>.Notification;</span><br><span class="line"><span class="keyword">if</span> (!!NotificationInstance) &#123;</span><br><span class="line">    <span class="keyword">const</span> permissionNow = NotificationInstance.permission;</span><br><span class="line">    <span class="keyword">if</span> (permissionNow === <span class="string">&#x27;granted&#x27;</span>) &#123;<span class="comment">//允许通知</span></span><br><span class="line">        CreatNotification();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (permissionNow === <span class="string">&#x27;denied&#x27;</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;用户拒绝了你!!!&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        setPermission();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setPermission</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">//请求获取通知权限</span></span><br><span class="line">        NotificationInstance.requestPermission(<span class="function"><span class="keyword">function</span> (<span class="params">PERMISSION</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (PERMISSION === <span class="string">&#x27;granted&#x27;</span>) &#123;</span><br><span class="line">                CreatNotification();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&#x27;用户无情残忍的拒绝了你!!!&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">CreatNotification</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> n = <span class="keyword">new</span> NotificationInstance(<span class="string">&#x27;XX网站消息通知&#x27;</span>, &#123;</span><br><span class="line">            <span class="attr">body</span>: <span class="string">&#x27;你的朋友有新状态啦，快去围观吧！&#x27;</span>,</span><br><span class="line">            <span class="attr">tag</span>: <span class="string">&#x27;2ue&#x27;</span>,</span><br><span class="line">            <span class="attr">icon</span>: <span class="string">&#x27;https://2ue.github.io/images/common/avatar.png&#x27;</span>,</span><br><span class="line">            <span class="attr">data</span>: &#123;</span><br><span class="line">                <span class="attr">url</span>: <span class="string">&#x27;https://2ue.github.io&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        n.onshow = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&#x27;通知显示了！&#x27;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">        n.onclick = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">            <span class="comment">//可以直接通过实例的方式获取data内自定义的数据</span></span><br><span class="line">            <span class="comment">//也可以通过访问回调参数e来获取data的数据</span></span><br><span class="line">            <span class="built_in">window</span>.open(n.data.url, <span class="string">&#x27;_blank&#x27;</span>);</span><br><span class="line">            n.close();</span><br><span class="line">        &#125;;</span><br><span class="line">        n.onclose = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&#x27;你墙壁了我！！！&#x27;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">        n.onerror = <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&#x27;出错了，小伙子在检查一下吧&#x27;</span>);</span><br><span class="line">            <span class="keyword">throw</span> err;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            n.close();</span><br><span class="line">        &#125;, <span class="number">2000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>