<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;第一章-初识FLASK&quot;&gt;&lt;a href=&quot;#第一章-初识FLASK&quot; class=&quot;headerlink&quot; title=&quot;第一章 初识FLASK&quot;&gt;&lt;/a&gt;第一章 初识FLASK&lt;/h2&gt;&lt;p&gt;HTML , css , JavaScript 分别作为一个 Web 页面的结构层、表现层和行为层"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>FlaskWeb开发实战1_基础 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Flask/" rel="tag">Flask</a></div><div class="post-time">2021-08-29</div></div></div><div class="container post-header"><h1>FlaskWeb开发实战1_基础</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%AB%A0-%E5%88%9D%E8%AF%86FLASK"><span class="toc-number">1.</span> <span class="toc-text">第一章 初识FLASK</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pipenv"><span class="toc-number">1.1.</span> <span class="toc-text">pipenv</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flask-Flask-%E5%92%8C-%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.2.</span> <span class="toc-text">flask.Flask 和 创建实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#URL%E5%8F%82%E6%95%B0%E8%AE%BE%E7%BD%AE%E9%BB%98%E8%AE%A4%E5%80%BC"><span class="toc-number">1.3.</span> <span class="toc-text">URL参数设置默认值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flask-routes%E5%91%BD%E4%BB%A4"><span class="toc-number">1.4.</span> <span class="toc-text">flask routes命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8F%91%E7%8E%B0%E7%A8%8B%E5%BA%8F%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.5.</span> <span class="toc-text">自动发现程序实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%A4%96%E9%83%A8%E5%8F%AF%E8%A7%81%E4%B8%8Eflask-run%E5%91%BD%E4%BB%A4"><span class="toc-number">1.6.</span> <span class="toc-text">使服务器外部可见与flask run命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-number">1.7.</span> <span class="toc-text">上下文</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE"><span class="toc-number">1.8.</span> <span class="toc-text">项目配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#url-for-%E7%9A%84%E7%9B%B8%E5%AF%B9%E4%BA%8E%E7%BB%9D%E5%AF%B9"><span class="toc-number">1.9.</span> <span class="toc-text">url_for 的相对于绝对</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#current-app"><span class="toc-number">1.10.</span> <span class="toc-text">current_app</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%8E%82"><span class="toc-number">1.11.</span> <span class="toc-text">工厂</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E5%91%BD%E4%BB%A4-%E4%B8%8E-click"><span class="toc-number">1.12.</span> <span class="toc-text">注册命令 与 click</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8Cfilters"><span class="toc-number">1.13.</span> <span class="toc-text">注册filters</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E6%A8%A1%E6%9D%BF%E4%B8%8A%E4%B8%8B%E6%96%87-%E6%A8%A1%E6%9D%BF%E5%8F%98%E9%87%8F"><span class="toc-number">1.14.</span> <span class="toc-text">注册模板上下文(模板变量)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E5%85%A8%E5%B1%80%E5%87%BD%E6%95%B0"><span class="toc-number">1.15.</span> <span class="toc-text">注册全局函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E6%B5%8B%E8%AF%95%E5%99%A8"><span class="toc-number">1.16.</span> <span class="toc-text">注册测试器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8CShell%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-number">1.17.</span> <span class="toc-text">注册Shell上下文</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8Cerrorhandlers"><span class="toc-number">1.18.</span> <span class="toc-text">注册errorhandlers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8Cblueprint"><span class="toc-number">1.19.</span> <span class="toc-text">注册blueprint</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E6%99%AE%E9%80%9A%E6%97%A5%E5%BF%97"><span class="toc-number">1.20.</span> <span class="toc-text">注册普通日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8CSMTP%E6%97%A5%E5%BF%97"><span class="toc-number">1.21.</span> <span class="toc-text">注册SMTP日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E8%AF%B7%E6%B1%82%E9%92%A9%E5%AD%90"><span class="toc-number">1.22.</span> <span class="toc-text">注册请求钩子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E7%A8%8B%E5%BA%8F%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-number">1.23.</span> <span class="toc-text">注册程序上下文</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%B3%A8%E5%86%8C%E5%A4%96%E9%83%A8%E5%BA%93"><span class="toc-number">1.24.</span> <span class="toc-text">创建注册外部库</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%AB%A0-FLASK%E4%B8%8EHTTP"><span class="toc-number">2.</span> <span class="toc-text">第二章 FLASK与HTTP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MutliDict%E4%B8%8EImmutableMultiDict"><span class="toc-number">2.1.</span> <span class="toc-text">MutliDict与ImmutableMultiDict</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E8%A1%A8"><span class="toc-number">2.2.</span> <span class="toc-text">路由表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#app-route-quot-colors-lt-any-blue-red-color-gt-quot"><span class="toc-number">2.3.</span> <span class="toc-text">app.route(&quot;&#x2F;colors&#x2F;&lt;any(blue,red):color&gt;&quot;)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MIME-%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.4.</span> <span class="toc-text">MIME 类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E4%B8%8B%E6%96%87-1"><span class="toc-number">2.5.</span> <span class="toc-text">上下文</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E5%92%8C%E8%AF%B7%E6%B1%82%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-number">2.5.1.</span> <span class="toc-text">应用上下文和请求上下文</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BF%80%E6%B4%BB%E4%B8%8A%E4%B8%8B%E6%96%87%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%83%85%E5%86%B5"><span class="toc-number">2.5.2.</span> <span class="toc-text">激活上下文的四种情况</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BF%80%E6%B4%BB%E8%AF%B7%E6%B1%82%E4%B8%8A%E4%B8%8B%E6%96%87-%E5%92%8C-%E7%A8%8B%E5%BA%8F%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-number">2.5.3.</span> <span class="toc-text">激活请求上下文 和 程序上下文</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8A%E4%B8%8B%E6%96%87%E9%92%A9%E5%AD%90"><span class="toc-number">2.5.4.</span> <span class="toc-text">上下文钩子</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E4%B8%8A%E4%B8%80%E4%B8%AA%E9%A1%B5%E9%9D%A2%E7%9A%84URL"><span class="toc-number">2.6.</span> <span class="toc-text">获取上一个页面的URL</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8referer"><span class="toc-number">2.6.1.</span> <span class="toc-text">使用referer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8query-args"><span class="toc-number">2.6.2.</span> <span class="toc-text">使用query args</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%BC%E5%90%88%E4%B8%8A%E8%BF%B0-url%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81"><span class="toc-number">2.6.3.</span> <span class="toc-text">综合上述 + url安全认证</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E6%8E%A8%E9%80%81"><span class="toc-number">2.7.</span> <span class="toc-text">HTTP服务器端推送</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB"><span class="toc-number">2.8.</span> <span class="toc-text">注入攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#XSS%E6%94%BB%E5%87%BB"><span class="toc-number">2.8.1.</span> <span class="toc-text">XSS攻击</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%AC%E4%B9%89"><span class="toc-number">2.8.2.</span> <span class="toc-text">转义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86%E5%8D%B1%E9%99%A9%E6%96%87%E6%9C%AC%E8%BD%AC%E4%B8%BAMarkup%E5%AF%B9%E8%B1%A1%E8%BF%9B%E8%A1%8C%E9%98%B2%E5%BE%A1"><span class="toc-number">2.8.3.</span> <span class="toc-text">将危险文本转为Markup对象进行防御</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CSRF%E6%94%BB%E5%87%BB"><span class="toc-number">2.8.4.</span> <span class="toc-text">CSRF攻击</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CSRF%E6%94%BB%E5%87%BB%E9%98%B2%E5%BE%A1"><span class="toc-number">2.8.5.</span> <span class="toc-text">CSRF攻击防御</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E7%AB%A0-%E6%A8%A1%E6%9D%BF"><span class="toc-number">3.</span> <span class="toc-text">第三章 模板</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E6%A8%A1%E6%9D%BF%E4%B8%8A%E4%B8%8B%E6%96%87%E5%8F%98%E9%87%8F"><span class="toc-number">3.1.</span> <span class="toc-text">注册模板上下文变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E6%A8%A1%E6%9D%BF%E6%96%B9%E6%B3%95"><span class="toc-number">3.2.</span> <span class="toc-text">注册模板方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Jinja2-%E5%86%85%E7%BD%AE%E6%A8%A1%E6%9D%BF%E5%85%A8%E5%B1%80%E5%87%BD%E6%95%B0"><span class="toc-number">3.3.</span> <span class="toc-text">Jinja2 内置模板全局函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#filter%E7%9A%84%E5%8F%A6%E4%B8%80%E7%A7%8D%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">3.4.</span> <span class="toc-text">filter的另一种使用方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%99%A8"><span class="toc-number">3.5.</span> <span class="toc-text">测试器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jinja-env"><span class="toc-number">3.6.</span> <span class="toc-text">jinja_env</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8F"><span class="toc-number">3.7.</span> <span class="toc-text">宏</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AEfavicon-ico"><span class="toc-number">3.8.</span> <span class="toc-text">设置favicon.ico</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%AE%8F%E5%8A%A0%E8%BD%BD%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90"><span class="toc-number">3.9.</span> <span class="toc-text">使用宏加载静态资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E9%97%AA%E7%8E%B0%E7%9A%84%E5%9B%BA%E5%AE%9Ajinja%E6%A8%A1%E6%9D%BF"><span class="toc-number">3.10.</span> <span class="toc-text">消息闪现的固定jinja模板</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89JS%E6%88%96CSS%E5%8F%98%E9%87%8F"><span class="toc-number">3.11.</span> <span class="toc-text">自定义JS或CSS变量</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E8%A1%A8%E5%8D%95"><span class="toc-number">4.</span> <span class="toc-text">第四章 表单</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#WTForms%E5%AE%9E%E4%BE%8B%E5%8C%96%E5%AD%97%E6%AE%B5%E5%B8%B8%E7%94%A8%E5%8F%82%E6%95%B0"><span class="toc-number">4.1.</span> <span class="toc-text">WTForms实例化字段常用参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WTForms%E5%B8%B8%E7%94%A8%E9%AA%8C%E8%AF%81%E5%99%A8"><span class="toc-number">4.2.</span> <span class="toc-text">WTForms常用验证器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#form-csrf-token%E5%AD%97%E6%AE%B5-%E5%92%8Cform-hidden-tag-%E6%96%B9%E6%B3%95%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">4.3.</span> <span class="toc-text">form.csrf_token字段 和form.hidden_tag()方法的区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PRG%EF%BC%88Post-Redirect-Get%EF%BC%89%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.4.</span> <span class="toc-text">PRG（Post&#x2F;Redirect&#x2F;Get）模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WTF%E6%9C%AC%E5%9C%B0%E5%8C%96"><span class="toc-number">4.5.</span> <span class="toc-text">WTF本地化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#form-field%E7%9A%84%E5%AE%8F"><span class="toc-number">4.6.</span> <span class="toc-text">form_field的宏</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WTForm%E7%9A%84%E8%A1%8C%E5%86%85%E5%92%8C%E5%85%A8%E5%B1%80validator"><span class="toc-number">4.7.</span> <span class="toc-text">WTForm的行内和全局validator</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">4.8.</span> <span class="toc-text">文件上传</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E6%96%87%E4%BB%B6-%E4%B8%8E-%E5%A4%9A%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E9%80%9A%E7%94%A8%E4%BB%A3%E7%A0%81"><span class="toc-number">4.8.1.</span> <span class="toc-text">单文件 与 多文件上传通用代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#secure-filename%E5%87%BD%E6%95%B0"><span class="toc-number">4.8.2.</span> <span class="toc-text">secure_filename函数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Flask-CKEditor-%E9%9B%86%E6%88%90%E5%AF%8C%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91%E5%99%A8"><span class="toc-number">4.9.</span> <span class="toc-text">使用Flask-CKEditor 集成富文本编辑器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E4%B8%AA%E8%A1%A8%E5%8D%95%E5%A4%9A%E4%B8%AA%E6%8F%90%E4%BA%A4%E6%8C%89%E9%92%AE"><span class="toc-number">4.10.</span> <span class="toc-text">单个表单多个提交按钮</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E4%B8%AA%E9%A1%B5%E9%9D%A2%E5%A4%9A%E4%B8%AA%E8%A1%A8%E5%8D%95"><span class="toc-number">4.11.</span> <span class="toc-text">单个页面多个表单</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E8%A7%86%E5%9B%BE%E5%A4%84%E7%90%86"><span class="toc-number">4.11.1.</span> <span class="toc-text">单视图处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E8%A7%86%E5%9B%BE%E5%A4%84%E7%90%86"><span class="toc-number">4.11.2.</span> <span class="toc-text">多视图处理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E7%AB%A0-%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">5.</span> <span class="toc-text">第五章 数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%AF%B9%E5%BA%94SQL%E8%AF%AD%E5%8F%A5"><span class="toc-number">5.1.</span> <span class="toc-text">查看对应SQL语句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E9%87%8D%E5%BB%BA%E5%AE%9A%E4%B9%89%E6%88%90click"><span class="toc-number">5.2.</span> <span class="toc-text">将数据库的重建定义成click</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE%E4%B8%8D%E8%83%BD%E4%BD%BF%E7%94%A8get-%E5%BF%85%E9%A1%BB%E6%94%B9%E6%88%90post"><span class="toc-number">5.3.</span> <span class="toc-text">删除数据不能使用get , 必须改成post</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-Python-Shell-%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-number">5.4.</span> <span class="toc-text">配置 Python Shell 上下文</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E5%AF%B9%E5%A4%9A"><span class="toc-number">5.5.</span> <span class="toc-text">一对多</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E5%AF%B9%E5%A4%9A%E7%9A%84%E5%8F%8C%E5%90%91%E5%85%B3%E7%B3%BB"><span class="toc-number">5.5.1.</span> <span class="toc-text">一对多的双向关系</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E5%AF%B9%E4%B8%80"><span class="toc-number">5.6.</span> <span class="toc-text">多对一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E5%AF%B9%E4%B8%80"><span class="toc-number">5.7.</span> <span class="toc-text">一对一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E5%AF%B9%E5%A4%9A1-%E8%99%9A%E6%8B%9F%E8%A1%A8"><span class="toc-number">5.8.</span> <span class="toc-text">多对多1:虚拟表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E5%AF%B9%E5%A4%9A2-%E5%AE%9E%E4%BD%93%E8%A1%A8"><span class="toc-number">5.9.</span> <span class="toc-text">多对多2:实体表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E5%AF%B9%E5%A4%9A3-%E8%87%AA%E5%BC%95%E7%94%A8"><span class="toc-number">5.10.</span> <span class="toc-text">多对多3:自引用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%A7%E8%81%94%E6%93%8D%E4%BD%9C"><span class="toc-number">5.11.</span> <span class="toc-text">级联操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#with-parent"><span class="toc-number">5.12.</span> <span class="toc-text">with_parent()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SQLalchemy%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC"><span class="toc-number">5.13.</span> <span class="toc-text">SQLalchemy事件监听</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E7%AB%A0-%E7%94%B5%E5%AD%90%E9%82%AE%E4%BB%B6"><span class="toc-number">6.</span> <span class="toc-text">第六章 电子邮件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8"><span class="toc-number">6.1.</span> <span class="toc-text">简单使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E5%8F%91%E9%80%81"><span class="toc-number">6.2.</span> <span class="toc-text">异步发送</span></a></li></ol></li></ol></details></div><div class="container post-content"><h2 id="第一章-初识FLASK"><a href="#第一章-初识FLASK" class="headerlink" title="第一章 初识FLASK"></a>第一章 初识FLASK</h2><p>HTML , css , JavaScript 分别作为一个 Web 页面的结构层、表现层和行为层</p>
<h3 id="pipenv"><a href="#pipenv" class="headerlink" title="pipenv"></a>pipenv</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pipenv</span><br></pre></td></tr></table></figure>

<p>Pipenv 是基 pip Python 理工具，它和 pip 的用 非常相似，可以看作 pip 的加强版，它的出现解决了旧的 pip+virtualenv+requirements.txt 作方式的弊端 具体来说，它是 pip Pipfile Virtualenv 结合体，它让包安装、包依赖 理和虚拟环境管理更加方便，使用它可 高效 Python 目开发工作流</p>
<p>之后我们就可以使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pipenv install</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pipenv install XXX</span><br></pre></td></tr></table></figure>

<p>这会为当前项目创建一个文件夹，其中包含隔离的 Python 解释器环境，并且安装 pip wheel setuptools 等基本的包</p>
<p>类似于<code>requirements.txt</code> , pipenv使用的文件为<code>Pipfile 文件</code>和<code>Pipfile.lock文件</code>，前者用来记录项目依赖包 ，而后者记录了固 定版本的详细依赖包列表,当我们使用 Pipenv安装/删除/更新依赖包时，Pipile以及 Pipilelock会自动更新。</p>
<blockquote>
<p>默认情况 下， Pipenv统一管理所有虚拟环境</p>
<p> Windows 系统中，虚拟环境文件夹 在 C: \U sers\Administrator. virtualenvs 目录下创建，而 Linux macOS 会在 ～／.local/share/virtualenvs 目录下创建</p>
<p>如采你想在项目目录内创建虚拟环珑文件夫，可以设置 环境变量 PIPENV_VENV_IN_PROJECT ，这时名为 .venv 的虚拟环 文件夹将在项目根 目录被创建</p>
</blockquote>
<p>激活虚拟环境</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pipenv shell</span><br></pre></td></tr></table></figure>



<h3 id="flask-Flask-和-创建实例"><a href="#flask-Flask-和-创建实例" class="headerlink" title="flask.Flask 和 创建实例"></a>flask.Flask 和 创建实例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br></pre></td></tr></table></figure>

<p>用特殊变量<code>__name__</code> : Python会根据所处的模块来赋予<code>_name_</code>变量相应的值，对于我们的程序来说（app.py），这个值为app。除此之外，这也会帮助 Flask在相应的文件夹里找到需要的资源，比如模板和静态文件。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">flask</span>.<span class="title">Flask</span>(<span class="params">import_name, static_url_path=<span class="literal">None</span>, static_folder=<span class="string">&#x27;static&#x27;</span>, static_host=<span class="literal">None</span>, host_matching=<span class="literal">False</span>, subdomain_matching=<span class="literal">False</span>, template_folder=<span class="string">&#x27;templates&#x27;</span>, instance_path=<span class="literal">None</span>, instance_relative_config=<span class="literal">False</span>, root_path=<span class="literal">None</span></span>)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>static_url_path : 前端访问资源文件的前缀目录。</li>
<li>static_folder : 后端存储资源文件的目录。</li>
<li>template_folder : 后端存储模板文件的目录</li>
</ul>
<h3 id="URL参数设置默认值"><a href="#URL参数设置默认值" class="headerlink" title="URL参数设置默认值"></a>URL参数设置默认值</h3><p>如果用户访问的 URL 没有添加变量，Flask在匹配失败后会返回一个404错误响应。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/greet&#x27;</span>,defaults=&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;hyl&#x27;</span>&#125;</span>)</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/greet/&lt;name&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">greet</span>(<span class="params">name</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&#x27;hello <span class="subst">&#123;name&#125;</span>&#x27;</span></span><br></pre></td></tr></table></figure>



<h3 id="flask-routes命令"><a href="#flask-routes命令" class="headerlink" title="flask routes命令"></a>flask routes命令</h3><p>查看当前项目的所有route</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Endpoint        Methods  Rule</span><br><span class="line">--------------  -------  -----------------------------</span><br><span class="line">index.any_test  GET      /colors/&lt;any(blue,red):color&gt;</span><br><span class="line">index.index     GET      /</span><br><span class="line">index.test      GET      /test/</span><br><span class="line">static          GET      /static/&lt;path:filename&gt;</span><br></pre></td></tr></table></figure>



<h3 id="自动发现程序实例"><a href="#自动发现程序实例" class="headerlink" title="自动发现程序实例"></a>自动发现程序实例</h3><p>在执行 flask run命令运行程序前，我们需要提供程序实例所在模块的位置。但是我们可以直接运行程序，是因为<br>Flask会自动探测程序实例，自动探测存在下面这些规则：</p>
<ul>
<li>从当前目录寻找 app.py和 wsgi.py模块，并从中寻找名为app或 application的程序实例。</li>
<li>从环境变量 FLASK_APP对应的值寻找名为app或 application 的程序实例。</li>
</ul>
<p>因为我们的程序主模块命名为app.py，所以 flask run命令会自动在其中寻找程序实例。如果你的程序主模块是其他名称，比如 hello.py，那么需要设置环境变量 FLASK APP，将包含程序实例的模块名赋值给这个变量。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set FLASK_APP=hello</span><br></pre></td></tr></table></figure>



<h3 id="使服务器外部可见与flask-run命令"><a href="#使服务器外部可见与flask-run命令" class="headerlink" title="使服务器外部可见与flask run命令"></a>使服务器外部可见与flask run命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flask run -- host 0.0.0.0 </span><br></pre></td></tr></table></figure>

<blockquote>
<p>执行 flask run命令时的host和port选项也可以通过环境变量 <code>FLASK_RUN_HOST</code>和<code>FLASK_RUN_PORT</code>设置。</p>
<p>事实上，Flask内置的命令都可以使用这种模式定义默认选项值，即<code>FLASK_&lt; COMMAND&gt;_&lt;OPTION&gt;</code>，你可以使用flask-help命令查看所有可用的命令</p>
</blockquote>
<p>开发环境</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FLASK_ENV=development</span><br></pre></td></tr></table></figure>



<p>在开发环境下，调试模式（Debug Mode）将被开启，这时执行 flask run启动程序会自动激活 Werkzeug内置的<code>调试器</code>（debugger）和<code>重载器</code>（reloader）</p>
<ul>
<li>默认会使用  Werkzeug内置的<code>stat重载器</code>，它的缺点是耗电较严重，而且准确性一般。</li>
<li>为了获得更优秀的体验，我们可以安装另一个用于监测文件变动的 Python库  Watchdog，安装后Werkzeug会自动使用它来监测文件变动：<code>pipenv install watchdog--dev</code></li>
</ul>
<h3 id="上下文"><a href="#上下文" class="headerlink" title="上下文"></a>上下文</h3><ul>
<li>上下文（ context ）可以理解为环境</li>
<li>为了正常运行程序，一些操作相关的状态和数据要被<strong>临时保存下来</strong>,这些状态和数据被统称为上下文</li>
<li>Flask 中，上下文有两种，分别为<code>程序上下文</code>和<code>请求上下文</code></li>
</ul>
<h3 id="项目配置"><a href="#项目配置" class="headerlink" title="项目配置"></a>项目配置</h3><p>配置的名称必须是全大写形式，小写的变量将不被读取</p>
<p>这些配置变量都通过 Flask对象的 app.config属性作为统一的接口来设置和获取,它指向的Config类实际上是字典的子类,所以你可以像操作其他字典一样操作它.</p>
<h3 id="url-for-的相对于绝对"><a href="#url-for-的相对于绝对" class="headerlink" title="url_for 的相对于绝对"></a>url_for 的相对于绝对</h3><ul>
<li>url_for函数生成的URL是相对URL ,</li>
<li>如果想要生成供外部使用的绝对URL，可以在使用 url_for函数时，将<code>_external</code>参数设为True，这会生成完整的URL</li>
</ul>
<h3 id="current-app"><a href="#current-app" class="headerlink" title="current_app"></a>current_app</h3><ul>
<li>current_app是一个表示当前程序实例的<code>代理对象</code>。</li>
<li>当某个程序实例被创建并运行时，它会自动指向当前运行的程序实例，并<strong>把所有操作都转发到当前的程序实例</strong>。</li>
<li>比如，当我们需要获取配置值时，会使用 current app.config，其他方法和属性亦同。</li>
</ul>
<h3 id="工厂"><a href="#工厂" class="headerlink" title="工厂"></a>工厂</h3><p>工厂（ factory ）是指<strong>创建其他对象的对象</strong> ,通常是一个返回其他类的对象的函数或方法，</p>
<h3 id="注册命令-与-click"><a href="#注册命令-与-click" class="headerlink" title="注册命令 与 click"></a>注册命令 与 click</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> click</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.cli.command()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span>():</span></span><br><span class="line">    click.echo(<span class="string">&#x27;Hello, Human!&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>一般我们就将click相关函数封装成一个类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">configure_click</span>(<span class="params">app</span>):</span></span><br><span class="line"><span class="meta">    @app.cli.command()</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hello</span>():</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Just say hello.&quot;&quot;&quot;</span></span><br><span class="line">        click.echo(<span class="string">&#x27;Hello, Human!&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_app</span>(<span class="params">config_name</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;创建app&quot;&quot;&quot;</span></span><br><span class="line">    app = Flask(__name__)</span><br><span class="line">    config_class = load_config_class(config_name)</span><br><span class="line">    app.config.from_object(config_class)</span><br><span class="line">    configure_click(app)</span><br><span class="line">    configure_errorhandlers(app)</span><br><span class="line">    configure_extensions(app)</span><br><span class="line">    configure_blueprint(app)</span><br><span class="line">    <span class="keyword">return</span> app</span><br></pre></td></tr></table></figure>

<p>这样 , 我们就可以在<code>flask --help</code>中看到了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;flask --help</span><br><span class="line">...</span><br><span class="line">Commands:</span><br><span class="line">  hello   Just say hello.</span><br><span class="line">  routes  Show the routes for the app.</span><br><span class="line">  run     Run a development server.</span><br><span class="line">  shell   Run a shell in the app context.</span><br></pre></td></tr></table></figure>

<h3 id="注册filters"><a href="#注册filters" class="headerlink" title="注册filters"></a>注册filters</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">configure_template_filters</span>(<span class="params">app</span>):</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @app.template_filter()</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">round_</span>(<span class="params">v, precision</span>):</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">round</span>(<span class="built_in">float</span>(v), precision)</span><br><span class="line">        <span class="keyword">except</span> Exception,e:</span><br><span class="line">            <span class="keyword">return</span> v</span><br></pre></td></tr></table></figure>

<h3 id="注册模板上下文-模板变量"><a href="#注册模板上下文-模板变量" class="headerlink" title="注册模板上下文(模板变量)"></a>注册模板上下文(模板变量)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">configure_processor</span>(<span class="params">app</span>):</span></span><br><span class="line"><span class="meta">    @app.context_processor</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inject_foo</span>():</span></span><br><span class="line">        foo = <span class="string">&#x27;I am foo&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">dict</span>(foo=foo)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">    &#123;&#123; foo &#125;&#125;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h3 id="注册全局函数"><a href="#注册全局函数" class="headerlink" title="注册全局函数"></a>注册全局函数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">configure_template_function</span>(<span class="params">app</span>):</span></span><br><span class="line"><span class="meta">    @app.template_global()</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bar</span>():</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;i am bar</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>@app.template_global()</code> 和 <code>@app.context_processor</code> 的区别:</p>
<p>前者专门用来<strong>创建模板函数</strong> , 后者<strong>创建模板变量</strong>(自然也可以用来创建函数)</p>
</blockquote>
<h3 id="注册测试器"><a href="#注册测试器" class="headerlink" title="注册测试器"></a>注册测试器</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">configure_tests</span>(<span class="params">app</span>):</span></span><br><span class="line"><span class="meta">    @app.template_test()</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_heyingliang</span>(<span class="params">string</span>):</span></span><br><span class="line">        <span class="keyword">return</span> string == <span class="string">&#x27;heyingliang&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="注册Shell上下文"><a href="#注册Shell上下文" class="headerlink" title="注册Shell上下文"></a>注册Shell上下文</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">configure_shell</span>(<span class="params">app</span>):</span></span><br><span class="line"><span class="meta">    @app.shell_context_processor</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">make_shell_context</span>():</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">dict</span> (</span><br><span class="line">            db=db,</span><br><span class="line">            Note=Note,</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>

<h3 id="注册errorhandlers"><a href="#注册errorhandlers" class="headerlink" title="注册errorhandlers"></a>注册errorhandlers</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">configure_errorhandlers</span>(<span class="params">app</span>):</span></span><br><span class="line"><span class="meta">    @app.errorhandler(<span class="params"><span class="number">401</span></span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">unauthorized</span>(<span class="params">error</span>):</span></span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&quot;errors/401.html&quot;</span>, error=error)</span><br></pre></td></tr></table></figure>

<h3 id="注册blueprint"><a href="#注册blueprint" class="headerlink" title="注册blueprint"></a>注册blueprint</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">configure_blueprint</span>(<span class="params">app</span>):</span></span><br><span class="line">    <span class="keyword">for</span> blueprint, url_prefix <span class="keyword">in</span> routers:</span><br><span class="line">        app.register_blueprint(blueprint, url_prefix=url_prefix)</span><br></pre></td></tr></table></figure>

<h3 id="注册普通日志"><a href="#注册普通日志" class="headerlink" title="注册普通日志"></a>注册普通日志</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> logging.handlers <span class="keyword">import</span> RoptatingFileHander</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register_logger</span>():</span></span><br><span class="line">    app.logger.setLevel(logging.INFO)</span><br><span class="line">    formatter =  logging.Formatter(<span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;</span>)</span><br><span class="line">    file_handler = RotatingFileHandler(<span class="string">&#x27;/logs/bulelog&#x27;</span> , maxBytes=<span class="number">10</span>*<span class="number">1024</span>*<span class="number">1024</span>,backupCount=<span class="number">10</span>)</span><br><span class="line">    file_handler.setFormatter(formatter)</span><br><span class="line">    file_handler.setLevel(logging.INFO)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> app.debug:</span><br><span class="line">        app.logger.addHandler(file_handler)</span><br></pre></td></tr></table></figure>

<h3 id="注册SMTP日志"><a href="#注册SMTP日志" class="headerlink" title="注册SMTP日志"></a>注册SMTP日志</h3><p>当发生ERROR级异常时 , 发送邮件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register_logging</span>(<span class="params">app</span>):</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">RequestFormatter</span>(<span class="params">logging.Formatter</span>):</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">format</span>(<span class="params">self, record</span>):</span></span><br><span class="line">            record.url = request.url</span><br><span class="line">            record.remote_addr = request.remote_addr</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>(RequestFormatter, self).<span class="built_in">format</span>(record)</span><br><span class="line"></span><br><span class="line">    request_formatter = RequestFormatter(</span><br><span class="line">        <span class="string">&#x27;[%(asctime)s] %(remote_addr)s requested %(url)s\n&#x27;</span></span><br><span class="line">        <span class="string">&#x27;%(levelname)s in %(module)s: %(message)s&#x27;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    formatter = logging.Formatter(<span class="string">&#x27;%(asctime)s - %(name)s - %(levelname)s - %(message)s&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    file_handler = RotatingFileHandler(os.path.join(basedir, <span class="string">&#x27;logs/bluelog.log&#x27;</span>),</span><br><span class="line">                                       maxBytes=<span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span>, backupCount=<span class="number">10</span>)</span><br><span class="line">    file_handler.setFormatter(formatter)</span><br><span class="line">    file_handler.setLevel(logging.INFO)</span><br><span class="line"></span><br><span class="line">    mail_handler = SMTPHandler(</span><br><span class="line">        mailhost=app.config[<span class="string">&#x27;MAIL_SERVER&#x27;</span>],</span><br><span class="line">        fromaddr=app.config[<span class="string">&#x27;MAIL_USERNAME&#x27;</span>],</span><br><span class="line">        toaddrs=[<span class="string">&#x27;ADMIN_EMAIL&#x27;</span>],</span><br><span class="line">        subject=<span class="string">&#x27;Bluelog Application Error&#x27;</span>,</span><br><span class="line">        credentials=(app.config[<span class="string">&#x27;MAIL_USERNAME&#x27;</span>], app.config[<span class="string">&#x27;MAIL_PASSWORD&#x27;</span>]))</span><br><span class="line">    mail_handler.setLevel(logging.ERROR)</span><br><span class="line">    mail_handler.setFormatter(request_formatter)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> app.debug:</span><br><span class="line">        app.logger.addHandler(mail_handler)</span><br><span class="line">        app.logger.addHandler(file_handler)</span><br></pre></td></tr></table></figure>

<h3 id="注册请求钩子"><a href="#注册请求钩子" class="headerlink" title="注册请求钩子"></a>注册请求钩子</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">configure_hook</span>(<span class="params">app</span>):</span></span><br><span class="line"><span class="meta">    @app.before_request</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hello</span>():</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="number">123465789</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @app.after_request</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bye</span>(<span class="params">resp</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="number">123465789</span>)</span><br><span class="line">        <span class="keyword">return</span> resp</span><br></pre></td></tr></table></figure>

<h3 id="注册程序上下文"><a href="#注册程序上下文" class="headerlink" title="注册程序上下文"></a>注册程序上下文</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">configure_context_processors</span>(<span class="params">app</span>):</span></span><br><span class="line"><span class="meta">    @app.context_processor</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">global_style</span>():</span></span><br><span class="line">        sidebar_collapsed_key = <span class="string">&quot;ace_settings.sidebar-collapsed&quot;</span></span><br><span class="line">        <span class="keyword">if</span> sidebar_collapsed_key <span class="keyword">in</span> request.cookies:</span><br><span class="line">            sidebar_collapsed = request.cookies[sidebar_collapsed_key]</span><br><span class="line">            <span class="keyword">if</span> sidebar_collapsed == <span class="string">&quot;1&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> &#123;<span class="string">&quot;sidebar_collapsed&quot;</span>: <span class="literal">True</span>&#125;</span><br><span class="line">        <span class="keyword">return</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="创建注册外部库"><a href="#创建注册外部库" class="headerlink" title="创建注册外部库"></a>创建注册外部库</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> send_from_directory</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UploadManager</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, app=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="keyword">if</span> app <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.init_app(app)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">init_app</span>(<span class="params">self, app</span>):</span></span><br><span class="line">        config_name = os.getenv(<span class="string">&#x27;GAMESDK_KFADMIN_CONFIG_NAME&#x27;</span>) <span class="keyword">or</span> <span class="string">&quot;local&quot;</span></span><br><span class="line">        <span class="keyword">if</span> config_name == <span class="string">&#x27;local&#x27;</span>:</span><br><span class="line"><span class="meta">            @app.route(<span class="params"><span class="string">&#x27;/uploads/&lt;filename&gt;&#x27;</span></span>)</span></span><br><span class="line">            <span class="function"><span class="keyword">def</span> <span class="title">uploaded_file</span>(<span class="params">filename</span>):</span></span><br><span class="line">                <span class="keyword">return</span> send_from_directory(app.config[<span class="string">&quot;STATIC_FILE_UPLOAD_PATH&quot;</span>],</span><br><span class="line">                                           filename)</span><br><span class="line"></span><br><span class="line"><span class="meta">            @app.route(<span class="params"><span class="string">&#x27;/tmpls/&lt;filename&gt;&#x27;</span></span>)</span></span><br><span class="line">            <span class="function"><span class="keyword">def</span> <span class="title">uploaded_tmpl</span>(<span class="params">filename</span>):</span></span><br><span class="line">                <span class="keyword">return</span> send_from_directory(app.config[<span class="string">&quot;CREATIVE_TMPL_PATH&quot;</span>],</span><br><span class="line">                                           filename)</span><br><span class="line"></span><br><span class="line"><span class="meta">            @app.route(<span class="params"><span class="string">&#x27;/excels/&lt;filename&gt;&#x27;</span></span>)</span></span><br><span class="line">            <span class="function"><span class="keyword">def</span> <span class="title">export_excel</span>(<span class="params">filename</span>):</span></span><br><span class="line">                <span class="keyword">return</span> send_from_directory(app.config[<span class="string">&quot;TMP_FILE_PATH&quot;</span>],</span><br><span class="line">                                           filename)</span><br><span class="line"></span><br><span class="line">upload_manager = UploadManager()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">configure_uploads</span>(<span class="params">app</span>):</span></span><br><span class="line">    upload_manager.init_app(app)</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> simplejson <span class="keyword">as</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint, url_for</span><br><span class="line"><span class="keyword">from</span> flask_login <span class="keyword">import</span> LoginManager, current_user</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .login <span class="keyword">import</span> bp</span><br><span class="line"><span class="keyword">from</span> .models.user <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> .cache <span class="keyword">import</span> cache</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OALogin</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, app=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="keyword">if</span> app <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.init_app(app)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">init_app</span>(<span class="params">self, app</span>):</span></span><br><span class="line">        app.config.setdefault(<span class="string">&quot;ZK_LOGIN_SITE_ID&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">        app.config.setdefault(<span class="string">&quot;ZK_LOGIN_SECRET_KEY&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">        app.register_blueprint(bp, url_prefix=<span class="string">&quot;/zkoa&quot;</span>)</span><br><span class="line">        self.configure_loginmanager(app)</span><br><span class="line">        cache[<span class="string">&quot;redis&quot;</span>] = redis.StrictRedis.from_url(app.config[<span class="string">&quot;ZK_REDIS_CACHE_URL&quot;</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 配置上下文</span></span><br><span class="line"><span class="meta">        @app.context_processor</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">project_name</span>():</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">dict</span>(</span><br><span class="line">                site_name=app.config[<span class="string">&#x27;SITE_NAME&#x27;</span>]</span><br><span class="line">            )</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">configure_loginmanager</span>(<span class="params">self, app</span>):</span></span><br><span class="line">        login_manager = LoginManager()</span><br><span class="line">        login_manager.init_app(app)</span><br><span class="line">        login_manager.login_message = <span class="string">u&quot;请先登录&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">        @login_manager.user_loader</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">load_user</span>(<span class="params">userid</span>):</span></span><br><span class="line">            <span class="keyword">return</span> User._get_user_from_cache(userid)</span><br><span class="line"></span><br><span class="line">        login_manager.login_view = <span class="string">&#x27;zkoa.login&#x27;</span></span><br></pre></td></tr></table></figure>



<h2 id="第二章-FLASK与HTTP"><a href="#第二章-FLASK与HTTP" class="headerlink" title="第二章 FLASK与HTTP"></a>第二章 FLASK与HTTP</h2><ul>
<li>Web服务器接收请求，通过<strong>WSGI将HTTP格式的请求数据转换成我们的Flask程序能够使用的Python数据</strong>。</li>
<li>响应依次经过 WSGI 转换生成 HTTP 响应，</li>
</ul>
<h3 id="MutliDict与ImmutableMultiDict"><a href="#MutliDict与ImmutableMultiDict" class="headerlink" title="MutliDict与ImmutableMultiDict"></a>MutliDict与ImmutableMultiDict</h3><ul>
<li>Werkzeug的 MutliDict类是字典的子类，它主要<strong>实现了同一个键对应多个值的情况</strong>。比如一个文件上传字段可能会接收多个文件。这时就可以通过 getlist方法来获取文件对象列表。</li>
<li>而 ImmutableMultiDict类继承了 MutliDict类，但<strong>其值不可更改</strong>。</li>
</ul>
<h3 id="路由表"><a href="#路由表" class="headerlink" title="路由表"></a>路由表</h3><ul>
<li>程序实例中存储了一个路由表（<code>app.url_map</code>），其中定义了URL规则和视图函数的映射关系。</li>
<li>使用 flask routes 命令可以查看程序中定义的所有路由，这个列表由app.url_map解析得到</li>
</ul>
<h3 id="app-route-quot-colors-lt-any-blue-red-color-gt-quot"><a href="#app-route-quot-colors-lt-any-blue-red-color-gt-quot" class="headerlink" title="app.route(&quot;/colors/&lt;any(blue,red):color&gt;&quot;)"></a><code>app.route(&quot;/colors/&lt;any(blue,red):color&gt;&quot;)</code></h3><p>any限定必须是blue或red</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@index_router.route(<span class="params"><span class="string">&quot;/colors/&lt;any(blue,red):color&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">any_test</span>(<span class="params">color</span>):</span></span><br><span class="line">    <span class="keyword">return</span> color</span><br></pre></td></tr></table></figure>



<h3 id="MIME-类型"><a href="#MIME-类型" class="headerlink" title="MIME 类型"></a>MIME 类型</h3><ul>
<li>MIME类型（又称为 media type或 content type）是一种用来标识文件类型的机制，它与文件扩展名相对应，可以<strong>让客户端区分不同的内容类型，并执行不同的操作</strong>。</li>
<li>一般的格式为“类型名/子类型名”，其中的子类型名一般为文件扩展名。比如，HTML的MIME类为“text/html”，png图片的MIME类型为“Image/png”。</li>
<li>常用的数据格式有纯文本、HTML、XML和JSON，</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@index_router.route(<span class="params"><span class="string">&quot;/test/&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">    res = make_response(<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line">    res.mimetype = <span class="string">&#x27;text/plain&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br></pre></td></tr></table></figure>



<h3 id="上下文-1"><a href="#上下文-1" class="headerlink" title="上下文"></a>上下文</h3><ul>
<li>Flask 通过<code>本地线程</code>（ thread local ）技术将请求对象在特定的线程和请求中全局可访问</li>
<li>当<code>请求上下文</code>被激活时，<code>程序上下文</code>也被自动激活 , 当请求处理完毕后，请求上下文和程序上下文也会自动销毁 , 也就是说，在请求处理时这两者拥有相同的生命周期。</li>
</ul>
<p>current_app , g , request , session :</p>
<ul>
<li>四个变量都是<code>代理对象</code>（ proxy ），即指向真实对象的代理 一般情况下，我们不需太关注其中的区别 </li>
<li>在某些特定的情况下，如你需要获取原始对象，可以对代理对象调用<code>＿get_current_ object （）</code>方法获取被代理的真实对象</li>
</ul>
<p>通常会使用<code>g</code>结合请求钩子来保存每个请求处理前所需要的全局变量，比如当前登人的用户对象，数据库连接等 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.before_request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span>():</span></span><br><span class="line">    g.name = request.args.get(<span class="string">&#x27;name&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h4 id="应用上下文和请求上下文"><a href="#应用上下文和请求上下文" class="headerlink" title="应用上下文和请求上下文"></a>应用上下文和请求上下文</h4><ul>
<li>实现线程隔离后，为了在一个线程中更加方便使用这些变量，flask中还有一种堆栈的数据结构，可以处理这些变量，但是并不直接处理这些变量。假如有一个程序得到一个请求，那么flask会将这个请求的所有相关信息进行打包，打包形成的东西就是处理请求的一个环境。flask将这种环境称为“请求上下文”(request context) ,  这样，请求发生时，我们一般都会指向堆栈中的“请求上下文”对象，这样可以通过请求上下文获取相关对象并直接访问</li>
<li>对于单应用单请求来说，使用“请求上下文”确实就可以了。然而，Flask的设计理念之一就是多应用的支持。当在一个应用的请求上下文环境中，需要嵌套处理另一个应用的相关操作时（这种情况更多的是用于测试或者在console中对多个应用进行相关处理），“请求上下文”显然就不能很好地解决问题了，<strong>因为魔法current_app无法确定当前处理的到底是哪个应用</strong>。</li>
<li>如何让请求找到“正确”的应用呢？我们可能会想到，可以再增加一个请求上下文环境，并将其推入栈中。由于两个上下文环境的运行是独立的，不会相互干扰，所以通过调用栈顶对象的app属性或者调用current_app(current_app一直指向栈顶的对象)也可以获得当前上下文环境正在处理哪个应用</li>
<li>在创建“请求上下文”时一定要创建一个“应用上下文”对象。有了“应用上下文”对象，便可以很容易地确定当前处理哪个应用，这就是魔法<code>current_app</code>。</li>
</ul>
<h4 id="激活上下文的四种情况"><a href="#激活上下文的四种情况" class="headerlink" title="激活上下文的四种情况"></a>激活上下文的四种情况</h4><ol>
<li>flask run命令启动程序时. </li>
<li>app.run()方法启动程序时. </li>
<li>执行使用@app.cli command()装饰器注册的flask命令时. </li>
<li>使用 flask shell 命令</li>
</ol>
<h4 id="激活请求上下文-和-程序上下文"><a href="#激活请求上下文-和-程序上下文" class="headerlink" title="激活请求上下文 和 程序上下文"></a>激活请求上下文 和 程序上下文</h4><p>激活程序上下文</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法一</span></span><br><span class="line"><span class="keyword">from</span> app <span class="keyword">import</span> app</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> current_app</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> app.app_context():</span><br><span class="line">    current_app.name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法二</span></span><br><span class="line">app_ctx = app.app_context()</span><br><span class="line">app_ctx.push()</span><br><span class="line">current_app.name</span><br><span class="line">app_ctx.pop()</span><br></pre></td></tr></table></figure>

<p>激活请求上下文</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> app <span class="keyword">import</span> app</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> app.test_request_context(<span class="string">&#x27;/hello&#x27;</span>):</span><br><span class="line">    requese.method</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意 , 因为这单单创建请求上下文 , 没有创建应用上下文 , 因此不能使用<code>current_app</code></p>
</blockquote>
<h4 id="上下文钩子"><a href="#上下文钩子" class="headerlink" title="上下文钩子"></a>上下文钩子</h4><ul>
<li><p>Flask 为上下文提供了<code>teardown_appcontext </code>钩子 , </p>
</li>
<li><p>使用它注册的回调函数会在程序上下文被销毁时调用，而且通常也会在请求上下文被销毁时调用 , </p>
</li>
<li><p>比如，你需要在每个请求处理结束后销毁数据库连接：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.teardown_appcontext</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">teardown_db</span>(<span class="params">exception</span>):</span></span><br><span class="line">    db.close()</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="获取上一个页面的URL"><a href="#获取上一个页面的URL" class="headerlink" title="获取上一个页面的URL"></a>获取上一个页面的URL</h3><p>用户单击某个需要登录才能访问的链接，这时程序会重定向到登录页面，当用户登录后合理的行为是重定向到用户登录前浏览的页面，以便用户执行未完成的操作，而不是直接重定向到主页。</p>
<h4 id="使用referer"><a href="#使用referer" class="headerlink" title="使用referer"></a>使用referer</h4><ul>
<li>referer是一个用来记录请求发源地址的HTTP首部字段（HttpreFerer），即访问来源。</li>
<li>当用户在某个站点单击链接，浏览器向新链接所在的服务器发起请求，请求的数据中包含的Referer字段记录了用户所在的原站点URL。</li>
<li>这个值通常会用来追踪用户，比如记录用户进入程序的外部站点，以此来更有针对性地进行营销。</li>
<li>在 Flask中，referer的值可以通过请求对象的 referrer属性获取，即 request。referrer。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> redirect(request.referrer <span class="keyword">or</span> url_for(<span class="string">&#x27;index&#x27;</span>))</span><br></pre></td></tr></table></figure>



<h4 id="使用query-args"><a href="#使用query-args" class="headerlink" title="使用query args"></a>使用query args</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> redirect(request.args.get(<span class="string">&#x27;next&#x27;</span>,url_for(<span class="string">&#x27;index&#x27;</span>)))</span><br></pre></td></tr></table></figure>



<h4 id="综合上述-url安全认证"><a href="#综合上述-url安全认证" class="headerlink" title="综合上述 + url安全认证"></a>综合上述 + url安全认证</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_safe_url</span>(<span class="params">target</span>):</span></span><br><span class="line">    ref_url = urlparse(request.host_url)</span><br><span class="line">    test_url = urlparse(urljoin(request.host_url, target))</span><br><span class="line">    <span class="keyword">return</span> test_url.scheme <span class="keyword">in</span> (<span class="string">&#x27;http&#x27;</span>, <span class="string">&#x27;https&#x27;</span>) <span class="keyword">and</span> \</span><br><span class="line">           ref_url.netloc == test_url.netloc</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">redirect_back</span>(<span class="params">default=<span class="string">&#x27;hello&#x27;</span>, **kwargs</span>):</span></span><br><span class="line">    <span class="keyword">for</span> target <span class="keyword">in</span> request.args.get(<span class="string">&#x27;next&#x27;</span>), request.referrer:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> target:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> is_safe_url(target):</span><br><span class="line">            <span class="keyword">return</span> redirect(target)</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(default, **kwargs))</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/abc&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_something</span>():</span></span><br><span class="line">    <span class="keyword">return</span> rediect_back()</span><br></pre></td></tr></table></figure>



<h3 id="HTTP服务器端推送"><a href="#HTTP服务器端推送" class="headerlink" title="HTTP服务器端推送"></a>HTTP服务器端推送</h3><ul>
<li><p>不论是传统的HTTP请求-响应式的通信模式，还是异步的AJAX式请求，服务器端始终处于被动的应答状态，只有在客户端发出请求的情况下，服务器端才会返回响应。这种通信模式被称为客户端拉取（client  pul）。在这种模式下，用户只能通过刷新页面或主动单击加载按钮来拉取新数据。</p>
</li>
<li><p>然而，在某些场景下，我们需要的通信模式是服务器端的主动推送（server push）。</p>
</li>
<li><p>比如聊天室 , 实时显示新提醒和私信的数量 , 用户的在线状态更新，股价行情监控、显示商品库存信息、多人游戏、文档协作等</p>
</li>
<li><p>实现服务器端推送的一系列技术被合称为Http Server Push（HTTP服务器端推送）</p>
</li>
</ul>
<p>常用推迭技术</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>传统轮询</td>
<td>在特定的时间间隔内，客户端使用AJAX技术不断向服务器发起HTTP请求，然传统轮询后获取新的数据并更新页面</td>
</tr>
<tr>
<td>长轮询</td>
<td>和传统轮询类似，但是如果服务器端没有返回数据，那就保持连接一直开启，直到有数据时才返回。取回数据后再次发送另一个请求</td>
</tr>
<tr>
<td>Server-Sent Events(SSE)</td>
<td>SSE通过HTML5中的 Event Source API实现. SSE会在客户端和服务器端建立一个单向的通道，客户端监听来自服务器端的数据，而服务器端可以在任意时间发送数据，两者建立类似订阅/发布的通信模式</td>
</tr>
</tbody></table>
<ul>
<li>除了这些推送技术，在HTML5的API中还包含了一个<code>WebSocket</code>协议，</li>
<li>和HTTP不同，它是一种基于TCP协议的全双工通信协议。和前面介绍的服务器端推送技术相比，WebSocket实时性更强，而且可以实现<code>双向通信</code>。另外，Web Socket的浏览器兼容性要强于SSE。</li>
</ul>
<h3 id="注入攻击"><a href="#注入攻击" class="headerlink" title="注入攻击"></a>注入攻击</h3><p>注入攻击包括</p>
<ul>
<li>注入攻击包括系统命令（OS Command）注入、</li>
<li>SQL注人（SQL Injection）、</li>
<li>NOSQL注入、</li>
<li>ORM注入等。</li>
</ul>
<h4 id="XSS攻击"><a href="#XSS攻击" class="headerlink" title="XSS攻击"></a>XSS攻击</h4><p>XSS攻击主要分为反射型XSS攻击（Reflected XSS Attack）和存储型XSS攻击（Stored XSS Attack）两类</p>
<ul>
<li>反射型XSS攻击 又被称为非持久型XSS</li>
<li>反射型XSS 和 存储型XSS 的区别就是会不会存入数据库 , 存入数据库就是永久性攻击了 , 任何用户访问包含攻击代码的页面都会被殃及。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;index&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    name = request.args.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">    response = <span class="string">&#x27;&lt;h1&gt;hello,%s!&lt;h1&gt;&#x27;</span> % name</span><br></pre></td></tr></table></figure>

<p>此时 , 访问<code>http://example.com/index?name=&lt;script&gt;alert(&#39;bingo&#39;);&lt;/script&gt;</code> , 服务端将返回<code>&lt;h1&gt;hello,&lt;script&gt;alert(&#39;bingo&#39;);&lt;/script&gt;!&lt;h1&gt;</code></p>
<h4 id="转义"><a href="#转义" class="headerlink" title="转义"></a>转义</h4><p>jinja2自带转义函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jinja2 <span class="keyword">import</span> escape</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;index&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    name = request.args.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&lt;h1&gt;hello,%s!&lt;h1&gt;&#x27;</span> % escape(name)</span><br></pre></td></tr></table></figure>



<p>转义无法防御的情况</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jinja2 <span class="keyword">import</span> escape</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;index&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    name = request.args.get(<span class="string">&#x27;url&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&lt;a href=&quot;&#123;&#123; url &#125;&#125;&quot; &gt;Website&lt;/a&gt; &#x27;</span>.<span class="built_in">format</span>(url=url)</span><br></pre></td></tr></table></figure>

<p>当传入的url为<code>javascript:alert(&#39;bingo&#39;)</code> , 因为不包含会被转义的&lt; 和 &gt; , 会返回</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:alert(&#x27;bingo&#x27;);&quot;</span>&gt;</span>Website<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>用户点击即可运行</p>
<h4 id="将危险文本转为Markup对象进行防御"><a href="#将危险文本转为Markup对象进行防御" class="headerlink" title="将危险文本转为Markup对象进行防御"></a>将危险文本转为Markup对象进行防御</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Markup</span><br><span class="line"></span><br><span class="line"><span class="meta">@index_router.route(<span class="params"><span class="string">&quot;/test/&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">    text = Markup(<span class="string">&#x27;&lt;h1&gt;Hello Flask!&lt;h1&gt;&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, text=text)</span><br></pre></td></tr></table></figure>

<p>这时在模板中可以直接使用<code>&#123;&#123; text &#125; &#125;</code></p>
<h4 id="CSRF攻击"><a href="#CSRF攻击" class="headerlink" title="CSRF攻击"></a>CSRF攻击</h4><p>简单来讲 , 在我的网站放置一个</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>= <span class="string">&quot;http://example.com/account/delete”&gt;</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>用户一点击 , 就会访问example.com , </li>
<li>就算我们改用POST请求提交删除账户的请求。攻击者只需要在网站中内嵌一个隐藏表单，然后设置在页面加载后执行提交表单的 JavaScript函数，攻击仍然会在用户点击时发起。</li>
</ul>
<h4 id="CSRF攻击防御"><a href="#CSRF攻击防御" class="headerlink" title="CSRF攻击防御"></a>CSRF攻击防御</h4><ul>
<li><p>只使用GET和POST两种</p>
</li>
<li><p>GET方法属于安全方法，不会改变资源状态，仅用于获取资源，因此又被称为幂等方法（idempotent<br>method）。页面中所有可以通过链接发起的请求都属于GET请求。</p>
</li>
<li><p>POST方法用于创建、修改和删除资源。在HTML中使用form标签创建表单并设置提交方法为POST，在提交时会创建POST请求。</p>
</li>
<li><p>CSRF令牌校验 :</p>
<p>当处理非GET请求时，要想避免CSRF攻击，关键在于判断请求是否来自自己的网站。在前面我们曾经介绍过使用 Http  referer获取请求来源，理论上说，通过 referer可以判断源站点从而避免CSRF攻击，但因为  referer很容易被修改和伪造，所以不能作为主要的防御措施。</p>
<p>除了在表单中加入验证码外，一般的做法是通过在客户端页面中加入伪随机数来防御CSRF攻击，这个伪随机数通常被称为CSRF令牌（token）。</p>
<p>POST方法的请求通过表单创建。我们把在服务器端创建的伪随机数（CSRF令牌）添加到表单中的隐藏字段里和 session变量（即签名 cookie）中，当用户提交表单时，这个令牌会和表单数据一起提交。在服务器端处理POST请求时，我们会对表单中的令牌值进行验证，如果表单中的令牌值和 session中的令牌值相同，那么就说明请求发自自己的网站。</p>
<blockquote>
<p>对于AJAX请求，我们可以在 XmlhTtpreoμuest请求首部添加一个自定义字段X-CSRFToken来保存CSRF令牌。</p>
</blockquote>
</li>
</ul>
<p><strong>如果程序包含XSS漏洞，那么攻击者可以使用跨站脚本攻破CSRF防御机制，比如使用 JavaScript窃取 cookie内容，进而获取CSRF令牌</strong></p>
<h2 id="第三章-模板"><a href="#第三章-模板" class="headerlink" title="第三章 模板"></a>第三章 模板</h2><h3 id="注册模板上下文变量"><a href="#注册模板上下文变量" class="headerlink" title="注册模板上下文变量"></a>注册模板上下文变量</h3><p>如果多个模板都需要使用同一变量，那么比起在多个视图函数中重复传入，更好的方法是能够设置一个模板全局变量。Flask提供了一个 app.context_processor装饰器，可以用来注册模板上下文处理函数，它可以帮我们完成统一传入变量的工作。<strong>模板上下文处理函数需要返回个包含变量键值对的字典</strong>，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">configure_processor</span>(<span class="params">app</span>):</span></span><br><span class="line"><span class="meta">    @app.context_processor</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inject_foo</span>():</span></span><br><span class="line">        foo = <span class="string">&#x27;I am foo&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">dict</span>(foo=foo)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">    &#123;&#123; foo &#125;&#125;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>和在 render template函数中传入变量类似，除了字符串、列表等数据结构，你也可以传入函数、类或类实例。</p>
</blockquote>
<h3 id="注册模板方法"><a href="#注册模板方法" class="headerlink" title="注册模板方法"></a>注册模板方法</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">configure_template_function</span>(<span class="params">app</span>):</span></span><br><span class="line"><span class="meta">    @app.template_global()</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bar</span>():</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;i am template function&#x27;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>@app.template_global()</code> 和 <code>@app.context_processor</code> 的区别:</p>
<p>前者专门用来<strong>创建模板函数</strong> , 后者<strong>创建模板变量</strong>(自然也可以用来创建函数)</p>
</blockquote>
<h3 id="Jinja2-内置模板全局函数"><a href="#Jinja2-内置模板全局函数" class="headerlink" title="Jinja2 内置模板全局函数"></a>Jinja2 内置模板全局函数</h3><table>
<thead>
<tr>
<th>函数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>range([start,]stop,step])</td>
<td>和 Python中的 range用法相同</td>
</tr>
<tr>
<td>lipsum(n=5,html=True,min=20,max=100)</td>
<td>生成随机文本(lorem ipsum),可以在测试时用来填充页面.默认生成5段HTML文本,每段包含20~100个单词</td>
</tr>
<tr>
<td>dict(**items)</td>
<td>和 Python中的dict用法相同</td>
</tr>
<tr>
<td>url_for()</td>
<td>用于生成URL的函数</td>
</tr>
<tr>
<td>get_ flashed_ messages()</td>
<td>用于获取 flash消息的函数</td>
</tr>
</tbody></table>
<p>全部的全局函数请看 : <a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/2.10.x/templates/#list-of-global-functions">https://jinja.palletsprojects.com/en/2.10.x/templates/#list-of-global-functions</a></p>
<h3 id="filter的另一种使用方法"><a href="#filter的另一种使用方法" class="headerlink" title="filter的另一种使用方法"></a>filter的另一种使用方法</h3><p>一般filter是用于变量的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; nameltitle &#125;&#125; </span><br></pre></td></tr></table></figure>

<p>但是 , 也可以用于文本 , 此时包含的所有文本当成第一参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% filter upper %&#125;</span><br><span class="line">    i am a student</span><br><span class="line">&#123;% endfilter %&#125;</span><br></pre></td></tr></table></figure>

<p>自定义的filter也可以</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.template_filter()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_upper2</span>(<span class="params">v1, v2=<span class="string">&#x27;asd&#x27;</span></span>):</span></span><br><span class="line"><span class="keyword">return</span> <span class="string">f&#x27;-- <span class="subst">&#123;v1.upper()&#125;</span> -- <span class="subst">&#123;v2.upper()&#125;</span>&#x27;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% filter my_upper2 %&#125;</span><br><span class="line">    i am a student</span><br><span class="line">&#123;% endfilter %&#125;</span><br></pre></td></tr></table></figure>



<h3 id="测试器"><a href="#测试器" class="headerlink" title="测试器"></a>测试器</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if age is number %&#125;</span><br><span class="line">    &#123;&#123; age * 365 &#125;&#125;</span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">    无效数字</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

<p>常用测试器</p>
<table>
<thead>
<tr>
<th>测试器</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>callable（object）</td>
<td>判断对象是否可被调用</td>
</tr>
<tr>
<td>defined（value）</td>
<td>判断变量是否已定义</td>
</tr>
<tr>
<td>undefined（value）</td>
<td>判断变量是否未定义</td>
</tr>
<tr>
<td>none（value）</td>
<td>判断变量是否为None</td>
</tr>
<tr>
<td>number（value）</td>
<td>判断变量是否是数字</td>
</tr>
<tr>
<td>string（value）</td>
<td>判断变量是否是字符串</td>
</tr>
<tr>
<td>sequence（value）</td>
<td>判断变量是否是序列，比如字符串、列表、元组</td>
</tr>
<tr>
<td>iterable（value）</td>
<td>判断变量是否可迭代</td>
</tr>
<tr>
<td>mapping（value）</td>
<td>判断变量是否是匹配对象，比如字典</td>
</tr>
<tr>
<td>sameas（value，other）</td>
<td>判断变量与 other是否指向相同的内存地址</td>
</tr>
</tbody></table>
<p>全部测试器 , 查看 : <a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/2.10.x/templates/#list-of-builtin-tests">https://jinja.palletsprojects.com/en/2.10.x/templates/#list-of-builtin-tests</a></p>
<h3 id="jinja-env"><a href="#jinja-env" class="headerlink" title="jinja_env"></a>jinja_env</h3><ul>
<li><p>在Jinja2中,渲染行为由Jinja2.Enviroment类控制 , 所有的配置选项、上下文变量、全局函数、过滤器和测试器都存储在 Enviroment实例上</p>
</li>
<li><p>我们可以使用<code>current_app.jinja_env</code> 获取这个Enviroment类 , 可以通过<code>current_app.jinja_env.__dict__.keys()</code>查看该类的所有属性</p>
</li>
<li><p>模板环境中的全局函数、过滤器和测试器分别存储在 Enviroment对象的 globals、filters和tests属性中</p>
</li>
<li><p>注册装饰器其实本质就是<strong>往jinja_env属性添加变量</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.template_global()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bar</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;i am bar&#x27;</span></span><br></pre></td></tr></table></figure>

<p>等价于</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bar</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;i am bar&#x27;</span></span><br><span class="line"></span><br><span class="line">app.jinja_env.<span class="built_in">globals</span>[<span class="string">&#x27;bar&#x27;</span>] = bar</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>app.template_global()</code>的源码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@setupmethod</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_template_global</span>(<span class="params">self, f, name=<span class="literal">None</span></span>):</span></span><br><span class="line">    self.jinja_env.<span class="built_in">globals</span>[name <span class="keyword">or</span> f.__name__] = f</span><br></pre></td></tr></table></figure></blockquote>
</li>
</ul>
<h3 id="宏"><a href="#宏" class="headerlink" title="宏"></a>宏</h3><p>为了便于管理,我们可以把宏存储在单独的文件中,这个文件通常命名为 <code>macros.html</code>或<code>_macors.html</code></p>
<p><code>&#123;% %&#125;</code> 和 <code>&#123;-% %&#125;</code>的区别</p>
<ul>
<li><p>前者不会移除空行 , 后者会移除空行</p>
</li>
<li><p><code>&#123;-% %&#125;</code>的<code>-</code>放置规则是 , end语句在左边 , 其他的语句都在右边</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if string == &#x27;heyingliang&#x27; -%&#125;</span><br><span class="line">    &#123;&#123; string &#125;&#125;</span><br><span class="line">&#123;% else -%&#125;</span><br><span class="line">    无效数字</span><br><span class="line">&#123;%- endif %&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>也可以使用模板环境对象提供的 <code>trim blocks</code>和<code>Istrip blocks</code>属性设置，前者用来删除 Jinja2语句后的第一个空行，后者则用来删除 Jinja2语句所在行之前的空格和制表符（tabs）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app.jinja_env.trim_blocks = <span class="literal">True</span></span><br><span class="line">app.jinja_env.lstrip_blocks = <span class="literal">True</span></span><br></pre></td></tr></table></figure></li>
<li><p>事实上，我们没有必要严格控制HTML输出，因为多余的空白并不影响浏览器的解析。</p>
</li>
</ul>
<h3 id="设置favicon-ico"><a href="#设置favicon-ico" class="headerlink" title="设置favicon.ico"></a>设置favicon.ico</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;link rel=&#x27;icon&#x27; type=&#x27;image/x-icon&#x27; href=&#x27;&#123;&#123; url_for(&#x27;static&#x27;,filename=&#x27;favicon&#x27;.ico&#x27;) &#125;&#125;&#x27;&gt;</span><br></pre></td></tr></table></figure>



<h3 id="使用宏加载静态资源"><a href="#使用宏加载静态资源" class="headerlink" title="使用宏加载静态资源"></a>使用宏加载静态资源</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% macro static_file(type, filename_or_url, local=True) %&#125;</span><br><span class="line">    &#123;% if local -%&#125;</span><br><span class="line">        &#123;% set filename_or_url = url_for(&#x27;static&#x27;, filename=filename_or_url) %&#125;</span><br><span class="line">    &#123;%- endif %&#125;</span><br><span class="line">    </span><br><span class="line">    &#123;% if type == &#x27;css&#x27; -%&#125;</span><br><span class="line">        &lt;link rel=&quot;stylesheet&quot; href=&quot;&#123;&#123; filename_or_url &#125;&#125;&quot; type=&quot;text/css&quot;&gt;</span><br><span class="line">    &#123;%- elif type == &#x27;js&#x27; -%&#125;</span><br><span class="line">        &lt;script type=&quot;text/javascript&quot; src=&quot;&#123;&#123; filename_or_url &#125;&#125;&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &#123;%- elif type == &#x27;icon&#x27; -%&#125;</span><br><span class="line">        &lt;link rel=&quot;icon&quot; href=&quot;&#123;&#123; filename_or_url &#125;&#125;&quot;&gt;</span><br><span class="line">    &#123;%- endif %&#125;</span><br><span class="line">&#123;% endmacro %&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">static_file(&#x27;css&#x27;,&#x27;css/bootstrap.min.css&#x27;)</span><br><span class="line">static_file(&#x27;css&#x27;,&#x27; https //maxcdn.../css/bootstrap.min.css&#x27;, l ocal=False)</span><br></pre></td></tr></table></figure>



<h3 id="消息闪现的固定jinja模板"><a href="#消息闪现的固定jinja模板" class="headerlink" title="消息闪现的固定jinja模板"></a>消息闪现的固定jinja模板</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if get_flashed_messages() %&#125;</span><br><span class="line">    &#123;% for category, message in get_flashed_messages(with_categories=true) %&#125;</span><br><span class="line">        &lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">            &#123;% if category==&quot;success&quot; %&#125;</span><br><span class="line">                layer.msg(&quot;&#123;&#123; message &#125;&#125;&quot;, &#123;time: 3000, icon: 6&#125;);</span><br><span class="line">            &#123;% else %&#125;</span><br><span class="line">                layer.msg(&quot;&#123;&#123; message &#125;&#125;&quot;, &#123;time: 5000, icon: 5&#125;);</span><br><span class="line">            &#123;% endif %&#125;</span><br><span class="line">        &lt;/script&gt;</span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>



<h3 id="自定义JS或CSS变量"><a href="#自定义JS或CSS变量" class="headerlink" title="自定义JS或CSS变量"></a>自定义JS或CSS变量</h3><p>自定义JS或CSS变量时 , 一般都要加入<code>data-</code>前缀 以示区别:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;span data-id=&quot;&#123;&#123; user.id &#125;&#125;&quot; data-username=&quot;&#123;&#123; user.username &#125;&#125;&quot;&gt;&#123;&#123; user.username &#125;&#125;&lt;/span&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">    :root &#123;</span><br><span class="line">    --theme-color:&#123;&#123; theme_color &#125;&#125;;</span><br><span class="line">    --background-url: &#123;&#123; url_for(&#x27;static&#x27;,filename=&#x27;background.jpg&#x27;) &#125;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>



<h2 id="第四章-表单"><a href="#第四章-表单" class="headerlink" title="第四章 表单"></a>第四章 表单</h2><h3 id="WTForms实例化字段常用参数"><a href="#WTForms实例化字段常用参数" class="headerlink" title="WTForms实例化字段常用参数"></a>WTForms实例化字段常用参数</h3><table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>label</td>
<td>字段标签&lt; label&gt;的值，也就是渲染后显示在输入字段前的文字</td>
</tr>
<tr>
<td>render_kw</td>
<td>字典,用来设置对应的HTML&lt; Input&gt;标签的属性,比如传人{placeholder’:”YourName},渲染后的HTML代码会将&lt; Input&gt;标签的 placeholder属性设为 Your name</td>
</tr>
<tr>
<td>validator</td>
<td>列表,包含一系列验证器,会在表单提交后被逐一调用验证表单数据</td>
</tr>
<tr>
<td>default</td>
<td>字符串或可调用对象,用来为表单字段设置默认值</td>
</tr>
</tbody></table>
<h3 id="WTForms常用验证器"><a href="#WTForms常用验证器" class="headerlink" title="WTForms常用验证器"></a>WTForms常用验证器</h3><table>
<thead>
<tr>
<th>验证器</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>DataRequired（message=None）</td>
<td>验证数据是否有效</td>
</tr>
<tr>
<td>Email（message None）</td>
<td>验证 Email地址</td>
</tr>
<tr>
<td>EqualTo（fieldname，message=None）</td>
<td>验证两个字段值是否相同</td>
</tr>
<tr>
<td>InputRequired（message=None）</td>
<td>验证是否有数据</td>
</tr>
<tr>
<td>Length（min=-1，max=-1，message=None）</td>
<td>验证输入值长度是否在给定范围内</td>
</tr>
<tr>
<td>Number Range（min=None，max=None，message=None）</td>
<td>验证输入数字是否在给定范围内</td>
</tr>
<tr>
<td>Optional（strip whitespace=True）</td>
<td>允许输入值为空，并跳过其他验证</td>
</tr>
<tr>
<td>Regexp（regex，flags=0，message=None</td>
<td>使用正则表达式验证输入</td>
</tr>
<tr>
<td>URL（require tld=True，message=None）</td>
<td>验证URL</td>
</tr>
<tr>
<td>Anyof（values，message=None，values formatter=None）</td>
<td>确保输人值在可选值列表中</td>
</tr>
<tr>
<td>Noneof（values，message=None，values formatter=None</td>
<td>确保输入值不在可选值列表中</td>
</tr>
</tbody></table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_wtf <span class="keyword">import</span> FlaskForm</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> StringField, IntegerField, SelectField,SubmitField</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Act2ndAnniversaryForm</span>(<span class="params">FlaskForm</span>):</span></span><br><span class="line">    start_date = TextField(</span><br><span class="line">        label=<span class="string">u&quot;开始日期&quot;</span>,</span><br><span class="line">        validators=[validators.DataRequired(<span class="string">u&quot;开始日期是必选项&quot;</span>)]</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<blockquote>
<p>InputRequired验证器和 DataRequired很相似，但 </p>
<ul>
<li>InputRequired仅验证用户是否有输入，而不管输入的值是否有效。例如，由空格组成的数据也会通过验证。</li>
<li>当使用DataRequired时，如果用户输入的数据不符合字段要求，比如在 IntegerField输入非数字时会视为未输入，而不是类型错误。</li>
</ul>
</blockquote>
<p><strong>Field实例化就是HTML代码</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">form = LoginForm()</span><br><span class="line"><span class="built_in">print</span>(form.username())</span><br><span class="line"><span class="comment"># &quot;&lt;input id=&#x27;username&#x27; name=&#x27;username&#x27; type=&#x27;text&#x27; value=&#x27;&#x27;&gt;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(form.username.label())</span><br><span class="line"><span class="comment"># &quot;&lt;label for=&#x27;username&#x27;&gt;Username&lt;/label&gt;&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>默认情况下，WTForms输出的字段HTML代码只会包含id和name属性，属性值均为表单类中对应的字段属性名称。如果要添加额外的属性，通常有两种方法。</p>
<ol>
<li>使用render_kw : <code>username = StringField(Username ’, render_kw=&#123; ’ placeholder’:’Your Username ’ &#125;) </code></li>
<li>在调用宇段时传入 : <code>form.username(style=’ width: 200px;’ class_= ’ bar ’ ) </code></li>
</ol>
</blockquote>
<blockquote>
<p>通过上面的方法也可以修改id和name属性，但表单被提交后，WTForms需要通过name属性来获取对应的数据，所以不能修改name属性值。</p>
</blockquote>
<h3 id="form-csrf-token字段-和form-hidden-tag-方法的区别"><a href="#form-csrf-token字段-和form-hidden-tag-方法的区别" class="headerlink" title="form.csrf_token字段 和form.hidden_tag()方法的区别"></a>form.csrf_token字段 和form.hidden_tag()方法的区别</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; form.csrf_token &#125;&#125;</span><br><span class="line">&#123;&#123; form.hidden_tag() &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>form.hidden tag()方法会依次渲染表单中所有的隐藏字段。因为 csrf_token字段也是隐藏字段，所以当这个方法被调用时也会渲染 csrf_token字段。</p>
<h3 id="PRG（Post-Redirect-Get）模式"><a href="#PRG（Post-Redirect-Get）模式" class="headerlink" title="PRG（Post/Redirect/Get）模式"></a>PRG（Post/Redirect/Get）模式</h3><ul>
<li>在浏览器中，当单击F5刷新/重载时的默认行为是发送上一个请求。如果上一个请求是POST请求，那么就会弹出一个确认窗口，询问用户是否再次提交表单。</li>
<li>为了避免出现这个容易让人产生困惑的提示，我们尽量不要让提交表单的POST请求作为最后一个请求。这就是为什么我们在处理表单后返回一个重定向响应，这会让浏览器重新发送一个新的GET请求到重定向的目标URL。最终，最后一个请求就变成了GET请求。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@dept_router.route(<span class="params"><span class="string">&#x27;/editDept/&lt;int:id&gt;&#x27;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>, ]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dept_edit</span>(<span class="params"><span class="built_in">id</span></span>):</span></span><br><span class="line">    g.<span class="built_in">id</span> = <span class="built_in">id</span></span><br><span class="line">    dept = Department.get_by_id(<span class="built_in">id</span>)</span><br><span class="line">    form = DeparmentEditForm(request.form, obj=dept)</span><br><span class="line">    <span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">        form.populate_obj(dept)</span><br><span class="line">        db.session.commit()</span><br><span class="line">        flash(<span class="string">&quot;修改成功&quot;</span>, category=<span class="string">&quot;success&quot;</span>)</span><br><span class="line">        <span class="comment"># 返回redirect</span></span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;dept.dept_detail&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;dept/dept_edit.html&#x27;</span>, form=form, <span class="built_in">id</span>=<span class="built_in">id</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>简单来说 , <strong>每次处理POST请求后 , 服务端都要返回redirect</strong></p>
</blockquote>
<h3 id="WTF本地化"><a href="#WTF本地化" class="headerlink" title="WTF本地化"></a>WTF本地化</h3><p>内置错误消息语言设为简体中文 :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_wtf <span class="keyword">import</span> FlaskForm</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;WTF_I18N_ENABLED&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyBaseForm</span>(<span class="params">FlaskForm</span>):</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        locales = [<span class="string">&#x27;zh&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DomainForm</span>(<span class="params">MyBaseForm</span>):</span></span><br><span class="line">    name = StringField(<span class="string">&#x27;域名&#x27;</span>, render_kw=&#123;<span class="string">&#x27;readonly&#x27;</span>: <span class="string">&#x27;readonly&#x27;</span>&#125;)</span><br><span class="line">    rr = StringField(<span class="string">&#x27;主机记录&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h3 id="form-field的宏"><a href="#form-field的宏" class="headerlink" title="form_field的宏"></a>form_field的宏</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;% macro form_field(field) %&#125;</span><br><span class="line">    &#123;&#123; field.label &#125;&#125;&lt;br&gt;</span><br><span class="line">    &#123;&#123; field(**kwargs) &#125;&#125;&lt;br&gt;</span><br><span class="line">    &#123;% if field.errors -%&#125;</span><br><span class="line">        &#123;% for error in field.errors -%&#125;</span><br><span class="line">            &lt;small class=&quot;error&quot;&gt;&#123;&#123; error &#125;&#125;&lt;/small&gt;&lt;br&gt;</span><br><span class="line">        &#123;%- endfor %&#125;</span><br><span class="line">    &#123;%- endif %&#125;</span><br><span class="line">&#123;% endmacro %&#125;</span><br></pre></td></tr></table></figure>



<h3 id="WTForm的行内和全局validator"><a href="#WTForm的行内和全局validator" class="headerlink" title="WTForm的行内和全局validator"></a>WTForm的行内和全局validator</h3><p>最常用的 , 被称为<code>行内验证器</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> wtforms.validators <span class="keyword">import</span> ValidationError</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DeparmentAddForm</span>(<span class="params">DeparmentForm</span>):</span></span><br><span class="line">    submit = SubmitField(<span class="string">&#x27;添加&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_id</span>(<span class="params">self, field</span>):</span></span><br><span class="line">        did = field.data</span><br><span class="line">        <span class="keyword">if</span> Department.query.filter_by(did=did).first():</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">&#x27;部门号已存在&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><code>全局验证器</code> , 就是使用field的validators属性</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_22</span>(<span class="params">message=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> message <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        message = <span class="string">&#x27;Must be 22&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_is_22</span>(<span class="params">form,filed</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">int</span>(filed.data) != <span class="number">22</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">&#x27;不是22&#x27;</span>) </span><br><span class="line">    <span class="keyword">return</span> _is_22</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DeparmentAddForm</span>(<span class="params">DeparmentForm</span>):</span></span><br><span class="line">    submit = SubmitField(<span class="string">&#x27;添加&#x27;</span>,validators=[is_22(message=<span class="string">&#x27;必须是22&#x27;</span>)])</span><br></pre></td></tr></table></figure>



<h3 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h3><h4 id="单文件-与-多文件上传通用代码"><a href="#单文件-与-多文件上传通用代码" class="headerlink" title="单文件 与 多文件上传通用代码"></a>单文件 与 多文件上传通用代码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">allowed_file</span>(<span class="params">filename</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;.&#x27;</span> <span class="keyword">in</span> filename <span class="keyword">and</span> \</span><br><span class="line">           filename.rsplit(<span class="string">&#x27;.&#x27;</span>, <span class="number">1</span>)[<span class="number">1</span>].lower() <span class="keyword">in</span> app.config[<span class="string">&#x27;ALLOWED_EXTENSIONS&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># upload form</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UploadForm</span>(<span class="params">FlaskForm</span>):</span></span><br><span class="line">    photo = FileField(<span class="string">&#x27;Upload Image&#x27;</span>, validators=[FileRequired(), FileAllowed([<span class="string">&#x27;jpg&#x27;</span>, <span class="string">&#x27;jpeg&#x27;</span>, <span class="string">&#x27;png&#x27;</span>, <span class="string">&#x27;gif&#x27;</span>])])</span><br><span class="line">    submit = SubmitField()</span><br><span class="line"></span><br><span class="line"><span class="comment"># multiple files upload form</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultiUploadForm</span>(<span class="params">FlaskForm</span>):</span></span><br><span class="line">    photo = MultipleFileField(<span class="string">&#x27;Upload Image&#x27;</span>, validators=[DataRequired()])</span><br><span class="line">    submit = SubmitField()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">random_filename</span>(<span class="params">filename</span>):</span></span><br><span class="line">    ext = os.path.splitext(filename)[<span class="number">1</span>]</span><br><span class="line">    new_filename = uuid.uuid4().<span class="built_in">hex</span> + ext</span><br><span class="line">    <span class="keyword">return</span> new_filename</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/upload&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span>():</span></span><br><span class="line">    form = UploadForm()</span><br><span class="line">    <span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">        f = form.photo.data</span><br><span class="line">        filename = random_filename(f.filename)</span><br><span class="line">        f.save(os.path.join(app.config[<span class="string">&#x27;UPLOAD_PATH&#x27;</span>], filename))</span><br><span class="line">        flash(<span class="string">&#x27;Upload success.&#x27;</span>)</span><br><span class="line">        session[<span class="string">&#x27;filenames&#x27;</span>] = [filename]</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;show_images&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;upload.html&#x27;</span>, form=form)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/multi-upload&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">multi_upload</span>():</span></span><br><span class="line">    form = MultiUploadForm()</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        filenames = []</span><br><span class="line"></span><br><span class="line">        <span class="comment"># check csrf token</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            validate_csrf(form.csrf_token.data)</span><br><span class="line">        <span class="keyword">except</span> ValidationError:</span><br><span class="line">            flash(<span class="string">&#x27;CSRF token error.&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;multi_upload&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># check if the post request has the file part</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;photo&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">            flash(<span class="string">&#x27;This field is required.&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;multi_upload&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> f <span class="keyword">in</span> request.files.getlist(<span class="string">&#x27;photo&#x27;</span>):</span><br><span class="line">            <span class="comment"># if user does not select file, browser also</span></span><br><span class="line">            <span class="comment"># submit a empty part without filename</span></span><br><span class="line">            <span class="comment"># if f.filename == &#x27;&#x27;:</span></span><br><span class="line">            <span class="comment">#     flash(&#x27;No selected file.&#x27;)</span></span><br><span class="line">            <span class="comment">#    return redirect(url_for(&#x27;multi_upload&#x27;))</span></span><br><span class="line">            <span class="comment"># check the file extension</span></span><br><span class="line">            <span class="keyword">if</span> f <span class="keyword">and</span> allowed_file(f.filename):</span><br><span class="line">                filename = random_filename(f.filename)</span><br><span class="line">                f.save(os.path.join(</span><br><span class="line">                    app.config[<span class="string">&#x27;UPLOAD_PATH&#x27;</span>], filename</span><br><span class="line">                ))</span><br><span class="line">                filenames.append(filename)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                flash(<span class="string">&#x27;Invalid file type.&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;multi_upload&#x27;</span>))</span><br><span class="line">        flash(<span class="string">&#x27;Upload success.&#x27;</span>)</span><br><span class="line">        session[<span class="string">&#x27;filenames&#x27;</span>] = filenames</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;show_images&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;upload.html&#x27;</span>, form=form)</span><br></pre></td></tr></table></figure>

<p><code>MAX_CONTENT_LENGTH</code> : 限制文件上传大小</p>
<h4 id="secure-filename函数"><a href="#secure-filename函数" class="headerlink" title="secure_filename函数"></a>secure_filename函数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> werkzeug <span class="keyword">import</span> secure_filename</span><br><span class="line">filename = secure_filename(<span class="string">&#x27;avatar!&amp;^%$.jpg&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h3 id="使用Flask-CKEditor-集成富文本编辑器"><a href="#使用Flask-CKEditor-集成富文本编辑器" class="headerlink" title="使用Flask-CKEditor 集成富文本编辑器"></a>使用Flask-CKEditor 集成富文本编辑器</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install flask-ckeditor</span><br></pre></td></tr></table></figure>

<p>详见 : <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/38643309">https://zhuanlan.zhihu.com/p/38643309</a></p>
<h3 id="单个表单多个提交按钮"><a href="#单个表单多个提交按钮" class="headerlink" title="单个表单多个提交按钮"></a>单个表单多个提交按钮</h3><ul>
<li>在某些情况下，我们可能需要为一个表单添加多个提交按钮。比如在创建文章的表单中添加发布新文章和保存草稿的按钮。</li>
<li>当用户提交表单时，我们需要在视图函数中根据按下的按钮来做出不同的处理。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># multiple submit button</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NewPostForm</span>(<span class="params">FlaskForm</span>):</span></span><br><span class="line">    title = StringField(<span class="string">&#x27;Title&#x27;</span>, validators=[DataRequired(), Length(<span class="number">1</span>, <span class="number">50</span>)])</span><br><span class="line">    body = TextAreaField(<span class="string">&#x27;Body&#x27;</span>, validators=[DataRequired()])</span><br><span class="line">    save = SubmitField(<span class="string">&#x27;Save&#x27;</span>)   <span class="comment"># 保存按钮</span></span><br><span class="line">    publish = SubmitField(<span class="string">&#x27;Publish&#x27;</span>) <span class="comment"># 发布按钮</span></span><br></pre></td></tr></table></figure>

<ul>
<li>当表单数据通过POST请求提交时，Flask会把表单数据解析到 request.form字典。</li>
<li>如果表单中有两个提交字段，那么只有被单击的提交字段才会出现在这个字典中。当我们对表单类实例或特定的字段属性调用data属性时，WTForms会对数据做进一步处理。对于提交字段的值，会将其转换为布尔值：<strong>被单击的提交字段的值将是True，未被单击的值则是 False</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/two-submits&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">two_submits</span>():</span></span><br><span class="line">    form = NewPostForm()</span><br><span class="line">    <span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">        <span class="keyword">if</span> form.save.data:</span><br><span class="line">            <span class="comment"># save it...</span></span><br><span class="line">            flash(<span class="string">&#x27;You click the &quot;Save&quot; button.&#x27;</span>)</span><br><span class="line">        <span class="keyword">elif</span> form.publish.data:</span><br><span class="line">            <span class="comment"># publish it...</span></span><br><span class="line">            flash(<span class="string">&#x27;You click the &quot;Publish&quot; button.&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;2submit.html&#x27;</span>, form=form)</span><br></pre></td></tr></table></figure>



<h3 id="单个页面多个表单"><a href="#单个页面多个表单" class="headerlink" title="单个页面多个表单"></a>单个页面多个表单</h3><ul>
<li>在程序的主页上同时添加登录和注册表单。</li>
<li>当在同一个页面上添加多个表单时，我们要解决的个问题就是在视图函数中判断当前被提交的是哪个表单。</li>
</ul>
<h4 id="单视图处理"><a href="#单视图处理" class="headerlink" title="单视图处理"></a>单视图处理</h4><ul>
<li>被单击的提交字段最终的data属性值是布尔值即True或 False。</li>
<li>为了区分两个submit , 为两个表单的提交字段设置不同的名称submit1 , submit2</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SigninForm</span>(<span class="params">FlaskForm</span>):</span></span><br><span class="line">    username = StringField(<span class="string">&#x27;Username&#x27;</span>, validators=[DataRequired(), Length(<span class="number">1</span>, <span class="number">20</span>)])</span><br><span class="line">    password = PasswordField(<span class="string">&#x27;Password&#x27;</span>, validators=[DataRequired(), Length(<span class="number">8</span>, <span class="number">128</span>)])</span><br><span class="line">    submit1 = SubmitField(<span class="string">&#x27;Sign in&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterForm</span>(<span class="params">FlaskForm</span>):</span></span><br><span class="line">    username = StringField(<span class="string">&#x27;Username&#x27;</span>, validators=[DataRequired(), Length(<span class="number">1</span>, <span class="number">20</span>)])</span><br><span class="line">    email = StringField(<span class="string">&#x27;Email&#x27;</span>, validators=[DataRequired(), Email(), Length(<span class="number">1</span>, <span class="number">254</span>)])</span><br><span class="line">    password = PasswordField(<span class="string">&#x27;Password&#x27;</span>, validators=[DataRequired(), Length(<span class="number">8</span>, <span class="number">128</span>)])</span><br><span class="line">    submit2 = SubmitField(<span class="string">&#x27;Register&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>视图函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/multi-form&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">multi_form</span>():</span></span><br><span class="line">    signin_form = SigninForm()</span><br><span class="line">    register_form = RegisterForm()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> signin_form.submit1.data <span class="keyword">and</span> signin_form.validate():</span><br><span class="line">        username = signin_form.username.data</span><br><span class="line">        flash(<span class="string">&#x27;%s, you just submit the Signin Form.&#x27;</span> % username)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> register_form.submit2.data <span class="keyword">and</span> register_form.validate():</span><br><span class="line">        username = register_form.username.data</span><br><span class="line">        flash(<span class="string">&#x27;%s, you just submit the Register Form.&#x27;</span> % username)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;2form.html&#x27;</span>, signin_form=signin_form, register_form=register_form)</span><br></pre></td></tr></table></figure>



<h4 id="多视图处理"><a href="#多视图处理" class="headerlink" title="多视图处理"></a>多视图处理</h4><p>更简洁的方法是通过分离表单的渲染和验证实现。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/multi-form-multi-view&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">multi_form_multi_view</span>():</span></span><br><span class="line">    signin_form = SigninForm2()</span><br><span class="line">    register_form = RegisterForm2()</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;2form2view.html&#x27;</span>, signin_form=signin_form, register_form=register_form)</span><br></pre></td></tr></table></figure>

<p>视图函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/handle-signin&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_signin</span>():</span></span><br><span class="line">    signin_form = SigninForm2()</span><br><span class="line">    register_form = RegisterForm2()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> signin_form.validate_on_submit():</span><br><span class="line">        username = signin_form.username.data</span><br><span class="line">        flash(<span class="string">&#x27;%s, you just submit the Signin Form.&#x27;</span> % username)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;2form2view.html&#x27;</span>, signin_form=signin_form, register_form=register_form)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/handle-register&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_register</span>():</span></span><br><span class="line">    signin_form = SigninForm2()</span><br><span class="line">    register_form = RegisterForm2()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> register_form.validate_on_submit():</span><br><span class="line">        username = register_form.username.data</span><br><span class="line">        flash(<span class="string">&#x27;%s, you just submit the Register Form.&#x27;</span> % username)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;2form2view.html&#x27;</span>, signin_form=signin_form, register_form=register_form)</span><br></pre></td></tr></table></figure>



<h2 id="第五章-数据库"><a href="#第五章-数据库" class="headerlink" title="第五章 数据库"></a>第五章 数据库</h2><ul>
<li><code>SQLALCHEMY_TRACK_ MODIFICATIONS</code>配置 : 是否追踪对象的修改，这用于Flask-SQLAlchemy的事件通知系统。一般设置为False就行</li>
</ul>
<p>默认情况下，Flask-SQLAlchemy会根据 <code>模型类的名称</code> 生成 <code>表名称</code> , 可以通过<code>__tablename__</code>属性自定义</p>
<h3 id="查看对应SQL语句"><a href="#查看对应SQL语句" class="headerlink" title="查看对应SQL语句"></a>查看对应SQL语句</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.schema <span class="keyword">import</span> CreateTable</span><br><span class="line"><span class="built_in">print</span>(CreateTable(Note.__table__))</span><br><span class="line"><span class="comment"># CREATE TABLE note (</span></span><br><span class="line"><span class="comment">#     id INTEGER NOT NULL ,</span></span><br><span class="line"><span class="comment">#     body TEXT,</span></span><br><span class="line"><span class="comment">#     PRIMARY KEY  (id)</span></span><br><span class="line"><span class="comment"># )</span></span><br></pre></td></tr></table></figure>



<h3 id="将数据库的重建定义成click"><a href="#将数据库的重建定义成click" class="headerlink" title="将数据库的重建定义成click"></a>将数据库的重建定义成click</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> click</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.cli.command()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initdb</span>():</span></span><br><span class="line">    db.drop_all()</span><br><span class="line">    db.create_all()</span><br><span class="line">    click.echo(<span class="string">&#x27;inited db&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>之后只要指向<code>flask initdb</code>即可</p>
<h3 id="删除数据不能使用get-必须改成post"><a href="#删除数据不能使用get-必须改成post" class="headerlink" title="删除数据不能使用get , 必须改成post"></a>删除数据不能使用get , 必须改成post</h3><p>为了防御CSRF攻击</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DeleteNoteForm</span>(<span class="params">FlaskForm</span>):</span></span><br><span class="line">    submit = SubmitField(<span class="string">&#x27;Delete&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/delete/&lt;int:note_id&gt;&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_note</span>(<span class="params">note_id</span>):</span></span><br><span class="line">    form = DeleteNoteForm()</span><br><span class="line">    <span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">        note = Note.query.get(note_id)</span><br><span class="line">        db.session.delete(note)</span><br><span class="line">        db.session.commit()</span><br><span class="line">        flash(<span class="string">&#x27;Your note is deleted.&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        abort(<span class="number">400</span>)</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for note in notes %&#125;</span><br><span class="line">    &lt;div class=&quot;note&quot;&gt;</span><br><span class="line">        &lt;p&gt;&#123;&#123; note.body &#125;&#125;&lt;/p&gt;</span><br><span class="line">        &lt;a class=&#x27;btn&#x27; href=&quot;&#123;&#123; url_for(&#x27;edit_note&#x27;, note_id=note.id) &#125;&#125;&quot;&gt;Edit&lt;/a&gt;</span><br><span class="line">        &lt;form method=&quot;post&quot; action=&quot;&#123;&#123; url_for(&#x27;delete_note&#x27;, note_id=note.id) &#125;&#125;&quot;&gt;</span><br><span class="line">            &#123;&#123; form.csrf_token &#125;&#125;</span><br><span class="line">            &#123;&#123; form.submit(class=&#x27;btn&#x27;) &#125;&#125;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>



<h3 id="配置-Python-Shell-上下文"><a href="#配置-Python-Shell-上下文" class="headerlink" title="配置 Python Shell 上下文"></a>配置 Python Shell 上下文</h3><ul>
<li>每次使用 flask shell命令启动 Python Shell后都要从app模块里导人db对象和相应的模型类。为什么不把它们自动集成到 Python Shell上下文里呢？</li>
<li>使用<code>app.shell_context_processor</code>装饰器注册一个shell上下文处理函数</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.shell_context_processor</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_shell_context</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">dict</span> (</span><br><span class="line">        db=db,</span><br><span class="line">        Note=Note,</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>


<h3 id="一对多"><a href="#一对多" class="headerlink" title="一对多"></a>一对多</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Author</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">20</span>), unique=<span class="literal">True</span>)</span><br><span class="line">    phone = db.Column(db.String(<span class="number">20</span>))</span><br><span class="line">    articles = db.relationship(<span class="string">&#x27;Article&#x27;</span>)  <span class="comment"># collection</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    title = db.Column(db.String(<span class="number">50</span>), index=<span class="literal">True</span>)</span><br><span class="line">    body = db.Column(db.Text)</span><br><span class="line">    author_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;author.id&#x27;</span>))</span><br></pre></td></tr></table></figure>

<ul>
<li>使用关系函数定义的属性不是数据库字段，而是类似于特定的查询函数。</li>
<li>当某个 Aritcle对象被删除时，在对应 Author对象的 aritcles属性调用时返回的列表也不会包含该对象</li>
</ul>
<blockquote>
<p>简单来说 , relationship就像一个函数 , 而不是一个数据库字段</p>
</blockquote>
<h4 id="一对多的双向关系"><a href="#一对多的双向关系" class="headerlink" title="一对多的双向关系"></a>一对多的双向关系</h4><p>一个作者有很多本书</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Writer</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">64</span>), unique=<span class="literal">True</span>)</span><br><span class="line">    books = db.relationship(<span class="string">&#x27;Book&#x27;</span>, back_populates=<span class="string">&#x27;writer&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">50</span>), index=<span class="literal">True</span>)</span><br><span class="line">    writer_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;writer.id&#x27;</span>))</span><br><span class="line">    writer = db.relationship(<span class="string">&#x27;Writer&#x27;</span>, back_populates=<span class="string">&#x27;books&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>或者使用<code>backref</code>进行简化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Singer</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">70</span>), unique=<span class="literal">True</span>)</span><br><span class="line">    songs = db.relationship(<span class="string">&#x27;Song&#x27;</span>, backref=<span class="string">&#x27;singer&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Song</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">50</span>), index=<span class="literal">True</span>)</span><br><span class="line">    singer_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;singer.id&#x27;</span>))</span><br></pre></td></tr></table></figure>



<h3 id="多对一"><a href="#多对一" class="headerlink" title="多对一"></a>多对一</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Citizen</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">70</span>), unique=<span class="literal">True</span>)</span><br><span class="line">    city_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;city.id&#x27;</span>))</span><br><span class="line">    city = db.relationship(<span class="string">&#x27;City&#x27;</span>)  <span class="comment"># scalar</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">City</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">30</span>), unique=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>



<h3 id="一对一"><a href="#一对一" class="headerlink" title="一对一"></a>一对一</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Country</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">30</span>), unique=<span class="literal">True</span>)</span><br><span class="line">    capital = db.relationship(<span class="string">&#x27;Capital&#x27;</span>, uselist=<span class="literal">False</span>)  <span class="comment"># collection -&gt; scalar</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Capital</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">30</span>), unique=<span class="literal">True</span>)</span><br><span class="line">    country_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;country.id&#x27;</span>))</span><br><span class="line">    country = db.relationship(<span class="string">&#x27;Country&#x27;</span>)  <span class="comment"># scalar</span></span><br></pre></td></tr></table></figure>



<h3 id="多对多1-虚拟表"><a href="#多对多1-虚拟表" class="headerlink" title="多对多1:虚拟表"></a>多对多1:虚拟表</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># many to many with association table</span></span><br><span class="line">association_table = db.Table(<span class="string">&#x27;association&#x27;</span>,</span><br><span class="line">                             db.Column(<span class="string">&#x27;student_id&#x27;</span>, db.Integer, db.ForeignKey(<span class="string">&#x27;student.id&#x27;</span>)),</span><br><span class="line">                             db.Column(<span class="string">&#x27;teacher_id&#x27;</span>, db.Integer, db.ForeignKey(<span class="string">&#x27;teacher.id&#x27;</span>))</span><br><span class="line">                             )</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">70</span>), unique=<span class="literal">True</span>)</span><br><span class="line">    grade = db.Column(db.String(<span class="number">20</span>))</span><br><span class="line">    teachers = db.relationship(<span class="string">&#x27;Teacher&#x27;</span>,</span><br><span class="line">                               secondary=association_table,</span><br><span class="line">                               back_populates=<span class="string">&#x27;students&#x27;</span>)  <span class="comment"># collection</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Teacher</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">70</span>), unique=<span class="literal">True</span>)</span><br><span class="line">    office = db.Column(db.String(<span class="number">20</span>))</span><br><span class="line">    students = db.relationship(<span class="string">&#x27;Student&#x27;</span>,</span><br><span class="line">                               secondary=association_table,</span><br><span class="line">                               back_populates=<span class="string">&#x27;teachers&#x27;</span>)  <span class="comment"># collection</span></span><br></pre></td></tr></table></figure>



<h3 id="多对多2-实体表"><a href="#多对多2-实体表" class="headerlink" title="多对多2:实体表"></a>多对多2:实体表</h3><p>上面的操作是使用sqlalchemy的特性创建了一张虚拟表 , 实际上我们也可以将这张表实体化</p>
<p>用户和收藏的图片是多对多关系</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">db.Model, UserMixin</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    username = db.Column(db.String(<span class="number">20</span>), unique=<span class="literal">True</span>, index=<span class="literal">True</span>)</span><br><span class="line">    collections = db.relationship(<span class="string">&#x27;Collect&#x27;</span>, back_populates=<span class="string">&#x27;collector&#x27;</span>, cascade=<span class="string">&#x27;all&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Photo</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    filename = db.Column(db.String(<span class="number">64</span>))</span><br><span class="line">    collectors = db.relationship(<span class="string">&#x27;Collect&#x27;</span>, back_populates=<span class="string">&#x27;collected&#x27;</span>, cascade=<span class="string">&#x27;all&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Collect</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="comment"># 收藏者</span></span><br><span class="line">    collector_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;user.id&#x27;</span>),primary_key=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># 被收藏的图片</span></span><br><span class="line">    collected_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;photo.id&#x27;</span>),primary_key=<span class="literal">True</span>)</span><br><span class="line">    timestamp = db.Column(db.DateTime, default=datetime.utcnow)</span><br><span class="line">    collector = db.relationship(<span class="string">&#x27;User&#x27;</span>, back_populates=<span class="string">&#x27;collections&#x27;</span>, lazy=<span class="string">&#x27;joined&#x27;</span>)</span><br><span class="line">    collected = db.relationship(<span class="string">&#x27;Photo&#x27;</span>, back_populates=<span class="string">&#x27;collectors&#x27;</span>, lazy=<span class="string">&#x27;joined&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>我们在 Photo和User模型中定义的关系属性返回的不再是关系另一侧的记录，而是存储对应关系的中间人—Collect记录。</li>
<li>在 Collect记录中添加的标量关系属性 collector和 collected，分别表示收藏者和被收藏图片，指向对应的User和<br>Photo记录，我们需要进一步调用这两个关系属性，才可以获取关系另一侧的记录。</li>
<li>举例来说，对于使用关联表的标（Tag）和图片（Photo）来说，对于使用关联模型的用户（User）和图片（Photo），当我们调用 <code>photo.collectors</code> 时，获得的只是一堆包含当前图片和对应收藏者关系的 Collect记录。我们需要对记录进一步调用 collector属性才会获得对应的User记录。</li>
<li>用户a收藏一张图片，仅使用 user_a.collections.append(photo_a)就可以了</li>
</ul>
<h3 id="多对多3-自引用"><a href="#多对多3-自引用" class="headerlink" title="多对多3:自引用"></a>多对多3:自引用</h3><p>用户的关注就是自引用的多对多</p>
<ul>
<li>因为在Follow模型中 , 两个字段定义的外键是指向同一个表的同一个字段(user.id)的 , 而当我们需要在Follow模型上建立反向属性的时候 , Sqlalchemy没法知道那个外键对应哪个反向属性 , 所以我们需要在关系函数中使用foreign_keys参数来明确对应的字段</li>
<li>同样因为同一个外键值包含歧义，对于集合关系属性 followers和 followings来说，我们无法通过 with_parent()查询方法筛选子对象，所以关系定义时使用 dynamic方式加载关系记录，这样就可以直接调用关系属性附加的查询方法</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Follow</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    follower_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;user.id&#x27;</span>),primary_key=<span class="literal">True</span>)</span><br><span class="line">    followed_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;user.id&#x27;</span>),primary_key=<span class="literal">True</span>)</span><br><span class="line">    timestamp = db.Column(db.DateTime, default=datetime.utcnow)</span><br><span class="line">    follower = db.relationship(<span class="string">&#x27;User&#x27;</span>, foreign_keys=[follower_id], back_populates=<span class="string">&#x27;following&#x27;</span>, lazy=<span class="string">&#x27;joined&#x27;</span>)</span><br><span class="line">    followed = db.relationship(<span class="string">&#x27;User&#x27;</span>, foreign_keys=[followed_id], back_populates=<span class="string">&#x27;followers&#x27;</span>, lazy=<span class="string">&#x27;joined&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">db.Model, UserMixin</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    username = db.Column(db.String(<span class="number">20</span>), unique=<span class="literal">True</span>, index=<span class="literal">True</span>)</span><br><span class="line">    following = db.relationship(<span class="string">&#x27;Follow&#x27;</span>, foreign_keys=[Follow.follower_id],back_populates=<span class="string">&#x27;follower&#x27;</span>,lazy=<span class="string">&#x27;dynamic&#x27;</span>, cascade=<span class="string">&#x27;all&#x27;</span>)</span><br><span class="line">    followers = db.relationship(<span class="string">&#x27;Follow&#x27;</span>, foreign_keys=[Follow.followed_id],back_populates=<span class="string">&#x27;followed&#x27;</span>,lazy=<span class="string">&#x27;dynamic&#x27;</span>, cascade=<span class="string">&#x27;all&#x27;</span>)</span><br></pre></td></tr></table></figure>





<h3 id="级联操作"><a href="#级联操作" class="headerlink" title="级联操作"></a>级联操作</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cascade</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    title = db.Column(db.String(<span class="number">50</span>))</span><br><span class="line">    body = db.Column(db.Text)</span><br><span class="line">    comments = db.relationship(<span class="string">&#x27;Comment&#x27;</span>, back_populates=<span class="string">&#x27;post&#x27;</span>, cascade=<span class="string">&#x27;all, delete-orphan&#x27;</span>)  <span class="comment"># collection</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Comment</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    body = db.Column(db.Text)</span><br><span class="line">    post_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;post.id&#x27;</span>))</span><br><span class="line">    post = db.relationship(<span class="string">&#x27;Post&#x27;</span>, back_populates=<span class="string">&#x27;comments&#x27;</span>)  <span class="comment"># scalar</span></span><br></pre></td></tr></table></figure>

<p>常用的配置组合如下所示:</p>
<ul>
<li>save-update , merge</li>
<li>save-update , merge , delete</li>
<li>all</li>
<li>all , delete-orphan</li>
</ul>
<h3 id="with-parent"><a href="#with-parent" class="headerlink" title="with_parent()"></a>with_parent()</h3><p>根据父对象找出所有的子对象 (使用前提是<code>foreignKey</code>)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 文章</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 评论</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Comment</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<ul>
<li>文章和评论是一对多</li>
<li>所以文章是父对象 , 评论是子对象</li>
<li>根据父对象post , 找到该文章下的所有评论</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">post = Post.query.filter_by(<span class="built_in">id</span>=<span class="number">23</span>).first()</span><br><span class="line">comments = Comment.query. with_parent(post).<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure>



<h3 id="SQLalchemy事件监听"><a href="#SQLalchemy事件监听" class="headerlink" title="SQLalchemy事件监听"></a>SQLalchemy事件监听</h3><ul>
<li><p>SQLAlchemy提供了一个 listen_for装饰器，它可以用来注册事件回调函数。</p>
</li>
<li><p>listen_for装饰器主要接收两个参数，</p>
<ul>
<li>target表示监听的对象，这个对象可以是模型类、类实例或类属性等。</li>
<li>identifier参数表示被监听事件的标识符，比如，用于监听属性的事件标识符有set、append、remove、init<br>scalar、init collection等。</li>
</ul>
</li>
<li><p>示例</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># event listening</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Draft</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    body = db.Column(db.Text)</span><br><span class="line">    edit_time = db.Column(db.Integer, default=<span class="number">0</span>)  <span class="comment"># 草稿被修改次数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@db.event.listens_for(<span class="params">Draft.body, <span class="string">&#x27;set&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">increment_edit_time</span>(<span class="params">target, value, oldvalue, initiator</span>):</span></span><br><span class="line">    <span class="keyword">if</span> target.edit_time <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        target.edit_time += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># same with:</span></span><br><span class="line"><span class="meta">@db.event.listens_for(<span class="params">Draft.body, <span class="string">&#x27;set&#x27;</span>, named=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">increment_edit_time</span>(<span class="params">**kwargs</span>):</span></span><br><span class="line">    <span class="keyword">if</span> kwargs[<span class="string">&#x27;target&#x27;</span>].edit_time <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        kwargs[<span class="string">&#x27;target&#x27;</span>].edit_time += <span class="number">1</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="第六章-电子邮件"><a href="#第六章-电子邮件" class="headerlink" title="第六章 电子邮件"></a>第六章 电子邮件</h2><h3 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> smtplib <span class="keyword">import</span> SMTPSenderRefused, SMTPAuthenticationError</span><br><span class="line"><span class="keyword">from</span> flask_mail <span class="keyword">import</span> Message</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_email</span>(<span class="params"><span class="type">Type</span></span>):</span></span><br><span class="line">    <span class="keyword">from</span> app <span class="keyword">import</span> app</span><br><span class="line">    sender = (app.config.get(<span class="string">&#x27;MAIL_NAME&#x27;</span>), app.config.get(<span class="string">&#x27;MAIL_USERNAME&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="type">Type</span> == <span class="string">&#x27;server&#x27;</span>:</span><br><span class="line">        days = <span class="number">15</span></span><br><span class="line">        subject = <span class="string">&#x27;服务器过期提醒&#x27;</span></span><br><span class="line">        template = <span class="string">&#x27;servers_expires.html&#x27;</span></span><br><span class="line">    <span class="keyword">elif</span> <span class="type">Type</span> == <span class="string">&#x27;domain&#x27;</span>:</span><br><span class="line">        days = <span class="number">15</span></span><br><span class="line">        subject = <span class="string">&#x27;域名过期提醒&#x27;</span></span><br><span class="line">        template = <span class="string">&#x27;domains_expires.html&#x27;</span></span><br><span class="line">    <span class="comment"># 获取预警联系人的字典</span></span><br><span class="line">    contact_dict = _get_contact_cloud_dict(<span class="type">Type</span>=<span class="type">Type</span>, days=days)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> contact_dict:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> app.app_context():</span><br><span class="line">        <span class="keyword">for</span> contact, clouds <span class="keyword">in</span> contact_dict.items():</span><br><span class="line">            msg = Message(subject, sender=sender, recipients=[contact.email])</span><br><span class="line">            msg.html = render_template(template, clouds=clouds, contact=contact)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                mail.send(msg)</span><br><span class="line">            <span class="keyword">except</span> (SMTPSenderRefused,SMTPAuthenticationError,ConnectionRefusedError) <span class="keyword">as</span> e:</span><br><span class="line">                send_email_error_logger(cloud_type=<span class="type">Type</span>, clouds=clouds, contact=contact)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                send_email_info_logger(cloud_type=<span class="type">Type</span>, clouds=clouds, contact=contact)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>简化版本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_mail <span class="keyword">import</span> Mail, Message</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_subscribe_mail</span>(<span class="params">subject, to, **kwargs</span>):</span></span><br><span class="line">    message = Message(subject, recipients=[to], sender=<span class="string">&#x27;Flask Weekly &lt;%s&gt;&#x27;</span> % os.getenv(<span class="string">&#x27;MAIL_USERNAME&#x27;</span>))</span><br><span class="line">    message.body = render_template(<span class="string">&#x27;emails/subscribe.txt&#x27;</span>, **kwargs)</span><br><span class="line">    message.html = render_template(<span class="string">&#x27;emails/subscribe.html&#x27;</span>, **kwargs)</span><br><span class="line">    mail.send(message)</span><br></pre></td></tr></table></figure>



<h3 id="异步发送"><a href="#异步发送" class="headerlink" title="异步发送"></a>异步发送</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># send email asynchronously</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_send_async_mail</span>(<span class="params">app, message</span>):</span></span><br><span class="line">    <span class="keyword">with</span> app.app_context():</span><br><span class="line">        mail.send(message)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_async_mail</span>(<span class="params">subject, to, body</span>):</span></span><br><span class="line">    app = current_app._get_current_object()  <span class="comment"># 获取被代理的真实对象</span></span><br><span class="line">    message = Message(subject, recipients=[to], body=body)</span><br><span class="line">    thr = Thread(target=_send_async_mail, args=[app, message])</span><br><span class="line">    thr.start()</span><br><span class="line">    <span class="keyword">return</span> thr</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    form = EmailForm()</span><br><span class="line">    <span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">        to = form.to.data</span><br><span class="line">        subject = form.subject.data</span><br><span class="line">        body = form.body.data</span><br><span class="line">        send_async_mail(subject, to, body)</span><br><span class="line">        flash(<span class="string">&#x27;Email sent ! Check your inbox.&#x27;</span> )</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    form.subject.data = <span class="string">&#x27;Hello, World!&#x27;</span></span><br><span class="line">    form.body.data = <span class="string">&#x27;Across the Great Wall we can reach every corner in the world.&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, form=form)</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>因为我们的程序实例是通过工厂函数构建的，所以实例化 Thread类时，我们使用代理对象 current<br>app作为args参数列表中ap的值。</li>
<li>另外，因为在新建的线程时需要真正的程序对象来创建上下文，所以我们不能直接传人 current app，而是传入对 current app调用get current objecto方法获取到的被代理的程序实例。</li>
</ul>
</blockquote>
</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>