<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;Flask四大内置对象&quot;&gt;&lt;a href=&quot;#Flask四大内置对象&quot; class=&quot;headerlink&quot; title=&quot;Flask四大内置对象&quot;&gt;&lt;/a&gt;Flask四大内置对象&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;Request : 使用request获取&lt;/li&gt;
&lt;li&gt;Session : 使用session获取&lt;/li&gt;
&lt;li&gt;G : 使用g获取&lt;/li&gt;
&lt;li&gt;Config : 在模板中使用config获取 , 在python代码中使用app.config获取&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;四个内置对象可以在&lt;code&gt;view&lt;/code&gt;和&lt;code&gt;template&lt;/code&gt;中使用"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>Web开发之Flask框架从入门到精通3_核心对象和常用插件 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Flask/" rel="tag">Flask</a></div><div class="post-time">2021-08-29</div></div></div><div class="container post-header"><h1>Web开发之Flask框架从入门到精通3_核心对象和常用插件</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Flask%E5%9B%9B%E5%A4%A7%E5%86%85%E7%BD%AE%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.</span> <span class="toc-text">Flask四大内置对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Session-%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.1.</span> <span class="toc-text">Session 对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#g%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.2.</span> <span class="toc-text">g对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Request-Response%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.3.</span> <span class="toc-text">Request,Response对象</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E6%95%B0"><span class="toc-number">1.3.1.</span> <span class="toc-text">参数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#request%E5%B1%9E%E6%80%A7"><span class="toc-number">1.4.</span> <span class="toc-text">request属性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E7%BB%88%E6%AD%A2%E8%AF%B7%E6%B1%82abort"><span class="toc-number">1.4.1.</span> <span class="toc-text">直接终止请求abort</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8D%95%E8%8E%B7%E5%BC%82%E5%B8%B8errorhandler"><span class="toc-number">1.4.2.</span> <span class="toc-text">捕获异常errorhandler</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAResponse%E7%9A%84%E4%B8%89%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="toc-number">1.4.3.</span> <span class="toc-text">创建Response的三种方式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Flask%E4%B8%A4%E5%A4%A7%E6%A0%B8%E5%BF%83%E6%A8%A1%E5%9D%97"><span class="toc-number">2.</span> <span class="toc-text">Flask两大核心模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Flask%E4%BA%94%E4%B8%AA%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0"><span class="toc-number">3.</span> <span class="toc-text">Flask五个钩子函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-number">4.</span> <span class="toc-text">上下文</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E4%B8%8A%E4%B8%8B%E6%96%87-request-context"><span class="toc-number">4.1.</span> <span class="toc-text">请求上下文(request context)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87-application-context"><span class="toc-number">4.2.</span> <span class="toc-text">应用上下文(application context)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%A4%E8%80%85%E5%8C%BA%E5%88%AB"><span class="toc-number">4.3.</span> <span class="toc-text">两者区别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Flask%E5%B8%B8%E7%94%A8%E6%8F%92%E4%BB%B6"><span class="toc-number">5.</span> <span class="toc-text">Flask常用插件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#flask-script"><span class="toc-number">5.1.</span> <span class="toc-text">flask_script</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flask-blueprint"><span class="toc-number">5.2.</span> <span class="toc-text">flask_blueprint</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flask-sqlalchemy"><span class="toc-number">5.3.</span> <span class="toc-text">flask_sqlalchemy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flask-migrate"><span class="toc-number">5.4.</span> <span class="toc-text">flask_migrate</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flask-session"><span class="toc-number">5.5.</span> <span class="toc-text">flask_session</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flask-bootstrap"><span class="toc-number">5.6.</span> <span class="toc-text">flask_bootstrap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flask-DebugToolbar"><span class="toc-number">5.7.</span> <span class="toc-text">Flask-DebugToolbar</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flask-cachinging"><span class="toc-number">5.8.</span> <span class="toc-text">Flask-cachinging</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flask-mail"><span class="toc-number">5.9.</span> <span class="toc-text">flask_mail</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flask-RESTful"><span class="toc-number">5.10.</span> <span class="toc-text">Flask_RESTful</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#flask-migrate%E4%BD%BF%E7%94%A8"><span class="toc-number">6.</span> <span class="toc-text">flask_migrate使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E7%8B%AC%E4%BD%BF%E7%94%A8"><span class="toc-number">6.1.</span> <span class="toc-text">单独使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E5%90%88flask-script%E4%BD%BF%E7%94%A8"><span class="toc-number">6.2.</span> <span class="toc-text">结合flask_script使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8flask-script%E5%92%8Cflask-migrate"><span class="toc-number">6.3.</span> <span class="toc-text">使用flask-script和flask-migrate</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%9A%E8%AF%9D%E6%8A%80%E6%9C%AF"><span class="toc-number">7.</span> <span class="toc-text">会话技术</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E8%8E%B7%E5%8F%96cookies"><span class="toc-number">7.1.</span> <span class="toc-text">设置获取cookies</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E8%8E%B7%E5%8F%96Session"><span class="toc-number">7.2.</span> <span class="toc-text">设置获取Session</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#flask-session%E4%BD%BF%E7%94%A8"><span class="toc-number">8.</span> <span class="toc-text">flask_session使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Flask-caching%E4%BD%BF%E7%94%A8"><span class="toc-number">9.</span> <span class="toc-text">Flask-caching使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Flask-DebugToolbar%E4%BD%BF%E7%94%A8"><span class="toc-number">10.</span> <span class="toc-text">Flask-DebugToolbar使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#flask-mail%E4%BD%BF%E7%94%A8"><span class="toc-number">11.</span> <span class="toc-text">flask_mail使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Flask-RESTful%E4%BD%BF%E7%94%A8"><span class="toc-number">12.</span> <span class="toc-text">Flask_RESTful使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Resource"><span class="toc-number">12.1.</span> <span class="toc-text">使用Resource</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">12.2.</span> <span class="toc-text">序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E5%A4%8D%E6%9D%82JSON"><span class="toc-number">12.3.</span> <span class="toc-text">返回复杂JSON</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8use-args"><span class="toc-number">12.4.</span> <span class="toc-text">使用use_args</span></a></li></ol></li></ol></details></div><div class="container post-content"><h2 id="Flask四大内置对象"><a href="#Flask四大内置对象" class="headerlink" title="Flask四大内置对象"></a>Flask四大内置对象</h2><ul>
<li>Request : 使用request获取</li>
<li>Session : 使用session获取</li>
<li>G : 使用g获取</li>
<li>Config : 在模板中使用config获取 , 在python代码中使用app.config获取</li>
</ul>
<blockquote>
<p>四个内置对象可以在<code>view</code>和<code>template</code>中使用</p>
</blockquote>
<h3 id="Session-对象"><a href="#Session-对象" class="headerlink" title="Session 对象"></a>Session 对象</h3><ul>
<li>db.session.add(obj) 添加对象</li>
<li>db.session.add_all([obj1,obj2,..]) 添加多个对象</li>
<li>db.session.delete(obj) 删除对象</li>
<li>db.session.commit() 提交会话</li>
<li>db.session.rollback() 回滚</li>
<li>db.session.remove() 移除会话</li>
</ul>
<h3 id="g对象"><a href="#g对象" class="headerlink" title="g对象"></a>g对象</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@user_router.before_request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span>():</span></span><br><span class="line">    g.msg = <span class="string">&#x27;this is msg&#x27;</span> <span class="comment">#设置g</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;Handling <span class="subst">&#123;request.url&#125;</span>&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="meta">@user_router.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>,]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">employee</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(g.msg) <span class="comment"># 获取g</span></span><br><span class="line">    EmployeeModel.query.paginate()</span><br><span class="line">    emp_record = EmployeeModel.query.<span class="built_in">all</span>()</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;user/user.html&quot;</span>, emp_record=emp_record)</span><br></pre></td></tr></table></figure>



<h3 id="Request-Response对象"><a href="#Request-Response对象" class="headerlink" title="Request,Response对象"></a>Request,Response对象</h3><h4 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h4><ul>
<li>url 完整请求地址</li>
<li>base_url 去掉GET参数的URL</li>
<li>host_url 只有主机和端口号的URL</li>
<li>path 路由中的路径</li>
<li>method 请求方法</li>
<li>remote_addr 请求的客户端地址</li>
<li><code>args</code> GET请求参数 (它并不是get专属，所有请求都能获取这个参数)</li>
<li><code>form</code> POST请求参数</li>
<li>files 文件上传</li>
<li>headers 请求头</li>
<li>cookies 请求中的cookie</li>
</ul>
<h3 id="request属性"><a href="#request属性" class="headerlink" title="request属性"></a>request属性</h3><table>
<thead>
<tr>
<th align="left">属性</th>
<th align="left">说明</th>
<th align="left">类型</th>
</tr>
</thead>
<tbody><tr>
<td align="left">data</td>
<td align="left">记录请求的数据，并转换为字符串</td>
<td align="left">*</td>
</tr>
<tr>
<td align="left">form</td>
<td align="left">记录请求中的表单数据</td>
<td align="left">MultiDict</td>
</tr>
<tr>
<td align="left">args</td>
<td align="left">记录请求中的查询参数</td>
<td align="left">MultiDict</td>
</tr>
<tr>
<td align="left">cookies</td>
<td align="left">记录请求中的cookie信息</td>
<td align="left">Dict</td>
</tr>
<tr>
<td align="left">headers</td>
<td align="left">记录请求中的报文头</td>
<td align="left">EnvironHeaders</td>
</tr>
<tr>
<td align="left">method</td>
<td align="left">记录请求使用的HTTP方法</td>
<td align="left">GET/POST</td>
</tr>
<tr>
<td align="left">url</td>
<td align="left">记录请求的URL地址</td>
<td align="left">string</td>
</tr>
<tr>
<td align="left">files</td>
<td align="left">记录请求上传的文件</td>
<td align="left">*</td>
</tr>
</tbody></table>
<h4 id="直接终止请求abort"><a href="#直接终止请求abort" class="headerlink" title="直接终止请求abort"></a>直接终止请求abort</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@blue.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    abort(<span class="number">404</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>abort源码 : 本质raise Execption</li>
<li>HttpExeception :子类指定两个属性即可实现<ol>
<li>code</li>
<li>description</li>
</ol>
</li>
</ul>
</blockquote>
<h4 id="捕获异常errorhandler"><a href="#捕获异常errorhandler" class="headerlink" title="捕获异常errorhandler"></a>捕获异常errorhandler</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.errorhandler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span>(<span class="params">e</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;LOL&#x27;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意 : 本蓝图的errorhandler只能捕获本蓝图的error</p>
</blockquote>
<h4 id="创建Response的三种方式"><a href="#创建Response的三种方式" class="headerlink" title="创建Response的三种方式"></a>创建Response的三种方式</h4><ol>
<li><p>直接返回字符串</p>
</li>
<li><p>make_response</p>
</li>
<li><p>直接构建Response1</p>
<blockquote>
<p>render_template : 帮助把模板变成html<code>字符串</code></p>
</blockquote>
</li>
</ol>
<ul>
<li>重定向 : redirect</li>
<li>反向解析 : url_for</li>
</ul>
<h2 id="Flask两大核心模块"><a href="#Flask两大核心模块" class="headerlink" title="Flask两大核心模块"></a>Flask两大核心模块</h2><ul>
<li>Jinjia2 : 模板引擎</li>
<li>Werkzurg : WSGI工具集</li>
</ul>
<h2 id="Flask五个钩子函数"><a href="#Flask五个钩子函数" class="headerlink" title="Flask五个钩子函数"></a>Flask五个钩子函数</h2><ul>
<li>before_first_request</li>
<li>before_request</li>
<li>after_request</li>
<li>teardown_request</li>
<li>errorhandler</li>
</ul>
<blockquote>
<p>Flask的钩子函数有点像Django的中间件 , 本质就是<code>面向切面编程</code></p>
<ol>
<li>process_request(self,request)</li>
<li>process_view(self, request, callback, callback_args, callback_kwargs)</li>
<li>process_template_response(self,request,response)</li>
<li>process_exception(self, request, exception)</li>
<li>process_response(self, request, response)</li>
</ol>
</blockquote>
<p>Flask的钩子函数可以用在<code>APP</code>上,也可以用在<code>蓝图</code>上 (<strong>APP的优先级更高</strong>)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@user_router.before_request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;Handling <span class="subst">&#123;request.url&#125;</span>&#x27;</span>)</span><br><span class="line"><span class="comment"># 和Django一样,不必像Scrapy一样必须返回Request</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># middleware.py</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_middleware</span>(<span class="params">app</span>):</span></span><br><span class="line"><span class="meta">    @app.before_request</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">before</span>():</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;Handling <span class="subst">&#123;request.url&#125;</span>&#x27;</span>)</span><br><span class="line">        </span><br><span class="line"><span class="meta">    @app.after_request</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">after</span>(<span class="params">response</span>):</span>  <span class="comment"># after_request需要传入response参数</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;Handled <span class="subst">&#123;request.url&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> response <span class="comment"># 还需要返回response</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># app.__init__.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_app</span>():</span></span><br><span class="line">    load_middleware(app)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>面向切面编程AOP :</p>
<p>简单来说 : <strong>动态介入某个流程</strong></p>
<ol>
<li>可以通过<code>预编译</code>方式和<code>运行期</code>动态代理实现在不修改源代码的情况下给程序动态统一添加功能的一种技术。</li>
<li>利用AOP可以对业务逻辑的各个部分进行隔离，从而使得业务逻辑各部分之间的耦合度降低，提高程序的可重用性，同时提高了开发的效率。</li>
<li>主要功能 : 日志记录，性能统计，安全控制，事务处理，异常处理</li>
</ol>
</blockquote>
<h2 id="上下文"><a href="#上下文" class="headerlink" title="上下文"></a>上下文</h2><p>上下文：相当于一个容器，保存了 Flask 程序运行过程中的一些信息。</p>
<p>Flask中有两种上下文</p>
<ul>
<li>请求上下文</li>
<li>应用上下文</li>
</ul>
<h3 id="请求上下文-request-context"><a href="#请求上下文-request-context" class="headerlink" title="请求上下文(request context)"></a>请求上下文(request context)</h3><p>在视图函数中，如何取到当前请求的相关数据？比如：请求地址，请求方式，cookie等等</p>
<p>在 flask 中，可以直接在视图函数中使用 <strong>request</strong> 这个对象进行获取相关数据，而 <strong>request</strong> 就是请求上下文的对象，保存了当前本次请求的相关数据，请求上下文对象有：request、session</p>
<ul>
<li>request<ul>
<li>封装了HTTP请求的内容，针对的是http请求。举例：user = request.args.get(‘user’)，获取的是get请求的参数。</li>
</ul>
</li>
<li>session<ul>
<li>用来记录请求会话中的信息，针对的是用户信息。举例：session[‘name’] = user.id，可以记录用户信息。还可以通过session.get(‘name’)获取用户信息。</li>
</ul>
</li>
</ul>
<h3 id="应用上下文-application-context"><a href="#应用上下文-application-context" class="headerlink" title="应用上下文(application context)"></a>应用上下文(application context)</h3><p>它的字面意思是 应用上下文，但它不是一直存在的，它只是request context 中的一个<code>对 app 的代理</code>，所谓<code>local proxy</code>。它的作用主要是<strong>帮助 request 获取当前的应用</strong>，它是伴 request 而生，随 request 而灭的。</p>
<p>应用上下文对象有：current_app，g</p>
<h3 id="两者区别"><a href="#两者区别" class="headerlink" title="两者区别"></a>两者区别</h3><ul>
<li>请求上下文：保存了客户端和服务器交互的数据</li>
<li>应用上下文：flask 应用程序运行过程中，保存的一些配置信息，比如程序名、数据库连接、应用信息等</li>
</ul>
<h2 id="Flask常用插件"><a href="#Flask常用插件" class="headerlink" title="Flask常用插件"></a>Flask常用插件</h2><h3 id="flask-script"><a href="#flask-script" class="headerlink" title="flask_script"></a>flask_script</h3><ul>
<li>让flask支持命令行参数</li>
<li>使用方法 : 使用APP创建manager对象 , 启动Manager对象</li>
</ul>
<h3 id="flask-blueprint"><a href="#flask-blueprint" class="headerlink" title="flask_blueprint"></a>flask_blueprint</h3><ul>
<li>可以扩展路由</li>
</ul>
<h3 id="flask-sqlalchemy"><a href="#flask-sqlalchemy" class="headerlink" title="flask_sqlalchemy"></a>flask_sqlalchemy</h3><ul>
<li>orm , 针对于flask进行优化和封装的Sqlalchemy</li>
<li>使用方法 : <ol>
<li>需要App构建SQLalchemy对象</li>
<li>配置DATABASES_URI</li>
<li>使用Models进行模型定制</li>
<li>使用Column创建字段</li>
<li>使用SQLAlchemy对象创建create_all</li>
<li>删除:drop_all</li>
</ol>
</li>
</ul>
<h3 id="flask-migrate"><a href="#flask-migrate" class="headerlink" title="flask_migrate"></a>flask_migrate</h3><ul>
<li>实现数据库迁移</li>
<li>使用方法 : <ol>
<li>初始化需要app和数据库SQLAlchemy</li>
<li>可以和flask_migrate配合使用 : 在Manager上添加命令 MigrateCommend</li>
</ol>
</li>
</ul>
<h3 id="flask-session"><a href="#flask-session" class="headerlink" title="flask_session"></a>flask_session</h3><ul>
<li>快速实现将session存储到其他位置(如数据库,文件,缓存等) . 并且提供一些设置参数</li>
</ul>
<h3 id="flask-bootstrap"><a href="#flask-bootstrap" class="headerlink" title="flask_bootstrap"></a>flask_bootstrap</h3><ul>
<li>Flask-Bootstrap把Bootstrap打包进一个扩展，这个扩展主要由一个叫“bootstrap”的蓝本（blueprint）组成。它也可以创建链接从一个CDN上引用Bootstrap资源。</li>
<li>集成了Bootstrap插件 , 为开发者准备了默认模板<code>base.html</code></li>
</ul>
<h3 id="Flask-DebugToolbar"><a href="#Flask-DebugToolbar" class="headerlink" title="Flask-DebugToolbar"></a>Flask-DebugToolbar</h3><ul>
<li>此扩展将工具栏覆盖添加到flask应用程序中，其中包含调试所需的有用信息。</li>
</ul>
<h3 id="Flask-cachinging"><a href="#Flask-cachinging" class="headerlink" title="Flask-cachinging"></a>Flask-cachinging</h3><ul>
<li>添加缓存</li>
</ul>
<h3 id="flask-mail"><a href="#flask-mail" class="headerlink" title="flask_mail"></a>flask_mail</h3><ul>
<li>发送邮件</li>
</ul>
<h3 id="Flask-RESTful"><a href="#Flask-RESTful" class="headerlink" title="Flask_RESTful"></a>Flask_RESTful</h3><ul>
<li>实现RESTful接口</li>
</ul>
<h2 id="flask-migrate使用"><a href="#flask-migrate使用" class="headerlink" title="flask_migrate使用"></a>flask_migrate使用</h2><p>Flask-Migrate是一个为Flask应用处理SQLAlchemy数据库迁移的扩展，使得可以通过Flask的命令行接口或者Flask-Scripts对数据库进行操作。</p>
<h3 id="单独使用"><a href="#单独使用" class="headerlink" title="单独使用"></a>单独使用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask_migrate <span class="keyword">import</span> Migrate</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;sqlite:///app.db&#x27;</span></span><br><span class="line"></span><br><span class="line">db = SQLAlchemy(app)</span><br><span class="line">migrate = Migrate(app, db)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">128</span>))</span><br></pre></td></tr></table></figure>

<h3 id="结合flask-script使用"><a href="#结合flask-script使用" class="headerlink" title="结合flask_script使用"></a>结合flask_script使用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask_script <span class="keyword">import</span> Manager</span><br><span class="line"><span class="keyword">from</span> flask_migrate <span class="keyword">import</span> Migrate, MigrateCommand</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;sqlite:///app.db&#x27;</span></span><br><span class="line"></span><br><span class="line">db = SQLAlchemy(app)</span><br><span class="line">migrate = Migrate(app, db)</span><br><span class="line"></span><br><span class="line">manager = Manager(app)</span><br><span class="line">manager.add_command(<span class="string">&#x27;db&#x27;</span>, MigrateCommand)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">128</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    manager.run()</span><br></pre></td></tr></table></figure>

<p>之后就可以使用命令:</p>
<ol>
<li><p><code>python manage.py db init</code></p>
<p>初始化</p>
<blockquote>
<p>这个命令将会新建一个名字为migrations的文件夹，并且记录一个数据库版本号，一份保留在migrations中，一份保存在数据库中(新建一张名字为alembic_version的表来保存)，值得注意的是新建了migrations文件夹后需要对数据库模型进行修改，然后使用flask-migrations进行迁移，这样才产生第一个版本号。</p>
</blockquote>
</li>
<li><p><code>python manage.py db migrate</code></p>
<p>生成迁移文件</p>
</li>
<li><p><code>python manage.py db upgrade</code></p>
<p>迁移</p>
<blockquote>
<p>每次数据库模型变化，需要重复使用migrate命令和upgrade命令（按顺序组合使用），使用成功后将修改版本号。</p>
</blockquote>
</li>
<li><p><code>python manage.py db downgrade</code> : 取消上一次迁移</p>
</li>
<li><p><code>python manage.py db --help</code></p>
<p>帮助</p>
</li>
</ol>
<blockquote>
<p>观察一下迁移文件 : 本质就是一段python脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;add note timestamp</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Revision ID: 7f3dae8cae4d</span></span><br><span class="line"><span class="string">Revises: </span></span><br><span class="line"><span class="string">Create Date: 2019-04-01 21:56:32.469000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">from</span> alembic <span class="keyword">import</span> op</span><br><span class="line"><span class="keyword">import</span> sqlalchemy <span class="keyword">as</span> sa</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># revision identifiers, used by Alembic.</span></span><br><span class="line">revision = <span class="string">&#x27;7f3dae8cae4d&#x27;</span></span><br><span class="line">down_revision = <span class="literal">None</span></span><br><span class="line">branch_labels = <span class="literal">None</span></span><br><span class="line">depends_on = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upgrade</span>():</span></span><br><span class="line">    <span class="comment"># ### commands auto generated by Alembic - please adjust! ###</span></span><br><span class="line">    op.drop_table(<span class="string">&#x27;draft&#x27;</span>)</span><br><span class="line">    op.drop_table(<span class="string">&#x27;post&#x27;</span>)</span><br><span class="line">    op.drop_table(<span class="string">&#x27;comment&#x27;</span>)</span><br><span class="line">    op.add_column(<span class="string">&#x27;note&#x27;</span>, sa.Column(<span class="string">&#x27;timeStamp&#x27;</span>, sa.String(length=<span class="number">70</span>), nullable=<span class="literal">True</span>))</span><br><span class="line">    op.create_unique_constraint(<span class="literal">None</span>, <span class="string">&#x27;note&#x27;</span>, [<span class="string">&#x27;timeStamp&#x27;</span>])</span><br><span class="line">    <span class="comment"># ### end Alembic commands ###</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">downgrade</span>():</span></span><br><span class="line">    <span class="comment"># ### commands auto generated by Alembic - please adjust! ###</span></span><br><span class="line">    op.drop_constraint(<span class="literal">None</span>, <span class="string">&#x27;note&#x27;</span>, type_=<span class="string">&#x27;unique&#x27;</span>)</span><br><span class="line">    op.drop_column(<span class="string">&#x27;note&#x27;</span>, <span class="string">&#x27;timeStamp&#x27;</span>)</span><br><span class="line">    op.create_table(<span class="string">&#x27;comment&#x27;</span>,</span><br><span class="line">    sa.Column(<span class="string">&#x27;id&#x27;</span>, sa.INTEGER(), nullable=<span class="literal">False</span>),</span><br><span class="line">    sa.Column(<span class="string">&#x27;body&#x27;</span>, sa.TEXT(), nullable=<span class="literal">True</span>),</span><br><span class="line">    sa.Column(<span class="string">&#x27;post_id&#x27;</span>, sa.INTEGER(), nullable=<span class="literal">True</span>),</span><br><span class="line">    sa.ForeignKeyConstraint([<span class="string">&#x27;post_id&#x27;</span>], [<span class="string">u&#x27;post.id&#x27;</span>], ),</span><br><span class="line">    sa.PrimaryKeyConstraint(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">    )</span><br><span class="line">    op.create_table(<span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">    sa.Column(<span class="string">&#x27;id&#x27;</span>, sa.INTEGER(), nullable=<span class="literal">False</span>),</span><br><span class="line">    sa.Column(<span class="string">&#x27;title&#x27;</span>, sa.VARCHAR(length=<span class="number">50</span>), nullable=<span class="literal">True</span>),</span><br><span class="line">    sa.Column(<span class="string">&#x27;body&#x27;</span>, sa.TEXT(), nullable=<span class="literal">True</span>),</span><br><span class="line">    sa.PrimaryKeyConstraint(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">    )</span><br><span class="line">    op.create_table(<span class="string">&#x27;draft&#x27;</span>,</span><br><span class="line">    sa.Column(<span class="string">&#x27;id&#x27;</span>, sa.INTEGER(), nullable=<span class="literal">False</span>),</span><br><span class="line">    sa.Column(<span class="string">&#x27;body&#x27;</span>, sa.TEXT(), nullable=<span class="literal">True</span>),</span><br><span class="line">    sa.Column(<span class="string">&#x27;edit_time&#x27;</span>, sa.INTEGER(), nullable=<span class="literal">True</span>),</span><br><span class="line">    sa.PrimaryKeyConstraint(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># ### end Alembic commands ###</span></span><br></pre></td></tr></table></figure>

<p>从上面的代码可以看出，迁移脚本主要包含了两个函数：</p>
<ul>
<li>upgrate()函数用来将改动应用到数据库，函数中包含了向表中添加timestamp字段的命令，</li>
<li>而downgrade()函数用来撤消改动，包含了删除timestamp字段的命令。</li>
</ul>
<p>所以我们执行<code>python manage.py db upgrade</code> 和 <code>python manage.py db downgrade</code> 其实就是执行这两个函数</p>
</blockquote>
<h3 id="使用flask-script和flask-migrate"><a href="#使用flask-script和flask-migrate" class="headerlink" title="使用flask-script和flask-migrate"></a>使用flask-script和flask-migrate</h3><p>使用flask-script管理数据库创立，此外flask-migrate也支持flask-script的命令行接口，所以可以用flask-script统一管理。</p>
<ol>
<li>flask-migrate提供了一个ManagerCommand类，可以附加在flask-script的Manager类实例上。</li>
<li>使用add_command()添加一个shell命令。使用shell命令将进入python shell状态，由于将db加入了上下文，可以使用shell手动创建数据库</li>
</ol>
<h2 id="会话技术"><a href="#会话技术" class="headerlink" title="会话技术"></a>会话技术</h2><ul>
<li>跨请求共享数据</li>
<li>出现原因<ol>
<li>web开发中http都是短连接</li>
<li>http请求是无状态的</li>
<li>请求从request到response就结束了</li>
</ol>
</li>
<li>Cookie</li>
<li>Session</li>
<li>Token</li>
</ul>
<h3 id="设置获取cookies"><a href="#设置获取cookies" class="headerlink" title="设置获取cookies"></a>设置获取cookies</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@blue.route(<span class="params"><span class="string">&#x27;/test/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">    resp = Response(<span class="string">&#x27;登录成功&#x27;</span>)</span><br><span class="line">    resp.set_cookies(<span class="string">&#x27;username&#x27;</span>,username)</span><br><span class="line">    <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@blue.route(<span class="params"><span class="string">&#x27;/test/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">    username = reques.cookies.get(<span class="string">&#x27;username&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="设置获取Session"><a href="#设置获取Session" class="headerlink" title="设置获取Session"></a>设置获取Session</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@blue.route(<span class="params"><span class="string">&#x27;/test/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">    resp = Response(<span class="string">&#x27;登录成功&#x27;</span>)</span><br><span class="line">    session[<span class="string">&#x27;username&#x27;</span>] = <span class="string">&#x27;hyl&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"><span class="meta">@blue.route(<span class="params"><span class="string">&#x27;/test/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">    username = session.get(<span class="string">&#x27;username&#x27;</span>)</span><br></pre></td></tr></table></figure>



<blockquote>
<ol>
<li><p>flask中的cookie默认对中文进行了处理，直接可以使用中文</p>
</li>
<li><p>Django对session序列化到数据库中 , 但是Flask默认是存储到内存中</p>
</li>
<li><p><strong>Django是将Session的Key作为SessionID传给cookies , flask将整个session序列化,然后将这整个序列化的session存到cookies中</strong></p>
<blockquote>
<p>也就是说:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@blue.route(<span class="params"><span class="string">&#x27;/test/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line"> session[<span class="string">&#x27;username&#x27;</span>] = <span class="string">&#x27;hyl&#x27;</span></span><br><span class="line"> session[<span class="string">&#x27;password&#x27;</span>] = <span class="string">&#x27;110&#x27;</span></span><br><span class="line"> <span class="keyword">return</span> Response(<span class="string">&#x27;登录成功&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>Django就是将username,password这两个键作为cookies的值</li>
<li>Flask是将{‘username’:’hyl’,’password’:’110’}序列化后作为cookies的值</li>
</ul>
<p>这就造成这样的现象 : </p>
<ul>
<li>用户A请求网页B,Flask为用户A设置了session.之后flask挂掉了重新启动(也就是说内存里面已经没有session了).但是用户A依旧能使用这个session</li>
<li>原因 : Flask的session保存了完整的信息,Flask只要在接收后解密就行了</li>
</ul>
</blockquote>
<blockquote>
<p>实际Flask对session的操作:</p>
<ol>
<li>将session数据序列化</li>
<li>生成签名,hash</li>
<li>base64编码</li>
<li>组装在一条数据上,存储在客户端</li>
</ol>
</blockquote>
</li>
</ol>
</blockquote>
<h2 id="flask-session使用"><a href="#flask-session使用" class="headerlink" title="flask_session使用"></a>flask_session使用</h2><ul>
<li>实现了服务端session</li>
<li>将数据存储服务端，将数据对应的key存储在cookies中</li>
<li>flask_session是嵌入级的插件,不需要修改flask源码 , 只需要配置redis就可以了</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, session</span><br><span class="line"><span class="keyword">from</span> flask.ext.session <span class="keyword">import</span> Session</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="comment"># 把session存在了redis里面</span></span><br><span class="line">SESSION_TYPE = <span class="string">&#x27;redis&#x27;</span></span><br><span class="line">app.config.from_object(__name__)</span><br><span class="line"><span class="comment"># 初始化app</span></span><br><span class="line">Session(app)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/set/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set</span>():</span></span><br><span class="line">    session[<span class="string">&#x27;key&#x27;</span>] = <span class="string">&#x27;value&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;ok&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/get/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span>():</span></span><br><span class="line">    <span class="keyword">return</span> session.get(<span class="string">&#x27;key&#x27;</span>, <span class="string">&#x27;not set&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>有两种使用模式。</p>
<p>一种是使用app初始化实例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app = Flask(__name__)</span><br><span class="line">Session(app)</span><br></pre></td></tr></table></figure>

<p>第二种是创建对象并稍后配置应用程序：(懒加载)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sess = Session()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_app</span>():</span></span><br><span class="line">    app = Flask(__name__)</span><br><span class="line">    sess.init_app(app)</span><br><span class="line">    <span class="keyword">return</span> app</span><br></pre></td></tr></table></figure>



<p>参数:</p>
<ul>
<li><p>SESSION_COOKIE_NAME : 设置返回给客户端的cookie的名称，默认是“session”;放置在response的头部；</p>
</li>
<li><p>SESSION_COOKIE_DOMAIN : 设置会话的域，默认是当前的服务器，因为Session是一个全局的变量，可能应用在多个app中；</p>
</li>
<li><p>SESSION_COOKIE_PATH : 设置会话的路径，即哪些路由下应该设置cookie，如果不设置，那么默认为‘/’，所有的路由都会设置cookie；</p>
</li>
<li><p>SESSION_COOKIE_HTTPONLY : cookie应该和httponly标志一起设置，默认为True，这个一般采用默认。</p>
</li>
<li><p>SESSION_COOKIE_SECURE : cookie是否和安全标志一起设置，默认为false，这个一般采用默认。</p>
</li>
<li><p>PERMANENT_SESSION_LIFETIME : 设置session的有效期，即cookie的失效时间，单位是s。这个参数很重要，因为默认会话是永久性的。</p>
</li>
<li><p>SESSION_TYPE</p>
<blockquote>
<p>SESSION_TYPE = ‘null’          : 采用flask默认的保存在cookie中；<br>SESSION_TYPE = ‘redis’         : 保存在redis中<br>SESSION_TYPE = ‘memcached’     : 保存在memcache<br>SESSION_TYPE = ‘filesystem’      : 保存在文件<br>SESSION_TYPE = ‘mongodb’        : 保存在MongoDB<br>SESSION_TYPE = ‘sqlalchemy’     : 保存在关系型数据库</p>
</blockquote>
</li>
<li><p>SESSION_PERMANENT : 是否使用永久会话，默认True，但是如果设置了PERMANENT_SESSION_LIFETIME，则这个失效；</p>
</li>
<li><p>SESSION_USE_SIGNER : 是否为cookie设置签名来保护数据不被更改，默认是False；如果设置True,那么必须设置flask的secret_key参数；</p>
</li>
<li><p>SESSION_KEY_PREFIX : 在所有的会话键之前添加前缀，对于不同的应用程序可以使用不同的前缀；默认“session:”，即保存在redis中的键的名称前都是以“session:”开头<code>SESSION_KEY_PREFIX = &#39;session:&#39;</code>；</p>
</li>
<li><p>SESSION_REDIS : 如果SESSION_TYPE = ‘redis’，那么设置该参数连接哪个redis，其是一个连接对象；如果不设置的话，默认连接127.0.0.1:6379/0</p>
<blockquote>
<p>SESSION_REDIS = redis.StrictRedis(host=”127.0.0.1”, port=6390, db=4)</p>
</blockquote>
</li>
</ul>
<h2 id="Flask-caching使用"><a href="#Flask-caching使用" class="headerlink" title="Flask-caching使用"></a>Flask-caching使用</h2><p>使用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_caching <span class="keyword">import</span> Cache</span><br><span class="line"></span><br><span class="line">cache = Cahce(config=&#123;<span class="string">&#x27;CACHE_TYPE&#x27;</span>:<span class="string">&#x27;simple&#x27;</span>&#125;)</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">cache.init_app(app)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># view.py</span></span><br><span class="line"><span class="comment"># 缓存时间为50秒</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/index/&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@cache.cached(<span class="params">timeout=<span class="number">50</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里的存储是存储整个request , 也就是说50秒内只会在第一次执行index函数 , 其余的都是执行从存缓中返回html代码</p>
</blockquote>
<p>使用redis</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_caching <span class="keyword">import</span> Cache</span><br><span class="line"></span><br><span class="line">cache = Cahce(config=&#123;<span class="string">&#x27;CACHE_TYPE&#x27;</span>:<span class="string">&#x27;redis&#x27;</span>&#125;)</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">cache.init_app(app)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># view.py</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/index/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">   username =  cache.get(<span class="string">&#x27;username&#x27;</span>) <span class="comment"># 获取</span></span><br><span class="line">    cache.<span class="built_in">set</span>(<span class="string">&#x27;username&#x27;</span>:session.get(<span class="string">&#x27;username&#x27;</span>)) <span class="comment"># 设置</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="Flask-DebugToolbar使用"><a href="#Flask-DebugToolbar使用" class="headerlink" title="Flask-DebugToolbar使用"></a>Flask-DebugToolbar使用</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_debugtoolbar <span class="keyword">import</span> DebugToolbarExtension</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># set a &#x27;SECRET_KEY&#x27; to enable the Flask session cookies</span></span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="string">&#x27;&lt;replace with a secret key&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line">toolbar = DebugToolbarExtension()</span><br><span class="line">app = create_app(<span class="string">&#x27;the-config.cfg&#x27;</span>)</span><br><span class="line">toolbar.init_app(app)</span><br></pre></td></tr></table></figure>



<h2 id="flask-mail使用"><a href="#flask-mail使用" class="headerlink" title="flask_mail使用"></a>flask_mail使用</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_mail <span class="keyword">import</span> Mail</span><br><span class="line"></span><br><span class="line">mail = Mail()</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">mail.init_app(app)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># config</span></span><br><span class="line">MAIL_DEBUG = <span class="literal">True</span></span><br><span class="line"><span class="comment"># 邮箱服务器</span></span><br><span class="line">MAIL_SERVER = <span class="string">&#x27;smtp.163.com&#x27;</span></span><br><span class="line"><span class="comment"># 端口号</span></span><br><span class="line">MAIL_PORT = <span class="number">465</span></span><br><span class="line"><span class="comment"># 邮箱账号</span></span><br><span class="line">MAIL_USERNAME = os.environ.get(<span class="string">&#x27;MAIL_USERNAME&#x27;</span>)</span><br><span class="line"><span class="comment"># 邮箱授权码</span></span><br><span class="line">MAIL_PASSWORD = os.environ.get(<span class="string">&#x27;MAIL_PASSWORD&#x27;</span>)</span><br><span class="line"><span class="comment"># 邮件发件人名字</span></span><br><span class="line">MAIL_NAME = os.environ.get(<span class="string">&#x27;MAIL_NAME&#x27;</span>)</span><br><span class="line"><span class="comment"># 使用SSL协议</span></span><br><span class="line">MAIL_USE_SSL = <span class="literal">True</span></span><br><span class="line">MAIL_USE_TLS = <span class="literal">False</span></span><br><span class="line"><span class="comment"># 邮件主题</span></span><br><span class="line">SERVERS_EXPIRES_MAIL_SUBJECT = <span class="string">&#x27;服务器过期提醒&#x27;</span></span><br><span class="line">DOMAINS_EXPIRES_MAIL_SUBJECT = <span class="string">&#x27;域名过期提醒&#x27;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_domains_email</span>():</span></span><br><span class="line">    <span class="keyword">from</span> serve <span class="keyword">import</span> app</span><br><span class="line">        subject = app.config.get(<span class="string">&#x27;DOMAINS_EXPIRES_MAIL_SUBJECT&#x27;</span>)</span><br><span class="line">        sender = (app.config.get(<span class="string">&#x27;MAIL_NAME&#x27;</span>),app.config.get(<span class="string">&#x27;MAIL_USERNAME&#x27;</span>))</span><br><span class="line">        template = <span class="string">&#x27;domains/expires.html&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> contact, domains <span class="keyword">in</span> d.items():</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> app.app_context():</span><br><span class="line">                    msg = Message(subject, sender=sender, recipients=[contact.email])</span><br><span class="line">                    msg.html = render_template(template, domains=domains, contact=contact)</span><br><span class="line">                    mail.send(msg)</span><br><span class="line">            <span class="keyword">except</span> ConnectionRefusedError <span class="keyword">as</span> e:</span><br><span class="line">                app.logger.error(<span class="string">&#x27;domains: %s, contact: %s&#x27;</span> % (domains, contact.name))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                app.logger.info(<span class="string">&#x27;domains: %s, contact: %s&#x27;</span> % (domains, contact.name))</span><br></pre></td></tr></table></figure>



<h2 id="Flask-RESTful使用"><a href="#Flask-RESTful使用" class="headerlink" title="Flask_RESTful使用"></a>Flask_RESTful使用</h2><h3 id="使用Resource"><a href="#使用Resource" class="headerlink" title="使用Resource"></a>使用Resource</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_restful <span class="keyword">import</span> Resource,Api</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">api.init_app(app)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义CBV</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span>(<span class="params">Resource</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,<span class="built_in">id</span></span>):</span></span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&#x27;hello&#x27;</span>:<span class="string">&#x27;world&#x27;</span>&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self,<span class="built_in">id</span></span>):</span></span><br><span class="line">        <span class="comment"># 输出字典 , 后台会直接将其序列化</span></span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&#x27;hello&#x27;</span>:<span class="string">&#x27;world&#x27;</span>&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 将CBV注册到url中</span></span><br><span class="line">api.add_resource(HelloWorld,<span class="string">&#x27;/user/&lt;int:id&gt;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>初始化 : 使用APP进行Api的初始化</li>
<li>创建资源:<ul>
<li>继承Resource</li>
<li>和视图行为基本一致</li>
<li>CBV</li>
</ul>
</li>
<li>注册资源 : 在API上添加</li>
</ul>
<blockquote>
<p>RESTful接口返回的JSON格式:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 单个对象</span></span><br><span class="line">&#123;</span><br><span class="line">    &#x27;status&#x27;:<span class="number">200</span>,</span><br><span class="line">    &#x27;msg&#x27;:&#x27;ok&#x27;,</span><br><span class="line">    &#x27;data&#x27;: &#123;</span><br><span class="line">        &#x27;property&#x27;:&#x27;value&#x27;,</span><br><span class="line">        &#x27;property&#x27;:&#x27;value&#x27;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 多个对象</span></span><br><span class="line">&#123;</span><br><span class="line">    &#x27;status&#x27;:<span class="number">200</span>,</span><br><span class="line">    &#x27;msg&#x27;:&#x27;ok&#x27;,</span><br><span class="line">    &#x27;data&#x27;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &#x27;property&#x27;:&#x27;value&#x27;,</span><br><span class="line">            &#x27;property&#x27;:&#x27;value&#x27;,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">             &#x27;property&#x27;:&#x27;value&#x27;,</span><br><span class="line">            &#x27;property&#x27;:&#x27;value&#x27;,</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</blockquote>
<h3 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_restful <span class="keyword">import</span> Resource , marshal</span><br><span class="line"></span><br><span class="line">goods_fields = &#123;</span><br><span class="line">    <span class="string">&quot;g_name&quot;</span>:fields.String,</span><br><span class="line">    <span class="string">&quot;g_price&quot;</span>:fields.Float</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodListResource</span>(<span class="params">Resource</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self</span>):</span></span><br><span class="line">        goods = GoodModel.query.first()</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;ok&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;data&#x27;</span>:marshal(goods,goods_fields)</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h3 id="返回复杂JSON"><a href="#返回复杂JSON" class="headerlink" title="返回复杂JSON"></a>返回复杂JSON</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@alarm.route(<span class="params"><span class="string">&#x27;/show_alarm&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_alarm_person</span>():</span></span><br><span class="line">    data = AlarmPerson.get_alarm_person() <span class="keyword">or</span> []</span><br><span class="line">    <span class="keyword">return</span> JsonpResp().success(&#123;<span class="string">&quot;alarms&quot;</span>: data&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> simplejson <span class="keyword">as</span> json</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Response</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JsonpResp</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args</span>):</span></span><br><span class="line">        self.callback = args[<span class="number">0</span>] <span class="keyword">if</span> <span class="built_in">len</span>(args) &gt;= <span class="number">1</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_build</span>(<span class="params">self, jsonify_result</span>):</span></span><br><span class="line">        reponse = Response(jsonify_result)</span><br><span class="line">        <span class="keyword">if</span> self.callback:</span><br><span class="line">            reponse = Response(</span><br><span class="line">                <span class="string">&quot;%s(%s)&quot;</span> % (self.callback, jsonify_result),</span><br><span class="line">                mimetype=<span class="string">&quot;application/javascript&quot;</span></span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">return</span> reponse</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">success</span>(<span class="params">self, data, page_status=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理成功状态下的jsonp请求&quot;&quot;&quot;</span></span><br><span class="line">        d = &#123;<span class="string">&quot;state&quot;</span>: <span class="number">1</span>, <span class="string">&quot;code&quot;</span>: <span class="string">&quot;200&quot;</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;success&quot;</span>, <span class="string">&quot;data&quot;</span>: data&#125;</span><br><span class="line">        <span class="keyword">if</span> page_status <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            d.update(&#123;<span class="string">&quot;page_status&quot;</span>: page_status&#125;)</span><br><span class="line">        <span class="keyword">return</span> self._build(json.dumps(d, ensure_ascii=<span class="literal">False</span>))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">error</span>(<span class="params">self, code, msg</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理错误状态下的jsonp请求&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self._build(</span><br><span class="line">            json.dumps(</span><br><span class="line">                &#123;<span class="string">&quot;state&quot;</span>: <span class="number">0</span>, <span class="string">&quot;code&quot;</span>: code, <span class="string">&quot;msg&quot;</span>: msg&#125;,</span><br><span class="line">                ensure_ascii=<span class="literal">False</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>

<h3 id="使用use-args"><a href="#使用use-args" class="headerlink" title="使用use_args"></a>使用use_args</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> webargs.flaskparser <span class="keyword">import</span> use_kwargs, use_args</span><br><span class="line"></span><br><span class="line"><span class="meta">@alarm.route(<span class="params"><span class="string">&#x27;/delete_alarm&#x27;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="meta">@use_args(<span class="params">&#123;<span class="string">&quot;id&quot;</span>: fields.Int(<span class="params"></span>)&#125;</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_alarm_person</span>(<span class="params">args</span>):</span></span><br><span class="line">    employee = Employee.get_by_id(args[<span class="string">&quot;id&quot;</span>])</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DepartmentSchema</span>(<span class="params">Schema</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;部门数据Schema&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Integer(allow_none=<span class="literal">True</span>)</span><br><span class="line">    name = String(allow_none=<span class="literal">True</span>, validate=Length(</span><br><span class="line">        <span class="built_in">max</span>=Department.name.<span class="built_in">type</span>.length))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListDepartmentSchema</span>(<span class="params">DepartmentSchema, ListSchema</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;部门数据列表的参数Schema&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#######################################</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@department_router.route(<span class="params"><span class="string">&#x27;/api/departments&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="meta">@use_args(<span class="params">ListDepartmentSchema(<span class="params"></span>), locations=(<span class="params"><span class="string">&#x27;query&#x27;</span>,</span>)</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_departments</span>(<span class="params">args</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;视图department.list_departments 部门列表&#x27;&#x27;&#x27;</span></span><br><span class="line">    departments, count = query_data(Department, args)</span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;</span><br><span class="line">        <span class="string">&#x27;data&#x27;</span>: dump(departments, many=<span class="literal">True</span>),</span><br><span class="line">        <span class="string">&#x27;itemsCount&#x27;</span>: count</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/av67507215/?p=51">https://www.bilibili.com/video/av67507215/?p=51</a></p>
</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>