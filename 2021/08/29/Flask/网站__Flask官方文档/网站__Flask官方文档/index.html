<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Flask 内部使用本地线程对象，这样就不必在同一个请求中因为线程安全的原因，而函数之间传递对象。"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>Flask官方文档 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Flask/" rel="tag">Flask</a></div><div class="post-time">2021-08-29</div></div></div><div class="container post-header"><h1>Flask官方文档</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%98%AF%E6%96%87%E4%BB%B6%E5%90%8D%E7%9A%84%E4%BF%9D%E5%AD%98"><span class="toc-number">1.</span> <span class="toc-text">文件上传是文件名的保存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%93%9D%E5%9B%BE%E5%92%8C%E8%A7%86%E5%9B%BE"><span class="toc-number">2.</span> <span class="toc-text">蓝图和视图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DEBUG%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.</span> <span class="toc-text">DEBUG模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TEST%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.</span> <span class="toc-text">TEST模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#test%E7%AE%80%E5%8D%95%E7%A4%BA%E4%BE%8B"><span class="toc-number">4.1.</span> <span class="toc-text">test简单示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flask-appcontext-pushed%E4%BF%A1%E5%8F%B7"><span class="toc-number">4.2.</span> <span class="toc-text">flask.appcontext_pushed信号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#test%E4%B8%AD%E4%BD%BF%E7%94%A8session"><span class="toc-number">4.3.</span> <span class="toc-text">test中使用session</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-CLI-%E5%91%BD%E4%BB%A4"><span class="toc-number">4.4.</span> <span class="toc-text">测试 CLI 命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97"><span class="toc-number">5.</span> <span class="toc-text">错误日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7"><span class="toc-number">6.</span> <span class="toc-text">信号</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A2%E9%98%85%E4%BF%A1%E5%8F%B7"><span class="toc-number">6.1.</span> <span class="toc-text">订阅信号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E8%AE%A2%E9%98%85%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="toc-number">6.2.</span> <span class="toc-text">信号订阅装饰器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%8F%91%E9%80%81%E4%BF%A1%E5%8F%B7"><span class="toc-number">6.3.</span> <span class="toc-text">创建发送信号</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E6%8F%92%E6%8B%94%E8%A7%86%E5%9B%BE"><span class="toc-number">7.</span> <span class="toc-text">可插拔视图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-number">8.</span> <span class="toc-text">应用上下文</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%83%85%E5%A2%83%E7%9A%84%E7%9B%AE%E7%9A%84"><span class="toc-number">8.1.</span> <span class="toc-text">情境的目的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E6%83%85%E5%A2%83%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">8.2.</span> <span class="toc-text">应用情境的生命周期</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-number">9.</span> <span class="toc-text">请求上下文</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%83%85%E5%A2%83%E7%9A%84%E7%9B%AE%E7%9A%84-1"><span class="toc-number">9.1.</span> <span class="toc-text">情境的目的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%83%85%E5%A2%83%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">9.2.</span> <span class="toc-text">请求情境的生命周期</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%83%85%E5%A2%83%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C"><span class="toc-number">10.</span> <span class="toc-text">情境如何工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%8E%A5%E5%8F%A3"><span class="toc-number">11.</span> <span class="toc-text">命令行接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CLI%E6%89%8B%E5%8A%A8%E6%8E%A8%E5%85%A5%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-number">11.1.</span> <span class="toc-text">CLI手动推入应用上下文</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E8%B0%83%E5%BA%A6"><span class="toc-number">12.</span> <span class="toc-text">应用调度</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E7%BB%84%E5%90%88"><span class="toc-number">12.1.</span> <span class="toc-text">应用组合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E5%AD%90%E5%9F%9F%E5%90%8D%E8%B0%83%E5%BA%A6"><span class="toc-number">12.2.</span> <span class="toc-text">根据子域名调度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E8%B7%AF%E5%BE%84%E8%B0%83%E5%BA%A6"><span class="toc-number">12.3.</span> <span class="toc-text">根据路径调度</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E7%AE%80%E5%8D%95%E5%BC%82%E5%B8%B8%E7%B1%BB"><span class="toc-number">13.</span> <span class="toc-text">注册简单异常类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#URL-%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">14.</span> <span class="toc-text">URL 处理器</span></a></li></ol></details></div><div class="container post-content"><p>Flask 内部使用本地线程对象，这样就不必在同一个请求中因为线程安全的原因，而函数之间传递对象。</p>
<h2 id="文件上传是文件名的保存"><a href="#文件上传是文件名的保存" class="headerlink" title="文件上传是文件名的保存"></a>文件上传是文件名的保存</h2><p>保存文件的时候最好使用<code>secure_filename</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> werkzeug.utils <span class="keyword">import</span> secure_filename</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/upload&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file</span>():</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        f = request.files[<span class="string">&#x27;the_file&#x27;</span>]</span><br><span class="line">        f.save(<span class="string">&#x27;/var/www/uploads/&#x27;</span> + secure_filename(f.filename))</span><br></pre></td></tr></table></figure>



<h2 id="蓝图和视图"><a href="#蓝图和视图" class="headerlink" title="蓝图和视图"></a>蓝图和视图</h2><ul>
<li><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.Blueprint"><code>Blueprint</code></a> 是一种<strong>组织一组相关视图及其他代码</strong>的方式。与把视图及其他代码直接注册到应用的方式不同，蓝图方式是把它们注册到蓝图，然后在工厂函数中 把蓝图注册到应用。</li>
<li>视图是一个应用对请求进行响应的函数。 </li>
</ul>
<h2 id="DEBUG模式"><a href="#DEBUG模式" class="headerlink" title="DEBUG模式"></a>DEBUG模式</h2><p>有两种方法:</p>
<p>第一种方法不会修改源文件 : </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set FLASK_ENV=development</span><br><span class="line">flask run</span><br></pre></td></tr></table></figure>

<p>另一种方法:</p>
<ol>
<li>在config文件配置好<code>DEBUG=True</code></li>
<li>cmd执行<code>pythyon app.py</code>(其中的app.py是入口文件)</li>
</ol>
<h2 id="TEST模式"><a href="#TEST模式" class="headerlink" title="TEST模式"></a>TEST模式</h2><h3 id="test简单示例"><a href="#test简单示例" class="headerlink" title="test简单示例"></a>test简单示例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), <span class="string">&#x27;../&#x27;</span>)))</span><br><span class="line"><span class="keyword">import</span> pytest</span><br><span class="line"><span class="keyword">from</span> test_app <span class="keyword">import</span> create_app</span><br><span class="line"></span><br><span class="line"><span class="meta">@pytest.fixture</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">app</span>():</span></span><br><span class="line">    app = create_app(<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line">    <span class="keyword">with</span> app.app_context() <span class="keyword">as</span> context:</span><br><span class="line">        <span class="keyword">yield</span> app</span><br><span class="line"></span><br><span class="line"><span class="meta">@pytest.fixture</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">client</span>(<span class="params">app</span>):</span></span><br><span class="line">    <span class="keyword">with</span> app.test_client() <span class="keyword">as</span> c:</span><br><span class="line">        <span class="keyword">yield</span> c</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_session</span>(<span class="params">client</span>):</span></span><br><span class="line">    rep = client.get(<span class="string">&#x27;/mysession&#x27;</span>)</span><br><span class="line">    <span class="keyword">assert</span> rep.status_code == <span class="number">200</span></span><br><span class="line">    <span class="keyword">assert</span> flask.session[<span class="string">&#x27;name&#x27;</span>] == <span class="string">&#x27;heyingliang&#x27;</span></span><br><span class="line">    <span class="keyword">assert</span> <span class="string">b&#x27;123&#x27;</span> <span class="keyword">in</span> rep.data</span><br></pre></td></tr></table></figure>

<ul>
<li><p>在使用<code>test_client()</code>函数时 , TESTING配置自动设置为True</p>
</li>
<li><p>测试请求环境中 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.Flask.before_request"><code>before_request()</code></a> 和 <a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/api.html#flask.Flask.after_request"><code>after_request()</code></a> 不会被自动调用。如果需要 <code>before_request()</code> 函数和正常情况下一样被调用，那么需要自己调用 <code>preprocess_request()</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">app = flask.Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> app.test_request_context(<span class="string">&#x27;/?name=Peter&#x27;</span>):</span><br><span class="line">    app.preprocess_request()</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line"><span class="keyword">with</span> app.test_request_context(<span class="string">&#x27;/?name=Peter&#x27;</span>):</span><br><span class="line">    resp = Response(<span class="string">&#x27;...&#x27;</span>)</span><br><span class="line">    resp = app.process_response(resp)</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="flask-appcontext-pushed信号"><a href="#flask-appcontext-pushed信号" class="headerlink" title="flask.appcontext_pushed信号"></a>flask.appcontext_pushed信号</h3><p>当<strong>推送应用程序上下文</strong>时发送此信号。发送者是应用程序。这通常对于单元测试很有用，以便暂时获取信息。例如，它可以用于将资源尽早设置到g对象上。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> contextlib <span class="keyword">import</span> contextmanager</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> appcontext_pushed</span><br><span class="line"></span><br><span class="line"><span class="meta">@contextmanager</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_set</span>(<span class="params">app, user</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handler</span>(<span class="params">sender, **kwargs</span>):</span></span><br><span class="line">        g.user = user</span><br><span class="line">    <span class="keyword">with</span> appcontext_pushed.connected_to(handler, app):</span><br><span class="line">        <span class="keyword">yield</span></span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_user_me</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="keyword">with</span> user_set(app, <span class="string">&#x27;john&#x27;</span>):</span><br><span class="line">        c = app.test_client()</span><br><span class="line">        resp = c.get(<span class="string">&#x27;/users/me&#x27;</span>)</span><br><span class="line">        <span class="keyword">assert</span> resp.data == <span class="string">&#x27;username=john&#x27;</span></span><br></pre></td></tr></table></figure>



<h3 id="test中使用session"><a href="#test中使用session" class="headerlink" title="test中使用session"></a>test中使用session</h3><p>在test中 , <code>flask.session</code>只能用于获取 , 不能设置 , 也不能在请求发出前获取session</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> app.test_client() <span class="keyword">as</span> c:</span><br><span class="line">    rv = c.get(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    <span class="comment"># 在请求发出后才能使用flask.session获取session</span></span><br><span class="line">    <span class="keyword">assert</span> flask.session[<span class="string">&#x27;foo&#x27;</span>] == <span class="number">42</span></span><br></pre></td></tr></table></figure>

<p>如果想设置session , 或者在请求发出前获取session :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> app.test_client() <span class="keyword">as</span> c:</span><br><span class="line">    <span class="keyword">with</span> c.session_transaction() <span class="keyword">as</span> sess:</span><br><span class="line">        sess[<span class="string">&#x27;a_key&#x27;</span>] = <span class="string">&#x27;a value&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 一旦到达，session就被存储并准备好供客户机使用</span></span><br><span class="line">    c.get(...)</span><br></pre></td></tr></table></figure>

<p>使用如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@pytest.fixture</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">app</span>():</span></span><br><span class="line">    app = create_app(<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line">    <span class="keyword">with</span> app.app_context() <span class="keyword">as</span> context:</span><br><span class="line">        <span class="keyword">yield</span> app</span><br><span class="line"></span><br><span class="line"><span class="meta">@pytest.fixture</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">client</span>(<span class="params">app</span>):</span></span><br><span class="line">    <span class="keyword">with</span> app.test_client() <span class="keyword">as</span> c:</span><br><span class="line">        <span class="keyword">yield</span> c</span><br><span class="line"></span><br><span class="line"><span class="meta">@pytest.fixture</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">session_client</span>(<span class="params">app</span>):</span></span><br><span class="line">    <span class="comment"># 使用此client,就会携带a_key这个session</span></span><br><span class="line">    <span class="keyword">with</span> app.test_client() <span class="keyword">as</span> c:</span><br><span class="line">        <span class="keyword">with</span> c.session_transaction() <span class="keyword">as</span> sess:</span><br><span class="line">            sess[<span class="string">&#x27;a_key&#x27;</span>] = <span class="string">&#x27;a_value&#x27;</span></span><br><span class="line">        <span class="keyword">yield</span> c</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_session</span>(<span class="params">client</span>):</span></span><br><span class="line">    rep = client.get(<span class="string">&#x27;/mysession&#x27;</span>)</span><br><span class="line">    <span class="comment"># 在请求后获取session</span></span><br><span class="line">    <span class="keyword">assert</span> flask.session[<span class="string">&#x27;a_key&#x27;</span>] == <span class="string">&#x27;a_value&#x27;</span></span><br></pre></td></tr></table></figure>



<h3 id="测试-CLI-命令"><a href="#测试-CLI-命令" class="headerlink" title="测试 CLI 命令"></a>测试 CLI 命令</h3><p>Flask 提供 test_cli_runner() 来创建一个 FlaskCliRunner ，以自动传递 Flask 应用给 CLI 。用 它的 invoke() 方法调用命令</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> click</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.cli.command(<span class="params"><span class="string">&#x27;hello&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@click.option(<span class="params"><span class="string">&#x27;--name&#x27;</span>, default=<span class="string">&#x27;World&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_command</span>(<span class="params">name</span>)</span></span><br><span class="line"><span class="function">    <span class="title">click</span>.<span class="title">echo</span>(<span class="params"><span class="string">f&#x27;Hello, <span class="subst">&#123;name&#125;</span>!&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">def</span> <span class="title">test_hello</span>():</span></span><br><span class="line">    runner = app.test_cli_runner()</span><br><span class="line">    <span class="comment"># invoke the command directly</span></span><br><span class="line">    result = runner.invoke(hello_command, [<span class="string">&#x27;--name&#x27;</span>, <span class="string">&#x27;Flask&#x27;</span>])</span><br><span class="line">    <span class="keyword">assert</span> <span class="string">&#x27;Hello, Flask&#x27;</span> <span class="keyword">in</span> result.output</span><br><span class="line">    <span class="comment"># or by name</span></span><br><span class="line">    result = runner.invoke(args=[<span class="string">&#x27;hello&#x27;</span>])</span><br><span class="line">    <span class="keyword">assert</span> <span class="string">&#x27;World&#x27;</span> <span class="keyword">in</span> result.output</span><br></pre></td></tr></table></figure>



<h2 id="错误日志"><a href="#错误日志" class="headerlink" title="错误日志"></a>错误日志</h2><p>错误日志工具 sentry-sdk 客户端:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install sentry-sdk[flask]</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sentry_sdk</span><br><span class="line"><span class="keyword">from</span> sentry_sdk.integrations.flask <span class="keyword">import</span> FlaskIntegration</span><br><span class="line">sentry_sdk.init(<span class="string">&#x27;YOUR_DSN_HERE&#x27;</span>,integrations=[FlaskIntegration()])</span><br></pre></td></tr></table></figure>



<h2 id="信号"><a href="#信号" class="headerlink" title="信号"></a>信号</h2><p>信号功能由优秀的 blinker 库提供支持</p>
<blockquote>
<p>什么是信号？</p>
<p>当核心框架的其他地方或另一个 Flask 扩展中发生动作时，信号通过发送通知来帮助你解耦应用。<br>简言之，信号允许某个发送者通知接收者有事情发生了。</p>
</blockquote>
<h3 id="订阅信号"><a href="#订阅信号" class="headerlink" title="订阅信号"></a>订阅信号</h3><ul>
<li>信号的 <a target="_blank" rel="noopener" href="https://pythonhosted.org/blinker/index.html#blinker.base.Signal.connect"><code>connect()</code></a> 方法可以订阅信号。</li>
<li>使用 <a target="_blank" rel="noopener" href="https://pythonhosted.org/blinker/index.html#blinker.base.Signal.disconnect"><code>disconnect()</code></a> 方法可以退订信号。</li>
</ul>
<p>下面是一个情境管理器的辅助工具，可用于在单元测试中辨别哪个模板被渲染了，哪 些变量被传递给了模板:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># template_rendered : 模板渲染完毕的信号</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> template_rendered</span><br><span class="line"><span class="keyword">from</span> contextlib <span class="keyword">import</span> contextmanager</span><br><span class="line"></span><br><span class="line"><span class="meta">@contextmanager</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">captured_templates</span>(<span class="params">app</span>):</span></span><br><span class="line">    recorded = []</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">record</span>(<span class="params">sender, template, context, **extra</span>):</span></span><br><span class="line">        recorded.append((template, context))</span><br><span class="line">    template_rendered.connect(record, app)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span> recorded</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        template_rendered.disconnect(record, app)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> captured_templates(app) <span class="keyword">as</span> templates:</span><br><span class="line">    rv = app.test_client().get(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    <span class="keyword">assert</span> rv.status_code == <span class="number">200</span></span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(templates) == <span class="number">1</span></span><br><span class="line">    template, context = templates[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">assert</span> template.name == <span class="string">&#x27;index.html&#x27;</span></span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(context[<span class="string">&#x27;items&#x27;</span>]) == <span class="number">10</span></span><br></pre></td></tr></table></figure>



<h3 id="信号订阅装饰器"><a href="#信号订阅装饰器" class="headerlink" title="信号订阅装饰器"></a>信号订阅装饰器</h3><p>通过使用新的 <code>connect_via()</code> 装饰器轻松订阅信号:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> template_rendered</span><br><span class="line"></span><br><span class="line"><span class="meta">@template_rendered.connect_via(<span class="params">app</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">when_template_rendered</span>(<span class="params">sender, template, context, **extra</span>):</span></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;Template %s is rendered with %s&#x27;</span> % (template.name, context)</span><br></pre></td></tr></table></figure>



<h3 id="创建发送信号"><a href="#创建发送信号" class="headerlink" title="创建发送信号"></a>创建发送信号</h3><ul>
<li>在自定义的 <a target="_blank" rel="noopener" href="https://pythonhosted.org/blinker/index.html#blinker.base.Namespace"><code>Namespace</code></a> 中命名信号:</li>
<li>使用 <a target="_blank" rel="noopener" href="https://pythonhosted.org/blinker/index.html#blinker.base.Signal.send"><code>send()</code></a> 方法发送信号 : 第一个参数是一个发送者，其他参数是要发送给订阅者的东西</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> blinker <span class="keyword">import</span> Namespace</span><br><span class="line">my_signals = Namespace()</span><br><span class="line"></span><br><span class="line">model_saved = my_signals.signal(<span class="string">&#x27;model-saved&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Model</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save</span>(<span class="params">self</span>):</span></span><br><span class="line">        model_saved.send(self)</span><br></pre></td></tr></table></figure>



<h2 id="可插拔视图"><a href="#可插拔视图" class="headerlink" title="可插拔视图"></a>可插拔视图</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyView</span>(<span class="params">View</span>):</span></span><br><span class="line">    methods = [<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span><br><span class="line">    decorators = [user_required]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatch_request</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">app.add_url_rule(<span class="string">&#x27;/myview&#x27;</span>, view_func=MyView.as_view(<span class="string">&#x27;myview&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>或者 : </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask.views <span class="keyword">import</span> MethodView</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserAPI</span>(<span class="params">MethodView</span>):</span></span><br><span class="line">    decorators = [user_required]</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, user_id</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self</span>):</span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">app.add_url_rule(</span><br><span class="line">    <span class="string">&#x27;/users/&#x27;</span>, </span><br><span class="line">    view_func=UserAPI.as_view(<span class="string">&#x27;users&#x27;</span>),</span><br><span class="line">    defaults=&#123;<span class="string">&#x27;user_id&#x27;</span>: <span class="literal">None</span>&#125;,</span><br><span class="line">    methods=[<span class="string">&#x27;GET&#x27;</span>,]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<h2 id="应用上下文"><a href="#应用上下文" class="headerlink" title="应用上下文"></a>应用上下文</h2><ul>
<li>应用情境在请求， CLI 命令或其他活动期间跟踪应用级数据。不是将应用程序传递给每个函数，而是代之以访问 current_app 和 g 代理。</li>
<li>这与 <strong>请求情境 类似，它在请求期间跟踪请求级数据</strong>。推送请求情境时会推送相应的应用情境。</li>
</ul>
<h3 id="情境的目的"><a href="#情境的目的" class="headerlink" title="情境的目的"></a>情境的目的</h3><ul>
<li>Flask 应用对象具有诸如 config 之类的属性，这些属性对于在视图和 CLI commands 中访问很有用。</li>
<li>但是，在项目中的模块内导入 app 实例容易导致循环导入问题。</li>
<li>当使用应用程序工厂方案 或编写可重用的 blueprints 或 extensions 时，根本不会有应用程序实例导入。</li>
</ul>
<h3 id="应用情境的生命周期"><a href="#应用情境的生命周期" class="headerlink" title="应用情境的生命周期"></a>应用情境的生命周期</h3><ul>
<li>当 Flask 应用开始处理请求时，它会推送应用情境 和 请求情境 。</li>
<li>当请求结束时，它会在请求情境中弹出，然后在应用情境中弹出。</li>
<li>通常，应用情境将具有与请求相同的生命周期。</li>
</ul>
<h2 id="请求上下文"><a href="#请求上下文" class="headerlink" title="请求上下文"></a>请求上下文</h2><h3 id="情境的目的-1"><a href="#情境的目的-1" class="headerlink" title="情境的目的"></a>情境的目的</h3><ul>
<li>当 Flask 应用处理请求时，它会根据从 WSGI 服务器收到的环境创建一个 Request 对象。因为 工作者 （取决于服务器的线程，进程或协程）一 次只能处理一个请求，所以在该请求期间请求数据可被认为是该工作者的全局数据。 Flask 对此使用术语 本地情境 。</li>
<li>处理请求时， Flask 自动 推送 请求情境。在请求期间运行的视图函数，错误处理器和其他函数将有权访问 request 代理，该请求代理指向当前请求的请求对象。</li>
</ul>
<h3 id="请求情境的生命周期"><a href="#请求情境的生命周期" class="headerlink" title="请求情境的生命周期"></a>请求情境的生命周期</h3><ul>
<li>当 Flask 应用开始处理请求时，它会推送请求情境，这也会推送 应用情境 。当请求结束时，它会弹出请求情境，然后弹出应用程序情境。</li>
<li>情境对于每个线程（或其他工作者类型）是唯一的。 request 不能传递给 另一个线程，另一个线程将拥有不同的情境堆栈，并且不会知道父线程指向的请求。</li>
</ul>
<h2 id="情境如何工作"><a href="#情境如何工作" class="headerlink" title="情境如何工作"></a>情境如何工作</h2><ol>
<li>处理每个请求时都会调用 Flask.wsgi_app() 方法。它在请求期间管理情境。 在内部，请求和应用程序情境实质是 _request_ctx_stack 和 _app_ctx_stack 堆栈。</li>
<li>当情境被压入堆栈时，依赖它们的代理可用并指向堆栈顶部情境中的信息。</li>
<li>当请求开始时，将创建并推送 RequestContext ，如果该应用程序的情境尚不是顶级情境，则该请求会首先创建并推送 AppContext 。</li>
<li>在推送这些情境时， current_app 、 g 、 request 和 session 代理可用于处理请求的原始线程。</li>
<li>由于情境是栈，因此在请求期间可能会压入其他情境导致代理变更。虽然这不是一 种常见模式，但它可以在高级应用使用。比如，执行内部重定向或将不同应用程序链接在一起。</li>
<li>在分派请求并生成和发送响应之后，会弹出请求情境，然后弹出应用情境。在紧临弹出之前，会执行 teardown_request() 和 teardown_appcontext() 函数。即使在调度期间发生未处理的异常， 也会执行这些函数。</li>
</ol>
<blockquote>
<p>在请求结束时，会弹出请求情境，并且与其关联的所有数据都将被销毁。如果在开发 过程中发生错误，延迟销毁数据以进行调试是有用的。</p>
<p>当开发服务器以开发模式运行时（ <code>FLASK_ENV</code> 环境变量设置为 <code>&#39;development&#39;</code> ），错误和数据将被保留并显示在交互式调试器中。</p>
</blockquote>
<h2 id="命令行接口"><a href="#命令行接口" class="headerlink" title="命令行接口"></a>命令行接口</h2><p>如果你的应用使用蓝图，那么可以把 CLI 命令 直接注册到蓝图上。当蓝图注册到 应用上的时候，相关的命令就可以应用于 <code>flask</code> 命令了。缺省情况下，那些 命令会嵌套于一个与蓝图相关匹配的组。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint</span><br><span class="line"></span><br><span class="line">bp = Blueprint(<span class="string">&#x27;students&#x27;</span>, __name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@bp.cli.command(<span class="params"><span class="string">&#x27;create&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@click.argument(<span class="params"><span class="string">&#x27;name&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">name</span>):</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">app.register_blueprint(bp)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ flask students create alice</span><br></pre></td></tr></table></figure>



<h3 id="CLI手动推入应用上下文"><a href="#CLI手动推入应用上下文" class="headerlink" title="CLI手动推入应用上下文"></a>CLI手动推入应用上下文</h3><p>使用 Flask 应用的 cli command() 装饰器添加的命令会在执行 时压入应用情境，这样命令和扩展就可以访问应用和应用的配置。如果使用 Click 的 command() 装饰器创建命令，而不是 Flask 的装饰器，那 么可以使用 with_appcontext() ，达到同样的效果。</p>
<p>之前: </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> click</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.cli.command(<span class="params"><span class="string">&quot;create-user&quot;</span></span>)</span></span><br><span class="line"><span class="meta">@click.argument(<span class="params"><span class="string">&quot;name&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_user</span>(<span class="params">name</span>):</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>现在 : </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> click</span><br><span class="line"><span class="keyword">from</span> flask.cli <span class="keyword">import</span> with_appcontext</span><br><span class="line"></span><br><span class="line"><span class="meta">@click.command</span></span><br><span class="line"><span class="meta">@with_appcontext</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_work</span>():</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">app.cli.add_command(do_work)</span><br></pre></td></tr></table></figure>



<h2 id="应用调度"><a href="#应用调度" class="headerlink" title="应用调度"></a>应用调度</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> werkzeug.serving <span class="keyword">import</span> run_simple</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello World!&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    run_simple(<span class="string">&#x27;localhost&#x27;</span>, <span class="number">5000</span>, app,</span><br><span class="line">               use_reloader=<span class="literal">True</span>, use_debugger=<span class="literal">True</span>, use_evalex=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>



<h3 id="应用组合"><a href="#应用组合" class="headerlink" title="应用组合"></a>应用组合</h3><p>app dispatch技术实现了app的隔离（独立的<code>login manager</code>、<code>secret_key</code>等），同时让每层业务系统都能模块化（只关心自己的URL部分）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> werkzeug.wsgi <span class="keyword">import</span> DispatcherMiddleware</span><br><span class="line"></span><br><span class="line">app = DispatcherMiddleware(app,&#123; <span class="string">&#x27;/app1&#x27;</span>: app1, <span class="string">&#x27;/app2&#x27;</span>: app2 &#125;)</span><br></pre></td></tr></table></figure>



<h3 id="根据子域名调度"><a href="#根据子域名调度" class="headerlink" title="根据子域名调度"></a>根据子域名调度</h3><ul>
<li>WSGI 层是完美的抽象层，因此可以<strong>写一个你自己的 WSGI 应用来监视请求，并把请求分配给你的 Flask 应用</strong>。可以把应用创建过程放在一个函数中，这样调用这个函数就可以创建一个应用的实例</li>
<li>最常见的做法是每个子域创建一个应用，配置服务器来调度所有子域的应用请求，使用子域来创建用户自定义的实例。一旦你的服务器可以监听所有子域，那么就可以使用一个很简单的 WSGI 应用来动态创建应用了。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Lock</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubdomainDispatcher</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, domain, create_app</span>):</span></span><br><span class="line">        self.domain = domain</span><br><span class="line">        self.create_app = create_app</span><br><span class="line">        self.lock = Lock()</span><br><span class="line">        self.instances = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_application</span>(<span class="params">self, host</span>):</span></span><br><span class="line">        host = host.split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">assert</span> host.endswith(self.domain), <span class="string">&#x27;Configuration error&#x27;</span></span><br><span class="line">        subdomain = host[:-<span class="built_in">len</span>(self.domain)].rstrip(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">        <span class="keyword">with</span> self.lock:</span><br><span class="line">            app = self.instances.get(subdomain)</span><br><span class="line">            <span class="keyword">if</span> app <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                app = self.create_app(subdomain)</span><br><span class="line">                self.instances[subdomain] = app</span><br><span class="line">            <span class="keyword">return</span> app</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, environ, start_response</span>):</span></span><br><span class="line">        app = self.get_application(environ[<span class="string">&#x27;HTTP_HOST&#x27;</span>])</span><br><span class="line">        <span class="keyword">return</span> app(environ, start_response)</span><br></pre></td></tr></table></figure>

<p>调度器示例:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> myapplication <span class="keyword">import</span> create_app, get_user_for_subdomain</span><br><span class="line"><span class="keyword">from</span> werkzeug.exceptions <span class="keyword">import</span> NotFound</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_app</span>(<span class="params">subdomain</span>):</span></span><br><span class="line">    user = get_user_for_subdomain(subdomain)</span><br><span class="line">    <span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># 如果子域没有对应的用户，那么还是得返回一个 WSGI 应用</span></span><br><span class="line">        <span class="comment"># 用于处理请求。这里我们把 NotFound() 异常作为应用返回，</span></span><br><span class="line">        <span class="comment"># 它会被渲染为一个缺省的 404 页面。然后，可能还需要把</span></span><br><span class="line">        <span class="comment"># 用户重定向到主页。</span></span><br><span class="line">        <span class="keyword">return</span> NotFound()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 否则为特定用户创建应用</span></span><br><span class="line">    <span class="keyword">return</span> create_app(user)</span><br><span class="line"></span><br><span class="line">application = SubdomainDispatcher(<span class="string">&#x27;example.com&#x27;</span>, make_app)</span><br></pre></td></tr></table></figure>



<h3 id="根据路径调度"><a href="#根据路径调度" class="headerlink" title="根据路径调度"></a>根据路径调度</h3><p>上面我们通过查找 <code>Host</code> 头来判断子域，现 在只要查找请求路径的第一个斜杠之前的路径就可以了:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Lock</span><br><span class="line"><span class="keyword">from</span> werkzeug.wsgi <span class="keyword">import</span> pop_path_info, peek_path_info</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PathDispatcher</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, default_app, create_app</span>):</span></span><br><span class="line">        self.default_app = default_app</span><br><span class="line">        self.create_app = create_app</span><br><span class="line">        self.lock = Lock()</span><br><span class="line">        self.instances = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_application</span>(<span class="params">self, prefix</span>):</span></span><br><span class="line">        <span class="keyword">with</span> self.lock:</span><br><span class="line">            app = self.instances.get(prefix)</span><br><span class="line">            <span class="keyword">if</span> app <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                app = self.create_app(prefix)</span><br><span class="line">                <span class="keyword">if</span> app <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    self.instances[prefix] = app</span><br><span class="line">            <span class="keyword">return</span> app</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, environ, start_response</span>):</span></span><br><span class="line">        app = self.get_application(peek_path_info(environ))</span><br><span class="line">        <span class="keyword">if</span> app <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            pop_path_info(environ)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            app = self.default_app</span><br><span class="line">        <span class="keyword">return</span> app(environ, start_response)</span><br></pre></td></tr></table></figure>

<p>与根据子域调度相比最大的不同是：根据路径调度时，如果创建函数返回 <code>None</code> ，那么就会回落到另一个应用:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> myapplication <span class="keyword">import</span> create_app, default_app, get_user_for_prefix</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_app</span>(<span class="params">prefix</span>):</span></span><br><span class="line">    user = get_user_for_prefix(prefix)</span><br><span class="line">    <span class="keyword">if</span> user <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> create_app(user)</span><br><span class="line"></span><br><span class="line">application = PathDispatcher(default_app, make_app)</span><br></pre></td></tr></table></figure>



<h2 id="注册简单异常类"><a href="#注册简单异常类" class="headerlink" title="注册简单异常类"></a>注册简单异常类</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> jsonify</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InvalidUsage</span>(<span class="params">Exception</span>):</span></span><br><span class="line">    status_code = <span class="number">400</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, message, status_code=<span class="literal">None</span>, payload=<span class="literal">None</span></span>):</span></span><br><span class="line">        Exception.__init__(self)</span><br><span class="line">        self.message = message</span><br><span class="line">        <span class="keyword">if</span> status_code <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.status_code = status_code</span><br><span class="line">        self.payload = payload</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">to_dict</span>(<span class="params">self</span>):</span></span><br><span class="line">        rv = <span class="built_in">dict</span>(self.payload <span class="keyword">or</span> ())</span><br><span class="line">        rv[<span class="string">&#x27;message&#x27;</span>] = self.message</span><br><span class="line">        <span class="keyword">return</span> rv</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.errorhandler(<span class="params">InvalidUsage</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_invalid_usage</span>(<span class="params">error</span>):</span></span><br><span class="line">    response = jsonify(error.to_dict())</span><br><span class="line">    response.status_code = error.status_code</span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/foo&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_foo</span>():</span></span><br><span class="line">    <span class="keyword">raise</span> InvalidUsage(<span class="string">&#x27;This view is gone&#x27;</span>, status_code=<span class="number">410</span>)</span><br></pre></td></tr></table></figure>



<h2 id="URL-处理器"><a href="#URL-处理器" class="headerlink" title="URL 处理器"></a>URL 处理器</h2><p>对于国际化视图</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&lt;lang_code&gt;/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">lang_code</span>):</span></span><br><span class="line">    g.lang_code = lang_code</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&lt;h1&gt;Index of language %s&lt;/h1&gt;&#x27;</span> % g.lang_code</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&lt;lang_code&gt;/path&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">path</span>(<span class="params">lang_code</span>):</span></span><br><span class="line">    g.lang_code = lang_code</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&lt;h1&gt;Language base URL is %s&lt;/h1&gt;&#x27;</span> % url_for(<span class="string">&#x27;index&#x27;</span>, lang_code=g.lang_code)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>每个路由都要加<code>lang_code</code>参数，而且每个视图函数都要将这个参数保存在上下文环境变量中以便其他地方使用</p>
</blockquote>
<p>使用 url_defaults() 函数来简化这个问题。这个函数可 以自动把值注入到 url_for() </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, g</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.url_defaults</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_language_code</span>(<span class="params">endpoint, values</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;lang_code&#x27;</span> <span class="keyword">in</span> values <span class="keyword">or</span> <span class="keyword">not</span> g.lang_code:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> app.url_map.is_endpoint_expecting(endpoint, <span class="string">&#x27;lang_code&#x27;</span>):</span><br><span class="line">        values[<span class="string">&#x27;lang_code&#x27;</span>] = g.lang_code</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.url_value_preprocessor</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pull_lang_code</span>(<span class="params">endpoint, values</span>):</span></span><br><span class="line">    g.lang_code = values.pop(<span class="string">&#x27;lang_code&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&lt;lang_code&gt;/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&lt;lang_code&gt;/about&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">about</span>():</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>



<p>看到url处理器</p>
<p><a target="_blank" rel="noopener" href="https://dormousehole.readthedocs.io/en/latest/patterns/urlprocessors.html">https://dormousehole.readthedocs.io/en/latest/patterns/urlprocessors.html</a></p>
</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>