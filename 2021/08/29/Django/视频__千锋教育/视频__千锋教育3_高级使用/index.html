<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;Django的高级使用&quot;&gt;&lt;a href=&quot;#Django的高级使用&quot; class=&quot;headerlink&quot; title=&quot;Django的高级使用&quot;&gt;&lt;/a&gt;Django的高级使用&lt;/h1&gt;&lt;h2 id=&quot;静态文件&quot;&gt;&lt;a href=&quot;#静态文件&quot; class=&quot;headerlink&quot; title=&quot;静态文件&quot;&gt;&lt;/a&gt;静态文件&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;&lt;p&gt;css,js,图片,json文件,字体文件等:"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>千锋教育3_高级使用 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-none-link" href="/tags/Django/" rel="tag">Django</a></div><div class="post-time">2021-08-29</div></div></div><div class="container post-header"><h1>千锋教育3_高级使用</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Django%E7%9A%84%E9%AB%98%E7%BA%A7%E4%BD%BF%E7%94%A8"><span class="toc-number">1.</span> <span class="toc-text">Django的高级使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6"><span class="toc-number">1.1.</span> <span class="toc-text">静态文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">1.2.</span> <span class="toc-text">中间件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87"><span class="toc-number">1.3.</span> <span class="toc-text">上传图片</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E9%A1%B5"><span class="toc-number">1.4.</span> <span class="toc-text">分页</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ajax"><span class="toc-number">1.5.</span> <span class="toc-text">ajax</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%8C%E6%96%87%E6%9C%AC"><span class="toc-number">1.6.</span> <span class="toc-text">富文本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#celery"><span class="toc-number">1.7.</span> <span class="toc-text">celery</span></a></li></ol></li></ol></details></div><div class="container post-content"><h1 id="Django的高级使用"><a href="#Django的高级使用" class="headerlink" title="Django的高级使用"></a>Django的高级使用</h1><h2 id="静态文件"><a href="#静态文件" class="headerlink" title="静态文件"></a>静态文件</h2><ol>
<li><p>css,js,图片,json文件,字体文件等:</p>
<p>就像templates一样,一般都是在manage.py所在文件夹创建一个static文件夹,里面再创建每个app对应的文件夹,在app文件夹下存放css,js,img,font等<br><img src="/images/1555681294793.png" alt="1555681294793"></p>
</li>
<li><p>配置setting.py:<br>setting.py本身就有STATIC_URL选项</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">STATIC_URL = <span class="string">&#x27;/static/&#x27;</span></span><br></pre></td></tr></table></figure>

<p>但是,我们需要配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SRATICFIELS_DIRS = [os.path.join(BASE_DIR,<span class="string">&#x27;static&#x27;</span>)]</span><br><span class="line"><span class="comment"># 这里的static对应static文件夹</span></span><br></pre></td></tr></table></figure>

<p>所以,当我们想用static/myapp/css/style.css时就要:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&#x27;stylesheet&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;text/css&#x27;</span> <span class="attr">href</span>=<span class="string">&#x27;/static/myapp/css/style.css&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&#x27;text/javascript&#x27;</span> <span class="attr">scr</span>=<span class="string">&#x27;/static/myapp/js/hyl.js&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;/static/myapp/img/hyl.png&#x27;</span>/&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>url可以反向解析,静态文件一样可以.</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;# urls的反向解析 #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;myapp:good&#x27; 199 %&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span>链接<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;# 首先在模块顶部导入 #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">load</span></span> static from staticfiles %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="comment">&#123;# 导入需要的文件 #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">static</span></span> &#x27;myapp/img/hyl.png&#x27; %&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>/&gt;</span>FIELS</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h2><ol>
<li><p>概述:<br>一个轻量级,底层的插件(C语言写的),可以==介入Django的请求和响应==.</p>
</li>
<li><p>本质:<br>一个Python类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 引入一个中间件的类</span></span><br><span class="line">MIDDLEWARE = [</span><br><span class="line">    <span class="string">&#x27;django.middleware.security.SecurityMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.sessions.middleware.SessionMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.middleware.common.CommonMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.middleware.csrf.CsrfViewMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.auth.middleware.AuthenticationMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.messages.middleware.MessageMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.middleware.clickjacking.XFrameOptionsMiddleware&#x27;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li>
<li><p>方法:</p>
<ol>
<li>__init__.py:<br>不需要传参数,服务器响应第一个请求的时候自动调用.<strong>用于确定是否启用该中间件</strong>.</li>
<li>process_request(self,request):<br><strong>分配url匹配视图之前</strong>调用.返回None或者HttpResponse对象</li>
<li>process_view(self,request,view_func,view_args,view_kwargs):<br>调用视图之前执行,返回None或者HttpResponse对象.</li>
<li>process_template_response(self,request,response):<br>在视图刚好执行完后调用,返回None或者HttpResponse对象.==在这里可以使用render==</li>
<li>process_response(self,request,response):<br>响应返回浏览器之前调用,返回HttpResponse对象.</li>
<li>process_exception(self,request,exception):<br>当<strong>视图</strong>发生异常时调用,返回HttpResponse对象.</li>
</ol>
</li>
<li><p>中间件作用位置示意图:</p>
<p><img src="/images/05218bda-%E4%B8%AD%E9%97%B4%E4%BB%B6%E4%BD%8D%E7%BD%AE%E7%A4%BA%E6%84%8F%E5%9B%BE.jpg" alt="中间件位置示意图"></p>
</li>
<li><p>自定义中间件:</p>
<ol>
<li><p>和template一样,在manage.py目录下创建一个middleware目录,在创建每个APP对应的目录,里面存放相应的中间件.<br><img src="/images/1555721765806.png" alt="1555721765806"></p>
</li>
<li><p>首先导入MiddlewareMixin:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.utils.deprecation <span class="keyword">import</span> MiddlewareMixin</span><br></pre></td></tr></table></figure>

<p>之后每个中间件都要继承MiddlewareMixin</p>
</li>
<li><p>示例:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">MyMiddleClass</span>(<span class="params">MiddlewareMixin</span>):</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">process_request</span>(<span class="params">self,request</span>):</span></span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&#x27;get的参数为&#x27;</span>,request.GET.get(<span class="string">&#x27;a&#x27;</span>))</span><br></pre></td></tr></table></figure></li>
<li><p>配置setting.py文件:<br>在<code>MIDDLEWARE</code>参数中添加:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MIDDLEWARE = [</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">&#x27;middleware.myapp.mymiddleware.MyMiddleClass&#x27;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
<h2 id="上传图片"><a href="#上传图片" class="headerlink" title="上传图片"></a>上传图片</h2><ol>
<li><p>概述:</p>
<ul>
<li><p>文件上传时,==文件数据存储在urequest.FILES属性中==,</p>
</li>
<li><p>在static目录下啊创建upfile目录用于储存接收上传的文件.<br><img src="/images/1555722727469.png" alt="1555722727469"></p>
</li>
<li><p>配置setting.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 上传文件目录</span></span><br><span class="line">MEDIA_ROOT = os.path.join(BASE_DIR,<span class="string">r&#x27;static\upfile&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>代码示例</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># myapp/views.py</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">savefile</span>(<span class="params">request</span>):</span></span><br><span class="line">	<span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">		f = request.FILES[<span class="string">&#x27;file&#x27;</span>]</span><br><span class="line">		<span class="comment"># 文件在服务器端的路径</span></span><br><span class="line">		filepath = os.path.join(settings.MEDIA_ROOT,f.name)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">with</span> <span class="built_in">open</span>(filepath,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> fp:</span><br><span class="line">			<span class="comment"># 分流读写(分段写入)</span></span><br><span class="line">			<span class="keyword">for</span> info <span class="keyword">in</span> f.chunks():</span><br><span class="line">				fp.write(info)</span><br><span class="line">		<span class="keyword">return</span> HttpResponse(<span class="string">&#x27;上传成功&#x27;</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">return</span> HttpResponse(<span class="string">&#x27;上传失败&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upfile</span>(<span class="params">request</span>):</span></span><br><span class="line">	<span class="keyword">return</span> render(request,<span class="string">&#x27;myapp/upfile.html&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;# templates/upfile.html #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&#x27;cn&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="comment">&lt;!-- form表单上传文件需要加enctype属性 --&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/savefile/&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">		</span><span class="template-tag">&#123;%<span class="name"><span class="name">csrf_token</span></span>%&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;上传&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>结果:<br><img src="/images/1555725737772.png" alt="1555725737772"><br><img src="/images/1555725751967.png" alt="1555725751967"><br><img src="/images/1555725761266.png" alt="1555725761266"></p>
</li>
</ol>
<h2 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h2><ol>
<li><p>Paginator对象:</p>
<ul>
<li><p>创建对象:<br>格式:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Paginator(列表,整数)</span><br><span class="line"><span class="comment"># 例如,25条数据,每页5个,那么就是</span></span><br><span class="line"><span class="comment"># Paginator([...],5)</span></span><br></pre></td></tr></table></figure>

<p>返回值:<br>返回一个分页对象</p>
</li>
<li><p>属性:</p>
<ol>
<li>count:对象总数<br>(25条数据,每页6个,所以Paginator.count就是25)</li>
<li>num_pages:页面总数<br>(25条数据,每页6个,所以Paginator.num_pages就是5)</li>
<li>page_range:页码列表<br>(就是num_pages的列表,num_pages为5,那么Paginator.page_range就是[1,2,3,4,5])<br>注意页码从1开始.</li>
</ol>
</li>
<li><p>方法:<br>Page(num):获得一个Page对象.<br><strong>Paginator分出5页,那么就有5个Page对象</strong>.<br>如果提供的页码不存在会抛出<code>InvaildPag异常</code></p>
</li>
<li><p>异常:</p>
<ol>
<li>InvaildPage:<br>当向Page传递的是一个无效的页码时抛出</li>
<li>PageNotAnInteger:<br>当向Page()传递的不是一个整数时抛出.</li>
<li>EmptyPage:<br>当先Page()传递一个有效值,但是该页面没有数据时抛出.</li>
</ol>
</li>
</ul>
</li>
<li><p>Page对象:</p>
<ul>
<li>创建对象:<br>Pageinator对象的page()方法返回得到Page对象.不需要手动创建.</li>
<li>属性:<ol>
<li>object_list:<br>当前页上所有的数据(对象)列表</li>
<li>number:<br>当前页的页码值</li>
<li>paginator:<br>当前page对象关联的paginator对象</li>
</ol>
</li>
<li>方法:<ol>
<li>has_next():<br>判断是否有下一页,若有返回Ture</li>
<li>has_previous():<br>判断是否有上一页,若有返回True</li>
<li>has_other_pages():<br>判断是否有上一页或下一页</li>
<li>next_page_number():<br>返回下一页的页码,若下一页不存在抛出InvaildPage异常</li>
<li>previous_page_number():<br>返回上一页的页码,若上一页不存在抛出InvaildPage异常</li>
<li>len():<br>返回当前页的数据个数</li>
</ol>
</li>
</ul>
</li>
<li><p>Paginator对象与Page对象的关系:<br>现在有25条数据,每页6条数据.</p>
<ul>
<li>student.objects.all()获取25条数据</li>
<li>调用Paginator方法形成一个Paginator对象</li>
<li>调用Pageinator的Page方法,形成5个Page对象</li>
<li>前面4个Page对象每个对象6条数据,第5个Page对象1条数据</li>
</ul>
<p><img src="/images/Paginator%E5%AF%B9%E8%B1%A1%E5%92%8CPage%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%85%B3%E7%B3%BB.jpg" alt="Paginator对象和Page对象的关系"></p>
</li>
<li><p>代码示例</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 匹配路由</span></span><br><span class="line">url(<span class="string">r&#x27;^studentspage/(\d+)/$&#x27;</span>,views.studentspage)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 视图函数</span></span><br><span class="line"><span class="keyword">from</span> django.core.paginator <span class="keyword">import</span> Paginator</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">studentspage</span>(<span class="params">request,pageid</span>):</span></span><br><span class="line">	<span class="comment"># 所有的学生列表</span></span><br><span class="line">	all_list = Students.objects.<span class="built_in">all</span>()</span><br><span class="line">    <span class="comment"># 调用Paginator函数,生成paginator对象</span></span><br><span class="line">	paginator = Paginator(all_list,<span class="number">6</span>)</span><br><span class="line">    <span class="comment"># 调用paginator对象的page方法,生成page对象</span></span><br><span class="line">	page = paginator.page(pageid)</span><br><span class="line">	<span class="keyword">return</span> render(request,<span class="string">&#x27;myapp/studentspage.html&#x27;</span>,&#123;<span class="string">&#x27;students&#x27;</span>:page&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;# myapp/studentspage.html #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&#x27;cn&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>分页显示<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="xml">		</span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> stu <span class="keyword">in</span> students %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">			</span><span class="template-variable">&#123;&#123;stu.name&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">		</span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>结果:<br><img src="/images/1555737479032.png" alt="1555737479032"><br><img src="/images/1555737489813.png" alt="1555737489813"></p>
</li>
<li><p>我们还可以制作一个简易的跳转页面</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&#x27;cn&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>分页显示<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="xml">		</span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> stu <span class="keyword">in</span> students %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">			</span><span class="template-variable">&#123;&#123;stu.name&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">		</span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="xml">		</span><span class="template-tag">&#123;%<span class="name"><span class="name">for</span></span> idx <span class="keyword">in</span> students.paginator.page_range %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">            </span><span class="comment">&#123;# 在这里跳转 #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">			<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/studentspage/</span></span></span><span class="template-variable">&#123;&#123;idx&#125;&#125;</span><span class="xml"><span class="tag"><span class="string">/&quot;</span>&gt;</span></span><span class="template-variable">&#123;&#123;idx&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">		</span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p><img src="/images/1555738156594.png" alt="1555738156594"><br><img src="/images/1555738216439.png" alt="1555738216439"></p>
</li>
</ol>
<h2 id="ajax"><a href="#ajax" class="headerlink" title="ajax"></a>ajax</h2><ol>
<li><p>需要动态生成,请求json数据</p>
</li>
<li><p>示例:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置url</span></span><br><span class="line">url(<span class="string">r&#x27;ajaxstudents/(\d+)/$&#x27;</span>,views.ajaxstudents),</span><br><span class="line">url(<span class="string">r&#x27;^studentsinfo/$&#x27;</span>,views.studentsinfo)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 视图函数</span></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ajaxstudents</span>(<span class="params">request</span>):</span></span><br><span class="line">	<span class="keyword">return</span> render(request,<span class="string">&#x27;myapp/ajaxstudents.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">studentsinfo</span>(<span class="params">request</span>):</span></span><br><span class="line">	stus = Students.objects.<span class="built_in">all</span>()</span><br><span class="line">	<span class="built_in">list</span> = []</span><br><span class="line">	<span class="keyword">for</span> stu <span class="keyword">in</span> stus:</span><br><span class="line">		<span class="built_in">list</span>.append([stu.name,stu.gender])</span><br><span class="line">	<span class="keyword">return</span> JsonResponse(&#123;<span class="string">&quot;data&quot;</span>:<span class="built_in">list</span>&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;# myapp/ajaxstudents.html #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&#x27;cn&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>学生信息<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;/static/myapp/js/jquery-3.1.1.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">h1</span>&gt;</span>学生信息列表<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span> = <span class="string">&quot;btn&quot;</span>&gt;</span>显示学生信息<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;/static/myapp/js/hyl.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*   static/myapp/js/hyl.js   */</span></span><br><span class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="built_in">document</span>.getElementByIdI(<span class="string">&quot;btn&quot;</span>).onclick =</span><br><span class="line">	<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		$.ajax(&#123;</span><br><span class="line">			<span class="attr">type</span>:<span class="string">&quot;get&quot;</span>,</span><br><span class="line">			<span class="attr">url</span> :<span class="string">&#x27;studentsinfo&#x27;</span>,</span><br><span class="line">			<span class="attr">dataType</span>:<span class="string">&quot;json&quot;</span></span><br><span class="line">			<span class="attr">success</span>:<span class="function"><span class="keyword">function</span>(<span class="params">data,status</span>)</span>&#123;</span><br><span class="line">			<span class="built_in">console</span>.log(data);	</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="富文本"><a href="#富文本" class="headerlink" title="富文本"></a>富文本</h2><ol>
<li><p>依赖项:<br>pip install django-tinymce</p>
</li>
<li><p>在站点中使用:</p>
<ul>
<li><p>配置setting.py文件:<br>installed_apps中添加<code>&#39;tinymce&#39;</code></p>
</li>
<li><p>配置TINYMCE_DEFAULT_CONFIG:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># setting.py</span></span><br><span class="line"><span class="comment"># 富文本</span></span><br><span class="line">TINYMCE_DEFAULT_CONFIG = &#123;</span><br><span class="line">    <span class="string">&#x27;theme&#x27;</span>:<span class="string">&#x27;advanced&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;width&#x27;</span>:<span class="number">600</span>,</span><br><span class="line">    <span class="string">&#x27;height&#x27;</span>:<span class="number">400</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>创建模型类:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># modles.py</span></span><br><span class="line"><span class="comment"># 创建HTMLField</span></span><br><span class="line"><span class="keyword">from</span> tinymce.models <span class="keyword">import</span> HTMLField</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Text</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">	<span class="built_in">str</span> = HTMLField()</span><br></pre></td></tr></table></figure></li>
<li><p>配置站点:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># admin.py</span></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Grades,Students,Text</span><br><span class="line">admin.site.register(Text)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>在自定义视图中使用:</p>
<p>使用textarea标签</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&#x27;cn&#x27;</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">	&lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">	&lt;title&gt;富文本&lt;/title&gt;</span><br><span class="line">	&lt;script <span class="built_in">type</span>=<span class="string">&quot;text/javascript&quot;</span> src=<span class="string">&quot;/staitic/tiny_mce/tiny_mce.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">	&lt;script <span class="built_in">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">		tinyMCE.init(&#123;</span><br><span class="line">			<span class="string">&#x27;mode&#x27;</span>:<span class="string">&#x27;textareas&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;theme&#x27;</span>:<span class="string">&#x27;advanced&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;width&#x27;</span>:<span class="number">800</span>,</span><br><span class="line">			<span class="string">&#x27;height&#x27;</span>:<span class="number">600</span>,</span><br><span class="line">		&#125;)</span><br><span class="line">	&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">	&lt;form&gt;</span><br><span class="line">		&lt;textarea name=<span class="string">&quot;str&quot;</span>&gt;hello world&lt;/textarea&gt;</span><br><span class="line">	&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="celery"><a href="#celery" class="headerlink" title="celery"></a>celery</h2><ol>
<li><p><a target="_blank" rel="noopener" href="http://docs.jinkan.org/docs/celery/">http://docs.jinkan.org/docs/celery/</a></p>
</li>
<li><p>问题</p>
<ul>
<li>用户发起request,并且等待response返回,但是在视图中有一些耗时的操作,导致用户可能会等待很长时间才能接受到response.</li>
<li>网站每个一段时间要同步一次数据,但是HTTP请求需要触发的.</li>
</ul>
</li>
<li><p>安装:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip intall django-celery</span><br></pre></td></tr></table></figure></li>
<li><p>示例:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># url.py</span></span><br><span class="line">url(<span class="string">r&#x27;^celery/$&#x27;</span>,views.celery)</span><br><span class="line"></span><br><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">celery</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="comment"># 耗时操作</span></span><br><span class="line">	time.sleep(<span class="number">5</span>)</span><br><span class="line">	<span class="keyword">return</span> render(request,<span class="string">&#x27;myapp/celery.html&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;# celery.html #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&#x27;cn&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>good<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">h1</span>&gt;</span>this is celery page<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>当进入127.0.0.1/celery时就会等待5秒钟,之后才能进入</p>
</li>
<li><p>解决:</p>
<ul>
<li>将耗时的操作放到celery中执行</li>
<li>使用celery定时执行</li>
</ul>
</li>
<li><p>celery:</p>
<ul>
<li>任务task:<br>本质是一个python函数,将耗时操作封装成一个函数</li>
<li>队列queue:<br>将要执行的任务放队列里</li>
<li>工人worker:<br>负责执行队列中的任务</li>
<li>代理broker:<br>负责调度,在部署环境中使用redis</li>
</ul>
</li>
<li><p>安装:</p>
<ul>
<li>pip install celery</li>
<li>pip install celery-with-redis</li>
<li>pip install django-celery</li>
</ul>
</li>
<li><p>配置setting.py</p>
<ul>
<li><p>INSTALLED_APPS:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">	...</span><br><span class="line">	<span class="string">&#x27;djcelery&#x27;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li>
<li><p>配置celery:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># celery</span></span><br><span class="line"><span class="keyword">import</span> djcelery</span><br><span class="line"><span class="comment"># 初始化</span></span><br><span class="line">djcelery.setup_loader()</span><br><span class="line"><span class="comment"># redis://:密码@ip地址:端口/数据库号</span></span><br><span class="line">BROKER_URL = <span class="string">&#x27;redis://:hyl@127.0.0.1:6379/0&#x27;</span></span><br><span class="line"><span class="comment"># 项目名</span></span><br><span class="line"><span class="comment"># 调用mapp文件夹下的task.py</span></span><br><span class="line">CELERY_IMPORTS =(<span class="string">&#x27;myapp.task&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>在应用目录下创建task.py文件:<br>在project/myapp/目录下创建task.py</p>
</li>
<li><p>迁移,生成celery需要的数据库表:</p>
</li>
</ol>
   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py migrate</span><br></pre></td></tr></table></figure>

<ol start="11">
<li><p>在工程目录下的project目录下创建celery.py的文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"></span><br><span class="line">os.environ.setdefault(<span class="string">&#x27;DJANGO_SETTINGS_MODULE&#x27;</span>,<span class="string">&#x27;whatas_home.settings&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app = Celery(<span class="string">&#x27;portal&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app.config_from_object(<span class="string">&#x27;django.conf:settings&#x27;</span>)</span><br><span class="line">app.autodiscover_tasks(<span class="keyword">lambda</span> : settings.INSTALLED_APPS)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.task(<span class="params">bind=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug_task</span>(<span class="params">self</span>):</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&#x27;Request: &#123;0!r&#125;&#x27;</span>.<span class="built_in">format</span>(self.request))</span><br></pre></td></tr></table></figure></li>
<li><p>在工程目录下的project目录下的__init__.py文件中添加</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .celery <span class="keyword">import</span> app <span class="keyword">as</span> celery_app</span><br></pre></td></tr></table></figure></li>
<li><p>视图:<br>将前面的视图函数修改为:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> .task <span class="keyword">import</span> task_func</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">celery</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="comment"># 添加到celery中执行,不会阻塞</span></span><br><span class="line">	task_func.delay()</span><br><span class="line">	<span class="keyword">return</span> render(request,<span class="string">&#x27;myapp/celery.html&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>启动redis</p>
</li>
<li><p>启动服务</p>
</li>
<li><p>启动worker</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py celery worker --loglevel=info</span><br></pre></td></tr></table></figure></li>
</ol>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>