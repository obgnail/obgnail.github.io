<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="一张表使用两个字段的时候就需要使用F函数.&lt;br&gt;本质就是为了避免将数据直接从数据库中取出."><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>千锋教育5_补充 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-none-link" href="/tags/Django/" rel="tag">Django</a></div><div class="post-time">2021-08-29</div></div></div><div class="container post-header"><h1>千锋教育5_补充</h1></div><div class="container post-content"><p>一张表使用两个字段的时候就需要使用F函数.<br>本质就是为了避免将数据直接从数据库中取出.</p>
<hr>
<p>OneToOneField其实就是ForeignKey多了一个<code>unique=True</code>的参数.</p>
<p>ForeignKey</p>
<ul>
<li><p>正向查找:(一方查找多方)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user.article_set.<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure></li>
<li><p>反向查找:(多方查找一方)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">article.user</span><br></pre></td></tr></table></figure></li>
</ul>
<p>ManyToManyField:<br>会自动生成两个实体的联系表.<br><strong>ManyToManyField可以写在任意一方</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span>:</span></span><br><span class="line">    tag = ManyToManyField(to=)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>正向查找:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">article.tags</span><br></pre></td></tr></table></figure></li>
<li><p>反向查找:(多方查找一方)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tags.article_set</span><br></pre></td></tr></table></figure></li>
<li><p>添加:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># article添加tags</span></span><br><span class="line">article.tags.add(tag)</span><br></pre></td></tr></table></figure></li>
<li><p>删除:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除单个标签</span></span><br><span class="line">article.tags.remove(tag)</span><br><span class="line"><span class="comment"># 删除所有标签</span></span><br><span class="line">article.tags.clear(tag)</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<p>media文件:文件上传存储的位置</p>
<p><code>FileField(upload_to=&#39;表示文件路径&#39;)</code></p>
<p>==此路径是基于media_root指明的路径==</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MEDIA_URL = <span class="string">&#x27;/static/media/&#x27;</span></span><br><span class="line">MEDIA_ROOT = os.path.join(BASE_DIR,<span class="string">&#x27;static/media/&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>如果想在模板中引用上传的文件:</p>
<ol>
<li>settings.py里的TEPLATES的OPTIONS字典里,添加:<code>django.template.context_processors.media</code></li>
<li>使用<code>&#123; MEDIA_URL &#125;</code></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">TEMPLATES = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;BACKEND&#x27;</span>: <span class="string">&#x27;django.template.backends.django.DjangoTemplates&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;DIRS&#x27;</span>: [os.path.join(BASE_DIR,<span class="string">&#x27;templates&#x27;</span>)],</span><br><span class="line">        <span class="string">&#x27;APP_DIRS&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">&#x27;OPTIONS&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;context_processors&#x27;</span>: [</span><br><span class="line">                <span class="string">&#x27;django.template.context_processors.debug&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.template.context_processors.request&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.contrib.auth.context_processors.auth&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.contrib.messages.context_processors.messages&#x27;</span>,</span><br><span class="line">                <span class="comment"># 在模板中可以使用&#123;&#123; MEDIA_URL &#125;&#125;</span></span><br><span class="line">                <span class="string">&#x27;django.template.context_processors.meida&#x27;</span>,</span><br><span class="line">            ],</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>



<hr>
<p>系统默认用户的继承使用:</p>
<ul>
<li>继承AbstractUser</li>
<li>修改setting.py里的AUTH_USER_MODEL = ‘user.UserProfile’</li>
<li>重新执行迁移同步.</li>
</ul>
<p>迁移数据库的时候,Django会自动生成auth_user</p>
<p><img src="/images/1558097542758.png" alt="1558097542758"></p>
<p>如果如果用户定义模板时继承了AbstractUser,就需要修改auth_user模型,具体操作是修改<code>AUTH_USER_MODEL</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserProfile</span>(<span class="params">AbstractUser</span>):</span></span><br><span class="line">    mobile = models.CharField(verbose_name=<span class="string">&#x27;手机号码&#x27;</span>, max_length=<span class="number">11</span>,unique=<span class="literal">True</span>)</span><br><span class="line">    icon   = models.ImageField(upload_to=<span class="string">&#x27;uploads/&#x27;</span>, height_field=<span class="literal">None</span>, width_field=<span class="literal">None</span>, max_length=<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table = <span class="string">&#x27;userprofile&#x27;</span></span><br><span class="line">        verbose_name = <span class="string">&quot;用户表&quot;</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.name</span><br></pre></td></tr></table></figure>

<p>需要在settings.py里修改AUTH_USER_MODEL:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># settings.py</span></span><br><span class="line"><span class="comment"># 如果用户继承了AbstractUser,就需要修改auth_user模型</span></span><br><span class="line"><span class="comment"># 格式为 &quot;&lt;django_app名&gt;.&lt;model名&gt;&quot;</span></span><br><span class="line">AUTH_USER_MODEL = <span class="string">&#x27;user.UserProfile&#x27;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/1558874666168.png" alt="1558874666168"></p>
<p>auth_user变成了userfile</p>
<hr>
<p>检验两次输入的密码:<br><img src="/images/1558875228582.png" alt="1558875228582"></p>
<hr>
<p>一般而言,我们不使用form.py来创建表单,因为这样很难添加样式,一样都是==用form来处理表单数据==,</p>
<p>Django会处理涉及表单的三个不同部分：</p>
<ul>
<li>准备并重组数据，以便下一步的渲染</li>
<li>为数据创建HTML表单</li>
<li>接收并处理客户端提交的表单及数据</li>
</ul>
<p>Form类描述一张表单并决定它如何工作及呈现。</p>
<p>类似于模型类的字段映射到数据库孥段的方式，<br>表单类的字段会映射到HTML表单的<code>&lt;input&gt;</code>元素。</p>
<p>==Modelform通过Form映射模型类的字段到HTML表单的<code>&lt;input&gt;</code>元素==</p>
<p>使用Form创建HTML表单:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># forms.py</span></span><br><span class="line"><span class="keyword">from</span> django.forms <span class="keyword">import</span> Form</span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserRegisterForm</span>(<span class="params">Form</span>):</span></span><br><span class="line">    <span class="comment"># forms.CharField对应html中的TextInput</span></span><br><span class="line">    <span class="comment"># label就是input对应的label标签,error_messages就是Input触发的错误信息,注意是字典形式</span></span><br><span class="line">    username = forms.CharField(min_length=<span class="number">6</span>, max_length=<span class="number">50</span>, required=<span class="literal">False</span>,label=<span class="string">&#x27;用户名&#x27;</span>,error_messages=&#123;<span class="string">&#x27;min_length&#x27;</span>:<span class="string">&#x27;至少六位&#x27;</span>,<span class="string">&#x27;max_length&#x27;</span>:<span class="string">&#x27;最多50位&#x27;</span>&#125;)</span><br><span class="line">    email = forms.EmailField(label=<span class="string">&#x27;邮箱&#x27;</span>, required=<span class="literal">True</span>,error_messages=&#123;<span class="string">&#x27;required&#x27;</span>:<span class="string">&#x27;必须填邮箱&#x27;</span>&#125;)</span><br><span class="line">    mobile = forms.CharField(label=<span class="string">&#x27;手机&#x27;</span>, required=<span class="literal">True</span>,error_messages=&#123;<span class="string">&#x27;required&#x27;</span>:<span class="string">&#x27;必须填手机&#x27;</span>&#125;)</span><br><span class="line">    <span class="comment"># PasswordInput对应密码框,但是我们并不直接使用PasswordInput,还是使用CharField,这是需要使用widget插件</span></span><br><span class="line">    <span class="comment"># 使用forms.widgets.PasswordInput插件</span></span><br><span class="line">    password = forms.CharField(label=<span class="string">&#x27;密码&#x27;</span>, required=<span class="literal">True</span>,error_messages=&#123;<span class="string">&#x27;required&#x27;</span>:<span class="string">&#x27;必须填密码&#x27;</span>&#125;,widget=forms.widgets.PasswordInput)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">zhuce</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        regform = UserRegisterForm()</span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;test.html&#x27;</span>,&#123;<span class="string">&#x27;regform&#x27;</span>:regform&#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;# test.html #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">carset</span> &quot;<span class="attr">UTF-8</span>&quot;&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>注册<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;user:zhuce&#x27; %&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">        </span><span class="template-variable">&#123;&#123; regform.as_p &#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;注册&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p><img src="/images/1558919438873.png" alt="1558919438873"></p>
<p>注意:</p>
<ol>
<li>Django的form类创建HTML表单时不会为我们准备form标签和submit的input标签,这都是需要我们手动添加的</li>
<li>as_p的意思是:这些标签都使用p标签包裹住,<br>还有as_table,as_ul,as_li等等<br><img src="/images/1558920117710.png" alt="1558920117710"></li>
<li>我们可以将form就当成是model来使用,所以不仅可以使用<code>regform.as_p</code>来渲染全部字段,还可以使用<code>&#123;&#123; regform.username &#125;&#125;</code>来渲染单个字段</li>
</ol>
<hr>
<p>接收客户端提交的表单及数据:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">zhuce</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        <span class="comment"># 如果是GET,直接创建新的UserRegisterForm实例</span></span><br><span class="line">        regform = UserRegisterForm()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;====&gt;&#x27;</span>,regform)</span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;test.html&#x27;</span>,&#123;<span class="string">&#x27;regform&#x27;</span>:regform&#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 如果是POST,直接将POST的结果传给UserRegisterForm</span></span><br><span class="line">        regform = UserRegisterForm(request.POST)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;----&gt;&#x27;</span>,regform)</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;sadasd&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>对比POST和GET两个regform</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">====&gt; &lt;tr&gt;&lt;th&gt;&lt;label for=&quot;id_username&quot;&gt;用户名:&lt;/label&gt;&lt;/th&gt;&lt;td&gt;&lt;input id=&quot;id_username&quot; maxlength=&quot;50&quot; minlength=&quot;6&quot; name=&quot;username&quot; type=&quot;text&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;</span><br><span class="line"></span><br><span class="line">----&gt; &lt;tr&gt;&lt;th&gt;&lt;label for=&quot;id_username&quot;&gt;用户名:&lt;/label&gt;&lt;/th&gt;&lt;td&gt;&lt;input id=&quot;id_username&quot; maxlength=&quot;50&quot; minlength=&quot;6&quot; name=&quot;username&quot; type=&quot;text&quot; value=&quot;2312123123&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;</span><br></pre></td></tr></table></figure>

<p>发现就只是多了一个value.<br>如果这个表单是多选框,就会多一个checked.</p>
<hr>
<p>处理客户端提交的表单及数据:</p>
<p>我们通过在forms类里定义<code>clean函数</code>,==这些clean函数会被自动调用==.来验证表单的合法性</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># forms.py</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</span><br><span class="line"><span class="keyword">from</span> django.core.exceptions <span class="keyword">import</span> ValidationError</span><br><span class="line"><span class="keyword">from</span> django.forms <span class="keyword">import</span> Form</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserRegisterForm</span>(<span class="params">Form</span>):</span></span><br><span class="line">    <span class="comment"># forms.CharField对应html中的TextInput</span></span><br><span class="line">    <span class="comment"># label就是input对应的label标签,error_messages就是Input触发的错误信息,注意是字典形式</span></span><br><span class="line">    username = forms.CharField(min_length=<span class="number">6</span>, max_length=<span class="number">50</span>, required=<span class="literal">False</span>,label=<span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">                               error_messages=&#123;<span class="string">&#x27;min_length&#x27;</span>:<span class="string">&#x27;至少六位&#x27;</span>,<span class="string">&#x27;max_length&#x27;</span>:<span class="string">&#x27;最多50位&#x27;</span>&#125;)</span><br><span class="line">    email = forms.EmailField(label=<span class="string">&#x27;邮箱&#x27;</span>, required=<span class="literal">True</span>,error_messages=&#123;<span class="string">&#x27;required&#x27;</span>:<span class="string">&#x27;必须填邮箱&#x27;</span>&#125;)</span><br><span class="line">    mobile = forms.CharField(label=<span class="string">&#x27;手机&#x27;</span>, required=<span class="literal">True</span>,error_messages=&#123;<span class="string">&#x27;required&#x27;</span>:<span class="string">&#x27;必须填手机&#x27;</span>&#125;)</span><br><span class="line">    <span class="comment"># PasswordInput对应密码框,但是我们并不直接使用PasswordInput,还是使用CharField,这是需要使用widget插件</span></span><br><span class="line">    <span class="comment"># 使用forms.widgets.PasswordInput插件</span></span><br><span class="line">    password = forms.CharField(label=<span class="string">&#x27;密码&#x27;</span>, required=<span class="literal">True</span>,error_messages=&#123;<span class="string">&#x27;required&#x27;</span>:<span class="string">&#x27;必须填密码&#x27;</span>&#125;,</span><br><span class="line">                               widget=forms.widgets.PasswordInput)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_username</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># self.cleaned_data就是表单获取的数据,以字典形式存储</span></span><br><span class="line">        username = self.cleaned_data.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        <span class="comment"># 必须字母开头,至少六位</span></span><br><span class="line">        result = re.match(<span class="string">r&#x27;[a-zA-Z]\w&#123;5,&#125;&#x27;</span>,username)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> result:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">&#x27;用户名必须字母开头&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> username</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">zhuce</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        <span class="comment"># 如果是GET,直接创建新的UserRegisterForm实例</span></span><br><span class="line">        regform = UserRegisterForm()</span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;test.html&#x27;</span>,&#123;<span class="string">&#x27;regform&#x27;</span>:regform&#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 如果是POST,直接将POST的结果传给UserRegisterForm</span></span><br><span class="line">        regform = UserRegisterForm(request.POST)</span><br><span class="line">        <span class="comment"># 如果出错则打印错误</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> regform.is_valid():</span><br><span class="line">            <span class="built_in">print</span>(regform.errors)</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;sadasd&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>现在故意输入错误,regform.errors打印出:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;errorlist&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">li</span>&gt;</span>username<span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;errorlist&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">li</span>&gt;</span>用户名必须字母开头<span class="tag">&lt;/<span class="name">li</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>正常使用:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">zhuce</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        <span class="comment"># 如果是GET,直接创建新的UserRegisterForm实例</span></span><br><span class="line">        regform = UserRegisterForm()</span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;test.html&#x27;</span>,&#123;<span class="string">&#x27;regform&#x27;</span>:regform&#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 如果是POST,直接将POST的结果传给UserRegisterForm</span></span><br><span class="line">        regform = UserRegisterForm(request.POST)</span><br><span class="line">        <span class="keyword">if</span> regform.is_valid():</span><br><span class="line">            username = regform.clean_data.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">            email    = regform.clean_data.get(<span class="string">&#x27;email&#x27;</span>)</span><br><span class="line">            mobile   = regform.clean_data.get(<span class="string">&#x27;mobile&#x27;</span>)</span><br><span class="line">            password = regform.clean_data.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> render(...)</span><br></pre></td></tr></table></figure>

<p>就像我之前说的,使用form来渲染表单很不方便,所以我们一般使用form来校验表单数据,所以我们就将视图函数里GET的判断全部砍掉:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># forms.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserRegisterForm</span>(<span class="params">Form</span>):</span></span><br><span class="line">    username = forms.CharField(min_length=<span class="number">6</span>, max_length=<span class="number">50</span>, required=<span class="literal">False</span>,label=<span class="string">&#x27;用户名&#x27;</span>,error_messages=&#123;<span class="string">&#x27;min_length&#x27;</span>:<span class="string">&#x27;至少六位&#x27;</span>,<span class="string">&#x27;max_length&#x27;</span>:<span class="string">&#x27;最多50位&#x27;</span>&#125;)</span><br><span class="line">    email = forms.EmailField(label=<span class="string">&#x27;邮箱&#x27;</span>, required=<span class="literal">True</span>,error_messages=&#123;<span class="string">&#x27;required&#x27;</span>:<span class="string">&#x27;必须填邮箱&#x27;</span>&#125;)</span><br><span class="line">    mobile = forms.CharField(label=<span class="string">&#x27;手机&#x27;</span>, required=<span class="literal">True</span>,error_messages=&#123;<span class="string">&#x27;required&#x27;</span>:<span class="string">&#x27;必须填手机&#x27;</span>&#125;)</span><br><span class="line">    password = forms.CharField(label=<span class="string">&#x27;密码&#x27;</span>, required=<span class="literal">True</span>,error_messages=&#123;<span class="string">&#x27;required&#x27;</span>:<span class="string">&#x27;必须填密码&#x27;</span>&#125;,widget=forms.widgets.PasswordInput)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_username</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># self.cleaned_data就是表单获取的数据,以字典形式存储</span></span><br><span class="line">        username = self.cleaned_data.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        result = re.match(<span class="string">r&#x27;[a-zA-Z]\w&#123;5,&#125;&#x27;</span>,username)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> result:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">&#x27;用户名必须字母开头&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> username</span><br><span class="line">  </span><br><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">zhuce</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="comment"># 如果是POST,直接将POST的结果传给UserRegisterForm</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        regform = UserRegisterForm(request.POST)</span><br><span class="line">        <span class="keyword">if</span> regform.is_valid():</span><br><span class="line">            username = regform.clean_data.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">            email    = regform.clean_data.get(<span class="string">&#x27;email&#x27;</span>)</span><br><span class="line">            mobile   = regform.clean_data.get(<span class="string">&#x27;mobile&#x27;</span>)</span><br><span class="line">            password = regform.clean_data.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(....)</span><br></pre></td></tr></table></figure>

<p>但是上面的写法还是很麻烦,这时就需要使用Modelform:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># forms.py</span></span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserProfile</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterForm</span>(<span class="params">forms.ModelForm</span>):</span></span><br><span class="line">    repassword = forms.CharField(label=<span class="string">&#x27;确认密码&#x27;</span>,required=<span class="literal">True</span>,error_messages=&#123;<span class="string">&#x27;required&#x27;</span>:<span class="string">&#x27;必须填密码&#x27;</span>&#125;,widget=forms.widgets.PasswordInput)</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        <span class="comment"># form对应的模型类</span></span><br><span class="line">        model = UserProfile</span><br><span class="line">        <span class="comment"># 获取这个模型类的需要的字段</span></span><br><span class="line">        <span class="comment"># __all__:获取所有字段.</span></span><br><span class="line">        <span class="comment"># fields = (&quot;&quot;,):填写需要的字段</span></span><br><span class="line">        fields = <span class="string">&#x27;__all__&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># exclude:排除字段</span></span><br><span class="line">        exclude = [<span class="string">&#x27;first_name&#x27;</span>,<span class="string">&#x27;last_name&#x27;</span>,<span class="string">&#x27;date_joined&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>我们可以在modelform里的Meta里的<code>model</code>定义要引用的模型类,然后使用fields定义引用模型类的哪些字段,还可以自行定义新的字段:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># forms.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterForm</span>(<span class="params">forms.ModelForm</span>):</span></span><br><span class="line">    <span class="comment"># 定义一个新的字段</span></span><br><span class="line">    repassword = forms.CharField(label=<span class="string">&#x27;确认密码&#x27;</span>,required=<span class="literal">True</span>,error_messages=&#123;<span class="string">&#x27;required&#x27;</span>:<span class="string">&#x27;必须填密码&#x27;</span>&#125;,widget=forms.widgets.PasswordInput)</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = UserProfile</span><br><span class="line">        fields = (<span class="string">&quot;username&quot;</span>,<span class="string">&#x27;email&#x27;</span>,<span class="string">&#x27;mobile&#x27;</span>,<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_username</span>(<span class="params">self</span>):</span></span><br><span class="line">        username = self.clean_data.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        result = re.match(<span class="string">&#x27;...&#x27;</span>,username)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> result:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">&#x27;用户名错误&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> username</span><br><span class="line">    </span><br><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">zhuce</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        <span class="comment"># 如果是GET,直接创建新的UserRegisterForm实例</span></span><br><span class="line">        regform = RegisterForm()</span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;test.html&#x27;</span>,&#123;<span class="string">&#x27;regform&#x27;</span>:regform&#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 如果是POST,直接将POST的结果传给UserRegisterForm</span></span><br><span class="line">        regform = RegisterForm(request.POST)</span><br><span class="line">        <span class="keyword">if</span> regform.is_valid():</span><br><span class="line">            username = regform.clean_data.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">            email    = regform.clean_data.get(<span class="string">&#x27;email&#x27;</span>)</span><br><span class="line">            mobile   = regform.clean_data.get(<span class="string">&#x27;mobile&#x27;</span>)</span><br><span class="line">            password = regform.clean_data.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;sadasd&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>总结一下forms和modelform的最大区别:</p>
<ul>
<li>forms必须自行定义全部的字段</li>
<li>Modelform可以引用model里的字段,也可以定义新的字段</li>
</ul>
<p>注意:<strong>filed填写的是需要验证的字段</strong>,也就是说不再filed里面的字段是不会被验证的</p>
<p>所以,我们最常用的<strong>注册视图函数</strong>为:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注册</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_register</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;user/regiset.html&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 获取form数据</span></span><br><span class="line">        regform = RegisterForm(request.POST)</span><br><span class="line">        <span class="comment"># 进行数据校验</span></span><br><span class="line">        <span class="keyword">if</span> regform.is_valid():</span><br><span class="line">            <span class="comment"># 从干净的数据中取值</span></span><br><span class="line">            username = regform.clean_data.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">            email    = regform.clean_data.get(<span class="string">&#x27;email&#x27;</span>)</span><br><span class="line">            mobile   = regform.clean_data.get(<span class="string">&#x27;mobile&#x27;</span>)</span><br><span class="line">            password = regform.clean_data.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">            <span class="comment"># 查找手机或用户名是否被抢注</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> UserProfile.objects.<span class="built_in">filter</span>((Q(username=username)|Q(mobile=mobile)).exists()):</span><br><span class="line">                <span class="comment"># 密码加密</span></span><br><span class="line">                password = make_password(password)</span><br><span class="line">                <span class="comment"># 注册到数据</span></span><br><span class="line">                user = UserProfile.objects.create(username=username,password=password,email=email,mobile=mobile)</span><br><span class="line">                <span class="keyword">if</span> user:</span><br><span class="line">                    <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;注册成功&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> render(request,<span class="string">&#x27;user/regiset.html&#x27;</span>,&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&#x27;用户名或者手机密码已存在&#x27;</span>&#125;)</span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;user/regiset.html&#x27;</span>,&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&#x27;注册失败&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>登录的常用视图函数:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_login</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;user/login.html&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        lform = LoginForm(request.POST)</span><br><span class="line">        <span class="keyword">if</span> lform.is_valid():</span><br><span class="line">            username = lform.clean_data.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">            password = lform.clean_data.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">            <span class="comment"># 进行数据库的查询</span></span><br><span class="line">            user = UserProfile.objects.<span class="built_in">filter</span>(username=username).first()</span><br><span class="line">            <span class="comment"># 进行密码验证</span></span><br><span class="line">            psw_is_true = check_password(password,user.password)</span><br><span class="line">            <span class="keyword">if</span> psw_is_true:</span><br><span class="line">                <span class="comment"># 把用户名放到session里面</span></span><br><span class="line">                request.session[<span class="string">&#x27;username&#x27;</span>] = username</span><br><span class="line">                <span class="comment"># 重定向到首页</span></span><br><span class="line">                <span class="keyword">return</span> redirect(reverse(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 传递errors</span></span><br><span class="line">            <span class="keyword">return</span> render(request,<span class="string">&#x27;user/login.html&#x27;</span>,&#123;<span class="string">&#x27;errors&#x27;</span>:lform.errors&#125;)</span><br></pre></td></tr></table></figure>

<p>这样我们就把username放进了session里了..</p>
<p>那么如何在模板里使用session?<br>使用request.session<br>(例如:拿出session里的username参数)</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> request.session.username %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    欢迎 <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span></span><span class="template-variable">&#123;&#123; request.session.username &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span>注销<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">else</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;user:login&#x27; %&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;user:register&#x27; %&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span>注册<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span></span><br></pre></td></tr></table></figure>

<p>注销:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_logout</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="comment"># 删除:django的session + 浏览器的cookies + request.session的字典</span></span><br><span class="line">    request.session.flush()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 删除字典</span></span><br><span class="line">    <span class="comment"># request.session.clear()</span></span><br><span class="line">    <span class="keyword">return</span> redirect(reverse(<span class="string">&#x27;index&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>但是一般我们都不直接操作session,而是使用封装好的方法:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> logout</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_logout</span>(<span class="params">request</span>):</span></span><br><span class="line">    logout(request)</span><br></pre></td></tr></table></figure>

<p>注意,还有一个<code>from django.contrib.auth.views import logout</code>,不要用错了.</p>
<p>既然有logout,那么就有login,所以前面的login函数也可以修改:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_login</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;user/login.html&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        lform = LoginForm(request.POST)</span><br><span class="line">        <span class="keyword">if</span> lform.is_valid():</span><br><span class="line">            username = lform.clean_data.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">            password = lform.clean_data.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">            <span class="comment"># 进行数据库的查询</span></span><br><span class="line">            user = UserProfile.objects.<span class="built_in">filter</span>(username=username).first()</span><br><span class="line">            <span class="comment"># 进行密码验证</span></span><br><span class="line">            psw_is_true = check_password(password,user.password)</span><br><span class="line">            <span class="keyword">if</span> psw_is_true:</span><br><span class="line">                <span class="comment"># 把用户名放到session里面</span></span><br><span class="line">                request.session[<span class="string">&#x27;username&#x27;</span>] = username</span><br><span class="line">                <span class="comment"># 重定向到首页</span></span><br><span class="line">                <span class="keyword">return</span> redirect(reverse(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 传递errors</span></span><br><span class="line">            <span class="keyword">return</span> render(request,<span class="string">&#x27;user/login.html&#x27;</span>,&#123;<span class="string">&#x27;errors&#x27;</span>:lform.errors&#125;)</span><br></pre></td></tr></table></figure>

<p>修改成:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> logout,login,authenticate</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_login</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;user/login.html&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        lform = LoginForm(request.POST)</span><br><span class="line">        <span class="keyword">if</span> lform.is_valid():</span><br><span class="line">            username = lform.clean_data.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">            password = lform.clean_data.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 自动验证用户和密码,如果成功则会返回一个user对象</span></span><br><span class="line">            user = authenticate(username=username,password=password)</span><br><span class="line">            <span class="keyword">if</span> user:</span><br><span class="line">                <span class="comment"># 将用户对象保存在底层的request中(没有返回值)</span></span><br><span class="line">                <span class="comment"># 自动将数据存储到request对象的user属性中</span></span><br><span class="line">                login(request,user)</span><br><span class="line">                <span class="keyword">return</span> redirect(reverse(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> render(request,<span class="string">&#x27;user/login.html&#x27;</span>,&#123;<span class="string">&#x27;errors&#x27;</span>:lform.errors&#125;)</span><br></pre></td></tr></table></figure>

<p>使用了login的话,那么模板就不能简单的使用session来获取数据了:<br>直接使用request对象的user属性:</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;% comment %&#125; 这个用户是被认证过的吗 &#123;% endcomment %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> request.user.is_authenticated %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    欢迎 <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span></span><span class="template-variable">&#123;&#123; request.user.username &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span>注销<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">else</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;user:login&#x27; %&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;user:register&#x27; %&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span>注册<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span></span><br></pre></td></tr></table></figure>

<p>总结:</p>
<ol>
<li>make_password:将明文密码加密</li>
<li>check_password:检查用户的密码是否一致</li>
<li>request.session:设置/获取session的值</li>
<li>request.session.flush:删除django_session + cookies + 字典</li>
<li>request.session.clear:删除字典</li>
<li>del request.session[key]:删除指定的key</li>
<li>只有继承了abstractuser类的用户模型才能使用logout,login和authenticate.<br>其中authenticate和login是一起使用的<strong>先验证后登录</strong>:<ul>
<li>先使用authenticate进行用户的数据库查询判断，如果有则返回用户对象</li>
<li>login(request,user):类似于<code>request.session</code>,但是不是使用session属性了,而是使用<code>request.user</code></li>
</ul>
</li>
<li>注意:<br>logout()方法会清空 session和 cookie，<strong>将 request.user设置成匿名的User()</strong></li>
</ol>
<hr>
<p>短信验证功能:</p>
<p>这时可以使用第三方的短信认证服务.比如说网易云信.</p>
<p>为了对接网易云信接口,我们需要写一个函数,为了功能拆分,我们在myapp目录下创建一个<code>utils.py</code>文件夹,里面存放工具类.在这里存放工具函数.</p>
<hr>
<p>实现验证码刷新功能(点击即刷新验证码)</p>
<ol>
<li><p><code> pip install django-simple-captcha</code></p>
</li>
<li><p>在setting.py的INSTALLED_APPS里面添加captcha</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置 captcha 图片大小</span></span><br><span class="line">CAPTCHA_IMAGE_SIZE = (<span class="number">80</span>, <span class="number">45</span>)</span><br><span class="line"><span class="comment"># 字符个数</span></span><br><span class="line">CAPTCHA_LENGTH = <span class="number">4</span></span><br><span class="line"><span class="comment"># 超时(minutes)</span></span><br><span class="line">CAPTCHA_TIMEOUT = <span class="number">1</span></span><br></pre></td></tr></table></figure></li>
<li><p><code>python manage.py migrate</code>,创建一个新的captcha表.</p>
</li>
<li><p>在项目下的路由添加:<br><code>url(r&#39;^captcha/&#39;,include(&#39;captcha.urls&#39;))</code></p>
</li>
<li><p>在forms.py添加:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> captcha.fields <span class="keyword">import</span> CaptchaField</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CaptchaTestForm</span>(<span class="params">forms.Form</span>):</span></span><br><span class="line">    <span class="comment"># 这个的字段视情况而定</span></span><br><span class="line">    email = forms.EmailField()</span><br><span class="line">    captcha = CaptchaField()</span><br></pre></td></tr></table></figure></li>
<li><p>添加一个视图函数:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">forget_password</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method = <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        form = CaptchaTestForm()</span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;forget_pwd.html&#x27;</span>,context=&#123;<span class="string">&#x27;form&#x27;</span>:form&#125;)</span><br></pre></td></tr></table></figure></li>
</ol>
<p>实际上<strong>captcha本身就是一个app</strong>,我们上面的操作也是一个创建一个app的常用流程.而captcha就为我们准备了url路由了,直接调用即可</p>
<hr>
<p>发送邮件:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 邮箱服务器</span></span><br><span class="line">EMAIL_HOST = <span class="string">&#x27;smtp.qq.com&#x27;</span></span><br><span class="line"><span class="comment"># 自己的邮箱账号</span></span><br><span class="line">EMAIL_HOST_USER = <span class="string">&#x27;xxx@qq.com&#x27;</span></span><br><span class="line"><span class="comment"># 自己的邮箱授权码(注意不是密码)</span></span><br><span class="line">EMAIL_HOST_PASSWORD = <span class="string">&#x27;p@ssw0rd&#x27;</span>  </span><br><span class="line"><span class="comment"># 端口号(默认为25,不同的协议有不同的端口号)</span></span><br><span class="line">EMAIL_PORT = <span class="number">25</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面两种协议选一</span></span><br><span class="line">EMAIL_USE_SSL = <span class="literal">True</span></span><br><span class="line">EMAIL_USE_TLS = <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p>用户通过邮箱找回密码:<br>整个流程:</p>
<ol>
<li>进入<code>forget_pwd.html</code>页面</li>
<li>填写表单,提交到<code>forget_pwd</code></li>
<li>后台发送邮箱</li>
<li>用户进入邮箱,点击邮箱的链接,进入<code>update_pwd.html</code></li>
<li>填写表单,提交到<code>update_pwd</code></li>
<li>后台更新密码</li>
</ol>
<p>上面流程对应:</p>
<ol>
<li>进入<code>forget_password</code>视图函数的get方法</li>
<li>进入<code>forget_password</code>视图函数的post方法</li>
<li>post方法再调用<code>send_email</code>方法</li>
<li>进入<code>update_pwd</code>视图函数的get方法</li>
<li>进入<code>update_pwd</code>视图函数的post方法</li>
<li>post方法更新用户密码</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># urls.py</span></span><br><span class="line">url(<span class="string">r&#x27;^captcha/&#x27;</span>,include(<span class="string">&#x27;captcha.urls&#x27;</span>))</span><br><span class="line">url(<span class="string">r&#x27;forget_pwd&#x27;</span>,views.forget_pwd,name=<span class="string">&#x27;forget_pwd&#x27;</span>)</span><br><span class="line">url(<span class="string">r&#x27;update_pwd&#x27;</span>,views.update_pwd,name=<span class="string">&#x27;update_pwd&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># forms.py</span></span><br><span class="line"><span class="keyword">from</span> captcha.fields <span class="keyword">import</span> CaptchaField</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CaptchaTestForm</span>(<span class="params">forms.Form</span>):</span></span><br><span class="line">    email = forms.EmailField()</span><br><span class="line">    captcha = CaptchaField()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="keyword">from</span> django.core.mail <span class="keyword">import</span> send_mail</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_email</span>(<span class="params">email,request</span>):</span></span><br><span class="line">    <span class="string">&#x27;发送邮箱的工具方法&#x27;</span></span><br><span class="line">    user = UserProfile.objects.<span class="built_in">filter</span>(email=email).first()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 产生随机码</span></span><br><span class="line">    ran_code = uuid.uuid4()</span><br><span class="line">    <span class="comment"># 使用session将随机码绑定到用户id里</span></span><br><span class="line">    request.session[ran_code] = user.<span class="built_in">id</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 邮件主题</span></span><br><span class="line">    subject = <span class="string">&#x27;个人博客找回密码&#x27;</span></span><br><span class="line">    <span class="comment"># 邮件内容</span></span><br><span class="line">    message = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        用户你好,此链接用户找回密码,请点击链接:</span></span><br><span class="line"><span class="string">        &lt;a href=&quot;http://107.0.0.1:8000/user/update_pwd?c=%s&quot;&gt;更新密码&lt;/a&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        如果链接不能点击,请复制:</span></span><br><span class="line"><span class="string">        http://107.0.0.1:8000/user/update_pwd?c=%s</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>%(ran_code,ran_code)</span><br><span class="line"></span><br><span class="line">    result = send_email(subject,message,EMAIL_HOST,[email,],html_message=message)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">forget_password</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="string">&#x27;点击&quot;忘记密码&quot;时,发送邮箱&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> request.method = <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        form = CaptchaTestForm()</span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;forget_pwd.html&#x27;</span>,context=&#123;<span class="string">&#x27;form&#x27;</span>:form&#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 获取提交的邮箱</span></span><br><span class="line">        email = request.POST.get(<span class="string">&#x27;email&#x27;</span>)</span><br><span class="line">        <span class="comment"># 发送邮箱</span></span><br><span class="line">        send_email(email,request)</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_pwd</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method = <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        <span class="comment"># 获取c的目的是让c存储在模板的hiden标签里,方便提交的使用POST方法能获取c</span></span><br><span class="line">        c = request.GET.get(<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;updata_pwd.html&#x27;</span>,&#123;<span class="string">&#x27;c&#x27;</span>:c&#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        code = request.POST.get(<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line">        <span class="comment"># 获取用户id</span></span><br><span class="line">        uid =request.session.get(code)</span><br><span class="line">        UserProfile.objects.get(pk=uid)</span><br><span class="line">        <span class="comment"># 获取密码</span></span><br><span class="line"></span><br><span class="line">        pwd = request.POST.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        <span class="comment"># 确认密码</span></span><br><span class="line">        repwd = request.POST.get(<span class="string">&#x27;repassword&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> pwd==repwd <span class="keyword">and</span> user:</span><br><span class="line">            pwd = make_password(pwd)</span><br><span class="line">            user.password = pwd</span><br><span class="line">            user.save()</span><br><span class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;用户密码更新成功&#x27;</span>)</span><br></pre></td></tr></table></figure>



<p>总结:</p>
<ul>
<li>短信验证</li>
<li>验证码验证</li>
<li>邮箱验证</li>
</ul>
<p>短信验证,第三方网易云信,调用它的接口即可</p>
<p>验证码验证:</p>
<ol>
<li><p>captcha的Form</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> captcha.fields <span class="keyword">import</span> CaptchaField</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CaptchaTestForm</span>(<span class="params">forms.Form</span>):</span></span><br><span class="line">    email = forms.EmailField()</span><br><span class="line">    <span class="comment"># 验证码字段</span></span><br><span class="line">    captcha = CaptchaField()</span><br></pre></td></tr></table></figure></li>
<li><p>captcha的视图:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> request.method = <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">    form = CaptchaTestForm()</span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">&#x27;forget_pwd.html&#x27;</span>,context=&#123;<span class="string">&#x27;form&#x27;</span>:form&#125;)</span><br></pre></td></tr></table></figure></li>
<li><p>captcha的模板:</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><span class="template-variable">&#123;&#123; msg &#125;&#125;</span><span class="xml"> </span><span class="template-variable">&#123;&#123; errors &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;user:forget_pwd&#x27; %&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">        </span><span class="template-tag">&#123;% <span class="name"><span class="name">csrf_token</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">        </span><span class="template-variable">&#123;&#123; form.email &#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">        </span><span class="template-variable">&#123;&#123; form.captcha &#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;找回密码&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure></li>
<li><p>captcha的Ajax验证请求:</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span></span><br><span class="line"><span class="javascript"><span class="xml">    $(<span class="string">&#x27;id_captcha_1&#x27;</span>).blur(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">        <span class="keyword">var</span> $this = $(<span class="built_in">this</span>);</span></span></span><br><span class="line"><span class="javascript"><span class="xml">        <span class="keyword">var</span> key = $(<span class="string">&#x27;#id_captcha_0&#x27;</span>).val();</span></span></span><br><span class="line"><span class="javascript"><span class="xml">        <span class="keyword">var</span> code = $(<span class="built_in">this</span>).val();</span></span></span><br><span class="line"><span class="javascript"><span class="xml"></span></span></span><br><span class="line"><span class="javascript"><span class="xml">        $.getJSON(<span class="string">&#x27;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;user:valid_code)&#x27; %&#125;</span><span class="xml"><span class="handlebars"><span class="xml">&#x27;,&#123;key:key,code:code&#125;,function(data)&#123;</span></span></span></span><br><span class="line"><span class="xml"><span class="handlebars"><span class="xml"></span></span></span></span><br><span class="line"><span class="xml"><span class="handlebars"><span class="xml">            if (data.status==1)&#123;</span></span></span></span><br><span class="line"><span class="xml"><span class="handlebars"><span class="xml">                $this.after(&#x27;<span class="tag">&lt;<span class="name">span</span>&gt;</span>验证码正确<span class="tag">&lt;/<span class="name">span</span>&gt;</span>&#x27;)</span></span></span></span><br><span class="line"><span class="xml"><span class="handlebars"><span class="xml">            &#125;else&#123;</span></span></span></span><br><span class="line"><span class="xml"><span class="handlebars"><span class="xml">                $this.after(&#x27;<span class="tag">&lt;<span class="name">span</span>&gt;</span>验证码错误<span class="tag">&lt;/<span class="name">span</span>&gt;</span>&#x27;)</span></span></span></span><br><span class="line"><span class="xml"><span class="handlebars"><span class="xml">            &#125;</span></span></span></span><br><span class="line"><span class="xml"><span class="handlebars"><span class="xml">        &#125;)</span></span></span></span><br><span class="line"><span class="xml"><span class="handlebars"><span class="xml">    &#125;)</span></span></span></span><br><span class="line"><span class="xml"><span class="handlebars"><span class="xml"></span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure></li>
<li><p>captcha的Ajax验证请求的视图函数:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">valid_code</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.is_ajax():</span><br><span class="line">        key = request.GET.get(<span class="string">&#x27;key&#x27;</span>)</span><br><span class="line">        code = request.GET.get(<span class="string">&#x27;code&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># CaptchaStore模型对象</span></span><br><span class="line">        captcha = CaptchaStore.objects.<span class="built_in">filter</span>(hashkey=key).first()</span><br><span class="line">        <span class="keyword">if</span> captcha.response = code.lower():</span><br><span class="line">            <span class="comment"># 正确</span></span><br><span class="line">            data = &#123;<span class="string">&#x27;status&#x27;</span>:<span class="number">1</span>&#125;</span><br><span class="line">            <span class="comment"># 错误</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            data = &#123;<span class="string">&#x27;status&#x27;</span>:<span class="number">0</span>&#125;</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(data)</span><br></pre></td></tr></table></figure></li>
</ol>
<p>邮箱验证</p>
<ol>
<li><p>邮箱的配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">EMAIL_HOST = <span class="string">&#x27;smtp.qq.com&#x27;</span></span><br><span class="line">EMAIL_HOST_USER = <span class="string">&#x27;xxx@qq.com&#x27;</span></span><br><span class="line">EMAIL_HOST_PASSWORD = <span class="string">&#x27;p@ssw0rd&#x27;</span>  </span><br><span class="line">EMAIL_PORT = <span class="number">25</span></span><br><span class="line">EMAIL_USE_SSL = <span class="literal">True</span></span><br></pre></td></tr></table></figure></li>
<li><p>send_email:<br>发送成功返回1,否则为0</p>
</li>
<li><p>密码确认</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">code = request.POST.get(<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line"><span class="comment"># 获取用户id</span></span><br><span class="line">uid =request.session.get(code)</span><br><span class="line">UserProfile.objects.get(pk=uid)</span><br><span class="line"><span class="comment"># 获取密码</span></span><br><span class="line"></span><br><span class="line">pwd = request.POST.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line"><span class="comment"># 确认密码</span></span><br><span class="line">repwd = request.POST.get(<span class="string">&#x27;repassword&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> pwd==repwd <span class="keyword">and</span> user:</span><br><span class="line">    pwd = make_password(pwd)</span><br><span class="line">    user.password = pwd</span><br><span class="line">    user.save()</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;用户密码更新成功&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<p>中间件:</p>
<p>中间件有一个常用的做法:<br>当用户未登录的时候,不管点击哪个链接,都会跳转到登录页面.</p>
<p>但是如果我们需要<code>特定的链接</code>跳转到登录页面,就可以定义一个login_list</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">login_list = [<span class="string">&#x27;/user/center&#x27;</span>,]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MiddleWare1</span>(<span class="params">MiddlewareMixin</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        path = request.path</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> path <span class="keyword">in</span> login_list:</span><br><span class="line">            <span class="comment"># 如果用户处于登录状态</span></span><br><span class="line">            <span class="keyword">if</span> request.user.is_authenticated:</span><br><span class="line">                <span class="built_in">print</span>(request.user.username)</span><br><span class="line">            <span class="comment"># 如果用户不处于登录状态</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> redirect(reverse(<span class="string">&#x27;user:login&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>使用中间件的话就会拦截全部的request请求,如果<strong>想把登录验证加在特定的视图函数</strong>的话,可以使用<code>login_required</code>装饰器,</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="comment"># 判断用户是否登录</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_center</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;用户中心&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># setting.py</span></span><br><span class="line"><span class="comment"># 登录的路由(当用户没有登录的时候跳转的url)</span></span><br><span class="line">LOGIN_URL = <span class="string">&#x27;/user/login&#x27;</span></span><br></pre></td></tr></table></figure>

<p>注意:<code>login_required</code>只能用于使用了login函数的user.也就是必须继承是abstractuser</p>
<p>中间件总结:</p>
<ul>
<li>步骤:<ol>
<li>创建middleware文件夹,创建XXmidelware.py文件</li>
<li>在setting.py的<code>MIDDLEWARE</code>里注册中间件</li>
<li>定义类继承<code>MiddelwareMixin</code></li>
<li>重写方法</li>
</ol>
</li>
<li>如果不想使用中间件,可以使用login_required装饰器:<br>注意在settings.py里添加LOGIN_URL</li>
<li><img src="/images/997599-20170113093429385-1950865037.png" alt="img"></li>
</ul>
<p><img src="/images/997599-20170113093451697-1784079574.png" alt="img"></p>
<hr>
<p>使用媒体文件:<br>使用媒体文件比较复杂,需要的操作比较多:</p>
<ol>
<li><p>在setting.py里添加:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MEDIA_URL = <span class="string">&#x27;/media/&#x27;</span></span><br><span class="line">MEDIA_ROOT = os.path.join(BASE_DIR,<span class="string">&#x27;media&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># TEMPLATES里添加</span></span><br><span class="line"><span class="string">&#x27;django.template.context_processors.media&#x27;</span>,</span><br></pre></td></tr></table></figure></li>
<li><p>配置<strong>主路由</strong>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r&#x27;^media/(?&lt;path&gt;.*)$&#x27;</span>,server,&#123;<span class="string">&#x27;document_root&#x27;</span>:MEDIA_ROOT&#125;)</span><br></pre></td></tr></table></figure></li>
<li><p>在模板中添加:</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; MEDIA_ROOT &#125;&#125;</span><span class="xml"><span class="tag"><span class="string"> </span></span></span><span class="template-variable">&#123;&#123; user.icon &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span></span></span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<p>上传,保存文件:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_center</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        user = request.user</span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;center.html&#x27;</span>,&#123;<span class="string">&#x27;user&#x27;</span>:user&#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        username = request.POST.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        email = request.POST.get(<span class="string">&#x27;email&#x27;</span>)</span><br><span class="line">        mobile = request.POST.get(<span class="string">&#x27;mobile&#x27;</span>)</span><br><span class="line">        <span class="comment"># 头像图片从FIELS属性中获取</span></span><br><span class="line">        <span class="comment"># icon属于InMemoryUploadFile</span></span><br><span class="line">        icon = request.FIELS.get(<span class="string">&#x27;icon&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        request.user.username = username</span><br><span class="line">        request.user.email = email</span><br><span class="line">        request.user.mobile = mobile</span><br><span class="line">        <span class="comment"># 很意外的写法,二进制文件竟然可以直接赋值</span></span><br><span class="line">        <span class="comment"># 因为我们在定义user模型的时候,icon字段为imageField(upload_to=&#x27;&#x27;)</span></span><br><span class="line">        <span class="comment"># 拥有upload_to,所以,就可以为我们自动的保存图片</span></span><br><span class="line">        request.user.icon = icon</span><br><span class="line">        <span class="comment"># 保存</span></span><br><span class="line">        request.user.save()</span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;center.html&#x27;</span>,&#123;<span class="string">&#x27;user&#x27;</span>:request.user&#125;)</span><br></pre></td></tr></table></figure>

<p>注意:上面的代码中,user模型本身就有ImageField,这样可以我们可以直接保存,如果像下面的代码,我们就必须手动写保存的代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># myapp/views.py</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">savefile</span>(<span class="params">request</span>):</span></span><br><span class="line">	<span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">		f = request.FILES[<span class="string">&#x27;file&#x27;</span>]</span><br><span class="line">		<span class="comment"># 文件在服务器端的路径</span></span><br><span class="line">		filepath = os.path.join(settings.MEDIA_ROOT,f.name)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">with</span> <span class="built_in">open</span>(filepath,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> fp:</span><br><span class="line">			<span class="comment"># 分流读写(分段写入)</span></span><br><span class="line">			<span class="keyword">for</span> info <span class="keyword">in</span> f.chunks():</span><br><span class="line">				fp.write(info)</span><br><span class="line">		<span class="keyword">return</span> HttpResponse(<span class="string">&#x27;上传成功&#x27;</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">return</span> HttpResponse(<span class="string">&#x27;上传失败&#x27;</span>)</span><br></pre></td></tr></table></figure>



<hr>
<p>Xadmin的使用:</p>
<ol>
<li><p>安装Xadmin,注意不仅要pip install xadmin,还要pip install requirement.txt</p>
</li>
<li><p>Xadmin实际上也是一个app,但是我们一般不把自己创建的app和外部导入的app混在一起,所以,一般文件目录为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">blogproject</span><br><span class="line">  |-- myblog</span><br><span class="line">  |-- static</span><br><span class="line">  |-- templates</span><br><span class="line">  |-- apps</span><br><span class="line">      |-- user</span><br><span class="line">      |--article</span><br><span class="line">  |-- extra_apps</span><br><span class="line">      |-- xadmin</span><br></pre></td></tr></table></figure></li>
<li><p>既然是app,那么就需要在settings.py里注册,但是xadmin比较特殊,需要注册两个:<br><code>xadmin</code>和<code>crispy_forms</code></p>
</li>
<li><p>修改主路由,原先的admin路由为:<code>url(admin/,admin.site.urls)</code>,现在修改为<code>url(&#39;xadmin&#39;,xadmin.site.urls)</code></p>
</li>
<li><p>因为xadmin需要用到数据库,所以还需要执行迁移和同步</p>
</li>
<li><p>在需要用到xadmin的app下创建adminx.py文件:<br>admin.py和adminx.py文件的对比:<br>两者的接口是一模一样的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># admin.py</span></span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Article</span><br><span class="line">admin.site.register(Article)</span><br><span class="line"></span><br><span class="line"><span class="comment"># adminx.py</span></span><br><span class="line"><span class="keyword">import</span> xadmin</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Article</span><br><span class="line">admin.site.register(Article)</span><br></pre></td></tr></table></figure></li>
</ol>
<p>xadmin可以除了list_display等,还可以使用<code>list_editable</code>,可以在列表页直接编辑数据,不必到详情页编辑</p>
<p>编辑Xadmin:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> xadmin</span><br><span class="line"><span class="keyword">from</span> xadmin <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Article</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseSettings</span>:</span></span><br><span class="line">    enable_themes = <span class="literal">True</span></span><br><span class="line">    use_bootswatch = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GlobalSettings</span>:</span></span><br><span class="line">    site_title = <span class="string">&#x27;博客后台管理&#x27;</span></span><br><span class="line">    site_footer = <span class="string">&#x27;powered by liangbo&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">xadmin.site.register(views.BaseAdminView,BaseSettings)</span><br><span class="line">xadmin.site.register(views.CommAdminView,GlobalSettings)</span><br></pre></td></tr></table></figure>



<p>带参数的url反向解析:</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;article:detail&#x27; %&#125;</span><span class="xml"><span class="tag"><span class="string">?id=</span></span></span><span class="template-variable">&#123;&#123; article.id | add:&quot;1&quot; &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;article:detail&#x27; %&#125;</span><span class="xml"><span class="tag"><span class="string">?id=</span></span></span><span class="template-variable">&#123;&#123; article.id | add:&quot;1&quot; &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&amp;tid=</span></span></span><span class="template-variable">&#123;&#123; tid &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="comment">&#123;# 嵌套使用 #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;article:show&#x27; %&#125;</span><span class="xml"><span class="tag"><span class="string">?page=</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> page.has_previous %&#125;</span><span class="template-variable">&#123;&#123; page.previous_page_number &#125;&#125;</span><span class="template-tag">&#123;% <span class="name"><span class="name">else</span></span> %&#125;</span><span class="xml"><span class="tag"><span class="string">1</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">    文本</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>在视图函数就写:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果取不到就将page参数设置为1</span></span><br><span class="line">page = request.GET.get(<span class="string">&#x27;page&#x27;</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure>



<hr>
<p>富文本编辑器</p>
<p>使用ckeditor:<br><code>pip install django-ckeditor</code></p>
<ol>
<li><p>ckeditor也是app,所以也要注册到INSTALL_APPS中,需要注册两种:</p>
<ul>
<li>ckeditor:<br>添加ckeditor富文本编辑器</li>
<li>ckeditor_uploder:<br>使用ckeditor进行文件上传</li>
</ul>
</li>
<li><p>在setting.py添加:<br><code>CKEDITOR_UPLOAD_PATH=&quot;uploads/&quot;</code>表示使用ckeditor上传文件时的存储路径.<br>注意,这个<code>CKEDITOR_UPLOAD_PATH</code>是依赖于<code>MEDIA_ROOT</code>的.(上面的uploads表示:将文件存储到<code>MEDIA_ROOT/uploads</code>目录下)</p>
</li>
<li><p>ckeditor还可以在setting.py里面设置ckeditor相关的配置:<br>使用<code>CKEDITOR_CONFIGS</code></p>
</li>
<li><p>收集静态文件:<br><code>python manage.py collectstatic</code></p>
</li>
<li><p>在主路由添加:<br><code>url(r&#39;ckeditor/&#39;,include(&#39;ckeditor_uploader.urls&#39;))</code></p>
<p>ckeditor本身就是app,ckeditor内部有upload和browse两个路由.upload负责上传,browse负责预览</p>
</li>
<li><p>让Django的后台使用富文本:</p>
<p>比如博客的Article模型,我们希望在后台写文章的时候,直接就能使用富文本编写.<br>这时需要将<code>content=model.TextFiled(verbose_name=&quot;内容&quot;)</code>改为<br><code>content=RichTextUploadingField(verbose_name=&quot;内容&quot;)</code><br>(需要先导包<code>from ckeditor_uploader.fileds import RichTextUploadeingField</code>)</p>
<p>简单来说,希望哪个字段在后台是富文本格式,就将这个字段改为RichTextUploadingField</p>
</li>
<li><p>最后迁移和同步即可.</p>
</li>
</ol>
<p>上面的步骤是在后台使用富文本,那么如何在前台使用?</p>
<ol>
<li><p>Model里定义:<br><code>content=RichTextUploadingField(verbose_name=&quot;内容&quot;)</code></p>
</li>
<li><p>定义一个forms:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleForm</span>(<span class="params">forms.ModelForm</span>):</span></span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Article</span><br><span class="line">        fields = <span class="string">&#x27;__all__&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li><p>在模板里:<br>以前的写法</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;#&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">	</span><span class="template-tag">&#123;% <span class="name"><span class="name">csrf_token</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    </span><span class="template-variable">&#123;&#123; regform.as_p &#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;发表文章&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>现在的写法:</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;#&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">	</span><span class="template-tag">&#123;% <span class="name"><span class="name">csrf_token</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    </span><span class="template-variable">&#123;&#123; regform.media &#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    </span><span class="template-variable">&#123;&#123; regform.as_p &#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;发表文章&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>就只是多了一个</p>
</li>
</ol>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>