<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;地址&quot;&gt;&lt;a href=&quot;#地址&quot; class=&quot;headerlink&quot; title=&quot;地址&quot;&gt;&lt;/a&gt;地址&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://www.bilibili.com/video/av28871471/&quot;&gt;(视频) django rest framework 实战和源码剖析&lt;/a&gt;"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>django_rest_framework_实战和源码剖析 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Django/" rel="tag">Django</a></div><div class="post-time">2021-08-29</div></div></div><div class="container post-header"><h1>django_rest_framework_实战和源码剖析</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%B0%E5%9D%80"><span class="toc-number">1.</span> <span class="toc-text">地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E5%87%86%E5%A4%87"><span class="toc-number">2.</span> <span class="toc-text">知识准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#FBV-CBV"><span class="toc-number">2.1.</span> <span class="toc-text">FBV,CBV</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CBV%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82"><span class="toc-number">2.2.</span> <span class="toc-text">CBV的实现细节</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CBV%E6%AF%94%E8%B5%B7FBV%E7%9A%84%E4%BC%98%E5%8A%BF"><span class="toc-number">2.3.</span> <span class="toc-text">CBV比起FBV的优势</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E4%B8%AAView%E5%85%8D%E9%99%A4SCRF%E9%AA%8C%E8%AF%81%E6%88%96%E5%8D%95%E4%B8%AAView%E5%A2%9E%E5%8A%A0SCRF%E9%AA%8C%E8%AF%81"><span class="toc-number">2.4.</span> <span class="toc-text">单个View免除SCRF验证或单个View增加SCRF验证</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#FBV%E4%BD%BF%E7%94%A8%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="toc-number">2.4.1.</span> <span class="toc-text">FBV使用装饰器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CBV%E4%BD%BF%E7%94%A8%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="toc-number">2.4.2.</span> <span class="toc-text">CBV使用装饰器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CSRF%E7%9A%84%E9%98%B2%E5%BE%A1%E9%80%BB%E8%BE%91%E5%8F%8A%E5%85%B6%E4%BD%8D%E7%BD%AE"><span class="toc-number">2.5.</span> <span class="toc-text">CSRF的防御逻辑及其位置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%88%97%E8%A1%A8%E7%94%9F%E6%88%90%E5%BC%8F%E5%88%9B%E5%BB%BA%E5%AF%B9%E8%B1%A1%E5%88%97%E8%A1%A8"><span class="toc-number">2.6.</span> <span class="toc-text">使用列表生成式创建对象列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#request-body%E5%92%8Crequest-POST%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">2.7.</span> <span class="toc-text">request.body和request.POST的关系</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#restful%E8%A7%84%E8%8C%83"><span class="toc-number">3.</span> <span class="toc-text">restful规范</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Django-rest-framework%E6%A1%86%E6%9E%B6"><span class="toc-number"></span> <span class="toc-text">Django rest framework框架</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E8%AE%A4%E8%AF%81%E5%92%8C%E6%BA%90%E7%A0%81%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">使用认证和源码执行流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81"><span class="toc-number">2.</span> <span class="toc-text">认证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%A4%E8%AF%81"><span class="toc-number">2.1.</span> <span class="toc-text">自定义认证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E5%85%A8%E5%B1%80%E8%AE%A4%E8%AF%81"><span class="toc-number">2.2.</span> <span class="toc-text">设置全局认证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%8F%82%E6%95%B0"><span class="toc-number">2.3.</span> <span class="toc-text">全局参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E7%9A%84%E8%AE%A4%E8%AF%81%E7%B1%BB"><span class="toc-number">2.4.</span> <span class="toc-text">内置的认证类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B"><span class="toc-number">2.5.</span> <span class="toc-text">源码流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%B5%81%E7%A8%8B"><span class="toc-number">2.6.</span> <span class="toc-text">实现流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%83%E9%99%90"><span class="toc-number">3.</span> <span class="toc-text">权限</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B-1"><span class="toc-number">3.1.</span> <span class="toc-text">源码流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%9D%83%E9%99%90"><span class="toc-number">3.2.</span> <span class="toc-text">自定义权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%92%8C%E5%B1%80%E9%83%A8%E6%9D%83%E9%99%90"><span class="toc-number">3.3.</span> <span class="toc-text">全局和局部权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%8F%82%E6%95%B0-1"><span class="toc-number">3.4.</span> <span class="toc-text">全局参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E6%9D%83%E9%99%90%E7%B1%BB"><span class="toc-number">3.5.</span> <span class="toc-text">内置权限类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%B5%81%E7%A8%8B-1"><span class="toc-number">3.6.</span> <span class="toc-text">实现流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8A%82%E6%B5%81-%E8%AE%BF%E9%97%AE%E9%A2%91%E7%8E%87%E6%8E%A7%E5%88%B6"><span class="toc-number">4.</span> <span class="toc-text">节流(访问频率控制)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B-2"><span class="toc-number">4.1.</span> <span class="toc-text">源码流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%98%88%E5%80%BC"><span class="toc-number">4.2.</span> <span class="toc-text">自定义阈值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%92%8C%E5%B1%80%E9%83%A8%E9%98%88%E5%80%BC"><span class="toc-number">4.3.</span> <span class="toc-text">全局和局部阈值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E9%98%88%E5%80%BC%E7%B1%BB"><span class="toc-number">4.4.</span> <span class="toc-text">内置阈值类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%8F%82%E6%95%B0-2"><span class="toc-number">4.5.</span> <span class="toc-text">全局参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%B5%81%E7%A8%8B-2"><span class="toc-number">4.6.</span> <span class="toc-text">实现流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%88%E6%9C%AC"><span class="toc-number">5.</span> <span class="toc-text">版本</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B-3"><span class="toc-number">5.1.</span> <span class="toc-text">源码流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6-%E9%80%9A%E8%BF%87url%E7%9A%84version%E5%8F%82%E6%95%B0%E4%BC%A0%E5%8F%82"><span class="toc-number">5.2.</span> <span class="toc-text">自定义版本控制(通过url的version参数传参)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E7%89%88%E6%9C%AC%E7%B1%BB"><span class="toc-number">5.3.</span> <span class="toc-text">内置版本类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%8F%82%E6%95%B0-3"><span class="toc-number">5.4.</span> <span class="toc-text">全局参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6-%E9%80%9A%E8%BF%87url%E8%B7%AF%E5%BE%84%E4%BC%A0%E5%8F%82-%E5%8F%8A%E5%85%A8%E5%B1%80%E4%BD%BF%E7%94%A8"><span class="toc-number">5.5.</span> <span class="toc-text">自定义版本控制(通过url路径传参)及全局使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%B5%81%E7%A8%8B-3"><span class="toc-number">5.6.</span> <span class="toc-text">实现流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E5%99%A8"><span class="toc-number">6.</span> <span class="toc-text">解析器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B-4"><span class="toc-number">6.1.</span> <span class="toc-text">源码流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A7%A3%E6%9E%90%E5%99%A8"><span class="toc-number">6.2.</span> <span class="toc-text">自定义解析器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E4%BD%BF%E7%94%A8"><span class="toc-number">6.3.</span> <span class="toc-text">全局使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E8%A7%A3%E9%87%8A%E5%99%A8%E7%B1%BB"><span class="toc-number">6.4.</span> <span class="toc-text">内置解释器类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%B5%81%E7%A8%8B-4"><span class="toc-number">6.5.</span> <span class="toc-text">实现流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">7.</span> <span class="toc-text">序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%AF%B9%E8%AF%B7%E6%B1%82%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E6%A0%A1%E9%AA%8C"><span class="toc-number">7.1.</span> <span class="toc-text">1. 对请求数据进行校验</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8"><span class="toc-number">7.1.1.</span> <span class="toc-text">简单使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A7%84%E5%88%99"><span class="toc-number">7.1.2.</span> <span class="toc-text">自定义规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0"><span class="toc-number">7.1.3.</span> <span class="toc-text">钩子函数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%AF%B9QuerySet%E8%BF%9B%E8%A1%8C%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">7.2.</span> <span class="toc-text">2. 对QuerySet进行序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8-1"><span class="toc-number">7.2.1.</span> <span class="toc-text">简单使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#source%E5%8F%82%E6%95%B0"><span class="toc-number">7.2.2.</span> <span class="toc-text">source参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SericalizerMethodField-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%98%BE%E7%A4%BA"><span class="toc-number">7.2.3.</span> <span class="toc-text">SericalizerMethodField()自定义显示</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E5%BA%8F%E5%88%97%E5%8C%96%E7%B1%BB"><span class="toc-number">7.2.4.</span> <span class="toc-text">内置序列化类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B-5"><span class="toc-number">7.2.5.</span> <span class="toc-text">源码流程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E9%A1%B5"><span class="toc-number">8.</span> <span class="toc-text">分页</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9C%8B%E7%AC%ACn%E9%A1%B5%EF%BC%8C%E6%AF%8F%E9%A1%B5%E6%98%BE%E7%A4%BAn%E6%9D%A1%E6%95%B0%E6%8D%AE"><span class="toc-number">8.1.</span> <span class="toc-text">看第n页，每页显示n条数据</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89page-size%E5%88%86%E9%A1%B5%E5%99%A8"><span class="toc-number">8.1.1.</span> <span class="toc-text">自定义page,size分页器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E6%9F%90%E4%B8%AA%E4%BD%8D%E7%BD%AE%EF%BC%8C%E5%90%91%E5%90%8E%E6%9F%A5%E7%9C%8Bn%E6%9D%A1%E6%95%B0%E6%8D%AE"><span class="toc-number">8.2.</span> <span class="toc-text">在某个位置，向后查看n条数据</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89limit-offset%E5%88%86%E9%A1%B5%E5%99%A8"><span class="toc-number">8.2.1.</span> <span class="toc-text">自定义limit,offset分页器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E5%AF%86%E5%88%86%E9%A1%B5%EF%BC%8C%E5%8F%AA%E8%83%BD%E7%9C%8B%E4%B8%8A%E4%B8%80%E9%A1%B5%E5%92%8C%E4%B8%8B%E4%B8%80%E9%A1%B5"><span class="toc-number">8.3.</span> <span class="toc-text">加密分页，只能看上一页和下一页</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%86%E5%9B%BE"><span class="toc-number">9.</span> <span class="toc-text">视图</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GenericAPIView"><span class="toc-number">9.1.</span> <span class="toc-text">GenericAPIView</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GenericViewSet"><span class="toc-number">9.2.</span> <span class="toc-text">GenericViewSet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ModelViewSet"><span class="toc-number">9.3.</span> <span class="toc-text">ModelViewSet</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1"><span class="toc-number">10.</span> <span class="toc-text">路由</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E5%A1%AB%E5%86%99%E8%B7%AF%E7%94%B1"><span class="toc-number">10.1.</span> <span class="toc-text">手动填写路由</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E8%87%AA%E5%8A%A8%E8%B7%AF%E7%94%B1"><span class="toc-number">10.2.</span> <span class="toc-text">全自动路由</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B8%B2%E6%9F%93%E5%99%A8"><span class="toc-number">11.</span> <span class="toc-text">渲染器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8-2"><span class="toc-number">11.1.</span> <span class="toc-text">简单使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E6%B8%B2%E6%9F%93%E5%99%A8%E7%B1%BB"><span class="toc-number">11.2.</span> <span class="toc-text">内置渲染器类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE"><span class="toc-number">11.3.</span> <span class="toc-text">全局配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Content-Type"><span class="toc-number">12.</span> <span class="toc-text">Content-Type</span></a></li></ol></details></div><div class="container post-content"><h2 id="地址"><a href="#地址" class="headerlink" title="地址"></a>地址</h2><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/av28871471/">(视频) django rest framework 实战和源码剖析</a></p>
<h2 id="知识准备"><a href="#知识准备" class="headerlink" title="知识准备"></a>知识准备</h2><h3 id="FBV-CBV"><a href="#FBV-CBV" class="headerlink" title="FBV,CBV"></a>FBV,CBV</h3><ul>
<li>FBV : Function Base View</li>
<li>CBV : Class Base View </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user</span>(<span class="params">request</span>):</span></span><br><span class="line">	<span class="keyword">return</span> HttpResponse(<span class="string">&#x27;FBV&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> View</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StudentView</span>(<span class="params">View</span>):</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request</span>):</span></span><br><span class="line">		<span class="keyword">return</span> HttpResponse(<span class="string">&#x27;CBV&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h3 id="CBV的实现细节"><a href="#CBV的实现细节" class="headerlink" title="CBV的实现细节"></a>CBV的实现细节</h3><p>使用Class_View在urls.py里面使用<code>as_view</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> View</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StudentView</span>(<span class="params">View</span>):</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request</span>):</span></span><br><span class="line">		<span class="keyword">return</span> HttpResponse(<span class="string">&#x27;GET&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self,request</span>):</span></span><br><span class="line">		<span class="keyword">return</span> HttpResponse(<span class="string">&#x27;POST&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># urls.py</span></span><br><span class="line">url(<span class="string">r&#x27;^xxx/$&#x27;</span>, views.StudentView.as_view(),name=<span class="string">&#x27;student&#x27;</span>),    </span><br></pre></td></tr></table></figure>

<blockquote>
<p>问题 : <code>as_view</code>是如何知道我们是使用post还是get方法.</p>
<p>使用getattr():</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http_method_names = [<span class="string">&#x27;get&#x27;</span>,<span class="string">&#x27;post&#x27;</span>,<span class="string">&#x27;put&#x27;</span>,<span class="string">&#x27;delete&#x27;</span>,<span class="string">&#x27;head&#x27;</span>,<span class="string">&#x27;options&#x27;</span>,<span class="string">&#x27;trace&#x27;</span>]</span><br><span class="line"><span class="comment"># 直接获取对象方法</span></span><br><span class="line"><span class="built_in">getattr</span>(http_method_names,request.method)</span><br></pre></td></tr></table></figure>

<p>通过源码发现,其实as_view在内部调用了<code>dispath()</code>方法,上面的逻辑就是<code>dispath()</code>方法实现的</p>
<p><code>dispatch() </code>: <strong>会自动判断当前的请求方式,根据这个请求方式，找相到应的真正的View函数</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dispatch源码</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispath</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">	<span class="keyword">if</span> request.method.lower() <span class="keyword">in</span> self.http_method_names:</span><br><span class="line">		headler = <span class="built_in">getattr</span>(self,request.method.lower(),self.http_method_not_allowed)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		headler = self.http_method_not_allowed</span><br><span class="line">	<span class="keyword">return</span> headler(request,*args,**kwargs)</span><br></pre></td></tr></table></figure>

<p><img src="/images/bd852e78-1556693679889.png" alt="1556693679889"></p>
<p>因此我们可以在自己的class_view里实现<code>dispatch()</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StudentView</span>(<span class="params">View</span>):</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">dispath</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&#x27;--- before ---&#x27;</span>)</span><br><span class="line">		ret = <span class="built_in">super</span>().dispath(request,*args,**kwargs)</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&#x27;--- after ---&#x27;</span>)</span><br><span class="line">		<span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request</span>):</span></span><br><span class="line">		<span class="keyword">return</span> HttpResponse(<span class="string">&#x27;GET&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self,request</span>):</span></span><br><span class="line">		<span class="keyword">return</span> HttpResponse(<span class="string">&#x27;POST&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>为什么要自己写<code>dispath</code>?</p>
<ul>
<li>这个dispath很像<code>process_request</code>中间件,每个请求过来请都需要经过这个dispath函数</li>
<li>但是<code>process_request</code>是全局的,而这里的<code>dispath</code>是局部的</li>
<li>我们可以在这里处理事务</li>
</ul>
</blockquote>
<p>所以,我们就知道了FBV和CBV互换的方法和原理</p>
<ol>
<li><strong>CBV基于反射实现根据请求方式不同，执行不同的方法</strong>。</li>
<li>路由ur1-&gt;view方法-&gt; dispatch方法（反射执行其他：GET/POST/DELETE/PUT）</li>
</ol>
<h3 id="CBV比起FBV的优势"><a href="#CBV比起FBV的优势" class="headerlink" title="CBV比起FBV的优势"></a>CBV比起FBV的优势</h3><p>继承:<br>如果有多个类似的Class_view,我们可以使用BaseView来继承部分代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseView</span>(<span class="params">View</span>):</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">dispath</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&#x27;--- before ---&#x27;</span>)</span><br><span class="line">		ret = <span class="built_in">super</span>().dispath(request,*args,**kwargs)</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&#x27;--- after ---&#x27;</span>)</span><br><span class="line">		<span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StudentView</span>(<span class="params">BaseView</span>):</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request</span>):</span></span><br><span class="line">		<span class="keyword">return</span> HttpResponse(<span class="string">&#x27;GET&#x27;</span>)</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self,request</span>):</span></span><br><span class="line">		<span class="keyword">return</span> HttpResponse(<span class="string">&#x27;POST&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TeacherView</span>(<span class="params">BaseView</span>):</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request</span>):</span></span><br><span class="line">		<span class="keyword">return</span> HttpResponse(<span class="string">&#x27;GET&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self,request</span>):</span></span><br><span class="line">		<span class="keyword">return</span> HttpResponse(<span class="string">&#x27;POST&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h3 id="单个View免除SCRF验证或单个View增加SCRF验证"><a href="#单个View免除SCRF验证或单个View增加SCRF验证" class="headerlink" title="单个View免除SCRF验证或单个View增加SCRF验证"></a>单个View免除SCRF验证或单个View增加SCRF验证</h3><h4 id="FBV使用装饰器"><a href="#FBV使用装饰器" class="headerlink" title="FBV使用装饰器"></a>FBV使用装饰器</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.decorators.csrf <span class="keyword">import</span> csrf_exempt,csrf_protect</span><br><span class="line"><span class="comment"># 免除</span></span><br><span class="line"><span class="meta">@csrf_exempt</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user</span>(<span class="params">request</span>):</span></span><br><span class="line">	<span class="keyword">return</span> HttpResponse(<span class="string">&#x27;user&#x27;</span>)</span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line"><span class="meta">@csrf_protect</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user</span>(<span class="params">request</span>):</span></span><br><span class="line">	<span class="keyword">return</span> HttpResponse(<span class="string">&#x27;user&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="CBV使用装饰器"><a href="#CBV使用装饰器" class="headerlink" title="CBV使用装饰器"></a>CBV使用装饰器</h4><p>FBV可以直接使用装饰器,但是CBV不可以,</p>
<ol>
<li>要使用<code>method_decorator</code>装饰器将<code>csrf_exempt</code>当成参数传入</li>
<li>而且,不能加在get,post函数中,<strong>必须加在dispath函数中</strong>(单独方法无效)</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.decorators.csrf <span class="keyword">import</span> csrf_exempt,csrf_protect</span><br><span class="line"><span class="keyword">from</span> django.utils.decorators <span class="keyword">import</span> method_decorator</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseView</span>(<span class="params">View</span>):</span></span><br><span class="line"><span class="meta">	@method_decorator(<span class="params">csrf_exempt</span>)</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">dispath</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&#x27;--- before ---&#x27;</span>)</span><br><span class="line">		ret = <span class="built_in">super</span>().dispath(request,*args,**kwargs)</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&#x27;--- after ---&#x27;</span>)</span><br><span class="line">		<span class="keyword">return</span> ret</span><br></pre></td></tr></table></figure>

<p>或者使用类装饰器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@method_decorator(<span class="params">csrf_exempt,name=<span class="string">&#x27;dispatch&#x27;</span></span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StudentView</span>(<span class="params">BaseView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;GET&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;POST&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h3 id="CSRF的防御逻辑及其位置"><a href="#CSRF的防御逻辑及其位置" class="headerlink" title="CSRF的防御逻辑及其位置"></a>CSRF的防御逻辑及其位置</h3><p>问题 : Django中的CSRF防御逻辑是放在中间件的哪个方法?process_request还是process_view?</p>
<blockquote>
<ol>
<li>process_request和process_view都是在执行视图函数前执行的</li>
<li>先顺序执行完process_request再顺序执行process_view</li>
<li><strong>process_request执行的时候是没有View函数对象的,执行process_view会携带View函数对象</strong></li>
<li>我们有免除CSRF的装饰器,而装饰器是在函数身上的</li>
<li>所以,CSRF防御逻辑是放在process_view</li>
</ol>
</blockquote>
<blockquote>
<p>CSRF的防御逻辑 :</p>
<ol>
<li>检查视图是否被@csrf_exempt装饰(免除csrf认证)</li>
<li>取出request中保存着token的cookies,进行校验</li>
</ol>
</blockquote>
<h3 id="使用列表生成式创建对象列表"><a href="#使用列表生成式创建对象列表" class="headerlink" title="使用列表生成式创建对象列表"></a>使用列表生成式创建对象列表</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bar</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成对象列表</span></span><br><span class="line">res = [item() <span class="keyword">for</span> item <span class="keyword">in</span> (Foo,Bar)]</span><br></pre></td></tr></table></figure>

<p>这没什么难的,但是之后我们会重复使用这种列表生成式,需要熟悉这种操作</p>
<h3 id="request-body和request-POST的关系"><a href="#request-body和request-POST的关系" class="headerlink" title="request.body和request.POST的关系"></a>request.body和request.POST的关系</h3><ul>
<li><p>浏览器发送一个post请求,request.POST不一定有值,但是request.body一定有值</p>
</li>
<li><p>原因: 其实<strong>request.POST的值是从request.body转化过去的</strong></p>
<blockquote>
<p>源码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> self.content_type == <span class="string">&#x27;multipart/form-data&#x27;</span>:</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">elif</span> self.content_type == <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>:</span><br><span class="line">    self._post.self._files = QueryDict(self.body,encoding=self._encoding),MultiValueDict()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    self._post.self._files = QueryDict(encoding=self._encoding),MultiValueDict()</span><br></pre></td></tr></table></figure></blockquote>
</li>
<li><p>要想request.POST中有值,需要满足两个要求:</p>
<ol>
<li><strong>请求头要求</strong> : 请求头中的<code>Content_Type</code>的值为<code>application/x-www-form-urlencoded</code>时,去request.body中解析数据</li>
<li><strong>数据格式要求</strong> : <code>name=alex&amp;age=18&amp;gender=男</code></li>
</ol>
</li>
<li><p>请求分类:</p>
<ul>
<li><p>如果使用form表单提交,默认的<code>Content_Type</code>的值和数据格式都会符合要求</p>
</li>
<li><p>如果是ajax,默认的<code>Content_Type</code>的值和数据格式都会符合要求</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    <span class="attr">url</span>:...</span><br><span class="line">    <span class="attr">type</span>:POST,</span><br><span class="line">    <span class="comment">// 虽然写的是字典,但是默认还是将它转为符合要求的数据格式</span></span><br><span class="line">    <span class="attr">data</span>:&#123;<span class="attr">name</span>:alax,<span class="attr">age</span>:<span class="number">18</span>&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>但是<strong>ajax能够定制请求头</strong>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    <span class="attr">url</span>:...</span><br><span class="line">    <span class="attr">type</span>:POST,</span><br><span class="line">    <span class="comment">// 定制请求头</span></span><br><span class="line">    <span class="attr">headers</span>:&#123;<span class="string">&#x27;Content_Type&#x27;</span>:<span class="string">&#x27;application/json&#x27;</span>&#125;</span><br><span class="line">    <span class="attr">data</span>:&#123;<span class="attr">name</span>:alax,<span class="attr">age</span>:<span class="number">18</span>&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>此时request.POST就没有数据</p>
</li>
</ul>
</li>
<li><p>如果request.POST没有数据,就可以去request.body中取值:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">json.loads((request.body).decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="restful规范"><a href="#restful规范" class="headerlink" title="restful规范"></a>restful规范</h2><ol>
<li><p>API与用户的通信协议，总是使用HTTPS协议</p>
</li>
<li><p>域名 </p>
<blockquote>
<ul>
<li>子域名方式 :<br><a target="_blank" rel="noopener" href="https://api.example.com/">https://api.example.com</a> : 尽量将API部署在专用域名（会存在跨域问题）</li>
<li>URL方式 :<br><a target="_blank" rel="noopener" href="https://example.org/api/">https://example.org/api/</a> : API很简单</li>
</ul>
</blockquote>
</li>
<li><p>版本</p>
<blockquote>
<ul>
<li>URL：<br><a target="_blank" rel="noopener" href="https://api.example.com/v1/">https://api.example.com/v1/</a></li>
<li>请求头：<br>跨域时，引发发送多次请求</li>
</ul>
</blockquote>
</li>
<li><p>路径，视网络上任何东西都是资源，均使用名词表示（可复数）</p>
<blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://api.example.com/v1/zoos">https://api.example.com/v1/zoos</a></li>
<li><a target="_blank" rel="noopener" href="https://api.example.com/v1/animals">https://api.example.com/v1/animals</a></li>
<li><a target="_blank" rel="noopener" href="https://api.example.com/v1/employees">https://api.example.com/v1/employees</a></li>
</ul>
</blockquote>
</li>
<li><p>根据method的不同做不同的操作</p>
<blockquote>
<ul>
<li>GET      ：从服务器取出资源（一项或多项）</li>
<li>POST    ：在服务器新建一个资源</li>
<li>PUT      ：在服务器更新资源（客户端提供改变后的完整资源）</li>
<li>PATCH  ：在服务器更新资源（客户端提供改变的属性）</li>
<li>DELETE ：从服务器删除资源</li>
</ul>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bad</span></span><br><span class="line">url(<span class="string">r&#x27;add_order/&#x27;</span>,View_func1,name=<span class="string">&#x27;add_order&#x27;</span>),</span><br><span class="line">url(<span class="string">r&#x27;del_order/&#x27;</span>,View_func2,name=<span class="string">&#x27;del_order&#x27;</span>),</span><br><span class="line">url(<span class="string">r&#x27;upt_order/&#x27;</span>,View_func3,name=<span class="string">&#x27;upt_order&#x27;</span>),</span><br><span class="line">url(<span class="string">r&#x27;get_order/&#x27;</span>,View_func4,name=<span class="string">&#x27;get_order&#x27;</span>),</span><br><span class="line"></span><br><span class="line"><span class="comment"># good:</span></span><br><span class="line">url(<span class="string">r&#x27;order/&#x27;</span>,view.OrderView.as_view(),name=<span class="string">&#x27;order&#x27;</span>),</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderView</span>(<span class="params">View</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;获取订单&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;创建订单&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;更新订单&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;删除订单&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>过滤，通过在url上传参的形式传递搜索条件</p>
<blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://api.example.com/v1/zoos?limit=10%EF%BC%9A%E6%8C%87%E5%AE%9A%E8%BF%94%E5%9B%9E%E8%AE%B0%E5%BD%95%E7%9A%84%E6%95%B0%E9%87%8F">https://api.example.com/v1/zoos?limit=10：指定返回记录的数量</a></li>
<li><a target="_blank" rel="noopener" href="https://api.example.com/v1/zoos?offset=10%EF%BC%9A%E6%8C%87%E5%AE%9A%E8%BF%94%E5%9B%9E%E8%AE%B0%E5%BD%95%E7%9A%84%E5%BC%80%E5%A7%8B%E4%BD%8D%E7%BD%AE">https://api.example.com/v1/zoos?offset=10：指定返回记录的开始位置</a></li>
<li><a target="_blank" rel="noopener" href="https://api.example.com/v1/zoos?page=2&amp;per_page=100%EF%BC%9A%E6%8C%87%E5%AE%9A%E7%AC%AC%E5%87%A0%E9%A1%B5%EF%BC%8C%E4%BB%A5%E5%8F%8A%E6%AF%8F%E9%A1%B5%E7%9A%84%E8%AE%B0%E5%BD%95%E6%95%B0">https://api.example.com/v1/zoos?page=2&amp;per_page=100：指定第几页，以及每页的记录数</a></li>
<li><a target="_blank" rel="noopener" href="https://api.example.com/v1/zoos?sortby=name&amp;order=asc%EF%BC%9A%E6%8C%87%E5%AE%9A%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%E6%8C%89%E7%85%A7%E5%93%AA%E4%B8%AA%E5%B1%9E%E6%80%A7%E6%8E%92%E5%BA%8F%EF%BC%8C%E4%BB%A5%E5%8F%8A%E6%8E%92%E5%BA%8F%E9%A1%BA%E5%BA%8F">https://api.example.com/v1/zoos?sortby=name&amp;order=asc：指定返回结果按照哪个属性排序，以及排序顺序</a></li>
<li><a target="_blank" rel="noopener" href="https://api.example.com/v1/zoos?animal_type_id=1%EF%BC%9A%E6%8C%87%E5%AE%9A%E7%AD%9B%E9%80%89%E6%9D%A1%E4%BB%B6">https://api.example.com/v1/zoos?animal_type_id=1：指定筛选条件</a></li>
</ul>
</blockquote>
</li>
<li><p>状态码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">200 OK - [GET]：服务器成功返回用户请求的数据，该操作是幂等的（Idempotent）。</span><br><span class="line">201 CREATED - [POST/PUT/PATCH]：用户新建或修改数据成功。</span><br><span class="line">202 Accepted - [*]：表示一个请求已经进入后台排队（异步任务）</span><br><span class="line">204 NO CONTENT - [DELETE]：用户删除数据成功。</span><br><span class="line">400 INVALID REQUEST - [POST/PUT/PATCH]：用户发出的请求有错误，服务器没有进行新建或修改数据的操作，该操作是幂等的。</span><br><span class="line">401 Unauthorized - [*]：表示用户没有权限（令牌、用户名、密码错误）。</span><br><span class="line">403 Forbidden - [*] 表示用户得到授权（与401错误相对），但是访问是被禁止的。</span><br><span class="line">404 NOT FOUND - [*]：用户发出的请求针对的是不存在的记录，服务器没有进行操作，该操作是幂等的。</span><br><span class="line">406 Not Acceptable - [GET]：用户请求的格式不可得（比如用户请求JSON格式，但是只有XML格式）。</span><br><span class="line">410 Gone -[GET]：用户请求的资源被永久删除，且不会再得到的。</span><br><span class="line">422 Unprocesable entity - [POST/PUT/PATCH] 当创建一个对象时，发生一个验证错误。</span><br><span class="line">500 INTERNAL SERVER ERROR - [*]：服务器发生错误，用户将无法判断发出的请求是否成功。</span><br></pre></td></tr></table></figure></li>
<li><p>错误处理，状态码是4xx时，应返回错误信息，error当做key。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    error: <span class="string">&quot;Invalid API key&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>返回结果，针对不同操作，服务器向用户返回的结果应该符合以下规范。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /collection：返回资源对象的列表（数组）</span><br><span class="line">GET /collection/resource：返回单个资源对象</span><br><span class="line">POST /collection：返回新生成的资源对象</span><br><span class="line">PUT /collection/resource：返回完整的资源对象</span><br><span class="line">PATCH /collection/resource：返回完整的资源对象</span><br><span class="line">DELETE /collection/resource：返回一个空文档</span><br></pre></td></tr></table></figure>

<blockquote>
<p>示例 : </p>
<ul>
<li>GET /order/：返回资源对象的列表（数组）<br>(返回整个订单数组)</li>
<li>GET /order/1/：返回单个资源对象<br>(返回id为1的订单)</li>
<li>POST /order/：返回新生成的资源对象<br>(返回新生成的订单)</li>
<li>PUT /order/1：返回完整的资源对象<br>(返回修改的订单,全局)</li>
<li>PATCH /order/1：返回完整的资源对象<br>(返回修改的订单,局部)</li>
<li>DELETE /order/1：返回一个空文档</li>
</ul>
</blockquote>
</li>
<li><p>Hypermedia API，RESTful API最好做到Hypermedia，即返回结果中提供链接，连向其他API方法，使得用户不查文档，也知道下一步应该做什么。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;link&quot;</span>: &#123;</span><br><span class="line">  <span class="attr">&quot;rel&quot;</span>:   <span class="string">&quot;collection https://www.example.com/zoos&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;href&quot;</span>:  <span class="string">&quot;https://api.example.com/zoos&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;List of zoos&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;type&quot;</span>:  <span class="string">&quot;application/vnd.yourformat+json&quot;</span></span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>示例:<br>请求一个订单列表</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        id:<span class="number">1</span>,</span><br><span class="line">        name:&#x27;apple&#x27;,</span><br><span class="line">        url:&#x27;https:<span class="comment">//api.example.com/apple/1&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        id:<span class="number">2</span>,</span><br><span class="line">        name:&#x27;oringe&#x27;,</span><br><span class="line">        url:&#x27;https:<span class="comment">//api.example.com/oringe/1&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>url字典本身就是我们附加上去的,方便客户跳转</p>
</blockquote>
</li>
</ol>
<hr>
<h1 id="Django-rest-framework框架"><a href="#Django-rest-framework框架" class="headerlink" title="Django rest framework框架"></a>Django rest framework框架</h1><p>安装:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install djangorestframework</span><br></pre></td></tr></table></figure>



<h2 id="使用认证和源码执行流程"><a href="#使用认证和源码执行流程" class="headerlink" title="使用认证和源码执行流程"></a>使用认证和源码执行流程</h2><p>使用framework就不要继承<code>from django.views import View</code>了.需要继承APIView</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;获取订单&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;创建订单&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;更新订单&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;删除订单&#x27;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意,APIView也有<code>dispatch()</code>方法,并且在这个方法里添加了新的功能,其中包括添加了<strong>处理了原生的request</strong>,也就是说,==APIView返回的request是丰富了新功能的request==</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部分源码</span></span><br><span class="line"><span class="comment"># 1.APIView的dispatch控制了并不同请求方法会反射到不同的函数中,但是同时还调用initialize_request方法,处理了request对象,丰富了新功能</span></span><br><span class="line"><span class="comment"># 而且还调用了inital方法</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">APIView</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatch</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="comment"># 注意1</span></span><br><span class="line">        request = self.initialize_request(request,*args,**kwargs)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 注意2</span></span><br><span class="line">            self.inital(request,*args,**kwargs)</span><br><span class="line">            ...</span><br><span class="line">            </span><br><span class="line"></span><br><span class="line"> <span class="comment"># 2.丰富request功能</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize_request</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> Request(reqeust,</span><br><span class="line">                    parsers=self.get_parses(),</span><br><span class="line">                    <span class="comment"># 验证相关</span></span><br><span class="line">                    <span class="comment"># 所以我们可以通过request.authenticators获取认证类的列表了</span></span><br><span class="line">                    authenticators=self.get_authenticators(),</span><br><span class="line">                    negotiator=self.get_content_negotiator,</span><br><span class="line">                    parser_context=parser_context)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.request的authenticators属性是一个认证类实例的列表</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_authenticators</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="keyword">return</span> [auth() <span class="keyword">for</span> auth <span class="keyword">in</span> self.authentication_class]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 看一下authentication_class是什么</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">APIView</span>(<span class="params">View</span>):</span></span><br><span class="line">    authentication_class = api_settings.DEFAULT_AUTHENTICATION_CALSSES</span><br><span class="line">    </span><br><span class="line"><span class="comment">###################################################################</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 5. 看一下self.inital(request,*args,**kwargs)函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initial</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">    ...</span><br><span class="line">    self.perform_authentication(request)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 6. 看一下self.perform_authentication(request)函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span>  <span class="title">perform_authentication</span>(<span class="params">self,request</span>):</span></span><br><span class="line">    request.user</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. 看一下request.user</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span>:</span></span><br><span class="line">    ...</span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">user</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(self,<span class="string">&#x27;_user&#x27;</span>):</span><br><span class="line">            <span class="keyword">with</span> wrap_attributeerrors():</span><br><span class="line">                <span class="comment"># 在获取属性的时候调用_authenticate方法</span></span><br><span class="line">                self._authenticate()</span><br><span class="line">            <span class="keyword">return</span> self._user</span><br><span class="line"></span><br><span class="line"><span class="comment"># 8. 看一下_authenticate()方法</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_authenticate</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="comment"># 调用了authenticators属性</span></span><br><span class="line">    <span class="keyword">for</span> authenticator <span class="keyword">in</span> self.authenticators:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 调用authenticate方法</span></span><br><span class="line">            user_auth_tuple = authenticator.authenticate(self)</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>总结 : APIView的一般认证过程</p>
<p>rest框架的AIPView类的dispatch函数,比起原生的View类的dispatch函数多做了两件事:</p>
<ul>
<li>添加了<code>authenticators</code>属性,这个属性是一个认证类实例组成的列表</li>
<li>调用了<code>inital</code>方法,这个方法<strong>最终</strong>会获取<code>authenticators</code>属性,然后对里面每个认证类实例进行一步步的认证</li>
</ul>
<p>复杂流程:</p>
<p>一方面:</p>
<ol>
<li>dispatch函数调用initialize_request方法</li>
<li>initialize_request方法给request添加一个authenticators属性 ,值为get_authenticators()方法的返回值</li>
<li>get_authenticators方法调用<code>authentication_class</code>属性,将实例化里面的元素</li>
</ol>
<p>另一方面:</p>
<ol>
<li>dispatch函数调用initial函数</li>
<li>initial函数调用perform_authentication函数</li>
<li>perform_authentication函数获取request.user属性</li>
<li>获取request.user属性时调用_authenticate方法</li>
<li>authenticate方法调用<code>authenticators</code>属性和authenticate方法</li>
</ol>
</blockquote>
<blockquote>
<p>现在我们自己写一个<code>authentication_class</code>实例,就能修改request里的authenticators属性了,并且重写<code>authenticate</code>,从而进行<strong>自定义认证</strong>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView,exceptions</span><br><span class="line"></span><br><span class="line"><span class="comment"># MyAuthentication需要实现两个方法authenticate,authenticate_header</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyAuthentication</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        <span class="comment"># request._request : 原生的request</span></span><br><span class="line">        token = request._request.GET.get(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> token:</span><br><span class="line">            <span class="keyword">raise</span> exceptions.AuthenticationFailed(<span class="string">&#x27;用户认证失败&#x27;</span>)</span><br><span class="line">        <span class="comment"># 第一个参数是user</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="string">&#x27;alex&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate_header</span>(<span class="params">self,val</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="comment"># 修改authentication_classes</span></span><br><span class="line">    authentication_classes = [MyAuthentication,]</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;获取订单&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;创建订单&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;更新订单&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;删除订单&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>此时</p>
<ul>
<li>输入<code>http://127.0.0.1:8000/order/</code>将返回<code>用户认证失败</code></li>
<li>输入<code>http://127.0.0.1:8000/order/?token=456</code>将返回<code>获取订单</code></li>
</ul>
</blockquote>
<p>Django请求生命周期</p>
<ol>
<li><p>wsgi ,请求封装后交给web框架（Flask，Django)</p>
</li>
<li><p>中间件，对请求进行校验或在请求对象中添加其他相关数据，例如：csrf,request.session</p>
</li>
<li><p>路由匹配 根据浏览器发送的不同url去匹配不同的视图函数</p>
</li>
<li><p>视图函数，在视图函数中进行业务逻辑的处理，可能涉及到：orm，templates </p>
<blockquote>
<p>如果视图是类的话,还要经过<code>dispatch()</code>方法</p>
</blockquote>
</li>
<li><p>中间件，对响应的数据进行处理</p>
</li>
<li><p>wsgi，将响应的内容发送给浏览器</p>
</li>
</ol>
<blockquote>
<p>所以说rest framework就是操作<code>dispatch()</code>方法</p>
</blockquote>
<h2 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h2><h3 id="自定义认证"><a href="#自定义认证" class="headerlink" title="自定义认证"></a>自定义认证</h3><p>有些API需要用户登录成功之后，才能访问；有些无需登录就能访问。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># models.py</span></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    user_type_chioces = (</span><br><span class="line">        (<span class="number">1</span>,<span class="string">&#x27;普通用户&#x27;</span>),  </span><br><span class="line">        (<span class="number">2</span>,<span class="string">&#x27;VIP&#x27;</span>),  </span><br><span class="line">        (<span class="number">3</span>,<span class="string">&#x27;SVIP&#x27;</span>),  </span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    user_type = models.IntegerField(choices=user_type_chioces)</span><br><span class="line">    username = models.CharField(max_length=<span class="number">32</span>,unique=<span class="literal">True</span>)</span><br><span class="line">    password = models.CharField(max_length=<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserToken</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    user = models.OneToOneField(<span class="string">&#x27;UserInfo&#x27;</span>)</span><br><span class="line">    token = models.CharField(max_length=<span class="number">64</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># urls.py</span></span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r&#x27;api/v1/auth/$&#x27;</span>,views.AuthView.as_view(),name=<span class="string">&#x27;auth&#x27;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render,HttpResponse</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView,exceptions</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserInfo,UserToken</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span>(<span class="params">user</span>):</span></span><br><span class="line">    ctime = <span class="built_in">str</span>(time.time())</span><br><span class="line">    m = hashlib.md5(<span class="built_in">bytes</span>(user,encoding=<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    m.update(<span class="built_in">bytes</span>(ctime,encoding=<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> m.hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        ret = &#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">1000</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="literal">None</span>&#125;</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            user = request._request.POST.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">            pwd  = request._request.POST.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">            obj = UserInfo.objects.<span class="built_in">filter</span>(username=user,password=pwd).first()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> obj:</span><br><span class="line">                ret[<span class="string">&#x27;code&#x27;</span>] = <span class="number">1001</span></span><br><span class="line">                ret[<span class="string">&#x27;msg&#x27;</span>] = <span class="string">&#x27;用户名或密码错误&#x27;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 为登录用户创建token</span></span><br><span class="line">            token = md5(user)</span><br><span class="line">            UserToken.objects.update_or_create(user=obj,defaults=&#123;<span class="string">&#x27;token&#x27;</span>:token&#125;)</span><br><span class="line">            <span class="comment"># 设置token</span></span><br><span class="line">            ret[<span class="string">&#x27;token&#x27;</span>] = token</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            ret[<span class="string">&#x27;code&#x27;</span>] = <span class="number">1002</span></span><br><span class="line">            ret[<span class="string">&#x27;msg&#x27;</span>] = <span class="string">&#x27;请求异常&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(ret)</span><br></pre></td></tr></table></figure>

<p>使用token限制访问:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># urls.py</span></span><br><span class="line">url(<span class="string">r&#x27;api/v1/order/$&#x27;</span>,views.OrderView.as_view(),name=<span class="string">&#x27;order&#x27;</span>),</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView,exceptions</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> exceptions</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ORDER_DICT = &#123;</span><br><span class="line">    <span class="number">1</span>:&#123;</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;apple&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;color&#x27;</span>:<span class="string">&#x27;red&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;cost&#x27;</span>:<span class="number">12</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="number">2</span>:&#123;</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;orange&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;color&#x27;</span>:<span class="string">&#x27;orange&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;cost&#x27;</span>:<span class="number">18</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Authtication</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        token = request._request.GET.get(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">        token_obj = UserToken.objects.<span class="built_in">filter</span>(token=token).first()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> token_obj:</span><br><span class="line">            <span class="keyword">raise</span> exceptions.AuthenticationFailed(<span class="string">&#x27;用户认证失败&#x27;</span>)</span><br><span class="line">        <span class="comment"># 在rest framework内部会将这两个字段赋值给request,以供后续操作使用</span></span><br><span class="line">        <span class="comment"># 这两个参数分别为request.user和request.auth</span></span><br><span class="line">        <span class="keyword">return</span> (token_obj.user,token_obj)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate_header</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    authentication_classes = [Authtication,]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        ret = &#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">1000</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="literal">None</span>,<span class="string">&#x27;date&#x27;</span>:<span class="literal">None</span>&#125;</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            ret[<span class="string">&#x27;date&#x27;</span>] = ORDER_DICT</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(ret)</span><br></pre></td></tr></table></figure>

<p>此时</p>
<ul>
<li>如果访问<code>http://127.0.0.1:8000/api/v1/order/</code>就会返回<code>&quot;detail&quot;: &quot;用户认证失败&quot;</code></li>
<li>如果添加token,访问<code>http://127.0.0.1:8000/api/v1/order/?token=726b7a47da65c3e9f7f4c736289202e2</code>就会返回正确值了</li>
</ul>
<blockquote>
<p>一般来说,我们都会把Authtication这个类放在utils.py里面</p>
</blockquote>
<h3 id="设置全局认证"><a href="#设置全局认证" class="headerlink" title="设置全局认证"></a>设置全局认证</h3><p>回过头来看默认的<code>authentication_classes</code>,默认值为<code>DEFAULT_AUTHENTICATION_CLASSES</code>,这个值其实是可以在<code>settings.py</code>设置的,因此:</p>
<blockquote>
<p>我们在<code>settings.py</code>里设置认证类,这样就可以<strong>全局应用这个认证类</strong>了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># settings.py</span></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_AUTHENTICATION_CLASSES&#x27;</span>:[<span class="string">&#x27;blog.utils.auth.Authtication&#x27;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog.utils.auth.py</span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> exceptions</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ..models <span class="keyword">import</span> UserInfo,UserToken</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span>(<span class="params">user</span>):</span></span><br><span class="line">    ctime = <span class="built_in">str</span>(time.time())</span><br><span class="line">    m = hashlib.md5(<span class="built_in">bytes</span>(user,encoding=<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    m.update(<span class="built_in">bytes</span>(ctime,encoding=<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> m.hexdigest()</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Authtication</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        token = request._request.GET.get(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">        token_obj = UserToken.objects.<span class="built_in">filter</span>(token=token).first()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> token_obj:</span><br><span class="line">            <span class="keyword">raise</span> exceptions.AuthenticationFailed(<span class="string">&#x27;用户认证失败&#x27;</span>)</span><br><span class="line">        <span class="comment"># 在rest framework内部会将这两个字段赋值给request,以供后续操作使用</span></span><br><span class="line">        <span class="comment"># 这两个参数分别为request.user和request.auth</span></span><br><span class="line">        <span class="keyword">return</span> (token_obj.user,token_obj)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate_header</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserInfo,UserToken</span><br><span class="line"><span class="keyword">from</span> .utils.auth <span class="keyword">import</span> Authtication</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="comment"># 已经在settings.py里面定义过了,不必在这里定义了</span></span><br><span class="line">    <span class="comment"># authentication_classes = [Authtication,]</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        ret = &#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">1000</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="literal">None</span>,<span class="string">&#x27;date&#x27;</span>:<span class="literal">None</span>&#125;</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            ret[<span class="string">&#x27;date&#x27;</span>] = ORDER_DICT</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(ret)</span><br></pre></td></tr></table></figure>

<p>注意 : <strong>authentication_classes已经在settings.py里面定义过了,不必在CBV里面定义了</strong></p>
<p>如果要部分类免除这个认证类,我们可以直接添加<code>authentication_classes = []</code>即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="comment"># 添加空列表</span></span><br><span class="line">    authentication_classes = []</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
</blockquote>
<p>所以,现在我们就知道了认证类的<code>局部使用</code>和<code>全局使用</code></p>
<p>同理,我们还可以设置<code>UNAUTHENTICATED_USER</code>和<code>UNAUTHENTICATED_TOKEN</code>.也就是<code>request.user</code>和<code>request.auth</code>的值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># settings.py</span></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_AUTHENTICATION_CLASSES&#x27;</span>:[<span class="string">&#x27;blog.utils.auth.Authtication&#x27;</span>]</span><br><span class="line">    <span class="comment"># 当验证不通过时,request.user的值</span></span><br><span class="line">    <span class="string">&#x27;UNAUTHENTICATED_USER&#x27;</span> : <span class="keyword">lambda</span> : <span class="string">&#x27;匿名用户&#x27;</span>,</span><br><span class="line">    <span class="comment"># 当验证不通过时,request.auth的值</span></span><br><span class="line">    <span class="string">&#x27;UNAUTHENTICATED_TOKEN&#x27;</span> :<span class="literal">None</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="全局参数"><a href="#全局参数" class="headerlink" title="全局参数"></a>全局参数</h3><ul>
<li><code>UNAUTHENTICATED_USER</code> : 当验证不通过时,request.user的值</li>
<li><code>UNAUTHENTICATED_TOKEN</code> : 当验证不通过时,request.auth的值</li>
</ul>
<h3 id="内置的认证类"><a href="#内置的认证类" class="headerlink" title="内置的认证类"></a>内置的认证类</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> BaseAuthentication</span><br></pre></td></tr></table></figure>

<ul>
<li><p>BaseAuthentication :<br>基础类，就<strong>定义</strong>了<code>authenticate()</code>和<code>authenticate_header()</code>两个类</p>
<blockquote>
<p>我们之前的认证类为 :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Authtication</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        token = request._request.GET.get(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">        token_obj = UserToken.objects.<span class="built_in">filter</span>(token=token).first()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> token_obj:</span><br><span class="line">            <span class="keyword">raise</span> exceptions.AuthenticationFailed(<span class="string">&#x27;用户认证失败&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> (token_obj.user,token_obj)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate_header</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>现在我们继承<code>BaseAuthentication</code>就可以不必写<code>authenticate_header()</code>了:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Authtication</span>(<span class="params">BaseAuthentication</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        token = request._request.GET.get(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">        token_obj = UserToken.objects.<span class="built_in">filter</span>(token=token).first()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> token_obj:</span><br><span class="line">            <span class="keyword">raise</span> exceptions.AuthenticationFailed(<span class="string">&#x27;用户认证失败&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> (token_obj.user,token_obj)</span><br></pre></td></tr></table></figure>

<p><code>authenticate_header()</code> : 用于处理当认证失败的时候返回给浏览器的响应头</p>
</blockquote>
</li>
<li><p>BasicAuthentication</p>
</li>
<li><p>SeessionAuthentication</p>
</li>
<li><p>TokenAuthentication</p>
</li>
<li><p>RemoteUserAuthentication</p>
</li>
</ul>
<h3 id="源码流程"><a href="#源码流程" class="headerlink" title="源码流程"></a>源码流程</h3><p><img src="/images/django_rest_framework%E8%AE%A4%E8%AF%81%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B.jpg" alt="django_rest_framework认证源码流程"></p>
<h3 id="实现流程"><a href="#实现流程" class="headerlink" title="实现流程"></a>实现流程</h3><ol>
<li>创建类,继承<code>BaseAithentication</code>,实现<code>authenticate()</code>方法</li>
<li>返回值:<ul>
<li>None : 不做处理,执行下一个认证</li>
<li>raise exception.AuthenticationFailed(‘用户认证失败’)</li>
<li>(元素1,元素2) : 元素1赋值给request.user , 元素2赋值给request.auth</li>
</ul>
</li>
</ol>
<h2 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h2><p>有些用户不能查看某些视图</p>
<h3 id="源码流程-1"><a href="#源码流程-1" class="headerlink" title="源码流程"></a>源码流程</h3><p><img src="/images/django_rest_framework%E6%9D%83%E9%99%90%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B.jpg" alt="django_rest_framework权限源码流程"></p>
<h3 id="自定义权限"><a href="#自定义权限" class="headerlink" title="自定义权限"></a>自定义权限</h3><blockquote>
<p>以前我们的做法是:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 直接判断request.user.user_type</span></span><br><span class="line">        <span class="keyword">if</span> request.user.user_type != <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;无权访问&#x27;</span>)</span><br><span class="line">        ret = &#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">1000</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="literal">None</span>,<span class="string">&#x27;date&#x27;</span>:<span class="literal">None</span>&#125;</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            ret[<span class="string">&#x27;date&#x27;</span>] = ORDER_DICT</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(ret)</span><br></pre></td></tr></table></figure>

<p>上面的做法比较硬编码,现在我们可以仿照上面的<code>认证</code>操作,修改<code>permission_classes</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># utils.peimission.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Permission</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">has_permission</span>(<span class="params">self,request,view</span>):</span></span><br><span class="line">        <span class="keyword">if</span> request.user.user_type != <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="keyword">from</span> .utils.permisson <span class="keyword">import</span> Permission</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="comment"># 添加一个permission_classes: 控制权限的类 组成的列表</span></span><br><span class="line">    permission_classes = [Permission,]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        ret = &#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">1000</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="literal">None</span>,<span class="string">&#x27;date&#x27;</span>:<span class="literal">None</span>&#125;</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            ret[<span class="string">&#x27;date&#x27;</span>] = ORDER_DICT</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(ret)</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="全局和局部权限"><a href="#全局和局部权限" class="headerlink" title="全局和局部权限"></a>全局和局部权限</h3><p>因此,我们也可以使用全局和局部权限</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># setttings.py</span></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_PERMISSION_CLASSES&#x27;</span> : [<span class="string">&#x27;blog.utils.permission.SVIPPermission&#x27;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog.utils.permission.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SVIPPermission</span>:</span></span><br><span class="line">    <span class="comment"># 使用messag控制拒绝访问返回的message</span></span><br><span class="line">    message = <span class="string">&#x27;必须是SVIP才能访问&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">has_permission</span>(<span class="params">self,request,view</span>):</span></span><br><span class="line">        <span class="keyword">if</span> request.user.user_type != <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>



<h3 id="全局参数-1"><a href="#全局参数-1" class="headerlink" title="全局参数"></a>全局参数</h3><p>无</p>
<h3 id="内置权限类"><a href="#内置权限类" class="headerlink" title="内置权限类"></a>内置权限类</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> BasePermission</span><br></pre></td></tr></table></figure>

<ul>
<li>BasePermission</li>
<li>AllowAny</li>
<li>IsAuthenticated</li>
<li>isAdminUser</li>
<li>IsAuthenticatedOrReadOnly等等</li>
</ul>
<h3 id="实现流程-1"><a href="#实现流程-1" class="headerlink" title="实现流程"></a>实现流程</h3><ol>
<li>创建类,继承<code>BasePermission</code>,实现<code>has_permission()</code>方法</li>
<li>返回值:<ul>
<li>True</li>
<li>False</li>
</ul>
</li>
</ol>
<h2 id="节流-访问频率控制"><a href="#节流-访问频率控制" class="headerlink" title="节流(访问频率控制)"></a>节流(访问频率控制)</h2><h3 id="源码流程-2"><a href="#源码流程-2" class="headerlink" title="源码流程"></a>源码流程</h3><p><img src="/images/django_rest_framework%E9%98%88%E5%80%BC%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B.jpg" alt="django_rest_framework阈值源码流程"></p>
<h3 id="自定义阈值"><a href="#自定义阈值" class="headerlink" title="自定义阈值"></a>自定义阈值</h3><p>如法炮制:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># utils.throlle.py</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.throttling <span class="keyword">import</span> BaseThrottle</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VisitThrottle</span>(<span class="params">BaseThrottle</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">allow_request</span>(<span class="params">self,request,view</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    throttle_classes = [VisitThrottle,]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        ret = &#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">1000</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="literal">None</span>,<span class="string">&#x27;date&#x27;</span>:<span class="literal">None</span>&#125;</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            ret[<span class="string">&#x27;date&#x27;</span>] = ORDER_DICT</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(ret)</span><br></pre></td></tr></table></figure>

<p>每个IP每10秒限制3次访问:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> rest_framework.throttling <span class="keyword">import</span> BaseThrottle</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VISIT_RECORD = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VisitThrottle</span>(<span class="params">BaseThrottle</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.history = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">allow_request</span>(<span class="params">self,request,view</span>):</span></span><br><span class="line">        <span class="comment"># 获取用户IP</span></span><br><span class="line">        remote_addr = request.META.get(<span class="string">&#x27;REMOTE_ADDR&#x27;</span>)</span><br><span class="line">        ctime = time.time()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> remote_addr <span class="keyword">not</span> <span class="keyword">in</span> VISIT_RECORD:</span><br><span class="line">            VISIT_RECORD[remote_addr] = [ctime,]</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        self.history = VISIT_RECORD.get(remote_addr)</span><br><span class="line">        <span class="keyword">while</span> self.history <span class="keyword">and</span> self.history[-<span class="number">1</span>] &lt; ctime - <span class="number">10</span>:</span><br><span class="line">            self.history.pop()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.history) &lt; <span class="number">3</span>:</span><br><span class="line">            self.history.insert(<span class="number">0</span>,ctime)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 还需要等待多少秒后,才能访问</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">10</span> - (time.time() - self.history[-<span class="number">1</span>])</span><br></pre></td></tr></table></figure>



<h3 id="全局和局部阈值"><a href="#全局和局部阈值" class="headerlink" title="全局和局部阈值"></a>全局和局部阈值</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># settings.py</span></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_CLASSES&#x27;</span> : [<span class="string">&#x27;blog.utils.throttle.VisitThrottle&#x27;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        ret = &#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">1000</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="literal">None</span>,<span class="string">&#x27;date&#x27;</span>:<span class="literal">None</span>&#125;</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            ret[<span class="string">&#x27;date&#x27;</span>] = ORDER_DICT</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(ret)</span><br></pre></td></tr></table></figure>



<h3 id="内置阈值类"><a href="#内置阈值类" class="headerlink" title="内置阈值类"></a>内置阈值类</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> BaseThrottle</span><br></pre></td></tr></table></figure>

<ul>
<li>BaseThrottle</li>
<li>SimpleRateThrottle(常用)</li>
</ul>
<p>就像前面Permission可以使用message一样,阈值类可以定义一个<code>DEFAULT_THROTTLE_RATES</code></p>
<p>前面的代码就可以修改为:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># utils.throttle.py</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> rest_framework.throttling <span class="keyword">import</span> BaseThrottle,SimpleRateThrottle</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VisitThrottle</span>(<span class="params">SimpleRateThrottle</span>):</span></span><br><span class="line">    scope = <span class="string">&#x27;visit_limit&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 放进缓存里的key,这里取ip值</span></span><br><span class="line">    <span class="comment"># 也可以使用用户名作为存缓的key</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_cache_key</span>(<span class="params">self,request,view</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.get_ident(request)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># settins.py</span></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_CLASSES&#x27;</span> : [<span class="string">&#x27;blog.utils.throttle.VisitThrottle&#x27;</span>],</span><br><span class="line">    <span class="comment"># 限制频率 : 每分钟3次</span></span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_RATES&#x27;</span> : &#123;<span class="string">&#x27;visit_limit&#x27;</span>:<span class="string">&#x27;3/m&#x27;</span>&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="全局参数-2"><a href="#全局参数-2" class="headerlink" title="全局参数"></a>全局参数</h3><p><code>DEFAULT_THROTTLE_RATES</code> : 限制频率 </p>
<h3 id="实现流程-2"><a href="#实现流程-2" class="headerlink" title="实现流程"></a>实现流程</h3><ol>
<li>创建类<ul>
<li>继承<code>BaseThrottle</code>,实现<code>allow_reques()</code>方法和<code>wait()</code>方法.</li>
<li>继承<code>SimpleRateThrottle</code>,实现<code>get_cache_key()</code>方法和<code>scope</code>类属性(settings.py中哦key)</li>
</ul>
</li>
<li>返回值:<ul>
<li>True</li>
<li>False</li>
</ul>
</li>
</ol>
<h2 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h2><h3 id="源码流程-3"><a href="#源码流程-3" class="headerlink" title="源码流程"></a>源码流程</h3><p><img src="/images/django_rest_framework%E7%89%88%E6%9C%AC%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B.jpg" alt="：django_rest_framework版本源码流程"></p>
<h3 id="自定义版本控制-通过url的version参数传参"><a href="#自定义版本控制-通过url的version参数传参" class="headerlink" title="自定义版本控制(通过url的version参数传参)"></a>自定义版本控制(通过url的version参数传参)</h3><p>如法炮制:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># urls.py</span></span><br><span class="line">url(<span class="string">r&#x27;api/(?P&lt;version&gt;[v1|v2]+)/user/$&#x27;</span>,views.UserView.as_view(),name=<span class="string">&#x27;user&#x27;</span>),</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># utils.version.py</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.versioning <span class="keyword">import</span> BaseVersioning</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParamVersion</span>(<span class="params">BaseVersioning</span>):</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">determine_version</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">		version = request.query_params.get(<span class="string">&#x27;version&#x27;</span>)</span><br><span class="line">		<span class="keyword">return</span> version</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="keyword">from</span> .utils.version <span class="keyword">import</span> ParamVersion</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="comment"># 注意:因为板块只要控制一个就行了,所以不是versioning_classes,也不用使用列表</span></span><br><span class="line">    versioning_class = ParamVersion</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 使用ParamVersion后,直接将version信息添加到request的version属性中</span></span><br><span class="line">        x = request.version</span><br><span class="line">        <span class="comment"># 处理版本的对象</span></span><br><span class="line">        y = request.versioning_scheme</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="built_in">str</span>(x))</span><br></pre></td></tr></table></figure>



<h3 id="内置版本类"><a href="#内置版本类" class="headerlink" title="内置版本类"></a>内置版本类</h3><ul>
<li>BaseVersioning</li>
<li>AcceptHeaderVersioning</li>
<li>URLPathVersioning</li>
<li>NamespaceVersioning</li>
<li>HostNameVersioning</li>
<li>QueryParameterVersioning</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.versioning <span class="keyword">import</span> QueryParameterVersioning</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    versioning_class = QueryParameterVersioning</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        x = request.version</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="built_in">str</span>(x))</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_VERSION&#x27;</span>  : <span class="string">&#x27;v1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ALLOWED_VERSIONS&#x27;</span> : [<span class="string">&#x27;v1&#x27;</span>,<span class="string">&#x27;v2&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;VERSION_PARAM&#x27;</span>    : <span class="string">&#x27;version&#x27;</span>,</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>



<h3 id="全局参数-3"><a href="#全局参数-3" class="headerlink" title="全局参数"></a>全局参数</h3><ul>
<li><code>DEFAULT_VERSION</code> : 默认版本(url参数中如果没有该参数则使用的版本)</li>
<li><code>ALLOWED_VERSIONS</code> : 允许的版本列表</li>
<li><code>VERSION_PARAM</code> : URL参数中表示版本的参数</li>
</ul>
<h3 id="自定义版本控制-通过url路径传参-及全局使用"><a href="#自定义版本控制-通过url路径传参-及全局使用" class="headerlink" title="自定义版本控制(通过url路径传参)及全局使用"></a>自定义版本控制(通过url路径传参)及全局使用</h3><p>使用内置类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># urls.py</span></span><br><span class="line"><span class="comment"># 在url里捕获版本</span></span><br><span class="line">url(<span class="string">r&#x27;api/(?P&lt;version&gt;[v1|v2]+)/user/$&#x27;</span>,views.UserView.as_view(),name=<span class="string">&#x27;user&#x27;</span>),</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># settings.py</span></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="comment"># 直接使用内置的URLPathVersioning类</span></span><br><span class="line">    <span class="string">&#x27;DEFAULT_VERSIONING_CLASS&#x27;</span> : <span class="string">&#x27;rest_framework.versioning.URLPathVersioning&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;DEFAULT_VERSION&#x27;</span>  : <span class="string">&#x27;v1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ALLOWED_VERSIONS&#x27;</span> : [<span class="string">&#x27;v1&#x27;</span>,<span class="string">&#x27;v2&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;VERSION_PARAM&#x27;</span>    : <span class="string">&#x27;version&#x27;</span>,</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        x = request.version</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="built_in">str</span>(x))</span><br></pre></td></tr></table></figure>



<h3 id="实现流程-3"><a href="#实现流程-3" class="headerlink" title="实现流程"></a>实现流程</h3><blockquote>
<p>使用配置文件 :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_VERSIONING_CLASS&#x27;</span> : <span class="string">&#x27;rest_framework.versioning.URLPathVersioning&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;DEFAULT_VERSION&#x27;</span>  : <span class="string">&#x27;v1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ALLOWED_VERSIONS&#x27;</span> : [<span class="string">&#x27;v1&#x27;</span>,<span class="string">&#x27;v2&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;VERSION_PARAM&#x27;</span>    : <span class="string">&#x27;version&#x27;</span>,</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>urls.py :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r&#x27;api/(?P&lt;version&gt;[v1|v2]+)/user/$&#x27;</span>,views.UserView.as_view(),name=<span class="string">&#x27;user&#x27;</span>),</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="解析器"><a href="#解析器" class="headerlink" title="解析器"></a>解析器</h2><p>功能 : 对请求体的数据进行解析</p>
<p>对于request.body有值而request.POST取不到值的情况,我们可以使用rest_framework的解析器了</p>
<h3 id="源码流程-4"><a href="#源码流程-4" class="headerlink" title="源码流程"></a>源码流程</h3><p><code>解析器</code>的源码流程和<code>权限</code>类似</p>
<p><img src="/images/django_rest_framework%E8%A7%A3%E6%9E%90%E5%99%A8%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B.jpg" alt="django_rest_framework解析器源码流程"></p>
<p>简单来说就是</p>
<ol>
<li>在dispatch将各种解析器封装到request中</li>
<li>当我们想要使用数据的时候<code>request.data</code>触发<code>self._load_data_and_files()</code>,</li>
<li>然后使用<code>反射</code>找到合适的解析器类,</li>
<li>最后触发解析器类的parse()方法去解析数据</li>
</ol>
<blockquote>
<p>本质: 根据请求头中的<code>Content_Type</code>去找到合适的解析器类</p>
</blockquote>
<h3 id="自定义解析器"><a href="#自定义解析器" class="headerlink" title="自定义解析器"></a>自定义解析器</h3><p>做法和前面的一模一样</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># urls.py</span></span><br><span class="line">url(<span class="string">r&#x27;^api/(?P&lt;version&gt;[v1|v2]+)/user/$&#x27;</span>,views.UserView.as_view(),name=<span class="string">&#x27;user&#x27;</span>),</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.parsers <span class="keyword">import</span> JSONParser</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="comment"># 只能解析请求头为 application/json的数据</span></span><br><span class="line">    parser_classes = [JSONParser,]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 获取解析后的结果</span></span><br><span class="line">        <span class="built_in">print</span>(request.data)</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;hyl&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>JSONParser : 解析application/json的数据</li>
<li>FormParse : 解析application/x-www-form-urlencoded的数据</li>
</ul>
<p>联合使用:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.parsers <span class="keyword">import</span> JSONParser,FormParser</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    parser_classes = [JSONParser,FormParser,]</span><br></pre></td></tr></table></figure>



<h3 id="全局使用"><a href="#全局使用" class="headerlink" title="全局使用"></a>全局使用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># settings.py</span></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line"><span class="string">&#x27;DEFAULT_PARSER_CLASS&#x27;</span> : [<span class="string">&#x27;rest_framework.parsers.JSONParser&#x27;</span>,<span class="string">&#x27;rest_framework.parsers.FormParser&#x27;</span>]</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 获取解析后的结果</span></span><br><span class="line">        <span class="built_in">print</span>(request.data)</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;hyl&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h3 id="内置解释器类"><a href="#内置解释器类" class="headerlink" title="内置解释器类"></a>内置解释器类</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.parsers <span class="keyword">import</span> JSONParser</span><br></pre></td></tr></table></figure>

<ul>
<li>BaseParser</li>
<li>JSONParser : 解析application/json的数据</li>
<li>FormParser : 解析application/x-www-form-urlencoded的数据</li>
<li>MultiPartParser : 解析multipart/form-data的数据</li>
<li>FileUploadParser :解析 */* 的数据(支持所有数据格式)</li>
</ul>
<h3 id="实现流程-4"><a href="#实现流程-4" class="headerlink" title="实现流程"></a>实现流程</h3><p>直接使用内置解析器类即可:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_PARSER_CLASS&#x27;</span> : [<span class="string">&#x27;rest_framework.parsers.JSONParser&#x27;</span>,<span class="string">&#x27;rest_framework.parsers.FormParser&#x27;</span>]</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>



<h2 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h2><h3 id="1-对请求数据进行校验"><a href="#1-对请求数据进行校验" class="headerlink" title="1. 对请求数据进行校验"></a>1. 对请求数据进行校验</h3><h4 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h4><p>这个操作和form简直一模一样</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># utils.serializer.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfoSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">	name = serializers.CharField(error_messages=&#123;<span class="string">&#x27;required&#x27;</span>:<span class="string">&#x27;标题不能为空&#x27;</span>&#125;)</span><br><span class="line">	age = serializers.IntegerField()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        ser = UserInfoSerializer(data=request.data)</span><br><span class="line">        <span class="keyword">if</span> ser.is_valid():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;------------&#x27;</span>,ser.validated_data)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;------------&#x27;</span>,ser.errors)</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;******&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h4 id="自定义规则"><a href="#自定义规则" class="headerlink" title="自定义规则"></a>自定义规则</h4><p>如果要自定义验证规则:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># utils.serializer.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XXValidator</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,base</span>):</span></span><br><span class="line">		self.base = base</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self,value</span>):</span></span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">not</span> value.startswith(self.base):</span><br><span class="line">			msg = <span class="string">f&#x27;必须以<span class="subst">&#123;self.base&#125;</span>开头&#x27;</span></span><br><span class="line">			<span class="keyword">raise</span> serializers.ValidationError(msg)</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">set_context</span>(<span class="params">self,serializer_field</span>):</span></span><br><span class="line">		<span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfoSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">	name = serializers.CharField(error_messages=&#123;<span class="string">&#x27;required&#x27;</span>:<span class="string">&#x27;标题不能为空&#x27;</span>&#125;,validators=[XXValidator(<span class="string">&#x27;hyl&#x27;</span>)])</span><br><span class="line">	age = serializers.IntegerField()</span><br></pre></td></tr></table></figure>



<h4 id="钩子函数"><a href="#钩子函数" class="headerlink" title="钩子函数"></a>钩子函数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfoSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">	name = serializers.CharField(error_messages=&#123;<span class="string">&#x27;required&#x27;</span>:<span class="string">&#x27;标题不能为空&#x27;</span>&#125;)</span><br><span class="line">	age = serializers.IntegerField()</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 验证name的钩子函数</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">validate_name</span>(<span class="params">self,value</span>):</span> <span class="comment"># 验证的字段值</span></span><br><span class="line">		<span class="keyword">if</span> value.startswith(<span class="string">&quot;w&quot;</span>):</span><br><span class="line">			<span class="keyword">raise</span> serializers.ValidationError(<span class="string">&#x27;name字段不能以w开头&#x27;</span>)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			<span class="keyword">return</span> value <span class="comment">#注意通过验证，必须返回其值</span></span><br></pre></td></tr></table></figure>



<h3 id="2-对QuerySet进行序列化"><a href="#2-对QuerySet进行序列化" class="headerlink" title="2. 对QuerySet进行序列化"></a>2. 对QuerySet进行序列化</h3><h4 id="简单使用-1"><a href="#简单使用-1" class="headerlink" title="简单使用"></a>简单使用</h4><p>我们正常使用JSON:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RoleView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 使用values将QuerySet序列化成字典</span></span><br><span class="line">        roles = <span class="built_in">list</span>(Role.objects.<span class="built_in">all</span>().values(<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;title&#x27;</span>))</span><br><span class="line">        <span class="comment"># 转为JSON数据类型</span></span><br><span class="line">        res = json.dumps(roles,ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(res)</span><br><span class="line"></span><br><span class="line"><span class="comment"># [&#123;&quot;id&quot;: 1, &quot;title&quot;: &quot;医生&quot;&#125;, &#123;&quot;id&quot;: 2, &quot;title&quot;: &quot;护士&quot;&#125;, &#123;&quot;id&quot;: 3, &quot;title&quot;: &quot;老师&quot;&#125;]</span></span><br></pre></td></tr></table></figure>

<p>现在使用serializers:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># models.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    user_type_chioces = (</span><br><span class="line">        (<span class="number">1</span>,<span class="string">&#x27;普通用户&#x27;</span>),  </span><br><span class="line">        (<span class="number">2</span>,<span class="string">&#x27;VIP&#x27;</span>),  </span><br><span class="line">        (<span class="number">3</span>,<span class="string">&#x27;SVIP&#x27;</span>),  </span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    user_type = models.IntegerField(choices=user_type_chioces)</span><br><span class="line">    username = models.CharField(max_length=<span class="number">32</span>,unique=<span class="literal">True</span>)</span><br><span class="line">    password = models.CharField(max_length=<span class="number">64</span>)</span><br><span class="line">    </span><br><span class="line">    group = models.ForeignKey(<span class="string">&#x27;UserGroup&#x27;</span>)</span><br><span class="line">    roles = models.ManyToManyField(<span class="string">&#x27;Role&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Role</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserGroup</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">   </span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># utils.serializer.py</span></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RolesSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">	<span class="built_in">id</span> = serializers.IntegerField()</span><br><span class="line">	title = serializers.CharField()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Views.py</span></span><br><span class="line"><span class="keyword">from</span> .utils.serializer <span class="keyword">import</span> RolesSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RoleView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        roles = Role.objects.<span class="built_in">all</span>().values(<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;title&#x27;</span>)</span><br><span class="line">        <span class="comment"># 有多条数据,所以使用many=True</span></span><br><span class="line">        ser = RolesSerializer(instance=roles,many=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># 使用ser.data获取序列化后的值</span></span><br><span class="line">        res = json.dumps(ser.data,ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(res)</span><br><span class="line"><span class="comment"># # [&#123;&quot;id&quot;: 1, &quot;title&quot;: &quot;医生&quot;&#125;, &#123;&quot;id&quot;: 2, &quot;title&quot;: &quot;护士&quot;&#125;, &#123;&quot;id&quot;: 3, &quot;title&quot;: &quot;老师&quot;&#125;]</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用方法很像<strong>Scrapy中的Item</strong>或者是<strong>Django里的form</strong> : </p>
<p>先定义字段,然后在实例化的时候传入数据就可以了</p>
</blockquote>
<h4 id="source参数"><a href="#source参数" class="headerlink" title="source参数"></a>source参数</h4><blockquote>
<p>注意:RolesSerializer中的字段名必须和models中的字段名一致</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RolesSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">	<span class="built_in">id</span> = serializers.IntegerField()</span><br><span class="line">	title = serializers.CharField()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回值</span></span><br><span class="line"><span class="comment"># [&#123;&quot;id&quot;: 1, &quot;title&quot;: &quot;医生&quot;&#125;, &#123;&quot;id&quot;: 2, &quot;title&quot;: &quot;护士&quot;&#125;, &#123;&quot;id&quot;: 3, &quot;title&quot;: &quot;老师&quot;&#125;]</span></span><br></pre></td></tr></table></figure>

<p>否则要使用<code>source</code>参数:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RolesSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    field1 = serializers.IntegerField(source=<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">    field2 = serializers.CharField(source=<span class="string">&#x27;title&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回值:</span></span><br><span class="line"><span class="comment"># [&#123;&quot;field1&quot;: 1, &quot;field2&quot;: &quot;医生&quot;&#125;, &#123;&quot;field1&quot;: 2, &quot;field2&quot;: &quot;护士&quot;&#125;, &#123;&quot;field1&quot;: 3, &quot;field2&quot;: &quot;老师&quot;&#125;]</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>对于下面的models,如果我们想拿到<code>普通用户</code>而不是<code>1</code>,那么该如何操作:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    user_type_chioces = (</span><br><span class="line">        (<span class="number">1</span>,<span class="string">&#x27;普通用户&#x27;</span>),  </span><br><span class="line">        (<span class="number">2</span>,<span class="string">&#x27;VIP&#x27;</span>),  </span><br><span class="line">        (<span class="number">3</span>,<span class="string">&#x27;SVIP&#x27;</span>),  </span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    user_type = models.IntegerField(choices=user_type_chioces)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>源码分析:</p>
<ol>
<li><p>对于<code>field1 = serializers.IntegerField(source=&#39;id&#39;)</code>,其实是扫描每一行row,然后执行<code>row.source</code>(这里就是row.id)</p>
</li>
<li><p><strong>如果<code>row.source</code>是一个可执行对象,那么就会执行该对象</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 类似于</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">arg</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">callable</span>(arg):</span><br><span class="line">        <span class="keyword">return</span> arg()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> arg</span><br></pre></td></tr></table></figure></li>
<li><p>Django中有一个<code>row.get_XXX_display()</code>方法用于获取display</p>
</li>
<li><p>所以代码如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># utils.serialize.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfoSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">	field1 = serializers.CharField(source=<span class="string">&#x27;user_type&#x27;</span>)</span><br><span class="line">	filed2 = serializers.CharField(source=<span class="string">&#x27;get_user_type_display&#x27;</span>)</span><br><span class="line">	username = serializers.CharField()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="keyword">from</span> .utils.serializer <span class="keyword">import</span> UserInfoSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        users = UserInfo.objects.<span class="built_in">all</span>()</span><br><span class="line">        ser = UserInfoSerializer(instance=users,many=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        res = json.dumps(ser.data,ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(res)</span><br><span class="line"></span><br><span class="line"><span class="comment"># [&#123;&quot;field1&quot;: &quot;1&quot;, &quot;filed2&quot;: &quot;普通用户&quot;, &quot;username&quot;: &quot;hyl&quot;&#125;, </span></span><br><span class="line"><span class="comment"># &#123;&quot;field1&quot;: &quot;2&quot;, &quot;filed2&quot;: &quot;SVIP&quot;, &quot;username&quot;: &quot;dsz&quot;&#125;, </span></span><br><span class="line"><span class="comment"># &#123;&quot;field1&quot;:&quot;4&quot;, &quot;filed2&quot;: &quot;VIP&quot;, &quot;username&quot;: &quot;hhh&quot;&#125;]</span></span><br></pre></td></tr></table></figure></li>
<li><p>同理,对于外键,我们也可以使用<code>source</code>参数:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># utils.serialize.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfoSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    field1 = serializers.CharField(source=<span class="string">&#x27;user_type&#x27;</span>)</span><br><span class="line">    filed2 = serializers.CharField(source=<span class="string">&#x27;get_user_type_display&#x27;</span>)</span><br><span class="line">    username = serializers.CharField()</span><br><span class="line">    <span class="comment"># 直接点号获取外键</span></span><br><span class="line">    group_title = serializers.CharField(source=<span class="string">&#x27;group.title&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># [&#123;&quot;field1&quot;: &quot;1&quot;, &quot;filed2&quot;: &quot;普通用户&quot;, &quot;username&quot;: &quot;hyl&quot;, &quot;group_title&quot;: &quot;group1&quot;&#125;,</span></span><br><span class="line"><span class="comment">#  &#123;&quot;field1&quot;: &quot;1&quot;, &quot;filed2&quot;: &quot;普通用户&quot;,&quot;username&quot;: &quot;dsz&quot;, &quot;group_title&quot;: &quot;group2&quot;&#125;,</span></span><br><span class="line"><span class="comment">#   &#123;&quot;field1&quot;: &quot;1&quot;, &quot;filed2&quot;: &quot;普通用户&quot;, &quot;username&quot;: &quot;hhh&quot;, &quot;group_title&quot;:&quot;group2&quot;&#125;]</span></span><br></pre></td></tr></table></figure></li>
<li><p>对于ManyToMany,也可以使用<code>source</code>参数:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># utils.serialize.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfoSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    field1      = serializers.CharField(source=<span class="string">&#x27;user_type&#x27;</span>)</span><br><span class="line">    filed2      = serializers.CharField(source=<span class="string">&#x27;get_user_type_display&#x27;</span>)</span><br><span class="line">    username    = serializers.CharField()</span><br><span class="line">    group_title = serializers.CharField(source=<span class="string">&#x27;group.title&#x27;</span>)</span><br><span class="line">    roles       = serializers.CharField(source=<span class="string">&#x27;roles.all&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
</ol>
</blockquote>
<h4 id="SericalizerMethodField-自定义显示"><a href="#SericalizerMethodField-自定义显示" class="headerlink" title="SericalizerMethodField()自定义显示"></a>SericalizerMethodField()自定义显示</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># utils.serialize.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfoSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    field1      = serializers.CharField(source=<span class="string">&#x27;user_type&#x27;</span>)</span><br><span class="line">    filed2      = serializers.CharField(source=<span class="string">&#x27;get_user_type_display&#x27;</span>)</span><br><span class="line">    username    = serializers.CharField()</span><br><span class="line">    group_title = serializers.CharField(source=<span class="string">&#x27;group.title&#x27;</span>)</span><br><span class="line">    roles = serializers.SerializerMethodField()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 这里返回什么,roles就是什么</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_roles</span>(<span class="params">self,row</span>):</span></span><br><span class="line">        role_obj_list = row.roles.<span class="built_in">all</span>()</span><br><span class="line">        ret = [&#123;<span class="string">&#x27;id&#x27;</span>:item.<span class="built_in">id</span>,<span class="string">&#x27;title&#x27;</span>:item.title&#125; <span class="keyword">for</span> item <span class="keyword">in</span> role_obj_list]</span><br><span class="line">        <span class="keyword">return</span> ret</span><br></pre></td></tr></table></figure>



<h4 id="内置序列化类"><a href="#内置序列化类" class="headerlink" title="内置序列化类"></a>内置序列化类</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br></pre></td></tr></table></figure>

<ul>
<li>Serializer</li>
<li>ModelSerializer</li>
</ul>
<p><code>ModelSerializer</code>和<code>Serializer</code>的关系,类似于<code>form</code>和<code>ModelForm</code>的关系:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># utils.serialize.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfoSerialier</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    field1 = serializers.CharField(source=<span class="string">&#x27;get_user_type_display&#x27;</span>)</span><br><span class="line">    rls = serializers.SerializerMethodField()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = UserInfo</span><br><span class="line">        <span class="comment"># model = &#x27;__all__&#x27;</span></span><br><span class="line">        fields = [<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;username&#x27;</span>,<span class="string">&#x27;field1&#x27;</span>,<span class="string">&#x27;rls&#x27;</span>,<span class="string">&#x27;group&#x27;</span>]</span><br><span class="line">        <span class="comment"># 获取的深度(默认为0)</span></span><br><span class="line">        depth = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 这里返回什么,roles就是什么</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_roles</span>(<span class="params">self,row</span>):</span></span><br><span class="line">        role_obj_list = row.roles.<span class="built_in">all</span>()</span><br><span class="line">        ret = [&#123;<span class="string">&#x27;id&#x27;</span>:item.<span class="built_in">id</span>,<span class="string">&#x27;title&#x27;</span>:item.title&#125; <span class="keyword">for</span> item <span class="keyword">in</span> role_obj_list]</span><br><span class="line">        <span class="keyword">return</span> ret</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>depth</code>参数说明:</p>
<p>当你获取的字段是外键获取多对多键的时候,depth就是获取外键或多对多键的数据.</p>
<p>eg:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># models.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    user_type_chioces = (</span><br><span class="line">        (<span class="number">1</span>,<span class="string">&#x27;3&#x27;</span>),  </span><br><span class="line">        (<span class="number">2</span>,<span class="string">&#x27;VIP&#x27;</span>),  </span><br><span class="line">        (<span class="number">3</span>,<span class="string">&#x27;SVIP&#x27;</span>),  </span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    user_type = models.IntegerField(choices=user_type_chioces)</span><br><span class="line">    username = models.CharField(max_length=<span class="number">32</span>,unique=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># 外键</span></span><br><span class="line">    group = models.ForeignKey(<span class="string">&#x27;UserGroup&#x27;</span>)</span><br><span class="line">    <span class="comment"># 多对多键</span></span><br><span class="line">    roles = models.ManyToManyField(<span class="string">&#x27;Role&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># utils.serialer.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfoSerialier</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    field1 = serializers.CharField(source=<span class="string">&#x27;get_user_type_display&#x27;</span>)</span><br><span class="line">    rls = serializers.SerializerMethodField()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = UserInfo</span><br><span class="line">        fields = [<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;username&#x27;</span>,<span class="string">&#x27;field1&#x27;</span>,<span class="string">&#x27;rls&#x27;</span>]</span><br><span class="line">        <span class="comment"># 深度为1</span></span><br><span class="line">        depth = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_roles</span>(<span class="params">self,row</span>):</span></span><br><span class="line">        role_obj_list = row.roles.<span class="built_in">all</span>()</span><br><span class="line">        ret = [&#123;<span class="string">&#x27;id&#x27;</span>:item.<span class="built_in">id</span>,<span class="string">&#x27;title&#x27;</span>:item.title&#125; <span class="keyword">for</span> item <span class="keyword">in</span> role_obj_list]</span><br><span class="line">        <span class="keyword">return</span> ret</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        users = UserInfo.objects.<span class="built_in">all</span>()</span><br><span class="line">        ser = UserInfoSerializer(instance=users,many=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        res = json.dumps(ser.data,ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(res)</span><br></pre></td></tr></table></figure>

<p>返回:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 没有depth=1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&#x27;id&#x27;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="string">&#x27;username&#x27;</span> : <span class="string">&#x27;hyl&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;field1&#x27;</span> : <span class="string">&#x27;普通用户&#x27;</span></span><br><span class="line">    <span class="string">&#x27;rls&#x27;</span> : [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># depth=1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&#x27;id&#x27;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="string">&#x27;username&#x27;</span> : <span class="string">&#x27;hyl&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;field1&#x27;</span> : <span class="string">&#x27;普通用户&#x27;</span></span><br><span class="line">    <span class="string">&#x27;rls&#x27;</span> : [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>:<span class="number">1</span>,</span><br><span class="line">            <span class="string">&#x27;title&#x27;</span>:<span class="string">&#x27;医生&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>:<span class="number">2</span>,</span><br><span class="line">            <span class="string">&#x27;title&#x27;</span>:<span class="string">&#x27;学生&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>:<span class="number">3</span>,</span><br><span class="line">            <span class="string">&#x27;title&#x27;</span>:<span class="string">&#x27;护士&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单来说,</p>
<ul>
<li>当depth=0,那么外键的值就是单纯的id</li>
<li>当depth=1,那么就会拆开一层,depth=2就会拆开2层.(最好不要超过10层)</li>
</ul>
<p>这种操作称为:<code>自动序列化联表</code>,如果有多张表通过外键链接起来,那么使用depth是非常方便的</p>
</blockquote>
<h4 id="源码流程-5"><a href="#源码流程-5" class="headerlink" title="源码流程"></a>源码流程</h4><p><img src="/images/django_rest_framework%E5%BA%8F%E5%88%97%E5%8C%96%E5%85%B6%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B.jpg" alt="django_rest_framework序列化其源码流程"></p>
<h2 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h2><ol>
<li>看第n页，每页显示n条数据，</li>
<li>在某个位置，向后查看n条数据；</li>
<li>加密分页，只能看上一页和下一页</li>
</ol>
<h3 id="看第n页，每页显示n条数据"><a href="#看第n页，每页显示n条数据" class="headerlink" title="看第n页，每页显示n条数据"></a>看第n页，每页显示n条数据</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># settings.py</span></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;PAGE_SIZE&#x27;</span>:<span class="number">2</span></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> PageNumberPagination</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 获取所有数据</span></span><br><span class="line">        users = UserInfo.objects.<span class="built_in">all</span>()</span><br><span class="line">        <span class="comment"># 创建分页对象</span></span><br><span class="line">        pg = PageNumberPagination()</span><br><span class="line">        <span class="comment"># 在数据库中获取分页的数据 </span></span><br><span class="line">        pager = pg.paginate_queryset(queryset=users,request=request,view=self)</span><br><span class="line">        <span class="comment"># 对数据进行序列化</span></span><br><span class="line">        ser = UserInfoSerializer(instance=pager,many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br></pre></td></tr></table></figure>

<p>这样,</p>
<ul>
<li>访问<code>http://127.0.0.1:8000/api/v1/user/</code>就会显示第一页</li>
<li>访问<code>http://127.0.0.1:8000/api/v1/user/?page=2</code>就会显示第二页</li>
</ul>
<h4 id="自定义page-size分页器"><a href="#自定义page-size分页器" class="headerlink" title="自定义page,size分页器"></a>自定义page,size分页器</h4><p>如果我们想要自定义分页,只需继承<code>PageNumberPagination</code>即可:</p>
<ul>
<li>page_size : 每页的数据数量(默认)</li>
<li>page_size_query_param : 制定每页的数量(局部)</li>
<li>max_page_size : 每页最多的数据数量</li>
<li>page_query_param : url中表示页数的参数(默认是<code>page</code>)</li>
</ul>
<blockquote>
<p>简单来说,控制数据的就只有两个变量 : <strong>page</strong>和<strong>size</strong></p>
<ol>
<li>page : 返回第几页的数据</li>
<li>size : 当前页有多少个数据</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># utils.pagination.py</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> PageNumberPagination</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPageNumberPagination</span>(<span class="params">PageNumberPagination</span>):</span></span><br><span class="line">	page_size = <span class="number">2</span></span><br><span class="line">	page_size_query_param = <span class="string">&#x27;size&#x27;</span></span><br><span class="line">	max_page_size = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">	page_query_param = <span class="string">&#x27;p&#x27;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># viewspy</span></span><br><span class="line"><span class="keyword">from</span> .utils.pagination <span class="keyword">import</span> MyPageNumberPagination</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 获取所有数据</span></span><br><span class="line">        users = UserInfo.objects.<span class="built_in">all</span>()</span><br><span class="line">        <span class="comment"># 创建分页对象</span></span><br><span class="line">        pg = MyPageNumberPagination()</span><br><span class="line">        <span class="comment"># 在数据库中获取分页的数据 </span></span><br><span class="line">        pager = pg.paginate_queryset(queryset=users,request=request,view=self)</span><br><span class="line">        <span class="comment"># 对数据进行序列化</span></span><br><span class="line">        ser = UserInfoSerializer(instance=pager,many=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br></pre></td></tr></table></figure>

<p>接下来就可以使用<code>page</code>和<code>size</code>控制数据了</p>
</blockquote>
<h3 id="在某个位置，向后查看n条数据"><a href="#在某个位置，向后查看n条数据" class="headerlink" title="在某个位置，向后查看n条数据"></a>在某个位置，向后查看n条数据</h3><p>使用<code>LimitoffsetPagination</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> LimitOffsetPagination</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 获取所有数据</span></span><br><span class="line">        users = UserInfo.objects.<span class="built_in">all</span>()</span><br><span class="line">        <span class="comment"># 创建分页对象</span></span><br><span class="line">        pg = LimitOffsetPagination()</span><br><span class="line">        <span class="comment"># 在数据库中获取分页的数据 </span></span><br><span class="line">        pager = pg.paginate_queryset(queryset=users,request=request,view=self)</span><br><span class="line">        <span class="comment"># 对数据进行序列化</span></span><br><span class="line">        ser = UserInfoSerializer(instance=pager,many=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>接下来就可以使用<code>limit</code>和<code>offset</code>控制数据了</p>
</blockquote>
<h4 id="自定义limit-offset分页器"><a href="#自定义limit-offset分页器" class="headerlink" title="自定义limit,offset分页器"></a>自定义limit,offset分页器</h4><p>同理,我们也可以继承LimitOffsetPagination,对类变量进行修改</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># utils.pagination.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPageNumberPagination2</span>(<span class="params">LimitOffsetPagination</span>):</span></span><br><span class="line">	default_limit = <span class="number">2</span></span><br><span class="line">	limit_query_param = <span class="string">&#x27;limit&#x27;</span></span><br><span class="line">	offset_query_param = <span class="string">&#x27;offset&#x27;</span></span><br><span class="line"></span><br><span class="line">	max_limit = <span class="number">5</span></span><br></pre></td></tr></table></figure>



<h3 id="加密分页，只能看上一页和下一页"><a href="#加密分页，只能看上一页和下一页" class="headerlink" title="加密分页，只能看上一页和下一页"></a>加密分页，只能看上一页和下一页</h3><p>使用<code>cursorPagination</code></p>
<p>此时的url为<code>http://127.0.0.1:8000/api/v1/user/?cursor=cD00</code><br>(cursor参数的值不确定,是由cursorPagination后台实现的)</p>
<blockquote>
<p>这时我们的views.py就不能返回普通的Response了,要返回<code>pg.get_paginated_response(ser.data)</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># utils.pagination.py</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> cursorPagination</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPageNumberPagination3</span>(<span class="params">CursorPagination</span>):</span></span><br><span class="line">	cursor_query_param = <span class="string">&#x27;cursor&#x27;</span></span><br><span class="line">	page_size = <span class="number">2</span></span><br><span class="line">	<span class="comment"># 这个分页器是需要排序的,所以要提供排序的键</span></span><br><span class="line">	ordering = <span class="string">&#x27;id&#x27;</span></span><br><span class="line">	page_size_query_param = <span class="literal">None</span></span><br><span class="line">	max_page_size = <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="keyword">from</span> .utils.pagination <span class="keyword">import</span> MyPageNumberPagination3</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 获取所有数据</span></span><br><span class="line">        users = UserInfo.objects.<span class="built_in">all</span>()</span><br><span class="line">        <span class="comment"># 创建分页对象</span></span><br><span class="line">        pg = MyPageNumberPagination3()</span><br><span class="line">        <span class="comment"># 在数据库中获取分页的数据 </span></span><br><span class="line">        pager = pg.paginate_queryset(queryset=users,request=request,view=self)</span><br><span class="line">        <span class="comment"># 对数据进行序列化</span></span><br><span class="line">        ser = UserInfoSerializer(instance=pager,many=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># 返回get_paginated_response</span></span><br><span class="line">        <span class="keyword">return</span> pg.get_paginated_response(ser.data)</span><br></pre></td></tr></table></figure>

<p>当我们访问<code>http://127.0.0.1:8000/api/v1/user/?cursor=cD00</code>得到:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;next&quot;</span>: <span class="string">&quot;http://127.0.0.1:8000/api/v1/user/?cursor=cD02&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;previous&quot;</span>: <span class="string">&quot;http://127.0.0.1:8000/api/v1/user/?cursor=cj0xJnA9NQ%3D%3D&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;results&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;id&quot;</span>: <span class="number">5</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;id&quot;</span>: <span class="number">6</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2><p>继承关系:</p>
<p><img src="/images/%E8%A7%86%E5%9B%BE%E7%B1%BB%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB-1565665206934.jpg" alt="视图类继承关系-1565665206934"></p>
<h3 id="GenericAPIView"><a href="#GenericAPIView" class="headerlink" title="GenericAPIView"></a>GenericAPIView</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Views.py</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> GenericAPIView</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">GenericAPIView</span>):</span></span><br><span class="line">    queryset = UserInfo.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = UserInfoSerializer</span><br><span class="line">    pagination_class = PageNumberPagination</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 获取所有数据</span></span><br><span class="line">        users = self.get_queryset()</span><br><span class="line">        <span class="comment"># 在数据库中获取分页的数据 </span></span><br><span class="line">        pager = self.paginate_queryset(users)</span><br><span class="line">        <span class="comment"># 对数据进行序列化</span></span><br><span class="line">        ser = self.get_serializer(instance=pager,many=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># 返回Response</span></span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br></pre></td></tr></table></figure>

<p>对比之前的APIView:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 获取所有数据</span></span><br><span class="line">        users = UserInfo.objects.<span class="built_in">all</span>()</span><br><span class="line">        <span class="comment"># 创建分页对象</span></span><br><span class="line">        pg = PageNumberPagination()</span><br><span class="line">        <span class="comment"># 在数据库中获取分页的数据 </span></span><br><span class="line">        pager = pg.paginate_queryset(queryset=users,request=request,view=self)</span><br><span class="line">        <span class="comment"># 对数据进行序列化</span></span><br><span class="line">        ser = UserInfoSerializer(instance=pager,many=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># 返回Response</span></span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>发现这只是将定义变量提前了而已</p>
</blockquote>
<h3 id="GenericViewSet"><a href="#GenericViewSet" class="headerlink" title="GenericViewSet"></a>GenericViewSet</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># urls.py</span></span><br><span class="line">url(<span class="string">r&#x27;^api/(?P&lt;version&gt;[v1|v2]+)/users/$&#x27;</span>,views.UserView.as_view(&#123;<span class="string">&#x27;get&#x27;</span>:<span class="string">&#x27;list&#x27;</span>,<span class="string">&#x27;post&#x27;</span>:<span class="string">&#x27;xxx&#x27;</span>&#125;),name=<span class="string">&#x27;users&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># from rest_framework.viewsets import GenericViewSet</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">GenericViewSet</span>):</span></span><br><span class="line">    serializer_class = UserInfoSerializer</span><br><span class="line">    queryset = UserInfo.objects.<span class="built_in">all</span>()</span><br><span class="line">    pagination_class = PageNumberPagination</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">list</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 获取所有数据</span></span><br><span class="line">        users = self.get_queryset()</span><br><span class="line">        <span class="comment"># 在数据库中获取分页的数据 </span></span><br><span class="line">        pager = self.paginate_queryset(users)</span><br><span class="line">        <span class="comment"># 对数据进行序列化</span></span><br><span class="line">        ser = self.get_serializer(instance=pager,many=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># 返回get_paginated_response</span></span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">xxx</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> Response(<span class="string">&#x27;post&#x27;</span>) </span><br></pre></td></tr></table></figure>

<blockquote>
<p>GenericViewSet的唯一功能 :<code>as_view(&#123;&#39;get&#39;:&#39;list&#39;,&#39;post&#39;:&#39;xxx&#39;&#125;)</code></p>
<p>将get请求映射到list方法,让list方法处理.让post请求交给xxx方法处理</p>
</blockquote>
<blockquote>
<p>原因:ViewSetMixin覆盖了原来的as_view方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GenericViewSet</span>(<span class="params">ViewSetMixin,GenericAPIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">as_view</span>(<span class="params">self,adict</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="ModelViewSet"><a href="#ModelViewSet" class="headerlink" title="ModelViewSet"></a>ModelViewSet</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># urls.py</span></span><br><span class="line">url(<span class="string">r&#x27;^api/(?P&lt;version&gt;[v1|v2]+)/users/$&#x27;</span>,views.UserView.as_view(&#123;<span class="string">&#x27;get&#x27;</span>:<span class="string">&#x27;list&#x27;</span>&#125;),name=<span class="string">&#x27;users&#x27;</span>),</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Views.py</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.viewsets <span class="keyword">import</span> ModelViewSet</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">ModelViewSet</span>):</span></span><br><span class="line">    serializer_class = UserInfoSerializer</span><br><span class="line">    queryset = UserInfo.objects.<span class="built_in">all</span>()</span><br><span class="line">    pagination_class = PageNumberPagination</span><br></pre></td></tr></table></figure>

<p>此时访问<code>http://127.0.0.1:8000/api/v1/users/</code>即可得到结果</p>
<blockquote>
<p>原因: </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModelViewSet</span>(<span class="params">CreateModelMixin,</span></span></span><br><span class="line"><span class="params"><span class="class">                   RetrieveModelMixin,</span></span></span><br><span class="line"><span class="params"><span class="class">                   UpdateModelMixin,</span></span></span><br><span class="line"><span class="params"><span class="class">                   DestoryModelMixin,</span></span></span><br><span class="line"><span class="params"><span class="class">                   ListModelMixin</span>)</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">ListModelMixin</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">list</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        qeuryset = self.filter_queryset(self.get_queryset())</span><br><span class="line">        page = self.paginate_queryset(queryset)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> page <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            serializer = self.get_serializer(pagem,many=<span class="literal">True</span>)</span><br><span class="line">            <span class="keyword">return</span> self.get_paginatated_response(serializer.data)</span><br><span class="line"></span><br><span class="line">            serializer = self.get_serializer(queryset,many=<span class="literal">True</span>)</span><br><span class="line">            <span class="keyword">return</span> Response(Serializer.data)</span><br></pre></td></tr></table></figure>

<p>也就是说,ListModelMixin已经写好了list方法了</p>
</blockquote>
<p>如果我们要使用<code>post</code>来创建数据,这时就应该写</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># urls.py</span></span><br><span class="line">url(<span class="string">r&#x27;^api/(?P&lt;version&gt;[v1|v2]+)/users/$&#x27;</span>,views.UserView.as_view(&#123;<span class="string">&#x27;get&#x27;</span>:<span class="string">&#x27;list&#x27;</span>,<span class="string">&#x27;post&#x27;</span>:<span class="string">&#x27;create&#x27;</span>&#125;),name=<span class="string">&#x27;users&#x27;</span>),</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">ModelViewSet</span>):</span></span><br><span class="line">    serializer_class = UserInfoSerializer</span><br><span class="line">    queryset = UserInfo.objects.<span class="built_in">all</span>()</span><br><span class="line">    pagination_class = PageNumberPagination</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>而这个create函数,<code>CreateModelMixin</code>已经帮我们写好了</p>
<p>所以总共有5个mixin:</p>
<ul>
<li>CreateModelMixin(创建)</li>
<li>RetrieveModelMixin(获取单条) : 需要传入ID</li>
<li>UpdateModelMixin(更新) : 需要传入ID</li>
<li>DestoryModelMixin(删除) : 需要传入ID</li>
<li>ListModelMixin(获取全部)</li>
</ul>
<p>所以 : 如果要使用这些Mixin类,就要让url增加<code>(?P&lt;pk&gt;\d+)</code></p>
<p>要写两个路由</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># urls.py</span></span><br><span class="line"><span class="comment"># 两个url</span></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r&#x27;^api/(?P&lt;version&gt;[v1|v2]+)/users/$&#x27;</span>,views.UserView.as_view(&#123;<span class="string">&#x27;get&#x27;</span>:<span class="string">&#x27;list&#x27;</span>,<span class="string">&#x27;post&#x27;</span>:<span class="string">&#x27;create&#x27;</span>&#125;),name=<span class="string">&#x27;users&#x27;</span>),</span><br><span class="line">    </span><br><span class="line">    url(<span class="string">r&#x27;^api/(?P&lt;version&gt;[v1|v2]+)/users/(?P&lt;pk&gt;\d+)/$&#x27;</span>,views.UserView.as_view(&#123;<span class="string">&#x27;get&#x27;</span>:<span class="string">&#x27;retrieve&#x27;</span>,<span class="string">&#x27;delete&#x27;</span>:<span class="string">&#x27;destory&#x27;</span>,<span class="string">&#x27;put&#x27;</span>:<span class="string">&#x27;update&#x27;</span>,<span class="string">&#x27;patch&#x27;</span>:<span class="string">&#x27;partical_update&#x27;</span>&#125;),name=<span class="string">&#x27;users&#x27;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">ModelViewSet</span>):</span></span><br><span class="line">    serializer_class = UserInfoSerializer</span><br><span class="line">    queryset = UserInfo.objects.<span class="built_in">all</span>()</span><br><span class="line">    pagination_class = PageNumberPagination</span><br></pre></td></tr></table></figure>

<ul>
<li>get : list(获取全部数据)</li>
<li>get : retrieve (获取单条数据)</li>
<li>post : create</li>
<li>delete : destory</li>
<li>put : update (更新单条数据)</li>
<li>patch : partical_update (更新全部数据)</li>
</ul>
<h2 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h2><h3 id="手动填写路由"><a href="#手动填写路由" class="headerlink" title="手动填写路由"></a>手动填写路由</h3><p>路由可以写为:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 原先:</span></span><br><span class="line">url(<span class="string">r&#x27;^api/(?P&lt;version&gt;[v1|v2]+)/users/$&#x27;</span>,views.UserView.as_view(&#123;<span class="string">&#x27;get&#x27;</span>:<span class="string">&#x27;list&#x27;</span>,<span class="string">&#x27;post&#x27;</span>:<span class="string">&#x27;create&#x27;</span>&#125;),name=<span class="string">&#x27;users&#x27;</span>),</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加一个.(?P&lt;format&gt;\w+)</span></span><br><span class="line">url(<span class="string">r&#x27;^api/(?P&lt;version&gt;[v1|v2]+)/users\.(?P&lt;format&gt;\w+)/$&#x27;</span>,views.UserView.as_view(&#123;<span class="string">&#x27;get&#x27;</span>:<span class="string">&#x27;list&#x27;</span>,<span class="string">&#x27;post&#x27;</span>:<span class="string">&#x27;create&#x27;</span>&#125;),name=<span class="string">&#x27;users&#x27;</span>),</span><br></pre></td></tr></table></figure>

<ol>
<li>原先支持的url : <a target="_blank" rel="noopener" href="http://127.0.0.1:8000/api/v1/users/%E5%92%8Chttp://127.0.0.1:8000/api/v1/users/?format=json">http://127.0.0.1:8000/api/v1/users/和http://127.0.0.1:8000/api/v1/users/?format=json</a></li>
<li>现在还支持 : <a target="_blank" rel="noopener" href="http://127.0.0.1:8000/api/v1/users.json/">http://127.0.0.1:8000/api/v1/users.json/</a><br>(View由返回网页显示,变成了返回json数据)</li>
</ol>
<blockquote>
<p>简单来说:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 支持http://127.0.0.1:8000/api/v1/users/ : 显示网页</span></span><br><span class="line"><span class="comment"># 支持http://127.0.0.1:8000/api/v1/users/?format=json :返回json</span></span><br><span class="line">url(<span class="string">r&#x27;^api/(?P&lt;version&gt;[v1|v2]+)/users/$&#x27;</span>,views.UserView.as_view(&#123;<span class="string">&#x27;get&#x27;</span>:<span class="string">&#x27;list&#x27;</span>,<span class="string">&#x27;post&#x27;</span>:<span class="string">&#x27;create&#x27;</span>&#125;),name=<span class="string">&#x27;users&#x27;</span>),</span><br><span class="line"></span><br><span class="line"><span class="comment"># 支持http://127.0.0.1:8000/api/v1/users.json/</span></span><br><span class="line">url(<span class="string">r&#x27;^api/(?P&lt;version&gt;[v1|v2]+)/users\.(?P&lt;format&gt;\w+)/$&#x27;</span>,views.UserView.as_view(&#123;<span class="string">&#x27;get&#x27;</span>:<span class="string">&#x27;list&#x27;</span>,<span class="string">&#x27;post&#x27;</span>:<span class="string">&#x27;create&#x27;</span>&#125;),name=<span class="string">&#x27;users&#x27;</span>),</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 支持http://127.0.0.1:8000/api/v1/users/1/ : 显示网页</span></span><br><span class="line"><span class="comment"># 支持http://127.0.0.1:8000/api/v1/users/1/?format=json :返回json</span></span><br><span class="line">url(<span class="string">r&#x27;^api/(?P&lt;version&gt;[v1|v2]+)/users/(?P&lt;pk&gt;\d+)/$&#x27;</span>,views.UserView.as_view(&#123;<span class="string">&#x27;get&#x27;</span>:<span class="string">&#x27;list&#x27;</span>,<span class="string">&#x27;post&#x27;</span>:<span class="string">&#x27;create&#x27;</span>&#125;),name=<span class="string">&#x27;users&#x27;</span>),</span><br><span class="line"></span><br><span class="line"><span class="comment"># 支持http://127.0.0.1:8000/api/v1/users/1.json/</span></span><br><span class="line">url(<span class="string">r&#x27;^api/(?P&lt;version&gt;[v1|v2]+)/users/(?P&lt;pk&gt;\d+)\.(?P&lt;format&gt;\w+)/$&#x27;</span>,views.UserView.as_view(&#123;<span class="string">&#x27;get&#x27;</span>:<span class="string">&#x27;list&#x27;</span>,<span class="string">&#x27;post&#x27;</span>:<span class="string">&#x27;create&#x27;</span>&#125;),name=<span class="string">&#x27;users&#x27;</span>),</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>也就是说对于同一个视图,我们最多可以有4个路由:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r&#x27;^api/(?P&lt;version&gt;[v1|v2]+)/users/$&#x27;</span>,views.UserView.as_view(&#123;<span class="string">&#x27;get&#x27;</span>:<span class="string">&#x27;list&#x27;</span>,<span class="string">&#x27;post&#x27;</span>:<span class="string">&#x27;create&#x27;</span>&#125;),name=<span class="string">&#x27;users&#x27;</span>),</span><br><span class="line">    url(<span class="string">r&#x27;^api/(?P&lt;version&gt;[v1|v2]+)/users\.(?P&lt;format&gt;\w+)/$&#x27;</span>,views.UserView.as_view(&#123;<span class="string">&#x27;get&#x27;</span>:<span class="string">&#x27;list&#x27;</span>,<span class="string">&#x27;post&#x27;</span>:<span class="string">&#x27;create&#x27;</span>&#125;),name=<span class="string">&#x27;users&#x27;</span>),</span><br><span class="line">	url(<span class="string">r&#x27;^api/(?P&lt;version&gt;[v1|v2]+)/users/(?P&lt;pk&gt;\d+)/$&#x27;</span>,views.UserView.as_view(&#123;<span class="string">&#x27;get&#x27;</span>:<span class="string">&#x27;list&#x27;</span>,<span class="string">&#x27;post&#x27;</span>:<span class="string">&#x27;create&#x27;</span>&#125;),name=<span class="string">&#x27;users&#x27;</span>),</span><br><span class="line">    url(<span class="string">r&#x27;^api/(?P&lt;version&gt;[v1|v2]+)/users/(?P&lt;pk&gt;\d+)\.(?P&lt;format&gt;\w+)/$&#x27;</span>,views.UserView.as_view(&#123;<span class="string">&#x27;get&#x27;</span>:<span class="string">&#x27;list&#x27;</span>,<span class="string">&#x27;post&#x27;</span>:<span class="string">&#x27;create&#x27;</span>&#125;),name=<span class="string">&#x27;users&#x27;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>这样 , 这个视图支持6种url:</p>
<ol>
<li><a target="_blank" rel="noopener" href="http://127.0.0.1:8000/api/v1/users/">http://127.0.0.1:8000/api/v1/users/</a> : 全部数据 , 显示网页</li>
<li><a target="_blank" rel="noopener" href="http://127.0.0.1:8000/api/v1/users/?format=json">http://127.0.0.1:8000/api/v1/users/?format=json</a> :  全部数据 , 返回json</li>
<li><a target="_blank" rel="noopener" href="http://127.0.0.1:8000/api/v1/users.json/">http://127.0.0.1:8000/api/v1/users.json/</a> :  全部数据 , 返回json</li>
<li><a target="_blank" rel="noopener" href="http://127.0.0.1:8000/api/v1/users/1/">http://127.0.0.1:8000/api/v1/users/1/</a> : id为1的数据 , 显示网页</li>
<li><a target="_blank" rel="noopener" href="http://127.0.0.1:8000/api/v1/users/?format=json">http://127.0.0.1:8000/api/v1/users/?format=json</a> :   id为1的数据 , 返回json</li>
<li><a target="_blank" rel="noopener" href="http://127.0.0.1:8000/api/v1/users/1.json/">http://127.0.0.1:8000/api/v1/users/1.json/</a> :  id为1的数据 , 返回json</li>
</ol>
</blockquote>
<h3 id="全自动路由"><a href="#全自动路由" class="headerlink" title="全自动路由"></a>全自动路由</h3><p>前面4个url写起来太麻烦,这时就可以使用路由类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> routers</span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url,include</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">router = routers.DefaultRouter()</span><br><span class="line"><span class="comment"># 第一个参数是前缀,第二个参数是调用的视图</span></span><br><span class="line"><span class="comment"># 这样就可以匹配api/(?P&lt;version&gt;[v1|v2]+)/users/...</span></span><br><span class="line">router.register(<span class="string">r&#x27;users&#x27;</span>,views.UserView)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># 一个代替4个</span></span><br><span class="line">    url(<span class="string">r&#x27;api/(?P&lt;version&gt;[v1|v2]+)/&#x27;</span>,include(router.urls))</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>这样,这个视图就支持下面4个url:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">^ api/(?P&lt;version&gt;[v1|v2]+)/ ^users\.(?P&lt;format&gt;[a-z0-9]+)/?$ [name=&#x27;userinfo-list&#x27;]</span><br><span class="line">^ api/(?P&lt;version&gt;[v1|v2]+)/ ^users/(?P&lt;pk&gt;[^/.]+)/$ [name=&#x27;userinfo-detail&#x27;]</span><br><span class="line">^ api/(?P&lt;version&gt;[v1|v2]+)/ ^users/(?P&lt;pk&gt;[^/.]+)\.(?P&lt;format&gt;[a-z0-9]+)/?$ [name=&#x27;userinfo-detail&#x27;]</span><br></pre></td></tr></table></figure>



<h2 id="渲染器"><a href="#渲染器" class="headerlink" title="渲染器"></a>渲染器</h2><ul>
<li>就像<code>权限</code>,<code>阈值</code>,<code>认证</code>,<code>解析器</code>都有相应的classes一样,渲染器也有<code>renderer_classes</code></li>
<li>和解析器的classes一样,<code>renderer_classes</code>有什么,这个视图就支持怎么样的渲染</li>
</ul>
<h3 id="简单使用-2"><a href="#简单使用-2" class="headerlink" title="简单使用"></a>简单使用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># urls.py</span></span><br><span class="line">url(<span class="string">r&#x27;^api/(?P&lt;version&gt;[v1|v2]+)/role/$&#x27;</span>,views.RoleView.as_view(),name=<span class="string">&#x27;role&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.renderers <span class="keyword">import</span> JSONRenderer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RoleView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    renderer_classes = [JSONRenderer,]</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span></span><br><span class="line">        roles = Role.objects.<span class="built_in">all</span>().values(<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;title&#x27;</span>)</span><br><span class="line">        ser = RolesSerializer(instance=roles,many=<span class="literal">True</span>)</span><br><span class="line">        res = json.dumps(ser.data,ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(res)</span><br></pre></td></tr></table></figure>



<h3 id="内置渲染器类"><a href="#内置渲染器类" class="headerlink" title="内置渲染器类"></a>内置渲染器类</h3><ul>
<li>JSONRenderer</li>
<li>BrowsableAPIRenderer</li>
<li>AdminRenderer</li>
<li>HTMLFormRenderer</li>
</ul>
<h3 id="全局配置"><a href="#全局配置" class="headerlink" title="全局配置"></a>全局配置</h3><p>当然,也可以写在Settings.py里:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_RENDERER_CLASSES&#x27;</span> : [</span><br><span class="line">        <span class="string">&#x27;rest_framework.renderers.JSONRenderer&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;rest_framework.renderers.BrowsableAPIRenderer&#x27;</span></span><br><span class="line">    ]</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>



<h2 id="Content-Type"><a href="#Content-Type" class="headerlink" title="Content-Type"></a>Content-Type</h2><p>Content-Type : Django内置的一个组件，帮助开发者做连表操作</p>
<p>Django创建的表中,其实内置了一张<code>django_content_type</code>表,这张表的储存着我们自定义表的数据</p>
<table>
<thead>
<tr>
<th>id</th>
<th>app_label</th>
<th>model</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>blog</td>
<td>role</td>
</tr>
<tr>
<td>2</td>
<td>blog</td>
<td>usergroup</td>
</tr>
<tr>
<td>3</td>
<td>blog</td>
<td>userinfo</td>
</tr>
</tbody></table>
<p>如果我们要进行获取表的数据,可以对<code>djano_content-type</code>使用联表操作</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.cotrib.contenttypes.models <span class="keyword">import</span> ContentType</span><br><span class="line"></span><br><span class="line">content_type = models.ForeignKey(ContentType,verbose_name=<span class="string">&#x27;关联的表的名称&#x27;</span>)</span><br></pre></td></tr></table></figure>














































</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>