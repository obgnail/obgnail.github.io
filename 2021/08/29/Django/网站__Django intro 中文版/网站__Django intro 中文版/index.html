<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;初识-Django&quot;&gt;&lt;a href=&quot;#初识-Django&quot; class=&quot;headerlink&quot; title=&quot;初识 Django&quot;&gt;&lt;/a&gt;初识 Django&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/images/20171215145650232.png&quot; alt=&quot;20171215145650232&quot;&gt;"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>Django intro 中文版 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Django/" rel="tag">Django</a></div><div class="post-time">2021-08-29</div></div></div><div class="container post-header"><h1>Django intro 中文版</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%9D%E8%AF%86-Django"><span class="toc-number">1.</span> <span class="toc-text">初识 Django</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.1.</span> <span class="toc-text">设计模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.2.</span> <span class="toc-text">创建模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.3.</span> <span class="toc-text">设计模板</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E4%B8%AADjango%E9%A1%B9%E7%9B%AE-%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86"><span class="toc-number">2.</span> <span class="toc-text">第一个Django项目 第一部分</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%BD%A0%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA-Django-%E9%A1%B9%E7%9B%AE%EF%BC%8C-%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86"><span class="toc-number">3.</span> <span class="toc-text">创建你的第一个 Django 项目， 第二部分</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%BD%A0%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA-Django-%E9%A1%B9%E7%9B%AE%EF%BC%8C-%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86"><span class="toc-number">4.</span> <span class="toc-text">创建你的第一个 Django 项目， 第三部分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%B9%E8%89%AF-URLconf"><span class="toc-number">4.0.1.</span> <span class="toc-text">改良 URLconf</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%B9%E8%89%AF%E8%A7%86%E5%9B%BE"><span class="toc-number">4.0.2.</span> <span class="toc-text">改良视图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ListView"><span class="toc-number">4.1.</span> <span class="toc-text">ListView</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86-category-%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0%E6%94%B9%E5%86%99%E4%B8%BA%E7%B1%BB%E8%A7%86%E5%9B%BE"><span class="toc-number">4.1.1.</span> <span class="toc-text">将 category 视图函数改写为类视图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DetailView"><span class="toc-number">4.2.</span> <span class="toc-text">DetailView</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%BD%A0%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA-Django-%E9%A1%B9%E7%9B%AE%EF%BC%8C-%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86"><span class="toc-number">5.</span> <span class="toc-text">创建你的第一个 Django 项目， 第五部分</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E7%AE%80%E4%BB%8B"><span class="toc-number">5.1.</span> <span class="toc-text">自动化测试简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%B5%8B%E8%AF%95%E7%AD%96%E7%95%A5"><span class="toc-number">5.2.</span> <span class="toc-text">基本测试策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E5%85%A8%E9%9D%A2%E7%9A%84%E6%B5%8B%E8%AF%95"><span class="toc-number">5.2.1.</span> <span class="toc-text">更全面的测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%A7%86%E5%9B%BE"><span class="toc-number">5.3.</span> <span class="toc-text">测试视图</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Django-%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7%E4%B9%8B-Client"><span class="toc-number">5.3.1.</span> <span class="toc-text">Django 测试工具之 Client</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%B9%E5%96%84%E8%A7%86%E5%9B%BE%E4%BB%A3%E7%A0%81"><span class="toc-number">5.3.2.</span> <span class="toc-text">改善视图代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%BD%A0%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA-Django-%E9%A1%B9%E7%9B%AE%EF%BC%8C-%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86"><span class="toc-number">6.</span> <span class="toc-text">创建你的第一个 Django 项目， 第六部分</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%BD%A0%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA-Django-%E9%A1%B9%E7%9B%AE%EF%BC%8C-%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86"><span class="toc-number">7.</span> <span class="toc-text">创建你的第一个 Django 项目， 第七部分</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AF%B9%E8%B1%A1%E5%88%97%E8%A1%A8"><span class="toc-number">7.1.</span> <span class="toc-text">自定义对象列表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AE%A1%E7%90%86%E9%A1%B5%E9%9D%A2%E6%A0%B7%E5%BC%8F"><span class="toc-number">7.2.</span> <span class="toc-text">自定义管理页面样式</span></a></li></ol></li></ol></details></div><div class="container post-content"><h1 id="初识-Django"><a href="#初识-Django" class="headerlink" title="初识 Django"></a>初识 Django</h1><p><img src="/images/20171215145650232.png" alt="20171215145650232"></p>
<p><img src="/images/948404-20160830222155746-982749621.png" alt="img"></p>
<h2 id="设计模型"><a href="#设计模型" class="headerlink" title="设计模型"></a>设计模型</h2><p>Django 无需数据库就可以使用，它提供了<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Object-relational_mapping">对象关系映射器（ORM）</a>。通过此技术，你可以使用 Python 代码来描述数据库结构。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mysite/news/models.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Reporter</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    full_name = models.CharField(max_length=<span class="number">70</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span>              </span><br><span class="line">        <span class="keyword">return</span> self.full_name</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    pub_date = models.DateField()</span><br><span class="line">    headline = models.CharField(max_length=<span class="number">200</span>)</span><br><span class="line">    content  = models.TextField()</span><br><span class="line">    reporter = models.ForeignKey(Reporter)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span>              </span><br><span class="line">        <span class="keyword">return</span> self.headline</span><br></pre></td></tr></table></figure>

<h2 id="创建模型"><a href="#创建模型" class="headerlink" title="创建模型"></a>创建模型</h2><p>然后，运行 Django 命令行工具来创建数据库表。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python manage.py migrate</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/1.11/ref/django-admin/#django-admin-migrate"><strong>migrate</strong></a> 命令会查找所有可用的模型，如果数据库中没有与之对应的表，则会为其自动创建。Django 也提供了其他<a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/1.11/topics/migrations/">更丰富的控制方式</a>。</p>
<p>URL匹配过程会在瞬间完成，因为这些正则表达式在启动时就被编译了。</p>
<p>视图函数的执行结果只可能有两种：返回一个包含请求页面内容的 <a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/1.11/ref/request-response/#django.http.HttpResponse"><strong>HttpResponse</strong></a> 对象；或者是抛出 <a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/1.11/topics/http/views/#django.http.Http404"><strong>Http404</strong></a> 这类异常。<br>通常来说，一个<strong>视图的工作就是：从参数获取数据，加载模板，然后模板进行带数据的渲染。</strong></p>
<h2 id="设计模板"><a href="#设计模板" class="headerlink" title="设计模板"></a>设计模板</h2><p>Django 允许设置搜索模板路径，这样可以最小化模板之间的冗余。在Django设置中，你可以通过 <a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/1.11/ref/settings/#std:setting-TEMPLATES-DIRS"><strong>DIRS</strong></a> 参数指定目录列表来检索模板。如果模板不在第一个目录中，就继续检查第二个，以此类推。</p>
<p>比如<strong>news/year_archive.html</strong> 模板找到了，它可能是这样的：</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"># mysite/templates/base.html</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">load</span></span> static %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">	    <span class="tag">&lt;<span class="name">title</span>&gt;</span></span><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> title %&#125;</span><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml">	    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">static</span></span> &quot;images/sitelogo.png&quot; %&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;Logo&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">	    </span><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> content %&#125;</span><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">extends</span></span> &quot;base.html&quot; %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> title %&#125;</span><span class="xml">Articles for </span><span class="template-variable">&#123;&#123; year &#125;&#125;</span><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> content %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">h1</span>&gt;</span>Articles for </span><span class="template-variable">&#123;&#123; year &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">	</span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> article <span class="keyword">in</span> article_list %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">	    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><span class="template-variable">&#123;&#123; article.headline &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">	    <span class="tag">&lt;<span class="name">p</span>&gt;</span>By </span><span class="template-variable">&#123;&#123; article.reporter.full_name &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">	    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Published </span><span class="template-variable">&#123;&#123; article.pub_date|<span class="name">date</span>:<span class="string">&quot;F j, Y&quot;</span> &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">	</span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">	</span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span></span><br></pre></td></tr></table></figure>

<p>变量都被双花括号括起来了。<br><code>&#123;&#123; article.headline &#125;&#125;</code>的意思是“输出 <strong>article</strong> 的 <strong>headline</strong> 属性值”。==这个“点”不止用于查找属性，还可以查找字典键值、索引和函数调用==。</p>
<p>Django 使用了“模板继承”的概念。这就是<code> &#123;% extends "base.html" %&#125;</code> 的作用。它的含义是“先加载名为 base 的模板作为基类，并且用下面的标记块对模板中定义的标记块进行填充”。简而言之，模板继承可以使模板间的冗余内容最小化：每个模板只需包含与其他文档有区别的内容。</p>
<p>模型数据获取:<br>==多取一使用点号==:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># a为文章对象,reporter为记者对象.</span></span><br><span class="line"><span class="comment"># 记者和文章是一对多关系</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 多取一</span></span><br><span class="line"><span class="comment"># 通过 Article 对象可以访问与其关联的 Reporter 对象。</span></span><br><span class="line">a = Article()</span><br><span class="line">a.reporter.full_name</span><br></pre></td></tr></table></figure>

<p>==一取多使用<code>模型__set</code>==:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Reporter 对象访问与其关联的 Article 对象。</span></span><br><span class="line">r = a.reporter</span><br><span class="line">r.article_set.<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure>





<h1 id="第一个Django项目-第一部分"><a href="#第一个Django项目-第一部分" class="headerlink" title="第一个Django项目 第一部分"></a>第一个Django项目 第一部分</h1><p>在本教程中，我们将创建一个基础的投票网站。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysite/</span><br><span class="line">    manage.py</span><br><span class="line">    mysite/</span><br><span class="line">        __init__.py</span><br><span class="line">        settings.py</span><br><span class="line">        urls.py</span><br><span class="line">        wsgi.py</span><br></pre></td></tr></table></figure>

<p>这些目录和文件的用处是：</p>
<ul>
<li>最外层的 <strong>mysite/</strong> 根目录只是你项目的容器， Django 不关心它的名字，你可以将它重命名为任何你喜欢的名字。</li>
<li><strong>manage.py</strong>：一个让你可以用各种方式管理该 Django 项目的命令行工具。你可以阅读 <a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/1.11/ref/django-admin/">django-admin and manage.py</a> 来获取关于 <strong>manage.py</strong> 的更多细节。</li>
<li>里面一层的 <strong>mysite/</strong> 目录就是你项目的实际 Python 包。它的名字就是当你引用它内部任何东西时需要用到的 Python 包名（比如：<strong>mysite.urls</strong>）。</li>
<li><strong>mysite/__init__.py</strong>：一个用于指明此目录是 Python 包的空白文件。</li>
<li><strong>mysite/settings.py</strong>：该 Django 项目的配置文件。如果你想知道这个文件是如何工作的，请看文档 <a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/1.11/topics/settings/">Django settings</a>。</li>
<li><strong>mysite/urls.py</strong>：该 Django 项目的 URL 声明，==就像是你网站的“目录”==。阅读 <a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/1.11/topics/http/urls/">URL dispatcher</a> 文档来获取更多关于 URL 的内容。</li>
<li><strong>mysite/wsgi.py</strong>：当你部署项目到一个兼容 WSGI 的服务器上时所需要的入口点。<a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/1.11/howto/deployment/wsgi/">How to deploy with WSGI</a> 文档内有更多关于这个文件的细节。</li>
</ul>
<blockquote>
<p><strong>更换端口</strong></p>
<p>默认情况下，<a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/1.11/ref/django-admin/#django-admin-runserver"><strong>runserver</strong></a> 命令会将服务器设置为监听本机内部 IP 的 8000 端口。<br>如果你想更换服务器监听的端口，请使用命令行参数。比如，让服务器监听 8080 端口：</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py runserver 8080</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果你想更换服务器监听的 IP ，可以将它和端口号写在一起作为参数。比如，监听所有公网 IP（这尤其有用，当你想通过网络展示给其他人时），像这样：</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python manage.py runserver 0:8000</span><br></pre></td></tr></table></figure>

<hr>
<p>在 Django 中，每一个应用都是一个 Python 包，并且遵循着一定的约定。</p>
<blockquote>
<p><strong>项目 VS 应用</strong></p>
<p>项目和应用有什么区别？==应用是一个专门做某件事的网络应用程序==，比如博客系统、公共记录的数据库、或者简单的投票程序。==项目则是一个网站使用的配置和应用的集合==。项目可以包含很多个应用；而应用可以被很多个项目使用。</p>
</blockquote>
<p>新建一个应用polls</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py startapp polls</span><br></pre></td></tr></table></figure>

<p>这将会创建一个 <strong>polls</strong> 目录，它的目录结构大致如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">polls/</span><br><span class="line">    __init__.py</span><br><span class="line">    admin.py</span><br><span class="line">    migrations/</span><br><span class="line">        __init__.py</span><br><span class="line">    models.py</span><br><span class="line">    tests.py</span><br><span class="line">    views.py</span><br></pre></td></tr></table></figure>

<p>各部分代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># polls/urls.py</span></span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r&#x27;^$&#x27;</span>, views.index, name=<span class="string">&#x27;index&#x27;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mysite/urls.py</span></span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> include, url</span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r&#x27;^polls/&#x27;</span>, include(<span class="string">&#x27;polls.urls&#x27;</span>)),</span><br><span class="line">    url(<span class="string">r&#x27;^admin/&#x27;</span>, admin.site.urls),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># polls/views.py</span></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">&quot;Hello, world. You&#x27;re at the polls index.&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>include() 函数允许引用其他的 URLconf。<br>要注意到 include() 函数并没有 $(字符串匹配结束)，取而代之的是尾部的一个斜杠。<br><strong>每当 Django 遇到 include()，它就会排除正则匹配的部分，并将剩下的字符串发送到引用的 URLconf 中做进一步的处理</strong>。</p>
<p>url 函数有四个参数，两个必需参数：regex 正则和 view 视图；两个选项参数：<strong>kwargs字典</strong>和 name 名字。</p>
<p>kwargs:任意的关键字参数都可以作为字典传递到目标视图。</p>
<p>注意，这些正则表达式不会去匹配 GET 和 POST 请求的参数值，或者域名。<br>比如<code>https://www.example.com/myapp/</code>这个请求，URLconf 会找 myapp/；<br>==<code>https://www.example.com/myapp/?page=3 </code>这个请求，URLconf 同样只会找 mysqpp/==。</p>
<p>简单来说,URLconf <strong>只会找域名,不会找锚点,不会找参数</strong></p>
<hr>
<h1 id="创建你的第一个-Django-项目，-第二部分"><a href="#创建你的第一个-Django-项目，-第二部分" class="headerlink" title="创建你的第一个 Django 项目， 第二部分"></a>创建你的第一个 Django 项目， 第二部分</h1><p> INSTALLED_APPS </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">django.contrib.admin —— 管理站点。</span><br><span class="line">django.contrib.auth —— 认证系统。</span><br><span class="line">django.contrib.contenttypes —— 内容类型框架。</span><br><span class="line">django.contrib.sessions —— session 框架。</span><br><span class="line">django.contrib.messages —— 消息框架。</span><br><span class="line">django.contrib.staticfiles —— 静态文件管理框架。</span><br></pre></td></tr></table></figure>

<p>其中一些应用使用了至少一张数据库表，所以在使用它们之前，我们需要先在数据库中创建这些表。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py migrate</span><br></pre></td></tr></table></figure>

<p>migrate 命令在 mysite/settings.py 文件的 INSTALLED_APPS 设置中寻找，并根据数据库设置创建一些必要的数据库表和随应用迁移的数据库。</p>
<p>简单来说:<br><strong>migrate 命令只会迁移那些在 INSTALLED_APPS 中激活的应用的数据库</strong>。</p>
<p>模型代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># polls/models.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Question</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    question_text = models.CharField(max_length=<span class="number">200</span>)</span><br><span class="line">    pub_date      = models.DateTimeField(<span class="string">&#x27;date published&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Choice</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    question    = models.ForeignKey(Question, on_delete=models.CASCADE)</span><br><span class="line">    choice_text = models.CharField(max_length=<span class="number">200</span>)</span><br><span class="line">    votes       = models.IntegerField(default=<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>每个 Field 类实例变量的名字（比如 question_text 或 pub_date）都是<strong>字段名</strong>，这是对机器友好的格式。你将会在 Python 代码里使用它们，而数据库会将它们作为列名。</p>
<p><img src="/images/1557971350947.png" alt="1557971350947"></p>
<p><img src="/images/1557971375833.png" alt="1557971375833"></p>
<ul>
<li>数据库的表名是由应用名（<strong>polls</strong>）和模型名的小写形式（<strong>question</strong> 和 <strong>choice</strong>）连接而来。（如果需要，你可以自定义此行为。）</li>
<li>你在模型里定义的变量就是列名</li>
</ul>
<p>Django 应用是“可插拔”的。你可以在多个项目中使用同一个应用。除此之外，你还可以分发自己的应用，因为它们并不会被绑定到当前安装的 Django 上。</p>
<p>migrate 命令选中所有还没有执行过的迁移（Django 通过在数据库中创建一个特殊的表 django_migrations 来跟踪执行过哪些迁移）并应用在数据库上 - 也就是将你对模型的更改同步到数据库结构上。<br>迁移是非常强大的功能，它能让你在开发过程中持续的改变数据库结构而不需要重新删除和创建表 - 它专注于使数据库平滑升级而不会丢失数据。</p>
<p>数据库迁移被分解成生成和应用两个命令是为了让你能够在代码控制系统上提交迁移数据并使其能在多个应用里使用；这不仅仅会让开发更加简单，也给别的开发者和生产环境中的使用带来方便。</p>
<p>我们创建多对一的方法:<br>可以使用<code>一方对象</code>的<code>模型__set.create()</code>方法直接创建<code>多方对象</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建问题对象</span></span><br><span class="line">q = Question.objects.get(pk=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建问题的选项对象</span></span><br><span class="line">q.choice_set.create(choice_text=<span class="string">&#x27;Not much&#x27;</span>, votes=<span class="number">0</span>)</span><br><span class="line">q.choice_set.create(choice_text=<span class="string">&#x27;The sky&#x27;</span>, votes=<span class="number">0</span>)</span><br><span class="line">c = q.choice_set.create(choice_text=<span class="string">&#x27;Just hacking again&#x27;</span>, votes=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(c.question)</span><br></pre></td></tr></table></figure>

<p>一方对象的<code>模型__set</code>还有其他方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看所有的多方</span></span><br><span class="line">q.choice_set.<span class="built_in">all</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计数所有的多方</span></span><br><span class="line">q.choice_set.count()</span><br></pre></td></tr></table></figure>



<p>admin代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># polls/admin.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Question</span><br><span class="line"></span><br><span class="line">admin.site.register(Question)</span><br><span class="line">admin.site.register(Choice)</span><br></pre></td></tr></table></figure>



<hr>
<h1 id="创建你的第一个-Django-项目，-第三部分"><a href="#创建你的第一个-Django-项目，-第三部分" class="headerlink" title="创建你的第一个 Django 项目， 第三部分"></a>创建你的第一个 Django 项目， 第三部分</h1><p>Django 中的视图的概念是「一类具有相同功能和模板的网页的集合」。比如，在一个博客应用中，你可能会创建如下几个视图：</p>
<ul>
<li>博客首页 —— 展示最近的一些记录。</li>
<li>内容详情页 —— 详细展示某项内容。</li>
<li>以年为单位的归档页 —— 展示选中的年份里各个月份创建的内容。</li>
<li>以月为单位的归档页 —— 展示选中的月份里各天创建的内容。</li>
<li>以天为单位的归档页 —— 展示选中天里创建的所有内容。</li>
<li>评论页 —— 用于响应为一项内容添加评论的操作。</li>
</ul>
<p>而在投票应用中，我们需要下列几个视图：</p>
<ul>
<li>问题索引页 —— 展示最近的几个投票问题。</li>
<li>问题详情页 —— 展示某个投票的问题和不带结果的选项列表。</li>
<li>问题结果页 —— 展示某个投票的结果。</li>
<li>投票页 —— 用于响应用户为某个问题的特定选项投票的操作。</li>
</ul>
<p>「载入模板，填充上下文，再返回由它生成的 HttpResponse 对象」是一个如此常用的操作流程。于是 Django 提供了一个快捷函数，我们用它来重写 <strong>index()</strong> 视图：</p>
<p><a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/1.11/topics/http/shortcuts/#django.shortcuts.render"><strong>render()</strong></a> 函数把请求(HttpRequest)对象作为第一个参数，加载的模版名字作为第二个参数，用于渲染模板的上下文字典作为可选的第三个参数。函数返回一个 <a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/1.11/ref/request-response/#django.http.HttpResponse"><strong>HttpResponse</strong></a> 对象，内容为指定模板用指定上下文渲染后的结果。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">&quot;Hello, world. You&#x27;re at the polls index.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">detail</span>(<span class="params">request, question_id</span>):</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">&quot;You&#x27;re looking at question %s.&quot;</span> % question_id)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">results</span>(<span class="params">request, question_id</span>):</span></span><br><span class="line">    response = <span class="string">&quot;You&#x27;re looking at the results of question %s.&quot;</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(response % question_id)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">vote</span>(<span class="params">request, question_id</span>):</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">&quot;You&#x27;re voting on question %s.&quot;</span> % question_id)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># polls/urls.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># ex: /polls/</span></span><br><span class="line">    url(<span class="string">r&#x27;^$&#x27;</span>, views.index, name=<span class="string">&#x27;index&#x27;</span>),</span><br><span class="line">    <span class="comment"># ex: /polls/5/</span></span><br><span class="line">    url(<span class="string">r&#x27;^(?P&lt;question_id&gt;[0-9]+)/$&#x27;</span>, views.detail, name=<span class="string">&#x27;detail&#x27;</span>),</span><br><span class="line">    <span class="comment"># ex: /polls/5/results/</span></span><br><span class="line">    url(<span class="string">r&#x27;^(?P&lt;question_id&gt;[0-9]+)/results/$&#x27;</span>, views.results, name=<span class="string">&#x27;results&#x27;</span>),</span><br><span class="line">    <span class="comment"># ex: /polls/5/vote/</span></span><br><span class="line">    url(<span class="string">r&#x27;^(?P&lt;question_id&gt;[0-9]+)/vote/$&#x27;</span>, views.vote, name=<span class="string">&#x27;vote&#x27;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>当某人请求你网站的某一页面时——比如说，“/polls/34/”，Django 将会载入 mysite.urls 模块，因为<strong>配置项 ROOT_URLCONF 说要载入它</strong>。然后 Django 寻找名为 urlpatterns 变量并且按序遍历正则表达式。Django 找到匹配的正则表达式 ‘^polls/‘ 然后 Django 将会去除被匹配的部分（polls/）,然后发送剩下的文本 —— “34/” —— 给 “polls.urls” 这个 URLconf 做进一步处理。然后找到匹配的正则表达式 r’^(?P[0-9]+)/$’，随后用以下方式调用 detail() 函数：</p>
<p>每个视图必须要做的只有两件事：返回一个包含被请求页面内容的 <a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/1.11/ref/request-response/#django.http.HttpResponse"><strong>HttpResponse</strong></a> 对象，或者抛出一个异常，比如 <a target="_blank" rel="noopener" href="https://docs.djangoproject.com/en/1.11/topics/http/views/#django.http.Http404"><strong>Http404</strong></a>。至于你还想干些什么，都随你。</p>
<p>你的视图可以从数据库里读取记录，可以使用一个模板引擎（比如 Django 自带的，或者其他第三方的），可以生成一个 PDF 文件，可以输出一个 XML，创建一个 ZIP 文件，你可以做任何你想做的事，使用任何你想用的 Python 库。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># polls/views.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span></span><br><span class="line">    latest_question_list = Question.objects.order_by(<span class="string">&#x27;-pub_date&#x27;</span>)[:<span class="number">5</span>]</span><br><span class="line">    context = &#123;<span class="string">&#x27;latest_question_list&#x27;</span>: latest_question_list&#125;</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">&#x27;polls/index.html&#x27;</span>, context)</span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="comment">&lt;!-- polls/templates/polls/index.html --&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> latest_question_list %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="xml">	    </span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> question <span class="keyword">in</span> latest_question_list %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">	        <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/polls/</span></span></span><span class="template-variable">&#123;&#123; question.id &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">/&quot;</span>&gt;</span></span><span class="template-variable">&#123;&#123; question.question_text &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">	    </span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">else</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>No polls are available.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span></span><br></pre></td></tr></table></figure>



<p>抛出 404 错误</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># polls/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> Http404</span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Question</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">detail</span>(<span class="params">request, question_id</span>):</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        question = Question.objects.get(pk=question_id)</span><br><span class="line">    <span class="keyword">except</span> Question.DoesNotExist:</span><br><span class="line">        <span class="keyword">raise</span> Http404(<span class="string">&quot;Question does not exist&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">&#x27;polls/detail.html&#x27;</span>, &#123;<span class="string">&#x27;question&#x27;</span>: question&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="comment">&lt;!--- polls/templates/polls/detail.html --&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span></span><span class="template-variable">&#123;&#123; question.question_text &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> choice <span class="keyword">in</span> question.choice_set.all %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><span class="template-variable">&#123;&#123; choice.choice_text &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br></pre></td></tr></table></figure>



<p>一个快捷函数：<strong>get_object_of_404()</strong></p>
<p>「用 get() 函数获取对象，抛出 Http404错误」也是一个常用流程。Django 也提供了一个快捷函数，下面是重写的 detail() 视图：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># polls/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> get_object_or_404, render</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Question</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">detail</span>(<span class="params">request, question_id</span>):</span></span><br><span class="line">    <span class="comment"># 注意:object对象被放到了第一参数</span></span><br><span class="line">    question = get_object_or_404(Question, pk=question_id)</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">&#x27;polls/detail.html&#x27;</span>, &#123;<span class="string">&#x27;question&#x27;</span>: question&#125;)</span><br></pre></td></tr></table></figure>

<p>对比:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">detail</span>(<span class="params">request, question_id</span>):</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        question = Question.objects.get(pk=question_id)</span><br><span class="line">    <span class="keyword">except</span> Question.DoesNotExist:</span><br><span class="line">        <span class="keyword">raise</span> Http404(<span class="string">&quot;Question does not exist&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">&#x27;polls/detail.html&#x27;</span>, &#123;<span class="string">&#x27;question&#x27;</span>: question&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>get_object_of_404() 函数的第一个参数是一个 Django 模型</strong>。在此之后可以有任意个的关键字参数，他们会被直接传递给模型的 ==get() 函数==。如果对象并不存在，此快捷函数将会抛出一个 Http404 异常。</p>
<p>也有 <strong>get_list_of_404() 函数</strong>，工作原理和 get_object_of_404() 一样，除了 get() 函数被换成了 filter() 函数。如果列表为空的话会抛出 Http404 异常。</p>
<p>反向解析格式:</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">include</span></span> &#x27;模板目录&#x27; 参数1 参数2 %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;namespace.name&#x27; p1 p2 %&#125;</span></span><br></pre></td></tr></table></figure>



<p>代码:</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="comment">&lt;!--- polls/templates/polls/detail.html --&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span></span><span class="template-variable">&#123;&#123; question.question_text &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> error_message %&#125;</span><span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">strong</span>&gt;</span></span><span class="template-variable">&#123;&#123; error_message &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">strong</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;polls:vote&#x27; question.id %&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">csrf_token</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> choice <span class="keyword">in</span> question.choice_set.all %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;choice&quot;</span> <span class="attr">id</span>=<span class="string">&quot;choice</span></span></span><span class="template-variable">&#123;&#123; forloop.counter &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span> <span class="attr">value</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; choice.id &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;choice</span></span></span><span class="template-variable">&#123;&#123; forloop.counter &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span></span><span class="template-variable">&#123;&#123; choice.choice_text &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Vote&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># polls/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> get_object_or_404, render</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponseRedirect, HttpResponse</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> reverse</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Choice, Question</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">vote</span>(<span class="params">request, question_id</span>):</span></span><br><span class="line">    question = get_object_or_404(Question, pk=question_id)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        selected_choice = question.choice_set.get(pk=request.POST[<span class="string">&#x27;choice&#x27;</span>])</span><br><span class="line">    <span class="keyword">except</span> (KeyError, Choice.DoesNotExist):</span><br><span class="line">        <span class="comment"># 重新显示问题的投票表单</span></span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">&#x27;polls/detail.html&#x27;</span>, &#123;</span><br><span class="line">            <span class="string">&#x27;question&#x27;</span>: question,</span><br><span class="line">            <span class="string">&#x27;error_message&#x27;</span>: <span class="string">&quot;You didn&#x27;t select a choice.&quot;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        selected_choice.votes += <span class="number">1</span></span><br><span class="line">        selected_choice.save()</span><br><span class="line">        <span class="comment"># 成功处理之后 POST 数据之后，总是返回一个 HttpResponseRedirect 。防止因为用户点击了后退按钮而提交了两次。</span></span><br><span class="line">        <span class="comment"># 在本例中，reverse() 调用将返回一个字符串：&#x27;/polls/3/results/&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponseRedirect(reverse(<span class="string">&#x27;polls:results&#x27;</span>, args=(question.<span class="built_in">id</span>,)))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># polls/views.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">results</span>(<span class="params">request, question_id</span>):</span></span><br><span class="line">    question = get_object_or_404(Question, pk=question_id)</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">&#x27;polls/results.html&#x27;</span>, &#123;<span class="string">&#x27;question&#x27;</span>: question&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># detail() 视图几乎一模一样。唯一的不同是模板的名字。 我们将在稍后解决这个冗余问题。</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>视图里使用url是,千万不能硬编码,必须使用reverse</strong></li>
<li>request.POST 的值永远是字符串。</li>
<li><strong>成功处理 POST 数据后总是返回一个 HttpResponseRedirect。</strong> </li>
</ul>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="comment">&lt;!--- polls/templates/polls/results.htm --&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span></span><span class="template-variable">&#123;&#123; question.question_text &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="xml">	</span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> choice <span class="keyword">in</span> question.choice_set.all %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">	    <span class="tag">&lt;<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">	    	</span><span class="template-variable">&#123;&#123; choice.choice_text &#125;&#125;</span><span class="xml"> -- </span><span class="template-variable">&#123;&#123; choice.votes &#125;&#125;</span><span class="xml"> vote</span><span class="template-variable">&#123;&#123; choice.votes|<span class="name">pluralize</span> &#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">	    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">	</span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;polls:detail&#x27; question.id %&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span>Vote again?<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br></pre></td></tr></table></figure>



<p>使用通用视图：代码还是少点好<br>detail()和 results() 视图存在冗余问题。</p>
<p>这些视图反映基本的 Web 开发中的一个常见情况：<br>根据 URL 中的参数从数据库中获取数据、载入模板文件然后返回渲染后的模板。 由于这种情况特别常见，Django 提供一种快捷方式，叫做<code>通用视图</code>系统。</p>
<p>让我们将我们的投票应用转换成使用通用视图系统，这样我们可以删除许多我们的代码。我们仅仅需要做以下几步来完成转换： 我们将：</p>
<ol>
<li>转换 URLconf。</li>
<li>删除一些旧的、不再需要的代码。</li>
<li>引进基于 Django 通用视图的新视图。</li>
</ol>
<h3 id="改良-URLconf"><a href="#改良-URLconf" class="headerlink" title="改良 URLconf"></a><strong>改良 URLconf</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># polls/urls.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">app_name = <span class="string">&#x27;polls&#x27;</span></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r&#x27;^$&#x27;</span>, views.IndexView.as_view(), name=<span class="string">&#x27;index&#x27;</span>),</span><br><span class="line">    url(<span class="string">r&#x27;^(?P&lt;pk&gt;[0-9]+)/$&#x27;</span>, views.DetailView.as_view(), name=<span class="string">&#x27;detail&#x27;</span>),</span><br><span class="line">    url(<span class="string">r&#x27;^(?P&lt;pk&gt;[0-9]+)/results/$&#x27;</span>, views.ResultsView.as_view(), name=<span class="string">&#x27;results&#x27;</span>),</span><br><span class="line">    url(<span class="string">r&#x27;^(?P&lt;question_id&gt;[0-9]+)/vote/$&#x27;</span>, views.vote, name=<span class="string">&#x27;vote&#x27;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>对比:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># ex: /polls/</span></span><br><span class="line">    url(<span class="string">r&#x27;^$&#x27;</span>, views.index, name=<span class="string">&#x27;index&#x27;</span>),</span><br><span class="line">    <span class="comment"># ex: /polls/5/</span></span><br><span class="line">    url(<span class="string">r&#x27;^(?P&lt;question_id&gt;[0-9]+)/$&#x27;</span>, views.detail, name=<span class="string">&#x27;detail&#x27;</span>),</span><br><span class="line">    <span class="comment"># ex: /polls/5/results/</span></span><br><span class="line">    url(<span class="string">r&#x27;^(?P&lt;question_id&gt;[0-9]+)/results/$&#x27;</span>, views.results, name=<span class="string">&#x27;results&#x27;</span>),</span><br><span class="line">    <span class="comment"># ex: /polls/5/vote/</span></span><br><span class="line">    url(<span class="string">r&#x27;^(?P&lt;question_id&gt;[0-9]+)/vote/$&#x27;</span>, views.vote, name=<span class="string">&#x27;vote&#x27;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>



<h3 id="改良视图"><a href="#改良视图" class="headerlink" title="改良视图"></a><strong>改良视图</strong></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># polls/views.py</span></span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> get_object_or_404, render</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponseRedirect</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> reverse</span><br><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> generic</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Choice, Question</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexView</span>(<span class="params">generic.ListView</span>):</span></span><br><span class="line">    template_name = <span class="string">&#x27;polls/index.html&#x27;</span></span><br><span class="line">    context_object_name = <span class="string">&#x27;latest_question_list&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot; 返回最近时间的五个问题 &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> Question.objects.order_by(<span class="string">&#x27;-pub_date&#x27;</span>)[:<span class="number">5</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DetailView</span>(<span class="params">generic.DetailView</span>):</span></span><br><span class="line">    model = Question</span><br><span class="line">    template_name = <span class="string">&#x27;polls/detail.html&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResultsView</span>(<span class="params">generic.DetailView</span>):</span></span><br><span class="line">    model = Question</span><br><span class="line">    template_name = <span class="string">&#x27;polls/results.html&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">vote</span>(<span class="params">request, question_id</span>):</span></span><br><span class="line">    question = get_object_or_404(Question, pk=question_id)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        selected_choice = question.choice_set.get(pk=request.POST[<span class="string">&#x27;choice&#x27;</span>])</span><br><span class="line">    <span class="keyword">except</span> (KeyError, Choice.DoesNotExist):</span><br><span class="line">        <span class="comment"># 重新显示问题的投票表单</span></span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">&#x27;polls/detail.html&#x27;</span>, &#123;</span><br><span class="line">            <span class="string">&#x27;question&#x27;</span>: question,</span><br><span class="line">            <span class="string">&#x27;error_message&#x27;</span>: <span class="string">&quot;You didn&#x27;t select a choice.&quot;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        selected_choice.votes += <span class="number">1</span></span><br><span class="line">        selected_choice.save()</span><br><span class="line">        <span class="comment"># 成功处理之后 POST 数据之后，总是返回一个 HttpResponseRedirect 。防止因为用户点击了后退按钮而提交了两次。</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponseRedirect(reverse(<span class="string">&#x27;polls:results&#x27;</span>, args=(question.<span class="built_in">id</span>,)))</span><br></pre></td></tr></table></figure>

<hr>
<p>通用视图函数:</p>
<p>通用视图常用分为<strong>TemplateView</strong>、<strong>ListView</strong>和<strong>DetailView</strong><br>TemplateView：可以方便的定义要返回的模板但它不能把数据库中的内容查询展示出来<br>如果设计到数据库数据，则ListView和DetailView。<br>ListView和DetailView区别:</p>
<ul>
<li>ListView 用来获取==某个 model 中的所有数据==，</li>
<li>DetailView 从数据库获取模型的一条记录数据</li>
</ul>
<h2 id="ListView"><a href="#ListView" class="headerlink" title="ListView"></a>ListView</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    获取 Article 列表以渲染首页模板</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    article_list = Article.objects.<span class="built_in">all</span>()   <span class="comment"># 获取文章列表</span></span><br><span class="line">    category_list = Category.objects.<span class="built_in">all</span>() <span class="comment"># 获取分类列表</span></span><br><span class="line">    context = &#123; <span class="string">&#x27;article_list&#x27;</span> : article_list , <span class="string">&#x27;category_list&#x27;</span> : category_list &#125;</span><br><span class="line">    <span class="keyword">return</span> render_to_response(<span class="string">&#x27;blog/index.html&#x27;</span>,context)</span><br></pre></td></tr></table></figure>

<p>一个应用中可能会重复书写下面代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">article_list = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">context = &#123; <span class="string">&#x27;article_list&#x27;</span> : article_list &#125;</span><br><span class="line"><span class="keyword">return</span> render_to_response(<span class="string">&#x27;blog/index.html&#x27;</span>,context)</span><br></pre></td></tr></table></figure>

<p>这些逻辑抽象出来放到一个类里,于是 Django 帮我们写好了一个类，专门用于处理上面的情况，这就是 <strong>ListView</strong>，将上面的视图函数转写成类视图如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexView</span>(<span class="params">ListView</span>):</span></span><br><span class="line">    <span class="comment"># 将 model 指定为 Post，告诉 Django 我要获取的模型是 Post。</span></span><br><span class="line">    model = Post</span><br><span class="line">    <span class="comment"># 指定需要渲染的模板</span></span><br><span class="line">    template_name = <span class="string">&quot;blog/index.html&quot;</span></span><br><span class="line">    <span class="comment"># 指定获取的模型列表数据保存的变量名。这个变量会被传递给模板。</span></span><br><span class="line">    context_object_name = <span class="string">&quot;article_list&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 复写get_queryset方法:增加获取 model 列表的其他逻辑</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        article_list = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">        <span class="comment"># 修改article的body属性</span></span><br><span class="line">        <span class="keyword">for</span> article <span class="keyword">in</span> article_list:</span><br><span class="line">            article.body = markdown2.markdown(article.body, extras=[<span class="string">&#x27;fenced-code-blocks&#x27;</span>], )</span><br><span class="line">        <span class="keyword">return</span> article_list</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 复写get_context_data方法:给 context 增加额外的变量</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_context_data</span>(<span class="params">self, **kwargs</span>):</span></span><br><span class="line">        kwargs[<span class="string">&#x27;category_list&#x27;</span>] = Category.objects.<span class="built_in">all</span>().order_by(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>(IndexView, self).get_context_data(**kwargs) </span><br></pre></td></tr></table></figure>

<p><strong>ListView 总结</strong>：</p>
<ul>
<li><strong>ListView 主要用在获取某个 model 列表中</strong></li>
<li>通过 template_name 属性来指定需要渲染的模板，<br>通过 context_object_name 属性来指定获取的 model 列表的名字，否则只能通过默认的 object_list 获取</li>
<li>复写 get_queryset 方法以增加获取 model 列表的其他逻辑</li>
<li>复写 get_context_data 方法来为上下文对象添加<strong>额外</strong>的变量以便在模板中访问</li>
</ul>
<p>ListView的前后对比:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog/views.py</span></span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> ListView</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexView</span>(<span class="params">ListView</span>):</span></span><br><span class="line">    model = Post</span><br><span class="line">    <span class="comment"># 要传给的templates</span></span><br><span class="line">    template_name = <span class="string">&#x27;blog/index.html&#x27;</span></span><br><span class="line">    <span class="comment"># 要传给templates的字典</span></span><br><span class="line">    context_object_name = <span class="string">&#x27;post_list&#x27;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog/views.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span></span><br><span class="line">    post_list = Post.objects.<span class="built_in">all</span>()</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">&#x27;blog/index.html&#x27;</span>, context=&#123;<span class="string">&#x27;post_list&#x27;</span>: post_list&#125;)</span><br></pre></td></tr></table></figure>

<p><code>index</code> 视图函数首先通过 <code>Post.objects.all()</code> 从数据库中获取文章（Post）列表数据，并将其保存到 <code>post_list</code> 变量中。而在类视图中这个过程 <code>ListView</code> 已经帮我们做了。==我们只需告诉 <code>ListView</code> 去数据库获取的模型是 <code>Post</code>，而不是 <code>Comment</code> 或者其它什么模型==，即指定 <code>model = Post</code>。<br>将获得的模型数据列表保存到 <code>post_list</code> 里，即指定 <code>context_object_name = &#39;post_list&#39;</code>。然后渲染 blog/index.html 模板文件，<code>index</code> 视图函数中使用 <code>render</code> 函数。但这个过程 <code>ListView</code> 已经帮我们做了，我们只需指定渲染哪个模板即可。</p>
<h3 id="将-category-视图函数改写为类视图"><a href="#将-category-视图函数改写为类视图" class="headerlink" title="将 category 视图函数改写为类视图"></a>将 category 视图函数改写为类视图</h3><p><code>category</code> 视图函数的功能也是从数据库中获取文章列表数据，不过其和 <code>index</code> 视图函数不同的是，它获取的是某个分类下的全部文章。因此 <code>category</code> 视图函数中多了一步，==即首先需要根据从 URL 中捕获的分类 id 并从数据库获取分类，然后使用 <code>filter</code> 函数过滤出该分类下的全部文章。==</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog/views.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryView</span>(<span class="params">ListView</span>):</span></span><br><span class="line">    model = Post</span><br><span class="line">    template_name = <span class="string">&#x27;blog/index.html&#x27;</span></span><br><span class="line">    context_object_name = <span class="string">&#x27;post_list&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ListView默认的get_queryset是取得全部的数据</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        cate = get_object_or_404(Category, pk=self.kwargs.get(<span class="string">&#x27;pk&#x27;</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>(CategoryView, self).get_queryset().<span class="built_in">filter</span>(category=cate)</span><br></pre></td></tr></table></figure>

<p>和 <code>IndexView</code> 不同的地方是，我们覆写了父类的 <code>get_queryset</code> 方法。<strong>该方法默认获取指定模型的全部列表数据</strong>。为了获取指定分类下的文章列表数据，我们覆写该方法，改变它的默认行为。</p>
<p>首先是需要根据从 URL 中捕获的分类 id（也就是 pk）获取分类，这和 <code>category</code> 视图函数中的过程是一样的。不过注意一点的是，在类视图中，<strong>从 URL 捕获的命名组参数值保存在实例的 <code>kwargs</code> 属性（是一个字典）里，非命名组参数值保存在实例的 <code>args</code> 属性（是一个列表）里</strong>。所以我们使了 <code>self.kwargs.get(&#39;pk&#39;)</code> 来获取从 URL 捕获的分类 id 值。然后我们调用父类的 <code>get_queryset</code> 方法获得全部文章列表，紧接着就对返回的结果调用了 <code>filter</code> 方法来筛选该分类下的全部文章并返回。</p>
<h2 id="DetailView"><a href="#DetailView" class="headerlink" title="DetailView"></a>DetailView</h2><p>前面的 ListView 用于获取某个 model 的列表，获取的是一系列对象，但获取单个 mdoel 对象也是很常见的，比如 Blog 里点击某篇文章后进入文章的详情页，这里获取的就是点击这篇文章。我们通常会写如下视图函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">detail</span>(<span class="params">request,article_id</span>):</span></span><br><span class="line">    article = get_object_or_404(Article,pk=article_id)</span><br><span class="line">    context = &#123; <span class="string">&#x27;article&#x27;</span> : article &#125;</span><br><span class="line">    <span class="keyword">return</span> render_to_response(<span class="string">&#x27;blog/detail.html&#x27;</span>,context)</span><br></pre></td></tr></table></figure>

<p>会重复写:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">article = get_object_or_404(Article,pk=article_id) </span><br></pre></td></tr></table></figure>

<p>Django 通过 DetailView 来把这种逻辑抽象出来，把上面的视图函数转成类视图：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleDetailView</span>(<span class="params">DetailView</span>):</span></span><br><span class="line">    <span class="comment"># 将 model 指定为 Article，告诉 Django 我要获取的模型是 Article。</span></span><br><span class="line">    model = Article</span><br><span class="line">    <span class="comment"># 指定需要渲染的模板</span></span><br><span class="line">    template_name = <span class="string">&quot;blog/detail.html&quot;</span></span><br><span class="line">    <span class="comment"># 指定获取的模型列表数据保存的变量名。这个变量会被传递给模板。</span></span><br><span class="line">    context_object_name = <span class="string">&quot;article&quot;</span></span><br><span class="line">    <span class="comment"># pk_url_kwarg用于接收一个来自url中的主键，然后会根据这个主键进行查询</span></span><br><span class="line">    <span class="comment"># 这个article_id就是url(r&#x27;^blog/article/(?P&lt;article_id&gt;\d+)$&#x27;)中的article_id</span></span><br><span class="line">    pk_url_kwarg = <span class="string">&#x27;article_id&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 返回该视图要显示的对象</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_object</span>(<span class="params">self, queryset=<span class="literal">None</span></span>):</span></span><br><span class="line">        obj = <span class="built_in">super</span>().get_object()</span><br><span class="line">        obj.body = markdown2.markdown(obj.body, extras=[<span class="string">&#x27;fenced-code-blocks&#x27;</span>], )</span><br><span class="line">        <span class="keyword">return</span> obj</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment"># urls.py</span></span><br><span class="line">url(<span class="string">r&#x27;^blog/article/(?P&lt;article_id&gt;\d+)$&#x27;</span>, views.ArticleDetailView.as_view(), name=<span class="string">&#x27;detail&#x27;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<ol>
<li>假设用户点击了第三篇文章，那么该 url 会被解析成：/blog/article/3，其中 3 被传递给了详情页面视图函数。</li>
<li>现在视图函数被调用，它首先根据传给它的参数获自动调用 get_object 方法取到文章的 model，然后根据 context_object_name = “article” 把 article 加入到上下文中（可以理解为携带着这个变量及其值并要传递给模板文件的对象，模板文件从这个对象中取出模板变量对应的值并替换。），</li>
<li>之后渲染 template_name = “blog/detail.html” 指定的模板文件，至此用户就跳转到了文章详情页</li>
</ol>
</blockquote>
<p><strong>DetailView 期望从 URL 中捕获名为 “pk” 的主键值，所以我们为通用视图把 question_id 改成 pk</strong> 。<br>前后对比:</p>
<p>DetailView 总结</p>
<ul>
<li>DetailView主要用在获取某个 model 的单个对象中</li>
<li>通过 template_name 属性来指定需要渲染的模板，通过 context_object_name 属性来指定获取的 model 对象的名字，否则只能通过默认的 object 获取</li>
<li>复写 get_object 方法以增加获取单个 model 对象的其他逻辑</li>
<li>复写 get_context_data 方法来为上下文对象添加额外的变量以便在模板中访问</li>
</ul>
<p>由于类不是函数，所以需要使用<code>as_view()</code>这个类方法将一个基于类的视图转换成函数形式的接口。</p>
<p>关于通用视图函数的总结:</p>
<ul>
<li>ListView 用来获取==某个 model 中的所有数据==，<br>DetailView 从数据库获取模型的一条记录数据</li>
</ul>
<p>  简单来说<br>  ListView :获取某个模型的所有行<br>  DetailView :获取某个模型的一行</p>
<ul>
<li><p><code>model = Post</code>:<br>要获取那个模型<br><code>template_name = &#39;blog/index.html&#39;</code>:<br>待渲染的模板<br><code>context_object_name = &#39;post_list&#39;</code>:<br>传递给模板的变量名.<br>对于DetailView 来说,这个变量会被自动提供,无需自己写.</p>
</li>
<li><p><code>get_queryset()</code>:<br>==在视图函数调用时自动运行==,ListView默认会获取模型的全部行,可以通过复写get_queryset来实现获取部分行</p>
<p><code>get_context_data</code>:<br>为上下文对象添加<strong>额外</strong>的变量以便在模板中访问</p>
</li>
<li><p>在类视图中，从 URL 捕获的命名组参数值保存在实例的 <code>kwargs</code> 属性（是一个字典）里，非命名组参数值保存在实例的 <code>args</code> 属性（是一个列表）里。</p>
</li>
</ul>
<hr>
<h1 id="创建你的第一个-Django-项目，-第五部分"><a href="#创建你的第一个-Django-项目，-第五部分" class="headerlink" title="创建你的第一个 Django 项目， 第五部分"></a>创建你的第一个 Django 项目， 第五部分</h1><h2 id="自动化测试简介"><a href="#自动化测试简介" class="headerlink" title="自动化测试简介"></a>自动化测试简介</h2><p>自动化测试是什么？<br>测试，是用来检查代码正确性的一些简单的程序。</p>
<p>测试在不同的层次中都存在。有些测试只关注某个很小的细节（某个模型的某个方法的返回值是否满足预期？），而另一些测试可能检查对某个软件的一系列操作（某一用户输入序列是否造成了预期的结果？）。我们使用 shell 来测试某一方法的功能，或者运行某个应用并输入数据来检查它的行为。</p>
<p>真正不同的地方在于，自动化测试是由某个系统帮你自动完成的。当你创建好了一系列测试，<strong>每次修改应用代码后，就可以自动检查出修改后的代码是否还像你曾经预期的那样正常工作</strong>。你不需要花费大量时间来进行手动测试。</p>
<h2 id="基本测试策略"><a href="#基本测试策略" class="headerlink" title="基本测试策略"></a><strong>基本测试策略</strong></h2><p>测试有几种不同的应用方法。</p>
<p>一些开发者遵循 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Test-driven_development">测试驱动开发（test-driven development）</a>的原则，他们<strong>在写代码之前先写测试</strong>。这种方法看起来有点反直觉，但事实上，这和大多数人日常的做法是相吻合的。我们会先描述一个问题，然后写代码来解决它。「测试驱动」的开发方法只是将问题的描述抽象为了 Python 的测试样例。</p>
<p>更普遍的情况是，一个刚接触自动化测试的新手更倾向于先写代码，然后再写测试。虽然提前写测试可能更好，但是晚点写起码也比没有强。</p>
<p>有时候很难决定从测试该哪里开始下手。如果你已经写了几千行 Python 代码了，选择从哪里开始写测试确实不怎么简单。如果是这种情况，那么在你下次修改代码（比如加新功能，或者修复 Bug）之前写个测试是比较合理且有效的。</p>
<p>我们的投票（<strong>polls</strong>）应用现在就有一个小 Bug 需要被修复：我们的要求是如果 <strong>Question</strong> 是在一天之内发布的，<strong>Question.was_published_recently()</strong> 方法将会返回 <strong>True</strong>，然而现在这个方法在 <strong>Question</strong> 的 <strong>pub_date</strong> 字段比当前时间还晚时也会返回 <strong>True</strong>（这是个 Bug）。</p>
<p>按照惯例，Django 应用的测试因该写在应用的 <strong>tests.py</strong> 文件里。测试系统会自动的在所有以 <strong>test</strong> 开头的文件里寻找并执行测试代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># polls/tests.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.utils <span class="keyword">import</span> timezone</span><br><span class="line"><span class="keyword">from</span> django.test <span class="keyword">import</span> TestCase</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Question</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QuestionModelTests</span>(<span class="params">TestCase</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_was_published_recently_with_future_question</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        was_published_recently() 应该对 pub_date 字段值是将来的那些问题返回 False。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        time = timezone.now() + datetime.timedelta(days=<span class="number">30</span>)</span><br><span class="line">        future_question = Question(pub_date=time)</span><br><span class="line">        self.assertIs(future_question.was_published_recently(), <span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>运行测试:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">python manage.py test polls</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line"><span class="comment"># Creating test database for alias &#x27;default&#x27;...</span></span><br><span class="line"><span class="comment"># E</span></span><br><span class="line"><span class="comment"># ======================================================================</span></span><br><span class="line"><span class="comment"># ERROR: test_was_published_recently_with_future_question (polls.tests.QuestionModelTests)</span></span><br><span class="line"><span class="comment"># ----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Traceback (most recent call last):</span></span><br><span class="line"><span class="comment">#   File &quot;D:\note\Django\书籍__Django intro 中文版\trainingfile\mysite\polls\tests.py&quot;, line 17, in test_was_published_recently_with_future_question</span></span><br><span class="line"><span class="comment">#     self.assertIs(future_question.was_published_recently(), False)</span></span><br><span class="line"><span class="comment"># AttributeError: &#x27;Question&#x27; object has no attribute &#x27;was_published_recently&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Ran 1 test in 0.489s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># FAILED (errors=1)</span></span><br><span class="line"><span class="comment"># Destroying test database for alias &#x27;default&#x27;...</span></span><br></pre></td></tr></table></figure>

<p>自动化测试的运行过程：</p>
<ul>
<li>python manage.py test polls 将会寻找 poll 应用里的测试代码</li>
<li>它找到了一个 django.test.TestCase 的子类</li>
<li>它创建一个特殊的数据库供测试使用</li>
<li>它在类中寻找测试方法——以 test 开头的方法。</li>
<li>在 test_was_published_recently_with_future_question 方法中，它创建了一个 pub_date 值为未来第 30 天的 Question 实例。</li>
<li>然后使用 assertIs() 方法，发现 was_published_recently() 返回了 True，而我们希望它返回 False</li>
</ul>
<p>修改bug</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># polls/model.py</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">was_published_recently</span>(<span class="params">self</span>):</span></span><br><span class="line">    now = timezone.now()</span><br><span class="line">    <span class="keyword">return</span> now - datetime.timedelta(days=<span class="number">1</span>) &lt;= self.pub_date &lt;= now</span><br></pre></td></tr></table></figure>



<h3 id="更全面的测试"><a href="#更全面的测试" class="headerlink" title="更全面的测试"></a>更全面的测试</h3><p>我们在上次写的类里再增加两个测试，来更全面的测试这个方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># polls/tests.py</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_was_published_recently_with_old_question</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    对于 pub_date 在一天以前的 Question，was_published_recently() 应该返回 False。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    time = timezone.now() - datetime.timedelta(days=<span class="number">1</span>, seconds=<span class="number">1</span>)</span><br><span class="line">    old_question = Question(pub_date=time)</span><br><span class="line">    self.assertIs(old_question.was_published_recently(), <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_was_published_recently_with_recent_question</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    对于 pub_date 在一天之内的 Question，was_published_recently() 应该返回 True。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    time = timezone.now() - datetime.timedelta(hours=<span class="number">23</span>, minutes=<span class="number">59</span>, seconds=<span class="number">59</span>)</span><br><span class="line">    recent_question = Question(pub_date=time)</span><br><span class="line">    self.assertIs(recent_question.was_published_recently(), <span class="literal">True</span>)</span><br></pre></td></tr></table></figure>



<h2 id="测试视图"><a href="#测试视图" class="headerlink" title="测试视图"></a>测试视图</h2><p>我们的投票应用对所有问题都一视同仁：它将会发布所有的问题，也包括那些 <strong>pub_date</strong> 字段值是未来的问题。我们应该改善这一点。将 <strong>pub_date</strong> 设置为将来应该被解释为这个问题将在所填写的时间点才被发布，而在之前是不可见的。</p>
<h3 id="Django-测试工具之-Client"><a href="#Django-测试工具之-Client" class="headerlink" title="Django 测试工具之 Client"></a>Django 测试工具之 Client</h3><p>Django 提供了一个供测试使用的 Client 来<strong>模拟用户和视图层代码的交互</strong>。我们能在 tests.py 甚至是 shell 中使用它。</p>
<p>我们依照惯例从 shell 开始，首先我们要做一些在 tests.py 里并不需要的准备工作。第一步是在 shell 中配置测试环境：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> django.test.utils <span class="keyword">import</span> setup_test_environment</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>setup_test_environment()</span><br></pre></td></tr></table></figure>

<p>setup_test_environment() 安装了一个特殊的模板渲染器，它能让我们使用 response 的一些在正常情况下不可用的附加属性，比如 response.context。<br>注意，这个方法并不会配置测试数据库，所以接下来的代码将会当前存在的数据库上运行，输出的内容可能由于数据库内容的不同而不同。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> django.test <span class="keyword">import</span> Client</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># 创建一个 Client 实例</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>client = Client()</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># 获取 &#x27;/&#x27; 的响应</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>response = client.get(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">Not Found: /</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># 我们期望返回一个 404；如果你看到一个“无效 HTTP_HOST_header” 错误 和 一个400 响应，那你可能忘记了这之前要调用的 setup_test_environment()</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>response.status_code</span><br><span class="line"><span class="number">404</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># 访问 &#x27;/polls/&#x27; 的话，我们应该会得到一些有意义的响应</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> django.urls <span class="keyword">import</span> reverse</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>response = client.get(reverse(<span class="string">&#x27;polls:index&#x27;</span>))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>response.status_code</span><br><span class="line"><span class="number">200</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>response.content</span><br><span class="line"><span class="string">b&#x27;\n    &lt;ul&gt;\n    \n        &lt;li&gt;&lt;a href=&quot;/polls/1/&quot;&gt;What&amp;#39;s up?&lt;/a&gt;&lt;/li&gt;\n    \n    &lt;/ul&gt;\n\n&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>response.context[<span class="string">&#x27;latest_question_list&#x27;</span>]</span><br><span class="line">&lt;QuerySet [&lt;Question: What<span class="string">&#x27;s up?&gt;]&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="改善视图代码"><a href="#改善视图代码" class="headerlink" title="改善视图代码"></a>改善视图代码</h3><p>现在的投票列表会显示将来的投票（pub_date 值是将来的那些）。我们来修复这个问题。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># polls/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexView</span>(<span class="params">generic.ListView</span>):</span></span><br><span class="line">    template_name = <span class="string">&#x27;polls/index.html&#x27;</span></span><br><span class="line">    context_object_name = <span class="string">&#x27;latest_question_list&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;返回最近发布的五个投票&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> Question.objects.order_by(<span class="string">&#x27;-pub_date&#x27;</span>)[:<span class="number">5</span>]</span><br></pre></td></tr></table></figure>

<p>我们需要改进 get_queryset() 方法，让他它能通过将 Question 的 pub_data 属性与 timezone.now() 相比较来判断是否应该显示此 Question。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># polls/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.utils <span class="keyword">import</span> timezone</span><br><span class="line"><span class="comment"># 改写get_queryset</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;返回最近发布的五个投票（不包括那些被设置为在将来发布的）&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> Question.objects.<span class="built_in">filter</span>(</span><br><span class="line">        pub_date__lte=timezone.now()</span><br><span class="line">    ).order_by(<span class="string">&#x27;-pub_date&#x27;</span>)[:<span class="number">5</span>]</span><br></pre></td></tr></table></figure>



<hr>
<h1 id="创建你的第一个-Django-项目，-第六部分"><a href="#创建你的第一个-Django-项目，-第六部分" class="headerlink" title="创建你的第一个 Django 项目， 第六部分"></a>创建你的第一个 Django 项目， 第六部分</h1><p>除了服务端生成的 HTML 以外，网络应用通常需要一些其他的文件 —— 比如图片，脚本和样式表 —— 来帮助渲染网络页面。在 Django 中，我们把这些文件统称为“静态文件”。</p>
<p><strong>django.contrib.staticfiles</strong> 存在的意义：它将各个应用的静态文件（和一些你指明的目录里的文件）统一收集起来，这样一来，在生产环境中，这些文件就会集中在一个便于分发的地方。</p>
<h1 id="创建你的第一个-Django-项目，-第七部分"><a href="#创建你的第一个-Django-项目，-第七部分" class="headerlink" title="创建你的第一个 Django 项目， 第七部分"></a>创建你的第一个 Django 项目， 第七部分</h1><p><img src="/images/1558000416808.png" alt="1558000416808"></p>
<p>Django  <strong>外键（ForeignKey） 应该被表示为 选择框（&lt;select&gt;）</strong>。</p>
<p>问题（Question）”旁边的“添加（Add Another）”按钮也值得注意一下。每一个 <strong>外键（ForeignKey）</strong> 字段都会有这个按钮。当你点击它时，会弹出一个带有“添加问题（Add question）”表单的窗口。如果使用它添加了问题（Question）并点击了“保存（Save）”，Django 会将问题（Question）对象储存在数据库中然后动态的将其加入到之前的“添加选项”表单中的问题（Question）选择框中。</p>
<p>实现当你添加一个问题（Question）时能够同时为它加上几个选项</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># polls/admin.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Question,Choice</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">admin.site.register(Choice)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChoiceInline</span>(<span class="params">admin.StackedInline</span>):</span></span><br><span class="line">    model = Choice</span><br><span class="line">    extra = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QuestionAdmin</span>(<span class="params">admin.ModelAdmin</span>):</span></span><br><span class="line">    fieldsets = [</span><br><span class="line">        (<span class="literal">None</span>,               &#123;<span class="string">&#x27;fields&#x27;</span>: [<span class="string">&#x27;question_text&#x27;</span>]&#125;),</span><br><span class="line">        (<span class="string">&#x27;Date information&#x27;</span>, &#123;<span class="string">&#x27;fields&#x27;</span>: [<span class="string">&#x27;pub_date&#x27;</span>], <span class="string">&#x27;classes&#x27;</span>: [<span class="string">&#x27;collapse&#x27;</span>]&#125;),</span><br><span class="line">    ]</span><br><span class="line">    inlines = [ChoiceInline]</span><br><span class="line"></span><br><span class="line">    list_display = (<span class="string">&#x27;question_text&#x27;</span>, <span class="string">&#x27;pub_date&#x27;</span>, <span class="string">&#x27;was_published_recently&#x27;</span>)</span><br><span class="line"></span><br><span class="line">admin.site.register(Question, QuestionAdmin)</span><br></pre></td></tr></table></figure>

<p>增加的代码将会告诉 Django：“<strong>Choice（选项）</strong> 对象将会在 <strong>问题（Question）</strong> 的管理界面里被编辑。默认显示3个选项字段以供编辑。”</p>
<p><img src="/images/1558000715043.png" alt="1558000715043"></p>
<h2 id="自定义对象列表"><a href="#自定义对象列表" class="headerlink" title="自定义对象列表"></a>自定义对象列表</h2><p>对象列表分页（Change list pagination）、搜索框（search boxes）、过滤器（filters）、根据 时间分组（date-hierarchies）和根据 表头排序（column-header-ordering）可以完美结合，一起工作。</p>
<h2 id="自定义管理页面样式"><a href="#自定义管理页面样式" class="headerlink" title="自定义管理页面样式"></a>自定义管理页面样式</h2><p>在 templates 里可以创建 admin 目录，然后从 Django 代码目录里的默认 Django 管理页面模板目录（django/contirb/admin/templates）中将 admin/base_site.html 模板复制到新建的目录里。</p>
<p>如果 DIRS 目录维持默认的空值的话，Django 怎么知道去哪找默认的模板呢？<br>答案是，因为 APP_DIRS 被设置为 True，Django 会自动搜索每个应用目录下的 templates/ 子目录，将它们作为最后的备用选择。（别忘了，django.contrib.admin 也是个应用）</p>
</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>