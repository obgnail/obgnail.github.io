<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="划分APP的时候可能会出现&lt;code&gt;循环引用&lt;/code&gt;:"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>Django项目实战视频教程全集 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-none-link" href="/tags/Django/" rel="tag">Django</a></div><div class="post-time">2021-08-29</div></div></div><div class="container post-header"><h1>Django项目实战视频教程全集</h1></div><div class="container post-content"><p>划分APP的时候可能会出现<code>循环引用</code>:</p>
<blockquote>
<p>现在有一个用户APP和课程APP,</p>
<ul>
<li>呈现用户所选的课程,需要在用户APP里.</li>
<li>显示课程的评论,需要在课程APP里</li>
</ul>
<p>所以现在就需要在用户APP里导入课程APP,在课程APP里导入用户APP</p>
<p><img src="/images/1560906784825.png" alt="1560906784825"></p>
</blockquote>
<p>为了解决这种情况,我们一般的操作都是设计上层APP去解耦,具体来说就是<strong>创建一个上层的operations的APP</strong></p>
<p><img src="/images/1560906981975.png" alt="1560906981975"></p>
<p>将用户评论和用户收藏课程都放在了operationsAPP中,这样user和cours只需导入oprations即可.</p>
<hr>
<p>课程,课程分章节,章节分小节,每个章节都有资料下载.这种情况我们设计表的时候应该:</p>
<ul>
<li>课程表</li>
<li>章节表(外键为课程)</li>
<li>小节(视频)表(外键为章节)</li>
<li>资源表(外键为章节)</li>
</ul>
<p>所以我们的APP设计如下:</p>
<ul>
<li>用户APP:<ol>
<li>用户信息表</li>
<li>轮播图表</li>
<li>邮箱验证码表</li>
</ol>
</li>
<li>课程APP<ol>
<li>课程表</li>
<li>章节表</li>
<li>视频表</li>
<li>资源表</li>
</ol>
</li>
<li>机构APP<ol>
<li>城市表(机构所属城市)</li>
<li>机构表</li>
<li>讲师表</li>
</ol>
</li>
<li>操作表<ol>
<li>用户咨询课程表</li>
<li>用户个人消息表</li>
<li>用户学习课程表</li>
<li>用户评论课程表</li>
<li>用户收藏机构表</li>
<li>用户收藏课程表</li>
<li>用户收藏讲师表</li>
</ol>
</li>
</ul>
<hr>
<p>将自己定义的app迁移到APPs中:<br>在settings.py添加:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.path.insert(<span class="number">0</span>,os.path.join(BASE_DIR,<span class="string">&#x27;apps&#x27;</span>))</span><br></pre></td></tr></table></figure>



<p>Model的Meta中</p>
<ul>
<li><p>unique_together<br>当你需要通过两个字段保持唯一性时使用。<br>这会在 Django admin 层和数据库层同时做出限制(也就是相关的 UNIQUE 语句会被包括在 CREATE TABLE 语句中)。</p>
<blockquote>
<p>比如：一个Person的FirstName和LastName两者的组合必须是唯一的，那么需要这样设置：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unique_together = ((<span class="string">&quot;first_name&quot;</span>, <span class="string">&quot;last_name&quot;</span>),)</span><br></pre></td></tr></table></figure></blockquote>
</li>
<li><p>verbose_name:<br>就是给你的<strong>模型类</strong>起一个更可读的名字</p>
</li>
<li><p>db_table<br>用于指定自定义数据库<strong>表名</strong>的。<br>Django有一套默认的按照一定规则生成数据模型对应的数据库表名，如果你想使用自定义的表名，就通过这个属性指定，比如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table_name = &#x27;my_owner_table&#x27;   </span><br></pre></td></tr></table></figure>

<blockquote>
<p>若不提供该参数, Django 会使用 app_label + ‘_’ + module_name 作为表的名字.</p>
<p>若你的表的名字是一个 SQL 保留字, 或包含 Python 变量名不允许的字符–特别是连字符 –没关系. Django 会自动在幕后替你将列名字和表名字用引号引起来.</p>
</blockquote>
</li>
</ul>
<hr>
<p>使用Xadmin:</p>
<ol>
<li><p>安装requirement.txt</p>
</li>
<li><p>将xadmin和crispy_forms添加在app</p>
</li>
<li><p>在urls.py添加:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r&#x27;^xadmin/&#x27;</span>, xadmin.site.urls),</span><br></pre></td></tr></table></figure></li>
<li><p>执行迁移同步</p>
</li>
<li><p>添加adminx.py文件(等同于原来的admin.py)</p>
</li>
</ol>
<hr>
<p>修改xadmin中显示的app名:</p>
<p><img src="/images/1561006958509.png" alt="1561006958509"></p>
<p>将blog改为博客信息:</p>
<ol>
<li><p>在blog/apps.py里添加<code>verbose_nam</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlogConfig</span>(<span class="params">AppConfig</span>):</span></span><br><span class="line">    name = <span class="string">&#x27;blog&#x27;</span></span><br><span class="line">    verbose_name = <span class="string">&#x27;博客信息&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li><p>在blog/__init__.py里添加</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default_app_config = <span class="string">&#x27;blog.apps.BlogConfig&#x27;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>如果想修改Xadmin的ICO,可以使用<code>awesome font</code></p>
<hr>
<p>form.is_valid()返回false的原因一般是</p>
<ul>
<li>form中的每个field默认都是required的，如果没有填，form.is_valid()就会返回false。</li>
<li>html中的form中的各个field的name一定要和对应的form类的各个field的name保持一致，这也是一个易错点。</li>
<li>慎用自定义form的互相继承,很容易造成form.is_valid()返回false</li>
</ul>
<p>对于:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserLoginForm</span>(<span class="params">forms.Form</span>):</span></span><br><span class="line">    username = forms.CharField()</span><br><span class="line">    password = forms.CharField()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_username</span>(<span class="params">self</span>):</span></span><br><span class="line">        username = self.cleaned_data.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> UserProfile.objects.<span class="built_in">filter</span>(username=username).exists():</span><br><span class="line">            <span class="keyword">raise</span> forms.ValidationError(<span class="string">&#x27;用户不存在&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> username</span><br></pre></td></tr></table></figure>

<p>我们使用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lform = UserLoginForm(request.POST)</span><br><span class="line">content = &#123;<span class="string">&#x27;msg&#x27;</span>:lform.errors&#125;</span><br></pre></td></tr></table></figure>

<p>获取<code>forms.ValidationError(&#39;用户不存在&#39;)</code></p>
<hr>
<p>简单的用户登录与注册:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># urls.py</span></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r&#x27;^register/$&#x27;</span>, views.RegisterView.as_view(), name=<span class="string">&#x27;register&#x27;</span>),</span><br><span class="line">    url(<span class="string">r&#x27;^login/$&#x27;</span>, views.LoginView.as_view(), name=<span class="string">&#x27;login&#x27;</span>),</span><br><span class="line">    url(<span class="string">r&#x27;^logout/$&#x27;</span>, views.Logout, name=<span class="string">&#x27;logout&#x27;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># view.py</span></span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.hashers <span class="keyword">import</span> make_password,check_password</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> logout</span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render,redirect</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> reverse</span><br><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> View</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .forms <span class="keyword">import</span> UserRegisterForm,UserLoginForm</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserProfile</span><br><span class="line"><span class="keyword">from</span> blog.utils <span class="keyword">import</span> get_ip</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterView</span>(<span class="params">View</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        rform = UserRegisterForm()</span><br><span class="line">        context = &#123;<span class="string">&#x27;rform&#x27;</span>:rform&#125;</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">&#x27;user/register.html&#x27;</span>,context)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        username_is_duplicate = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        rform = UserRegisterForm(request.POST)</span><br><span class="line">        <span class="comment"># 校验成功</span></span><br><span class="line">        <span class="keyword">if</span> rform.is_valid():</span><br><span class="line">            username = rform.cleaned_data.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">            email = rform.cleaned_data.get(<span class="string">&#x27;email&#x27;</span>)</span><br><span class="line">            password = rform.cleaned_data.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">            repassword = rform.cleaned_data.get(<span class="string">&#x27;repassword&#x27;</span>)</span><br><span class="line">            ip = get_ip(request)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 该用户名没有被抢注</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> UserProfile.objects.<span class="built_in">filter</span>(username=username).exists():</span><br><span class="line">                <span class="comment"># 对密码加密</span></span><br><span class="line">                password = make_password(password)</span><br><span class="line">                user = UserProfile.objects.create(username=username,password=password,ip=ip)</span><br><span class="line">                <span class="comment"># 成功创建用户</span></span><br><span class="line">                <span class="keyword">if</span> user:</span><br><span class="line">                    <span class="comment"># 重定向到首页</span></span><br><span class="line">                    <span class="keyword">return</span> render(request,<span class="string">&#x27;user/logined.html&#x27;</span>)</span><br><span class="line">                    <span class="comment"># return redirect(reverse(&#x27;blog:index&#x27;))</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 该用户名已被抢注</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                username_is_duplicate = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 当is_valid失败或username_is_duplicate</span></span><br><span class="line">        <span class="keyword">if</span> username_is_duplicate:</span><br><span class="line">            msg = <span class="string">&#x27;该用户名已被注册&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            msg = <span class="string">&#x27;注册失败,请重新填写&#x27;</span></span><br><span class="line">        rform = UserRegisterForm()</span><br><span class="line">        context = &#123;<span class="string">&#x27;rform&#x27;</span>:rform,<span class="string">&#x27;msg&#x27;</span>:msg&#125;</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">&#x27;user/register.html&#x27;</span>,context=context)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginView</span>(<span class="params">View</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        context = &#123;<span class="string">&#x27;lform&#x27;</span>:UserLoginForm()&#125;</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">&#x27;user/login.html&#x27;</span>,context)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        wrong_pw = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        lform = UserLoginForm(request.POST)</span><br><span class="line">        <span class="keyword">if</span> lform.is_valid():</span><br><span class="line">            username = lform.cleaned_data.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">            password = lform.cleaned_data.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">            </span><br><span class="line">            user = UserProfile.objects.<span class="built_in">filter</span>(username=username).first()</span><br><span class="line">            is_auth = check_password(password,user.password)</span><br><span class="line">            <span class="comment"># 密码验证通过</span></span><br><span class="line">            <span class="keyword">if</span> is_auth:</span><br><span class="line">                request.session[<span class="string">&#x27;username&#x27;</span>] = username</span><br><span class="line">                <span class="keyword">return</span> render(request, <span class="string">&#x27;user/logined.html&#x27;</span>)</span><br><span class="line">                <span class="comment"># return redirect(reverse(&#x27;blog:index&#x27;))</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 密码验证不通过</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                wrong_pw = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 当is_valid失败或wrong_pw</span></span><br><span class="line">        <span class="keyword">if</span> wrong_pw:</span><br><span class="line">            msg = <span class="string">&#x27;密码错误&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            msg = lform.errors</span><br><span class="line">        context = &#123;<span class="string">&#x27;msg&#x27;</span>:msg,<span class="string">&#x27;lform&#x27;</span>:UserLoginForm()&#125;</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">&#x27;user/login.html&#x27;</span>,context=context)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Logout</span>(<span class="params">request</span>):</span></span><br><span class="line">    logout(request)</span><br><span class="line">    <span class="comment"># 或者使用:</span></span><br><span class="line">    <span class="comment"># request.session.flush()</span></span><br><span class="line">    <span class="keyword">return</span> redirect(reverse(<span class="string">&#x27;blog:index&#x27;</span>))</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># forms.py</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserProfile</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserRegisterForm</span>(<span class="params">forms.Form</span>):</span></span><br><span class="line">    username = forms.CharField(required=<span class="literal">True</span>,max_length=<span class="number">50</span>,min_length=<span class="number">5</span>,label=<span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">                                error_messages=&#123;<span class="string">&#x27;min_length&#x27;</span>:<span class="string">&#x27;最少5位&#x27;</span>,<span class="string">&#x27;max_length&#x27;</span>:<span class="string">&#x27;最多50位&#x27;</span>,<span class="string">&#x27;required&#x27;</span>:<span class="string">&#x27;必须填写用户名&#x27;</span>&#125;,</span><br><span class="line">                                widget=forms.widgets.TextInput(attrs=&#123;<span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;cm-input&#x27;</span>,<span class="string">&#x27;placeholder&#x27;</span>:<span class="string">&quot;用户名&quot;</span>&#125;))</span><br><span class="line">    email = forms.EmailField(required=<span class="literal">False</span>,label=<span class="string">&#x27;邮箱&#x27;</span>,</span><br><span class="line">                                widget=forms.widgets.TextInput(attrs=&#123;<span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;cm-input&#x27;</span>,<span class="string">&#x27;placeholder&#x27;</span>:<span class="string">&quot;邮箱&quot;</span>&#125;))</span><br><span class="line">    password = forms.CharField(required=<span class="literal">True</span>,label=<span class="string">&#x27;密码&#x27;</span>,</span><br><span class="line">                                error_messages=&#123;<span class="string">&#x27;required&#x27;</span>:<span class="string">&#x27;必须填写密码&#x27;</span>&#125;,</span><br><span class="line">                                widget=forms.widgets.PasswordInput(attrs=&#123;<span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;cm-input&#x27;</span>,<span class="string">&#x27;id&#x27;</span>:<span class="string">&quot;password&quot;</span>,<span class="string">&#x27;placeholder&#x27;</span>:<span class="string">&quot;密码&quot;</span>&#125;))</span><br><span class="line">    repassword = forms.CharField(required=<span class="literal">True</span>,label=<span class="string">&#x27;确认密码&#x27;</span>,</span><br><span class="line">                                error_messages=&#123;<span class="string">&#x27;required&#x27;</span>:<span class="string">&#x27;必须填写确认密码&#x27;</span>&#125;,</span><br><span class="line">                                widget=forms.widgets.PasswordInput(attrs=&#123;<span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;cm-input&#x27;</span>,<span class="string">&#x27;id&#x27;</span>:<span class="string">&quot;check_password&quot;</span>,<span class="string">&#x27;placeholder&#x27;</span>:<span class="string">&quot;确认密码&quot;</span>&#125;))</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_email</span>(<span class="params">self</span>):</span></span><br><span class="line">        email = self.cleaned_data.get(<span class="string">&#x27;email&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> email <span class="keyword">and</span> re.match(<span class="string">r&#x27;^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$&#x27;</span>,email):</span><br><span class="line">            <span class="keyword">return</span> email</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserLoginForm</span>(<span class="params">forms.Form</span>):</span></span><br><span class="line">    username = forms.CharField(required=<span class="literal">True</span>,max_length=<span class="number">50</span>,min_length=<span class="number">5</span>,label=<span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">                                error_messages=&#123;<span class="string">&#x27;min_length&#x27;</span>:<span class="string">&#x27;最少5位&#x27;</span>,<span class="string">&#x27;max_length&#x27;</span>:<span class="string">&#x27;最多50位&#x27;</span>,<span class="string">&#x27;required&#x27;</span>:<span class="string">&#x27;必须填写用户名&#x27;</span>&#125;,</span><br><span class="line">                                widget=forms.widgets.TextInput(attrs=&#123;<span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;cm-input&#x27;</span>,<span class="string">&#x27;placeholder&#x27;</span>:<span class="string">&quot;用户名&quot;</span>&#125;))</span><br><span class="line">    password = forms.CharField(required=<span class="literal">True</span>,label=<span class="string">&#x27;密码&#x27;</span>,</span><br><span class="line">                            error_messages=&#123;<span class="string">&#x27;required&#x27;</span>:<span class="string">&#x27;必须填写密码&#x27;</span>&#125;,</span><br><span class="line">                            widget=forms.widgets.PasswordInput(attrs=&#123;<span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;cm-input&#x27;</span>,<span class="string">&#x27;id&#x27;</span>:<span class="string">&quot;password&quot;</span>,<span class="string">&#x27;placeholder&#x27;</span>:<span class="string">&quot;密码&quot;</span>&#125;))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_username</span>(<span class="params">self</span>):</span></span><br><span class="line">        username = self.cleaned_data.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> UserProfile.objects.<span class="built_in">filter</span>(username=username).exists():</span><br><span class="line">            <span class="keyword">raise</span> forms.ValidationError(<span class="string">&#x27;用户不存在&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> username</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># models.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserProfile</span>(<span class="params">AbstractUser</span>):</span></span><br><span class="line">    <span class="string">&#x27;注册用户&#x27;</span></span><br><span class="line">    ip = models.GenericIPAddressField(<span class="string">&quot;ip&quot;</span>, protocol=<span class="string">&quot;both&quot;</span>, unpack_ipv4=<span class="literal">False</span>,null=<span class="literal">True</span>,blank=<span class="literal">True</span>)</span><br><span class="line">    icon = models.ForeignKey(Icon, verbose_name=<span class="string">&quot;icon&quot;</span>, on_delete=models.CASCADE,null=<span class="literal">True</span>,blank=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = verbose_name_plural = <span class="string">&#x27;注册用户&#x27;</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.username</span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;# login.html #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;user:login&#x27; %&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">	</span><span class="template-tag">&#123;% <span class="name"><span class="name">csrf_token</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><span class="template-variable">&#123;&#123; msg &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">    </span></span><br><span class="line"><span class="xml">    </span><span class="template-variable">&#123;&#123; lform.username &#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span></span><br><span class="line"><span class="xml">    </span><span class="template-variable">&#123;&#123; lform.password &#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cm-button cm-button-size--middle cm-button-type--primary&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 90px; border-radius: 4px; margin-top:10px&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;# register.html  #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span></span><br><span class="line"><span class="javascript"><span class="xml">    <span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">        <span class="built_in">document</span>.getElementById(<span class="string">&quot;password&quot;</span>).onchange = validatePassword;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">        <span class="built_in">document</span>.getElementById(<span class="string">&quot;check_password&quot;</span>).onchange = validatePassword;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">    &#125;</span></span></span><br><span class="line"><span class="javascript"><span class="xml"></span></span></span><br><span class="line"><span class="javascript"><span class="xml">    <span class="function"><span class="keyword">function</span> <span class="title">validatePassword</span>(<span class="params"></span>)</span>&#123;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">        <span class="keyword">var</span> pw = <span class="built_in">document</span>.getElementById(<span class="string">&quot;password&quot;</span>).value;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">        <span class="keyword">var</span> cek_pw = <span class="built_in">document</span>.getElementById(<span class="string">&quot;check_password&quot;</span>).value;</span></span></span><br><span class="line"><span class="javascript"><span class="xml"></span></span></span><br><span class="line"><span class="javascript"><span class="xml">        <span class="keyword">if</span> (pw != cek_pw)&#123;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">            <span class="built_in">document</span>.getElementById(<span class="string">&quot;check_password&quot;</span>).setCustomValidity(<span class="string">&quot;Password Don&#x27;t Mathch&quot;</span>);</span></span></span><br><span class="line"><span class="javascript"><span class="xml">        &#125;<span class="keyword">else</span>&#123;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">            <span class="built_in">document</span>.getElementById(<span class="string">&quot;check_password&quot;</span>).setCustomValidity(<span class="string">&quot;&quot;</span>);</span></span></span><br><span class="line"><span class="javascript"><span class="xml">        &#125;</span></span></span><br><span class="line"><span class="javascript"><span class="xml">    &#125;</span></span></span><br><span class="line"><span class="javascript"><span class="xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;user:register&#x27; %&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">	</span><span class="template-tag">&#123;% <span class="name"><span class="name">csrf_token</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><span class="template-variable">&#123;&#123; msg &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">    </span></span><br><span class="line"><span class="xml">    </span><span class="template-variable">&#123;&#123; rform.username &#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    </span><span class="template-variable">&#123;&#123; rform.email &#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span></span><br><span class="line"><span class="xml">    </span><span class="template-variable">&#123;&#123; rform.password &#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    </span><span class="template-variable">&#123;&#123; rform.repassword &#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span> <span class="attr">class</span>=<span class="string">&quot;cm-button cm-button-size--middle cm-button-type--primary&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 90px; border-radius: 4px; margin-top:10px&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="comment">&#123;% comment %&#125; &lt;form action=&quot;&#123;% url &#x27;user:register&#x27; %&#125;&quot; method=&quot;post&quot;&gt;</span></span><br><span class="line"><span class="comment">	&#123;% csrf_token %&#125;</span></span><br><span class="line"><span class="comment">    &lt;input type=&quot;text&quot; placeholder=&quot;用户名&quot; name=&quot;user&quot; class=&quot;cm-input&quot; required&gt;</span></span><br><span class="line"><span class="comment">	&lt;input type=&quot;text&quot; placeholder=&quot;邮箱&quot; name=&quot;email&quot; class=&quot;cm-input&quot;&gt;</span></span><br><span class="line"><span class="comment">    &lt;br/&gt;</span></span><br><span class="line"><span class="comment">    &lt;input type=&quot;password&quot; placeholder=&quot;密码&quot; name=&quot;password&quot; id=&quot;password&quot; class=&quot;cm-input&quot; required&gt;</span></span><br><span class="line"><span class="comment">    &lt;input type=&quot;password&quot; placeholder=&quot;确认密码&quot; name=&quot;check_password&quot; id=&quot;check_password&quot; class=&quot;cm-input&quot; required&gt;</span></span><br><span class="line"><span class="comment">    &lt;br/&gt;</span></span><br><span class="line"><span class="comment">    &lt;input type=&quot;submit&quot; value=&quot;提交&quot; class=&quot;cm-button cm-button-size--middle cm-button-type--primary&quot; style=&quot;width: 90px; border-radius: 4px; margin-top:10px&quot; /&gt;</span></span><br><span class="line"><span class="comment">&lt;/form&gt; &#123;% endcomment %&#125;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;# logined.html #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">extends</span></span> &#x27;base.html&#x27; %&#125;</span><span class="xml"> </span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">load</span></span> staticfiles %&#125;</span><span class="xml"> </span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> title %&#125;</span><span class="xml"> </span></span><br><span class="line"><span class="xml">    test | 凉薄 </span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> title %&#125;</span><span class="xml"> </span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> content %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> request.session.username %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>欢迎! </span><span class="template-variable">&#123;&#123; request.session.username &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;user:logout&#x27; %&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span>注销<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">else</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;user:register&#x27; %&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;user:login&#x27; %&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> content %&#125;</span></span><br></pre></td></tr></table></figure>



<hr>
<p>使用Django自带的login:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> logout,login,authenticate</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_login</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;user/login.html&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        lform = LoginForm(request.POST)</span><br><span class="line">        <span class="keyword">if</span> lform.is_valid():</span><br><span class="line">            username = lform.clean_data.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">            password = lform.clean_data.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 自动验证用户和密码,如果成功则会返回一个user对象</span></span><br><span class="line">            user = authenticate(username=username,password=password)</span><br><span class="line">            <span class="keyword">if</span> user:</span><br><span class="line">                <span class="comment"># 将用户对象保存在底层的request中(没有返回值)</span></span><br><span class="line">                <span class="comment"># 自动将数据存储到request对象的user属性中</span></span><br><span class="line">                login(request,user)</span><br><span class="line">                <span class="keyword">return</span> redirect(reverse(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> render(request,<span class="string">&#x27;user/login.html&#x27;</span>,&#123;<span class="string">&#x27;errors&#x27;</span>:lform.errors&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;% comment %&#125; 这个用户是被认证过的吗 &#123;% endcomment %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> request.user.is_authenticated %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    欢迎 <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span></span><span class="template-variable">&#123;&#123; request.user.username &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span>注销<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">else</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;user:login&#x27; %&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;user:register&#x27; %&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span>注册<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span></span><br></pre></td></tr></table></figure>



<hr>
<p>获取MEDIA文件:</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">scr</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; MEDIA_URL &#125;&#125;</span><span class="template-variable">&#123;&#123; request.user.image &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br></pre></td></tr></table></figure>



<p>注意Django的标签其实可以内嵌到HTML标签里面:</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">li</span> </span></span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> num==pages.number %&#125;</span><span class="xml"><span class="tag"> <span class="attr">class</span>=<span class="string">&quot;active&quot;</span> </span></span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"><span class="tag">&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;?pagenum=</span></span></span><span class="template-variable">&#123;&#123; num &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br></pre></td></tr></table></figure>



<p>如果是非form表单来提交Ajax的话,若需要使用csrf,可以如下使用:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    $(<span class="string">&#x27;#staybin&#x27;</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> name = $(<span class="string">&#x27;#name&#x27;</span>);</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            <span class="attr">type</span>:<span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">            <span class="attr">url</span>:<span class="string">&#x27;xxx&#x27;</span>,</span><br><span class="line">            <span class="attr">data</span>:&#123;</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span>:name,</span><br><span class="line">                <span class="string">&#x27;csrfmiddlewaretoken&#x27;</span>:<span class="string">&#x27;&#123;&#123; csrf_token  &#125;&#125;&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">success</span>:<span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<p>对于一个form标签:<br>如果没有action,那么url默认就是当前url,method默认就是get</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;&#123;% url &#x27;tools:index&#x27; %&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">&quot;rightform&quot;</span> <span class="attr">id</span>=<span class="string">&quot;stayForm&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>如果想对Form标签的submit按钮使用ajax,我们可以使用return false来阻止form标签的提交</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    $(<span class="string">&#x27;#submit&#x27;</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> name = $(<span class="string">&#x27;#name&#x27;</span>);</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            <span class="attr">type</span>:<span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">            <span class="attr">url</span>:<span class="string">&#x27;xxx&#x27;</span>,</span><br><span class="line">            <span class="attr">data</span>:&#123;</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span>:name,</span><br><span class="line">                <span class="string">&#x27;csrfmiddlewaretoken&#x27;</span>:<span class="string">&#x27;&#123;&#123; csrf_token &#125;&#125;&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">success</span>:<span class="function"><span class="keyword">function</span>(<span class="params">callback</span>)</span>&#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 阻止form标签的提交</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>在js中,我们不仅可以使用url标签获取url,还可以使用普通的变量:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    $(<span class="string">&#x27;#submit&#x27;</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> name = $(<span class="string">&#x27;#name&#x27;</span>);</span><br><span class="line">        <span class="keyword">var</span> comment = &#123;&#123; course.id &#125;&#125;;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>模板中获取路径:</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">request.path</span></span><br></pre></td></tr></table></figure>



<hr>
<p>使用simple-captcha产生验证码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> captcha.models <span class="keyword">import</span> CaptchaStore</span><br><span class="line"><span class="keyword">from</span> captcha.helpers <span class="keyword">import</span> captcha_image_url</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexView</span>(<span class="params">View</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        <span class="comment"># hashkey验证码生成的秘钥，image_url验证码的图片地址</span></span><br><span class="line">        hashkey = CaptchaStore.generate_key()</span><br><span class="line">        image_url = captcha_image_url(hashkey)</span><br><span class="line">        <span class="comment">#  Python内置了一个locals()函数，它返回当前所有的本地变量字典</span></span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">&#x27;tools/index.html&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $(<span class="string">&#x27;.captcha&#x27;</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> img = $(<span class="built_in">this</span>);</span><br><span class="line">        $.getJSON(<span class="string">&#x27;/captcha/refresh&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">            img.attr(<span class="string">&#x27;src&#x27;</span>, data[<span class="string">&#x27;image_url&#x27;</span>]);</span><br><span class="line">            $(<span class="string">&#x27;#id_captcha_0&#x27;</span>).val(data[<span class="string">&#x27;key&#x27;</span>])</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;hidden_captcha&quot;</span> <span class="attr">style</span>=<span class="string">&quot;display:none;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;tools:index&#x27; %&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">		</span><span class="template-tag">&#123;% <span class="name"><span class="name">csrf_token</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; image_url &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;captcha&quot;</span> <span class="attr">class</span>=<span class="string">&quot;captcha&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">input</span> <span class="attr">autocomplete</span>=<span class="string">&quot;off&quot;</span> <span class="attr">id</span>=<span class="string">&quot;id_captcha_1&quot;</span> <span class="attr">name</span>=<span class="string">&quot;captcha_1&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;小学算术&quot;</span> <span class="attr">required</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;id_captcha_0&quot;</span> <span class="attr">name</span>=<span class="string">&quot;captcha_0&quot;</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; hashkey &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;cm-button-type--primary&quot;</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;showloading();&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 90px; border-radius: 4px; margin-top:10px&quot;</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span> </span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure>



<p>js失效可能原因:</p>
<ul>
<li><p>直接使用js,元素尚未加载:使用<code>$(document).ready</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<p>Django内置一个login_required装饰器,<strong>当用户没有登录的时候就会自动跳转到登录页面</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth.decorators <span class="keyword">import</span> login_required</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@login_required(<span class="params">login_url=<span class="string">&#x27;/user/user_login/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tool</span>(<span class="params">request</span>):</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>但是这个装饰器有个缺点就是当用户登录后只会跳转到固定的页面,我们希望从哪来到哪去.</p>
<blockquote>
<p>例如上面,从tool函数的页面跳转到登录页面,当用户登录后就会自动跳转回tool函数的页面</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> redirect,reverse</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login_decorator</span>(<span class="params">func</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner</span>(<span class="params">request,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 如果用户已经登录</span></span><br><span class="line">        <span class="keyword">if</span> request.user.is_authenticated():</span><br><span class="line">            <span class="keyword">return</span> func(request,*args,**kwargs)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> request.is_ajax():</span><br><span class="line">                <span class="keyword">return</span> JsonResponse(&#123;<span class="string">&#x27;status&#x27;</span>:<span class="string">&#x27;nologin&#x27;</span>&#125;)</span><br><span class="line">            <span class="comment"># 拿到目前访问的完整url，不只是路径部分</span></span><br><span class="line">            url = request.get_full_path()</span><br><span class="line">            ret = redirect(reverse(<span class="string">&#x27;users:user_login&#x27;</span>))</span><br><span class="line">            ret.set_cookie(<span class="string">&#x27;url&#x27;</span>,url)</span><br><span class="line">            <span class="keyword">return</span> ret</span><br><span class="line">    <span class="keyword">return</span> inner</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里仅仅只是添加一个原路径的cookie而已</p>
</blockquote>
<p>之后在login函数里写:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">request</span>):</span></span><br><span class="line">    ...</span><br><span class="line">    url = request.COOKIES.get(<span class="string">&#x27;url&#x27;</span>,<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    ret = redirect(url)</span><br><span class="line">    ret.delete_cookie(<span class="string">&#x27;url&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> ret</span><br></pre></td></tr></table></figure>



<p>如果默认的login_required要自己实现的话那就是:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> redirect</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login_decorator</span>(<span class="params">login_url</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrap</span>(<span class="params">func</span>):</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">inner</span>(<span class="params">request,*args,**kwargs</span>):</span></span><br><span class="line">            <span class="comment"># 如果用户已经登录</span></span><br><span class="line">            <span class="keyword">if</span> request.user.is_authenticated():</span><br><span class="line">                <span class="keyword">return</span> func(request,*args,**kwargs)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> redirect(login_url)</span><br><span class="line">        <span class="keyword">return</span> inner</span><br><span class="line">    <span class="keyword">return</span> wrap</span><br></pre></td></tr></table></figure>



<hr>
<p>在Xadmin中添加富文本插件:</p>
<ol>
<li><p>在models中将需要改为富文本格式的字段修改field类型</p>
</li>
<li><p>在<code>plugins</code>文件夹下添加代码</p>
</li>
<li><p>在<code>plugins</code>的<code>__init__</code>下注册该插件</p>
</li>
<li><p>在Xadmin的admin类里,将需要改为富文本的字段使用<code>style_fields</code>注册:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XXadmin</span>:</span></span><br><span class="line">    display_list = [....]</span><br><span class="line">    style_fields = &#123;<span class="string">&#x27;这是字段&#x27;</span>:<span class="string">&#x27;ueditor&#x27;</span>&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>数据库迁移同步</p>
</li>
</ol>
<blockquote>
<p>注意,使用富文本必须先配置media</p>
</blockquote>
<hr>
<p>在创建数据库的时候千万要设置charset</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create database XXX charset=utf-8;</span><br></pre></td></tr></table></figure>










</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>