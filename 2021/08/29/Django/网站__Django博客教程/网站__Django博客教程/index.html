<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;搭建开发环境&quot;&gt;&lt;a href=&quot;#搭建开发环境&quot; class=&quot;headerlink&quot; title=&quot;搭建开发环境&quot;&gt;&lt;/a&gt;搭建开发环境&lt;/h1&gt;&lt;h2 id=&quot;使用虚拟环境-Virtualenv&quot;&gt;&lt;a href=&quot;#使用虚拟环境-Virtualenv&quot; class=&quot;headerlink&quot; title=&quot;使用虚拟环境 Virtualenv&quot;&gt;&lt;/a&gt;使用虚拟环境 Virtualenv&lt;/h2&gt;&lt;p&gt;Virtualenv 是一个 Python 工具，使用它可以创建一个独立的 Python 环境。&lt;br&gt;Virtualenv 帮我们从系统的 Python 环境中克隆一个全新的 Python 环境出来，这个环境独立于原来的 Python 环境。"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>Django博客教程 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Django/" rel="tag">Django</a></div><div class="post-time">2021-08-29</div></div></div><div class="container post-header"><h1>Django博客教程</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83"><span class="toc-number">1.</span> <span class="toc-text">搭建开发环境</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83-Virtualenv"><span class="toc-number">1.1.</span> <span class="toc-text">使用虚拟环境 Virtualenv</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B-Django-%E5%B7%A5%E7%A8%8B"><span class="toc-number">1.2.</span> <span class="toc-text">建立 Django 工程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hello-Django"><span class="toc-number">1.3.</span> <span class="toc-text">Hello Django</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B-Django-%E5%8D%9A%E5%AE%A2%E5%BA%94%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">建立 Django 博客应用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-Django-%E5%8D%9A%E5%AE%A2%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A8%A1%E5%9E%8B"><span class="toc-number">3.</span> <span class="toc-text">创建 Django 博客的数据库模型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E5%8D%9A%E5%AE%A2%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E7%BB%93%E6%9E%84"><span class="toc-number">3.1.</span> <span class="toc-text">设计博客的数据库表结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E5%8D%9A%E5%AE%A2%E6%A8%A1%E5%9E%8B%E4%BB%A3%E7%A0%81"><span class="toc-number">3.2.</span> <span class="toc-text">编写博客模型代码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%A9-Django-%E5%AE%8C%E6%88%90%E7%BF%BB%E8%AF%91%EF%BC%9A%E8%BF%81%E7%A7%BB%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">4.</span> <span class="toc-text">让 Django 完成翻译：迁移数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%81%E7%A7%BB%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">4.1.</span> <span class="toc-text">迁移数据库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%89%E6%8B%A9%E6%95%B0%E6%8D%AE%E5%BA%93%E7%89%88%E6%9C%AC"><span class="toc-number">4.2.</span> <span class="toc-text">选择数据库版本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8-Django-%E7%9A%84%E6%96%B9%E5%BC%8F%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">4.3.</span> <span class="toc-text">用 Django 的方式操作数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%98%E6%95%B0%E6%8D%AE"><span class="toc-number">4.3.1.</span> <span class="toc-text">存数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%96%E6%95%B0%E6%8D%AE"><span class="toc-number">4.3.2.</span> <span class="toc-text">取数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%B9%E6%95%B0%E6%8D%AE"><span class="toc-number">4.3.3.</span> <span class="toc-text">改数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E6%95%B0%E6%8D%AE"><span class="toc-number">4.3.4.</span> <span class="toc-text">删数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.3.5.</span> <span class="toc-text">总结:</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Django-%E5%8D%9A%E5%AE%A2%E9%A6%96%E9%A1%B5%E8%A7%86%E5%9B%BE"><span class="toc-number">5.</span> <span class="toc-text">Django 博客首页视图</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Django-%E5%A4%84%E7%90%86-HTTP-%E8%AF%B7%E6%B1%82"><span class="toc-number">5.1.</span> <span class="toc-text">Django 处理 HTTP 请求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hello-%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0"><span class="toc-number">5.2.</span> <span class="toc-text">Hello 视图函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%91%E5%AE%9A-URL-%E4%B8%8E%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0"><span class="toc-number">5.2.1.</span> <span class="toc-text">绑定 URL 与视图函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0"><span class="toc-number">5.2.2.</span> <span class="toc-text">编写视图函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E9%A1%B9%E7%9B%AE-URL"><span class="toc-number">5.2.3.</span> <span class="toc-text">配置项目 URL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="toc-number">5.2.4.</span> <span class="toc-text">运行结果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Django-%E6%A8%A1%E6%9D%BF%E7%B3%BB%E7%BB%9F"><span class="toc-number">5.3.</span> <span class="toc-text">使用 Django 模板系统</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9C%9F%E6%AD%A3%E7%9A%84-Django-%E5%8D%9A%E5%AE%A2%E9%A6%96%E9%A1%B5%E8%A7%86%E5%9B%BE"><span class="toc-number">6.</span> <span class="toc-text">真正的 Django 博客首页视图</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A6%96%E9%A1%B5%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0"><span class="toc-number">6.1.</span> <span class="toc-text">首页视图函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6"><span class="toc-number">6.2.</span> <span class="toc-text">处理静态文件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9C%A8-Django-Admin-%E5%90%8E%E5%8F%B0%E5%8F%91%E5%B8%83%E6%96%87%E7%AB%A0"><span class="toc-number">7.</span> <span class="toc-text">在 Django Admin 后台发布文章</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0%E8%AF%A6%E6%83%85%E9%A1%B5"><span class="toc-number">8.</span> <span class="toc-text">博客文章详情页</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%94%AF%E6%8C%81-Markdown-%E8%AF%AD%E6%B3%95%E5%92%8C%E4%BB%A3%E7%A0%81%E9%AB%98%E4%BA%AE"><span class="toc-number">9.</span> <span class="toc-text">支持 Markdown 语法和代码高亮</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A1%B5%E9%9D%A2%E4%BE%A7%E8%BE%B9%E6%A0%8F%EF%BC%9A%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A8%A1%E6%9D%BF%E6%A0%87%E7%AD%BE"><span class="toc-number">10.</span> <span class="toc-text">页面侧边栏：使用自定义模板标签</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF%E6%A0%87%E7%AD%BE%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">10.1.</span> <span class="toc-text">模板标签目录结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E6%A8%A1%E6%9D%BF%E6%A0%87%E7%AD%BE%E4%BB%A3%E7%A0%81"><span class="toc-number">10.2.</span> <span class="toc-text">编写模板标签代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BD%92%E6%A1%A3%E6%A8%A1%E6%9D%BF%E6%A0%87%E7%AD%BE"><span class="toc-number">10.3.</span> <span class="toc-text">归档模板标签</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E7%B1%BB%E6%A8%A1%E6%9D%BF%E6%A0%87%E7%AD%BE"><span class="toc-number">10.4.</span> <span class="toc-text">分类模板标签</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E6%A8%A1%E6%9D%BF%E6%A0%87%E7%AD%BE"><span class="toc-number">10.5.</span> <span class="toc-text">使用自定义的模板标签</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E7%B1%BB%E4%B8%8E%E5%BD%92%E6%A1%A3"><span class="toc-number">11.</span> <span class="toc-text">分类与归档</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AF%84%E8%AE%BA"><span class="toc-number">12.</span> <span class="toc-text">评论</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B7%B2%E7%9F%A5%E5%B0%8F%E9%97%AE%E9%A2%98%E4%BF%AE%E6%AD%A3"><span class="toc-number">13.</span> <span class="toc-text">已知小问题修正</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Nginx-%E5%92%8C-Gunicorn-%E9%83%A8%E7%BD%B2-Django-%E5%8D%9A%E5%AE%A2"><span class="toc-number">14.</span> <span class="toc-text">使用 Nginx 和 Gunicorn 部署 Django 博客</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Fabric-%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2"><span class="toc-number">15.</span> <span class="toc-text">使用 Fabric 自动化部署</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%9F%E8%AE%A1%E6%96%87%E7%AB%A0%E9%98%85%E8%AF%BB%E9%87%8F"><span class="toc-number">16.</span> <span class="toc-text">统计文章阅读量</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E6%96%87%E7%AB%A0%E6%91%98%E8%A6%81"><span class="toc-number">17.</span> <span class="toc-text">自动生成文章摘要</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E5%86%99-save-%E6%96%B9%E6%B3%95"><span class="toc-number">17.1.</span> <span class="toc-text">复写 save 方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-truncatechars-%E6%A8%A1%E6%9D%BF%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">17.2.</span> <span class="toc-text">使用 truncatechars 模板过滤器</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E7%B1%BB%E7%9A%84%E9%80%9A%E7%94%A8%E8%A7%86%E5%9B%BE%EF%BC%9AListView-%E5%92%8C-DetailView"><span class="toc-number">18.</span> <span class="toc-text">基于类的通用视图：ListView 和 DetailView</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86-index-%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0%E6%94%B9%E5%86%99%E4%B8%BA%E7%B1%BB%E8%A7%86%E5%9B%BE"><span class="toc-number">18.1.</span> <span class="toc-text">将 index 视图函数改写为类视图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86-category-%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0%E6%94%B9%E5%86%99%E4%B8%BA%E7%B1%BB%E8%A7%86%E5%9B%BE"><span class="toc-number">18.2.</span> <span class="toc-text">将 category 视图函数改写为类视图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DetailView"><span class="toc-number">18.3.</span> <span class="toc-text">DetailView</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Django-Pagination-%E7%AE%80%E5%8D%95%E5%88%86%E9%A1%B5"><span class="toc-number">18.4.</span> <span class="toc-text">Django Pagination 简单分页</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8%E6%A8%A1%E6%9D%BF%E4%B8%AD%E8%AE%BE%E7%BD%AE%E5%88%86%E9%A1%B5%E5%AF%BC%E8%88%AA"><span class="toc-number">18.5.</span> <span class="toc-text">在模板中设置分页导航</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Django-Pagination-%E5%AE%8C%E5%96%84%E5%88%86%E9%A1%B5"><span class="toc-number">19.</span> <span class="toc-text">Django Pagination 完善分页</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%9F%E8%AE%A1%E5%90%84%E4%B8%AA%E5%88%86%E7%B1%BB%E4%B8%8B%E7%9A%84%E6%96%87%E7%AB%A0%E6%95%B0"><span class="toc-number">20.</span> <span class="toc-text">统计各个分类下的文章数</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Annotate"><span class="toc-number">20.1.</span> <span class="toc-text">使用 Annotate</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8%E6%A8%A1%E6%9D%BF%E4%B8%AD%E5%BC%95%E7%94%A8%E6%96%B0%E5%A2%9E%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="toc-number">20.2.</span> <span class="toc-text">在模板中引用新增的属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86-Annotate-%E7%94%A8%E4%BA%8E%E5%85%B6%E5%AE%83%E5%85%B3%E8%81%94%E5%85%B3%E7%B3%BB"><span class="toc-number">20.3.</span> <span class="toc-text">将 Annotate 用于其它关联关系</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A0%87%E7%AD%BE%E4%BA%91"><span class="toc-number">21.</span> <span class="toc-text">标签云</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RSS-%E8%AE%A2%E9%98%85"><span class="toc-number">22.</span> <span class="toc-text">RSS 订阅</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Django-Feed-%E7%B1%BB"><span class="toc-number">22.1.</span> <span class="toc-text">使用 Django Feed 类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0-URL"><span class="toc-number">22.2.</span> <span class="toc-text">添加 URL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%A8%A1%E6%9D%BF"><span class="toc-number">22.3.</span> <span class="toc-text">修改模板</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RSS-%E6%B5%8B%E8%AF%95%E6%8F%92%E4%BB%B6"><span class="toc-number">22.4.</span> <span class="toc-text">RSS 测试插件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Markdown-%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95"><span class="toc-number">23.</span> <span class="toc-text">Markdown 自动生成文章目录</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8%E9%A1%B5%E9%9D%A2%E7%9A%84%E4%BB%BB%E4%BD%95%E5%9C%B0%E6%96%B9%E6%8F%92%E5%85%A5%E7%9B%AE%E5%BD%95"><span class="toc-number">23.1.</span> <span class="toc-text">在页面的任何地方插入目录</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2"><span class="toc-number">24.</span> <span class="toc-text">简单全文搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">24.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86%E5%85%B3%E9%94%AE%E8%AF%8D%E6%8F%90%E4%BA%A4%E7%BB%99%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">24.2.</span> <span class="toc-text">将关键词提交给服务器</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Django-Haystack-%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2%E4%B8%8E%E5%85%B3%E9%94%AE%E8%AF%8D%E9%AB%98%E4%BA%AE"><span class="toc-number">25.</span> <span class="toc-text">Django Haystack 全文检索与关键词高亮</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%BF%85%E8%A6%81%E4%BE%9D%E8%B5%96"><span class="toc-number">25.1.</span> <span class="toc-text">安装必要依赖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-Haystack"><span class="toc-number">25.2.</span> <span class="toc-text">配置 Haystack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E6%95%B0%E6%8D%AE"><span class="toc-number">25.3.</span> <span class="toc-text">处理数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-URL"><span class="toc-number">25.4.</span> <span class="toc-text">配置 URL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%90%9C%E7%B4%A2%E8%A1%A8%E5%8D%95"><span class="toc-number">25.5.</span> <span class="toc-text">修改搜索表单</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9C%E9%A1%B5%E9%9D%A2"><span class="toc-number">25.6.</span> <span class="toc-text">创建搜索结果页面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E4%BA%AE%E5%85%B3%E9%94%AE%E8%AF%8D"><span class="toc-number">25.7.</span> <span class="toc-text">高亮关键词</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E4%B8%BA%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D"><span class="toc-number">25.8.</span> <span class="toc-text">修改搜索引擎为中文分词</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B%E7%B4%A2%E5%BC%95%E6%96%87%E4%BB%B6"><span class="toc-number">25.9.</span> <span class="toc-text">建立索引文件</span></a></li></ol></li></ol></details></div><div class="container post-content"><h1 id="搭建开发环境"><a href="#搭建开发环境" class="headerlink" title="搭建开发环境"></a>搭建开发环境</h1><h2 id="使用虚拟环境-Virtualenv"><a href="#使用虚拟环境-Virtualenv" class="headerlink" title="使用虚拟环境 Virtualenv"></a>使用虚拟环境 Virtualenv</h2><p>Virtualenv 是一个 Python 工具，使用它可以创建一个独立的 Python 环境。<br>Virtualenv 帮我们从系统的 Python 环境中克隆一个全新的 Python 环境出来，这个环境独立于原来的 Python 环境。</p>
<p>首先创建虚拟环境,并将虚拟环境命名为 blogproject_env（也可以取任何你喜欢的名字）。在命令栏运行如下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd C:\Users\yangxg\Envs</span><br><span class="line">virtualenv blogproject_env</span><br></pre></td></tr></table></figure>

<p>这里我使用了<code>virtualenv D:\note\Django\Django博客教程\blogproject</code></p>
<p>建好虚拟环境之后需要激活，运行 blogproject\Scripts\ 目录下的 activate 程序激活它：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">blogproject_env\Scripts\activate</span><br></pre></td></tr></table></figure>

<p>接下来就是在虚拟环境里安装Django了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install django==1.10.6</span><br></pre></td></tr></table></figure>

<p>检测是否安装成功:</p>
<p><img src="/images/1554905377582.png" alt="1554905377582"></p>
<h2 id="建立-Django-工程"><a href="#建立-Django-工程" class="headerlink" title="建立 Django 工程"></a>建立 Django 工程</h2><p>Django 工程（Project）是我们项目代码的容器，例如我们博客项目中所有的代码（包括 Django 为我们自动生成的以及我们自己写的）都包含在这个工程里。<br>其实<strong>说通俗一点就是用一个文件夹把一系列 Python 代码文件和 Django 配置文件包裹起来，这个文件夹就可以看做一个 Django 工程。</strong><br>我们不必亲自动手新建这个文件夹和代码文件，Django 的内置命令已经帮我们做了这些事情。例如我把博客工程的代码放在 C:\Users\yangxg\Workspace\ ，工程名我把它叫做 blogproject 。</p>
<p>创建工程项目:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd C:\Users\yangxg\Workspace</span><br><span class="line">django-admin startproject blogproject</span><br></pre></td></tr></table></figure>

<p>形成的文件目录结构如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">workspace</span><br><span class="line">	└───blogproject</span><br><span class="line">            ├───manage.py </span><br><span class="line">            └───blogproject</span><br><span class="line">                    ├───settings.py</span><br><span class="line">                    ├───urls.py</span><br><span class="line">                    ├───wsgi.py</span><br><span class="line">                    └───__init__.py</span><br></pre></td></tr></table></figure>

<p>manage 是管理的意思，顾名思义 manage.py 就是 Django 为我们生成的管理这个项目的 Python 脚本文件.<br>与 manage.py 同级的还有一个 blogproject\ 的目录，这里面存放了一些 Django 的配置文件，例如 settings.py、urls.py 等等，</p>
<h2 id="Hello-Django"><a href="#Hello-Django" class="headerlink" title="Hello Django"></a>Hello Django</h2><p>网站需要运行在一个 Web 服务器上，Django 已经为我们提供了一个用于本地开发的 Web 服务器。<br>在命令行工具里进入到 manage.py 所在目录，即<strong>最外层</strong>的 blogproject\ 目录下。运行 <code>python manage.py runserver</code> 命令就可以在本机上开启一个 Web 服务器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(blogproject) D:\note\Django\Django博客教程\trainingfile\workspace\blogproject&gt;python manage.py runserver</span><br><span class="line">Performing system checks...</span><br><span class="line"></span><br><span class="line">System check identified no issues (0 silenced).</span><br><span class="line"></span><br><span class="line">You have 13 unapplied migration(s). Your project may not work properly until you apply the migrations for app(s): admin, auth, contenttypes, sessions.</span><br><span class="line">Run &#x27;python manage.py migrate&#x27; to apply them.</span><br><span class="line">April 10, 2019 - 22:17:31</span><br><span class="line">Django version 1.10.6, using settings &#x27;blogproject.settings&#x27;</span><br><span class="line">Starting development server at http://127.0.0.1:8000/</span><br><span class="line">Quit the server with CTRL-BREAK.</span><br></pre></td></tr></table></figure>

<p>这时<a target="_blank" rel="noopener" href="http://127.0.0.1:8000/%E5%B0%B1%E5%8F%98%E6%88%90%E4%BA%86">http://127.0.0.1:8000/就变成了</a></p>
<p><img src="/images/1554905938559.png" alt="1554905938559"></p>
<p>Django 默认的语言是英语，所以显示给我们的欢迎页面是英文的。我们在 Django 的setting.py里稍作修改，让它支持中文。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LANGUAGE_CODE = <span class="string">&#x27;zh-hans&#x27;</span></span><br><span class="line">TIME_ZONE = <span class="string">&#x27;Asia/Shanghai&#x27;</span></span><br></pre></td></tr></table></figure>
<p>刷新得到:</p>
<p><img src="/images/1554906335428.png" alt="1554906335428"></p>
<h1 id="建立-Django-博客应用"><a href="#建立-Django-博客应用" class="headerlink" title="建立 Django 博客应用"></a>建立 Django 博客应用</h1><p>Django 鼓励我们把自己编写的代码组织到应用（Application）里，并且最好是一个应用只提供一种功能。<br>例如我们要开发的 Django 博客，相关的代码都放在 blog 这个应用里。其实应用也没什么复杂的，不过是把功能相关的代码组织到一个文件夹里，这个文件夹就成了一个应用（姑且可以这样理解）。</p>
<p>所以我们就可以创建一个Django 博客应用:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py startapp blog</span><br></pre></td></tr></table></figure>

<p>这时manage.py所在文件夹就会多一个blog文件夹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">blog</span><br><span class="line">  ├───__init__.py</span><br><span class="line">  ├───admin.py </span><br><span class="line">  ├───apps.py</span><br><span class="line">  ├───models.py</span><br><span class="line">  ├───tests.py</span><br><span class="line">  ├───views.py</span><br><span class="line">  └───migrations</span><br><span class="line">		└───__init__.py  </span><br></pre></td></tr></table></figure>

<p>现在它还只是包含各种文件的一个文件夹而已，Django 目前还不知道这是一个应用。我们得告诉 Django 这是我们建立的应用，专业一点说就是在 Django 的配置文件中注册这个应用。</p>
<p>注册方法很简单,只要在setting.py里的INSTALLED_APPS添加一个元素即可。<br>（同时我们可以看到Django 已经为我们提供了一些内置的应用）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="string">&#x27;django.contrib.admin&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.auth&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.contenttypes&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.sessions&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.messages&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.staticfiles&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;blog&#x27;</span> <span class="comment"># 注册blog应用</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h1 id="创建-Django-博客的数据库模型"><a href="#创建-Django-博客的数据库模型" class="headerlink" title="创建 Django 博客的数据库模型"></a>创建 Django 博客的数据库模型</h1><h2 id="设计博客的数据库表结构"><a href="#设计博客的数据库表结构" class="headerlink" title="设计博客的数据库表结构"></a>设计博客的数据库表结构</h2><p>博客最主要的功能就是展示我们写的文章，它需要从某个地方获取博客文章数据才能把文章展示出来，通常来说这个地方就是数据库。我们把写好的文章永久地保存在数据库里，当用户访问我们的博客时，Django 就去数据库里把这些数据取出来展现给用户。</p>
<p>现在我们想创建如下的数据库</p>
<p><img src="/images/%E6%9C%AA%E5%91%BD%E5%90%8D%E8%A1%A8%E5%8D%95.jpg" alt="未命名表单"></p>
<h2 id="编写博客模型代码"><a href="#编写博客模型代码" class="headerlink" title="编写博客模型代码"></a>编写博客模型代码</h2><p>Django 把一套数据库的语法转换成了 Python 的语法形式，我们只要写 Python 代码就可以了.Django 会把 Python 代码翻译成对应的数据库操作语言。用更加专业一点的说法，就是 Django 为我们提供了一套 ORM（Object Relational Mapping）系统。</p>
<p>例如我们的分类数据库表，Django 只要求我们这样写：<br>==在blog/models.py==写下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Category</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<p>这样，Django 就可以把这个类翻译成数据库的操作语言，<br>在数据库里创建一个名为 category 的表格，这个表格的一个列名为 name。<br><strong>还有一个列 id，Django 则会自动创建</strong>。<br>可以看出从 Python 代码翻译成数据库语言时其规则就是一个 ==Python 类对应一个数据库表格，类名即表名，类的属性对应着表格的列，属性名即列名==。</p>
<p>我们需要文章（Post）、分类（Category）以及标签（Tag）三个表格:<br>(注意,ID列会被自动创建)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Category</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Django 要求模型必须继承 models.Model 类。</span></span><br><span class="line"><span class="string">    Category 只需要一个简单的分类名 name 就可以了。</span></span><br><span class="line"><span class="string">    CharField 指定了分类名 name 的数据类型，CharField 是字符型，</span></span><br><span class="line"><span class="string">    CharField 的 max_length 参数指定其最大长度，超过这个长度的分类名就不能被存入数据库。</span></span><br><span class="line"><span class="string">    当然 Django 还为我们提供了多种其它的数据类型，如日期时间类型 DateTimeField、整数类型 IntegerField 等等。</span></span><br><span class="line"><span class="string">    Django 内置的全部类型可查看文档：</span></span><br><span class="line"><span class="string">    https://docs.djangoproject.com/en/1.10/ref/models/fields/#field-types</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tag</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    标签 Tag 也比较简单，和 Category 一样。</span></span><br><span class="line"><span class="string">    再次强调一定要继承 models.Model 类！</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    文章的数据库表稍微复杂一点，主要是涉及的字段更多。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 文章标题</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">70</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 文章正文，我们使用了 TextField。</span></span><br><span class="line">    <span class="comment"># 存储比较短的字符串可以使用 CharField，但对于文章的正文来说可能会是一大段文本，因此使用 TextField 来存储大段文本。</span></span><br><span class="line">    body = models.TextField()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 这两个列分别表示文章的创建时间和最后一次修改时间，存储时间的字段用 DateTimeField 类型。</span></span><br><span class="line">    created_time = models.DateTimeField()</span><br><span class="line">    modified_time = models.DateTimeField()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 文章摘要，可以没有文章摘要，但默认情况下 CharField 要求我们必须存入数据，否则就会报错。</span></span><br><span class="line">    <span class="comment"># 指定 CharField 的 blank=True 参数值后就可以允许空值了。</span></span><br><span class="line">    excerpt = models.CharField(max_length=<span class="number">200</span>, blank=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 这是分类与标签，分类与标签的模型我们已经定义在上面。</span></span><br><span class="line">    <span class="comment"># 我们在这里把文章对应的数据库表和分类、标签对应的数据库表关联了起来，但是关联形式稍微有点不同。</span></span><br><span class="line">    <span class="comment"># 我们规定一篇文章只能对应一个分类，但是一个分类下可以有多篇文章，所以我们使用的是 ForeignKey，即一对多的关联关系。</span></span><br><span class="line">    <span class="comment"># 而对于标签来说，一篇文章可以有多个标签，同一个标签下也可能有多篇文章，所以我们使用 ManyToManyField，表明这是多对多的关联关系。</span></span><br><span class="line">    <span class="comment"># 同时我们规定文章可以没有标签，因此为标签 tags 指定了 blank=True。</span></span><br><span class="line">    <span class="comment"># 如果你对 ForeignKey、ManyToManyField 不了解，请看教程中的解释，亦可参考官方文档：</span></span><br><span class="line">    <span class="comment"># https://docs.djangoproject.com/en/1.10/topics/db/models/#relationships</span></span><br><span class="line">    category = models.ForeignKey(Category)</span><br><span class="line">    tags = models.ManyToManyField(Tag, blank=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 文章作者，这里 User 是从 django.contrib.auth.models 导入的。</span></span><br><span class="line">    <span class="comment"># django.contrib.auth 是 Django 内置的应用，专门用于处理网站用户的注册、登录等流程，User 是 Django 为我们已经写好的用户模型。</span></span><br><span class="line">    <span class="comment"># 这里我们通过 ForeignKey 把文章和 User 关联了起来。</span></span><br><span class="line">    <span class="comment"># 因为我们规定一篇文章只能有一个作者，而一个作者可能会写多篇文章，因此这是一对多的关联关系，和 Category 类似。</span></span><br><span class="line">    author = models.ForeignKey(User)</span><br></pre></td></tr></table></figure>

<p>我们规定一篇文章只能对应一个分类，但是一个分类下可以有多篇文章，所以我们使用的是 <code>ForeignKey</code>，即一对多的关联关系。<br>而对于标签来说，一篇文章可以有多个标签，同一个标签下也可能有多篇文章，所以我们使用 <code>ManyToManyField</code>，表明这是多对多的关联关系。</p>
<p>数据库中表与表之间的关系</p>
<ul>
<li> 一对多，models.ForeignKey(ColorDic)</li>
<li>一对一，models.OneToOneField(OneModel)</li>
<li>多对多，authors = models.ManyToManyField(Author)</li>
</ul>
<p>回忆一下数据库原理,当实体与实体是一对多的关系时,就要把多的那个实体单独制作成一张表,然后作为一实体的外键.<br>这里就是外键的实际运用.因为是一对多,所以要拆表.</p>
<p><img src="/images/1554947100383.png" alt="1554947100383"></p>
<p>当实体之间是多对多的情况时,数据库的操作就是每个实体都将一张表,关联关系也将一张表.然后把两个实体作为管理关系的外键形成这张表的联合主键.<br>但是Django不是这样设计的,而是直接设计成一张多对多的表:</p>
<p><img src="/images/1554947424746.png" alt="1554947424746"></p>
<p>也就是说本来文章ID是这张表的主键的,现在不是这样了,允许文件ID不唯一.</p>
<h1 id="让-Django-完成翻译：迁移数据库"><a href="#让-Django-完成翻译：迁移数据库" class="headerlink" title="让 Django 完成翻译：迁移数据库"></a>让 Django 完成翻译：迁移数据库</h1><p>我们已经编写了博客数据库模型的代码，但那还只是 Python 代码而已，Django 还没有把它翻译成数据库语言，因此实际上这些数据库表还没有真正的在数据库中创建。</p>
<h2 id="迁移数据库"><a href="#迁移数据库" class="headerlink" title="迁移数据库"></a>迁移数据库</h2><p>Django 完成翻译，创建好这些数据库表<br>cmd代码:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python manage.py makemigrations</span><br><span class="line">python manage.py migrate</span><br></pre></td></tr></table></figure>

<p>当我们执行了 <code>python manage.py makemigrations</code> 后，Django 在 blog 应用的 migrations\ 目录下生成了一个 0001_initial.py 文件，这个文件是 Django 用来记录我们对模型做了哪些修改的文件。目前来说，我们在 models.py 文件里创建了 3 个模型类，Django 把这些变化记录在了 0001_initial.py 里。</p>
<p>我们可以通过下面语句来查看Django到底做了什么</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py sqlmigrate blog 0001</span><br></pre></td></tr></table></figure>

<p>观看发现这其实是一个创建表和创建索引的存储过程:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">BEGIN;</span><br><span class="line">--</span><br><span class="line">-- Create model Category</span><br><span class="line">--</span><br><span class="line">CREATE TABLE &quot;blog_category&quot; (</span><br><span class="line">    &quot;id&quot; integer NOT NULL PRIMARY KEY AUTOINCREMENT,</span><br><span class="line">    &quot;name&quot; varchar(100) NOT NULL);</span><br><span class="line">--</span><br><span class="line">-- Create model Post</span><br><span class="line">--</span><br><span class="line">CREATE TABLE &quot;blog_post&quot; (</span><br><span class="line">    &quot;id&quot; integer NOT NULL PRIMARY KEY AUTOINCREMENT, </span><br><span class="line">    &quot;title&quot; varchar(70) NOT NULL, </span><br><span class="line">    &quot;body&quot; text NOT NULL, </span><br><span class="line">    &quot;create_time&quot; datetime NOT NULL,</span><br><span class="line">    &quot;modified_time&quot; datetime NOT NULL, </span><br><span class="line">    &quot;excerpt&quot; varchar(200) NOT NULL, </span><br><span class="line">    &quot;autor_id&quot; integer NOT NULL REFERENCES &quot;auth_user&quot; (&quot;id&quot;), </span><br><span class="line">    &quot;category_id&quot; integer NOT NULL REFERENCES &quot;blog_category&quot; (&quot;id&quot;));</span><br><span class="line">--</span><br><span class="line">-- Create model Tag</span><br><span class="line">--</span><br><span class="line">CREATE TABLE &quot;blog_tag&quot; (</span><br><span class="line">    &quot;id&quot; integer NOT NULL PRIMARY KEY AUTOINCREMENT,</span><br><span class="line">    &quot;name&quot; varchar(100) NOT NULL);</span><br><span class="line">--</span><br><span class="line">-- Add field tags to post</span><br><span class="line">--</span><br><span class="line">CREATE TABLE &quot;blog_post_tags&quot; (</span><br><span class="line">    &quot;id&quot; integer NOT NULL PRIMARY KEY AUTOINCREMENT,</span><br><span class="line">    &quot;post_id&quot; integer NOT NULL REFERENCES &quot;blog_post&quot; (&quot;id&quot;), </span><br><span class="line">    &quot;tag_id&quot; integer NOT NULL REFERENCES &quot;blog_tag&quot; (&quot;id&quot;));</span><br><span class="line">    </span><br><span class="line">CREATE INDEX &quot;blog_post_52be3978&quot; ON &quot;blog_post&quot; (&quot;autor_id&quot;);</span><br><span class="line">CREATE INDEX &quot;blog_post_b583a629&quot; ON &quot;blog_post&quot; (&quot;category_id&quot;);</span><br><span class="line">CREATE UNIQUE INDEX &quot;blog_post_tags_post_id_4925ec37_uniq&quot; ON &quot;blog_post_tags&quot; (&quot;post_id&quot;, &quot;tag_id&quot;);</span><br><span class="line">CREATE INDEX &quot;blog_post_tags_f3aa1999&quot; ON &quot;blog_post_tags&quot; (&quot;post_id&quot;);</span><br><span class="line">CREATE INDEX &quot;blog_post_tags_76f094bc&quot; ON &quot;blog_post_tags&quot; (&quot;tag_id&quot;);</span><br><span class="line">COMMIT;</span><br></pre></td></tr></table></figure>

<p>观看上面的sql代码,我们就可以解决很多疑惑了</p>
<ol>
<li><p>为什么上面说ID列会自动生成?<br>因为创建了ID字段,而且是主键和AUTOINCREMENT</p>
</li>
<li><p>为什么会有ForeignKey,OneToOneField,ManyToManyField这些函数?<br>实际上就是数据库原理的实体之间的关系(一对一,一对多,多对多)</p>
<p>尤其是ManyToManyField,我们使用了这个函数后,Django后台会自动生成一张关联关系表.不过和数据库原理不一样的是,数据库原理<strong>使用两个外键组成联合主键</strong>,而Django是默认使用一个自动增加的ID作为主键.</p>
<p>对于一对多的情况也一样,在一实体的表上也会建立一个外键.</p>
</li>
</ol>
<p>总结:Django背后建立的数据库和根据数据库原理建立的数据库是一样的,只是==全部的主键都变成了自动增加的ID字段==</p>
<h2 id="选择数据库版本"><a href="#选择数据库版本" class="headerlink" title="选择数据库版本"></a>选择数据库版本</h2><p>我们没有安装任何的数据库软件，Django 就帮我们迁移了数据库。这是因为我们使用了 Python 内置的 SQLite3 数据库。</p>
<p>这个数据库就是根目录下面的db.sqlite3</p>
<p><img src="/images/1554949275355.png" alt="1554949275355"></p>
<p>数据库的设置可以在settings.py里找到:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;django.db.backends.sqlite3&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: os.path.join(BASE_DIR, <span class="string">&#x27;db.sqlite3&#x27;</span>),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里不再说明如何迁移到MySQL,自行搜索.</p>
<h2 id="用-Django-的方式操作数据库"><a href="#用-Django-的方式操作数据库" class="headerlink" title="用 Django 的方式操作数据库"></a>用 Django 的方式操作数据库</h2><p>介绍如何使用Django对数据库进行增删改查</p>
<h3 id="存数据"><a href="#存数据" class="headerlink" title="存数据"></a>存数据</h3><p>实例化表格类,调用表格类实例的save()方法</p>
<p>Django 进入shell命令,键入:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py shell</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> blog.models <span class="keyword">import</span> Category,Tag,Post</span><br><span class="line"><span class="comment"># 实例化一个表格类</span></span><br><span class="line"><span class="comment"># 这里的name参数就是表格的字段</span></span><br><span class="line"><span class="comment"># name=&#x27;category test&#x27;表示新增一行数据,值为category test</span></span><br><span class="line">c = Category(name=<span class="string">&#x27;category test&#x27;</span>)</span><br><span class="line">t = Tag(name = <span class="string">&#x27;tag test&#x27;</span>)</span><br><span class="line"><span class="comment"># 保存(把数据保存到数据库)</span></span><br><span class="line">c.save()</span><br></pre></td></tr></table></figure>

<p>注意,文章类因为使用了<code>author = models.ForeignKey(User)</code>,也就是说,使用文章类之前必须先创建一个用户实例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 创建上传用户,之后会提示你输入用户名、邮箱、密码和确认密码</span><br><span class="line">python manage.py createsuperuser</span><br></pre></td></tr></table></figure>

<p>现在我们回去shell,键入</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> blog.models <span class="keyword">import</span> Category, Tag, Post</span><br><span class="line"><span class="keyword">from</span> django.utils <span class="keyword">import</span> timezone</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过 get 方法取出了存在数据库中的 User 和 Category</span></span><br><span class="line">user = User.objects.get(username=<span class="string">&#x27;liangbo&#x27;</span>)</span><br><span class="line">c = Category.objects.get(name=<span class="string">&#x27;category test&#x27;</span>)</span><br><span class="line">p = Post(title=<span class="string">&#x27;title test&#x27;</span>, </span><br><span class="line">         body=<span class="string">&#x27;body test&#x27;</span>, </span><br><span class="line">         created_time=timezone.now(), </span><br><span class="line">         modified_time=timezone.now(), </span><br><span class="line">         category=c,</span><br><span class="line">         author=user)</span><br><span class="line">p.save()</span><br></pre></td></tr></table></figure>

<p>注意：<br><strong>我们这里使用 get 方法根据 Category 的 name 属性的值获取分类的一条记录。Category.objects.get(name=’category test’) 的含义是从数据库中取出 name 的值为 category test 的分类记录</strong>。<br>确保数据库中只有一条值为 category test 的记录，否则 get 方法将返回一个 MultipleObjectsReturned 异常。如果你不小心已经存了多条记录，请删掉多余的记录。</p>
<h3 id="取数据"><a href="#取数据" class="headerlink" title="取数据"></a>取数据</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>Category.objects.<span class="built_in">all</span>()</span><br><span class="line"><span class="comment"># &lt;QuerySet [&lt;Category: Category object&gt;]&gt;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Tag.objects.<span class="built_in">all</span>()</span><br><span class="line"><span class="comment"># &lt;QuerySet [&lt;Tag: Tag object&gt;]&gt;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Post.objects.<span class="built_in">all</span>()</span><br><span class="line"><span class="comment"># &lt;QuerySet [&lt;Post: Post object&gt;]&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>objects</code> 是我们的模型管理器，它为我们提供一系列从数据库中取数据方法，这里我们使用了 <code>all</code> 方法，表示我们要把对应的数据全部取出来。<br>可以看到 <code>all</code> 方法都返回了数据，这些数据应该是我们之前存进去的，但是显示的字符串有点奇怪，无法看出究竟是不是我们之前存入的数据。为了让显示出来的数据更加人性化一点，我们为 3 个模型分别增加一个 <code>__str__</code> 方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog/models.py</span></span><br><span class="line"><span class="keyword">from</span> django.utils.six <span class="keyword">import</span> python_2_unicode_compatible</span><br><span class="line"></span><br><span class="line"><span class="comment"># python_2_unicode_compatible 装饰器用于兼容 Python2</span></span><br><span class="line"><span class="comment"># 如果是使用python3,则可以去掉这个装饰器</span></span><br><span class="line"><span class="meta">@python_2_unicode_compatible</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Category</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.name</span><br><span class="line"></span><br><span class="line"><span class="meta">@python_2_unicode_compatible</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tag</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.name</span><br><span class="line"></span><br><span class="line"><span class="meta">@python_2_unicode_compatible</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.title</span><br></pre></td></tr></table></figure>

<p>再次进入shell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> blog.models <span class="keyword">import</span> Category, Tag, Post</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Category.objects.<span class="built_in">all</span>()</span><br><span class="line">&lt;QuerySet [&lt;Category: category test&gt;]&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Tag.objects.<span class="built_in">all</span>()</span><br><span class="line">&lt;QuerySet [&lt;Tag: tag test&gt;]&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Post.objects.<span class="built_in">all</span>()</span><br><span class="line">&lt;QuerySet [&lt;Post: title test&gt;]&gt;</span><br><span class="line"><span class="comment"># 可以看到返回的是我们之前存入的数据。</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Post.objects.get(title=<span class="string">&#x27;title test&#x27;</span>)</span><br><span class="line">&lt;Post: title test&gt;</span><br></pre></td></tr></table></figure>

<p> <code>all</code> 方法和 <code>get</code> 方法的区别是：<br><code>all</code> 方法返回全部数据，是一个类似于列表的数据结构（QuerySet）；<br>而 <code>get</code> 返回一条记录数据，如有多条记录或者没有记录，<code>get</code> 方法均会抛出相应异常。</p>
<h3 id="改数据"><a href="#改数据" class="headerlink" title="改数据"></a>改数据</h3><p>修改数据直接赋值即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>c = Category.objects.get(name=<span class="string">&#x27;category test&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.name = <span class="string">&#x27;category test new&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.save()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Category.objects.<span class="built_in">all</span>()</span><br><span class="line">&lt;QuerySet [&lt;Category: test category new&gt;]&gt;</span><br></pre></td></tr></table></figure>

<p>首先通过 <code>get</code> 方法根据分类名 <code>name</code> 获取值为 category test 到分类，修改它的 <code>name</code> 属性为新的值 category test new，然后调用 <code>save</code> 方法把修改保存到数据库，之后可以看到数据库返回的数据已经是修改后的值了。<code>Tag</code>、<code>Post</code> 的修改也一样。</p>
<h3 id="删数据"><a href="#删数据" class="headerlink" title="删数据"></a>删数据</h3><p>调用delete()方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>p = Post.objects.get(title=<span class="string">&#x27;title test&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p</span><br><span class="line">&lt;Post: title test&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p.delete()</span><br><span class="line">(<span class="number">1</span>, &#123;<span class="string">&#x27;blog.Post_tags&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;blog.Post&#x27;</span>: <span class="number">1</span>&#125;)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Post.objects.<span class="built_in">all</span>()</span><br><span class="line">&lt;QuerySet []&gt;</span><br></pre></td></tr></table></figure>

<p>先根据标题 <code>title</code> 的值从数据库中取出 <code>Post</code>，保存在变量 <code>p</code> 中，然后调用它的<code>delete</code> 方法，最后看到 <code>Post.objects.all()</code> 返回了一个空的 QuerySet（类似于一个列表），表明数据库中已经没有 Post，Post 已经被删除了。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结:"></a>总结:</h3><ol>
<li>表格类对应数据表</li>
<li>表格类属对应数据表的字段</li>
<li>表格类实例对应数据表的一行</li>
</ol>
<p>所以数据的增删改查就对应表格类实例的各种方法</p>
<ul>
<li>增 – 实例化,(或者说__init__方法)</li>
<li>删 – delete方法,</li>
<li>改 – update方法,</li>
<li>查 – get方法和all方法</li>
</ul>
<p>增</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法一：</span></span><br><span class="line">stu1 = Student(name=<span class="string">&quot;Aaron&quot;</span>, age=<span class="number">23</span>)</span><br><span class="line">stu1.save() <span class="comment"># flush到数据库中</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法二:</span></span><br><span class="line">Student.objects.create(name=<span class="string">&quot;Aaron&quot;</span>, age=<span class="number">23</span>)</span><br></pre></td></tr></table></figure>

<p>删</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除表中所有数据：</span></span><br><span class="line">Student.objects.<span class="built_in">all</span>().delete()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除name等于Aaron的数据：</span></span><br><span class="line">Student.objects.get(name=<span class="string">&#x27;Aaron&#x27;</span>).delete()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除age等于20的多条数据：</span></span><br><span class="line">Student.objects.<span class="built_in">filter</span>(age=<span class="number">20</span>).delete()</span><br></pre></td></tr></table></figure>

<p>改</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法一：</span></span><br><span class="line">stu = Student.objects.get(name=<span class="string">&#x27;Aaron&#x27;</span>) <span class="comment"># 查询该条记录</span></span><br><span class="line">stu.name = <span class="string">&#x27;Zhang&#x27;</span>                      <span class="comment"># 修改</span></span><br><span class="line">stu.save()                              <span class="comment"># 保存</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法二，更新多个字段：</span></span><br><span class="line">Student.objects.get(name=<span class="string">&#x27;Aaron&#x27;</span>).update(name=<span class="string">&#x27;Zhang&#x27;</span>, age=<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法三，更新所有字段：</span></span><br><span class="line">Student.objects.<span class="built_in">all</span>().update(name=<span class="string">&#x27;Zhang&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>查</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查表中所有记录</span></span><br><span class="line">Student.objects.<span class="built_in">all</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询带字段名的所有记录，就是将所有记录以key-value的形式保存在字典中</span></span><br><span class="line">Student.objects.<span class="built_in">all</span>().values()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询单条记录</span></span><br><span class="line">Student.objects.get(name=<span class="string">&#x27;Aaron&#x27;</span>) </span><br><span class="line"><span class="comment"># 查询name字段是Aaron的这条数据，如果返回多条记录或没有会报错，需结合try/except一起使用。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询匹配条件的多条数据</span></span><br><span class="line">Student.objects.<span class="built_in">filter</span>(name=<span class="string">&#x27;Aaron&#x27;</span>)</span><br><span class="line"><span class="comment"># 查询name字段值为Aaron的所有匹配数据，括号中匹配条件可多个，以逗号分隔。注意filter与上面get方法的区别！！</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模糊查询</span></span><br><span class="line">Student.objects.<span class="built_in">filter</span>(name__contains=<span class="string">&quot;A&quot;</span>)</span><br><span class="line"><span class="comment"># 查询name字段中值包含A的记录。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将字段内容排序后显示</span></span><br><span class="line">Student.objects.order_by(<span class="string">&#x27;age&#x27;</span>)</span><br><span class="line"><span class="comment"># 根据Aaron字段的内容进行排序后输出结果。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将字段内容逆序后显示</span></span><br><span class="line">Student.objects.order_by(<span class="string">&#x27;-age&#x27;</span>)</span><br><span class="line"><span class="comment"># 只需要加一个-号就可以达到逆序输出的效果。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 多重查询，比如过滤后逆序输出</span></span><br><span class="line">Student.objects.<span class="built_in">filter</span>(age=<span class="number">20</span>).order_by(<span class="string">&quot;-age&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 限制数据条数</span></span><br><span class="line">Student.objects.<span class="built_in">filter</span>(age=<span class="number">20</span>)[<span class="number">0</span>]  <span class="comment"># [0]取第一条记录，[0:2]取前两条记录</span></span><br><span class="line">Student.objects.<span class="built_in">filter</span>(age=<span class="number">20</span>).order_by(<span class="string">&quot;‐age&quot;</span>)[<span class="number">0</span>] </span><br><span class="line"><span class="comment"># 切片不支持负数，可以使用上面先逆序排列后再输出达到这个效果。</span></span><br></pre></td></tr></table></figure>

<h1 id="Django-博客首页视图"><a href="#Django-博客首页视图" class="headerlink" title="Django 博客首页视图"></a>Django 博客首页视图</h1><h2 id="Django-处理-HTTP-请求"><a href="#Django-处理-HTTP-请求" class="headerlink" title="Django 处理 HTTP 请求"></a>Django 处理 HTTP 请求</h2><p>Django 作为一个 Web 框架，它的使命就是处理接收浏览器发来的 HTTP 请求，返回相应的 HTTP 响应。于是引出这么几个问题：</p>
<ol>
<li>Django 如何接收 HTTP 请求？</li>
<li>Django 如何处理这个 HTTP 请求？</li>
<li>Django 如何生成 HTTP 响应？</li>
</ol>
<h2 id="Hello-视图函数"><a href="#Hello-视图函数" class="headerlink" title="Hello 视图函数"></a>Hello 视图函数</h2><p>我们先以一个最简单的 Hello World 为例来看看 Django 处理上述问题的机制是怎么样的。</p>
<h3 id="绑定-URL-与视图函数"><a href="#绑定-URL-与视图函数" class="headerlink" title="绑定 URL 与视图函数"></a>绑定 URL 与视图函数</h3><p>首先 Django 需要知道当用户访问不同的网址时，应该如何处理这些不同的网址（即所说的路由）。Django 的做法是把不同的网址对应的处理函数写在一个 urls.py 文件里，当用户访问某个网址时，Django 就去会这个文件里找，如果找到这个网址，就会调用和它绑定在一起的处理函数（叫做视图函数）。</p>
<p>我们首先在blog文件夹下创建一个urls.py文件</p>
<p><img src="/images/1554955565299.png" alt="1554955565299"></p>
<p>在urls.py写入:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r&#x27;^$&#x27;</span>, views.index, name=<span class="string">&#x27;index&#x27;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p><code>url</code> 函数（第一个参数是网址，第二个参数是处理函数,参数 <code>name</code>值将作为处理函数 <code>index</code> 的别名）</p>
<p>注意这里我们的网址是用正则表达式写的，Django 会用这个正则表达式去匹配用户实际输入的网址，如果匹配成功，就会调用其后面的视图函数做相应的处理。</p>
<p>比如说我们本地开发服务器的域名是 <a href="http://127.0.0.1:8000，那么当用户输入网址">http://127.0.0.1:8000，那么当用户输入网址</a> <a target="_blank" rel="noopener" href="http://127.0.0.1:8000/">http://127.0.0.1:8000</a> 后，Django 首先会把协议 http、域名 127.0.0.1 和端口号 8000 去掉，此时只剩下一个空字符串，而 <code>r&#39;^$&#39;</code> 的模式正是匹配一个空字符串，Django 便会调用其对应的 <code>views.index</code> 函数。</p>
<p>注意：在项目根目录的 blogproject\ 目录下，原本就有一个 urls.py 文件，<strong>那是整个工程项目的 URL 配置文件。</strong><br>而我们这里新建了一个 urls.py 文件，且位于 blog 应用下。这个文件将<strong>用于 blog 应用相关的 URL 配置。</strong>不要把两个文件搞混了。</p>
<h3 id="编写视图函数"><a href="#编写视图函数" class="headerlink" title="编写视图函数"></a>编写视图函数</h3><p>第二步就是要实际编写我们的 <code>views.index</code> 视图函数了，<br>按照惯例<strong>视图函数定义在 views.py 文件里</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog/views.py</span></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">&quot;欢迎访问我的博客首页！&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>函数首先接受了一个名为 <code>request</code> 的参数，这个 <code>request</code> 就是 Django 为我们封装好的 HTTP 请求，它是类 <code>HttpRequest</code> 的一个实例。然后我们便直接返回了一个 HTTP 响应给用户，这个 HTTP 响应也是 Django 帮我们封装好的，它是类 <code>HttpResponse</code> 的一个实例，只是我们给它传了一个自定义的字符串参数。<br>浏览器接收到这个响应后就会在页面上显示出我们传递的内容 ：欢迎访问我的博客首页！</p>
<h3 id="配置项目-URL"><a href="#配置项目-URL" class="headerlink" title="配置项目 URL"></a>配置项目 URL</h3><p>我们前面建立了一个 urls.py 文件，并且绑定了 URL 和视图函数 <code>index</code>，但是 Django 并不知道。<br>Django 匹配 URL 模式是在 blogproject\ 目录的 urls.py 下的，所以我们要<strong>把 blog 应用下的 urls.py 文件包含到 blogproject\urls.py 里去</strong></p>
<p>将其修改为:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blogproject/urls.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url,include</span><br><span class="line"><span class="keyword">from</span> django.comtrib <span class="keyword">import</span> admin</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">	url(<span class="string">r&#x27;^admin/&#x27;</span>,admin.site.urls),</span><br><span class="line">	url(<span class="string">r&#x27;&#x27;</span>,include(<span class="string">&#x27;blog.urls&#x27;</span>))</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>导入了一个 <code>include</code> 函数，然后利用这个函数把 blog 应用下的 urls.py 文件包含了进来。此外 include 前还有一个 <code>r&#39;&#39;</code>，这是一个空字符串。这里也可以写其它字符串，<strong>Django 会把这个字符串和后面 include 的 urls.py 文件中的 URL 拼接</strong>。比如说如果我们这里把 <code>r&#39;&#39;</code> 改成 <code>r&#39;blog/&#39;</code>，而我们在 blog.urls 中写的 URL 是 <code>r&#39;^$&#39;</code>，即一个空字符串。那么 Django 最终匹配的就是 blog/ 加上一个空字符串，即 blog/。</p>
<h3 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h3><p>运行 <code>python manage.py runserver</code> 打开开发服务器，在浏览器输入开发服务器的地址 <a target="_blank" rel="noopener" href="http://127.0.0.1:8000/%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0">http://127.0.0.1:8000/，可以看到</a> Django 返回的内容了。</p>
<p><img src="/images/1554980114496.png" alt="1554980114496"></p>
<h2 id="使用-Django-模板系统"><a href="#使用-Django-模板系统" class="headerlink" title="使用 Django 模板系统"></a>使用 Django 模板系统</h2><p>这基本上就上 Django 的开发流程了，<strong>写好处理 HTTP 请求和返回 HTTP 响应的视图函数，然后把视图函数绑定到相应的 URL 上</strong>。</p>
<p>我们看到在视图函数里返回的是一个 <code>HttpResponse</code> 类的实例，我们给它传入了一个希望显示在用户浏览器上的字符串。但是我们的博客不可能只显示这么一句话，它有可能会显示很长很长的内容。比如我们发布的博客文章列表，或者一大段的博客文章。我们不能每次都把这些大段大段的内容传给 <code>HttpResponse</code>。</p>
<p>Django 对这个问题给我们提供了一个很好的解决方案，叫做<code>模板系统</code>。Django 要我们把大段的文本写到一个文件里，然后 Django 自己会去读取这个文件，再把读取到的内容传给 <code>HttpResponse</code>。让我们用模板系统来改造一下上面的例子。</p>
<p>首先在我们的项目<strong>根目录</strong>（即 manage.py 文件所在目录）下建立一个名为 templates 的文件夹，用来存放我们的模板。然后在 templates\ 目录下建立一个名为 blog 的文件夹，用来存放和 blog 应用相关的模板，在 templates\blog 目录下建立一个名为 index.html 的文件.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">workspace</span><br><span class="line">    └───blogproject</span><br><span class="line">            ├───blog</span><br><span class="line">            ├───blogproject</span><br><span class="line">            ├...</span><br><span class="line">            └───templates</span><br><span class="line">                └───blog</span><br><span class="line">                	└───index.html</span><br></pre></td></tr></table></figure>

<p>然后在index.html键入</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>&#123;&#123; title &#125;&#125;<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123; welcome &#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>&#123;&#123; title &#125;&#125;</code>，<code>&#123;&#123; welcome &#125;&#125;</code>。这是 Django 规定的语法。<br>用 <code>&#123;&#123; &#125;&#125;</code> 包起来的变量叫做<code>模板变量</code>。Django 在渲染这个模板的时候会根据我们传递给模板的变量替换掉这些变量。最终在模板中显示的将会是我们传递的值。</p>
<p><strong>注意：index.html 必须以 UTF-8 的编码格式保存，且小心不要往里面添加一些特殊字符，否则极有可能得到一个 UnicodeDecodeError 这样的错误。</strong></p>
<p>模板写好了，还得告诉 Django 去哪里找模板，在 settings.py 文件里设置一下模板文件所在的路径。在 settings.py 找到 <code>TEMPLATES</code> 选项，它的内容是这样的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">TEMPLATES = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;BACKEND&#x27;</span>: <span class="string">&#x27;django.template.backends.django.DjangoTemplates&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;DIRS&#x27;</span>: [],  <span class="comment">#### 指定模板的路径</span></span><br><span class="line">        <span class="string">&#x27;APP_DIRS&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">&#x27;OPTIONS&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;context_processors&#x27;</span>: [</span><br><span class="line">                <span class="string">&#x27;django.template.context_processors.debug&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.template.context_processors.request&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.contrib.auth.context_processors.auth&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.contrib.messages.context_processors.messages&#x27;</span>,</span><br><span class="line">            ],</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>其中 <code>DIRS</code> 就是设置模板的路径，在 [] 中写入 <code>os.path.join(BASE_DIR, &#39;templates&#39;)</code>，即像下面这样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;DIRS&#x27;</span>: [os.path.join(BASE_DIR, <span class="string">&#x27;templates&#x27;</span>)],</span><br></pre></td></tr></table></figure>

<p>这里 <code>BASE_DIR</code> 是 settings.py 在配置开头前面定义的变量，记录的是工程根目录 blogproject\ 的值（注意是最外层的 blogproject\ 目录）。在这个目录下有模板文件所在的目录 templates\</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br></pre></td></tr></table></figure>

<p>于是利用<code>os.path.join</code> 把这两个路径连起来，构成完整的模板路径，Django 就知道去这个路径下面找我们的模板了。</p>
<p>视图函数改成:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">&#x27;blog/index.html&#x27;</span>, context=&#123;</span><br><span class="line">                      <span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;我的博客首页&#x27;</span>, </span><br><span class="line">                      <span class="string">&#x27;welcome&#x27;</span>: <span class="string">&#x27;欢迎访问我的博客首页&#x27;</span></span><br><span class="line">                  &#125;)</span><br></pre></td></tr></table></figure>

<p>这里我们不再是直接把字符串传给 <code>HttpResponse</code> 了，而是调用 Django 提供的 <code>render</code> 函数。这个函数根据我们传入的参数来构造 <code>HttpResponse</code>。</p>
<p>我们首先把 HTTP 请求传了进去，然后 <code>render</code> 根据第二个参数的值 blog/index.html 找到这个模板文件并读取模板中的内容。之后 <code>render</code> 根据我们传入的 <code>context</code> 参数的值把模板中的变量替换为我们传递的变量的值，<code>&#123;&#123; title &#125;&#125;</code> 被替换成了 <code>context</code> 字典中 <code>title</code> 对应的值，同理 <code>&#123;&#123; welcome &#125;&#125;</code> 也被替换成相应的值。</p>
<p>最终，我们的 HTML 模板中的内容字符串被传递给 <code>HttpResponse</code> 对象并返回给浏览器（Django 在 <code>render</code> 函数里隐式地帮我们完成了这个过程），这样用户的浏览器上便显示出了我们写的 HTML 模板的内容。</p>
<p><img src="/images/1554981388511.png" alt="1554981388511"></p>
<p>总结Django的工作流程:</p>
<p><img src="/images/20161219113912193.png" alt="img"></p>
<p><img src="/images/dbb95c12-20171215145650232.png" alt="img"></p>
<ol>
<li>首先根据url去urls.py匹配,然后调用匹配成功的视图函数</li>
<li>视图函数去加载模板,将视图函数的参数传入模板</li>
<li>模板去数据库里取出数据,返回给视图</li>
</ol>
<h1 id="真正的-Django-博客首页视图"><a href="#真正的-Django-博客首页视图" class="headerlink" title="真正的 Django 博客首页视图"></a>真正的 Django 博客首页视图</h1><p>前面制作的首页只是显示标题和欢迎界面,现在制作真正的Django首页.</p>
<h2 id="首页视图函数"><a href="#首页视图函数" class="headerlink" title="首页视图函数"></a>首页视图函数</h2><p>Django的开发流程:</p>
<ol>
<li>首先配置 URL，把 URL 和相应的视图函数绑定，一般写在 urls.py 文件里，然后在工程的 urls.py 文件引入。</li>
<li>其次是编写视图函数，视图中需要渲染模板，我们也在 settings.py 中进行了模板相关的配置，让 Django 能够找到需要渲染的模板。</li>
<li>最后把渲染完成的 HTTP 响应返回就可以了。相关的配置和准备工作都在之前完成了，这里我们只需专心编写视图函数，让它实现我们想要的功能即可。</li>
</ol>
<p>首页的视图函数其实很简单，代码像这样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Post</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span></span><br><span class="line">    post_list = Post.objects.<span class="built_in">all</span>().order_by(<span class="string">&#x27;-created_time&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">&#x27;blog/index.html&#x27;</span>, context=&#123;<span class="string">&#x27;post_list&#x27;</span>: post_list&#125;)</span><br></pre></td></tr></table></figure>

<p>在前面的章节讲解过模型管理器 <code>objects</code> 的使用。<br>这里我们使用 <code>all()</code> 方法从数据库里获取了全部的文章，存储在 <code>post_list</code> 变量里。<code>all</code> 方法返回的是一个 <code>QuerySet</code>（可以理解成一个类似于列表的数据结构），由于通常来说博客文章列表是按文章发表时间倒序排列的，即最新的文章排在最前面，所以我们紧接着调用了 <code>order_by</code>方法对这个返回的 queryset 进行排序。排序依据的字段是 <code>created_time</code>，即文章的创建时间。<code>-</code> 号表示逆序，如果不加 <code>-</code> 则是正序。<br> 接着如之前所做，我们渲染了 blog\index.html 模板文件，并且把包含文章列表数据的 <code>post_list</code> 变量传给了模板。</p>
<h2 id="处理静态文件"><a href="#处理静态文件" class="headerlink" title="处理静态文件"></a>处理静态文件</h2><p>我们的项目使用了从网上下载的一套博客模板（<a target="_blank" rel="noopener" href="https://github.com/zmrenwu/django-blog-tutorial-templates">点击这里下载全套模板</a>）。这里面除了 HTML 文档外，还包含了一些 CSS 文件和 JavaScript 文件以让网页呈现出我们现在看到的样式。同样我们需要对 Django 做一些必要的配置，才能让 Django 知道如何在开发服务器中引入这些 CSS 和 JavaScript 文件，这样才能让博客页面的 CSS 样式生效。</p>
<p>我们把 CSS 和 JavaScript 文件放在 <strong>blog 应用</strong>的 static\ 目录下。<br>因此，先在 <strong>blog 应用</strong>下建立一个 static 文件夹。同时，为了避免和其它应用中的 CSS 和 JavaScript 文件命名冲突（别的应用下也可能有和 blog 应用下同名的 CSS 、JavaScript 文件），我们再在 static\ 目录下建立一个 blog 文件夹，把下载的博客模板中的 css 和 js 文件夹连同里面的全部文件一同拷贝进这个目录。最终我们的 blog 应用目录结构应该是这样的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">blog\</span><br><span class="line">    __init__.py</span><br><span class="line">    static\</span><br><span class="line">        blog\</span><br><span class="line">            css\</span><br><span class="line">                .css 文件...</span><br><span class="line">            js\</span><br><span class="line">                .js 文件...</span><br><span class="line">    admin.py</span><br><span class="line">    apps.py</span><br><span class="line">    migrations\</span><br><span class="line">        __init__.py</span><br><span class="line">    models.py</span><br><span class="line">    tests.py</span><br><span class="line">    views.py</span><br></pre></td></tr></table></figure>

<p><strong>static 模板标签位于 staticfiles 模块中</strong>，只有通过 load 模板标签将该模块引入后，才能在模板中使用<code>&#123;% static %&#125; </code>标签。</p>
<h1 id="在-Django-Admin-后台发布文章"><a href="#在-Django-Admin-后台发布文章" class="headerlink" title="在 Django Admin 后台发布文章"></a><a target="_blank" rel="noopener" href="https://www.zmrenwu.com/courses/django-blog-tutorial/materials/8/">在 Django Admin 后台发布文章</a></h1><p>略</p>
<h1 id="博客文章详情页"><a href="#博客文章详情页" class="headerlink" title="博客文章详情页"></a><a target="_blank" rel="noopener" href="https://www.zmrenwu.com/courses/django-blog-tutorial/materials/9/">博客文章详情页</a></h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">app_name = <span class="string">&#x27;blog&#x27;</span></span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r&#x27;^$&#x27;</span>, views.index, name=<span class="string">&#x27;index&#x27;</span>),</span><br><span class="line">    url(<span class="string">r&#x27;^post/(?P&lt;pk&gt;[0-9]+)/$&#x27;</span>, views.detail, name=<span class="string">&#x27;detail&#x27;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>通过 <code>app_name=&#39;blog&#39; </code>告诉 Django 这个 urls.py 模块是属于 blog 应用的，这种技术叫做视图函数命名空间。<br>这个 <code>app_name=&#39;blog&#39; </code>和urls.py里的include的作用是一致的.</p>
<hr>
<p>get_absolute_url的使用:<br>如果使用了自定义的get_absolute_url,那么就可以在模板里不使用<code>&#123;% url %&#125;</code>了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog/models.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> reverse</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 自定义 get_absolute_url 方法</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_absolute_url</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> reverse(<span class="string">&#x27;blog:detail&#x27;</span>, kwargs=&#123;<span class="string">&#x27;pk&#x27;</span>: self.pk&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">&quot;entry-title&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; post.get_absolute_url &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span></span><span class="template-variable">&#123;&#123; post.title &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>或者可以在views.py里面避免使用reverse:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">article = get_object_or_404(Article,pk=articleid)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定位到commentarea锚点</span></span><br><span class="line"><span class="keyword">return</span> redirect(<span class="string">&#x27;&#123;&#125;#commentarea&#x27;</span>.<span class="built_in">format</span>(article.get_absolute_url()))   </span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以使用:</span></span><br><span class="line"><span class="comment"># return redirect(&#x27;&#123;&#125;#commentarea&#x27;.format(reverse(&#x27;blog:article&#x27;,kwargs=&#123;&#x27;articleid&#x27;: articleid&#125;)))</span></span><br></pre></td></tr></table></figure>

<p>也就是说,使用get_absolute_url能避免在view里使用reverse.(<strong>其实就是把views.py里的reverse放到model.py里而已</strong>)</p>
<p>get_absolute_url还可以这么用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    title = models.CharFiled(max_length=<span class="number">200</span>)</span><br><span class="line">    slug = models.CharField(max_length=<span class="number">255</span>)</span><br><span class="line">    body = models.TextField()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_absolute_url</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;post/%s.html&#x27;</span> % (self.slug)</span><br></pre></td></tr></table></figure>

<p>注意:get_absolute_url是<code>行级</code>的url反向解析(比如说文章表中的某一篇文章就是<code>行级</code>),<br>我们将:</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> each <span class="keyword">in</span> articles %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">span</span>&gt;</span></span><span class="template-variable">&#123;&#123; url &#x27;blog:arcticle&#x27; each.id &#125;&#125;</span><span class="xml"><span class="tag">&lt;<span class="name">span</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>改为:</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> each <span class="keyword">in</span> articles %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">span</span>&gt;</span></span><span class="template-variable">&#123;&#123; each.get_absolute_url &#125;&#125;</span><span class="xml"><span class="tag">&lt;<span class="name">span</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>以后就不必在传id给模板了.可以使用only限制掉,提高性能.</p>
<h1 id="支持-Markdown-语法和代码高亮"><a href="#支持-Markdown-语法和代码高亮" class="headerlink" title="支持 Markdown 语法和代码高亮"></a>支持 Markdown 语法和代码高亮</h1><p>略</p>
<h1 id="页面侧边栏：使用自定义模板标签"><a href="#页面侧边栏：使用自定义模板标签" class="headerlink" title="页面侧边栏：使用自定义模板标签"></a>页面侧边栏：使用自定义模板标签</h1><p>我们希望自己定义一个模板标签，例如名为 <code>get_recent_posts</code> 的模板标签，它可以这样工作：我们只要在模板中写入<code> &#123;% get_recent_posts as recent_post_list %&#125;</code>，那么模板中就会有一个从数据库获取的最新文章列表，并通过 as 语句保存到 <code>recent_post_list</code> 模板变量里。</p>
<p>这样我们就可以通过<code>&#123;% for %&#125;`,` &#123;% endfor%&#125;</code>模板标签来循环这个变量，显示最新文章列表了，这和我们在编写博客首页面视图函数是类似的。首页视图函数中从数据库获取文章列表并保存到 <code>post_list</code> 变量，然后把这个 <code>post_list</code> 变量传给模板，模板使用 for 模板标签循环这个文章列表变量，从而展示一篇篇文章。这里唯一的不同是<strong>我们从数据库获取文章列表的操作不是在视图函数中进行，而是在模板中通过自定义的<code>&#123;% get_recent_posts %&#125;</code>模板标签进行</strong>。</p>
<h2 id="模板标签目录结构"><a href="#模板标签目录结构" class="headerlink" title="模板标签目录结构"></a>模板标签目录结构</h2><p>首先在我们的 <strong>blog 应用</strong>下创建一个 templatetags 文件夹。然后在这个文件夹下创建一个 __init__.py 文件，使这个文件夹成为一个 Python 包，之后在 templatetags\ 目录下创建一个 blog_tags.py 文件，这个文件存放自定义的模板标签代码</p>
<h2 id="编写模板标签代码"><a href="#编写模板标签代码" class="headerlink" title="编写模板标签代码"></a>编写模板标签代码</h2><p>其实模板标签<strong>本质上就是一个 Python 函数</strong>，因此按照 Python 函数的思路来编写模板标签的代码就可以了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog/templatetags/blog_tags.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ..models <span class="keyword">import</span> Post</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_recent_posts</span>(<span class="params">num=<span class="number">5</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> Post.objects.<span class="built_in">all</span>().order_by(<span class="string">&#x27;-created_time&#x27;</span>)[:num]</span><br></pre></td></tr></table></figure>

<p>为了能够通过 <code>&#123;% get_recent_posts %&#125; </code>的语法在模板中调用这个函数，必须按照 Django 的规定注册这个函数为模板标签，方法如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog/templatetags/blog_tags.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> template</span><br><span class="line"><span class="keyword">from</span> ..models <span class="keyword">import</span> Post</span><br><span class="line"></span><br><span class="line">register = template.Library()</span><br><span class="line"></span><br><span class="line"><span class="meta">@register.simple_tag</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_recent_posts</span>(<span class="params">num=<span class="number">5</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> Post.objects.<span class="built_in">all</span>().order_by(<span class="string">&#x27;-created_time&#x27;</span>)[:num]</span><br></pre></td></tr></table></figure>

<p>这里我们首先导入 template 这个模块，然后实例化了一个 <code>template.Library</code> 类，并将函数 <code>get_recent_posts</code> 装饰为 <code>register.simple_tag</code>。</p>
<p><strong>这样就可以在模板中使用语法 <code>&#123;% get_recent_posts %&#125;</code> 调用这个函数了。</strong></p>
<h2 id="归档模板标签"><a href="#归档模板标签" class="headerlink" title="归档模板标签"></a>归档模板标签</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog/templatetags/blog_tags.py</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@register.simple_tag</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">archives</span>():</span></span><br><span class="line">    <span class="keyword">return</span> Post.objects.dates(<span class="string">&#x27;created_time&#x27;</span>, <span class="string">&#x27;month&#x27;</span>, order=<span class="string">&#x27;DESC&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>这里 <code>dates</code> 方法会返回一个列表，列表中的元素为每一篇文章（Post）的创建时间，且是 Python 的 <code>date</code> 对象，精确到月份，降序排列。接受的三个参数值表明了这些含义，一个是 <code>created_time</code> ，即 <code>Post</code> 的创建时间，<code>month</code> 是精度，<code>order=&#39;DESC&#39;</code> 表明降序排列（即离当前越近的时间越排在前面）。</p>
<p>例如我们写了 3 篇文章，分别发布于 2017 年 2 月 21 日、2017 年 3 月 25 日、2017 年 3 月 28 日，那么 <code>dates</code> 函数将返回 2017 年 3 月 和 2017 年 2 月这样一个时间列表，且降序排列，从而帮助我们实现按月归档的目的。</p>
<h2 id="分类模板标签"><a href="#分类模板标签" class="headerlink" title="分类模板标签"></a>分类模板标签</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog/templatetags/blog_tags.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ..models <span class="keyword">import</span> Post, Category</span><br><span class="line"></span><br><span class="line"><span class="meta">@register.simple_tag</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_categories</span>():</span></span><br><span class="line">    <span class="keyword">return</span> Category.objects.<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure>



<h2 id="使用自定义的模板标签"><a href="#使用自定义的模板标签" class="headerlink" title="使用自定义的模板标签"></a>使用自定义的模板标签</h2><p>这次在 <code>&#123;% load staticfiles %&#125; </code>下再导入 blog_tags：<code>&#123;% load blog_tags %&#125;</code></p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;# templates/base.html #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">load</span></span> staticfiles %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">load</span></span> blog_tags %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="xml">...</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;# templates/base.html #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;widget widget-recent-posts&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">&quot;widget-title&quot;</span>&gt;</span>最新文章<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line"><span class="xml">  </span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;% <span class="name">get_recent_posts</span> <span class="keyword">as</span> recent_post_list %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="xml">    </span><span class="comment">&#123;# 使用recent_post_list #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> post <span class="keyword">in</span> recent_post_list %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; post.get_absolute_url &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span></span><span class="template-variable">&#123;&#123; post.title &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">empty</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    暂无文章！</span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>这里我们通过使用 <code>get_recent_posts</code> 模板标签获取到最新文章列表，然后我们通过 <strong>as 语法（Django 模板系统的语法）将获取的文章列表保存进了 <code>recent_post_list</code> 模板变量中</strong>，之后就可以通过 for 循环来循环显示文章列表数据了，这和我们在写首页视图时是一样的。</p>
<h1 id="分类与归档"><a href="#分类与归档" class="headerlink" title="分类与归档"></a>分类与归档</h1><p>略</p>
<h1 id="评论"><a href="#评论" class="headerlink" title="评论"></a>评论</h1><p>相对来说，评论其实是另外一个比较独立的功能。Django 提倡，如果功能相对比较独立的话，最好是创建一个应用，把相应的功能代码写到这个应用里。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># comments/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render, get_object_or_404, redirect</span><br><span class="line"><span class="keyword">from</span> blog.models <span class="keyword">import</span> Post</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Comment</span><br><span class="line"><span class="keyword">from</span> .forms <span class="keyword">import</span> CommentForm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">post_comment</span>(<span class="params">request, post_pk</span>):</span></span><br><span class="line">    post = get_object_or_404(Post, pk=post_pk)</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        form = CommentForm(request.POST)</span><br><span class="line">        <span class="keyword">if</span> form.is_valid():</span><br><span class="line">            <span class="comment"># commit=False 的作用是仅仅利用表单的数据生成 Comment 模型类的实例，但还不保存评论数据到数据库。</span></span><br><span class="line">            comment = form.save(commit=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 将评论和被评论的文章关联起来。</span></span><br><span class="line">            comment.post = post</span><br><span class="line"></span><br><span class="line">            comment.save()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 重定向到 post 的详情页，实际上当 redirect 函数接收一个模型的实例时，它会调用这个模型实例的 get_absolute_url 方法，</span></span><br><span class="line">            <span class="comment"># 然后重定向到 get_absolute_url 方法返回的 URL。</span></span><br><span class="line">            <span class="keyword">return</span> redirect(post)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            comment_list = post.comment_set.<span class="built_in">all</span>()</span><br><span class="line">            context = &#123;<span class="string">&#x27;post&#x27;</span>: post,</span><br><span class="line">                       <span class="string">&#x27;form&#x27;</span>: form,</span><br><span class="line">                       <span class="string">&#x27;comment_list&#x27;</span>: comment_list</span><br><span class="line">                       &#125;</span><br><span class="line">            <span class="keyword">return</span> render(request, <span class="string">&#x27;blog/detail.html&#x27;</span>, context=context)</span><br><span class="line">    <span class="comment"># 不是 post 请求，说明用户没有提交数据，重定向到文章详情页。</span></span><br><span class="line">    <span class="keyword">return</span> redirect(post)</span><br></pre></td></tr></table></figure>

<p>这里 <code>post.comment_set.all()</code> 也等价于 <code>Comment.objects.filter(post=post)</code>，即根据 <code>post</code> 来过滤该 <code>post</code> 下的全部评论。</p>
<h1 id="已知小问题修正"><a href="#已知小问题修正" class="headerlink" title="已知小问题修正"></a>已知小问题修正</h1><p>略</p>
<h1 id="使用-Nginx-和-Gunicorn-部署-Django-博客"><a href="#使用-Nginx-和-Gunicorn-部署-Django-博客" class="headerlink" title="使用 Nginx 和 Gunicorn 部署 Django 博客"></a>使用 Nginx 和 Gunicorn 部署 Django 博客</h1><p>略</p>
<h1 id="使用-Fabric-自动化部署"><a href="#使用-Fabric-自动化部署" class="headerlink" title="使用 Fabric 自动化部署"></a>使用 Fabric 自动化部署</h1><p>略</p>
<h1 id="统计文章阅读量"><a href="#统计文章阅读量" class="headerlink" title="统计文章阅读量"></a>统计文章阅读量</h1><p>一旦用户访问了某篇文章，这时就应该将 <code>views</code> 的值 +1，这个过程最好由 <code>Post</code> 模型自己来完成，因此再给模型添加一个自定义的方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog/models.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="comment"># ... 其它已有字段</span></span><br><span class="line">    <span class="comment"># 新增 views 字段记录阅读量</span></span><br><span class="line">    views = models.PositiveIntegerField(default=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ... 其它已有的模型方法</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">increase_views</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.update(reading=F(<span class="string">&#x27;reading&#x27;</span>) + <span class="number">1</span>)</span><br></pre></td></tr></table></figure>



<h1 id="自动生成文章摘要"><a href="#自动生成文章摘要" class="headerlink" title="自动生成文章摘要"></a>自动生成文章摘要</h1><p>博客文章的模型有一个 <code>excerpt</code> 字段，这个字段用于存储文章的摘要。目前为止，还只能在 Django Admin 后台手动为文章输入摘要。每次手动输入摘要比较麻烦，对有些文章来说，只要摘取正文的前 N 个字符作为摘要，以便提供文章预览就可以了。因此我们来实现如果文章没有输入摘要，则自动摘取正文的前 N 个字符作为摘要，这有两种实现方法。</p>
<h2 id="复写-save-方法"><a href="#复写-save-方法" class="headerlink" title="复写 save 方法"></a>复写 save 方法</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog/models.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> markdown</span><br><span class="line"><span class="keyword">from</span> django.utils.html <span class="keyword">import</span> strip_tags</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    body = models.TextField()</span><br><span class="line">    excerpt = models.CharField(max_length=<span class="number">200</span>, blank=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save</span>(<span class="params">self, *args, **kwargs</span>):</span>    </span><br><span class="line">        <span class="comment"># 如果没有填写摘要</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.excerpt:</span><br><span class="line">            <span class="comment"># 首先实例化一个 Markdown 类，用于渲染 body 的文本</span></span><br><span class="line">            md = markdown.Markdown(extensions=[</span><br><span class="line">                <span class="string">&#x27;markdown.extensions.extra&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;markdown.extensions.codehilite&#x27;</span>,</span><br><span class="line">            ])</span><br><span class="line">            <span class="comment"># 先将 Markdown 文本渲染成 HTML 文本</span></span><br><span class="line">            <span class="comment"># strip_tags 去掉 HTML 文本的全部 HTML 标签</span></span><br><span class="line">            <span class="comment"># 从文本摘取前 54 个字符赋给 excerpt</span></span><br><span class="line">            self.excerpt = strip_tags(md.convert(self.body))[:<span class="number">54</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 调用父类的 save 方法将数据保存到数据库中</span></span><br><span class="line">        <span class="built_in">super</span>(Post, self).save(*args, **kwargs)</span><br></pre></td></tr></table></figure>

<h2 id="使用-truncatechars-模板过滤器"><a href="#使用-truncatechars-模板过滤器" class="headerlink" title="使用 truncatechars 模板过滤器"></a>使用 truncatechars 模板过滤器</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># templates/blog/index.html</span></span><br><span class="line"></span><br><span class="line">&lt;article <span class="class"><span class="keyword">class</span>=&quot;<span class="title">post</span> <span class="title">post</span>-&#123;&#123; <span class="title">post</span>.<span class="title">pk</span> &#125;&#125;&quot;&gt;</span></span><br><span class="line"><span class="class">  &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">entry</span>-<span class="title">content</span> <span class="title">clearfix</span>&quot;&gt;</span></span><br><span class="line"><span class="class">      &lt;<span class="title">p</span>&gt;&#123;&#123; <span class="title">post</span>.<span class="title">body</span>|<span class="title">truncatechars</span>:</span><span class="number">54</span> &#125;&#125;&lt;/p&gt;</span><br><span class="line">      &lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">read</span>-<span class="title">more</span> <span class="title">cl</span>-<span class="title">effect</span>-14&quot;&gt;</span></span><br><span class="line"><span class="class">          &lt;<span class="title">a</span> <span class="title">href</span>=&quot;&#123;&#123; <span class="title">post</span>.<span class="title">get_absolute_url</span> &#125;&#125;&quot; <span class="title">class</span>=&quot;<span class="title">more</span>-<span class="title">link</span>&quot;&gt;继续阅读 &lt;<span class="title">span</span> <span class="title">class</span>=&quot;<span class="title">meta</span>-<span class="title">nav</span>&quot;&gt;→&lt;/<span class="title">span</span>&gt;&lt;/<span class="title">a</span>&gt;</span></span><br><span class="line"><span class="class">      &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">  &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">article</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h1 id="基于类的通用视图：ListView-和-DetailView"><a href="#基于类的通用视图：ListView-和-DetailView" class="headerlink" title="基于类的通用视图：ListView 和 DetailView"></a>基于类的通用视图：ListView 和 DetailView</h1><p>在开发网站的过程中，有一些视图函数虽然处理的对象不同，但是其大致的代码逻辑是一样的。比如一个博客和一个论坛，通常其首页都是展示一系列的文章列表或者帖子列表。对处理首页的视图函数来说，虽然其处理的对象一个是文章，另一个是帖子，但是其处理的过程是非常类似的。首先是从数据库取出文章或者帖子列表，然后将这些数据传递给模板并渲染模板。于是，Django 把这些相同的逻辑代码抽取了出来，写成了一系列的通用视图函数，即基于类的通用视图（Class Based View）。</p>
<h2 id="将-index-视图函数改写为类视图"><a href="#将-index-视图函数改写为类视图" class="headerlink" title="将 index 视图函数改写为类视图"></a>将 index 视图函数改写为类视图</h2><p><strong>针对这种从数据库中获取某个模型列表数据（比如这里的 Post 列表）的视图</strong>，Django 专门提供了一个 <code>ListView</code>类视图。<br>下面我们通过一个例子来看看 <code>ListView</code> 的使用方法。我们首先把 <code>index</code> 视图函数改造成类视图函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> ListView</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexView</span>(<span class="params">ListView</span>):</span></span><br><span class="line">    model = Post</span><br><span class="line">    template_name = <span class="string">&#x27;blog/index.html&#x27;</span></span><br><span class="line">    context_object_name = <span class="string">&#x27;post_list&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这里 <code>IndexView</code> 的功能是从数据库中获取文章（Post）列表，**<code>ListView</code> 就是从数据库中获取某个模型列表数据的**，所以 <code>IndexView</code> 继承 <code>ListView</code>。</p>
<ul>
<li>model。将 model 指定为 <code>Post</code>，告诉 Django 我要获取的模型是 <code>Post</code>。</li>
<li>template_name。指定这个视图渲染的模板。</li>
<li>context_object_name。指定获取的模型列表数据保存的变量名。这个变量会被传递给模板。</li>
</ul>
<p>将类视图的代码和 <code>index</code> 视图函数的代码对比一下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span></span><br><span class="line">    post_list = Post.objects.<span class="built_in">all</span>()</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">&#x27;blog/index.html&#x27;</span>, context=&#123;<span class="string">&#x27;post_list&#x27;</span>: post_list&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="将-category-视图函数改写为类视图"><a href="#将-category-视图函数改写为类视图" class="headerlink" title="将 category 视图函数改写为类视图"></a>将 category 视图函数改写为类视图</h2><p><code>category</code> 视图函数的功能也是从数据库中获取文章列表数据，不过其和 <code>index</code> 视图函数不同的是，<strong>它获取的是某个分类下的全部文章</strong>。因此 <code>category</code> 视图函数中多了一步，即首先需要根据从 URL 中捕获的分类 id 并从数据库获取分类，然后使用 <code>filter</code> 函数过滤出该分类下的全部文章。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryView</span>(<span class="params">ListView</span>):</span></span><br><span class="line">    model = Post</span><br><span class="line">    template_name = <span class="string">&#x27;blog/index.html&#x27;</span></span><br><span class="line">    context_object_name = <span class="string">&#x27;post_list&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        cate = get_object_or_404(Category, pk=self.kwargs.get(<span class="string">&#x27;pk&#x27;</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>(CategoryView, self).get_queryset().<span class="built_in">filter</span>(category=cate)</span><br></pre></td></tr></table></figure>

<p>我们覆写了父类的 <code>get_queryset</code> 方法。该方法默认获取指定模型的全部列表数据。为了获取指定分类下的文章列表数据，我们覆写该方法，改变它的默认行为。</p>
<p>首先是需要根据从 URL 中捕获的分类 id（也就是 pk）获取分类，这和 <code>category</code> 视图函数中的过程是一样的。不过注意一点的是，<strong>在类视图中，从 URL 捕获的命名组参数值保存在实例的 <code>kwargs</code> 属性（是一个字典）里，非命名组参数值保存在实例的 <code>args</code> 属性（是一个列表）里。</strong>所以我们使了 <code>self.kwargs.get(&#39;pk&#39;)</code> 来获取从 URL 捕获的分类 id 值。然后我们调用父类的 <code>get_queryset</code> 方法获得全部文章列表，紧接着就对返回的结果调用了 <code>filter</code> 方法来筛选该分类下的全部文章并返回。</p>
<p>此外我们可以看到 <code>CategoryView</code> 类中指定的属性值和 <code>IndexView</code> 中是一模一样的，所以如果为了进一步节省代码，甚至可以直接继承 <code>IndexView</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryView</span>(<span class="params">IndexView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        cate = get_object_or_404(Category, pk=self.kwargs.get(<span class="string">&#x27;pk&#x27;</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>(CategoryView, self).get_queryset().<span class="built_in">filter</span>(category=cate)</span><br></pre></td></tr></table></figure>

<h2 id="DetailView"><a href="#DetailView" class="headerlink" title="DetailView"></a>DetailView</h2><p>除了从数据库中获取<strong>模型列表</strong>的数据外，<strong>从数据库获取模型的一条记录数据</strong>也是常见的需求。<br>比如查看某篇文章的详情，就是从数据库中获取这篇文章的记录然后渲染模板。对于这种类型的需求，Django 提供了一个 <code>DetailView</code>类视图。下面我们就来将 <code>detail</code> 视图函数转换为等价的类视图 <code>PostDetailView</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> ListView, DetailView</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostDetailView</span>(<span class="params">DetailView</span>):</span></span><br><span class="line">    model = Post</span><br><span class="line">    template_name = <span class="string">&#x27;blog/detail.html&#x27;</span></span><br><span class="line">    context_object_name = <span class="string">&#x27;post&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 覆写 get 方法的目的是因为每当文章被访问一次，就得将文章阅读量 +1</span></span><br><span class="line">        <span class="comment"># get 方法返回的是一个 HttpResponse 实例</span></span><br><span class="line">        <span class="comment"># 之所以需要先调用父类的 get 方法，是因为只有当 get 方法被调用后，</span></span><br><span class="line">        <span class="comment"># 才有 self.object 属性，其值为 Post 模型实例，即被访问的文章 post</span></span><br><span class="line">        response = <span class="built_in">super</span>(PostDetailView, self).get(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 将文章阅读量 +1</span></span><br><span class="line">        <span class="comment"># 注意 self.object 的值就是被访问的文章 post</span></span><br><span class="line">        self.<span class="built_in">object</span>.increase_views()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 视图必须返回一个 HttpResponse 对象</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_object</span>(<span class="params">self, queryset=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="comment"># 覆写 get_object 方法的目的是因为需要对 post 的 body 值进行渲染</span></span><br><span class="line">        post = <span class="built_in">super</span>(PostDetailView, self).get_object(queryset=<span class="literal">None</span>)</span><br><span class="line">        post.body = markdown.markdown(post.body,</span><br><span class="line">                                      extensions=[</span><br><span class="line">                                          <span class="string">&#x27;markdown.extensions.extra&#x27;</span>,</span><br><span class="line">                                          <span class="string">&#x27;markdown.extensions.codehilite&#x27;</span>,</span><br><span class="line">                                          <span class="string">&#x27;markdown.extensions.toc&#x27;</span>,</span><br><span class="line">                                      ])</span><br><span class="line">        <span class="keyword">return</span> post</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_context_data</span>(<span class="params">self, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 覆写 get_context_data 的目的是因为除了将 post 传递给模板外（DetailView 已经帮我们完成），</span></span><br><span class="line">        <span class="comment"># 还要把评论表单、post 下的评论列表传递给模板。</span></span><br><span class="line">        context = <span class="built_in">super</span>(PostDetailView, self).get_context_data(**kwargs)</span><br><span class="line">        form = CommentForm()</span><br><span class="line">        comment_list = self.<span class="built_in">object</span>.comment_set.<span class="built_in">all</span>()</span><br><span class="line">        context.update(&#123;</span><br><span class="line">            <span class="string">&#x27;form&#x27;</span>: form,</span><br><span class="line">            <span class="string">&#x27;comment_list&#x27;</span>: comment_list</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> context</span><br></pre></td></tr></table></figure>

<p>我们覆写了 <code>get</code> 方法。这对应着 <code>detail</code> 视图函数中将 post 的阅读量 +1 的那部分代码。你可以简单地<strong>把 <code>get</code> 方法的调用看成是 <code>detail</code> 视图函数的调用</strong>。</p>
<p>我们复写了 <code>get_object</code> 方法。这对应着 <code>detail</code> 视图函数中根据文章的 id（也就是 pk）获取文章，然后对文章的 post.body 进行 Markdown 渲染的代码部分。</p>
<p>我们复写了 <code>get_context_data</code> 方法。这部分对应着 <code>detail</code> 视图函数中生成评论表单、获取 post 下的评论列表的代码部分。这个方法返回的值是一个字典，这个字典就是模板变量字典，最终会被传递给模板。</p>
<p>你可以简单地把 <code>get</code> 方法看成是 <code>detail</code> 视图函数，至于其它的像 <code>get_object</code>、<code>get_context_data</code> 都是辅助方法，<strong>这些方法最终在 <code>get</code> 方法中被调用</strong>，这里你没有看到被调用的原因是它们隐含在了 <code>super(PostDetailView, self).get(request, *args, **kwargs)</code> 即父类 <code>get</code> 方法的调用中。最终传递给浏览器的 HTTP 响应就是 <code>get</code> 方法返回的 <code>HttpResponse</code> 对象。</p>
<h2 id="Django-Pagination-简单分页"><a href="#Django-Pagination-简单分页" class="headerlink" title="Django Pagination 简单分页"></a>Django Pagination 简单分页</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.core.paginator <span class="keyword">import</span> Paginator, EmptyPage, PageNotAnInteger</span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">listing</span>(<span class="params">request</span>):</span></span><br><span class="line">    contact_list = Contacts.objects.<span class="built_in">all</span>()</span><br><span class="line">    paginator = Paginator(contact_list, <span class="number">25</span>) <span class="comment"># 每页显示 25 个联系人</span></span><br><span class="line"></span><br><span class="line">    page = request.GET.get(<span class="string">&#x27;page&#x27;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        contacts = paginator.page(page)</span><br><span class="line">    <span class="keyword">except</span> PageNotAnInteger:</span><br><span class="line">        <span class="comment"># 如果用户请求的页码号不是整数，显示第一页</span></span><br><span class="line">        contacts = paginator.page(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span> EmptyPage:</span><br><span class="line">        <span class="comment"># 如果用户请求的页码号超过了最大页码号，显示最后一页</span></span><br><span class="line">        contacts = paginator.page(paginator.num_pages)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">&#x27;list.html&#x27;</span>, &#123;<span class="string">&#x27;contacts&#x27;</span>: contacts&#125;)</span><br></pre></td></tr></table></figure>

<p>基于类的通用视图：ListView 和 DetailView 中的内容，我们已将视图函数转换成了类视图。而<strong>类视图 ListView 已经帮我们写好了上述的分页逻辑，我们只需通过指定 paginate_by 属性来开启分页功能即可</strong>，即在类视图中指定 paginate_by 属性的值：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexView</span>(<span class="params">ListView</span>):</span></span><br><span class="line">    model = Post</span><br><span class="line">    template_name = <span class="string">&#x27;blog/index.html&#x27;</span></span><br><span class="line">    context_object_name = <span class="string">&#x27;post_list&#x27;</span></span><br><span class="line">    <span class="comment"># 指定 paginate_by 属性后开启分页功能，其值代表每一页包含多少篇文章</span></span><br><span class="line">    paginate_by = <span class="number">10</span></span><br></pre></td></tr></table></figure>

<h2 id="在模板中设置分页导航"><a href="#在模板中设置分页导航" class="headerlink" title="在模板中设置分页导航"></a>在模板中设置分页导航</h2><p>接下来便是在模板中设置分页导航，比如上一页、下一页的按钮，以及显示一些页面信息。</p>
<p><code>ListView</code> 传递了以下和分页有关的模板变量供我们在模板中使用：</p>
<ul>
<li><code>paginator</code> ，即 <code>Paginator</code> 的实例。</li>
<li><code>page_obj</code> ，当前请求页面分页对象。</li>
<li><code>is_paginated</code>，是否已分页。只有当分页后页面超过两页时才算已分页。</li>
<li><code>object_list</code>，请求页面的对象列表，和 <code>post_list</code> 等价。所以在模板中循环文章列表时可以选 <code>post_list</code> ，也可以选 <code>object_list</code>。</li>
</ul>
<p>模板中使用示例：</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;# templates/blog/index.html #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> is_paginated %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;pagination-simple&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="comment">&lt;!-- 如果当前页还有上一页，显示一个上一页的按钮 --&gt;</span></span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> page_obj.has_previous %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;?page=</span></span></span><span class="template-variable">&#123;&#123; page_obj.previous_page_number &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span>上一页<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">  <span class="comment">&lt;!-- 显示当前页面信息 --&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;current&quot;</span>&gt;</span>第 </span><span class="template-variable">&#123;&#123; page_obj.number &#125;&#125;</span><span class="xml"> 页 / 共 </span><span class="template-variable">&#123;&#123; paginator.num_pages &#125;&#125;</span><span class="xml"> 页<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="comment">&lt;!-- 如果当前页还有下一页，显示一个下一页的按钮 --&gt;</span></span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> page_obj.has_next %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;?page=</span></span></span><span class="template-variable">&#123;&#123; page_obj.next_page_number &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span>下一页<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span></span><br></pre></td></tr></table></figure>



<h1 id="Django-Pagination-完善分页"><a href="#Django-Pagination-完善分页" class="headerlink" title="Django Pagination 完善分页"></a>Django Pagination 完善分页</h1><p>在 Django Pagination 简单分页 中，我们实现了一个简单的分页导航效果。但效果有点差强人意，我们只能点上一页和下一页的按钮进行翻页。比较完善的分页效果应该像下面这样，但想实现这样一种效果，Django Pagination 内置的 API 已无能为力。本文将通过拓展 Django Pagination 来实现下图这样比较完善的分页效果。</p>
<p><img src="/images/%E9%AB%98%E7%BA%A7%E5%88%86%E9%A1%B5%E6%95%88%E6%9E%9C.png" alt="é&quot;çº§åé¡µææå¾"></p>
<p>一个比较完善的分页效果应该具有以下特性，就像上图展示的那样，很多网站都采用了类似这种的分页导航方式</p>
<ul>
<li>始终显示第一页和最后一页。</li>
<li>当前页码高亮显示。</li>
<li>显示当前页码前后几个连续的页码。</li>
<li>如果两个页码号间还有其它页码，中间显示省略号以提示用户。</li>
</ul>
<p>先来分析一下导航条的组成部分，可以看到整个分页导航条其实可以分成 七个部分：</p>
<ol>
<li>第 1 页页码，这一页需要始终显示。</li>
<li>第 1 页页码后面的省略号部分。但要注意如果第 1 页的页码号后面紧跟着页码号 2，那么省略号就不应该显示。</li>
<li>当前页码的左边部分，比如这里的 3-6。</li>
<li>当前页码，比如这里的 7。</li>
<li>当前页码的右边部分，比如这里的 8-11。</li>
<li>最后一页页码前面的省略号部分。但要注意如果最后一页的页码号前面跟着的页码号是连续的，那么省略号就不应该显示。</li>
<li>最后一页的页码号。</li>
</ol>
<p>因此我们的思路是，在视图里将以上七步中所需要的数据生成，然后传递给模板并在模板中渲染显示即可。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexView</span>(<span class="params">ListView</span>):</span></span><br><span class="line">    model = Post</span><br><span class="line">    template_name = <span class="string">&#x27;blog/index.html&#x27;</span></span><br><span class="line">    context_object_name = <span class="string">&#x27;post_list&#x27;</span></span><br><span class="line">    paginate_by = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_context_data</span>(<span class="params">self, **kwargs</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        在视图函数中将模板变量传递给模板是通过给 render 函数的 context 参数传递一个字典实现的，</span></span><br><span class="line"><span class="string">        例如 render(request, &#x27;blog/index.html&#x27;, context=&#123;&#x27;post_list&#x27;: post_list&#125;)，</span></span><br><span class="line"><span class="string">        这里传递了一个 &#123;&#x27;post_list&#x27;: post_list&#125; 字典给模板。</span></span><br><span class="line"><span class="string">        在类视图中，这个需要传递的模板变量字典是通过 get_context_data 获得的，</span></span><br><span class="line"><span class="string">        所以我们复写该方法，以便我们能够自己再插入一些我们自定义的模板变量进去。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 首先获得父类生成的传递给模板的字典。</span></span><br><span class="line">        context = <span class="built_in">super</span>().get_context_data(**kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 父类生成的字典中已有 paginator、page_obj、is_paginated 这三个模板变量，</span></span><br><span class="line">        <span class="comment"># paginator 是 Paginator 的一个实例，</span></span><br><span class="line">        <span class="comment"># page_obj 是 Page 的一个实例，</span></span><br><span class="line">        <span class="comment"># is_paginated 是一个布尔变量，用于指示是否已分页。</span></span><br><span class="line">        <span class="comment"># 例如如果规定每页 10 个数据，而本身只有 5 个数据，其实就用不着分页，此时 is_paginated=False。</span></span><br><span class="line">        <span class="comment"># 由于 context 是一个字典，所以调用 get 方法从中取出某个键对应的值。</span></span><br><span class="line">        paginator = context.get(<span class="string">&#x27;paginator&#x27;</span>)</span><br><span class="line">        page = context.get(<span class="string">&#x27;page_obj&#x27;</span>)</span><br><span class="line">        is_paginated = context.get(<span class="string">&#x27;is_paginated&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 调用自己写的 pagination_data 方法获得显示分页导航条需要的数据，见下方。</span></span><br><span class="line">        pagination_data = self.pagination_data(paginator, page, is_paginated)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 将分页导航条的模板变量更新到 context 中，注意 pagination_data 方法返回的也是一个字典。</span></span><br><span class="line">        context.update(pagination_data)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 将更新后的 context 返回，以便 ListView 使用这个字典中的模板变量去渲染模板。</span></span><br><span class="line">        <span class="comment"># 注意此时 context 字典中已有了显示分页导航条所需的数据。</span></span><br><span class="line">        <span class="keyword">return</span> context</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pagination_data</span>(<span class="params">self, paginator, page, is_paginated</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> is_paginated:</span><br><span class="line">            <span class="comment"># 如果没有分页，则无需显示分页导航条，不用任何分页导航条的数据，因此返回一个空的字典</span></span><br><span class="line">            <span class="keyword">return</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 当前页左边连续的页码号，初始值为空</span></span><br><span class="line">        left = []</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 当前页右边连续的页码号，初始值为空</span></span><br><span class="line">        right = []</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 标示第 1 页页码后是否需要显示省略号</span></span><br><span class="line">        left_has_more = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 标示最后一页页码前是否需要显示省略号</span></span><br><span class="line">        right_has_more = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 标示是否需要显示第 1 页的页码号。</span></span><br><span class="line">        <span class="comment"># 因为如果当前页左边的连续页码号中已经含有第 1 页的页码号，此时就无需再显示第 1 页的页码号，</span></span><br><span class="line">        <span class="comment"># 其它情况下第一页的页码是始终需要显示的。</span></span><br><span class="line">        <span class="comment"># 初始值为 False</span></span><br><span class="line">        first = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 标示是否需要显示最后一页的页码号。</span></span><br><span class="line">        <span class="comment"># 需要此指示变量的理由和上面相同。</span></span><br><span class="line">        last = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 获得用户当前请求的页码号</span></span><br><span class="line">        page_number = page.number</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 获得分页后的总页数</span></span><br><span class="line">        total_pages = paginator.num_pages</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 获得整个分页页码列表，比如分了四页，那么就是 [1, 2, 3, 4]</span></span><br><span class="line">        page_range = paginator.page_range</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> page_number == <span class="number">1</span>:</span><br><span class="line">            <span class="comment"># 如果用户请求的是第一页的数据，那么当前页左边的不需要数据，因此 left=[]（已默认为空）。</span></span><br><span class="line">            <span class="comment"># 此时只要获取当前页右边的连续页码号，</span></span><br><span class="line">            <span class="comment"># 比如分页页码列表是 [1, 2, 3, 4]，那么获取的就是 right = [2, 3]。</span></span><br><span class="line">            <span class="comment"># 注意这里只获取了当前页码后连续两个页码，你可以更改这个数字以获取更多页码。</span></span><br><span class="line">            right = page_range[page_number:page_number + <span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 如果最右边的页码号比最后一页的页码号减去 1 还要小，</span></span><br><span class="line">            <span class="comment"># 说明最右边的页码号和最后一页的页码号之间还有其它页码，因此需要显示省略号，通过 right_has_more 来指示。</span></span><br><span class="line">            <span class="keyword">if</span> right[-<span class="number">1</span>] &lt; total_pages - <span class="number">1</span>:</span><br><span class="line">                right_has_more = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 如果最右边的页码号比最后一页的页码号小，说明当前页右边的连续页码号中不包含最后一页的页码</span></span><br><span class="line">            <span class="comment"># 所以需要显示最后一页的页码号，通过 last 来指示</span></span><br><span class="line">            <span class="keyword">if</span> right[-<span class="number">1</span>] &lt; total_pages:</span><br><span class="line">                last = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> page_number == total_pages:</span><br><span class="line">            <span class="comment"># 如果用户请求的是最后一页的数据，那么当前页右边就不需要数据，因此 right=[]（已默认为空），</span></span><br><span class="line">            <span class="comment"># 此时只要获取当前页左边的连续页码号。</span></span><br><span class="line">            <span class="comment"># 比如分页页码列表是 [1, 2, 3, 4]，那么获取的就是 left = [2, 3]</span></span><br><span class="line">            <span class="comment"># 这里只获取了当前页码后连续两个页码，你可以更改这个数字以获取更多页码。</span></span><br><span class="line">            left = page_range[(page_number - <span class="number">3</span>) <span class="keyword">if</span> (page_number - <span class="number">3</span>) &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span>:page_number - <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 如果最左边的页码号比第 2 页页码号还大，</span></span><br><span class="line">            <span class="comment"># 说明最左边的页码号和第 1 页的页码号之间还有其它页码，因此需要显示省略号，通过 left_has_more 来指示。</span></span><br><span class="line">            <span class="keyword">if</span> left[<span class="number">0</span>] &gt; <span class="number">2</span>:</span><br><span class="line">                left_has_more = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 如果最左边的页码号比第 1 页的页码号大，说明当前页左边的连续页码号中不包含第一页的页码，</span></span><br><span class="line">            <span class="comment"># 所以需要显示第一页的页码号，通过 first 来指示</span></span><br><span class="line">            <span class="keyword">if</span> left[<span class="number">0</span>] &gt; <span class="number">1</span>:</span><br><span class="line">                first = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 用户请求的既不是最后一页，也不是第 1 页，则需要获取当前页左右两边的连续页码号，</span></span><br><span class="line">            <span class="comment"># 这里只获取了当前页码前后连续两个页码，你可以更改这个数字以获取更多页码。</span></span><br><span class="line">            left = page_range[(page_number - <span class="number">3</span>) <span class="keyword">if</span> (page_number - <span class="number">3</span>) &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span>:page_number - <span class="number">1</span>]</span><br><span class="line">            right = page_range[page_number:page_number + <span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 是否需要显示最后一页和最后一页前的省略号</span></span><br><span class="line">            <span class="keyword">if</span> right[-<span class="number">1</span>] &lt; total_pages - <span class="number">1</span>:</span><br><span class="line">                right_has_more = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">if</span> right[-<span class="number">1</span>] &lt; total_pages:</span><br><span class="line">                last = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 是否需要显示第 1 页和第 1 页后的省略号</span></span><br><span class="line">            <span class="keyword">if</span> left[<span class="number">0</span>] &gt; <span class="number">2</span>:</span><br><span class="line">                left_has_more = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">if</span> left[<span class="number">0</span>] &gt; <span class="number">1</span>:</span><br><span class="line">                first = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">&#x27;left&#x27;</span>: left,</span><br><span class="line">            <span class="string">&#x27;right&#x27;</span>: right,</span><br><span class="line">            <span class="string">&#x27;left_has_more&#x27;</span>: left_has_more,</span><br><span class="line">            <span class="string">&#x27;right_has_more&#x27;</span>: right_has_more,</span><br><span class="line">            <span class="string">&#x27;first&#x27;</span>: first,</span><br><span class="line">            <span class="string">&#x27;last&#x27;</span>: last,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> is_paginated %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;pagination&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> first %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;?page=1&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> left %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> left_has_more %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>...<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> i <span class="keyword">in</span> left %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;?page=</span></span></span><span class="template-variable">&#123;&#123; i &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span></span><span class="template-variable">&#123;&#123; i &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;?page=</span></span></span><span class="template-variable">&#123;&#123; page_obj.number &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span> <span class="attr">style</span>=<span class="string">&quot;color: red&quot;</span>&gt;</span></span><span class="template-variable">&#123;&#123; page_obj.number &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> right %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> i <span class="keyword">in</span> right %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;?page=</span></span></span><span class="template-variable">&#123;&#123; i &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span></span><span class="template-variable">&#123;&#123; i &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> right_has_more %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>...<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> last %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;?page=</span></span></span><span class="template-variable">&#123;&#123; paginator.num_pages &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span></span><span class="template-variable">&#123;&#123; paginator.num_pages &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span></span><br></pre></td></tr></table></figure>



<h1 id="统计各个分类下的文章数"><a href="#统计各个分类下的文章数" class="headerlink" title="统计各个分类下的文章数"></a>统计各个分类下的文章数</h1><p>在我们的博客侧边栏有分类列表，显示博客已有的全部文章分类。现在想在分类名后显示该分类下有多少篇文章，该怎么做呢？最优雅的方式就是使用 Django 模型管理器的 <code>annotate</code> 方法。</p>
<p>回顾一下我们的模型代码，Django 博客有一个 Post 和 Category 模型，分别表示文章和分类：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog/models.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">70</span>)</span><br><span class="line">    body = models.TextField()</span><br><span class="line">    category = models.ForeignKey(<span class="string">&#x27;Category&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.title</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Category</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<h2 id="使用-Annotate"><a href="#使用-Annotate" class="headerlink" title="使用 Annotate"></a>使用 Annotate</h2><p>在我们的博客中，获取侧边栏的分类列表的方法写在模板标签 <code>get_categories</code> 里，因此我们修改一下这个函数，具体代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog/templatetags/blog_tags.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.db.models.aggregates <span class="keyword">import</span> Count</span><br><span class="line"><span class="keyword">from</span> blog.models <span class="keyword">import</span> Category</span><br><span class="line"></span><br><span class="line"><span class="meta">@register.simple_tag</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_categories</span>():</span></span><br><span class="line">    <span class="comment"># Count 计算分类下的文章数，其接受的参数为需要计数的模型的名称</span></span><br><span class="line">    <span class="keyword">return</span> Category.objects.annotate(num_posts=Count(<span class="string">&#x27;post&#x27;</span>)).<span class="built_in">filter</span>(num_posts__gt=<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>这个 <code>Category.objects.annotate</code> 方法和 <code>Category.objects.all</code> 有点类似，它会返回数据库中全部 Category 的记录，但同时它还会做一些额外的事情，在这里我们希望它做的额外事情就是去<strong>统计返回的 Category 记录的集合中每条记录下的文章数。</strong></p>
<p>代码中的 <code>Count</code> 方法为我们做了这个事，它接收一个和 Categoty 相关联的模型参数名（这里是 <code>Post</code>，通过 ForeignKey 关联的），然后它便会统计 Category 记录的集合中每条记录下的与之关联的 Post 记录的行数，也就是文章数，最后把这个值保存到 <code>num_posts</code> 属性中。</p>
<p>此外，我们还对结果集做了一个过滤，使用 <code>filter</code> 方法把 <code>num_posts</code> 的值小于 1 的分类过滤掉。因为 <code>num_posts</code> 的值小于 1 表示该分类下没有文章，没有文章的分类我们不希望它在页面中显示。</p>
<h2 id="在模板中引用新增的属性"><a href="#在模板中引用新增的属性" class="headerlink" title="在模板中引用新增的属性"></a>在模板中引用新增的属性</h2><p><strong>现在在 Category 列表中每一项都新增了一个 <code>num_posts</code> 属性记录该 Category 下的文章数量</strong>，我们就可以在模板中引用这个属性来显示分类下的文章数量了。</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;# templates/base.html #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> category <span class="keyword">in</span> category_list %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;blog:category&#x27; category.pk %&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span></span><span class="template-variable">&#123;&#123; category.name &#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;post-count&quot;</span>&gt;</span>(</span><span class="template-variable">&#123;&#123; category.num_posts &#125;&#125;</span><span class="xml">)<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">empty</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">  暂无分类！</span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br></pre></td></tr></table></figure>



<h2 id="将-Annotate-用于其它关联关系"><a href="#将-Annotate-用于其它关联关系" class="headerlink" title="将 Annotate 用于其它关联关系"></a>将 Annotate 用于其它关联关系</h2><p>此外，<code>annotate</code> 方法不局限于用于本文提到的统计分类下的文章数，你也可以举一反三，==只要是两个 model 类通过 ForeignKey 或者 ManyToMany 关联起来，那么就可以使用 annotate 方法来统计数量。==比如下面这样一个标签系统：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">70</span>)</span><br><span class="line">    body = models.TextField()</span><br><span class="line">    Tags = models.ManyToManyField(<span class="string">&#x27;Tag&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.title</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tag</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<p>统计标签下的文章数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models.aggregates <span class="keyword">import</span> Count</span><br><span class="line"><span class="keyword">from</span> blog.models <span class="keyword">import</span> Tag</span><br><span class="line"></span><br><span class="line"><span class="comment"># Count 计算分类下的文章数，其接受的参数为需要计数的模型的名称</span></span><br><span class="line">tag_list = Tag.objects.annotate(num_posts=Count(<span class="string">&#x27;post&#x27;</span>))</span><br></pre></td></tr></table></figure>



<h1 id="标签云"><a href="#标签云" class="headerlink" title="标签云"></a>标签云</h1><p>略</p>
<h1 id="RSS-订阅"><a href="#RSS-订阅" class="headerlink" title="RSS 订阅"></a>RSS 订阅</h1><p>博客提供 RSS 订阅应该是标配，这样读者就可以通过一些聚合阅读工具订阅你的博客，时时查看是否有文章更新，而不必每次都跳转到博客上来查看。现在我们就来为博客添加 RSS 订阅功能。</p>
<p>RSS（Really Simple Syndication）是一种描述和同步网站内容的格式，它采用 XML 作为内容传递的格式。简单来说就是网站可以把内容包装成符合 RSS 标准的 XML 格式文档。一旦网站内容符合一个统一的规范，那么人们就可以开发一种读取这种规范化的 XML 文档的工具来聚合各大网站的内容。例如一个读者可能关注了很多的博客网站，如果这些博客网站都支持 RSS 订阅的话，他就只需要一个聚合阅读器订阅这些博客，就可以在聚合器工具里看到全部博客的更新内容，而不必再分别访问各个博客去看有没有内容更新了。</p>
<h2 id="使用-Django-Feed-类"><a href="#使用-Django-Feed-类" class="headerlink" title="使用 Django Feed 类"></a>使用 Django Feed 类</h2><p>根据以上对 RSS 的介绍，我们可以发现关键的地方就是根<strong>据网站的内容生成规范化的 XML 文档，</strong>Django 已经内置了一些生成这个文档的方法，下面就使用这些方法来创建 RSS 订阅文档。</p>
<p>首先我们在 <strong>blog 应用</strong>的根目录下（models.py 所在目录）新建一个 feeds.py 文件以存放和 RSS 功能相关的代码。让后在 feeds.py 中写入如下代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog/feeds.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.contrib.syndication.views <span class="keyword">import</span> Feed</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Post</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AllPostsRssFeed</span>(<span class="params">Feed</span>):</span></span><br><span class="line">    <span class="comment"># 显示在聚合阅读器上的标题</span></span><br><span class="line">    title = <span class="string">&quot;Django 博客教程演示项目&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 通过聚合阅读器跳转到网站的地址</span></span><br><span class="line">    link = <span class="string">&quot;/&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 显示在聚合阅读器上的描述信息</span></span><br><span class="line">    description = <span class="string">&quot;Django 博客教程演示项目测试文章&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 需要显示的内容条目</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">items</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> Post.objects.<span class="built_in">all</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 聚合器中显示的内容条目的标题</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">item_title</span>(<span class="params">self, item</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;[%s] %s&#x27;</span> % (item.category, item.title)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 聚合器中显示的内容条目的描述</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">item_description</span>(<span class="params">self, item</span>):</span></span><br><span class="line">        <span class="keyword">return</span> item.body</span><br></pre></td></tr></table></figure>

<h2 id="添加-URL"><a href="#添加-URL" class="headerlink" title="添加 URL"></a>添加 URL</h2><p>接下来就是指定 URL 模式，让人们访问这个 URL 后就可以看到 <code>Feed</code> 生成的内容。通常 RSS 的 URL 配置直接写在项目的 urls.py 文件里，即打开 blogproject/urls.py 文件，添加如下代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blogproject/urls.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> blog.feeds <span class="keyword">import</span> AllPostsRssFeed</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r&#x27;^admin/&#x27;</span>, admin.site.urls),</span><br><span class="line">    url(<span class="string">r&#x27;&#x27;</span>, include(<span class="string">&#x27;blog.urls&#x27;</span>)),</span><br><span class="line">    url(<span class="string">r&#x27;&#x27;</span>, include(<span class="string">&#x27;comments.urls&#x27;</span>)),</span><br><span class="line">    <span class="comment"># 记得在顶部引入 AllPostsRssFeed</span></span><br><span class="line">    url(<span class="string">r&#x27;^all/rss/$&#x27;</span>, AllPostsRssFeed(), name=<span class="string">&#x27;rss&#x27;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="修改模板"><a href="#修改模板" class="headerlink" title="修改模板"></a>修改模板</h2><p>简单修改一下模板，把 RSS 的 URL 添加到模板中：</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;rss&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;rss&#x27; %&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;ion-social-rss-outline&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span> RSS 订阅<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>运行开发服务器，在侧边栏点击 RSS 订阅的链接，就跳转到 /all/rss/，你会看到这对乱码一样的东西，这就是生成的 RSS 标准文档，当然这个文档不是给你读的，而是给 RSS 聚合阅读器工具读的。</p>
<h2 id="RSS-测试插件"><a href="#RSS-测试插件" class="headerlink" title="RSS 测试插件"></a>RSS 测试插件</h2><p>可以在本地测试一下订阅效果，Chrome 浏览器安装 RSS Feed Reader 的应用。</p>
<p><img src="/images/rss%E8%AE%A2%E9%98%85.png" alt="rssè®¢é"></p>
<h1 id="Markdown-自动生成文章目录"><a href="#Markdown-自动生成文章目录" class="headerlink" title="Markdown 自动生成文章目录"></a>Markdown 自动生成文章目录</h1><p>在渲染 Markdown 文本时加入了 toc 拓展后，就可以在文中插入目录了。方法是在书写 Markdown 文本时，在你想生成目录的地方插入 [TOC] 标记即可</p>
<p>例如新写一篇 Markdown 博文，其 Markdown 文本内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[TOC]</span><br><span class="line"></span><br><span class="line">## 我是标题一</span><br><span class="line"></span><br><span class="line">这是标题一下的正文</span><br><span class="line"></span><br><span class="line">## 我是标题二</span><br><span class="line"></span><br><span class="line">这是标题二下的正文</span><br><span class="line"></span><br><span class="line">### 我是标题二下的子标题</span><br><span class="line">这是标题二下的子标题的正文</span><br><span class="line"></span><br><span class="line">## 我是标题三</span><br><span class="line">这是标题三下的正文</span><br></pre></td></tr></table></figure>

<p>其最终渲染后的效果就是：</p>
<p><img src="/images/Markdown%E6%96%87%E4%B8%AD%E7%9B%AE%E5%BD%95.png" alt="Markdownæä¸­ç®å½"></p>
<h2 id="在页面的任何地方插入目录"><a href="#在页面的任何地方插入目录" class="headerlink" title="在页面的任何地方插入目录"></a>在页面的任何地方插入目录</h2><p>上述方式的一个局限局限性就是只能通过 [TOC] 标记在文章内容中插入目录。如果我想在页面的其它地方，比如侧边栏插入一个目录该怎么做呢？方法其实也很简单，只需要稍微改动一下渲染 Markdown 文本内容的方式即可，具体代码就像这样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostDetailView</span>(<span class="params">DetailView</span>):</span></span><br><span class="line">    model = Post</span><br><span class="line">    template_name = <span class="string">&#x27;blog/detail.html&#x27;</span></span><br><span class="line">    context_object_name = <span class="string">&#x27;post&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_object</span>(<span class="params">self, queryset=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="comment"># 覆写 get_object 方法的目的是因为需要对 post 的 body 值进行渲染</span></span><br><span class="line">        md = markdown.Markdown(extensions=[</span><br><span class="line">            <span class="string">&#x27;markdown.extensions.extra&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;markdown.extensions.codehilite&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;markdown.extensions.toc&#x27;</span>,</span><br><span class="line">        ])</span><br><span class="line">        post.body = md.convert(post.body)</span><br><span class="line">        post.toc = md.toc</span><br><span class="line">        <span class="keyword">return</span> post</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_context_data</span>(<span class="params">self, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># ...</span></span><br></pre></td></tr></table></figure>

<p>和之前的代码不同，在 <code>get_object</code> 方法中我们没有直接用 <code>markdown.markdown()</code> 方法来渲染 <code>post.body</code> 中的内容，而是先实例化了一个 <code>markdown.Markdown</code> 类 <code>md</code>，和 <code>markdown.markdown()</code> 方法一样，也传入了 <code>extensions</code> 参数。接着我们便使用该实例的 <code>convert</code> 方法将 <code>post.body</code> 中的 Markdown 文本渲染成 HTML 文本。而一旦调用该方法后，实例 <code>md</code> 就会多出一个 <code>toc</code> 属性，这个属性的值就是内容的目录，我们把 <code>md.toc</code> 的值赋给 <code>post.toc</code> 属性（要注意这个 post 实例本身是没有 md 属性的，我们给它动态添加了 md 属性，这就是 Python 动态语言的好处，不然这里还真不知道该怎么把 toc 的值传给模板）。</p>
<p>接下来就在博客文章详情页的文章目录侧边栏渲染文章的目录吧！删掉占位用的目录内容，替换成如下代码：</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> toc %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;widget widget-content&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">&quot;widget-title&quot;</span>&gt;</span>文章目录<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line"><span class="xml">        </span><span class="template-variable">&#123;&#123; post.toc|<span class="name">safe</span> &#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> toc %&#125;</span></span><br></pre></td></tr></table></figure>



<h1 id="简单全文搜索"><a href="#简单全文搜索" class="headerlink" title="简单全文搜索"></a>简单全文搜索</h1><p>搜索是一个复杂的功能，但对于一些简单的搜索任务，我们可以使用 Django Model 层提供的一些内置方法来完成。</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>博客文章通常包含标题和正文两个部分。当用户输入某个关键词进行搜索后，我们希望为用户显示标题和正文中含有被搜索关键词的全部文章。整个搜索的过程如下：</p>
<ol>
<li>用户在搜素框中输入搜索关键词，假设为 “django”，然后用户点击了搜索按钮提交其输入的结果到服务器。</li>
<li>服务器接收到用户输入的搜索关键词 “django” 后去数据库查找文章标题和正文中含有该关键词的全部文章。</li>
<li>服务器将查询结果返回给用户。</li>
</ol>
<h2 id="将关键词提交给服务器"><a href="#将关键词提交给服务器" class="headerlink" title="将关键词提交给服务器"></a>将关键词提交给服务器</h2><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;# base.html #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">role</span>=<span class="string">&quot;search&quot;</span> <span class="attr">method</span>=<span class="string">&quot;get&quot;</span> <span class="attr">id</span>=<span class="string">&quot;searchform&quot;</span> <span class="attr">action</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;blog:search&#x27; %&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;search&quot;</span> <span class="attr">name</span>=<span class="string">&quot;q&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;搜索&quot;</span> <span class="attr">required</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;ion-ios-search-strong&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Q</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">search</span>(<span class="params">request</span>):</span></span><br><span class="line">    q = request.GET.get(<span class="string">&#x27;q&#x27;</span>)</span><br><span class="line">    error_msg = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> q:</span><br><span class="line">        error_msg = <span class="string">&quot;请输入关键词&quot;</span></span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">&#x27;blog/index.html&#x27;</span>, &#123;<span class="string">&#x27;error_msg&#x27;</span>: error_msg&#125;)</span><br><span class="line"></span><br><span class="line">    post_list = Post.objects.<span class="built_in">filter</span>(Q(title__icontains=q) | Q(body__icontains=q))</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">&#x27;blog/index.html&#x27;</span>, &#123;<span class="string">&#x27;error_msg&#x27;</span>: error_msg,</span><br><span class="line">                                               <span class="string">&#x27;post_list&#x27;</span>: post_list&#125;)</span><br></pre></td></tr></table></figure>

<p>如果用户输入了搜索关键词，我们就通过 <code>filter</code> 方法从数据库里<strong>过滤出符合条件的所有文章</strong>。这里的过滤条件是 <code>title__icontains=q</code>，即 title 中包含（contains）关键字 q，前缀 i 表示不区分大小写。</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;# templates/blog/index.html #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">extends</span></span> &#x27;base.html&#x27; %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> main %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> error_msg %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><span class="template-variable">&#123;&#123; error_msg &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> post <span class="keyword">in</span> post_list %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    ...</span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">empty</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;no-post&quot;</span>&gt;</span>暂时还没有发布的文章！<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> main %&#125;</span></span><br></pre></td></tr></table></figure>

<p>django-haystack 这款第三方 app 为我们完成了全部工作。使用它我们可以实现更加复杂的搜索功能，比如全文检索、按搜索相关度排序、关键字高亮等等类似于百度搜索的功能，功能十分强大。</p>
<h1 id="Django-Haystack-全文检索与关键词高亮"><a href="#Django-Haystack-全文检索与关键词高亮" class="headerlink" title="Django Haystack 全文检索与关键词高亮"></a>Django Haystack 全文检索与关键词高亮</h1><p>django-haystack 是一个专门提供搜索功能的 django 第三方应用，它支持 Solr、Elasticsearch、Whoosh、Xapian 等多种搜索引擎，配合著名的中文自然语言处理库 jieba 分词，就可以为我们的博客提供一个效果不错的博客文章搜索系统。</p>
<h2 id="安装必要依赖"><a href="#安装必要依赖" class="headerlink" title="安装必要依赖"></a>安装必要依赖</h2><ul>
<li>Whoosh。Whoosh 是一个由纯 Python 实现的全文搜索引擎，没有二进制文件等，比较小巧，配置简单方便。</li>
<li>jieba 中文分词。由于 Whoosh 自带的是英文分词，对中文的分词支持不是太好，所以使用 jieba 替换Whoosh 的分词组件。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install whoosh django-haystack jieba</span><br></pre></td></tr></table></figure>

<h2 id="配置-Haystack"><a href="#配置-Haystack" class="headerlink" title="配置 Haystack"></a>配置 Haystack</h2><p>首先是把 django haystack 加入到 <code>INSTALLED_APPS</code> 选项里,然后加入如下配置项：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blogproject/settings.py</span></span><br><span class="line"></span><br><span class="line">HAYSTACK_CONNECTIONS = &#123;</span><br><span class="line">    <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;blog.whoosh_cn_backend.WhooshEngine&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;PATH&#x27;</span>: os.path.join(BASE_DIR, <span class="string">&#x27;whoosh_index&#x27;</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line">HAYSTACK_SEARCH_RESULTS_PER_PAGE = <span class="number">10</span></span><br><span class="line">HAYSTACK_SIGNAL_PROCESSOR = <span class="string">&#x27;haystack.signals.RealtimeSignalProcessor&#x27;</span></span><br></pre></td></tr></table></figure>

<p><code>HAYSTACK_CONNECTIONS</code> 的 <code>ENGINE</code> 指定了 django haystack 使用的搜索引擎，这里我们使用了 <code>blog.whoosh_cn_backend.WhooshEngine</code>，虽然目前这个引擎还不存在，但我们接下来会创建它。<code>PATH</code> 指定了索引文件需要存放的位置，我们设置为项目根目录 <code>BASE_DIR</code> 下的 whoosh_index 文件夹（在建立索引是会自动创建）。</p>
<p><code>HAYSTACK_SEARCH_RESULTS_PER_PAGE</code> 指定如何对搜索结果分页，这里设置为每 10 项结果为一页。</p>
<p><code>HAYSTACK_SIGNAL_PROCESSOR</code> 指定什么时候更新索引，这里我们使用 <code>haystack.signals.RealtimeSignalProcessor</code>，作用是每当有文章更新时就更新索引。由于博客文章更新不会太频繁，因此实时更新没有问题。</p>
<h2 id="处理数据"><a href="#处理数据" class="headerlink" title="处理数据"></a>处理数据</h2><p>接下来就要告诉 django haystack 使用那些数据建立索引以及如何存放索引。如果要对 blog 应用下的数据进行全文检索，做法是在 blog 应用下建立一个 search_indexes.py 文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blog/search_indexes.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> haystack <span class="keyword">import</span> indexes</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Post</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostIndex</span>(<span class="params">indexes.SearchIndex, indexes.Indexable</span>):</span></span><br><span class="line">    text = indexes.CharField(document=<span class="literal">True</span>, use_template=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_model</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> Post</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">index_queryset</span>(<span class="params">self, using=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.get_model().objects.<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure>

<p>这是 django haystack 的规定。要相对某个 app 下的数据进行全文检索，就要在该 app 下创建一个 search_indexes.py 文件，然后创建一个 XXIndex 类（XX 为含有被检索数据的模型，如这里的 Post），并且继承 <code>SearchIndex</code> 和 <code>Indexable</code>。</p>
<p>为什么要创建索引？索引就像是一本书的目录，可以为读者提供更快速的导航与查找。在这里也是同样的道理，当数据量非常大的时候，若要从这些数据里找出所有的满足搜索条件的几乎是不太可能的，将会给服务器带来极大的负担。所以我们需要为指定的数据添加一个索引（目录），在这里是为 Post 创建一个索引，索引的实现细节是我们不需要关心的，我们只关心为哪些字段创建索引，如何指定。</p>
<p>每个索引里面必须有且只能有一个字段为 <code>document=True</code>，<strong>这代表 django haystack 和搜索引擎将使用此字段的内容作为索引进行检索(primary field)。</strong>注意，如果使用一个字段设置了<code>document=True</code>，则一般约定此字段名为<code>text</code>，这是在 <code>SearchIndex</code> 类里面一贯的命名，以防止后台混乱，当然名字你也可以随便改，不过不建议改。</p>
<p>并且，haystack 提供了use_template=True 在 text 字段中，这样就允许我们使用数据模板去建立搜索引擎索引的文件，说得通俗点就是<strong>索引里面需要存放一些什么东西，例如 Post 的 title 字段，这样我们可以通过 title 内容来检索 Post 数据了。</strong><br>举个例子，假如你搜索 Python ，那么就可以检索出 title 中含有 Python 的Post了，是不是很简单？数据模板的路径为<code> templates/search/indexes/youapp/\&lt;model_name&gt;_text.txt</code>（例如 templates/search/indexes/blog/post_text.txt），其内容为：</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;# templates/search/indexes/blog/post_text.txt #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123; object.title &#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123; object.body &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>这个数据模板的作用是对 Post.title、Post.body 这两个字段建立索引，当检索的时候会对这两个字段做全文检索匹配，然后将匹配的结果排序后作为搜索结果返回。</p>
<h2 id="配置-URL"><a href="#配置-URL" class="headerlink" title="配置 URL"></a>配置 URL</h2><p>搜索的视图函数和 URL 模式 django haystack 都已经帮我们写好了，只需要项目的 urls.py 中包含它：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blogproject/urls.py</span></span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r&#x27;^search/&#x27;</span>, include(<span class="string">&#x27;haystack.urls&#x27;</span>)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="修改搜索表单"><a href="#修改搜索表单" class="headerlink" title="修改搜索表单"></a>修改搜索表单</h2><p>修改一下搜索表单，让它提交数据到 django haystack 搜索视图对应的 URL：</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">role</span>=<span class="string">&quot;search&quot;</span> <span class="attr">method</span>=<span class="string">&quot;get&quot;</span> <span class="attr">id</span>=<span class="string">&quot;searchform&quot;</span> <span class="attr">action</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;haystack_search&#x27; %&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;search&quot;</span> <span class="attr">name</span>=<span class="string">&quot;q&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;搜索&quot;</span> <span class="attr">required</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;ion-ios-search-strong&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>主要是把表单的 action 属性改为 <code>&#123;% url 'haystack_search' %&#125;</code></p>
<h2 id="创建搜索结果页面"><a href="#创建搜索结果页面" class="headerlink" title="创建搜索结果页面"></a>创建搜索结果页面</h2><p><code>haystack_search</code> 视图函数会将搜索结果传递给模板 search/search.html，因此创建这个模板文件，对搜索结果进行渲染：</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;# templates/search/search.html #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">extends</span></span> &#x27;base.html&#x27; %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">load</span></span> highlight %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> main %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> query %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">        </span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> result <span class="keyword">in</span> page.object_list %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">article</span> <span class="attr">class</span>=<span class="string">&quot;post post-</span></span></span><span class="template-variable">&#123;&#123; result.object.pk &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">header</span> <span class="attr">class</span>=<span class="string">&quot;entry-header&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">&quot;entry-title&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; result.object.get_absolute_url &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span></span><span class="template-tag">&#123;% <span class="name">highlight</span> result.object.title with query %&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;entry-meta&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;post-category&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;blog:category&#x27; result.object.category.pk %&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                            </span><span class="template-variable">&#123;&#123; result.object.category.name &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;post-date&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                            <span class="tag">&lt;<span class="name">time</span> <span class="attr">class</span>=<span class="string">&quot;entry-date&quot;</span> <span class="attr">datetime</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; result.object.created_time &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                                </span><span class="template-variable">&#123;&#123; result.object.created_time &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">time</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;post-author&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span></span><span class="template-variable">&#123;&#123; result.object.author &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;comments-link&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; result.object.get_absolute_url &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">#comment-area&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                            </span><span class="template-variable">&#123;&#123; result.object.comment_set.count &#125;&#125;</span><span class="xml"> 评论<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;views-count&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">a</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                                <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; result.object.get_absolute_url &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span></span><span class="template-variable">&#123;&#123; result.object.views &#125;&#125;</span><span class="xml"> 阅读<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;entry-content clearfix&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><span class="template-tag">&#123;% <span class="name">highlight</span> result.object.body with query %&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;read-more cl-effect-14&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; result.object.get_absolute_url &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span> <span class="attr">class</span>=<span class="string">&quot;more-link&quot;</span>&gt;</span>继续阅读 <span class="tag">&lt;<span class="name">span</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                                <span class="attr">class</span>=<span class="string">&quot;meta-nav&quot;</span>&gt;</span>→<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">article</span>&gt;</span></span></span><br><span class="line"><span class="xml">        </span><span class="template-tag">&#123;% <span class="name"><span class="name">empty</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;no-post&quot;</span>&gt;</span>没有搜索到你想要的结果！<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">        </span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">        </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> page.has_previous or page.has_next %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">                </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> page.has_previous %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;?q=</span></span></span><span class="template-variable">&#123;&#123; query &#125;&#125;</span><span class="xml"><span class="tag"><span class="string"><span class="symbol">&amp;amp;</span>page=</span></span></span><span class="template-variable">&#123;&#123; page.previous_page_number &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span></span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"><span class="symbol">&amp;laquo;</span> Previous</span></span><br><span class="line"><span class="xml">                </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> page.has_previous %&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">                |</span></span><br><span class="line"><span class="xml">                </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> page.has_next %&#125;</span><span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;?q=</span></span></span><span class="template-variable">&#123;&#123; query &#125;&#125;</span><span class="xml"><span class="tag"><span class="string"><span class="symbol">&amp;amp;</span>page=</span></span></span><span class="template-variable">&#123;&#123; page.next_page_number &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span></span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml">Next</span></span><br><span class="line"><span class="xml">                <span class="symbol">&amp;raquo;</span></span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> page.has_next %&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">        </span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">else</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">        请输入搜索关键词，例如 django</span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> main %&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="高亮关键词"><a href="#高亮关键词" class="headerlink" title="高亮关键词"></a>高亮关键词</h2><p>只需要使用<code>&#123;% highlight %&#125;</code> 模板标签即可，其用法如下：</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"># 使用默认值  </span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">highlight</span> result.summary with query %&#125;</span><span class="xml">  </span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"># 这里我们为 </span><span class="template-variable">&#123;&#123; result.summary &#125;&#125;</span><span class="xml"> 里所有的 </span><span class="template-variable">&#123;&#123; query &#125;&#125;</span><span class="xml"> 指定了一个<span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span>标签，并且将class设置为highlight_me_please，这样就可以自己通过CSS为</span><span class="template-variable">&#123;&#123; query &#125;&#125;</span><span class="xml">添加高亮效果了</span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">highlight</span> result.summary with query html_tag &quot;div&quot; css_class &quot;highlight_me_please&quot; %&#125;</span><span class="xml">  </span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"># 可以 max_length 限制最终</span><span class="template-variable">&#123;&#123; result.summary &#125;&#125;</span><span class="xml"> 被高亮处理后的长度</span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">highlight</span> result.summary with query max_length 40 %&#125;</span><span class="xml">  </span></span><br></pre></td></tr></table></figure>

<p>在博客文章搜索页中我们对 title 和 body 做了高亮处理：<code>&#123;% highlight result.object.title with query %&#125;</code>，<code>&#123;% highlight result.object.body with query %&#125;</code>。<strong>高亮处理的原理其实就是给文本中的关键字包上一个 span 标签并且为其添加 highlighted 样式</strong>（当然你也可以修改这个默认行为，具体参见上边给出的用法）。因此我们还要给 highlighted 类指定样式，在 base.html 中添加即可：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">base.html</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Black <span class="symbol">&amp;amp;</span> White<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"></span></span><br><span class="line"><span class="css">        <span class="selector-tag">span</span><span class="selector-class">.highlighted</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="attribute">color</span>: red;</span></span><br><span class="line"><span class="css">        &#125;</span></span><br><span class="line"><span class="css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="修改搜索引擎为中文分词"><a href="#修改搜索引擎为中文分词" class="headerlink" title="修改搜索引擎为中文分词"></a>修改搜索引擎为中文分词</h2><p>我们使用 Whoosh 作为搜索引擎，但在 django haystack 中为 Whoosh 指定的分词器是英文分词器，可能会使得搜索结果不理想，我们把这个分词器替换成 jieba 中文分词器。从你安装的 haystack 中把 haystack/backends/whoosh_backends.py 文件拷贝到 blog/ 下，重命名为 whoosh_cn_backends.py（之前我们在 settings.py 中 的 <code>HAYSTACK_CONNECTIONS</code> 指定的就是这个文件），然后找到如下一行代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schema_fields[field_class.index_fieldname] = TEXT(stored=<span class="literal">True</span>, analyzer=StemmingAnalyzer(), field_boost=field_class.boost, sortable=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>将其中的 analyzer 改为 ChineseAnalyzer，当然为了使用它，你需要在文件顶部引入：from jieba.analyse import ChineseAnalyzer。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jieba.analyse <span class="keyword">import</span> ChineseAnalyzer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#注意先找到这个再修改，而不是直接添加  </span></span><br><span class="line">schema_fields[field_class.index_fieldname] = TEXT(stored=<span class="literal">True</span>, analyzer=ChineseAnalyzer(),field_boost=field_class.boost, sortable=<span class="literal">True</span>) </span><br></pre></td></tr></table></figure>

<h2 id="建立索引文件"><a href="#建立索引文件" class="headerlink" title="建立索引文件"></a>建立索引文件</h2><p>最后一步就是建立索引文件了，运行命令 <code>python manage.py rebuild_index</code> 就可以建立索引文件了。</p>
</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>