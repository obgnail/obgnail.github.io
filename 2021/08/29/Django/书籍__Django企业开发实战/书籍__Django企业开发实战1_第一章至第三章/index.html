<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;Web-Server&quot;&gt;&lt;a href=&quot;#Web-Server&quot; class=&quot;headerlink&quot; title=&quot;Web Server&quot;&gt;&lt;/a&gt;Web Server&lt;/h3&gt;&lt;p&gt;简单的Web Server"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>Django企业开发实战1_第一章至第三章 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-none-link" href="/tags/Django/" rel="tag">Django</a></div><div class="post-time">2021-08-29</div></div></div><div class="container post-header"><h1>Django企业开发实战1_第一章至第三章</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Web-Server"><span class="toc-number">1.</span> <span class="toc-text">Web Server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E5%8D%95Forms%E7%B1%BB"><span class="toc-number">2.</span> <span class="toc-text">表单Forms类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E5%8D%95%E7%9A%84%E9%AA%8C%E8%AF%81"><span class="toc-number">3.</span> <span class="toc-text">表单的验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CBV"><span class="toc-number">4.</span> <span class="toc-text">CBV</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="toc-number">5.</span> <span class="toc-text">单元测试</span></a></li></ol></details></div><div class="container post-content"><h3 id="Web-Server"><a href="#Web-Server" class="headerlink" title="Web Server"></a>Web Server</h3><p>简单的Web Server</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">EOL1 = <span class="string">&#x27;\n\n&#x27;</span></span><br><span class="line">EOL2 = <span class="string">&#x27;\n\r\n&#x27;</span></span><br><span class="line">body = <span class="string">&#x27;&#x27;&#x27;Hello, world! &lt;h1&gt; from the5fire 《Django企业开发实战》&lt;/h1&gt;&#x27;&#x27;&#x27;</span></span><br><span class="line">response_params = [</span><br><span class="line">	<span class="string">&#x27;HTTP/1.0 200 OK&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;Date: Sat, 10 jun 2017 01:01:01 GMT&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;Content-Type: text/plain; charset=utf-8&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;Content-Length: &#123;&#125;\r\n&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(body)),</span><br><span class="line">	body,</span><br><span class="line">]</span><br><span class="line">response = <span class="string">b&#x27;\r\n&#x27;</span>.join(response_params)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_connection</span>(<span class="params">conn, addr</span>):</span></span><br><span class="line">	request = <span class="string">&quot;&quot;</span></span><br><span class="line">	<span class="keyword">while</span> EOL1 <span class="keyword">not</span> <span class="keyword">in</span> request <span class="keyword">and</span> EOL2 <span class="keyword">not</span> <span class="keyword">in</span> request:</span><br><span class="line">		request += conn.recv(<span class="number">1024</span>)</span><br><span class="line">	<span class="built_in">print</span>(request)</span><br><span class="line">	conn.send(response)</span><br><span class="line">	conn.close()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="comment"># socket.AF_INET    用于服务器与服务器之间的网络通信</span></span><br><span class="line">    <span class="comment"># socket.SOCK_STREAM    基于TCP的流式socket通信</span></span><br><span class="line">	serversocket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    <span class="comment"># 设置端口可复用，保证我们每次Ctrl C之后，快速再次重启</span></span><br><span class="line">	serversocket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">	serversocket.bind((<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">8080</span>))</span><br><span class="line">    <span class="comment"># 可参考：https://stackoverflow.com/questions/2444459/python-sock-listen</span></span><br><span class="line">	serversocket.listen(<span class="number">1</span>)</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&#x27;http://127.0.0.1:8080&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">			conn, address = serversocket.accept()</span><br><span class="line">			handle_connection(conn, address)</span><br><span class="line">	<span class="keyword">finally</span>:</span><br><span class="line">		serversocket.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	main()</span><br></pre></td></tr></table></figure>

<p>WSGI，全称是Web Server Gateway Interface（Web服务网关接口）。规定了Web Server如何跟应用程序进行交互。</p>
<p><img src="/images/1556286413602.png" alt="1556286413602"></p>
<h3 id="表单Forms类"><a href="#表单Forms类" class="headerlink" title="表单Forms类"></a>表单Forms类</h3><p>什么是表单？何时使用表单？<br>在web开发里表单的使用必不可少。表单用于让用户提交数据或上传文件，表单也用于让用户编辑已有数据。<strong>Django的表单Forms类的作用是把用户输入的数据转化成Python对象格式，便于后续操作（比如存储，修改）</strong>。</p>
<p>自定义表单:<br>类似模型，Django表单也由各种字段组成。表单可以自定义，也可以由模型Models创建。值得注意的是<strong>模型里用的是verbose_name来描述一个字段, 而表单用的是label</strong>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Contact</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContactForm1</span>(<span class="params">forms.Form</span>):</span></span><br><span class="line">    <span class="comment"># 使用label</span></span><br><span class="line">    name = forms.CharField(label=<span class="string">&quot;Your Name&quot;</span>, max_length=<span class="number">255</span>)</span><br><span class="line">    email = forms.EmailField(label=<span class="string">&quot;Email address&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContactForm2</span>(<span class="params">forms.ModelForm</span>):</span></span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Contact</span><br><span class="line">        fields = (<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;email&#x27;</span>,)</span><br></pre></td></tr></table></figure>

<p>用户提交的数据可以通过以下方法与表单结合，生成与数据结合过的表单(Bound forms)。Django只能对Bound forms进行验证。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">form = ContactForm(data=request.POST, files=request.FILES)</span><br></pre></td></tr></table></figure>

<hr>
<p>表单比较完整的运用:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># forms.py</span></span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegistrationForm</span>(<span class="params">forms.Form</span>):</span></span><br><span class="line">    username = forms.CharField(label=<span class="string">&#x27;Username&#x27;</span>, max_length=<span class="number">50</span>)</span><br><span class="line">    email = forms.EmailField(label=<span class="string">&#x27;Email&#x27;</span>,)</span><br><span class="line">    password1 = forms.CharField(label=<span class="string">&#x27;Password&#x27;</span>, widget=forms.PasswordInput)</span><br><span class="line">    password2 = forms.CharField(label=<span class="string">&#x27;Password Confirmation&#x27;</span>, widget=forms.PasswordInput)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># view.py</span></span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render, get_object_or_404</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> .forms <span class="keyword">import</span> RegistrationForm</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponseRedirect</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        form = RegistrationForm(request.POST)</span><br><span class="line">        <span class="keyword">if</span> form.is_valid():</span><br><span class="line">            username = form.cleaned_data[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">            email = form.cleaned_data[<span class="string">&#x27;email&#x27;</span>]</span><br><span class="line">            password = form.cleaned_data[<span class="string">&#x27;password2&#x27;</span>]</span><br><span class="line">            <span class="comment"># 使用内置User自带create_user方法创建用户，不需要使用save()</span></span><br><span class="line">            user = User.objects.create_user(username=username, password=password, email=email)</span><br><span class="line">            <span class="comment"># 如果直接使用objects.create()方法后不需要使用save()</span></span><br><span class="line">            <span class="keyword">return</span> HttpResponseRedirect(<span class="string">&quot;/accounts/login/&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        form = RegistrationForm()</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">&#x27;users/registration.html&#x27;</span>, &#123;<span class="string">&#x27;form&#x27;</span>: form&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;# 模板:registration.html #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">”.”</span> <span class="attr">method</span>=<span class="string">”POST”</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123; form.as_p &#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>工作:</p>
<ol>
<li>当用户通过POST方法提交表单，我们将提交的数据与RegistrationForm结合，然后验证表单RegistrationForm的数据是否有效。</li>
<li>如果表单数据有效，我们先用Django User模型自带的create_user方法创建user对象，再创建user_profile。用户通过一张表单提交数据，我们实际上分别存储在两张表里。</li>
<li>如果用户注册成功，我们通过HttpResponseRedirect方法转到登陆页面。</li>
<li>如果用户没有提交表单或不是通过POST方法提交表单，我们转到注册页面，生成一张空的RegistrationForm。</li>
</ol>
<h3 id="表单的验证"><a href="#表单的验证" class="headerlink" title="表单的验证"></a>表单的验证</h3><p>每个forms类可以通过clean方法自定义表单验证。如果你只想对某些字段进行验证，你可以通过<strong>clean_字段名</strong>方式自定义表单验证。如果用户提交的数据未通过验证，会返回ValidationError，并呈现给用户。如果用户提交的数据有效form.is_valid()，则会将数据存储在cleaned_data里。</p>
<p>通用视图里使用表单:<br>在Django基于类的视图(Class Based View)里使用表单也非常容易，只需定义<code>form_class</code>就好了。下面是一个使用<code>CreateView</code>创建一篇新文章的例子。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.generic.edit <span class="keyword">import</span> CreateView</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Article</span><br><span class="line"><span class="keyword">from</span> .forms <span class="keyword">import</span> ArticleForm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleCreateView</span>(<span class="params">CreateView</span>):</span></span><br><span class="line">    model = Article</span><br><span class="line">    form_class = ArticleForm</span><br><span class="line">    template_name = <span class="string">&#x27;blog/article_create_form.html&#x27;</span></span><br></pre></td></tr></table></figure>

<p>完整示例:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># urls.py</span></span><br><span class="line">url(<span class="string">r&#x27;^addtest$&#x27;</span>,views.addtest,name=<span class="string">&quot;addtest&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># forms.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddForm</span>(<span class="params">forms.Form</span>):</span></span><br><span class="line">    a = forms.IntegerField()</span><br><span class="line">    b = forms.IntegerField()</span><br><span class="line"></span><br><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="keyword">from</span> .forms <span class="keyword">import</span> AddForm</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">addtest</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        form = AddForm(request.POST) </span><br><span class="line">        <span class="keyword">if</span> form.is_valid():</span><br><span class="line">            a = form.cleaned_data[<span class="string">&#x27;a&#x27;</span>]</span><br><span class="line">            b = form.cleaned_data[<span class="string">&#x27;b&#x27;</span>]</span><br><span class="line">            <span class="keyword">return</span> HttpResponse(<span class="built_in">str</span>(<span class="built_in">int</span>(a) + <span class="built_in">int</span>(b)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        form = AddForm()</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">&#x27;addtest.html&#x27;</span>, &#123;<span class="string">&#x27;form&#x27;</span>: form&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;# addtest.html #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&#x27;post&#x27;</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">csrf_token</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123; form &#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p><img src="/images/1556670927798.png" alt="1556670927798"><br><img src="/images/1556670944607.png" alt="1556670944607"></p>
<p>如果打印一下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">addtest</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        form = AddForm(request.POST)</span><br><span class="line">        <span class="keyword">if</span> form.is_valid():</span><br><span class="line">            a = form.cleaned_data[<span class="string">&#x27;a&#x27;</span>]</span><br><span class="line">            b = form.cleaned_data[<span class="string">&#x27;b&#x27;</span>]</span><br><span class="line">            <span class="comment"># 加一句print</span></span><br><span class="line">    	    <span class="built_in">print</span>(form)</span><br><span class="line">            <span class="keyword">return</span> HttpResponse(<span class="built_in">str</span>(<span class="built_in">int</span>(a) + <span class="built_in">int</span>(b)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        form = AddForm()</span><br><span class="line">    <span class="comment"># 加一句print</span></span><br><span class="line">    <span class="built_in">print</span>(form)</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">&#x27;addtest.html&#x27;</span>, &#123;<span class="string">&#x27;form&#x27;</span>: form&#125;)</span><br></pre></td></tr></table></figure>

<p>在第一次访问的时候得到:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;id_a&quot;</span>&gt;</span>A:<span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;id_a&quot;</span> <span class="attr">name</span>=<span class="string">&quot;a&quot;</span> <span class="attr">type</span>=<span class="string">&quot;number&quot;</span> <span class="attr">required</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;id_b&quot;</span>&gt;</span>B:<span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;id_b&quot;</span> <span class="attr">name</span>=<span class="string">&quot;b&quot;</span> <span class="attr">type</span>=<span class="string">&quot;number&quot;</span> <span class="attr">required</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在输入a=1.b=2提交得到:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;id_a&quot;</span>&gt;</span>A:<span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;id_a&quot;</span> <span class="attr">name</span>=<span class="string">&quot;a&quot;</span> <span class="attr">type</span>=<span class="string">&quot;number&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> <span class="attr">required</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;id_b&quot;</span>&gt;</span>B:<span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;id_b&quot;</span> <span class="attr">name</span>=<span class="string">&quot;b&quot;</span> <span class="attr">type</span>=<span class="string">&quot;number&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span> <span class="attr">required</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>所以总结一下,Django 的 forms 提供了：</p>
<ul>
<li><strong>模板中表单的渲染</strong>(自动生成HTML表单元素)</li>
<li>数据的验证工作，某一些输入不合法也不会丢失已经输入的数据。</li>
<li>还可以定制更复杂的验证工作，如果提供了10个输入框，必须必须要输入其中两个以上，在 forms.py 中都很容易实现.</li>
</ul>
<p>Form相关的对象包括:</p>
<ul>
<li>Widget：用来渲染成HTML元素的工具，如：forms.Textarea对应HTML中的标签</li>
<li>Field：Form对象中的一个字段，如：EmailField表示email字段，如果这个字段不是有效的email格式，就会产生错误。</li>
<li>Form：一系列Field对象的集合，负责验证和显示HTML元素</li>
<li>Form Media：用来渲染表单的CSS和JavaScript资源。</li>
</ul>
<p>如果我们要设置admin的字段名称,我们可以直接使用verbose_name:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name = models.CharField(max_length=<span class="number">128</span>,verbose_name=<span class="string">&#x27;姓名&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/1556325130858.png" alt="1556325130858"></p>
<p>在Meta里也可以使用verbose_name:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">    verbose_name = verbose_name_plural = <span class="string">&#x27;学员信息&#x27;</span></span><br></pre></td></tr></table></figure>

<p>以前我们要修改字段名的话,需要设置一个函数,现在我们只需要使用chioce参数:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># model.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    SEX_TIMES = [</span><br><span class="line">        (<span class="number">0</span>,<span class="string">&#x27;未知&#x27;</span>),</span><br><span class="line">        (<span class="number">1</span>,<span class="string">&#x27;男&#x27;</span>),</span><br><span class="line">        (<span class="number">2</span>,<span class="string">&#x27;女&#x27;</span>),</span><br><span class="line">    ]</span><br><span class="line">    STATUS_TIMES = [</span><br><span class="line">        (<span class="number">0</span>,<span class="string">&#x27;申请&#x27;</span>),</span><br><span class="line">        (<span class="number">1</span>,<span class="string">&#x27;通过&#x27;</span>),</span><br><span class="line">        (<span class="number">2</span>,<span class="string">&#x27;拒绝&#x27;</span>),</span><br><span class="line">    ]</span><br><span class="line">    status = models.IntegerField(choices=STATUS_TIMES,verbose_name=<span class="string">&#x27;审核状态&#x27;</span>)</span><br><span class="line">    sex = models.IntegerField(choices=SEX_TIMES,verbose_name=<span class="string">&#x27;性别&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;# templates/index.html#&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">table</span> <span class="attr">border</span>=<span class="string">&quot;1&quot;</span> <span class="attr">cellspacing</span>=<span class="string">&quot;0&quot;</span> <span class="attr">cellpadding</span>=<span class="string">&quot;2&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> student <span class="keyword">in</span> students_list %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span></span><br><span class="line"><span class="xml">        </span><span class="comment">&#123;# 提供了get_XXX_display方法 #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><span class="template-variable">&#123;&#123; student.get_sex_display &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><span class="template-variable">&#123;&#123; student.get_status_display &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>现在字段名显示的就不是0,1,2,而是男,女,未知,申请,通过,拒绝</p>
<p>网页的值传到服务器是通过<code>&lt;input&gt;</code>或 <code>&lt;textarea&gt;</code>标签中的 <strong>name</strong> 属性来传递的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># urls.py</span></span><br><span class="line">url(<span class="string">r&#x27;^$&#x27;</span>,views.index,name=<span class="string">&#x27;index&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">reqeust</span>):</span></span><br><span class="line">    students = Student.objects.<span class="built_in">all</span>()</span><br><span class="line">    <span class="keyword">if</span> reqeust.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        form = StudentForm(reqeust.POST)</span><br><span class="line">        <span class="keyword">if</span> form.is_valid():</span><br><span class="line">            <span class="comment"># 使用form.save代替下面的手动创建Student对象</span></span><br><span class="line">            form.save()</span><br><span class="line">            <span class="comment"># cleaned_data = form.cleaned_data</span></span><br><span class="line">            <span class="comment"># student = Student()</span></span><br><span class="line">            <span class="comment"># student.name = cleaned_data[&#x27;name&#x27;]</span></span><br><span class="line">            <span class="comment"># student.sex = cleaned_data[&#x27;sex&#x27;]</span></span><br><span class="line">            <span class="comment"># student.email = cleaned_data[&#x27;email&#x27;]</span></span><br><span class="line">            <span class="comment"># student.profession = cleaned_data[&#x27;profession&#x27;]</span></span><br><span class="line">            <span class="comment"># student.qq = cleaned_data[&#x27;qq&#x27;]</span></span><br><span class="line">            <span class="comment"># student.status = cleaned_data[&#x27;status&#x27;]</span></span><br><span class="line">            <span class="comment"># student.save()</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 在urls.py定义index的时候声明了name=&#x27;index&#x27;</span></span><br><span class="line">            <span class="comment"># 所以可以通过reverse来拿到name对应的url</span></span><br><span class="line">            <span class="keyword">return</span> HttpResponseRedirect(reverse(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        form = StudentForm()</span><br><span class="line">        context = &#123;<span class="string">&#x27;students&#x27;</span>: students, <span class="string">&#x27;form&#x27;</span>: form&#125;</span><br><span class="line">        <span class="keyword">return</span> render(reqeust, <span class="string">&#x27;student/index.html&#x27;</span>, context=context)</span><br><span class="line"></span><br><span class="line"><span class="comment"># forms.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StudentForm</span>(<span class="params">forms.ModelForm</span>):</span></span><br><span class="line">    <span class="comment"># 该方法会被form自动调用</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_qq</span>(<span class="params">self</span>):</span></span><br><span class="line">        qq = self.cleaned_data[<span class="string">&#x27;qq&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> qq.isdigit():</span><br><span class="line">            <span class="keyword">raise</span> forms.ValidationError(<span class="string">&#x27;必须是数字！&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">int</span>(qq)</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Student</span><br><span class="line">        fields = (<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;sex&#x27;</span>,<span class="string">&#x27;profession&#x27;</span>,<span class="string">&#x27;email&#x27;</span>,<span class="string">&#x27;qq&#x27;</span>,<span class="string">&#x27;phone&#x27;</span>,<span class="string">&#x27;status&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;# index.html #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">title</span>&gt;</span>学员管理系统<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">h3</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/admin/&quot;</span>&gt;</span>Admin<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="xml">			</span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> student <span class="keyword">in</span> students %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">			<span class="tag">&lt;<span class="name">li</span>&gt;</span></span><span class="template-variable">&#123;&#123; student.name &#125;&#125;</span><span class="xml"> - </span><span class="template-variable">&#123;&#123; student.get_status_display &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">			</span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">hr</span>/&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">			</span><span class="template-tag">&#123;% <span class="name"><span class="name">csrf_token</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">			</span><span class="template-variable">&#123;&#123; form &#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">			<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Submit&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>cleaned_data对象是Django的form对用户提交的数据根据字段类型做完转换之后的结果。</p>
<h3 id="CBV"><a href="#CBV" class="headerlink" title="CBV"></a>CBV</h3><p>前面的views.py有一个对于request.method的判断,我们可以使用一个类来封装:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">reqeust</span>):</span></span><br><span class="line">    students = Student.objects.<span class="built_in">all</span>()</span><br><span class="line">    <span class="keyword">if</span> reqeust.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        form = StudentForm(reqeust.POST)</span><br><span class="line">        <span class="keyword">if</span> form.is_valid():</span><br><span class="line">            form.save()</span><br><span class="line">            <span class="keyword">return</span> HttpResponseRedirect(reverse(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        form = StudentForm()</span><br><span class="line">        context = &#123;<span class="string">&#x27;students&#x27;</span>: students, <span class="string">&#x27;form&#x27;</span>: form&#125;</span><br><span class="line">        <span class="keyword">return</span> render(reqeust, <span class="string">&#x27;student/index.html&#x27;</span>, context=context)</span><br></pre></td></tr></table></figure>

<p>改为:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render, HttpResponse, HttpResponseRedirect</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> reverse</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Student</span><br><span class="line"><span class="keyword">from</span> .forms <span class="keyword">import</span> StudentForm,AddForm</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> View</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexView</span>(<span class="params">View</span>):</span></span><br><span class="line">    template_name = <span class="string">&#x27;index.html&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_context</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&#x27;students&#x27;</span>:Student.get_all()&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,reqeust</span>):</span></span><br><span class="line">        context = self.get_context()</span><br><span class="line">        form = StudentForm()</span><br><span class="line">        context.update(&#123;<span class="string">&#x27;form&#x27;</span>:form&#125;)</span><br><span class="line">        <span class="keyword">return</span> render(reqeust,self.template_name,context=context)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self,reqeust</span>):</span></span><br><span class="line">        form = StudentForm(reqeust.POST)</span><br><span class="line">        <span class="keyword">if</span> form.is_valid():</span><br><span class="line">            form.save()</span><br><span class="line">            <span class="keyword">return</span> HttpResponseRedirect(reverse(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">        context = self.get_context()</span><br><span class="line">        context.update(&#123;<span class="string">&#x27;form&#x27;</span>:form&#125;)</span><br><span class="line">        <span class="keyword">return</span> render(reqeust.self.template_name,context=context)</span><br></pre></td></tr></table></figure>

<p>因为这是一个类,不再是一个方法.这时urls.py就需要改为:<br>这个 as_view 其实是对 get 和post 方法的包装。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># urls.py</span></span><br><span class="line"><span class="keyword">from</span> .views <span class="keyword">import</span> IndexView</span><br><span class="line"></span><br><span class="line">url(<span class="string">r&#x27;^$&#x27;</span>,IndexView.as_view(),name=<span class="string">&#x27;index&#x27;</span>),</span><br></pre></td></tr></table></figure>



<p>简单来说:<br>一般请求的判断方法:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">view</span>(<span class="params">request, *args, **kwargs</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method.lower() == <span class="string">&#x27;get&#x27;</span>:</span><br><span class="line">        do_something()</span><br><span class="line">    <span class="keyword">if</span> request.method.lower() == <span class="string">&#x27;post&#x27;</span>:</span><br><span class="line">        do_something()</span><br></pre></td></tr></table></figure>

<p>现在使用使用View.as_view()代替判断：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassName</span>(<span class="params">View</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    继承View自动判断请求方法</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>():</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>():</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">other</span>():</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#调用方法</span></span><br><span class="line">url(url, ClassName.as_view(), name)</span><br></pre></td></tr></table></figure>

<p>设计思想：<br>把视图函数的逻辑定义到类的方法里面去，然后在函数中实例化这个类，通过调用类的方法实现函数逻辑，而把逻辑定义在类中的一个好处就是可以通过继承复用这些方法。</p>
<p><img src="/images/1556693679889.png" alt="1556693679889"></p>
<p>使用分页功能:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># models.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    ...</span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_all</span>(<span class="params">cls</span>):</span></span><br><span class="line">        <span class="keyword">return</span> cls.objects.<span class="built_in">all</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># urls.py</span></span><br><span class="line">url(<span class="string">r&#x27;^students/(\d+)/$&#x27;</span>,views.students,name=<span class="string">&#x27;student_page&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># view.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">students</span>(<span class="params">reqeust, student_page</span>):</span></span><br><span class="line">    paginator = Paginator(Student.get_all(),<span class="number">5</span>)</span><br><span class="line">    students_list = paginator.page(student_page)</span><br><span class="line">    content = &#123;<span class="string">&#x27;students_list&#x27;</span>: students_list&#125;</span><br><span class="line">    <span class="keyword">return</span> render(reqeust, <span class="string">&#x27;student/students.html&#x27;</span>,context=content)</span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;# students.html #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">title</span>&gt;</span>students<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="css"></span></span></span><br><span class="line"><span class="css"><span class="xml">			<span class="selector-tag">li</span>&#123;</span></span></span><br><span class="line"><span class="css"><span class="xml">				<span class="attribute">display</span>: inline;</span></span></span><br><span class="line"><span class="css"><span class="xml">			&#125;</span></span></span><br><span class="line"><span class="css"><span class="xml">		</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">    </span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>students<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">border</span>=<span class="string">&quot;1&quot;</span> <span class="attr">cellspacing</span>=<span class="string">&quot;0&quot;</span> <span class="attr">cellpadding</span>=<span class="string">&quot;2&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>ID<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>姓名<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>性别<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>职业<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>EMAIL<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>QQ<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>电话<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>审核状态<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>创建时间<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">            </span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> student <span class="keyword">in</span> students_list %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><span class="template-variable">&#123;&#123;student.pk&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><span class="template-variable">&#123;&#123;student.name&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><span class="template-variable">&#123;&#123;student.get_sex_display&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><span class="template-variable">&#123;&#123;student.profession&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><span class="template-variable">&#123;&#123;student.email&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><span class="template-variable">&#123;&#123;student.qq&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><span class="template-variable">&#123;&#123;student.phone&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><span class="template-variable">&#123;&#123;student.get_status_display&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><span class="template-variable">&#123;&#123;student.created_time&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span></span><br><span class="line"><span class="xml">            </span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">            </span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> idx <span class="keyword">in</span> students_list.paginator.page_range %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">                </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> idx == students_list.number %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        </span><span class="template-variable">&#123;&#123;idx&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">                </span><span class="template-tag">&#123;% <span class="name"><span class="name">else</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=</span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;student_sys:student_page&#x27; idx %&#125;</span><span class="xml"><span class="tag">&gt;</span></span><span class="template-variable">&#123;&#123;idx&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">                </span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">            </span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>





<p>导入静态文件:</p>
<ul>
<li>在manage.py目录下创建static目录,该目录下创建css,js,img,json,other等等目录.不同目录存放不同的文件</li>
<li>setting.py文件添加<code>STATICFILES_DIRS = [os.path.join(BASE_DIR,&#39;static&#39;)]</code><br>注意<strong>这里的<code>&#39;static&#39;</code>就是对应文件夹的名称.</strong></li>
<li>在 模板文件导入:<code>&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;/static/student/css/student.css&quot;/&gt;</code></li>
</ul>
<p>静态文件的反向解析:</p>
<ul>
<li><code>&#123;% load static from staticfiles %&#125;</code></li>
<li><code>&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;&#123;% static 'student/css/student.css' %&#125;&quot;/&gt;</code></li>
</ul>
<p>url的反向解析:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># project/urls.py</span></span><br><span class="line"><span class="comment"># 注意namespace是include的参数</span></span><br><span class="line">url(<span class="string">r&#x27;^&#x27;</span>,include(<span class="string">&#x27;student.urls&#x27;</span>,namespace=<span class="string">&#x27;student_sys&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># myapp/urls.py</span></span><br><span class="line">url(<span class="string">r&#x27;^students/(\d+)/$&#x27;</span>,views.students,name=<span class="string">&#x27;student_page&#x27;</span>),</span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;# 导入 #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;student_sys:student_page&#x27; 3 %&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="comment">&#123;# 或者 #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="comment">&#123;# 外面的引号可有可无 #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=</span></span><span class="template-tag">&#123;% <span class="name"><span class="name">url</span></span> &#x27;student_sys:student_page&#x27; 3 %&#125;</span><span class="xml"><span class="tag">&gt;</span>3<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br></pre></td></tr></table></figure>



<p>使用中间件:</p>
<p><img src="/images/%E4%B8%AD%E9%97%B4%E4%BB%B6%E4%BD%8D%E7%BD%AE%E7%A4%BA%E6%84%8F%E5%9B%BE.jpg" alt="中间件位置示意图"></p>
<p>方法:</p>
<ol>
<li><p>__init__.py:<br>不需要传参数,服务器响应第一个请求的时候自动调用.<strong>用于确定是否启用该中间件</strong>.</p>
</li>
<li><p>process_request(self,request):<br>分配url匹配视图之前调用.一般情况下，我们可以在这里做一些校验，比如用户登录或者HTTP中是否有认证头之类的验证。<br><strong>返回None或者HttpResponse对象.</strong></p>
<p>==如果返回 HttpResponse，那么接下来的处理方法只会执行 process_response==，其他方法将不会被执行。这里需要注意的是，如果你的 middleware是 settings配置的 MIDDLEWARE的第一个，那么剩下的middleware也不会被执行；==如果返回None，那么 Django会继续执行其他方法。==</p>
</li>
<li><p>process_view(self,request,view_func,view_args,view_kwargs):<br><strong>调用视图之前执行</strong>,返回None或者HttpResponse对象.</p>
<p>view_func就是我们将要执行的view方法。它的返回值跟 process_request一样，是 Httpresponse或者None，其逻辑也一样。如果返回None，那么 Django会帮你执行view函数，从而得到最终的 response</p>
</li>
<li><p>process_template_response(self,request,response):<br><strong>在视图刚好执行完后调用</strong>,返回None或者HttpResponse对象.在这里可以使用render</p>
<p>执行完上面的方法，并且 Django帮我们执行完view，拿到最终的 response后，如果使用了模板的 response（这是指通过 return render方式返回的 response），就会来到这个方法中。在这个方法中，我们可以对 response做一下操作，比如 Content-Type设置，或者其他 header的修改/增加。</p>
</li>
<li><p>process_response(self,request,response):<br><strong>响应返回浏览器之前调用</strong>,返回HttpResponse对象.</p>
<p>所有流程都处理完毕后，就来到了这个方法。这个方法的逻辑跟 process_template_response是完全一样的，只是后者是针对带有模板的 response的处理。</p>
</li>
<li><p>process_exception(self,request,exception):<br><strong>当视图发生异常时调用</strong>,返回HttpResponse对象.</p>
<p>在发生异常时，才会进入这个方法。哪个阶段发生的异常呢？可以简单理解为在将要调用的ⅵew中出现异常（就是==在 process_view的func函数中==）或者==返回的模板 response在渲染时发生的异常==。但是需要注意的是，<strong>如果你在 process_View中手动调用了func，就不会触发 process_exception了</strong>。这个方法接收到异常之后，可以选择处理异常，然后返回一个含有异常信息的 Httpresponse，或者直接返回None不处理，这种情况下 Django会使用自己的异常模板</p>
</li>
</ol>
<p>多个中间件的调用顺序:</p>
<p><img src="/images/1556702234157.png" alt="1556702234157"></p>
<p><img src="/images/1396321-20180714173132947-504897233.png" alt="img"></p>
<p><img src="/images/%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%A4%84%E7%90%86%E9%A1%BA%E5%BA%8F.jpg" alt="中间件处理顺序"></p>
<p>Django框架的执行过程:(上面黄色箭头就是执行过程)</p>
<ol>
<li>request请求经过WSGI后，先进入中间件，开始先走process_request函数，然后走到由关系映射后，这里注意并没有直接进入视图函数，而是从头开始执行process_view()函数；然后再去执行与urls.py匹配的视图函数；</li>
<li>如果视图函数没有报错，那就直接挨个反过来从最后一个中间件开始，依次将返回的实例对象(也就是我们在视图函数中写的 return HttpResponse()等等)传递给每个中间件的process_response函数；最后再交给客户端浏览器；</li>
</ol>
<p>如果执行视图函数出错，那就反过来从最后一个中间件开始，将错误信息传递给每个中间件的process_exception()函数，走完所有后，然后最终再走procss_response后，最终再交给客户端浏览器注意：视图函数的错误是由process_exception()函数处理的，从最后一个中间件开始，依次逐级提交捕捉到的异常然后最终交给procss_response()函数，将最终的错误信息交给客户端浏览器。</p>
<p>简单来说:</p>
<ul>
<li><p>process_request,process_view,process_response都是返回None则继续运行,返回HttpResponse则开始执行process_response</p>
</li>
<li><p>process_template_response只有在返回值中有render才会被调用,必须返回一个继承有 render 方法的 response 对象</p>
</li>
<li><p>process_exception在视图函数发生错误时调用.process_View中手动调用了func，就不会触发 process_exception了.<br>返回None则是不处理错误,错误将传递到下一个中间件的process_exception.返回HttpResponse则开始执行process_response</p>
</li>
<li><p>多个中间件的执行顺序:<br>处理视图前:正序<br>处理视图后:倒序</p>
<p>也就是说:<br>process_request,process_view为正序执行,<br>process_exception,process_response为倒序执行</p>
</li>
</ul>
<p><img src="/images/django-middleware.png" alt="img"></p>
<p><img src="/images/1101486-20181011230649907-1428852485.png" alt="img"></p>
<p><img src="/images/20190424100737810.png" alt="img"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> reverse</span><br><span class="line"><span class="keyword">from</span> django.utils.deprecation <span class="keyword">import</span> MiddlewareMixin</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimeItMiddleware</span>(<span class="params">MiddlewareMixin</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        self.start_time = time.time()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 统计调用view所消耗的时间</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_view</span>(<span class="params">self,request,func,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="keyword">if</span> request.path != reverse(<span class="string">&#x27;index&#x27;</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        start = time.time()</span><br><span class="line">        response = func(request)</span><br><span class="line">        costed = time.time() - start</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;process view: <span class="subst">&#123;costed:<span class="number">.2</span>f&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span>(<span class="params">self,request,response</span>):</span></span><br><span class="line">        costed = time.time() - self.start_time</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">  </span><br><span class="line"><span class="comment"># setting.py</span></span><br><span class="line">MIDDLEWARE = [</span><br><span class="line">    <span class="string">&#x27;middleware.student.middlewares.TimeItMiddleware&#x27;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>



<h3 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h3><p>单元测试写在app里面的test.py.(与views.py同级)</p>
<p>如果使用MySQL数据库存储,那么Django就会自动生成一个测试用的数据库.<br>当然我们可以修改这个数据库的名称</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;django.db.backends.mysql&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&#x27;djangobook&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;USER&#x27;</span>:<span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;PASSWORD&#x27;</span>:<span class="string">&#x27;5KVp2y7,k96o&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;HOST&#x27;</span>:<span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;POST&#x27;</span>:<span class="string">&#x27;3306&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;TEST&#x27;</span>:&#123;</span><br><span class="line">            <span class="comment"># 修改测试用的数据库名称</span></span><br><span class="line">            <span class="string">&#x27;NAME&#x27;</span>:<span class="string">&#x27;mytestdatabase&#x27;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Django提供了一个名为 Test case的基类，我们可以通过继承这个类来实现自己的测试逻辑。在此之前，我们需要了解 Test case给我们提供了哪些方法。</p>
<ol>
<li>def setUp(self):用来初始化环境,包括创建初始化的数据,或者做一些其他准备工作</li>
<li>def test_xxx(self):方法后面的_xxx可以是任意东西.以test开头的方法认为是需要测试的方法,跑测试时会被执行.<strong>每个需要被测试的方法是相互独立的</strong>. </li>
<li>def tearDown(self):跟 setUp相对,用来清理测试环境和测试数据.</li>
</ol>
<p>Model 层测试:<br>这一层的测试主要保证数据的写入和查询是可用的，同时也需要保证我们在 Model层所提供的方法是符合预期的。</p>
<p>比如，在 Model中增加了 sex_show这样的属性，用来展示sex这个字段的中文显示，而不是数字1或者2.当然，这个功能是 Django已经提供给我们的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    objects = StudentManager()</span><br><span class="line">    SEX_TIMES = [</span><br><span class="line">        (<span class="number">0</span>,<span class="string">&#x27;未知&#x27;</span>),</span><br><span class="line">        (<span class="number">1</span>,<span class="string">&#x27;男&#x27;</span>),</span><br><span class="line">        (<span class="number">2</span>,<span class="string">&#x27;女&#x27;</span>),</span><br><span class="line">    ]</span><br><span class="line">	...</span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sex_show</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">dict</span>(self.SEX_ITEMS)[self.sex]</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># myapp/test.py</span></span><br><span class="line"><span class="keyword">from</span> django.test <span class="keyword">import</span> TestCase</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your tests here.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Student</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StudentTestCase</span>(<span class="params">TestCase</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setUp</span>(<span class="params">self</span>):</span></span><br><span class="line">        Student.objects.create(</span><br><span class="line">            name=<span class="string">&#x27;hyl&#x27;</span>,</span><br><span class="line">            sex=<span class="number">1</span>,</span><br><span class="line">            email=<span class="string">&#x27;xxxx.com&#x27;</span>,</span><br><span class="line">            profession=<span class="string">&#x27;程序员&#x27;</span>,</span><br><span class="line">            qq=<span class="number">333</span></span><br><span class="line">            phone=<span class="string">&#x27;22222&#x27;</span></span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_create_and_sex_show</span>(<span class="params">self</span>):</span></span><br><span class="line">        student = Student.objects.create(</span><br><span class="line">            name=<span class="string">&#x27;YYYY&#x27;</span>,</span><br><span class="line">            sex=<span class="number">1</span>,</span><br><span class="line">            email=<span class="string">&#x27;zzzz.com&#x27;</span>,</span><br><span class="line">            profession=<span class="string">&#x27;程序员&#x27;</span>,</span><br><span class="line">            qq=<span class="number">333</span></span><br><span class="line">            phone=<span class="string">&#x27;22222&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        self.assertEqual(Student.sex_show,<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;性别字段内容跟展示不一致&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_filter</span>(<span class="params">self</span>):</span></span><br><span class="line">        Student.objects.create(</span><br><span class="line">            name=<span class="string">&#x27;hyl&#x27;</span>,</span><br><span class="line">            sex=<span class="number">1</span>,</span><br><span class="line">            email=<span class="string">&#x27;xxxx.com&#x27;</span>,</span><br><span class="line">            profession=<span class="string">&#x27;程序员&#x27;</span>,</span><br><span class="line">            qq=<span class="number">333</span></span><br><span class="line">            phone=<span class="string">&#x27;22222&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        name = <span class="string">&#x27;hyl&#x27;</span></span><br><span class="line">        students = Student.objects.<span class="built_in">filter</span>(name=name)</span><br><span class="line">        self.assertEqual(students.count(),<span class="number">1</span>,<span class="string">f&#x27;应该只存在一个名称为<span class="subst">&#123;name&#125;</span>的记录&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>View 层测试<br>这一层更多的是功能上的测试，也是我们重点关注的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.test <span class="keyword">import</span> TestCase,Client</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Student</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StudentTestCase</span>(<span class="params">TestCase</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setUp</span>(<span class="params">self</span>):</span></span><br><span class="line">        Student.objects.create(</span><br><span class="line">            name=<span class="string">&#x27;hyl&#x27;</span>,</span><br><span class="line">            sex=<span class="number">1</span>,</span><br><span class="line">            email=<span class="string">&#x27;xxxx.com&#x27;</span>,</span><br><span class="line">            profession=<span class="string">&#x27;程序员&#x27;</span>,</span><br><span class="line">            qq=<span class="number">333</span></span><br><span class="line">            phone=<span class="string">&#x27;22222&#x27;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_get_index</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 测试首页的可用性</span></span><br><span class="line">        client = Client()</span><br><span class="line">        response = client.get(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">        self.assertEqual(response.status_code,<span class="number">200</span>,<span class="string">&#x27;status code must be 200!&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_post_student</span>(<span class="params">self</span>):</span></span><br><span class="line">        client = Client()</span><br><span class="line">        data = <span class="built_in">dict</span>(</span><br><span class="line">            name = <span class="string">&#x27;test_for_post&#x27;</span>,</span><br><span class="line">            sex = <span class="number">1</span>,</span><br><span class="line">            email = <span class="string">&#x27;333@d.com&#x27;</span>,</span><br><span class="line">            profession = <span class="string">&#x27;程序员&#x27;</span>,</span><br><span class="line">            qq = <span class="string">&#x27;333&#x27;</span>,</span><br><span class="line">            phone = <span class="string">&#x27;3333&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        response = client.post(<span class="string">&#x27;/&#x27;</span>,data)</span><br><span class="line">        self.assertEqual(response.status_code,<span class="number">302</span>,<span class="string">&#x27;status code must be 302&#x27;</span>)</span><br><span class="line">        response = client.get(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">        self.assertTrue(<span class="string">b&#x27;test_for_post&#x27;</span> <span class="keyword">in</span> response.content,</span><br><span class="line">                        <span class="string">&#x27;response content must contain &quot;test_for_post&quot;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>执行单元测试:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py <span class="built_in">test</span></span><br></pre></td></tr></table></figure>













</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>