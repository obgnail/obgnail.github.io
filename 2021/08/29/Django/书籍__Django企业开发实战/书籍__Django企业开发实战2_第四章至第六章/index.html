<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;第四章&quot;&gt;&lt;a href=&quot;#第四章&quot; class=&quot;headerlink&quot; title=&quot;第四章&quot;&gt;&lt;/a&gt;第四章&lt;/h1&gt;&lt;p&gt;代码规范问题:"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>Django企业开发实战2_第四章至第六章 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-none-link" href="/tags/Django/" rel="tag">Django</a></div><div class="post-time">2021-08-29</div></div></div><div class="container post-header"><h1>Django企业开发实战2_第四章至第六章</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E7%AB%A0"><span class="toc-number">1.</span> <span class="toc-text">第四章</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E7%AB%A0-Model"><span class="toc-number">2.</span> <span class="toc-text">第五章:Model</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%BC%80%E5%8F%91%E7%AE%A1%E7%90%86%E5%90%8E%E5%8F%B0"><span class="toc-number">3.</span> <span class="toc-text">第六章:开发管理后台</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F-%E8%B7%B3%E8%BF%87%E4%BA%86%E7%AC%AC6%E7%AB%A0"><span class="toc-number">3.1.</span> <span class="toc-text">注意 : 跳过了第6章</span></a></li></ol></li></ol></details></div><div class="container post-content"><h1 id="第四章"><a href="#第四章" class="headerlink" title="第四章"></a>第四章</h1><p>代码规范问题:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 错误写法</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">a,b,c,d,</span></span></span><br><span class="line"><span class="params"><span class="function">    e,f,g</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="number">123</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 正确写法:悬挂对齐</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">a,b,c,</span></span></span><br><span class="line"><span class="params"><span class="function">         d,e,f</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="number">13</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二种正确写法:第一参数换行,参数缩进一格</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    a,b,c,</span></span></span><br><span class="line"><span class="params"><span class="function">    d,e,f</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="number">13</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 当导入的内容过多时,使用括号换行</span></span><br><span class="line"><span class="keyword">from</span> xx imprt (a,b,</span><br><span class="line">    c,d,e,f</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 错误写法</span></span><br><span class="line">a = (b + </span><br><span class="line">     c + </span><br><span class="line">     d + </span><br><span class="line">     e)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 正确写法</span></span><br><span class="line">a = (b </span><br><span class="line">     + c </span><br><span class="line">     + d</span><br><span class="line">     + e)</span><br></pre></td></tr></table></figure>

<p>顶级的类或者方法周围（上下）应该各有两个空行.<br>类内部的方法周围（上下）需要各有一个空行。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 错误写法:</span></span><br><span class="line"><span class="keyword">import</span> sys,os</span><br><span class="line"></span><br><span class="line"><span class="comment"># 正确写法</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br></pre></td></tr></table></figure>

<p>import语句需要放到文件的顶部，在模块注释和文档注释之后，且在模块级全局变量和常量定义之前。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">this is the example module</span></span><br><span class="line"><span class="string">this module does stuff</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> barry_as_FLUFL</span><br><span class="line"></span><br><span class="line">__all__ = [<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>]</span><br><span class="line">__version__ = <span class="string">&#x27;0.1&#x27;</span></span><br><span class="line">__author__ = <span class="string">&#x27;hyl&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br></pre></td></tr></table></figure>

<p>import的顺序:</p>
<ol>
<li>future</li>
<li>标准库</li>
<li>第三方库</li>
<li>本项目的其他模块</li>
</ol>
<p>各组引用之间要用空行分隔，每一组引用中按照 <strong>import在from上面</strong>的顺序，并且需要<strong>根据字母排序</strong>。</p>
<p>eg:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> datatime <span class="keyword">import</span> datatime</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> django</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> blog.models <span class="keyword">import</span> Post</span><br></pre></td></tr></table></figure>

<p>对于Django来说:</p>
<ul>
<li>future</li>
<li>标准库</li>
<li>第三方库</li>
<li>Django库</li>
<li>本项目的其他模块</li>
</ul>
<p>模板风格</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;# 错误写法 #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123;foo&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="comment">&#123;# 正确写法 #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123; foo &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>模型风格:<br>使用下划线而不是驼峰.</p>
<p>模型类型顺序:</p>
<ol>
<li>字段定义</li>
<li>自定义managers属性</li>
<li>class Meta定义</li>
<li>def __str__</li>
<li>def save</li>
<li>def get_absolute_url</li>
<li>其他方法</li>
</ol>
<p>choices字段的用法:<br>如果用到了带有 choices参数的字段，choices的定义需要大写</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SEX_TIMES = [</span><br><span class="line">    (<span class="number">0</span>,<span class="string">&#x27;未知&#x27;</span>),</span><br><span class="line">    (<span class="number">1</span>,<span class="string">&#x27;男&#x27;</span>),</span><br><span class="line">    (<span class="number">2</span>,<span class="string">&#x27;女&#x27;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>



<h1 id="第五章-Model"><a href="#第五章-Model" class="headerlink" title="第五章:Model"></a>第五章:Model</h1><p>Django中每个App应该是一个自组织的应用<br>(<strong>所谓自组织,是指应用内部的所有逻辑都是相关联的,可以理解为是紧耦合的</strong>).<br>我们既可以把所有模型放到一个App中,也可以根据 Model的业务性质来分别处理.</p>
<p><img src="/images/1556763835253.png" alt="1556763835253"></p>
<p>我们将这个ER图拆分成三个APP来做:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blogapp.py</span></span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 文章分类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Category</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    STATUS_NORMAL = <span class="number">1</span></span><br><span class="line">    STATUS_DELETE = <span class="number">0</span></span><br><span class="line">    STATUS_ITEMS = (</span><br><span class="line">        (STATUS_NORMAL,<span class="string">&#x27;正常&#x27;</span>),</span><br><span class="line">        (STATUS_DELETE,<span class="string">&#x27;删除&#x27;</span>),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    name         = models.CharField(max_length=<span class="number">50</span>,verbose_name=<span class="string">&#x27;名称&#x27;</span>)</span><br><span class="line">    status       = models.PositiveIntegerField(default=STATUS_NORMAL,</span><br><span class="line">                                                chioces=STATUS_ITEMS,verbose_name=<span class="string">&#x27;状态&#x27;</span>)</span><br><span class="line">    is_nav       = models.BooleanField(default=<span class="literal">False</span>,verbose_name=<span class="string">&#x27;是否为导航&#x27;</span>)</span><br><span class="line">    owner        = models.ForeignKey(User,verbose_name=<span class="string">&#x27;作者&#x27;</span>)</span><br><span class="line">    created_time = models.DateTimeField(auto_now_add=<span class="literal">True</span>,verbose_name=<span class="string">&#x27;创建时间&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = verbose_name_plural = <span class="string">&#x27;分类&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 标签</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tag</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    STATUS_NORMAL = <span class="number">1</span></span><br><span class="line">    STATUS_DELETE = <span class="number">0</span></span><br><span class="line">    STATUS_ITEMS = (</span><br><span class="line">        (STATUS_NORMAL,<span class="string">&#x27;正常&#x27;</span>),</span><br><span class="line">        (STATUS_DELETE,<span class="string">&#x27;删除&#x27;</span>),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    name         = models.CharField(max_length=<span class="number">10</span>,verbose_name=<span class="string">&#x27;名称&#x27;</span>)</span><br><span class="line">    status       = models.PositiveIntegerField(default=STATUS_NORMAL,</span><br><span class="line">                                            chioces=STATUS_ITEMS,verbose_name=<span class="string">&#x27;状态&#x27;</span>)</span><br><span class="line">    owner        = models.ForeignKey(User,verbose_name=<span class="string">&#x27;作者&#x27;</span>)</span><br><span class="line">    created_time = models.DateTimeField(auto_now_add=<span class="literal">True</span>,verbose_name=<span class="string">&#x27;创建时间&#x27;</span>)</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = verbose_name_plural = <span class="string">&#x27;标签&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 文章</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    STATUS_NORMAL = <span class="number">1</span></span><br><span class="line">    STATUS_DELETE = <span class="number">0</span></span><br><span class="line">    STATUS_DRAFT  = <span class="number">2</span> </span><br><span class="line">    STATUS_ITEMS  = (</span><br><span class="line">        (STATUS_NORMAL,<span class="string">&#x27;正常&#x27;</span>),</span><br><span class="line">        (STATUS_DELETE,<span class="string">&#x27;删除&#x27;</span>),</span><br><span class="line">        (STATUS_ITEMS,<span class="string">&#x27;草稿&#x27;</span>),</span><br><span class="line">    )   </span><br><span class="line"></span><br><span class="line">    title        = models.CharField(max_length=<span class="number">255</span>,verbose_name=<span class="string">&#x27;标题&#x27;</span>)</span><br><span class="line">    desc         = models.CharField(max_length=<span class="number">1024</span>,blank=<span class="literal">True</span>,verbose_name=<span class="string">&#x27;摘要&#x27;</span>)</span><br><span class="line">    content      = models.TextField(verbose_name=<span class="string">&#x27;正文&#x27;</span>,help_text=<span class="string">&#x27;正文必须为MarkdDown格式&#x27;</span>)</span><br><span class="line">    status       = models.PositiveIntegerField(default=STATUS_NORMAL,chioces=STATUS_ITEMS,verbose_name=<span class="string">&#x27;状态&#x27;</span>)</span><br><span class="line">    category     = models.ForeignKey(Category,verbose_name=<span class="string">&#x27;分类&#x27;</span>)</span><br><span class="line">    tag          = models.ManyToManyField(Tag,verbose_name=<span class="string">&#x27;标签&#x27;</span>)</span><br><span class="line">    owner        = models.ForeignKey(User,verbose_name=<span class="string">&#x27;作者&#x27;</span>)</span><br><span class="line">    created_time = models.DateTimeField(auto_now_add=<span class="literal">True</span>,verbose_name<span class="string">&#x27;创建时间&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = verbose_name_plural = <span class="string">&#x27;文章&#x27;</span></span><br><span class="line">        ordering = [<span class="string">&#x27;-id&#x27;</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># configapp.py</span></span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 友链</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Link</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    STATUS_NORMAL = <span class="number">1</span></span><br><span class="line">    STATUS_DELETE = <span class="number">0</span></span><br><span class="line">    STATUS_ITEMS = (</span><br><span class="line">        (STATUS_NORMAL,<span class="string">&#x27;正常&#x27;</span>),</span><br><span class="line">        (STATUS_DELETE,<span class="string">&#x27;删除&#x27;</span>),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    title        = models.CharField(max_length=<span class="number">50</span>,verbose_name=<span class="string">&#x27;标题&#x27;</span>)</span><br><span class="line">    <span class="comment"># 默认长度为200</span></span><br><span class="line">    href         = models.URLField(verbose_name=<span class="string">&#x27;链接&#x27;</span>)   </span><br><span class="line">    status       = models.PositiveIntegerField(default=STATUS_NORMAL,</span><br><span class="line">                                                chioces=STATUS_ITEMS,verbose_name=<span class="string">&#x27;状态&#x27;</span>)</span><br><span class="line">    weitht       = models.PositiveIntegerField(default=<span class="number">1</span>,chioces=<span class="built_in">zip</span>(<span class="built_in">range</span>(<span class="number">1</span>,<span class="number">6</span>),<span class="built_in">range</span>(<span class="number">1</span>,<span class="number">6</span>)),</span><br><span class="line">                                                verbose_name=<span class="string">&#x27;权重&#x27;</span>,help_text=<span class="string">&#x27;权重高展示顺序靠前&#x27;</span>)</span><br><span class="line">    owner        = models.ForeignKey(User,verbose_name=<span class="string">&#x27;作者&#x27;</span>)</span><br><span class="line">    created_time = models.DateTimeField(auto_now_add=<span class="literal">True</span>,verbose_name=<span class="string">&#x27;创建时间&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = verbose_name_plural = <span class="string">&#x27;友链&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 侧边栏</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SideBar</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    STATUS_SHOW = <span class="number">1</span></span><br><span class="line">    STATUS_HIDE = <span class="number">0</span></span><br><span class="line">    STATUS_ITEMS = (</span><br><span class="line">        (STATUS_SHOW,<span class="string">&#x27;展示&#x27;</span>),</span><br><span class="line">        (STATUS_HIDE,<span class="string">&#x27;隐藏&#x27;</span>),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    SIDE_TYPE =(</span><br><span class="line">        (<span class="number">1</span>,<span class="string">&#x27;HTML&#x27;</span>),</span><br><span class="line">        (<span class="number">2</span>,<span class="string">&#x27;最新文章&#x27;</span>),</span><br><span class="line">        (<span class="number">3</span>,<span class="string">&#x27;最热文章&#x27;</span>),</span><br><span class="line">        (<span class="number">4</span>,<span class="string">&#x27;最新评论&#x27;</span>),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    title        = models.CharField(max_length=<span class="number">50</span>,verbose_name=<span class="string">&#x27;标题&#x27;</span>)</span><br><span class="line">    display_type = models.PositiveIntegerField(default=<span class="number">1</span>,chioces=SIDE_TYPE,</span><br><span class="line">                                                verbose_name=<span class="string">&#x27;展示类型&#x27;</span>)</span><br><span class="line">    content      = models.CharField(max_length=<span class="number">500</span>,blank=<span class="literal">True</span>,verbose_name=<span class="string">&#x27;内容&#x27;</span>,</span><br><span class="line">                                    help_text=<span class="string">&#x27;如果设置的不是HTML类型,可为空&#x27;</span>)</span><br><span class="line">    stauts       = models.PositiveIntegerField(default=STATUS_SHOW,chioces=STATUS_ITEMS,</span><br><span class="line">                                                verbose_name=<span class="string">&#x27;状态&#x27;</span>)</span><br><span class="line">    owner        = models.ForeignKey(User,verbose_name=<span class="string">&#x27;作者&#x27;</span>)</span><br><span class="line">    created_time = models.DateTimeField(auto_now_add=<span class="literal">True</span>,verbose_name=<span class="string">&#x27;创建时间&#x27;</span>)</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = verbose_name_plural = <span class="string">&#x27;侧边栏&#x27;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># commentapp.py</span></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> blogapp.models <span class="keyword">import</span> Post</span><br><span class="line"><span class="comment"># Create your models here.</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Comment</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    STATUS_NORMAL = <span class="number">1</span></span><br><span class="line">    STATUS_DELETE = <span class="number">0</span></span><br><span class="line">    STATUS_ITEMS  = (</span><br><span class="line">        (STATUS_NORMAL,<span class="string">&#x27;正常&#x27;</span>),</span><br><span class="line">        (STATUS_DELETE,<span class="string">&#x27;删除&#x27;</span>),</span><br><span class="line">    )   </span><br><span class="line"></span><br><span class="line">    target       = models.ForeignKey(Post,verbose_name=<span class="string">&#x27;评论目标&#x27;</span>)</span><br><span class="line">    content      = models.CharField(max_length=<span class="number">2000</span>,verbose_name=<span class="string">&#x27;内容&#x27;</span>)</span><br><span class="line">    nickname     = models.CharField(max_length=<span class="number">50</span>,verbose_name=<span class="string">&#x27;昵称&#x27;</span>)</span><br><span class="line">    website      = models.URLField(verbose_name=<span class="string">&#x27;网站&#x27;</span>)</span><br><span class="line">    email        = models.EmailField(verbose_name=<span class="string">&#x27;邮箱&#x27;</span>)</span><br><span class="line">    status       = models.PositiveIntegerField(default=STATUS_NORMAL,</span><br><span class="line">    											choices=STATUS_ITEMS,verbose_name=<span class="string">&#x27;状态&#x27;</span>)</span><br><span class="line">    created_time = models.DateTimeField(auto_now_add=<span class="literal">True</span>,verbose_name=<span class="string">&#x27;创建时间&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = verbose_name_plural = <span class="string">&#x27;评论&#x27;</span></span><br></pre></td></tr></table></figure>

<p>可以看出:</p>
<ul>
<li>ForeignKey写在<code>多</code>方.</li>
<li>PositiveIntegerField:<br>同 IntergerField,只包含正整数</li>
</ul>
<p>INSTALLED_APPS:<br>Django是根据这些App的顺序来查找对应资源的。比如static和 templates这些模块，Django会<strong>根据顺序挨个去这些App下查找对应资源</strong>，如果资源路径和名称相同的话，前面的会覆盖掉后面的。</p>
<p>这同时也有好处:<br>如果你想覆盖自带的Admin,你就可以自己写一个,然后排在自带你Admin的前面,这样Django就会加载你写的Admin,同时又不用修改自带的Admin</p>
<p>迁移文件（migration）:<br>就是把我们的 Model定义迁移到数据库中来具体操作。</p>
<p>DML:<br>数据库数据操作语言，<br>CRUD:<br>增、查、改、删</p>
<p>model类参数:</p>
<ul>
<li>null:<br>可以同blank对比考虑,其中null用于设定在<strong>数据库层面</strong>是否允许为空. </li>
<li>blank:<br>针对<strong>业务层面</strong>,该值是否允许为空. </li>
<li>choices:<br>配置字段的 choices后,==在 admin页面上就可以看到对应的可选项展示==. </li>
<li>db_column:<br>默认情况下,我们定义的 Field就是对应数据库中的字段名称,通过这个参数可以==指定Model中的某个字段对应数据库中的哪个字段==. </li>
<li>db_index:<br>索引配置.对于业务上需要经常作为查询条件的字段,应该配置此项. </li>
<li>default:<br>默认值配置</li>
<li>editable:<br>是否可编辑,默认是True.==如果不想将这个字段展示到页面上,可以配置为False==</li>
<li>error_messages:<br>用来自定义字段值校验失败时的异常提示,它是字典格式.<br>key的可选项为null、blank、invalid、invalid_choice、unique和  unique_for_ate. </li>
<li>help_text.<br>字段提示语,配置这一项后,在页面对应字段的下方会展示此配置. </li>
<li>primary_key.<br>主键,一个Model只允许设置一个字段为 primary_key</li>
<li>unique.<br>唯一约束,当需要配置唯一值时,设置 unique=True,设置此项后,不需要设置 db_index. </li>
<li>unique_for_date.<br>针对date(日期)的联合约束,比如我们需要一天只能有一篇名为《学习Django实战》的文章,那么可以在定义tittle字段时配置参数:uniquefordate=”created_time”</li>
<li>unique_for month.<br>针对月份的联合约束. </li>
<li>unique_for year.<br>针对年份的联合约束</li>
<li>verbose name.<br>==字段对应的展示文案.==</li>
<li>validators.<br>自定义校验逻辑,同form类似</li>
</ul>
<p>在 Model层中，Django通过给 Model增加一个<strong>objects属性来提供数据操作的接口</strong>.</p>
<p>懒加载:代码执行后，都不会产生数据库查询操作，只是会返回一个QuerySet对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 返回一个QuerySet对象并赋位给 posts</span></span><br><span class="line">posts = Post.objects.<span class="built_in">all</span>()</span><br><span class="line"><span class="comment"># 继续返回一个QuerySet对象并赋值给available_posts </span></span><br><span class="line">available_posts = posts.<span class="built_in">filter</span>(status=l) </span><br><span class="line"><span class="comment"># 此时会根据上面的两个条件执行数据查询操作，对应的 SQL 语句为:</span></span><br><span class="line"><span class="comment"># SELECT * FROM blog_post where status =1; </span></span><br><span class="line"><span class="built_in">print</span>(available_posts)</span><br></pre></td></tr></table></figure>

<p>objects的各种接口</p>
<p>支持链式调用的借口:</p>
<ul>
<li>all接口.<br>相当于 SELECT * FROM table_name语句,用于查询所有数据. </li>
<li>filter接口.<br>顾名思义,根据条件过滤数据,常用的条件基本上是字段等于、不等于、大于、小于.<br>当然还有其他的,比如能改成产生LIKE查询的:Model.objects.filter(content__contains=”条件”)</li>
<li>exclude接口.<br>同 filter,只是相反的逻辑. </li>
<li>reverse接口.<br>把QuerySet中的结果倒序排列.</li>
<li>distinct接口.<br>用来进行去重查询,产生 SELECT DISTINCT这样的SQL查询</li>
<li>none接口.<br>返回空的 QuerySet</li>
</ul>
<p>不支持链式调用的接口</p>
<ul>
<li><p>get 接口:<br>get接口的一般使用方法:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> :</span><br><span class="line">	post = Post.objects.get(<span class="built_in">id</span>=l)</span><br><span class="line"><span class="keyword">except</span> Post.DoesNotExist:</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></li>
<li><p>create 接口:<br>直接创建一个 Model 对象</p>
</li>
<li><p>get_or_create接口.<br>根据条件查找,如果没查找到,就调用 create创建. </p>
</li>
<li><p>update_or_create接口.<br>同get_or_create,<strong>只是用来做更新操作</strong>. </p>
</li>
<li><p>count接口.<br>用于返回 QuerySet有多少条记录,相当于 SELECT COUNT(*) FROM tablename.  </p>
</li>
<li><p>latest接口.<br>用于<strong>返回最新的一条记录</strong>,但是需要在 Model的Meta中定义:<code>get_latest_by= &lt;用来排序的字段&gt;</code></p>
</li>
<li><p>earliest接口.<br>同上,返回最早的一条记录. </p>
</li>
<li><p>first接口.<br>从当前 Queryset记录中获取第一条. </p>
</li>
<li><p>last接口.<br>同上,获取最后一条. </p>
</li>
<li><p>exists接口.<br>返回True或者False,在数据库层面执行<code> SELECT (1) As &quot;a&quot; FROM table_name  LIMIT 1</code>的查询,如果<strong>只是需要判断Queryset是否有数据</strong>,用这个接口是最合适的方式.不要用 count或者len(queryset)这样的操作来判断是否存在.<br>相反,如果可以预期接下来会用到 QuerySet中的数据,可以考虑使用<code>len(queryset)</code>的方式来做判断,这样可以减少一次DB查询请求.</p>
</li>
<li><p>bulk_create接口.<br>同create,用来批量创建记录. (bulk:大量的)</p>
</li>
<li><p>in_bulk接口.<br>批量<strong>查询</strong>,接收两个参数id_list和field_name.<br>可以通过<code>Post.objects.in_bulk([1,2,3])</code>查询出id为1、2、3的数据,返回结果是字典类型,字典类型的key为查询条件.返回结果示例:<code>&#123;1:&lt;Post 实例1&gt;,2:&lt;Post 实例2&gt;,3:&lt;Post 实例3&gt;&#125;</code>. </p>
</li>
<li><p>update接口.<br>用来根据条件批量更新记录,比如:<br><code>Post.objects.filter(owner__name=&#39;hyl&#39;).update(title=&#39;测试更新)</code></p>
</li>
<li><p>delete接口.<br>同 update,这个接口是用来根据条件批量删除记录.需要注意的是,update和 delete都会触发 Django的 signal</p>
</li>
<li><p><strong>values接口</strong>.<br>当我们明确知道只需要返回某个字段的值,不需要 Model实例时,可以使用它,用法如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">title_list= Post.objects.<span class="built_in">filter</span>(category_id=l).values(<span class="string">&#x27; title &#x27;</span>)</span><br><span class="line"><span class="comment"># 返回的结果是包含dict的QuerySet,类似这样:&lt;Queryset[&#123;&#x27;title&#x27;:xxx&#125;,]&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意:values实际上是返回一个queryset,而不是真正意义的字典,不可以用它来返回JsonResponse</p>
<p>要想用它来返回字典列表还是乖乖的使用列表解析:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">result = [&#123;<span class="string">&#x27;create_time&#x27;</span>: datetime.datetime.strftime(each.create_time,<span class="string">&#x27;%Y-%m-%d&#x27;</span>),</span><br><span class="line">           <span class="string">&#x27;title&#x27;</span>: each.title,<span class="string">&#x27;pk&#x27;</span>:each.pk&#125;</span><br><span class="line">          <span class="keyword">for</span> each <span class="keyword">in</span> articles]</span><br></pre></td></tr></table></figure></blockquote>
</li>
<li><p><strong>values_list接口</strong>.<br>同values,但是直接返回的是包含tuple的 QuerySet:<br>(values() 类似，只是在迭代时返回的是元组而不是字典)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">title_list= Post.objects.<span class="built_in">filter</span>(category_id=l).values_list(<span class="string">&#x27; title &#x27;</span>)</span><br><span class="line"><span class="comment"># 返回的结果是包含tuple的QuerySet,类似这样:&lt;Queryset[(&#x27;标题&#x27;,)]&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果只是一个字段的话，可以通过增加flat=True参数，便于我们后续处理</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">title_list= Post.objects.<span class="built_in">filter</span>(category_id=l).values_list(<span class="string">&#x27; title &#x27;</span>,flat=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> title <span class="keyword">in</span> title_list:</span><br><span class="line">    <span class="built_in">print</span>(title)</span><br></pre></td></tr></table></figure></li>
</ul>
<p>进阶接口:<br>用来提高性能的接口</p>
<ul>
<li><p>defer接口.<br>把不需要展示的字段做<strong>延迟加载</strong>.<br>比如说,需要获取到文章中除正文外的其他字段,就可以通过<br><code>posts = Post.objects.all().defer(&quot;content&quot;)</code>,这样拿到的记录中就不会包含 content部分.但是当我们需要用到这个字段时,在使用时会去加载.下面还是通过代码演示:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">posts = Post.objects.<span class="built_in">all</span>().defer(<span class="string">&#x27;content&#x27;</span>) </span><br><span class="line"><span class="comment"># 此时会执行数据库查询</span></span><br><span class="line"><span class="keyword">for</span> post <span class="keyword">in</span> posts:</span><br><span class="line">    <span class="comment"># 此时会执行数据查询，获取到 content</span></span><br><span class="line">    <span class="built_in">print</span>(post.content)                              </span><br></pre></td></tr></table></figure>

<p>当不想加载某个过大的字段时(如text类型的字段),会使用 defer,但是上面的演示代码会产生N+1的查询问题,在实际使用时千万要注意!</p>
<blockquote>
<ul>
<li>上面的代码是一个不太典型的N+1查询的问题.</li>
<li>一般情况下由外键查询产生的N+1问题比较多，即一条查询请求返回N条数据，当我们操作数据时，又会产生额外的请求。这就是N+1问题，所有的ORM框架都存在这样的问题</li>
</ul>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  获取所有的文章数据，注意此时不会执行sql语句</span></span><br><span class="line">posts = Post.objects.<span class="built_in">all</span>()  </span><br><span class="line">result = []</span><br><span class="line"><span class="comment"># 此时会执行select * from post的查询</span></span><br><span class="line"><span class="keyword">for</span> post <span class="keyword">in</span> posts:   </span><br><span class="line">    result.append(&#123;</span><br><span class="line">        <span class="string">&#x27;title&#x27;</span>: post.title,</span><br><span class="line">        <span class="comment"># 此时会执行select * from post的查询</span></span><br><span class="line">        <span class="string">&#x27;owner&#x27;</span>: post.owner.name, </span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<p>查看上面代码我们得知:每次循环都要查一下user表</p>
</li>
<li><p>only接口<br>同 defer接口刚好相反,如果只想获取到所有的title记录,就可以使用only,只获取title的内容,其他值在获取时会产生额外的查询. </p>
</li>
<li><p>select_related接口.<br>这就是用来解决外键产生的N+1问题的方案.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">posts = Post.objects.<span class="built_in">all</span>()(<span class="string">&#x27;category&#x27;</span>)</span><br><span class="line"><span class="comment"># 产生数据库查询</span></span><br><span class="line"><span class="keyword">for</span> post <span class="keyword">in</span> posts:</span><br><span class="line">    <span class="comment"># 产生额外的数据查询</span></span><br><span class="line">    <span class="built_in">print</span>(post.owner) </span><br></pre></td></tr></table></figure>

<p>使用select_related外键不会产生的N+1问题</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">post = Post.objects.<span class="built_in">all</span>().select_related(<span class="string">&#x27;category&#x27;</span>)</span><br><span class="line"><span class="comment"># 产生数据库查询,category数据也会一次性查询出来</span></span><br><span class="line"><span class="keyword">for</span> post <span class="keyword">in</span> posts: </span><br><span class="line">    <span class="built_in">print</span>(post.category) </span><br></pre></td></tr></table></figure>

<p>当然 ，这个接口只能用来解决<strong>一对多</strong>的关联关系,对于 对多的关系还得使用下面的接口</p>
</li>
<li><p>prefetch_related接口:<br>针对多对多关系的数据，可以通过这个接口来避免N+1查询。<br>比如，post和tag的关系可以通过这种方式来避免：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">posts = Post.objects.<span class="built_in">all</span>().prefetch_related(<span class="string">&#x27;tag&#x27;</span>)</span><br><span class="line"><span class="comment"># 产生两条查询语句，分别查询post和tag</span></span><br><span class="line"><span class="keyword">for</span> post <span class="keyword">in</span> posts: </span><br><span class="line">    <span class="built_in">print</span> (post.tag.<span class="built_in">all</span>()) </span><br></pre></td></tr></table></figure></li>
</ul>
<p>常用的字段查询:</p>
<ul>
<li>contains:<br>包含,用来进行相似查询. </li>
<li>icontains:<br>同 contains,只是忽略大小写. </li>
<li>exact:<br>精确匹配</li>
<li>iexact:<br>同 exact,忽略大小写. </li>
<li>in:<br>指定某个集合,比如<code>Post.objects.filter(id__in=[1,2,3])</code>相当于<code>SELECT * FROM blog_post WHERE IN(1,2,3)</code></li>
<li>gt:<br>大于某个值. </li>
<li>gte:<br>大于等于某个值. </li>
<li>lt:<br>小于某个值. </li>
<li>lte:<br>小于等于某个值. </li>
<li>startswith:<br>以某个字符串开头,与 contains类似,只是会产生<code>LKE&#39;&lt;关键词&gt;%&#39;</code>这样的SQL.  </li>
<li>istartswith:<br>同 startswith,忽略大小写. </li>
<li>endswith:<br>以某个字符串结尾. </li>
<li>iendswith:<br>同 endswith,忽略大小写. </li>
<li>range:<br>范围查询,多用于时间范围,如<code>Post.objects.filter(created_time__range(&#39;2018-05-01&#39;,&#39;2018-06-01&#39;))</code>会产生这样的查询:<code>SELECT ... WHERE created_time BETWEEN &#39;2018-05-01&#39; AND &#39;2018-06-01&#39;</code>;.</li>
</ul>
<p>进阶查询:</p>
<ul>
<li><p>F.<br><strong>F表达式常用来执行数据库层面的计算,从而避免出现竞争状态.</strong><br>比如需要处理每篇文章的访问量,假设存在post.pv这样的字段,当有用户访问时,我们对其加1</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">post = Post.objects.get(<span class="built_in">id</span>=<span class="number">1</span>)</span><br><span class="line">post.pv = post.pv + <span class="number">1</span></span><br><span class="line">pos.save() </span><br></pre></td></tr></table></figure>

<p>这在多线程的情况下会出现问题，其执行逻辑是先获取到当前的 pv 值，然后将其加1后赋值给 post.pv，最后保存.如果多个线程同时执行了<code>post=Post.objects.get(id=1)</code>那么每个线程里的post.pv值都是一样的,执行完加1和保存之后,相当于只执行了个加1,而不是多个.</p>
<p>其原因在于我们把数据拿到 Python中转了一圈，然后再保存到数据库中。这时通过F表达式就可以方便地解决这个问题</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> F</span><br><span class="line"></span><br><span class="line">post = Post.objects.get(<span class="built_in">id</span>=<span class="number">1</span>)</span><br><span class="line">post.pv = F(<span class="string">&#x27;pv&#x27;</span>) + <span class="number">1</span></span><br><span class="line">post.save() </span><br></pre></td></tr></table></figure>

<p>这种方式最终会产生类似这样的SQL语句:<code>UPDATE blog_post SET pv=pv+1  WHERE ID=1</code>.它在数据库层面执行原子性操作.</p>
<p>简单来说:<br><strong>F()对象代表一个模型字段的值或注释列</strong>。使用它可以直接引用模型字段的值并执行数据库操作而不用把它们导入到python的内存中。</p>
</li>
<li><p>Q.<br><strong>Q表达式就是用来解决OR查询的</strong>，可以这么用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Q</span><br><span class="line">Post.objects.<span class="built_in">filter</span>(Q(<span class="built_in">id</span>=<span class="number">1</span>) | Q(<span class="built_in">id</span>=<span class="number">2</span>)) </span><br></pre></td></tr></table></figure>

<p>或者 进行AND查询:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Post.objects.<span class="built_in">filter</span>(Q(<span class="built_in">id</span>=<span class="number">1</span>) &amp; Q(<span class="built_in">id</span>=<span class="number">2</span>)) </span><br></pre></td></tr></table></figure></li>
<li><p>Count<br>用来做聚合查询，比如想要得到某个分类下有多少篇文章，怎么做呢？简单的做法就是</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">category = Category.objects.get(<span class="built_in">id</span>=<span class="number">1</span>)</span><br><span class="line">posts_count = category.post_set.count() </span><br></pre></td></tr></table></figure>

<p>但是如果想要把这个结果放到 category 上呢？通过 category.post_count 可以访问到</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.mdoels <span class="keyword">import</span> Count</span><br><span class="line">categories = Category.objects.annotate(posts_count = Count(<span class="string">&#x27;post&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(categories[O].posts_count) </span><br></pre></td></tr></table></figure>

<p>这相当于给category动态增加了属性posts_count ,而这个属性的值来源于<code>Count(&#39;post&#39;)</code></p>
</li>
<li><p>Sum.<br>同 Count类似,只是它是用来做合计的.比如想要统计目前所有文章加起来的访问量有多少,可以这么做:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Sum</span><br><span class="line">Post.objects.aggregate(all_pv = Sum(<span class="string">&#x27;pv&#x27;</span>))</span><br><span class="line"><span class="comment"># 输出类似结果：&#123;&#x27;all_pv&#x27;:487&#125;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>ORM的使用必定会产生损耗.因此,Django还提供了原生SQL的接口<code>Post.objects.raw(&#39;SELECT * FROM blog_post&#39;)</code>,它除了可以解决 Queryset无法满足查询的情况外,还可以提高执行效率.不过,我们需要严格把控使用场景,因为过多地使用原生SQL会提高维护成本.</p>
<h1 id="第六章-开发管理后台"><a href="#第六章-开发管理后台" class="headerlink" title="第六章:开发管理后台"></a>第六章:开发管理后台</h1><p>本章来配置 Django 自带的admin.<br>Model定义好了字段类型，上层可以据这些字段类型定义Fom中需要呈现以及编辑的字段类型，这样就形成了表单。有了表单之后，基本上就有了增、删、改的页面。而基于Queryset这个数据集合以及它所提供的查询操作，就有了列表的数据以及列表页的操作。</p>
<p>制作用户CategoryAdmin,TagAdmin页面:<br>这里需要注意:<br>owner有非空约束,但是我们不可以在Admin页面来选择用户.如果这么做,岂不是任何作者都可以随意把自己创建的内容改为作者的吗?这就是bug了.</p>
<p>此时可以这么做:<br><strong>把owner这个字段自动设定为当前的登录用户</strong>。<br>这个时候就需要重写 ModelAdmin的<code>save_model</code>方法，其作用是==保存数据到数据库中==。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Post,Category,Tag</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@admin.register(<span class="params">Category</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryAdmin</span>(<span class="params">admin.ModelAdmin</span>):</span></span><br><span class="line">	list_display = (<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;status&#x27;</span>,<span class="string">&#x27;is_nav&#x27;</span>,<span class="string">&#x27;created_time&#x27;</span>)</span><br><span class="line">	fields = (<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;status&#x27;</span>,<span class="string">&#x27;is_nav&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">save_model</span>(<span class="params">self,request,obj,form,change</span>):</span></span><br><span class="line">		<span class="comment"># 给obj.owner赋值,自动设置owner</span></span><br><span class="line">		<span class="comment"># request是当前的请求,request.user就是当前已经登录的用户</span></span><br><span class="line">		<span class="comment"># 如果是未登录情况,request.user拿到的就是匿名用户对象</span></span><br><span class="line">		obj.owner = request.user</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">super</span>().save_model(request,obj,form,change)</span><br><span class="line"></span><br><span class="line"><span class="meta">@admin.register(<span class="params">Tag</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TagAdmin</span>(<span class="params">admin.ModelAdmin</span>):</span></span><br><span class="line">	list_display = (<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;status&#x27;</span>,<span class="string">&#x27;created_time&#x27;</span>)</span><br><span class="line">	fields = (<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;status&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">save_model</span>(<span class="params">self,request,obj,form,change</span>):</span></span><br><span class="line">		obj.owner = request.user</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">super</span>().save_model(request,obj,form,change)</span><br></pre></td></tr></table></figure>

<p>save_model()参数说明:</p>
<ul>
<li>request是当前的请求,reqeust.user就是当前已经登录的用户.<br>(如果是未登录情况,reqeust.user拿到的就是匿名用户对象)</li>
<li>obj就是当前要保存的对象</li>
<li>form是页面提交过来的表单之后的对象，</li>
<li>change用于标志本次保存的数据是新增的还是更新的</li>
</ul>
<p>制作用户PostAdmin页面:<br>还是在刚才的文件blogapp/admin.py中增加代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@admin.register(<span class="params">Post</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostAdmin</span>(<span class="params">admin.ModelAdmin</span>):</span></span><br><span class="line">	list_display = [</span><br><span class="line">		<span class="string">&#x27;title&#x27;</span>,<span class="string">&#x27;category&#x27;</span>,<span class="string">&#x27;status&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;created_time&#x27;</span>,<span class="string">&#x27;operator&#x27;</span></span><br><span class="line">	]</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 用来配置哪些字段可以作为链接，点击它们，可以进入编辑页面。</span></span><br><span class="line">	list_display_links = []</span><br><span class="line">	search_fields = [<span class="string">&#x27;title&#x27;</span>,<span class="string">&#x27;category__name&#x27;</span>]</span><br><span class="line"></span><br><span class="line">	actions_on_top = <span class="literal">True</span></span><br><span class="line">	actions_on_bottom = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 编辑页面</span></span><br><span class="line">	save_on_top = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">	fields = (</span><br><span class="line">		(<span class="string">&#x27;category&#x27;</span>,<span class="string">&#x27;title&#x27;</span>),</span><br><span class="line">		<span class="string">&#x27;desc&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;status&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;content&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;tag&#x27;</span>,</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">operator</span>(<span class="params">self,obj</span>):</span></span><br><span class="line">		<span class="keyword">return</span> format_html(</span><br><span class="line">			<span class="string">&#x27;&lt;a href=&quot;&#123;&#125;&quot;&gt;编辑&lt;/a&gt;&#x27;</span>,</span><br><span class="line">			reverse(<span class="string">&#x27;admin:blogapp_post_change&#x27;</span>,args=(obj.<span class="built_in">id</span>,))</span><br><span class="line">		)</span><br><span class="line"></span><br><span class="line">	operator.short_description = <span class="string">&#x27;操作&#x27;</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">save_model</span>(<span class="params">self,request,obj,form,change</span>):</span></span><br><span class="line">		obj.owner = request.user</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">super</span>(PostAdmin,self).save_model(request,obj,form,change)</span><br></pre></td></tr></table></figure>

<ul>
<li>list_display:<br>用来配置列表页面展示哪些字段.<br><img src="/images/1556808049606.png" alt="1556808049606"></li>
<li>list_display_links:<br><strong>用来配置哪些字段可以作为链接,点击它们,可以进入编辑页面</strong></li>
<li>list_filter:<br>配置页面过滤器,需要通过哪些字段来过滤列表页.上面我们配置了category,这意味着可以通过 category中的值来对数据进行过滤. </li>
<li>search_fields:<br>配置搜索字段.<br><img src="/images/1556808029571.png" alt="1556808029571"></li>
<li>actions_on_top:<br>动作相关的配置,是否展示在顶部.<br><img src="/images/1556807940677.png" alt="1556807940677"></li>
<li>ctions_on bottom:<br>动作相关的配置,是否展示在底部</li>
<li>save_on _top:<br><strong>保存、编辑、编辑并新建按钮是否在顶部展示</strong><br><img src="/images/1556808088754.png" alt="1556808088754"></li>
<li>operator.short_description:<br>指定表头的展示文案。<br><img src="/images/1556808384781.png" alt="1556808384781"></li>
</ul>
<p>自定义方法:<br>在list_display中，如果想要<strong>展示自定义字段</strong>，如何处理呢？上面的operator就是一个示例。<br><strong>自定义函数的参数是固定的，就是当前行的对象</strong>。列表页中的每一行数据都对应数据表中的条数据，也对应Model的一个实例。<br>自定义函数可以返回HTML，但是需要通过format _html函数处理，reverse是根据名称解析出URL地址。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自定义展示文章数量</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">post_count</span>(<span class="params">self,obj</span>):</span></span><br><span class="line">    <span class="keyword">return</span> obj.post_set.count()</span><br><span class="line"></span><br><span class="line">post_count.short_description = <span class="string">&#x27;文章数量&#x27;</span></span><br><span class="line">list_display = [post_count,...]</span><br></pre></td></tr></table></figure>



<p>在上面代码中,分类都是Category object.<br><img src="/images/1556808616850.png" alt="1556808616850"></p>
<p>这是因为<strong>没有定义Category类的__str__的缘故</strong>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Category</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.name</span><br></pre></td></tr></table></figure>

<p>对于每个 Model，都需要增加这个方法</p>
<p>接下来在设置configapp/admin.py和commentapp/admin.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># configapp/admin.py</span></span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Link,SideBar</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@admin.register(<span class="params">Link</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LinkAdmin</span>(<span class="params">admin.ModelAdmin</span>):</span></span><br><span class="line">	list_display = (<span class="string">&#x27;title&#x27;</span>,<span class="string">&#x27;href&#x27;</span>,<span class="string">&#x27;status&#x27;</span>,<span class="string">&#x27;weight&#x27;</span>,<span class="string">&#x27;created_time&#x27;</span>)</span><br><span class="line">	fields = (<span class="string">&#x27;title&#x27;</span>,<span class="string">&#x27;href&#x27;</span>,<span class="string">&#x27;status&#x27;</span>,<span class="string">&#x27;weight&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">save_model</span>(<span class="params">self,request,obj,form,change</span>):</span></span><br><span class="line">		obj.owner = request.user</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">super</span>(LinkAdmin,self).save_model(request,obj,form,change)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@admin.register(<span class="params">SideBar</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SideBarAdmin</span>(<span class="params">admin.ModelAdmin</span>):</span></span><br><span class="line">	list_display = (<span class="string">&#x27;title&#x27;</span>,<span class="string">&#x27;display_type&#x27;</span>,<span class="string">&#x27;content&#x27;</span>,<span class="string">&#x27;created_time&#x27;</span>)</span><br><span class="line">	fields = (<span class="string">&#x27;title&#x27;</span>,<span class="string">&#x27;display_type&#x27;</span>,<span class="string">&#x27;content&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">save_model</span>(<span class="params">self,request,obj,form,change</span>):</span></span><br><span class="line">		obj.owner = request.user</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">super</span>(SideBarAdmin,self).save_model(request,obj,form,change)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># commentapp/admin.py</span></span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Comment</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@admin.register(<span class="params">Comment</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommentAdmin</span>(<span class="params">admin.ModelAdmin</span>):</span></span><br><span class="line">	list_display = [<span class="string">&#x27;target&#x27;</span>,<span class="string">&#x27;nickname&#x27;</span>,<span class="string">&#x27;content&#x27;</span>,<span class="string">&#x27;website&#x27;</span>,<span class="string">&#x27;created_time&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>然后,站点管理就会变成这样:<br><img src="/images/1556843115040.png" alt="1556843115040"></p>
<hr>
<p>定制Admin页面</p>
<p>通过<code>__（双下划线）</code>的方式指定搜索关联Model。<br>这种用法可以用于list_display和list_filter。</p>
<p>下图,我们可以发现当前用户可以查看其它用户的文章,过滤器也可以查看全部的分类<br><img src="/images/1556844770338.png" alt="1556844770338"></p>
<p>让当前用户只能看到自己的分类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryOwnerFilter</span>(<span class="params">admin.SimpleListFilter</span>):</span></span><br><span class="line">	<span class="string">&#x27;&#x27;&#x27;自定义过滤器,只能展示当前用户分类&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">	title = <span class="string">&#x27;分类过滤器&#x27;</span></span><br><span class="line">	parameter_name = <span class="string">&#x27;owner_category&#x27;</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">lookups</span>(<span class="params">self,request,model_admin</span>):</span></span><br><span class="line">		<span class="keyword">return</span> Category.objects.<span class="built_in">filter</span>(owner=request.user).values_list(<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">queryset</span>(<span class="params">self,request,queryset</span>):</span></span><br><span class="line">		category_id = self.value()</span><br><span class="line">		<span class="keyword">if</span> category_id:</span><br><span class="line">			<span class="keyword">return</span> queryset.<span class="built_in">filter</span>(category_id=self.value())</span><br><span class="line">		<span class="keyword">return</span> queryset</span><br><span class="line">   </span><br><span class="line"><span class="comment"># 修改 PostAdmin的list_filter</span></span><br><span class="line">list_filter = [CategoryOwnerFilter]</span><br></pre></td></tr></table></figure>

<p>simpleListFilter类提供了两个属性和两个方法来供我们重写.<br>两个属性的作用顾名思义,</p>
<ul>
<li>title<br>用于展示标题</li>
<li>parameter_name<br>查询时URL参数的名字,比如查询分类id为1的内容时,URL后面的Query部分是<code>?owner_category=1</code>,此时就可以通过我们的过滤器拿到这个id,从而进行过滤.</li>
</ul>
<p>两个方法的作用如下:</p>
<ul>
<li>lookups:<br>返回要展示的内容和查询用的id(就是上面Query用的)</li>
<li>queryset:<br>根据 URL Query的内容返回列表页数据.比如如果URL最后的 Query是<code>?owner  category=1</code>,那么这里拿到的self.value()就是1,此时就会根据1来过滤Queryset.这里的 Queryset是列表页所有展示数据的合集,即post的数据集.</li>
</ul>
<p>让当前登录的用户在列表页中只能看到自己创建的文章.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@admin.register(<span class="params">Post</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostAdmin</span>(<span class="params">admin.ModelAdmin</span>):</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self,request</span>):</span></span><br><span class="line">		qs = <span class="built_in">super</span>().get_queryset(request)</span><br><span class="line">		<span class="keyword">return</span> qs.<span class="built_in">filter</span>(owner=request.ueser)</span><br></pre></td></tr></table></figure>

<p><img src="/images/1556847008751.png" alt="1556847008751"></p>
<p>使用fieldsets</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">fieldsets = (</span><br><span class="line">	(<span class="string">&#x27;基础配置&#x27;</span>,&#123;</span><br><span class="line">		<span class="string">&#x27;description&#x27;</span>:<span class="string">&#x27;基础配置描述&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;fields&#x27;</span>:(</span><br><span class="line">			(<span class="string">&#x27;title&#x27;</span>,<span class="string">&#x27;category&#x27;</span>),</span><br><span class="line">			<span class="string">&#x27;status&#x27;</span>,</span><br><span class="line">		),</span><br><span class="line">	&#125;),</span><br><span class="line"></span><br><span class="line">	(<span class="string">&#x27;内容&#x27;</span>,&#123;</span><br><span class="line">		<span class="string">&#x27;fields&#x27;</span>:(</span><br><span class="line">			<span class="string">&#x27;desc&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;content&#x27;</span>,</span><br><span class="line">		),</span><br><span class="line">	&#125;),</span><br><span class="line"></span><br><span class="line">	(<span class="string">&#x27;额外信息&#x27;</span>,&#123;</span><br><span class="line">		<span class="string">&#x27;classes&#x27;</span>:(<span class="string">&#x27;collapse&#x27;</span>,),</span><br><span class="line">		<span class="string">&#x27;fields&#x27;</span>:(<span class="string">&#x27;tag&#x27;</span>,),</span><br><span class="line">		&#125;)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><img src="/images/1556847870407.png" alt="1556847870407"></p>
<p>基本语法就是:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fieldsets = (</span><br><span class="line">    (名称,&#123;内容&#125;),</span><br><span class="line">    (名称,&#123;内容&#125;),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>第一个元素是 string，第二个元素是dict，而dict的key可以是fields、description和classes。</p>
<ul>
<li>fields:<br>可以控制展示哪些元素，也可以给元素排序井组合元素的位置</li>
<li>description:<br>描述信息</li>
<li>classes:<br>给要配置的版块加上一些CSS属性,Django admin默认支持的是collapse和wide.当然,你也可以写其他属性,然后自己来处理样式. </li>
</ul>
<p>针对多对多字段展示的配置 <code>filter_horizontal</code>和 <code>filter_vertical</code>:<br>它们用来控制多对多字段的展示效果</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">filter_horizontal = (<span class="string">&#x27;tags&#x27;</span>,)</span><br><span class="line"><span class="comment"># 或者下面</span></span><br><span class="line">filter_vertical = (<span class="string">&#x27;tags&#x27;</span>,)</span><br></pre></td></tr></table></figure>



<p>导入静态文件</p>
<p>我们之前介绍的是设置文件夹给<code>普通网页</code>导入静态文件,那么如何给<code>Admin页面</code>导入?<br>我们可以使用<code>Media类</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@admin.register(<span class="params">Post</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostAdmin</span>(<span class="params">admin.ModelAdmin</span>):</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Media</span>:</span></span><br><span class="line">		css = &#123;</span><br><span class="line">			<span class="built_in">all</span>:(<span class="string">&#x27;http://XXX.css&#x27;</span>,),</span><br><span class="line">		&#125;</span><br><span class="line">		js = (<span class="string">&#x27;https://XXX.js&#x27;</span>,)</span><br></pre></td></tr></table></figure>



<p>自定义 Form</p>
<p>现在我们自定义的Admin界面都是用Django的组件,我们还可以使用Model Form自定义</p>
<p>先在 blogapp 目录下新增一个文件adminfoms.py,<br>通过Fom来定制 status这个字段的展示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># adminfoms.py</span></span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostAdminForm</span>(<span class="params">forms.ModelForm</span>):</span></span><br><span class="line">	desc = forms.CharField(widget=forms.Textarea,label=<span class="string">&#x27;摘要&#x27;</span>,required=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<p>将这个PostAdminForm配置到admin.py中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blogapp/admin.py</span></span><br><span class="line"><span class="keyword">from</span> .adminforms <span class="keyword">import</span> PostAdminForm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@admin.register(<span class="params">Post</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostAdmin</span>(<span class="params">admin.ModelAdmin</span>):</span></span><br><span class="line">	form = PostAdminForm</span><br></pre></td></tr></table></figure>

<p>刷新一下页面，就能看到文章描述字段已经改为 Textarea 组件了</p>
<p>在同一页面编辑关联数据</p>
<p>在分类页面直接编辑文章</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostInline</span>(<span class="params">admin.TabularInline</span>):</span></span><br><span class="line">	fields = (<span class="string">&#x27;title&#x27;</span>,<span class="string">&#x27;desc&#x27;</span>)</span><br><span class="line">	extra = <span class="number">2</span></span><br><span class="line">	model = Post</span><br><span class="line">  </span><br><span class="line"><span class="comment"># 添加到CategoryAdmin</span></span><br><span class="line"><span class="meta">@admin.register(<span class="params">Category</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryAdmin</span>(<span class="params">admin.ModelAdmin</span>):</span></span><br><span class="line">	inlines = [PostInline,]</span><br></pre></td></tr></table></figure>

<p>效果</p>
<p><img src="/images/1556850368090.png" alt="1556850368090"></p>
<hr>
<p>现在我们登录一下admin页面</p>
<p><img src="/images/1556850693382.png" alt="1556850693382"></p>
<p>现在后台名称是“Django管理”，这看起来有点奇怪。</p>
<ol>
<li><p>新建一个custom_site.py文件:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># custom_site.py</span></span><br><span class="line"><span class="keyword">from</span> django.contrib.admin <span class="keyword">import</span> AdminSite</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomeSite</span>(<span class="params">AdminSite</span>):</span></span><br><span class="line">	site_header = <span class="string">&#x27;Typeidea&#x27;</span></span><br><span class="line">	site_title = <span class="string">&#x27;Typeidea 管理后台&#x27;</span></span><br><span class="line">	index_title = <span class="string">&#x27;首页&#x27;</span></span><br><span class="line"></span><br><span class="line">custom_site = CustomeSite(name=<span class="string">&#x27;cus_site&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>在blogapp.py中导入:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> custom_site <span class="keyword">import</span> custom_site</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改装饰器:</span></span><br><span class="line"><span class="comment"># 原先装饰器admin.register(Category)</span></span><br><span class="line"><span class="meta">@admin.register(<span class="params">Category,site=custom_site</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryAdmin</span>(<span class="params">admin.ModelAdmin</span>):</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></li>
<li><p>需要注意的是，上面用 reverse方式来获取后台地址时，我们用到了 admin这个名称，因此需要调整 blogapp/admin.py的代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 原先</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">operator</span>(<span class="params">self,obj</span>):</span></span><br><span class="line">	<span class="keyword">return</span> format_html(</span><br><span class="line">		<span class="string">&#x27;&lt;a href=&quot;&#123;&#125;&quot;&gt;编辑&lt;/a&gt;&#x27;</span>,</span><br><span class="line">		reverse(<span class="string">&#x27;admin:blogapp_post_change&#x27;</span>,args=(obj.<span class="built_in">id</span>,))</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 改为</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">operator</span>(<span class="params">self,obj</span>):</span></span><br><span class="line">	<span class="keyword">return</span> format_html(</span><br><span class="line">		<span class="string">&#x27;&lt;a href=&quot;&#123;&#125;&quot;&gt;编辑&lt;/a&gt;&#x27;</span>,</span><br><span class="line">		reverse(<span class="string">&#x27;cus_admin:blogapp_post_change&#x27;</span>,args=(obj.<span class="built_in">id</span>,))</span><br><span class="line">	)</span><br></pre></td></tr></table></figure></li>
<li><p>在project/urls.py添加路由:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r&#x27;^super_admin/&#x27;</span>,admin.site.urls),</span><br></pre></td></tr></table></figure>

<p>这样就有两套后台地址，一套用来管理用户，另外一套用来管理业务。<br>需要理解的是，这两套系统都是基于一套逻辑的用户系统，只是我们在URL上进行了划分。</p>
</li>
</ol>
<p>admin 的权限逻辑以及 sso 登录</p>
<p>SSO ( Single Sign-On ）:单点登录系统<br>SSO是在多个应用系统中，用户只需要登录一次就可以访问所有相互信任的应用系统。</p>
<p>ModelAdmin的配置就对应一个 Model的数据管理页面（列表页、新增页、编辑页、删除页），所以 Modelaamin的配置中包含了这些权限的方法。</p>
<ol>
<li>has_add_permission </li>
<li>has_change _permission </li>
<li>has_delete_permission </li>
<li>has_module_permission</li>
</ol>
<p>如果需要自己实现不同 Model 对应管理功能上的权限逻辑，可以通过重写上面的方法来实现.比如需要判断某个用户是否有添加文章的权限，而权限的管理是在另外的系统上,只提供了一个接口:<code>http://permission.sso.com/has_perm?user=&lt;用户标识&gt;&amp;perm_code=&lt;权限编号&gt;</code>如果有权限，那么响应状态为200；如果没有权限，则为403。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> get_permission_codename</span><br><span class="line"></span><br><span class="line">PERMISSION_API = <span class="string">&#x27;http://permission.sso.com/has_perm?user=&#123;&#125;&amp;perm_code=&#123;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostAdmin</span>(<span class="params">admin.ModelAdmin</span>):</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">has_add_permission</span>(<span class="params">self,request</span>):</span></span><br><span class="line">		opts = self.opts</span><br><span class="line">		codename = get_permission_codename(<span class="string">&#x27;add&#x27;</span>,opts)</span><br><span class="line">        <span class="comment"># 当前权限编号</span></span><br><span class="line">		perm_code = <span class="string">&#x27;&#123;&#125;.&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(opts.app_label,codename)</span><br><span class="line">		resp = requests.get(PERMISSION_API.<span class="built_in">format</span>(request.user.username,perm_code))</span><br><span class="line">		<span class="keyword">if</span> resp.status_code == <span class="number">200</span>:</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>



<p>抽取 Admin 基类:<br>我们整理一下 admin 的代码， 来保证代码整洁</p>
<p>之前我们在 PostAdmin中重写了save_model方法和 get_queryset方法, </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># save_model，其作用是保存数据到数据库中</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_model</span>(<span class="params">self,request,obj,form,change</span>):</span></span><br><span class="line">	obj.owner = request.user</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">super</span>(PostAdmin,self).save_model(request,obj,form,change)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self,request</span>):</span></span><br><span class="line">	qs = <span class="built_in">super</span>(PostAdmin,self).get_queryset(request)</span><br><span class="line">	<span class="keyword">return</span> qs.<span class="built_in">filter</span>(owner=request.user)</span><br></pre></td></tr></table></figure>

<p>目的是设置文章作者以及当前用户只能看到自己的文章.除了文章管理之外,还有其他模块也需要这么处理.因此，需要做一定程度的抽象</p>
<p>抽象BaseOwnerAdmin基类:<br>这个类帮我们完成两件事:</p>
<ul>
<li>重写 save_model 方法,此时需要自动设置对象的 owner;</li>
<li>重写 get_queryset 方法,让列表页在展示文章或者分类时只能展示当前用户的数据.</li>
</ul>
<p>首先,在manage.py目录下新创建一个base_admin.py文件<br>(之所以放这里是因为所有的App都需要用到):</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseOwnerAdmin</span>(<span class="params">admin.ModelAdmin</span>):</span></span><br><span class="line">	<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">	1. 用来自动补充文章,分类,标签,侧边栏,友链这些Model的owner字段</span></span><br><span class="line"><span class="string">	2. 用来针对queryset过滤当前用户的数据</span></span><br><span class="line"><span class="string">	&#x27;&#x27;&#x27;</span></span><br><span class="line">	exclude = (<span class="string">&#x27;owner&#x27;</span>,)</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self,request</span>):</span></span><br><span class="line">		qs = <span class="built_in">super</span>(BaseOwnerAdmin,self).get_queryset(request)</span><br><span class="line">		<span class="keyword">return</span> qs.<span class="built_in">filter</span>(owner=request.user)</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">save_model</span>(<span class="params">self,request,obj,form,change</span>):</span></span><br><span class="line">		obj.owner = request.user</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">super</span>(BaseOwnerAdmin,self).save_model(request,obj,form,change)</span><br></pre></td></tr></table></figure>

<p>接下来只要让管理类继承这个BaseOwnerAdmin即可:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 原先</span></span><br><span class="line"><span class="meta">@admin.register(<span class="params">Category,site=custom_site</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryAdmin</span>(<span class="params">admin.ModelAdmin</span>):</span></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改</span></span><br><span class="line"><span class="meta">@admin.register(<span class="params">Category,site=custom_site</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryAdmin</span>(<span class="params">BaseOwnerAdmin</span>):</span></span><br><span class="line">	...</span><br></pre></td></tr></table></figure>

<hr>
<p>定制ModelAdmin</p>
<p>ModelAdmin内部提供了两个方法，分别是log_addition和log_change。在官方文档上是看不到这个介绍的，因为它们是内部使用的函数。其功能如命名一样，一个是记录新增日志，一个是记录变更日志。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log_addition</span>(<span class="params">self, request, <span class="built_in">object</span>, message</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Log that an object has been successfully added.</span></span><br><span class="line"><span class="string">    The default implementation creates an admin LogEntry object.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">from</span> django.contrib.admin.models <span class="keyword">import</span> LogEntry, ADDITION</span><br><span class="line">    <span class="keyword">return</span> LogEntry.objects.log_action(</span><br><span class="line">        user_id=request.user.pk,</span><br><span class="line">        content_type_id=get_content_type_for_model(<span class="built_in">object</span>).pk,</span><br><span class="line">        object_id=<span class="built_in">object</span>.pk,</span><br><span class="line">        object_repr=force_text(<span class="built_in">object</span>),</span><br><span class="line">        action_flag=ADDITION,</span><br><span class="line">        change_message=message,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log_change</span>(<span class="params">self, request, <span class="built_in">object</span>, message</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Log that an object has been successfully changed.</span></span><br><span class="line"><span class="string">    The default implementation creates an admin LogEntry object.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">from</span> django.contrib.admin.models <span class="keyword">import</span> LogEntry, CHANGE</span><br><span class="line">    <span class="keyword">return</span> LogEntry.objects.log_action(</span><br><span class="line">        user_id=request.user.pk,</span><br><span class="line">        content_type_id=get_content_type_for_model(<span class="built_in">object</span>).pk,</span><br><span class="line">        object_id=<span class="built_in">object</span>.pk,</span><br><span class="line">        object_repr=force_text(<span class="built_in">object</span>),</span><br><span class="line">        action_flag=CHANGE,</span><br><span class="line">        change_message=message,</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<p>参数说明:</p>
<ul>
<li>user_id:<br>当前用户id</li>
<li>content_type_id:<br>要保存内容的类型,上面的代码中使用的是 get_typefor_model方法拿到对应 Model的类型id.这可以简单理解为 Content Type为每个Mode定义了一个类型id. </li>
<li>object_id:<br>记录变更实例的id,比如 PostAdmin中它就是post.id</li>
<li>object_repr:<br>实例的展示名称,可以简单理解为我们定义的__str__所返回的内容. </li>
<li>action_flag:<br>操作标记.admin的 Model里面定义了几种基础的标记:ADDITION、CHANGE和  DELETTON.它用来标记当前参数是数据变更、新增,还是删除. </li>
<li>change_message:<br>这是记录的消息,可以自行定义.我们可以把新添加的内容放进去必要时可以通过这里来恢复),也可以把新旧内容的区别放进去.</li>
</ul>
<p>查询某个对象的变更<br>如何查询已经记录的变更呢？</p>
<p>其实这是简单的 Model查询问题。假设我们记录的对象是post的操作，现在来获取Post中id为1的所有变更日志，大概代码如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.admin.models <span class="keyword">import</span> LogEntry,CHANGE</span><br><span class="line"><span class="keyword">from</span> django.contrib.admin.options <span class="keyword">import</span> get_content_type_for_model</span><br><span class="line"></span><br><span class="line">post = Post.objects.get(<span class="built_in">id</span>=<span class="number">1</span>)</span><br><span class="line">log_entries = LogEntry.objects.<span class="built_in">filter</span>(</span><br><span class="line">	content_type_id = get_content_type_for_model(post).pk,</span><br><span class="line">	object_id = post.<span class="built_in">id</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<p>在admin 页面上查看操作日志</p>
<p>我们既知道如何记录变更日志，也知道如何获取变更日志，那么如何才能够在 admin后台方便地查看操作日志呢？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blogapp/admin.py</span></span><br><span class="line"><span class="keyword">from</span> django.contrib.admin.models <span class="keyword">import</span> LogEntry</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@admin.register(<span class="params">LogEntry,site=custom_site</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogEntryAdmin</span>(<span class="params">admin.ModelAdmin</span>):</span></span><br><span class="line">	list_display = [<span class="string">&#x27;object_repr&#x27;</span>,<span class="string">&#x27;objec_id&#x27;</span>,<span class="string">&#x27;action_flag&#x27;</span>,<span class="string">&#x27;user&#x27;</span>,<span class="string">&#x27;change_message&#x27;</span>]</span><br></pre></td></tr></table></figure>



<h2 id="注意-跳过了第6章"><a href="#注意-跳过了第6章" class="headerlink" title="注意 : 跳过了第6章"></a>注意 : 跳过了第6章</h2></div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>