<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;用元素名称、id、class-定位元素&quot;&gt;&lt;a href=&quot;#用元素名称、id、class-定位元素&quot; class=&quot;headerlink&quot; title=&quot;用元素名称、id、class 定位元素&quot;&gt;&lt;/a&gt;用元素名称、id、class 定位元素&lt;/h2&gt;&lt;p&gt;address：&lt;a href=&quot;https://testerhome.com/topics/1047&quot;&gt;https://testerhome.com/topics/1047&lt;/a&gt;"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>ADB+Python | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Android-Debug-Bridge/" rel="tag">Android Debug Bridge</a></div><div class="post-time">2021-10-27</div></div></div><div class="container post-header"><h1>ADB+Python</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E5%85%83%E7%B4%A0%E5%90%8D%E7%A7%B0%E3%80%81id%E3%80%81class-%E5%AE%9A%E4%BD%8D%E5%85%83%E7%B4%A0"><span class="toc-number">1.</span> <span class="toc-text">用元素名称、id、class 定位元素</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%92%89%E9%92%89%E6%89%93%E5%8D%A1"><span class="toc-number">2.</span> <span class="toc-text">钉钉打卡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%B3%E4%B8%80%E8%B7%B3%E8%BE%85%E5%8A%A9%E7%A8%8B%E5%BA%8F"><span class="toc-number">3.</span> <span class="toc-text">跳一跳辅助程序</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A41"><span class="toc-number">3.1.</span> <span class="toc-text">步骤1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A42"><span class="toc-number">3.2.</span> <span class="toc-text">步骤2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A43"><span class="toc-number">3.3.</span> <span class="toc-text">步骤3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A44"><span class="toc-number">3.4.</span> <span class="toc-text">步骤4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81"><span class="toc-number">3.5.</span> <span class="toc-text">完整代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E6%9E%9C%E6%83%B3%E4%BD%BF%E7%94%A8%E6%A1%86%E6%9E%B6%EF%BC%8C%E5%8F%AF%E4%BB%A5%E8%AF%95%E8%AF%95Appium%E5%92%8Cpocoui"><span class="toc-number">4.</span> <span class="toc-text">如果想使用框架，可以试试Appium和pocoui</span></a></li></ol></details></div><div class="container post-content"><h2 id="用元素名称、id、class-定位元素"><a href="#用元素名称、id、class-定位元素" class="headerlink" title="用元素名称、id、class 定位元素"></a>用元素名称、id、class 定位元素</h2><p>address：<a target="_blank" rel="noopener" href="https://testerhome.com/topics/1047">https://testerhome.com/topics/1047</a></p>
<p>步骤：</p>
<ol>
<li>使用<code>adb shell uiautomator dump</code>命令，执行 <code>adb shell uiautomator dump /data/local/tmp/uidump.xml</code>，</li>
<li>然后将该 xml 文件 pull 到本地，从里面可以看到手机上当前页面的布局，在 note 节点下可以找到这些属性：text，resource-id，class，bounds，知道这些内容后就可以使用 python 对该 xml 文件解析获取到对应的属性，取出 bounds 的值，计算出对应元素区域的中心坐标，</li>
<li>接着使用<code> adb shell input tap</code> 命令就可以点击该坐标，如果有相同的属性值，那就需要得到一个坐标点的列表，</li>
</ol>
<p>以应用 “1 号店 “为例，在桌面上通过应用名称 “1 号店”，点击进入应用，然后点击 “手机充值”用 python 简单实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> xml.etree.cElementTree <span class="keyword">as</span> ET</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Element</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    通过元素定位,需要Android 4.0以上</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        初始化，获取系统临时文件存储目录，定义匹配数字模式</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.tempFile = tempfile.gettempdir()</span><br><span class="line">        self.pattern = re.<span class="built_in">compile</span>(<span class="string">r&quot;\d+&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__uidump</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        获取当前Activity控件树</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        os.popen(<span class="string">&quot;adb shell uiautomator dump /data/local/tmp/uidump.xml&quot;</span>)</span><br><span class="line">        os.popen(<span class="string">&quot;adb pull /data/local/tmp/uidump.xml &quot;</span> + self.tempFile)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__element</span>(<span class="params">self, attrib, name</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        同属性单个元素，返回单个坐标元组</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.__uidump()</span><br><span class="line">        tree = ET.ElementTree(file=self.tempFile + <span class="string">&quot;\\uidump.xml&quot;</span>)</span><br><span class="line">        treeIter = tree.<span class="built_in">iter</span>(tag=<span class="string">&quot;node&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> elem <span class="keyword">in</span> treeIter:</span><br><span class="line">            <span class="keyword">if</span> elem.attrib[attrib] == name:</span><br><span class="line">                bounds = elem.attrib[<span class="string">&quot;bounds&quot;</span>]</span><br><span class="line">                coord = self.pattern.findall(bounds)</span><br><span class="line">                Xpoint = (<span class="built_in">int</span>(coord[<span class="number">2</span>]) - <span class="built_in">int</span>(coord[<span class="number">0</span>])) / <span class="number">2.0</span> + <span class="built_in">int</span>(coord[<span class="number">0</span>])</span><br><span class="line">                Ypoint = (<span class="built_in">int</span>(coord[<span class="number">3</span>]) - <span class="built_in">int</span>(coord[<span class="number">1</span>])) / <span class="number">2.0</span> + <span class="built_in">int</span>(coord[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> Xpoint, Ypoint</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__elements</span>(<span class="params">self, attrib, name</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        同属性多个元素，返回坐标元组列表</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">list</span> = []</span><br><span class="line">        self.__uidump()</span><br><span class="line">        tree = ET.ElementTree(file=self.tempFile + <span class="string">&quot;\\uidump.xml&quot;</span>)</span><br><span class="line">        treeIter = tree.<span class="built_in">iter</span>(tag=<span class="string">&quot;node&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> elem <span class="keyword">in</span> treeIter:</span><br><span class="line">            <span class="keyword">if</span> elem.attrib[attrib] == name:</span><br><span class="line">                bounds = elem.attrib[<span class="string">&quot;bounds&quot;</span>]</span><br><span class="line">                coord = self.pattern.findall(bounds)</span><br><span class="line">                Xpoint = (<span class="built_in">int</span>(coord[<span class="number">2</span>]) - <span class="built_in">int</span>(coord[<span class="number">0</span>])) / <span class="number">2.0</span> + <span class="built_in">int</span>(coord[<span class="number">0</span>])</span><br><span class="line">                Ypoint = (<span class="built_in">int</span>(coord[<span class="number">3</span>]) - <span class="built_in">int</span>(coord[<span class="number">1</span>])) / <span class="number">2.0</span> + <span class="built_in">int</span>(coord[<span class="number">1</span>])</span><br><span class="line">                <span class="built_in">list</span>.append((Xpoint, Ypoint))</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">list</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">findElementByName</span>(<span class="params">self, name</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        通过元素名称定位</span></span><br><span class="line"><span class="string">        usage: findElementByName(u&quot;相机&quot;)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.__element(<span class="string">&quot;text&quot;</span>, name)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">findElementsByName</span>(<span class="params">self, name</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.__elements(<span class="string">&quot;text&quot;</span>, name)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">findElementByClass</span>(<span class="params">self, className</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        通过元素类名定位</span></span><br><span class="line"><span class="string">        usage: findElementByClass(&quot;android.widget.TextView&quot;)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.__element(<span class="string">&quot;class&quot;</span>, className)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">findElementsByClass</span>(<span class="params">self, className</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.__elements(<span class="string">&quot;class&quot;</span>, className)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">findElementById</span>(<span class="params">self, <span class="built_in">id</span></span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        通过元素的resource-id定位</span></span><br><span class="line"><span class="string">        usage: findElementsById(&quot;com.android.deskclock:id/imageview&quot;)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.__element(<span class="string">&quot;resource-id&quot;</span>,<span class="built_in">id</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">findElementsById</span>(<span class="params">self, <span class="built_in">id</span></span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.__elements(<span class="string">&quot;resource-id&quot;</span>,<span class="built_in">id</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Event</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        os.popen(<span class="string">&quot;adb wait-for-device &quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">touch</span>(<span class="params">self, dx, dy</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        触摸事件</span></span><br><span class="line"><span class="string">        usage: touch(500, 500)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        os.popen(<span class="string">&quot;adb shell input tap &quot;</span> + <span class="built_in">str</span>(dx) + <span class="string">&quot; &quot;</span> + <span class="built_in">str</span>(dy))</span><br><span class="line">        time.sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">    element = Element()</span><br><span class="line">    evevt = Event()</span><br><span class="line"></span><br><span class="line">    e1 = element.findElementByName(<span class="string">u&quot;1号店&quot;</span>)</span><br><span class="line">    evevt.touch(e1[<span class="number">0</span>], e1[<span class="number">1</span>])</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    e2 = element.findElementByName(<span class="string">u&quot;手机充值&quot;</span>)</span><br><span class="line">    evevt.touch(e2[<span class="number">0</span>], e2[<span class="number">1</span>])</span><br></pre></td></tr></table></figure>

<p>使用的前提是需要开启 view server，否则无法获取到 uidump.xml 这个文件。另外程序运行的时间会有点慢，可以有优化的方法。<br>另外如果属性值相同，使用 elements，返回的是含坐标元组的列表，如何使用，这里就不讲了。</p>
<p>将其进行修改:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> xml.etree.cElementTree <span class="keyword">as</span> ET</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_without_output</span>(<span class="params">cmd</span>):</span></span><br><span class="line">    os.popen(cmd)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_with_output</span>(<span class="params">cmd</span>):</span></span><br><span class="line">    <span class="keyword">with</span> os.popen(cmd) <span class="keyword">as</span> fp:</span><br><span class="line">        bf = fp._stream.buffer.read()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> bf.decode()</span><br><span class="line">    <span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">        <span class="keyword">return</span> bf.decode(<span class="string">&#x27;gbk&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Element</span>:</span></span><br><span class="line"></span><br><span class="line">    ADB_UI_TREE_DUMP_CMD = <span class="string">&quot;adb shell uiautomator dump /data/local/tmp/uidump.xml&quot;</span></span><br><span class="line">    ADB_GET_UI_TREE_CMD = <span class="string">&quot;adb shell cat /data/local/tmp/uidump.xml&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.pattern = re.<span class="built_in">compile</span>(<span class="string">r&quot;\d+&quot;</span>)</span><br><span class="line">        self.ui_tree = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__uidump</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        获取当前Activity控件树</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        run_with_output(self.ADB_UI_TREE_DUMP_CMD)</span><br><span class="line">        self.ui_tree = run_with_output(self.ADB_GET_UI_TREE_CMD)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__element</span>(<span class="params">self, attrib, name</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        同属性单个元素，返回单个坐标元组</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.__uidump()</span><br><span class="line">        tree = ET.ElementTree(ET.fromstring(self.ui_tree))</span><br><span class="line"></span><br><span class="line">        treeIter = tree.<span class="built_in">iter</span>(tag=<span class="string">&quot;node&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> elem <span class="keyword">in</span> treeIter:</span><br><span class="line">            <span class="keyword">if</span> elem.attrib[attrib] == name:</span><br><span class="line">                bounds = elem.attrib[<span class="string">&quot;bounds&quot;</span>]</span><br><span class="line">                coord = self.pattern.findall(bounds)</span><br><span class="line">                Xpoint = (<span class="built_in">int</span>(coord[<span class="number">2</span>]) - <span class="built_in">int</span>(coord[<span class="number">0</span>])) / <span class="number">2.0</span> + <span class="built_in">int</span>(coord[<span class="number">0</span>])</span><br><span class="line">                Ypoint = (<span class="built_in">int</span>(coord[<span class="number">3</span>]) - <span class="built_in">int</span>(coord[<span class="number">1</span>])) / <span class="number">2.0</span> + <span class="built_in">int</span>(coord[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> Xpoint, Ypoint</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__elements</span>(<span class="params">self, attrib, name</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        同属性多个元素，返回坐标元组列表</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.__uidump()</span><br><span class="line">        tree = ET.ElementTree(ET.fromstring(self.ui_tree))</span><br><span class="line">        </span><br><span class="line">        l = []</span><br><span class="line">        treeIter = tree.<span class="built_in">iter</span>(tag=<span class="string">&quot;node&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> elem <span class="keyword">in</span> treeIter:</span><br><span class="line">            <span class="keyword">if</span> elem.attrib[attrib] == name:</span><br><span class="line">                bounds = elem.attrib[<span class="string">&quot;bounds&quot;</span>]</span><br><span class="line">                coord = self.pattern.findall(bounds)</span><br><span class="line">                Xpoint = (<span class="built_in">int</span>(coord[<span class="number">2</span>]) - <span class="built_in">int</span>(coord[<span class="number">0</span>])) / <span class="number">2.0</span> + <span class="built_in">int</span>(coord[<span class="number">0</span>])</span><br><span class="line">                Ypoint = (<span class="built_in">int</span>(coord[<span class="number">3</span>]) - <span class="built_in">int</span>(coord[<span class="number">1</span>])) / <span class="number">2.0</span> + <span class="built_in">int</span>(coord[<span class="number">1</span>])</span><br><span class="line">                l.append((Xpoint, Ypoint))</span><br><span class="line">        <span class="keyword">return</span> l</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">findElementByName</span>(<span class="params">self, name</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        通过元素名称定位</span></span><br><span class="line"><span class="string">        usage: findElementByName(u&quot;相机&quot;)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.__element(<span class="string">&quot;text&quot;</span>, name)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">findElementsByName</span>(<span class="params">self, name</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.__elements(<span class="string">&quot;text&quot;</span>, name)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">findElementByClass</span>(<span class="params">self, className</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        通过元素类名定位</span></span><br><span class="line"><span class="string">        usage: findElementByClass(&quot;android.widget.TextView&quot;)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.__element(<span class="string">&quot;class&quot;</span>, className)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">findElementsByClass</span>(<span class="params">self, className</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.__elements(<span class="string">&quot;class&quot;</span>, className)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">findElementById</span>(<span class="params">self, <span class="built_in">id</span></span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        通过元素的resource-id定位</span></span><br><span class="line"><span class="string">        usage: findElementsById(&quot;com.android.deskclock:id/imageview&quot;)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.__element(<span class="string">&quot;resource-id&quot;</span>,<span class="built_in">id</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">findElementsById</span>(<span class="params">self, <span class="built_in">id</span></span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.__elements(<span class="string">&quot;resource-id&quot;</span>,<span class="built_in">id</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Event</span>:</span></span><br><span class="line"></span><br><span class="line">    ADB_WAIT_DEVICE_CMD = <span class="string">&quot;adb wait-for-device &quot;</span></span><br><span class="line">    ADB_TOUCH_CMD = <span class="string">&quot;adb shell input tap &#123;&#125; &#123;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        run_with_output(self.ADB_WAIT_DEVICE_CMD)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">touch</span>(<span class="params">self, dx, dy</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        触摸事件</span></span><br><span class="line"><span class="string">        usage: touch(500, 500)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        run_with_output(self.ADB_TOUCH_CMD.<span class="built_in">format</span>(dx, dy))</span><br><span class="line"></span><br><span class="line">element = Element()</span><br><span class="line">evevt = Event()</span><br><span class="line"></span><br><span class="line">e1 = element.findElementByName(<span class="string">u&quot;企业微信&quot;</span>)</span><br><span class="line">evevt.touch(e1[<span class="number">0</span>], e1[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">e2 = element.findElementByName(<span class="string">u&quot;技术支持研发沟通&quot;</span>)</span><br><span class="line">evevt.touch(e2[<span class="number">0</span>], e2[<span class="number">1</span>])</span><br></pre></td></tr></table></figure>



<h2 id="钉钉打卡"><a href="#钉钉打卡" class="headerlink" title="钉钉打卡"></a>钉钉打卡</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> os,subprocess</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">PATH = <span class="keyword">lambda</span> p: os.path.abspath(p)</span><br><span class="line">  </span><br><span class="line">isScreenshoting = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#打卡</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">onWork</span>():</span></span><br><span class="line">    <span class="comment"># 开个线程截图</span></span><br><span class="line">    ts = threading.Thread(target=runLoopScreenshot, args=())</span><br><span class="line">    ts.setDaemon(<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">global</span> isScreenshoting</span><br><span class="line">    isScreenshoting = <span class="literal">True</span></span><br><span class="line">    ts.start()</span><br><span class="line"></span><br><span class="line">    os.system(<span class="string">&#x27;adb shell input keyevent 26&#x27;</span>)</span><br><span class="line">    os.system(<span class="string">&#x27;adb shell input keyevent 3&#x27;</span>)</span><br><span class="line">    os.system(<span class="string">&#x27;adb shell am start -n com.alibaba.android.rimet/com.alibaba.android.rimet.biz.SplashActivity&#x27;</span>)</span><br><span class="line">    <span class="comment"># 等15秒后关闭</span></span><br><span class="line">    time.sleep(<span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">    os.system(<span class="string">&#x27;adb shell input keyevent 3&#x27;</span>)</span><br><span class="line">    os.system(<span class="string">&#x27;adb shell input keyevent 6&#x27;</span>)</span><br><span class="line">    isScreenshoting = <span class="literal">False</span></span><br><span class="line">    <span class="comment"># 打卡完毕</span></span><br><span class="line">    tend = threading.Thread(target=enddk, args=())</span><br><span class="line">    tend.start()</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">enddk</span>():</span></span><br><span class="line">    <span class="comment"># 通知你想通知的地方</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;end&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">10</span>)</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runLoopScreenshot</span>():</span></span><br><span class="line">    <span class="keyword">global</span> isScreenshoting</span><br><span class="line">    <span class="keyword">while</span> isScreenshoting:</span><br><span class="line">        <span class="comment"># os.popen(&quot;adb wait-for-device&quot;)</span></span><br><span class="line">        s = os.popen(<span class="string">&quot;adb shell screencap -p  | base64&quot;</span>).read()</span><br><span class="line">        <span class="built_in">print</span>(s)</span><br><span class="line">        os.popen(<span class="string">&quot;adb shell screencap -p /data/local/tmp/tmp.png&quot;</span>)</span><br><span class="line">        path = <span class="string">&#x27;/home/pi&#x27;</span></span><br><span class="line">        os.popen(<span class="string">&quot;adb pull /data/local/tmp/tmp.png &quot;</span> + PATH(path + <span class="string">&quot;/s.png&quot;</span>))</span><br><span class="line">        <span class="comment"># os.popen(&quot;adb shell rm /data/local/tmp/tmp.png&quot;)</span></span><br><span class="line">        <span class="comment"># 图片转了base64 可以发到你想发的地方</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(path + <span class="string">&quot;/s.png&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            base64_data = base64.b64encode(f.read())</span><br><span class="line">             </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;success&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    dakaTime = [<span class="string">&#x27;08:49:40&#x27;</span>, <span class="string">&#x27;08:47:32&#x27;</span>, <span class="string">&#x27;08:53:25&#x27;</span>]</span><br><span class="line">    nextDakaTime = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 看有没有设备连接</span></span><br><span class="line">            device = os.popen(<span class="string">&#x27;adb devices -l&#x27;</span>).read()</span><br><span class="line">            out = device.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;&#123;&quot;action&quot;:&quot;device&quot;,&quot;data&quot;:&quot;%s,%s,%s&quot;&#125;&#x27;</span> % (out[<span class="number">11</span>], out[<span class="number">12</span>], out[<span class="number">13</span>]))</span><br><span class="line">            currentTime = time.strftime(<span class="string">&quot;%H:%M:%S&quot;</span>, time.localtime())</span><br><span class="line">  </span><br><span class="line">            <span class="keyword">if</span> nextDakaTime == <span class="literal">None</span>:</span><br><span class="line">                r = random.randint(<span class="number">0</span>, <span class="built_in">len</span>(dakaTime) - <span class="number">1</span>)</span><br><span class="line">                nextDakaTime = dakaTime[r]</span><br><span class="line">            <span class="built_in">print</span>(currentTime,nextDakaTime)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> currentTime == nextDakaTime:</span><br><span class="line">                <span class="comment"># 开个线程打卡</span></span><br><span class="line">                t = threading.Thread(target=onWork, args=())</span><br><span class="line">                t.setDaemon(<span class="literal">True</span>)</span><br><span class="line">                t.start()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;something wrong:&quot;</span>, e)</span><br><span class="line"></span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  <span class="comment"># 设置多几个打卡时间</span></span><br><span class="line">  main()</span><br></pre></td></tr></table></figure>



<h2 id="跳一跳辅助程序"><a href="#跳一跳辅助程序" class="headerlink" title="跳一跳辅助程序"></a>跳一跳辅助程序</h2><p>address：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/dongkuo/p/8285162.html">https://www.cnblogs.com/dongkuo/p/8285162.html</a></p>
<ol>
<li>每次跳跃之前，截取一下手机屏幕，并将截图保存到本地电脑中；</li>
<li>计算截图中人偶的位置与将要跳至的台面中心的距离𝑑；</li>
<li>将以上距离𝑑换算成相应的触摸时间𝑠；</li>
<li>发送模拟触摸的命令至手机，触摸时间为以上时间𝑠；</li>
</ol>
<h3 id="步骤1"><a href="#步骤1" class="headerlink" title="步骤1"></a>步骤1</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用如下命令可截取手机屏幕图片至SD卡保存：</span></span><br><span class="line">adb shell screencap -p /mnt/sdcard/screencap.png</span><br><span class="line"></span><br><span class="line"><span class="comment"># 然后可用如下命令pull图片到电脑：</span></span><br><span class="line">adb pull /mnt/sdcard/screencap.png C:/screencap.png</span><br></pre></td></tr></table></figure>



<h3 id="步骤2"><a href="#步骤2" class="headerlink" title="步骤2"></a>步骤2</h3><p>要计算出人偶与将要跳至的台面中心的距离，需要分别识别出人偶的位置（坐标）和台面中心的位置（坐标）。</p>
<p>我们以人偶最底部的一行的中心作为人偶的位置，如下图所示:</p>
<p><img src="/images/TIM%E6%88%AA%E5%9B%BE20180114225816.jpg" alt="img"></p>
<p>至于怎么识别出人偶的最底部，可以这样来操作。通过观察可发现，人偶底部的颜色的rgb值在(53, 57, 95)到(59, 61, 103)之间，因此我们逐行扫描各个像素点，找到rbg值在该区间的各行，最后一行即为人偶的底部了。得到了最底部的一行，自然就能算出该行的中心坐标。</p>
<p>接下来需要识别人偶将要跳至的平台的中心。要想得到该中心的坐标，我们只需要识别得到下图中的两个顶点vertex1和vertex2的坐标即可：</p>
<p><img src="/images/TIM%E6%88%AA%E5%9B%BE20180114232019.jpg" alt="img"></p>
<p>我们同样用<strong>从左往右，从上往下的顺序扫描各个像素点的方法来找出vertex1的坐标</strong>。扫描之前先获取整个背景的颜色的rgb值，取任意“空白”处即可（例如本人手机截图大小为1920x1080，可断定坐标为(40, 500)的点一定处于“空白”处。）。在扫描过程中一旦发现某处的颜色与背景色不一致，发生了“突变”，可断定该点即为vertex1。</p>
<p>我们把vertex1点的rgb值记录下来作为台面的背景色。在接下去的扫描过程中，我们开始关心当前扫描的点的rgb值是否和该记录值“相似”。“相似”则说明该点“属于”台面，而通过上图可发现，顶点vertex2是所有“属于”台面的点中，横坐标最小的点，这样vertex2的坐标也找到了。</p>
<p>显然，台面中心的横坐标等于vertex1的横坐标，而纵坐标等于vertex2的纵坐标。</p>
<h3 id="步骤3"><a href="#步骤3" class="headerlink" title="步骤3"></a>步骤3</h3><p>通过多次尝试，发现用如下公式转换距离𝑑（单位：px）为时间𝑠（单位：毫秒）比较合适：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s=d∗1.35</span><br></pre></td></tr></table></figure>



<h3 id="步骤4"><a href="#步骤4" class="headerlink" title="步骤4"></a>步骤4</h3><p>得到了触摸时间，我们还是借助adb工具来模拟触摸屏幕的行为，以下是相关命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell input swipe 0 0 0 0 1000</span><br></pre></td></tr></table></figure>

<p>以上命令的最后一个参数即为需要模拟按压屏幕的时长，单位是毫秒。</p>
<h3 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h3><p>以下是完整代码，在本人手机（1920 * 1080 ）下测试发现大多数情况都能正中靶心，少数情况不能命中靶心，极少数情况会跳出台面以外。其他分辨率的手机可能需要适当修改<code>BACKGROUND_POS</code>和<code>DISTANCE_TO_TIME_RATIO</code>参数大小。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> reduce</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"> </span><br><span class="line">BACKGROUND_POS = (<span class="number">40</span>, <span class="number">500</span>)</span><br><span class="line">DISTANCE_TO_TIME_RATIO = <span class="number">1.35</span></span><br><span class="line">SCREENSHOT_PATH = tempfile.gettempdir() + <span class="string">&quot;/screenshot.png&quot;</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calculate_jump_distance</span>():</span></span><br><span class="line">    im = Image.<span class="built_in">open</span>(SCREENSHOT_PATH)</span><br><span class="line">    background_rgb = im.getpixel(BACKGROUND_POS)</span><br><span class="line"> </span><br><span class="line">    role_pos_list = <span class="literal">None</span></span><br><span class="line">    vertex1_pos = <span class="literal">None</span></span><br><span class="line">    vertex2_pos = <span class="literal">None</span></span><br><span class="line">    block_background_rgb = <span class="literal">None</span></span><br><span class="line">    role_line_flag = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(BACKGROUND_POS[<span class="number">1</span>], im.height):</span><br><span class="line">        <span class="keyword">if</span> role_pos_list <span class="keyword">and</span> role_line_flag:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        role_line_flag = <span class="literal">True</span></span><br><span class="line">        vertex2_line_flag = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(BACKGROUND_POS[<span class="number">0</span>], im.width):</span><br><span class="line">            current_rgb = im.getpixel((x, y))</span><br><span class="line">            next_rgb = im.getpixel((x + <span class="number">1</span>, y)) <span class="keyword">if</span> x + <span class="number">1</span> &lt; im.width <span class="keyword">else</span> (<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">            <span class="comment"># 识别顶点1</span></span><br><span class="line">            <span class="keyword">if</span> x &gt; BACKGROUND_POS[<span class="number">0</span>] <span class="keyword">and</span> y &gt; BACKGROUND_POS[<span class="number">1</span>] <span class="keyword">and</span> <span class="keyword">not</span> vertex1_pos <span class="keyword">and</span> <span class="keyword">not</span> is_similar(background_rgb, current_rgb) <span class="keyword">and</span> is_similar(current_rgb, next_rgb):</span><br><span class="line">                vertex1_pos = (x, y)</span><br><span class="line">                block_background_rgb = current_rgb</span><br><span class="line">            <span class="comment"># 识别顶点2</span></span><br><span class="line">            <span class="keyword">if</span> block_background_rgb <span class="keyword">and</span> vertex2_line_flag <span class="keyword">and</span> is_similar(current_rgb, block_background_rgb, <span class="number">5</span>):</span><br><span class="line">                vertex2_line_flag = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">if</span> vertex2_pos:</span><br><span class="line">                    <span class="keyword">if</span> x &lt; vertex2_pos[<span class="number">0</span>] <span class="keyword">and</span> vertex2_pos[<span class="number">0</span>] - x &lt; <span class="number">20</span> <span class="keyword">and</span> y - vertex2_pos[<span class="number">1</span>] &lt; <span class="number">20</span>:</span><br><span class="line">                        vertex2_pos = (x, y)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    vertex2_pos = (x, y)</span><br><span class="line">            <span class="comment"># 识别小人</span></span><br><span class="line">            <span class="keyword">if</span> is_part_of_role(current_rgb):</span><br><span class="line">                <span class="keyword">if</span> role_line_flag:</span><br><span class="line">                    role_pos_list = []</span><br><span class="line">                    role_line_flag = <span class="literal">False</span></span><br><span class="line">                role_pos_list.append((x, y))</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(role_pos_list) == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&#x27;无法识别小人位置！！！&#x27;</span>)</span><br><span class="line">    pos_sum = reduce((<span class="keyword">lambda</span> o1, o2: (o1[<span class="number">0</span>] + o2[<span class="number">0</span>], o1[<span class="number">1</span>] + o2[<span class="number">1</span>])), role_pos_list)</span><br><span class="line">    role_pos = (<span class="built_in">int</span>(pos_sum[<span class="number">0</span>] / <span class="built_in">len</span>(role_pos_list)), <span class="built_in">int</span>(pos_sum[<span class="number">1</span>] / <span class="built_in">len</span>(role_pos_list)))</span><br><span class="line">    destination_pos = (vertex1_pos[<span class="number">0</span>], vertex2_pos[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(linear_distance(role_pos, destination_pos))</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_part_of_role</span>(<span class="params">rgb</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">53</span> &lt; rgb[<span class="number">0</span>] &lt; <span class="number">59</span> <span class="keyword">and</span> <span class="number">57</span> &lt; rgb[<span class="number">1</span>] &lt; <span class="number">61</span> <span class="keyword">and</span> <span class="number">95</span> &lt; rgb[<span class="number">2</span>] &lt; <span class="number">103</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">linear_distance</span>(<span class="params">xy1, xy2</span>):</span></span><br><span class="line">    <span class="keyword">return</span> math.sqrt(<span class="built_in">pow</span>(xy1[<span class="number">0</span>] - xy2[<span class="number">0</span>], <span class="number">2</span>) + <span class="built_in">pow</span>(xy1[<span class="number">1</span>] - xy2[<span class="number">1</span>], <span class="number">2</span>))</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_similar</span>(<span class="params">rgb1, rgb2, degree=<span class="number">10</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">abs</span>(rgb1[<span class="number">0</span>] - rgb2[<span class="number">0</span>]) &lt;= degree <span class="keyword">and</span> <span class="built_in">abs</span>(rgb1[<span class="number">1</span>] - rgb2[<span class="number">1</span>]) &lt;= degree <span class="keyword">and</span> <span class="built_in">abs</span>(rgb1[<span class="number">2</span>] - rgb2[<span class="number">2</span>]) &lt;= degree</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">screenshot</span>():</span></span><br><span class="line">    os.system(<span class="string">&quot;adb shell screencap -p /mnt/sdcard/screencap.png&quot;</span>)</span><br><span class="line">    os.system(<span class="string">&quot;adb pull /mnt/sdcard/screencap.png &#123;&#125; &gt;&gt; &#123;&#125;/jump.out&quot;</span>.<span class="built_in">format</span>(SCREENSHOT_PATH, tempfile.gettempdir()))</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">jump</span>(<span class="params">touch_time</span>):</span></span><br><span class="line">    os.system(<span class="string">&quot;adb shell input swipe 0 0 0 0 &#123;&#125;&quot;</span>.<span class="built_in">format</span>(touch_time))</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">distance2time</span>(<span class="params">distance</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(distance * DISTANCE_TO_TIME_RATIO)</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    count = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        screenshot()</span><br><span class="line">        distance = calculate_jump_distance()</span><br><span class="line">        touch_time = distance2time(distance)</span><br><span class="line">        jump(touch_time)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;#&#123;&#125;: distance=&#123;&#125;, time=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(count, distance, touch_time))</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main()</span><br></pre></td></tr></table></figure>



<h2 id="如果想使用框架，可以试试Appium和pocoui"><a href="#如果想使用框架，可以试试Appium和pocoui" class="headerlink" title="如果想使用框架，可以试试Appium和pocoui"></a>如果想使用框架，可以试试Appium和pocoui</h2></div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>