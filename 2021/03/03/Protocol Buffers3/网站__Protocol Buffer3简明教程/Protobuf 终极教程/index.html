<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;Protobuf-终极教程&quot;&gt;&lt;a href=&quot;#Protobuf-终极教程&quot; class=&quot;headerlink&quot; title=&quot;Protobuf 终极教程&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://colobu.com/2019/10/03/protobuf-ultimate-tutorial-in-go/&quot;&gt;Protobuf 终极教程&lt;/a&gt;&lt;/h1&gt;&lt;h2 id=&quot;快速入门&quot;&gt;&lt;a href=&quot;#快速入门&quot; class=&quot;headerlink&quot; title=&quot;快速入门&quot;&gt;&lt;/a&gt;快速入门&lt;/h2&gt;&lt;h3 id=&quot;message定义一个消息&quot;&gt;&lt;a href=&quot;#message定义一个消息&quot; class=&quot;headerlink&quot; title=&quot;message定义一个消息&quot;&gt;&lt;/a&gt;message定义一个消息&lt;/h3&gt;&lt;p&gt;订单的消息格式：每个订单都含有一个order_id，订单金额num，订单时间timestamp字段。"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>Protobuf 终极教程 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Protocol-Buffers3/" rel="tag">Protocol Buffers3</a></div><div class="post-time">2021-03-03</div></div></div><div class="container post-header"><h1>Protobuf 终极教程</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Protobuf-%E7%BB%88%E6%9E%81%E6%95%99%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">Protobuf 终极教程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-number">1.1.</span> <span class="toc-text">快速入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#message%E5%AE%9A%E4%B9%89%E4%B8%80%E4%B8%AA%E6%B6%88%E6%81%AF"><span class="toc-number">1.1.1.</span> <span class="toc-text">message定义一个消息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91proto%E6%96%87%E4%BB%B6"><span class="toc-number">1.1.2.</span> <span class="toc-text">编译proto文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8go%E6%96%87%E4%BB%B6%E4%B8%AD%E4%BD%BF%E7%94%A8"><span class="toc-number">1.1.3.</span> <span class="toc-text">在go文件中使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B"><span class="toc-number">1.2.</span> <span class="toc-text">详细教程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#proto3-%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.2.1.</span> <span class="toc-text">proto3 格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%88%E6%9C%AC%E5%AE%9A%E4%B9%89"><span class="toc-number">1.2.2.</span> <span class="toc-text">版本定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E5%85%B6%E5%AE%83proto%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.3.</span> <span class="toc-text">引入其它proto文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#package"><span class="toc-number">1.2.4.</span> <span class="toc-text">package</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#option"><span class="toc-number">1.2.5.</span> <span class="toc-text">option</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%99%AE%E9%80%9A%E5%AD%97%E6%AE%B5"><span class="toc-number">1.2.6.</span> <span class="toc-text">普通字段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Oneof"><span class="toc-number">1.2.7.</span> <span class="toc-text">Oneof</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#map%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.8.</span> <span class="toc-text">map类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Reserved"><span class="toc-number">1.2.9.</span> <span class="toc-text">Reserved</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.10.</span> <span class="toc-text">枚举类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%85%B6%E5%AE%83%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.11.</span> <span class="toc-text">使用其它类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B5%8C%E5%A5%97%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.12.</span> <span class="toc-text">嵌套类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AA%E7%9F%A5%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.13.</span> <span class="toc-text">未知类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Any"><span class="toc-number">1.2.14.</span> <span class="toc-text">Any</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E6%B6%88%E6%81%AF%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.15.</span> <span class="toc-text">更新消息类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E5%AE%83"><span class="toc-number">1.2.16.</span> <span class="toc-text">其它</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Well-Known%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.3.</span> <span class="toc-text">Well-Known类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E7%A0%81"><span class="toc-number">1.4.</span> <span class="toc-text">编码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gogo%E5%BA%93"><span class="toc-number">1.5.</span> <span class="toc-text">gogo库</span></a></li></ol></li></ol></details></div><div class="container post-content"><h1 id="Protobuf-终极教程"><a href="#Protobuf-终极教程" class="headerlink" title="Protobuf 终极教程"></a><a target="_blank" rel="noopener" href="https://colobu.com/2019/10/03/protobuf-ultimate-tutorial-in-go/">Protobuf 终极教程</a></h1><h2 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h2><h3 id="message定义一个消息"><a href="#message定义一个消息" class="headerlink" title="message定义一个消息"></a>message定义一个消息</h3><p>订单的消息格式：每个订单都含有一个order_id，订单金额num，订单时间timestamp字段。</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// person.proto</span></span><br><span class="line">syntax = <span class="string">&quot;proto2&quot;</span></span><br><span class="line"><span class="keyword">package</span> myexample; <span class="comment">// 之后生成的go文件的包名就是myexample</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Order</span> </span>&#123;</span><br><span class="line">	<span class="keyword">required</span> <span class="built_in">string</span> order_id = <span class="number">1</span>; <span class="comment">// 1代表字段顺序，即order_id是第一个参数，以下同理</span></span><br><span class="line">	<span class="keyword">optional</span> <span class="built_in">int64</span> num = <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">repeated</span> <span class="built_in">int32</span> timestamp = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">	<span class="keyword">required</span> <span class="built_in">string</span> Name = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">required</span> <span class="built_in">int32</span> Age = <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">required</span> <span class="built_in">string</span> From = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>指定字段类型：protobuf字段的类型包括：string，int32，int64，enum等等</li>
<li>分配标识符：每个字段都有一个标识符，从1到536870911</li>
<li>指定字段规则：字段的修饰符包含三种类型：<ul>
<li>required：该字段必须设置</li>
<li>optional：该字段是可选的，即改字段可以有0个或1个值（不超过1）</li>
<li>repeated：该字段可以重复任意次（包括0次）</li>
</ul>
</li>
</ul>
<h3 id="编译proto文件"><a href="#编译proto文件" class="headerlink" title="编译proto文件"></a>编译proto文件</h3><p>编译person.proto文件，并将已编译文件输出到当前目录。执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc --go_out=. person.proto</span><br></pre></td></tr></table></figure>

<p>这样，当前目录就新增了一个<code>person.pb.go</code>文件，此文件包含了person的序列化和反序列化方法，可以给后续go文件使用。</p>
<h3 id="在go文件中使用"><a href="#在go文件中使用" class="headerlink" title="在go文件中使用"></a>在go文件中使用</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;ProtocDemo/myexample&quot;</span></span><br><span class="line">  <span class="string">&quot;github.com/golang/protobuf/proto&quot;</span></span><br><span class="line">  <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  msg_test := &amp;myexample.Person&#123;</span><br><span class="line">    Name: proto.String(<span class="string">&quot;hyl&quot;</span>)</span><br><span class="line">    Age : proto.Int(<span class="number">22</span>)</span><br><span class="line">    From: proto.String(<span class="string">&quot;China&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 序列化</span></span><br><span class="line">  msgDataEncoding, err := proto.Marshal(msg_test)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="built_in">panic</span>(err.Error())</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 反序列化</span></span><br><span class="line">  msgEntity := myexample.Person&#123;&#125;</span><br><span class="line">  err = proto.Unmashal(msgDataEncoding, &amp;msgEntity)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    fmt.Println(err.Error())</span><br><span class="line">    os.Exit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="详细教程"><a href="#详细教程" class="headerlink" title="详细教程"></a>详细教程</h2><p>首先让我们看一个简单的例子<code>simple.proto</code>:</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">SearchRequest</span> </span>&#123;</span><br><span class="line">  <span class="built_in">string</span> query = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">int32</span> page_number = <span class="number">2</span>;</span><br><span class="line">  <span class="built_in">int32</span> result_per_page = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一行指定protobuf的版本，这里是以<code>proto3</code>格式定义。你还可以指定为<code>proto2</code>。如果没有指定，默认以<code>proto2</code>格式定义。</p>
<p>它定义了一个message类型: <code>SearchRequest</code>， 它包含三个字段<code>query</code>、<code>page_number</code>、<code>result_per_page</code>,它会被protoc编译成不同的编程语言的相应对象，比如Java中的class、Go中的struct等。</p>
<p>字段是以<code>[ &quot;repeated&quot; ] type fieldName &quot;=&quot; fieldNumber [ &quot;[&quot; fieldOptions &quot;]&quot; ] &quot;;&quot;</code>格式定义的。这个例子是一个简单的例子，采用了<code>type fieldName &quot;=&quot; fieldNumber</code>格式定义的。</p>
<p>比如第一个字段<code>query</code>, 首先是它的类型<code>string</code>，其次是字段的名称，然后是等号<code>=</code>, 之后是字段的序号，然后是分号。</p>
<p>复杂的结构，前面可以定义为<code>repeated</code>, 序号之后可以定义一些可选项。</p>
<p>这是普通的字段定义，当然还有一些复杂的一些字段定义，比如<code>Oneof</code>、<code>Map</code>、<code>Reserved</code>、<code>enum</code>定义，下一节我们再详细讲。</p>
<p>在当前的目录下执行<code>protoc -I=. -I/usr/local/include -I=$(GOPATH)/src --go_out=. simple.proto</code>, 可以将这个proto编译成Go的代码，因为这里我们使用了<code>go_out</code>输出格式。</p>
<p><code>-I</code>指定protoc的搜索import的proto的文件夹。在<code>MacOS</code>操作系统中protobuf把一些扩展的proto放在了<code>/usr/local/include</code>对应的文件夹中，一些第三方的Go库放在了gopath对应的包下，所以这里都把它们加上了。对于这个简单的例子，实际是不需要的。</p>
<p><code>cpp_out</code>用来生成C++代码，<code>java_out</code>产生Java代码，<code>python_out</code>产生python代码，类似地还有<code>csharp_out</code>、<code>objc_out</code>、<code>ruby_out</code>、<code>php_out</code>等参数。</p>
<p>一些第三方的插件也会定义自己的输出插件，比如<code>gofast_out</code>使用gogo库生成代码， <code>rust_out</code>产生rust代码。</p>
<p>生成的代码我们指定放在本地文件夹中(<code>--go_out=.</code>)。</p>
<p>生成的数据结构如下，它还包括一些辅助方法以及<code>GetXXXX</code>读取字段的方法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> SearchRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	Query                <span class="keyword">string</span>   <span class="string">`protobuf:&quot;bytes,1,opt,name=query,proto3&quot; json:&quot;query,omitempty&quot;`</span></span><br><span class="line">	PageNumber           <span class="keyword">int32</span>    <span class="string">`protobuf:&quot;varint,2,opt,name=page_number,json=pageNumber,proto3&quot; json:&quot;page_number,omitempty&quot;`</span></span><br><span class="line">	ResultPerPage        <span class="keyword">int32</span>    <span class="string">`protobuf:&quot;varint,3,opt,name=result_per_page,json=resultPerPage,proto3&quot; json:&quot;result_per_page,omitempty&quot;`</span></span><br><span class="line">	XXX_NoUnkeyedLiteral <span class="keyword">struct</span>&#123;&#125; <span class="string">`json:&quot;-&quot;`</span></span><br><span class="line">	XXX_unrecognized     []<span class="keyword">byte</span>   <span class="string">`json:&quot;-&quot;`</span></span><br><span class="line">	XXX_sizecache        <span class="keyword">int32</span>    <span class="string">`json:&quot;-&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *SearchRequest)</span> <span class="title">Reset</span><span class="params">()</span></span>         &#123; *m = SearchRequest&#123;&#125; &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *SearchRequest)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123; <span class="keyword">return</span> proto.CompactTextString(m) &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*SearchRequest)</span> <span class="title">ProtoMessage</span><span class="params">()</span></span>    &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*SearchRequest)</span> <span class="title">Descriptor</span><span class="params">()</span> <span class="params">([]<span class="keyword">byte</span>, []<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> fileDescriptor_5ffd045dd4d042c1, []<span class="keyword">int</span>&#123;<span class="number">0</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	proto.RegisterType((*SearchRequest)(<span class="literal">nil</span>), <span class="string">&quot;abc.SearchRequest&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>



<h3 id="proto3-格式"><a href="#proto3-格式" class="headerlink" title="proto3 格式"></a>proto3 格式</h3><h3 id="版本定义"><a href="#版本定义" class="headerlink" title="版本定义"></a>版本定义</h3><p>首先我们会定义proto的版本。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br></pre></td></tr></table></figure>

<h3 id="引入其它proto文件"><a href="#引入其它proto文件" class="headerlink" title="引入其它proto文件"></a>引入其它proto文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import &quot;other.proto&quot;;</span><br><span class="line">import public &quot;other2.proto&quot;;</span><br><span class="line">import weak &quot;other.proto&quot;;</span><br></pre></td></tr></table></figure>

<p>比较少使用的是<code>public</code>和<code>weak</code>关键字。默认情况下<code>weak</code>引入的文件允许不存在(missing)，只为了google内部使用。<code>public</code>具有传递性，如果你在文件中通过<code>public</code>引入第三方的proto文件，那么引入你这个文件同时也会引入第三方的proto。</p>
<p>我们一般忽略<code>public</code>和<code>weak</code>关键字，这两个关键字也没有在规范中详细进行介绍。</p>
<h3 id="package"><a href="#package" class="headerlink" title="package"></a>package</h3><p>定义proto的包名，包名可以避免对message 类型之间的名字冲突，同名的Message可以通过package进行区分。</p>
<p>在没有为特定语言定义<code>option xxx_package</code>的时候，它还可以用来生成特定语言的包名，比如Java package, go package。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">package foo.bar;</span><br></pre></td></tr></table></figure>

<h3 id="option"><a href="#option" class="headerlink" title="option"></a>option</h3><p>option可以用在proto的scope中，或者message、enum、service的定义中。<br>可以是Protobuf定义的option，或者自定义的option。</p>
<p>option的定义格式是<code>&quot;option&quot; optionName &quot;=&quot; constant &quot;;&quot;</code>,比如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">option java_package = &quot;com.example.foo&quot;;</span><br></pre></td></tr></table></figure>

<p>一些Protobuf定义的option:</p>
<ul>
<li>java_package</li>
<li>java_multiple_files</li>
<li>java_outer_classname</li>
<li>optimize_for</li>
<li>cc_enable_arenas</li>
<li>objc_class_prefix</li>
<li>deprecated</li>
</ul>
<p>自定义的例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">option (gogoproto.testgen_all) = true;</span><br><span class="line">option (gogoproto.populate_all) = true;</span><br><span class="line">option (gogoproto.benchgen_all) = true;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">message NidRepPackedNative &#123;</span><br><span class="line">	repeated double Field1 = 1 [(gogoproto.nullable) = false, packed = true];</span><br><span class="line">	repeated float Field2 = 2 [(gogoproto.nullable) = false, packed = true];</span><br><span class="line">	repeated int32 Field3 = 3 [(gogoproto.nullable) = false, packed = true];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="普通字段"><a href="#普通字段" class="headerlink" title="普通字段"></a>普通字段</h3><p>前面讲过，普通字段的格式为<code>field = [ &quot;repeated&quot; ] type fieldName &quot;=&quot; fieldNumber [ &quot;[&quot; fieldOptions &quot;]&quot; ] &quot;;&quot;</code></p>
<p><code>repeated</code>允许字段重复，对于Go语言来说，它会编译成数组(<code>slice of type</code>)类型的格式。</p>
<p>其中类型可以是以下几种类型：</p>
<ul>
<li>数字类型： double、float、int32、int64、uint32、uint64、sint32、sint64: 存储长度可变的浮点数、整数、无符号整数和有符号整数</li>
<li>存储固定大小的数字类型：fixed32、fixed64、sfixed32、sfixed64: 存储空间固定</li>
<li>布尔类型: bool</li>
<li>字符串: string</li>
<li>bytes: 字节数组</li>
<li>messageType: 消息类型</li>
<li>enumType:枚举类型</li>
</ul>
<p>字段名、消息名、枚举类型名、map名、服务名等名称首字母必须是字母类型，然后可以是字母、数字或者下划线_。</p>
<p>下面是一个包含各种类型(Scalar Value Types)的proto文件。<br><img src="/images/normal-types.png" alt="img"></p>
<p>编译成Go文件：<code>protoc -I=. -I/usr/local/include -I=$(GOPATH)/src --go_out=. types.proto</code>。<br><img src="/images/normal-types-in-go.png" alt="img"></p>
<p>proto类型和各语言的对应关系可以参考文档：<a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/proto3#scalar">Scalar Value Types</a></p>
<p>同一个message的每个字段都有唯一一个编号，并且建议终生这个编号都不要改变。</p>
<h3 id="Oneof"><a href="#Oneof" class="headerlink" title="Oneof"></a>Oneof</h3><p>如果你有一组字段，同时最多允许这一组中的一个字段出现，就可以使用<code>Oneof</code>定义这一组字段，这有点Union的意思，但是Oneof允许你设置零各值。</p>
<p>因为proto3没有办法区分正常的值是否是设置了还是取得缺省值(比如int64类型字段，如果它的值是0，你无法判断数据是否包含这个字段，因为0几可能是数据中设置的值，也可能是这个字段的零值)，所以你可以通过Oneof取得这个功能，因为Oneof有判断字段是否设置的功能。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line"></span><br><span class="line">package abc;</span><br><span class="line"></span><br><span class="line">message OneofMessage &#123;</span><br><span class="line">    oneof test_oneof &#123;</span><br><span class="line">      string name = 4;</span><br><span class="line">      int64 value = 9;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><code>oneof</code>字段不能同时使用<code>repeated</code>。</p>
<h3 id="map类型"><a href="#map类型" class="headerlink" title="map类型"></a>map类型</h3><p>map类型需要设置键和值的类型，格式是<code>&quot;map&quot; &quot;&lt;&quot; keyType &quot;,&quot; type &quot;&gt;&quot; mapName &quot;=&quot; fieldNumber [ &quot;[&quot; fieldOptions &quot;]&quot;</code>。</p>
<p>比如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">map&lt;int64,string&gt; values = 1;</span><br></pre></td></tr></table></figure>

<p><code>map</code>字段不能同时使用<code>repeated</code>。</p>
<h3 id="Reserved"><a href="#Reserved" class="headerlink" title="Reserved"></a>Reserved</h3><p>Reserved可以用来指明此message不使用某些字段，也就是忽略这些字段。</p>
<p>可以通过字段编号范围或者字段名称指定保留的字段：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line"></span><br><span class="line">package abc;</span><br><span class="line"></span><br><span class="line">message AllNormalypes &#123;</span><br><span class="line">  reserved 2, 4 to 6;</span><br><span class="line">  reserved &quot;field14&quot;, &quot;field11&quot;;</span><br><span class="line">  double field1 = 1;</span><br><span class="line">  // float field2 = 2;</span><br><span class="line">  int32 field3 = 3;</span><br><span class="line">  // int64 field4 = 4;</span><br><span class="line">  // uint32 field5 = 5;</span><br><span class="line">  // uint64 field6 = 6;</span><br><span class="line">  sint32 field7 = 7;</span><br><span class="line">  sint64 field8 = 8;</span><br><span class="line">  fixed32 field9 = 9;</span><br><span class="line">  fixed64 field10 = 10;</span><br><span class="line">  // sfixed32 field11 = 11;</span><br><span class="line">  sfixed64 field12 = 12;</span><br><span class="line">  bool field13 = 13;</span><br><span class="line">  // string field14 = 14;</span><br><span class="line">  bytes field15 = 15;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>声明保留的字段你就不要再定义了，否则编译的时候会出错。</p>
<h3 id="枚举类型"><a href="#枚举类型" class="headerlink" title="枚举类型"></a>枚举类型</h3><p>枚举类型也是常用的一种类型，它限定字段的值只能取某个特定的值，比如星期类型只能取周一到周日七个值。</p>
<p>注意枚举类型的定义采用C++ scoping规则，也就是枚举值是枚举类型的兄弟类型，而不是子类型，所以避免在同一个package定义重名的枚举字段。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">enum EnumAllowingAlias &#123;</span><br><span class="line">  option allow_alias = true;</span><br><span class="line">  UNKNOWN = 0;</span><br><span class="line">  STARTED = 1;</span><br><span class="line">  RUNNING = 1;</span><br><span class="line">&#125;</span><br><span class="line">enum EnumNotAllowingAlias &#123;</span><br><span class="line">  UNKNOWN2 = 0;</span><br><span class="line">  STARTED2 = 1;</span><br><span class="line">  // RUNNING = 1; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>虽然产生的Go代码会给产生的类型加上前缀，但是proto的定义还是需要避免重名(把上面的STARTED2改成STARTED试试)。</p>
<p>如果设置<code>allow_alias</code>，允许字段编号重复，<code>RUNNING</code>是<code>STARTED</code>的别名。</p>
<p>枚举的常量必须是一个32比特的整数，从效率的角度考虑，不推荐采用负数。</p>
<p>第一个枚举值必须是0，而且必须定义。</p>
<p>你也可以把枚举类型定义到message中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">message SearchRequest &#123;</span><br><span class="line">  string query = 1;</span><br><span class="line">  int32 page_number = 2;</span><br><span class="line">  int32 result_per_page = 3;</span><br><span class="line">  enum Corpus &#123;</span><br><span class="line">    UNIVERSAL = 0;</span><br><span class="line">    WEB = 1;</span><br><span class="line">    IMAGES = 2;</span><br><span class="line">    LOCAL = 3;</span><br><span class="line">    NEWS = 4;</span><br><span class="line">    PRODUCTS = 5;</span><br><span class="line">    VIDEO = 6;</span><br><span class="line">  &#125;</span><br><span class="line">  Corpus corpus = 4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于无法识别的枚举值，不同的语言有不同的处理。对于Go语言来说，因为枚举类型以int32来表示，所以对应的值依然用int32解析出来，只不过没有对应的枚举值而已。这种情况还是会存在的，比如proto有改动，或者代码强行设置了一个未知的枚举值。</p>
<h3 id="使用其它类型"><a href="#使用其它类型" class="headerlink" title="使用其它类型"></a>使用其它类型</h3><p>你也可以使用其它message类型作为字段的类型值。因为前面在介绍字段的类型的时候说了，类型可以是消息类型和枚举类型，枚举类型如上所示，而消息类型如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">message SearchResponse &#123;</span><br><span class="line">  repeated Result results = 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message Result &#123;</span><br><span class="line">  string url = 1;</span><br><span class="line">  string title = 2;</span><br><span class="line">  repeated string snippets = 3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果要使用的类型在其它proto文件中定义，你需要使用<code>import</code>把对应的文件引入进来。</p>
<h3 id="嵌套类型"><a href="#嵌套类型" class="headerlink" title="嵌套类型"></a>嵌套类型</h3><p>嵌套类型就是消息类型里面定义了消息类型：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">message SearchResponse &#123;</span><br><span class="line">  message Result &#123;</span><br><span class="line">    string url = 1;</span><br><span class="line">    string title = 2;</span><br><span class="line">    repeated string snippets = 3;</span><br><span class="line">  &#125;</span><br><span class="line">  repeated Result results = 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果<code>Result</code>不需要共用，只被<code>SearchResponse</code>使用，可以采用这种定义方式， 如果你需要在外部使用这个类型，其实你也可以使用，但是不如把这个内部的消息类型定义抽取出来，除非你有很特别的含义：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">message SomeOtherMessage &#123;</span><br><span class="line">  SearchResponse.Result result = 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="未知类型"><a href="#未知类型" class="headerlink" title="未知类型"></a>未知类型</h3><p>未知类型是指数据的格式符合Protobuf的定义，但是数据中的某个/某些字段解析器无法识别的字段类型。一般发生在proto文件有变化，新旧数据不一致的情况导致。</p>
<p>proto3最开始对于不能识别的数据就丢弃掉了，但是自3.5 版本后重新引入了未知字段，以匹配proto2的行为。</p>
<h3 id="Any"><a href="#Any" class="headerlink" title="Any"></a>Any</h3><p><code>Any</code>字段允许你处理嵌套数据，并不需要它的proto定义。一个<code>Any</code>以bytes呈现序列化的消息，并且包含一个URL作为这个类型的唯一标识和元数据。</p>
<p>为了使用<code>Any</code>类型，你需要引入<code>google/protobuf/any.proto</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import &quot;google/protobuf/any.proto&quot;;</span><br><span class="line"></span><br><span class="line">message ErrorStatus &#123;</span><br><span class="line">  string message = 1;</span><br><span class="line">  repeated google.protobuf.Any details = 2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Any类型用来替换proto2中的扩展。</p>
<h3 id="更新消息类型"><a href="#更新消息类型" class="headerlink" title="更新消息类型"></a>更新消息类型</h3><p>有时候你不得不修改正在使用的proto文件，比如为类型增加一个字段，protobuf支持这种修改而不影响已有的服务，不过你需要遵循一定的规则：</p>
<ul>
<li>不要改变已有字段的字段编号</li>
<li>当你增加一个新的字段的时候，老系统序列化后的数据依然可以被你的新的格式所解析，只不过你需要处理新加字段的缺省值。 老系统也能解析你信息的值，新加字段只不过被丢弃了</li>
<li>字段也可以被移除，但是建议你Reserved这个字段，避免将来会使用这个字段</li>
<li>int32, uint32, int64, uint64 和 bool类型都是兼容的</li>
<li>sint32 和 sint64兼容，但是不和其它整数类型兼容</li>
<li>string 和 bytes兼容，如果 bytes 是合法的UTF-8 bytes的话</li>
<li>嵌入类型和bytes兼容，如果bytes包含一个消息的编码版本的话</li>
<li>fixed32和sfixed32, fixed64和sfixed64</li>
<li>enum和int32, uint32, int64, uint64格式兼容</li>
<li>把单一一个值改变成一个新的oneof类型的一个成员是安全和二进制兼容的。把一组字段变成一个新的oneof字段也是安全的，如果你确保这一组字段最多只会设置一个。把一个字段移动到一个已存在的oneof字段是不安全的</li>
</ul>
<h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><p>如果没有<code>Any</code>类型，序列化后的数据是没有类型的元数据信息的。这也意味着序列化的包和序列化后的包可以不一样，只要保证数据格式的定义兼容即可。</p>
<p>还可以通过Protobuf定义grpc服务，不过这个教程不涉及这一方面的介绍。</p>
<h2 id="Well-Known类型"><a href="#Well-Known类型" class="headerlink" title="Well-Known类型"></a>Well-Known类型</h2><p>除了我们前面介绍的基本类型、Any、还有省略未介绍的Service相关的类型外，还有一些大家常见的类型，Protobuf也提供了定义，比如<code>Timestamp</code>和<code>Duration</code>。这里我们看看如何使用它。</p>
<p>Protobuf提供了<code>github.com/golang/protobuf/ptypes/timestamp.Timestamp</code>和<code>github.com/golang/protobuf/ptypes/duration.Duration</code>两种扩展类型，用来表示时间，并提供了和标准库<code>time.Time</code>和 <code>time.Duration</code>的转换函数。</p>
<p>你可以在你的proto中需要时间戳和duration的地方使用这两个类型，而不是使用标准库的<code>time.Time</code>和<code>time.Duration</code>,因为标注库的类型没有提供protobuf序列化反序列化的功能，你需要额外处理，所以不如直接使用Protobuf提供的对应类型(下一节gogo库提供了对标准库的支持，稍候再讲)。</p>
<p>同时，它还是以指针的方式定义字段，这也意味着我们我们可以分别反序列化的时候，可以区分对应字段是否在数据中存在。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	fmt &quot;fmt&quot;</span><br><span class="line">	&quot;time&quot;</span><br><span class="line"></span><br><span class="line">	proto &quot;github.com/golang/protobuf/proto&quot;</span><br><span class="line">	ptypes &quot;github.com/golang/protobuf/ptypes&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	msg := &amp;WellKnownTypes&#123;</span><br><span class="line">		Now:  ptypes.TimestampNow(),</span><br><span class="line">		Took: ptypes.DurationProto(10 * time.Minute),</span><br><span class="line">	&#125;</span><br><span class="line">	data, err := proto.Marshal(msg)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		panic(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = proto.Unmarshal(data, msg)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		panic(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Println(msg)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h2><p>首先，我们先了解<code>varint</code>方法。<code>varint</code>方法是一种使用变长方式表示整数的方法，可以使用一个或者多个字节来表示小整数和大整数，数越小，使用的字节数越少。</p>
<p>在<code>varint</code>表示的字节中，除了最后一个字节，前面的字节都有一个bit来表示还有字节需要处理，这个标记叫做most significant bit (msb) set。低位放在前面。</p>
<p>比如<code>1</code>表示为<code>0000 0001</code>。最高位0表示这是最后一个字节了，只用一个字节就可以表示。</p>
<p>数字<code>300</code>表示为<code>1010 1100 0000 0010</code>, 两个字节来表示。每个字节高位去掉即可: <code>010 1100 000 0010</code>,反转<code>000 0010 010 1100</code>,去掉前面的0，也就是<code>100101100</code>, 2^8 + 2^5 + 2^3 + 2^2= 256+32+8+4=300。</p>
<p>Go标准库<code>encoding/binary</code>有对<code>varint</code>处理<a target="_blank" rel="noopener" href="https://golang.org/src/encoding/binary/varint.go">方法</a>。</p>
<p>事实上。Protobuf是编码的键值对，其中键用varint来表示，其中后三位代表wire type。</p>
<p>Protobuf只定义了6种wire类型。<br><img src="/images/wire-type.png" alt="img"></p>
<p>对于字段比较少(2^4=16)情况，使用一个字节就可以表示key。</p>
<p>我们以一个简单的例子，看看Protobuf是如何进行编码的。</p>
<p>这个例子的proto定义文件为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line"></span><br><span class="line">option go_package = &quot;main&quot;;</span><br><span class="line"></span><br><span class="line">message Person &#123;</span><br><span class="line">    string name = 1;</span><br><span class="line">    int32 id = 2;</span><br><span class="line">    repeated string email = 3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它定义了Persion这个message，包含三个字段，分别是string, int32和string类型，其中第三个字段允许重复。</p>
<p>定义一个实例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">p := &amp;Person&#123;</span><br><span class="line">	Name:  &quot;smallnest&quot;,</span><br><span class="line">	Id:    9527,</span><br><span class="line">	Email: []string&#123;&quot;test@example.com&quot;&#125;,</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>编码后是一个32字节的数据：</p>
<p><img src="/images/msg-data.png" alt="img"></p>
<p>第一个字段的类型是字符串(wire type是2), 字段编号是1 (00000001)， 字段编号左移三位再加上wiretype就是<code>0a</code>(00001010)。<br><img src="/images/field1.png" alt="img">]</p>
<p>第二个字段的类型是int32(wire type是0), 字段编号是2 (00000010)， 字段编号左移三位再加上wiretype就是<code>10</code>(00010000)。</p>
<p><img src="/images/field2-4756337.png" alt="img"></p>
<p>第三个字段的类型是字符串(wire type是2), 字段编号是3 (00000011)， 字段编号左移三位再加上wiretype就是<code>1a</code>(00011010)。<br><img src="/images/field3.png" alt="img"></p>
<p>为了更有效的处理<code>sint32</code>和<code>sint64</code>, Protobuf采用ZigZag<a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/encoding#signed-integers">编码</a>。</p>
<p>对于固定长度的数字，采用小端序的方式编码（little-endian byte order）。</p>
<p>字符串处理key之外，还需要一个varint记录其长度，然后是UTF-8的字符串值。</p>
<p>嵌入的message和bytes、string一样。</p>
<p>Proto3中对数字类型的repeated字段采用<code>pack</code>处理方式，同一个repeated元素共享同一个key，之后是字段的整体字节长度，然后是各个元素。因为数字类型天生具有可区分性，不需要额外的分隔符进行区分。</p>
<h2 id="gogo库"><a href="#gogo库" class="headerlink" title="gogo库"></a>gogo库</h2><p>虽然官方库<a target="_blank" rel="noopener" href="https://github.com/golang/protobuf">golang/protobu</a>提供了对Protobuf的支持，但是使用最多还是第三方实现的库<a target="_blank" rel="noopener" href="https://github.com/gogo/protobuf">gogo/protobuf</a>。</p>
<p>gogo库基于官方库开发，增加了很多的功能，包括：</p>
<ul>
<li>快速的序列化和反序列化</li>
<li>更规范的Go数据结构</li>
<li>goprotobuf兼容</li>
<li>可选择的产生一些辅助方法，减少使用中的代码输入</li>
<li>可以选择产生测试代码和benchmark代码</li>
<li>其它序列化格式</li>
</ul>
<p>比如etcd、k8s、dgraph、docker swarmkit都使用它。</p>
<p>基于速度和定制化的考虑，gogo有三种产生代码的方式</p>
<ul>
<li><code>gofast</code>: 速度优先，不支持其它gogoprotobuf extensions。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/gogo/protobuf/protoc-gen-gofast</span><br><span class="line">protoc --gofast_out=. myproto.proto</span><br></pre></td></tr></table></figure>

<ul>
<li><code>gogofast</code>、<code>gogofaster</code>、<code>gogoslick</code>: 更快的速度、更多的产生代码</li>
</ul>
<p><code>gogofast</code>类似<code>gofast</code>,但是会导入gogoprotobuf.<br><code>gogofaster</code>类似<code>gogofast</code>, 不会产生<code>XXX_unrecognized</code>指针字段，可以减少垃圾回收时间。<br><code>gogoslick</code>类似<code>gogofaster</code>,但是可以增加一些额外的方法<code>gostring</code>和<code>equal</code>等等。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/gogo/protobuf/proto</span><br><span class="line">go get github.com/gogo/protobuf/&#123;binary&#125; //protoc-gen-gogofast、protoc-gen-gogofaster 、protoc-gen-gogoslick </span><br><span class="line">go get github.com/gogo/protobuf/gogoproto</span><br><span class="line"></span><br><span class="line">protoc -I=. -I=$GOPATH/src -I=$GOPATH/src/github.com/gogo/protobuf/protobuf --&#123;binary&#125;_out=. myproto.proto</span><br></pre></td></tr></table></figure>

<ul>
<li><code>protoc-gen-gogo</code>: 最快的速度，最多的可定制化</li>
</ul>
<p>你可以通过扩展定制序列化: <a target="_blank" rel="noopener" href="https://github.com/gogo/protobuf/blob/master/extensions.md">扩展</a>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/gogo/protobuf/proto</span><br><span class="line">go get github.com/gogo/protobuf/jsonpb</span><br><span class="line">go get github.com/gogo/protobuf/protoc-gen-gogo</span><br><span class="line">go get github.com/gogo/protobuf/gogoproto</span><br></pre></td></tr></table></figure>

<p>gogo同样支持grpc: <code>protoc --gofast_out=plugins=grpc:. my.proto</code>, 但是本文不涉及这方面的介绍。</p>
<p>gogo提供了非常多的option, 以便在产生代码的时候进行更多的控制。这里有一个全面的介绍：<a target="_blank" rel="noopener" href="https://github.com/gogo/protobuf/blob/master/extensions.md">extensions</a>，主要包含一些生成快速序列化反序列化的代码的可选项、生成更规范的Go数据结构的可选项、Goprotobuf兼容的可选项，一些产生辅助方法的可选项、产生测试代码和benchmark的可选项，还可以增加jsontag。</p>
<p>这些可选项既然可以在message、enum中定义，控制单个message的生成方式，也可以在proto file scope中定义，控制这个文件中所有的message和enum的生成方式。如果是文件中定义可选项，可选项后面加<code>_all</code>下划线, 例如：</p>
<ul>
<li>marshaler_all</li>
<li>sizer_all</li>
<li>protosizer_all</li>
<li>unmarshaler_all</li>
<li>unsafe_marshaler_all</li>
<li>unsafe_unmarshaler_all</li>
<li>stable_marshaler_all</li>
<li>goproto_enum_prefix_all</li>
<li>goproto_getters_all</li>
<li>goproto_stringer_all</li>
<li>goproto_enum_stringer_all</li>
<li>……</li>
</ul>
<p>经常有网友问，标准库中的<code>time.Time</code>增加进行protobuf序列化？有建议采用unixtime， 使用int64表示。但是如果你使用gogo库，问题迎刃而解，因为它可以为标准库的time.Time和time.Duration生成定制的序列化反序列化方法。你直接使用标准库的类型即可。</p>
<p>下面是一个比较全面的扩展类型的proto的定义，增加了很多gogo的特别控制。运行<code>protoc -I=. -I=$(GOPATH)/src --gogo_out=. example.proto</code>会产生对应的代码以及测试和benchmark代码，你可以运行测试一下，以便更好的了解gogo库的威力。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line"></span><br><span class="line">package gogo_p3;</span><br><span class="line"></span><br><span class="line">import &quot;github.com/gogo/protobuf/gogoproto/gogo.proto&quot;;</span><br><span class="line"></span><br><span class="line">//import &quot;google/protobuf/any.proto&quot;;</span><br><span class="line">import &quot;google/protobuf/duration.proto&quot;;</span><br><span class="line">import &quot;google/protobuf/struct.proto&quot;;</span><br><span class="line">import &quot;google/protobuf/timestamp.proto&quot;;</span><br><span class="line">import &quot;google/protobuf/wrappers.proto&quot;;</span><br><span class="line"></span><br><span class="line">option (gogoproto.testgen_all) = true;</span><br><span class="line">option (gogoproto.populate_all) = true;</span><br><span class="line">option (gogoproto.benchgen_all) = true;</span><br><span class="line">option (gogoproto.unmarshaler_all) = false;</span><br><span class="line">option (gogoproto.marshaler_all) = false;</span><br><span class="line">option (gogoproto.sizer_all) = true;</span><br><span class="line">option (gogoproto.equal_all) = true;</span><br><span class="line">option (gogoproto.verbose_equal_all) = true;</span><br><span class="line">option (gogoproto.unsafe_marshaler_all) = false;</span><br><span class="line">option (gogoproto.unsafe_unmarshaler_all) = false;</span><br><span class="line"></span><br><span class="line">message KnownTypes &#123;</span><br><span class="line">  option (gogoproto.compare) = true;</span><br><span class="line">  google.protobuf.Duration dur = 1;</span><br><span class="line">  google.protobuf.Timestamp ts = 2;</span><br><span class="line">  google.protobuf.DoubleValue dbl = 3;</span><br><span class="line">  google.protobuf.FloatValue flt = 4;</span><br><span class="line">  google.protobuf.Int64Value i64 = 5;</span><br><span class="line">  google.protobuf.UInt64Value u64 = 6;</span><br><span class="line">  google.protobuf.Int32Value i32 = 7;</span><br><span class="line">  google.protobuf.UInt32Value u32 = 8;</span><br><span class="line">  google.protobuf.BoolValue bool = 9;</span><br><span class="line">  google.protobuf.StringValue str = 10;</span><br><span class="line">  google.protobuf.BytesValue bytes = 11;</span><br><span class="line"></span><br><span class="line">  // TODO uncomment this once https://github.com/gogo/protobuf/issues/197 is fixed</span><br><span class="line">  google.protobuf.Struct st = 12;</span><br><span class="line">  // google.protobuf.Any an = 14;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message ProtoTypes &#123;</span><br><span class="line">  // TODO this should be a compare_all at the top of the file once time.Time, time.Duration, oneof and map is supported by compare</span><br><span class="line">  option (gogoproto.compare) = true;</span><br><span class="line">  google.protobuf.Timestamp nullableTimestamp = 1;</span><br><span class="line">  google.protobuf.Duration nullableDuration = 2;</span><br><span class="line">  google.protobuf.DoubleValue nullableDouble = 3;</span><br><span class="line">  google.protobuf.FloatValue nullableFloat = 4;</span><br><span class="line">  google.protobuf.Int64Value nullableInt64 = 5;</span><br><span class="line">  google.protobuf.UInt64Value nullableUInt64 = 6;</span><br><span class="line">  google.protobuf.Int32Value nullableInt32 = 7;</span><br><span class="line">  google.protobuf.UInt32Value nullableUInt32 = 8;</span><br><span class="line">  google.protobuf.BoolValue nullableBool = 9;</span><br><span class="line">  google.protobuf.StringValue nullableString = 10;</span><br><span class="line">  google.protobuf.BytesValue nullableBytes = 11;</span><br><span class="line">    </span><br><span class="line">  google.protobuf.Timestamp timestamp = 12 [(gogoproto.nullable) = false];</span><br><span class="line">  google.protobuf.Duration duration = 13 [(gogoproto.nullable) = false];</span><br><span class="line">  google.protobuf.DoubleValue nonnullDouble = 14 [(gogoproto.nullable) = false];</span><br><span class="line">  google.protobuf.FloatValue nonnullFloat = 15 [(gogoproto.nullable) = false];</span><br><span class="line">  google.protobuf.Int64Value nonnullInt64 = 16 [(gogoproto.nullable) = false];</span><br><span class="line">  google.protobuf.UInt64Value nonnullUInt64 = 17 [(gogoproto.nullable) = false];</span><br><span class="line">  google.protobuf.Int32Value nonnullInt32 = 18 [(gogoproto.nullable) = false];</span><br><span class="line">  google.protobuf.UInt32Value nonnullUInt32 = 19 [(gogoproto.nullable) = false];</span><br><span class="line">  google.protobuf.BoolValue nonnullBool = 20 [(gogoproto.nullable) = false];</span><br><span class="line">  google.protobuf.StringValue nonnullString = 21 [(gogoproto.nullable) = false];</span><br><span class="line">  google.protobuf.BytesValue nonnullBytes = 22 [(gogoproto.nullable) = false];</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">message StdTypes &#123;</span><br><span class="line">  google.protobuf.Timestamp nullableTimestamp = 1 [(gogoproto.stdtime) = true];</span><br><span class="line">  google.protobuf.Duration nullableDuration = 2 [(gogoproto.stdduration) = true];</span><br><span class="line">  google.protobuf.DoubleValue nullableDouble = 3 [(gogoproto.wktpointer) = true];;</span><br><span class="line">  google.protobuf.FloatValue nullableFloat = 4 [(gogoproto.wktpointer) = true];;</span><br><span class="line">  google.protobuf.Int64Value nullableInt64 = 5 [(gogoproto.wktpointer) = true];;</span><br><span class="line">  google.protobuf.UInt64Value nullableUInt64 = 6 [(gogoproto.wktpointer) = true];;</span><br><span class="line">  google.protobuf.Int32Value nullableInt32 = 7 [(gogoproto.wktpointer) = true];;</span><br><span class="line">  google.protobuf.UInt32Value nullableUInt32 = 8 [(gogoproto.wktpointer) = true];;</span><br><span class="line">  google.protobuf.BoolValue nullableBool = 9 [(gogoproto.wktpointer) = true];;</span><br><span class="line">  google.protobuf.StringValue nullableString = 10 [(gogoproto.wktpointer) = true];;</span><br><span class="line">  google.protobuf.BytesValue nullableBytes = 11 [(gogoproto.wktpointer) = true];;</span><br><span class="line">    </span><br><span class="line">  google.protobuf.Timestamp timestamp = 12 [(gogoproto.stdtime) = true, (gogoproto.nullable) = false];</span><br><span class="line">  google.protobuf.Duration duration = 13 [(gogoproto.stdduration) = true, (gogoproto.nullable) = false];</span><br><span class="line">  google.protobuf.DoubleValue nonnullDouble = 14 [(gogoproto.wktpointer) = true, (gogoproto.nullable) = false];</span><br><span class="line">  google.protobuf.FloatValue nonnullFloat = 15 [(gogoproto.wktpointer) = true, (gogoproto.nullable) = false];</span><br><span class="line">  google.protobuf.Int64Value nonnullInt64 = 16 [(gogoproto.wktpointer) = true, (gogoproto.nullable) = false];</span><br><span class="line">  google.protobuf.UInt64Value nonnullUInt64 = 17 [(gogoproto.wktpointer) = true, (gogoproto.nullable) = false];</span><br><span class="line">  google.protobuf.Int32Value nonnullInt32 = 18 [(gogoproto.wktpointer) = true, (gogoproto.nullable) = false];</span><br><span class="line">  google.protobuf.UInt32Value nonnullUInt32 = 19 [(gogoproto.wktpointer) = true, (gogoproto.nullable) = false];</span><br><span class="line">  google.protobuf.BoolValue nonnullBool = 20 [(gogoproto.wktpointer) = true, (gogoproto.nullable) = false];</span><br><span class="line">  google.protobuf.StringValue nonnullString = 21 [(gogoproto.wktpointer) = true, (gogoproto.nullable) = false];</span><br><span class="line">  google.protobuf.BytesValue nonnullBytes = 22 [(gogoproto.wktpointer) = true, (gogoproto.nullable) = false];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>