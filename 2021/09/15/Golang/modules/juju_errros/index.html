<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Git URL:"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>juju_errros | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Golang/" rel="tag">Golang</a></div><div class="post-time">2021-09-15</div></div></div><div class="container post-header"><h1>juju_errros</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#quick-start"><span class="toc-number">1.</span> <span class="toc-text">quick start</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#API-%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.</span> <span class="toc-text">API 介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#errors-Errorf-format-arg-errors-New-msg"><span class="toc-number">2.1.</span> <span class="toc-text">errors.Errorf(format,arg...) &#x2F; errors.New(msg)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#errors-Trace-error"><span class="toc-number">2.2.</span> <span class="toc-text">errors.Trace(error)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#errors-Annotate-error-msg"><span class="toc-number">2.3.</span> <span class="toc-text">errors.Annotate(error,msg)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Wrapf-error1-error2-format-args-Wrap-parent-new-error"><span class="toc-number">2.4.</span> <span class="toc-text">Wrapf(error1, error2, format, args) , Wrap(parent, new) error</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#errors-NewBadRequest-err-msg-%E5%92%8C-errors-IsBadRequest-err"><span class="toc-number">2.5.</span> <span class="toc-text">errors.NewBadRequest(err,msg) 和 errors.IsBadRequest(err)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E6%80%95%E4%BC%A0%E9%80%92%E7%A9%BA"><span class="toc-number">2.6.</span> <span class="toc-text">不怕传递空</span></a></li></ol></li></ol></details></div><div class="container post-content"><p>Git URL:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git://www.github.com/juju/errors.git</span><br></pre></td></tr></table></figure>



<h2 id="quick-start"><a href="#quick-start" class="headerlink" title="quick start"></a>quick start</h2><p>下面是个简单的例子，假如我们的func每次都去向外抛出异常，对于代码跟踪来说说实话很不方便的，所以依靠这个日志很好的定位问题！</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	err := errors.New(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">	err1 := errors.Trace(err)</span><br><span class="line">	err2 := errors.Trace(err1)</span><br><span class="line">	err3 := errors.Trace(err2)</span><br><span class="line">	stack := errors.ErrorStack(err3)</span><br><span class="line">	fmt.Println(stack)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/Users/dong/go/code/github/errors-pck/errors/main.go:9: 1</span><br><span class="line">/Users/dong/go/code/github/errors-pck/errors/main.go:10: </span><br><span class="line">/Users/dong/go/code/github/errors-pck/errors/main.go:11: </span><br><span class="line">/Users/dong/go/code/github/errors-pck/errors/main.go:12: </span><br></pre></td></tr></table></figure>



<p>如果在业务中，我们可能靠打印日志的问题，那么就会造成异常日志难以追踪，必须依赖trace_id，还需要依赖上下文传递，所以这里我们假如使用这个error，那么会带来很多方便的功能，就是很好的定位异常。</p>
<p>比如我举个例子：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/juju/errors&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// dao</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">findUserNameById</span><span class="params">(ctx context.Context, id <span class="keyword">uint64</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> id == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, errors.Errorf(<span class="string">&quot;not fond user , user_id=%d&quot;</span>, id)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;success&quot;</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// service</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetUserInfo</span><span class="params">(ctx context.Context, id <span class="keyword">uint64</span>)</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span></span> &#123;</span><br><span class="line">	name, err := findUserNameById(ctx, id)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.Annotate(err, <span class="string">&quot;GetUserInfo error&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">		<span class="string">&quot;name&quot;</span>: name,</span><br><span class="line">	&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// controller</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	info, err := GetUserInfo(context.Background(), <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		errs := errors.ErrorStack(err)</span><br><span class="line">		<span class="comment">// todo log</span></span><br><span class="line">		fmt.Println(errs)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(info)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/Users/dong/<span class="keyword">go</span>/code/github/errors-pck/errors/main.<span class="keyword">go</span>:<span class="number">11</span>: not fond user , user_id=<span class="number">0</span></span><br><span class="line">/Users/dong/<span class="keyword">go</span>/code/github/errors-pck/errors/main.<span class="keyword">go</span>:<span class="number">19</span>: GetUserInfo error</span><br></pre></td></tr></table></figure>

<p>所以很轻松的携带了信息，同时很好的记录的异常。如果我们业务去记录大量的日志，对于io的影响很大。</p>
<p>其实对于磁盘来说，单次io的消耗&gt;调用<code>Caller</code>的消耗，同时省去了trace_id 的烦恼！！！！！！</p>
<h2 id="API-介绍"><a href="#API-介绍" class="headerlink" title="API 介绍"></a>API 介绍</h2><h3 id="errors-Errorf-format-arg-errors-New-msg"><a href="#errors-Errorf-format-arg-errors-New-msg" class="headerlink" title="errors.Errorf(format,arg...) / errors.New(msg)"></a><code>errors.Errorf(format,arg...)</code> / <code>errors.New(msg)</code></h3><p>我相信，业务异常中，大部分都是需要打印参数信息的，所以errorf 是很重要的！！</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Errorf</span><span class="params">(format <span class="keyword">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	err := &amp;Err&#123;message: fmt.Sprintf(format, args...)&#125;</span><br><span class="line">  err.SetLocation(<span class="number">1</span>) <span class="comment">// 记录堆栈信息，这里堆栈信息可以通过runtime.Caller(skip) 函数来拿，性能很高，如果skip值越小损耗性能越小</span></span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="errors-Trace-error"><a href="#errors-Trace-error" class="headerlink" title="errors.Trace(error)"></a><code>errors.Trace(error)</code></h3><p>如果你想函数传递过程中记录你这个error抛出的位置，记得调用<code>trace</code>方法！</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">findUserNameById</span><span class="params">(ctx context.Context, id <span class="keyword">uint64</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> id == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, errors.New(<span class="string">&quot;find err&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;success&quot;</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetUserInfo</span><span class="params">(ctx context.Context, id <span class="keyword">uint64</span>)</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span></span> &#123;</span><br><span class="line">	name, err := findUserNameById(ctx, id)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err <span class="comment">// 如果把errors.Trace(err)改成err，那么只会打印一层堆栈信息</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">		<span class="string">&quot;name&quot;</span>: name,</span><br><span class="line">	&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Users/dong/<span class="keyword">go</span>/code/github/errors-pck/errors/main.<span class="keyword">go</span>:<span class="number">11</span>: find err</span><br></pre></td></tr></table></figure>



<h3 id="errors-Annotate-error-msg"><a href="#errors-Annotate-error-msg" class="headerlink" title="errors.Annotate(error,msg)"></a><code>errors.Annotate(error,msg)</code></h3><p>如果我们向外抛出的时候，还想记录一些信息，那么很棒，这个方法就是！！！ 是不是很nice！</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetUserInfo</span><span class="params">(ctx context.Context, id <span class="keyword">uint64</span>)</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span></span> &#123;</span><br><span class="line">	name, err := findUserNameById(ctx, id)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.Annotate(err, <span class="string">&quot;我要记录一下&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">		<span class="string">&quot;name&quot;</span>: name,</span><br><span class="line">	&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/Users/dong/<span class="keyword">go</span>/code/github/errors-pck/errors/main.<span class="keyword">go</span>:<span class="number">11</span>: not fond user , user_id=<span class="number">0</span></span><br><span class="line">/Users/dong/<span class="keyword">go</span>/code/github/errors-pck/errors/main.<span class="keyword">go</span>:<span class="number">19</span>: 我要记录一下</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="Wrapf-error1-error2-format-args-Wrap-parent-new-error"><a href="#Wrapf-error1-error2-format-args-Wrap-parent-new-error" class="headerlink" title="Wrapf(error1, error2, format, args) , Wrap(parent, new) error"></a><code>Wrapf(error1, error2, format, args)</code> , <code>Wrap(parent, new) error</code></h3><p>wraper 的方式，我感觉使用场景并不多，所以并没有care到多少！</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetUserInfo</span><span class="params">(ctx context.Context, id <span class="keyword">uint64</span>)</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span></span> &#123;</span><br><span class="line">	name, err := findUserNameById(ctx, id)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.Wrapf(err, errors.New(<span class="string">&quot;GetUserInfo&quot;</span>), <span class="string">&quot;GetUserInfo&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">		<span class="string">&quot;name&quot;</span>: name,</span><br><span class="line">	&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/Users/dong/<span class="keyword">go</span>/code/github/errors-pck/errors/main.<span class="keyword">go</span>:<span class="number">23</span>: not fond user , user_id=<span class="number">0</span></span><br><span class="line">/Users/dong/<span class="keyword">go</span>/code/github/errors-pck/errors/main.<span class="keyword">go</span>:<span class="number">31</span>: GetUserInfo: GetUserInfo</span><br></pre></td></tr></table></figure>



<h3 id="errors-NewBadRequest-err-msg-和-errors-IsBadRequest-err"><a href="#errors-NewBadRequest-err-msg-和-errors-IsBadRequest-err" class="headerlink" title="errors.NewBadRequest(err,msg) 和 errors.IsBadRequest(err)"></a><code>errors.NewBadRequest(err,msg)</code> 和 <code>errors.IsBadRequest(err)</code></h3><blockquote>
<p>​    一些类型判断的函数，比如我异常类型又多个，需要判断，所以就需要这个。</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	request := errors.NewBadRequest(errors.Errorf(<span class="string">&quot;err&quot;</span>), <span class="string">&quot;111&quot;</span>)</span><br><span class="line">	fmt.Println(errors.IsBadRequest(request))</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> badRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	Err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBadRequest</span><span class="params">(err error, msg <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;badRequest&#123;wrap(err, msg, <span class="string">&quot;&quot;</span>)&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">IsBadRequest</span><span class="params">(err error)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	err = Cause(err) <span class="comment">// 找真正的error，cause我不理解这个函数的地位!</span></span><br><span class="line">	_, ok := err.(*badRequest)</span><br><span class="line">	<span class="keyword">return</span> ok</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="不怕传递空"><a href="#不怕传递空" class="headerlink" title="不怕传递空"></a><code>不怕传递空</code></h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	request := errors.NewBadRequest(<span class="literal">nil</span>, <span class="string">&quot;111&quot;</span>)</span><br><span class="line">	fmt.Println(errors.IsBadRequest(request)) <span class="comment">// 不会异常</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// /Users/dong/go/code/github/errors-pck/errors/main.go:64: 111</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>