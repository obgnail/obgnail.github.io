<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;第13章-Python建模库介绍&quot;&gt;&lt;a href=&quot;#第13章-Python建模库介绍&quot; class=&quot;headerlink&quot; title=&quot;第13章 Python建模库介绍&quot;&gt;&lt;/a&gt;第13章 Python建模库介绍&lt;/h1&gt;&lt;p&gt;本章会回顾⼀些pandas的特点，这有利于pandas数据规整和模型拟合和评分。然后简短介绍两个流⾏的建模⼯具，statsmodels和scikit-learn。"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>利用Python进行数据分析10_第13章_Python建模库介绍 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-none-link" href="/tags/Python/" rel="tag">Python</a></div><div class="post-time">2019-05-14</div></div></div><div class="container post-header"><h1>利用Python进行数据分析10_第13章_Python建模库介绍</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC13%E7%AB%A0-Python%E5%BB%BA%E6%A8%A1%E5%BA%93%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">第13章 Python建模库介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#13-1-pandas%E4%B8%8E%E6%A8%A1%E5%9E%8B%E4%BB%A3%E7%A0%81%E7%9A%84%E6%8E%A5%E2%BC%9D"><span class="toc-number">1.1.</span> <span class="toc-text">13.1 pandas与模型代码的接⼝</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-2-%E2%BD%A4Patsy%E5%88%9B%E5%BB%BA%E6%A8%A1%E5%9E%8B%E6%8F%8F%E8%BF%B0"><span class="toc-number">1.2.</span> <span class="toc-text">13.2 ⽤Patsy创建模型描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-3-statsmodels%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.3.</span> <span class="toc-text">13.3 statsmodels介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-4-scikit-learn%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.4.</span> <span class="toc-text">13.4 scikit-learn介绍</span></a></li></ol></li></ol></details></div><div class="container post-content"><h1 id="第13章-Python建模库介绍"><a href="#第13章-Python建模库介绍" class="headerlink" title="第13章 Python建模库介绍"></a>第13章 Python建模库介绍</h1><p>本章会回顾⼀些pandas的特点，这有利于pandas数据规整和模型拟合和评分。然后简短介绍两个流⾏的建模⼯具，statsmodels和scikit-learn。</p>
<h2 id="13-1-pandas与模型代码的接⼝"><a href="#13-1-pandas与模型代码的接⼝" class="headerlink" title="13.1 pandas与模型代码的接⼝"></a>13.1 pandas与模型代码的接⼝</h2><p>模型开发的通常⼯作流是使⽤pandas进⾏数据加载和清洗，然后切换到建模库进⾏建模。</p>
<p>pandas与其它分析库通常是靠NumPy的数组联系起来的。<br><strong>将DataFrame转换为NumPy数组，可以使⽤.values属性</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data = pd.DataFrame(&#123;</span><br><span class="line">    <span class="string">&#x27;x0&#x27;</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>],</span><br><span class="line">    <span class="string">&#x27;x1&#x27;</span>: [<span class="number">0.01</span>, -<span class="number">0.01</span>, <span class="number">0.25</span>, -<span class="number">4.1</span>, <span class="number">0.</span>],</span><br><span class="line">    <span class="string">&#x27;y&#x27;</span>: [-<span class="number">1.5</span>, <span class="number">0.</span>, <span class="number">3.6</span>, <span class="number">1.3</span>, -<span class="number">2.</span>]&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(data)</span><br><span class="line"><span class="comment">#    x0    x1    y</span></span><br><span class="line"><span class="comment"># 0   1  0.01 -1.5</span></span><br><span class="line"><span class="comment"># 1   2 -0.01  0.0</span></span><br><span class="line"><span class="comment"># 2   3  0.25  3.6</span></span><br><span class="line"><span class="comment"># 3   4 -4.10  1.3</span></span><br><span class="line"><span class="comment"># 4   5  0.00 -2.0</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(data.columns)</span><br><span class="line"><span class="comment"># Index([&#x27;x0&#x27;, &#x27;x1&#x27;, &#x27;y&#x27;], dtype=&#x27;object&#x27;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(data.values)</span><br><span class="line"><span class="comment"># [[ 1.    0.01 -1.5 ]</span></span><br><span class="line"><span class="comment">#  [ 2.   -0.01  0.  ]</span></span><br><span class="line"><span class="comment">#  [ 3.    0.25  3.6 ]</span></span><br><span class="line"><span class="comment">#  [ 4.   -4.1   1.3 ]</span></span><br><span class="line"><span class="comment">#  [ 5.    0.   -2.  ]]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用.values转为NumPy数组</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(data.values))</span><br><span class="line"><span class="comment"># &lt;class &#x27;numpy.ndarray&#x27;&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">model_cols = [<span class="string">&#x27;x0&#x27;</span>, <span class="string">&#x27;x1&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(data.loc[:, model_cols].values)</span><br><span class="line"><span class="comment"># [[ 1.    0.01]</span></span><br><span class="line"><span class="comment">#  [ 2.   -0.01]</span></span><br><span class="line"><span class="comment">#  [ 3.    0.25]</span></span><br><span class="line"><span class="comment">#  [ 4.   -4.1 ]</span></span><br><span class="line"><span class="comment">#  [ 5.    0.  ]]</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(data.loc[:, model_cols].values))</span><br><span class="line"><span class="comment"># &lt;class &#x27;numpy.ndarray&#x27;&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用DataFrame函数将NumPy数组转为DataFrame</span></span><br><span class="line">df2 = pd.DataFrame(data.values, columns=[<span class="string">&#x27;one&#x27;</span>, <span class="string">&#x27;two&#x27;</span>, <span class="string">&#x27;three&#x27;</span>])</span><br><span class="line"><span class="built_in">print</span>(df2)</span><br><span class="line"><span class="comment">#    one   two  three</span></span><br><span class="line"><span class="comment"># 0  1.0  0.01   -1.5</span></span><br><span class="line"><span class="comment"># 1  2.0 -0.01    0.0</span></span><br><span class="line"><span class="comment"># 2  3.0  0.25    3.6</span></span><br><span class="line"><span class="comment"># 3  4.0 -4.10    1.3</span></span><br><span class="line"><span class="comment"># 4  5.0  0.00   -2.0</span></span><br></pre></td></tr></table></figure>

<p>虚变量增加与删除:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data = pd.DataFrame(&#123;</span><br><span class="line">    <span class="string">&#x27;x0&#x27;</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>],</span><br><span class="line">    <span class="string">&#x27;x1&#x27;</span>: [<span class="number">0.01</span>, -<span class="number">0.01</span>, <span class="number">0.25</span>, -<span class="number">4.1</span>, <span class="number">0.</span>],</span><br><span class="line">    <span class="string">&#x27;y&#x27;</span>: [-<span class="number">1.5</span>, <span class="number">0.</span>, <span class="number">3.6</span>, <span class="number">1.3</span>, -<span class="number">2.</span>]&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># category列为非数值列</span></span><br><span class="line">data[<span class="string">&#x27;category&#x27;</span>] = pd.Categorical([<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>],categories=[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>])</span><br><span class="line"><span class="built_in">print</span>(data)</span><br><span class="line"><span class="comment">#    x0    x1    y category</span></span><br><span class="line"><span class="comment"># 0   1  0.01 -1.5        a</span></span><br><span class="line"><span class="comment"># 1   2 -0.01  0.0        b</span></span><br><span class="line"><span class="comment"># 2   3  0.25  3.6        a</span></span><br><span class="line"><span class="comment"># 3   4 -4.10  1.3        a</span></span><br><span class="line"><span class="comment"># 4   5  0.00 -2.0        b</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据category列创建虚变量</span></span><br><span class="line">dummies = pd.get_dummies(data.category, prefix=<span class="string">&#x27;category&#x27;</span>)</span><br><span class="line"><span class="comment"># 删除category列，然后添加虚变量</span></span><br><span class="line">data_with_dummies = data.drop(<span class="string">&#x27;category&#x27;</span>, axis=<span class="number">1</span>).join(dummies)</span><br><span class="line"><span class="built_in">print</span>(data_with_dummies)</span><br><span class="line"><span class="comment">#    x0    x1    y  category_a  category_b</span></span><br><span class="line"><span class="comment"># 0   1  0.01 -1.5           1           0</span></span><br><span class="line"><span class="comment"># 1   2 -0.01  0.0           0           1</span></span><br><span class="line"><span class="comment"># 2   3  0.25  3.6           1           0</span></span><br><span class="line"><span class="comment"># 3   4 -4.10  1.3           1           0</span></span><br><span class="line"><span class="comment"># 4   5  0.00 -2.0           0           1</span></span><br></pre></td></tr></table></figure>



<hr>
<h2 id="13-2-⽤Patsy创建模型描述"><a href="#13-2-⽤Patsy创建模型描述" class="headerlink" title="13.2 ⽤Patsy创建模型描述"></a>13.2 ⽤Patsy创建模型描述</h2><p>Patsy是Python的⼀个库，使⽤简短的字符串“公式语法”描述统计模型（尤其是线性模型）</p>
<p>Patsy适合描述statsmodels的线性模型，Patsy的公式是⼀个特殊的字符串语法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">y ~ x0 + x1</span><br></pre></td></tr></table></figure>

<p>y ~ x0 + x1被称为<code>公式字符串</code>.<br>a+b不是将a与b相加的意思，⽽是<strong>为模型创建的设计矩阵</strong>。</p>
<p>patsy.dmatrices函数接收⼀个<code>公式字符串</code>和⼀个<code>数据集</code>（可以是DataFrame或数组的字典），为线性模型创建设计矩阵：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> patsy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data = pd.DataFrame(&#123;</span><br><span class="line">    <span class="string">&#x27;x0&#x27;</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>],</span><br><span class="line">    <span class="string">&#x27;x1&#x27;</span>: [<span class="number">0.01</span>, -<span class="number">0.01</span>, <span class="number">0.25</span>, -<span class="number">4.1</span>, <span class="number">0.</span>],</span><br><span class="line">    <span class="string">&#x27;y&#x27;</span>: [-<span class="number">1.5</span>, <span class="number">0.</span>, <span class="number">3.6</span>, <span class="number">1.3</span>, -<span class="number">2.</span>]&#125;)</span><br><span class="line"><span class="built_in">print</span>(data)</span><br><span class="line"><span class="comment">#    x0    x1    y</span></span><br><span class="line"><span class="comment"># 0   1  0.01 -1.5</span></span><br><span class="line"><span class="comment"># 1   2 -0.01  0.0</span></span><br><span class="line"><span class="comment"># 2   3  0.25  3.6</span></span><br><span class="line"><span class="comment"># 3   4 -4.10  1.3</span></span><br><span class="line"><span class="comment"># 4   5  0.00 -2.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 为模型创建的设计矩阵</span></span><br><span class="line">y, X = patsy.dmatrices(<span class="string">&#x27;y ~ x0 + x1&#x27;</span>, data)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(y)</span><br><span class="line"><span class="comment"># DesignMatrix with shape (5, 1)</span></span><br><span class="line"><span class="comment">#      y</span></span><br><span class="line"><span class="comment">#   -1.5</span></span><br><span class="line"><span class="comment">#    0.0</span></span><br><span class="line"><span class="comment">#    3.6</span></span><br><span class="line"><span class="comment">#    1.3</span></span><br><span class="line"><span class="comment">#   -2.0</span></span><br><span class="line"><span class="comment">#   Terms:</span></span><br><span class="line"><span class="comment">#     &#x27;y&#x27; (column 0)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 有个Intercept列</span></span><br><span class="line"><span class="built_in">print</span>(X)</span><br><span class="line"><span class="comment"># DesignMatrix with shape (5, 3)</span></span><br><span class="line"><span class="comment">#   Intercept  x0     x1</span></span><br><span class="line"><span class="comment">#           1   1   0.01</span></span><br><span class="line"><span class="comment">#           1   2  -0.01</span></span><br><span class="line"><span class="comment">#           1   3   0.25</span></span><br><span class="line"><span class="comment">#           1   4  -4.10</span></span><br><span class="line"><span class="comment">#           1   5   0.00</span></span><br><span class="line"><span class="comment">#   Terms:</span></span><br><span class="line"><span class="comment">#     &#x27;Intercept&#x27; (column 0)</span></span><br><span class="line"><span class="comment">#     &#x27;x0&#x27; (column 1)</span></span><br><span class="line"><span class="comment">#     &#x27;x1&#x27; (column 2)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(y))</span><br><span class="line"><span class="comment"># &lt;class &#x27;patsy.design_info.DesignMatrix&#x27;&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(X))</span><br><span class="line"><span class="comment"># &lt;class &#x27;patsy.design_info.DesignMatrix&#x27;&gt;</span></span><br></pre></td></tr></table></figure>

<p>这些Patsy的DesignMatrix实例实际上是NumPy的<code>ndarray</code>，带有附加元数据：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 转为ndarray对象</span></span><br><span class="line"><span class="built_in">print</span>(np.asarray(y))</span><br><span class="line"><span class="comment"># [[-1.5]</span></span><br><span class="line"><span class="comment">#  [ 0. ]</span></span><br><span class="line"><span class="comment">#  [ 3.6]</span></span><br><span class="line"><span class="comment">#  [ 1.3]</span></span><br><span class="line"><span class="comment">#  [-2. ]]</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(np.asarray(X))</span><br><span class="line"><span class="comment"># [[ 1.    1.    0.01]</span></span><br><span class="line"><span class="comment">#  [ 1.    2.   -0.01]</span></span><br><span class="line"><span class="comment">#  [ 1.    3.    0.25]</span></span><br><span class="line"><span class="comment">#  [ 1.    4.   -4.1 ]</span></span><br><span class="line"><span class="comment">#  [ 1.    5.    0.  ]]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(np.asarray(y)))</span><br><span class="line"><span class="comment"># &lt;class &#x27;numpy.ndarray&#x27;&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(np.asarray(X)))</span><br><span class="line"><span class="comment"># &lt;class &#x27;numpy.ndarray&#x27;&gt;</span></span><br></pre></td></tr></table></figure>

<p>就像刚刚说的,X会出现一个Intercept列:<br>这是线性模型（⽐如普通最⼩⼆乘法）的惯例⽤法。添加 +0 到模型可以不显示intercept：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(patsy.dmatrices(<span class="string">&#x27;y ~ x0 + x1 + 0&#x27;</span>, data)[<span class="number">1</span>])</span><br><span class="line"><span class="comment"># DesignMatrix with shape (5, 2)</span></span><br><span class="line"><span class="comment">#   x0     x1</span></span><br><span class="line"><span class="comment">#    1   0.01</span></span><br><span class="line"><span class="comment">#    2  -0.01</span></span><br><span class="line"><span class="comment">#    3   0.25</span></span><br><span class="line"><span class="comment">#    4  -4.10</span></span><br><span class="line"><span class="comment">#    5   0.00</span></span><br><span class="line"><span class="comment">#   Terms:</span></span><br><span class="line"><span class="comment">#     &#x27;x0&#x27; (column 0)</span></span><br><span class="line"><span class="comment">#     &#x27;x1&#x27; (column 1)</span></span><br></pre></td></tr></table></figure>

<p>Patsy对象可以直接传递到算法（⽐如numpy.linalg.lstsq）中，它执⾏普通最⼩⼆乘回归.<br>模型的元数据保留在design_info属性中，因此你可以重新附加列名到拟合系数，以获得⼀个Series</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Patsy对象直接传递到算法</span></span><br><span class="line">coef, resid, _, _ = np.linalg.lstsq(X, y)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(coef)</span><br><span class="line"><span class="comment"># [[ 0.31290976]</span></span><br><span class="line"><span class="comment">#  [-0.07910564]</span></span><br><span class="line"><span class="comment">#  [-0.26546384]]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模型的元数据保留在design_info属性中，因此你可以重新附加列名到拟合系数，以获得⼀个Series</span></span><br><span class="line">coef = pd.Series(coef.squeeze(), index=X.design_info.column_names)</span><br><span class="line"><span class="built_in">print</span>(coef)</span><br><span class="line"><span class="comment"># Intercept    0.312910</span></span><br><span class="line"><span class="comment"># x0          -0.079106</span></span><br><span class="line"><span class="comment"># x1          -0.265464</span></span><br><span class="line"><span class="comment"># dtype: float64</span></span><br></pre></td></tr></table></figure>



<p>⽤Patsy公式进⾏数据转换</p>
<p>可以将Python代码与patsy公式结合</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> patsy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data = pd.DataFrame(&#123;</span><br><span class="line">    <span class="string">&#x27;x0&#x27;</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>],</span><br><span class="line">    <span class="string">&#x27;x1&#x27;</span>: [<span class="number">0.01</span>, -<span class="number">0.01</span>, <span class="number">0.25</span>, -<span class="number">4.1</span>, <span class="number">0.</span>],</span><br><span class="line">    <span class="string">&#x27;y&#x27;</span>: [-<span class="number">1.5</span>, <span class="number">0.</span>, <span class="number">3.6</span>, <span class="number">1.3</span>, -<span class="number">2.</span>]&#125;)</span><br><span class="line"><span class="built_in">print</span>(data)</span><br><span class="line"><span class="comment">#    x0    x1    y</span></span><br><span class="line"><span class="comment"># 0   1  0.01 -1.5</span></span><br><span class="line"><span class="comment"># 1   2 -0.01  0.0</span></span><br><span class="line"><span class="comment"># 2   3  0.25  3.6</span></span><br><span class="line"><span class="comment"># 3   4 -4.10  1.3</span></span><br><span class="line"><span class="comment"># 4   5  0.00 -2.0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将Python代码与patsy公式结合</span></span><br><span class="line">y, X = patsy.dmatrices(<span class="string">&#x27;y ~ x0 + np.log(np.abs(x1) + 1)&#x27;</span>, data)</span><br><span class="line"><span class="built_in">print</span>(X)</span><br><span class="line"><span class="comment"># DesignMatrix with shape (5, 3)</span></span><br><span class="line"><span class="comment">#   Intercept  x0  np.log(np.abs(x1) + 1)</span></span><br><span class="line"><span class="comment">#           1   1                 0.00995</span></span><br><span class="line"><span class="comment">#           1   2                 0.00995</span></span><br><span class="line"><span class="comment">#           1   3                 0.22314</span></span><br><span class="line"><span class="comment">#           1   4                 1.62924</span></span><br><span class="line"><span class="comment">#           1   5                 0.00000</span></span><br><span class="line"><span class="comment">#   Terms:</span></span><br><span class="line"><span class="comment">#     &#x27;Intercept&#x27; (column 0)</span></span><br><span class="line"><span class="comment">#     &#x27;x0&#x27; (column 1)</span></span><br><span class="line"><span class="comment">#     &#x27;np.log(np.abs(x1) + 1)&#x27; (column 2)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用Patsy的内置的函数</span></span><br><span class="line">y, X = patsy.dmatrices(<span class="string">&#x27;y ~ standardize(x0) + center(x1)&#x27;</span>, data)</span><br><span class="line"><span class="built_in">print</span>(X)</span><br><span class="line"><span class="comment"># DesignMatrix with shape (5, 3)</span></span><br><span class="line"><span class="comment">#   Intercept  standardize(x0)  center(x1)</span></span><br><span class="line"><span class="comment">#           1         -1.41421        0.78</span></span><br><span class="line"><span class="comment">#           1         -0.70711        0.76</span></span><br><span class="line"><span class="comment">#           1          0.00000        1.02</span></span><br><span class="line"><span class="comment">#           1          0.70711       -3.33</span></span><br><span class="line"><span class="comment">#           1          1.41421        0.77</span></span><br><span class="line"><span class="comment">#   Terms:</span></span><br><span class="line"><span class="comment">#     &#x27;Intercept&#x27; (column 0)</span></span><br><span class="line"><span class="comment">#     &#x27;standardize(x0)&#x27; (column 1)</span></span><br><span class="line"><span class="comment">#     &#x27;center(x1)&#x27; (column 2)</span></span><br></pre></td></tr></table></figure>

<p>patsy.build_design_matrices函数可以应⽤于转换新数据，使⽤原始样本数据集的保存信息：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">new_data = pd.DataFrame(&#123;</span><br><span class="line">    <span class="string">&#x27;x0&#x27;</span>: [<span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>],</span><br><span class="line">    <span class="string">&#x27;x1&#x27;</span>: [<span class="number">3.1</span>, -<span class="number">0.5</span>, <span class="number">0</span>, <span class="number">2.3</span>],</span><br><span class="line">    <span class="string">&#x27;y&#x27;</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]&#125;)</span><br><span class="line">new_X = patsy.build_design_matrices([X.design_info], new_data)</span><br><span class="line"><span class="built_in">print</span>(new_X)</span><br><span class="line"><span class="comment"># [DesignMatrix with shape (4, 3)</span></span><br><span class="line"><span class="comment"># Intercept  standardize(x0)  center(x1)</span></span><br><span class="line"><span class="comment">#         1          2.12132        3.87</span></span><br><span class="line"><span class="comment">#         1          2.82843        0.27</span></span><br><span class="line"><span class="comment">#         1          3.53553        0.77</span></span><br><span class="line"><span class="comment">#         1          4.24264        3.07</span></span><br><span class="line"><span class="comment"># Terms:</span></span><br><span class="line"><span class="comment"># &#x27;Intercept&#x27; (column 0), &#x27;standardize(x0)&#x27; (column 1), &#x27;center(x1)&#x27; (column 2)]</span></span><br></pre></td></tr></table></figure>

<p>因为Patsy中的加号不是加法的意义，当你按照名称将数据集的列相加时，你必须⽤特殊I函数将它们封装起来：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">y, X = patsy.dmatrices(<span class="string">&#x27;y ~ I(x0 + x1)&#x27;</span>, data)</span><br><span class="line"><span class="built_in">print</span>(X)</span><br><span class="line"><span class="comment"># DesignMatrix with shape (5, 2)</span></span><br><span class="line"><span class="comment">#   Intercept  I(x0 + x1)</span></span><br><span class="line"><span class="comment">#           1        1.01</span></span><br><span class="line"><span class="comment">#           1        1.99</span></span><br><span class="line"><span class="comment">#           1        3.25</span></span><br><span class="line"><span class="comment">#           1       -0.10</span></span><br><span class="line"><span class="comment">#           1        5.00</span></span><br><span class="line"><span class="comment">#   Terms:</span></span><br><span class="line"><span class="comment">#     &#x27;Intercept&#x27; (column 0)</span></span><br><span class="line"><span class="comment">#     &#x27;I(x0 + x1)&#x27; (column 1)</span></span><br></pre></td></tr></table></figure>



<p>分类数据和Patsy</p>
<p>当你在Patsy公式中使⽤⾮数值数据，它们会默认转换为虚变<br>量。<strong>如果有截距，会去掉⼀个，避免共线性</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> patsy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data = pd.DataFrame(&#123;</span><br><span class="line">    <span class="string">&#x27;key1&#x27;</span>: [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;key2&#x27;</span>: [<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">    <span class="string">&#x27;v1&#x27;</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>],</span><br><span class="line">    <span class="string">&#x27;v2&#x27;</span>: [-<span class="number">1</span>, <span class="number">0</span>, <span class="number">2.5</span>, -<span class="number">0.5</span>, <span class="number">4.0</span>, -<span class="number">1.2</span>, <span class="number">0.2</span>, -<span class="number">1.7</span>]</span><br><span class="line">&#125;)</span><br><span class="line">y, X = patsy.dmatrices(<span class="string">&#x27;v2 ~ key1&#x27;</span>, data)</span><br><span class="line"><span class="built_in">print</span>(X)</span><br><span class="line"><span class="comment"># DesignMatrix with shape (8, 2)</span></span><br><span class="line"><span class="comment">#   Intercept  key1[T.b]</span></span><br><span class="line"><span class="comment">#           1          0</span></span><br><span class="line"><span class="comment">#           1          0</span></span><br><span class="line"><span class="comment">#           1          1</span></span><br><span class="line"><span class="comment">#           1          1</span></span><br><span class="line"><span class="comment">#           1          0</span></span><br><span class="line"><span class="comment">#           1          1</span></span><br><span class="line"><span class="comment">#           1          0</span></span><br><span class="line"><span class="comment">#           1          1</span></span><br><span class="line"><span class="comment">#   Terms:</span></span><br><span class="line"><span class="comment">#     &#x27;Intercept&#x27; (column 0)</span></span><br><span class="line"><span class="comment">#     &#x27;key1&#x27; (column 1)</span></span><br></pre></td></tr></table></figure>

<p>如果从模型中忽略截距，每个分类值的列都会包括在设计矩阵的模型中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> patsy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data = pd.DataFrame(&#123;</span><br><span class="line">    <span class="string">&#x27;key1&#x27;</span>: [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;key2&#x27;</span>: [<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">    <span class="string">&#x27;v1&#x27;</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>],</span><br><span class="line">    <span class="string">&#x27;v2&#x27;</span>: [-<span class="number">1</span>, <span class="number">0</span>, <span class="number">2.5</span>, -<span class="number">0.5</span>, <span class="number">4.0</span>, -<span class="number">1.2</span>, <span class="number">0.2</span>, -<span class="number">1.7</span>]</span><br><span class="line">&#125;)</span><br><span class="line">y, X = patsy.dmatrices(<span class="string">&#x27;v2 ~ key1 + 0&#x27;</span>, data)</span><br><span class="line"><span class="built_in">print</span>(X)</span><br><span class="line"><span class="comment"># DesignMatrix with shape (8, 2)</span></span><br><span class="line"><span class="comment">#   key1[a]  key1[b]</span></span><br><span class="line"><span class="comment">#         1        0</span></span><br><span class="line"><span class="comment">#         1        0</span></span><br><span class="line"><span class="comment">#         0        1</span></span><br><span class="line"><span class="comment">#         0        1</span></span><br><span class="line"><span class="comment">#         1        0</span></span><br><span class="line"><span class="comment">#         0        1</span></span><br><span class="line"><span class="comment">#         1        0</span></span><br><span class="line"><span class="comment">#         0        1</span></span><br><span class="line"><span class="comment">#   Terms:</span></span><br><span class="line"><span class="comment">#     &#x27;key1&#x27; (columns 0:2)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使⽤C函数，数值列可以截取为分类量：</span></span><br><span class="line">y, X = patsy.dmatrices(<span class="string">&#x27;v2 ~ C(key2)&#x27;</span>, data)</span><br><span class="line"><span class="built_in">print</span>(X)</span><br><span class="line"><span class="comment"># DesignMatrix with shape (8, 2)</span></span><br><span class="line"><span class="comment">#   Intercept  C(key2)[T.1]</span></span><br><span class="line"><span class="comment">#           1             0</span></span><br><span class="line"><span class="comment">#           1             1</span></span><br><span class="line"><span class="comment">#           1             0</span></span><br><span class="line"><span class="comment">#           1             1</span></span><br><span class="line"><span class="comment">#           1             0</span></span><br><span class="line"><span class="comment">#           1             1</span></span><br><span class="line"><span class="comment">#           1             0</span></span><br><span class="line"><span class="comment">#           1             0</span></span><br><span class="line"><span class="comment">#   Terms:</span></span><br><span class="line"><span class="comment">#     &#x27;Intercept&#x27; (column 0)</span></span><br><span class="line"><span class="comment">#     &#x27;C(key2)&#x27; (column 1)</span></span><br></pre></td></tr></table></figure>

<p>当你在模型中使⽤多个分类名，事情就会变复杂，因为会包括key1:key2形式的相交部分，它可以⽤在⽅差（ANOVA）模型分析中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> patsy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data = pd.DataFrame(&#123;</span><br><span class="line">    <span class="string">&#x27;key1&#x27;</span>: [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;key2&#x27;</span>: [<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">    <span class="string">&#x27;v1&#x27;</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>],</span><br><span class="line">    <span class="string">&#x27;v2&#x27;</span>: [-<span class="number">1</span>, <span class="number">0</span>, <span class="number">2.5</span>, -<span class="number">0.5</span>, <span class="number">4.0</span>, -<span class="number">1.2</span>, <span class="number">0.2</span>, -<span class="number">1.7</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data[<span class="string">&#x27;key2&#x27;</span>] = data[<span class="string">&#x27;key2&#x27;</span>].<span class="built_in">map</span>(&#123;<span class="number">0</span>: <span class="string">&#x27;zero&#x27;</span>, <span class="number">1</span>: <span class="string">&#x27;one&#x27;</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(data)</span><br><span class="line"><span class="comment">#   key1  key2  v1   v2</span></span><br><span class="line"><span class="comment"># 0    a  zero   1 -1.0</span></span><br><span class="line"><span class="comment"># 1    a   one   2  0.0</span></span><br><span class="line"><span class="comment"># 2    b  zero   3  2.5</span></span><br><span class="line"><span class="comment"># 3    b   one   4 -0.5</span></span><br><span class="line"><span class="comment"># 4    a  zero   5  4.0</span></span><br><span class="line"><span class="comment"># 5    b   one   6 -1.2</span></span><br><span class="line"><span class="comment"># 6    a  zero   7  0.2</span></span><br><span class="line"><span class="comment"># 7    b  zero   8 -1.7</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">y, X = patsy.dmatrices(<span class="string">&#x27;v2 ~ key1 + key2&#x27;</span>, data)</span><br><span class="line"><span class="built_in">print</span>(X)</span><br><span class="line"><span class="comment"># DesignMatrix with shape (8, 3)</span></span><br><span class="line"><span class="comment">#   Intercept  key1[T.b]  key2[T.zero]</span></span><br><span class="line"><span class="comment">#           1          0             1</span></span><br><span class="line"><span class="comment">#           1          0             0</span></span><br><span class="line"><span class="comment">#           1          1             1</span></span><br><span class="line"><span class="comment">#           1          1             0</span></span><br><span class="line"><span class="comment">#           1          0             1</span></span><br><span class="line"><span class="comment">#           1          1             0</span></span><br><span class="line"><span class="comment">#           1          0             1</span></span><br><span class="line"><span class="comment">#           1          1             1</span></span><br><span class="line"><span class="comment">#   Terms:</span></span><br><span class="line"><span class="comment">#     &#x27;Intercept&#x27; (column 0)</span></span><br><span class="line"><span class="comment">#     &#x27;key1&#x27; (column 1)</span></span><br><span class="line"><span class="comment">#     &#x27;key2&#x27; (column 2)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">y, X = patsy.dmatrices(<span class="string">&#x27;v2 ~ key1 + key2 + key1:key2&#x27;</span>, data)</span><br><span class="line"><span class="built_in">print</span>(X)</span><br><span class="line"><span class="comment"># DesignMatrix with shape (8, 4)</span></span><br><span class="line"><span class="comment">#   Intercept  key1[T.b]  key2[T.zero]</span></span><br><span class="line"><span class="comment"># key1[T.b]:key2[T.zero]</span></span><br><span class="line"><span class="comment">#           1          0             1                       0</span></span><br><span class="line"><span class="comment">#           1          0             0                       0</span></span><br><span class="line"><span class="comment">#           1          1             1                       1</span></span><br><span class="line"><span class="comment">#           1          1             0                       0</span></span><br><span class="line"><span class="comment">#           1          0             1                       0</span></span><br><span class="line"><span class="comment">#           1          1             0                       0</span></span><br><span class="line"><span class="comment">#           1          0             1                       0</span></span><br><span class="line"><span class="comment">#           1          1             1                       1</span></span><br><span class="line"><span class="comment">#   Terms:</span></span><br><span class="line"><span class="comment">#     &#x27;Intercept&#x27; (column 0)</span></span><br><span class="line"><span class="comment">#     &#x27;key1&#x27; (column 1)</span></span><br><span class="line"><span class="comment">#     &#x27;key2&#x27; (column 2)</span></span><br><span class="line"><span class="comment">#     &#x27;key1:key2&#x27; (column 3)</span></span><br></pre></td></tr></table></figure>



<hr>
<h2 id="13-3-statsmodels介绍"><a href="#13-3-statsmodels介绍" class="headerlink" title="13.3 statsmodels介绍"></a>13.3 statsmodels介绍</h2><p>statsmodels是Python进⾏拟合多种统计模型、进⾏统计试验和数据探索可视化的库。Statsmodels包含许多经典的统计⽅法，但没有⻉叶斯⽅法和机器学习模型。</p>
<p>statsmodels包含的模型有：</p>
<ul>
<li>线性模型，⼴义线性模型和健壮线性模型</li>
<li>线性混合效应模型</li>
<li>⽅差（ANOVA）⽅法分析</li>
<li>时间序列过程和状态空间模型</li>
<li>⼴义矩估计</li>
</ul>
<p>估计线性模型</p>
<p>statsmodels的线性模型有两种不同的接⼝：基于数组，和基于公式。它们可以通过API模块引⼊：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> statsmodels.api <span class="keyword">as</span> sm</span><br><span class="line"><span class="keyword">import</span> statsmodels.formula.api <span class="keyword">as</span> smf</span><br></pre></td></tr></table></figure>

<p>使用:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> statsmodels.api <span class="keyword">as</span> sm</span><br><span class="line"><span class="keyword">import</span> statsmodels.formula.api <span class="keyword">as</span> smf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dnorm</span>(<span class="params">mean, variance, size=<span class="number">1</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(size, <span class="built_in">int</span>):</span><br><span class="line">        size = size,</span><br><span class="line">    <span class="keyword">return</span> mean + np.sqrt(variance) * np.random.randn(*size)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">np.random.seed(<span class="number">12345</span>)</span><br><span class="line"></span><br><span class="line">N = <span class="number">100</span></span><br><span class="line">X = np.c_[dnorm(<span class="number">0</span>, <span class="number">0.4</span>, size=N),</span><br><span class="line">          dnorm(<span class="number">0</span>, <span class="number">0.6</span>, size=N),</span><br><span class="line">          dnorm(<span class="number">0</span>, <span class="number">0.2</span>, size=N)]</span><br><span class="line">eps = dnorm(<span class="number">0</span>, <span class="number">0.1</span>, size=N)</span><br><span class="line">beta = [<span class="number">0.1</span>, <span class="number">0.3</span>, <span class="number">0.5</span>]</span><br><span class="line"></span><br><span class="line">y = np.dot(X, beta) + eps</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(X[:<span class="number">5</span>])</span><br><span class="line"><span class="comment"># [[-0.12946849 -1.21275292  0.50422488]</span></span><br><span class="line"><span class="comment">#  [ 0.30291036 -0.43574176 -0.25417986]</span></span><br><span class="line"><span class="comment">#  [-0.32852189 -0.02530153  0.13835097]</span></span><br><span class="line"><span class="comment">#  [-0.35147471 -0.71960511 -0.25821463]</span></span><br><span class="line"><span class="comment">#  [ 1.2432688  -0.37379916 -0.52262905]]</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(y[:<span class="number">5</span>])</span><br><span class="line"><span class="comment"># [ 0.42786349 -0.67348041 -0.09087764 -0.48949442 -0.12894109]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># sm.add_constant函数可以添加⼀个截距的列到现存的矩阵：</span></span><br><span class="line">X_model = sm.add_constant(X)</span><br><span class="line"><span class="built_in">print</span>(X_model[:<span class="number">5</span>])</span><br><span class="line"><span class="comment"># [[ 1.         -0.12946849 -1.21275292  0.50422488]</span></span><br><span class="line"><span class="comment">#  [ 1.          0.30291036 -0.43574176 -0.25417986]</span></span><br><span class="line"><span class="comment">#  [ 1.         -0.32852189 -0.02530153  0.13835097]</span></span><br><span class="line"><span class="comment">#  [ 1.         -0.35147471 -0.71960511 -0.25821463]</span></span><br><span class="line"><span class="comment">#  [ 1.          1.2432688  -0.37379916 -0.52262905]]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># sm.OLS类可以拟合⼀个普通最⼩⼆乘回归：</span></span><br><span class="line">model = sm.OLS(y, X)</span><br><span class="line"></span><br><span class="line"><span class="comment"># fit⽅法返回了⼀个回归结果对象，它包含估计的模型参数和其它内容：</span></span><br><span class="line">results = model.fit()</span><br><span class="line"><span class="built_in">print</span>(results.params)</span><br><span class="line"><span class="comment"># [0.17826108 0.22303962 0.50095093]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对结果使⽤summary⽅法可以打印模型的详细诊断结果：</span></span><br><span class="line"><span class="built_in">print</span>(results.summary())</span><br><span class="line"><span class="comment">#                             OLS Regression Results                            </span></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line"><span class="comment"># Dep. Variable:                      y   R-squared:                       0.430</span></span><br><span class="line"><span class="comment"># Model:                            OLS   Adj. R-squared:                  0.413</span></span><br><span class="line"><span class="comment"># Method:                 Least Squares   F-statistic:                     24.42</span></span><br><span class="line"><span class="comment"># Date:                Tue, 14 May 2019   Prob (F-statistic):           7.44e-12</span></span><br><span class="line"><span class="comment"># Time:                        17:12:00   Log-Likelihood:                -34.305</span></span><br><span class="line"><span class="comment"># No. Observations:                 100   AIC:                             74.61</span></span><br><span class="line"><span class="comment"># Df Residuals:                      97   BIC:                             82.42</span></span><br><span class="line"><span class="comment"># Df Model:                           3                                         </span></span><br><span class="line"><span class="comment"># Covariance Type:            nonrobust                                         </span></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line"><span class="comment">#                  coef    std err          t      P&gt;|t|      [0.025      0.975]</span></span><br><span class="line"><span class="comment"># ------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># x1             0.1783      0.053      3.364      0.001       0.073       0.283</span></span><br><span class="line"><span class="comment"># x2             0.2230      0.046      4.818      0.000       0.131       0.315</span></span><br><span class="line"><span class="comment"># x3             0.5010      0.080      6.237      0.000       0.342       0.660</span></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line"><span class="comment"># Omnibus:                        4.662   Durbin-Watson:                   2.201</span></span><br><span class="line"><span class="comment"># Prob(Omnibus):                  0.097   Jarque-Bera (JB):                4.098</span></span><br><span class="line"><span class="comment"># Skew:                           0.481   Prob(JB):                        0.129</span></span><br><span class="line"><span class="comment"># Kurtosis:                       3.243   Cond. No.                         1.74</span></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line"><span class="comment"># Warnings:</span></span><br><span class="line"><span class="comment"># [1]	Standard	Errors	assume	that	the	covariance	matrix	of	the	errors	is	correctly	</span></span><br><span class="line"><span class="comment"># specified.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data = pd.DataFrame(X, columns=[<span class="string">&#x27;col0&#x27;</span>, <span class="string">&#x27;col1&#x27;</span>, <span class="string">&#x27;col2&#x27;</span>])</span><br><span class="line">data[<span class="string">&#x27;y&#x27;</span>] = y</span><br><span class="line"><span class="built_in">print</span>(data[:<span class="number">5</span>])</span><br><span class="line"><span class="comment">#        col0      col1      col2         y</span></span><br><span class="line"><span class="comment"># 0 -0.129468 -1.212753  0.504225  0.427863</span></span><br><span class="line"><span class="comment"># 1  0.302910 -0.435742 -0.254180 -0.673480</span></span><br><span class="line"><span class="comment"># 2 -0.328522 -0.025302  0.138351 -0.090878</span></span><br><span class="line"><span class="comment"># 3 -0.351475 -0.719605 -0.258215 -0.489494</span></span><br><span class="line"><span class="comment"># 4  1.243269 -0.373799 -0.522629 -0.128941</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使⽤statsmodels的公式API和Patsy的公式字符串：</span></span><br><span class="line">results = smf.ols(<span class="string">&#x27;y ~ col0 + col1 + col2&#x27;</span>, data=data).fit()</span><br><span class="line"><span class="built_in">print</span>(results.params)</span><br><span class="line"><span class="comment"># Intercept    0.033559</span></span><br><span class="line"><span class="comment"># col0         0.176149</span></span><br><span class="line"><span class="comment"># col1         0.224826</span></span><br><span class="line"><span class="comment"># col2         0.514808</span></span><br><span class="line"><span class="comment"># dtype: float64</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(results.tvalues)</span><br><span class="line"><span class="comment"># Intercept    0.952188</span></span><br><span class="line"><span class="comment"># col0         3.319754</span></span><br><span class="line"><span class="comment"># col1         4.850730</span></span><br><span class="line"><span class="comment"># col2         6.303971</span></span><br><span class="line"><span class="comment"># dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 给出⼀个样本外数据，可以根据估计的模型参数计算预测值：</span></span><br><span class="line"><span class="built_in">print</span>(results.predict(data[:<span class="number">5</span>]))</span><br><span class="line"><span class="comment"># 0   -0.002327</span></span><br><span class="line"><span class="comment"># 1   -0.141904</span></span><br><span class="line"><span class="comment"># 2    0.041226</span></span><br><span class="line"><span class="comment"># 3   -0.323070</span></span><br><span class="line"><span class="comment"># 4   -0.100535</span></span><br><span class="line"><span class="comment"># dtype: float64</span></span><br></pre></td></tr></table></figure>



<p>估计时间序列过程</p>
<p>statsmodels的另⼀模型类是进⾏时间序列分析，包括⾃回归过程、卡尔曼滤波和其它态空间模型，和多元⾃回归模型。</p>
<p>⽤⾃回归结构和噪声来模拟⼀些时间序列数据：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> statsmodels.api <span class="keyword">as</span> sm</span><br><span class="line"><span class="keyword">import</span> statsmodels.formula.api <span class="keyword">as</span> smf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dnorm</span>(<span class="params">mean, variance, size=<span class="number">1</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(size, <span class="built_in">int</span>):</span><br><span class="line">        size = size,</span><br><span class="line">    <span class="keyword">return</span> mean + np.sqrt(variance) * np.random.randn(*size)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">np.random.seed(<span class="number">12345</span>)</span><br><span class="line">init_x = <span class="number">4</span></span><br><span class="line">values = [init_x, init_x]</span><br><span class="line">N = <span class="number">1000</span></span><br><span class="line"></span><br><span class="line">b0 = <span class="number">0.8</span></span><br><span class="line">b1 = -<span class="number">0.4</span></span><br><span class="line">noise = dnorm(<span class="number">0</span>, <span class="number">0.1</span>, N)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(N):</span><br><span class="line">    new_x = values[-<span class="number">1</span>] * b0 + values[-<span class="number">2</span>] * b1 + noise[i]</span><br><span class="line">    values.append(new_x)</span><br><span class="line"></span><br><span class="line">MAXLAGS = <span class="number">5</span></span><br><span class="line">model = sm.tsa.AR(values)</span><br><span class="line">results = model.fit(MAXLAGS)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果中的估计参数⾸先是截距，其次是前两个参数的估计值</span></span><br><span class="line"><span class="built_in">print</span>(results.params)</span><br><span class="line"><span class="comment"># [-0.0008394   0.7990018  -0.41539155 -0.00639167 -0.00286703  0.01663687]</span></span><br></pre></td></tr></table></figure>



<hr>
<h2 id="13-4-scikit-learn介绍"><a href="#13-4-scikit-learn介绍" class="headerlink" title="13.4 scikit-learn介绍"></a>13.4 scikit-learn介绍</h2><p>scikit-learn是⼀个⼴泛使⽤、⽤途多样的Python机器学习库。<br>它包含多种标准监督和⾮监督机器学习⽅法和模型选择和评估、数据转换、数据加载和模型持久化⼯具。<br>这些模型可以⽤于分类、聚合、预测和其它任务。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">train = pd.read_csv(<span class="string">&#x27;datasets/titanic/train.csv&#x27;</span>)</span><br><span class="line">test = pd.read_csv(<span class="string">&#x27;datasets/titanic/test.csv&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(train[:<span class="number">4</span>])</span><br><span class="line"><span class="comment">#    PassengerId  Survived  Pclass    ...        Fare Cabin  Embarked</span></span><br><span class="line"><span class="comment"># 0            1         0       3    ...      7.2500   NaN         S</span></span><br><span class="line"><span class="comment"># 1            2         1       1    ...     71.2833   C85         C</span></span><br><span class="line"><span class="comment"># 2            3         1       3    ...      7.9250   NaN         S</span></span><br><span class="line"><span class="comment"># 3            4         1       1    ...     53.1000  C123         S</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [4 rows x 12 columns]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># statsmodels和scikit-learn不能接收缺失数据，因此要查看列是否包含缺失值：</span></span><br><span class="line"><span class="built_in">print</span>(train.isnull().<span class="built_in">sum</span>())</span><br><span class="line"><span class="comment"># PassengerId      0</span></span><br><span class="line"><span class="comment"># Survived         0</span></span><br><span class="line"><span class="comment"># Pclass           0</span></span><br><span class="line"><span class="comment"># Name             0</span></span><br><span class="line"><span class="comment"># Sex              0</span></span><br><span class="line"><span class="comment"># Age            177</span></span><br><span class="line"><span class="comment"># SibSp            0</span></span><br><span class="line"><span class="comment"># Parch            0</span></span><br><span class="line"><span class="comment"># Ticket           0</span></span><br><span class="line"><span class="comment"># Fare             0</span></span><br><span class="line"><span class="comment"># Cabin          687</span></span><br><span class="line"><span class="comment"># Embarked         2</span></span><br><span class="line"><span class="comment"># dtype: int64</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(test.isnull().<span class="built_in">sum</span>())</span><br><span class="line"><span class="comment"># PassengerId      0</span></span><br><span class="line"><span class="comment"># Pclass           0</span></span><br><span class="line"><span class="comment"># Name             0</span></span><br><span class="line"><span class="comment"># Sex              0</span></span><br><span class="line"><span class="comment"># Age             86</span></span><br><span class="line"><span class="comment"># SibSp            0</span></span><br><span class="line"><span class="comment"># Parch            0</span></span><br><span class="line"><span class="comment"># Ticket           0</span></span><br><span class="line"><span class="comment"># Fare             1</span></span><br><span class="line"><span class="comment"># Cabin          327</span></span><br><span class="line"><span class="comment"># Embarked         0</span></span><br><span class="line"><span class="comment"># dtype: int64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 现在想用年龄作为预测值，但是它包含缺失值。</span></span><br><span class="line"><span class="comment"># ⽤训练数据集的中位数补全两个表的空值：</span></span><br><span class="line">impute_value = train[<span class="string">&#x27;Age&#x27;</span>].median()</span><br><span class="line">train[<span class="string">&#x27;Age&#x27;</span>] = train[<span class="string">&#x27;Age&#x27;</span>].fillna(impute_value)</span><br><span class="line">test[<span class="string">&#x27;Age&#x27;</span>] = test[<span class="string">&#x27;Age&#x27;</span>].fillna(impute_value)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 现在需要指定模型。增加了⼀个列IsFemale，作为“Sex”列的编码</span></span><br><span class="line">train[<span class="string">&#x27;IsFemale&#x27;</span>] = (train[<span class="string">&#x27;Sex&#x27;</span>] == <span class="string">&#x27;female&#x27;</span>).astype(<span class="built_in">int</span>)</span><br><span class="line">test[<span class="string">&#x27;IsFemale&#x27;</span>] = (test[<span class="string">&#x27;Sex&#x27;</span>] == <span class="string">&#x27;female&#x27;</span>).astype(<span class="built_in">int</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 确定模型变量，并创建NumPy数组：</span></span><br><span class="line">predictors = [<span class="string">&#x27;Pclass&#x27;</span>, <span class="string">&#x27;IsFemale&#x27;</span>, <span class="string">&#x27;Age&#x27;</span>]</span><br><span class="line">X_train = train[predictors].values</span><br><span class="line">X_test = test[predictors].values</span><br><span class="line">y_train = train[<span class="string">&#x27;Survived&#x27;</span>].values</span><br><span class="line"><span class="built_in">print</span>(X_train[:<span class="number">5</span>])</span><br><span class="line"><span class="comment"># [[ 3.  0. 22.]</span></span><br><span class="line"><span class="comment">#  [ 1.  1. 38.]</span></span><br><span class="line"><span class="comment">#  [ 3.  1. 26.]</span></span><br><span class="line"><span class="comment">#  [ 1.  1. 35.]</span></span><br><span class="line"><span class="comment">#  [ 3.  0. 35.]]</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(y_train[:<span class="number">5</span>])</span><br><span class="line"><span class="comment"># [0 1 1 1 0]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LogisticRegression</span><br><span class="line"><span class="comment"># scikitlearn的LogisticRegression模型，创建⼀个模型实例：</span></span><br><span class="line">model = LogisticRegression()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 与statsmodels类似，我们可以⽤模型的fit⽅法，将它拟合到训练数据：</span></span><br><span class="line"><span class="built_in">print</span>(model.fit(X_train, y_train))</span><br><span class="line"><span class="comment"># LogisticRegression(C=1.0, class_weight=None, dual=False, fit_intercept=True,</span></span><br><span class="line"><span class="comment">#           intercept_scaling=1, max_iter=100, multi_class=&#x27;ovr&#x27;, n_jobs=1,</span></span><br><span class="line"><span class="comment">#           penalty=&#x27;l2&#x27;, random_state=None, solver=&#x27;liblinear&#x27;, tol=0.0001,</span></span><br><span class="line"><span class="comment">#           verbose=0, warm_start=False)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ⽤model.predict，对测试数据进⾏预测：</span></span><br><span class="line">y_predict = model.predict(X_test)</span><br><span class="line"><span class="built_in">print</span>(y_predict[:<span class="number">10</span>])</span><br><span class="line"><span class="comment"># [0 0 0 0 1 0 1 0 1 0]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># logisticregressioncv类可以⽤⼀个参数指定⽹格搜索对模型的正则化参数C的粒度：</span></span><br><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LogisticRegressionCV</span><br><span class="line">model_cv = LogisticRegressionCV(<span class="number">10</span>)</span><br><span class="line"><span class="built_in">print</span>(model_cv.fit(X_train, y_train))</span><br><span class="line"><span class="comment"># LogisticRegressionCV(Cs=10, class_weight=None, cv=None, dual=False,</span></span><br><span class="line"><span class="comment">#            fit_intercept=True, intercept_scaling=1.0, max_iter=100,</span></span><br><span class="line"><span class="comment">#            multi_class=&#x27;ovr&#x27;, n_jobs=1, penalty=&#x27;l2&#x27;, random_state=None,</span></span><br><span class="line"><span class="comment">#            refit=True, scoring=None, solver=&#x27;lbfgs&#x27;, tol=0.0001, verbose=0)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 要⼿动进⾏交叉验证，可以使⽤cross_val_score帮助函数</span></span><br><span class="line"><span class="comment"># 它可以处理数据分割。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 交叉验证我们的带有四个不重叠训练数据的模型</span></span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> cross_val_score</span><br><span class="line">model = LogisticRegression(C=<span class="number">10</span>)</span><br><span class="line">scores = cross_val_score(model, X_train, y_train, cv=<span class="number">4</span>)</span><br><span class="line"><span class="built_in">print</span>(scores)</span><br><span class="line"><span class="comment"># [0.77232143 0.80269058 0.77027027 0.78828829]</span></span><br></pre></td></tr></table></figure>





</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>