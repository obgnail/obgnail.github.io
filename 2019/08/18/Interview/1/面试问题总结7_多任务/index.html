<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;进程与线程&quot;&gt;&lt;a href=&quot;#进程与线程&quot; class=&quot;headerlink&quot; title=&quot;进程与线程&quot;&gt;&lt;/a&gt;进程与线程&lt;/h2&gt;&lt;h3 id=&quot;使用多线程&quot;&gt;&lt;a href=&quot;#使用多线程&quot; class=&quot;headerlink&quot; title=&quot;使用多线程&quot;&gt;&lt;/a&gt;使用多线程&lt;/h3&gt;&lt;h4 id=&quot;继承Thread类&quot;&gt;&lt;a href=&quot;#继承Thread类&quot; class=&quot;headerlink&quot; title=&quot;继承Thread类&quot;&gt;&lt;/a&gt;继承Thread类&lt;/h4&gt;&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; time&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; threading &lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; Thread&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;thread1&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;Thread&lt;/span&gt;):&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;run&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;self&lt;/span&gt;):&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;True&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;------------&amp;#x27;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            time.sleep(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; each &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;range&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    thread1().start()&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h4 id=&quot;直接使用Thread类&quot;&gt;&lt;a href=&quot;#直接使用Thread类&quot; class=&quot;headerlink&quot; title=&quot;直接使用Thread类&quot;&gt;&lt;/a&gt;直接使用Thread类&lt;/h4&gt;&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; time&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; threading &lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; Thread&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;func&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;num&lt;/span&gt;):&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;True&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;print&lt;/span&gt;(num)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        num += &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        time.sleep(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;t = Thread(target=func,args=(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;,))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;t.start()&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h4 id=&quot;使用ThreadPoolExecutor&quot;&gt;&lt;a href=&quot;#使用ThreadPoolExecutor&quot; class=&quot;headerlink&quot; title=&quot;使用ThreadPoolExecutor&quot;&gt;&lt;/a&gt;使用ThreadPoolExecutor&lt;/h4&gt;&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; time&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; threading&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; concurrent.futures &lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; ThreadPoolExecutor&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;func&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;num&lt;/span&gt;):&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;#x27;---&amp;#x27;&lt;/span&gt;,num)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    time.sleep(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; __name__ == &lt;span class=&quot;string&quot;&gt;&amp;#x27;__main__&amp;#x27;&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;with&lt;/span&gt; ThreadPoolExecutor(&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;as&lt;/span&gt; e:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        e.&lt;span class=&quot;built_in&quot;&gt;map&lt;/span&gt;(func,&lt;span class=&quot;built_in&quot;&gt;range&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;









&lt;h3 id=&quot;使用多进程&quot;&gt;&lt;a href=&quot;#使用多进程&quot; class=&quot;headerlink&quot; title=&quot;使用多进程&quot;&gt;&lt;/a&gt;使用多进程&lt;/h3&gt;&lt;h4 id=&quot;使用Process类&quot;&gt;&lt;a href=&quot;#使用Process类&quot; class=&quot;headerlink&quot; title=&quot;使用Process类&quot;&gt;&lt;/a&gt;使用Process类&lt;/h4&gt;&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; time&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; multiprocessing &lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; Process&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;func&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;num&lt;/span&gt;):&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; n &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;range&lt;/span&gt;(num):&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;built_in&quot;&gt;print&lt;/span&gt;(n)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		time.sleep(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; each &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;range&lt;/span&gt;(&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;):&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Process(target=func,args=(each,)).start()	&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h4 id=&quot;使用Pool&quot;&gt;&lt;a href=&quot;#使用Pool&quot; class=&quot;headerlink&quot; title=&quot;使用Pool&quot;&gt;&lt;/a&gt;使用Pool&lt;/h4&gt;&lt;blockquote&gt;
&lt;p&gt;注意 : 必须将它放在&lt;code&gt;if __name__ == &amp;#39;__main__&amp;#39;:&lt;/code&gt;中"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>面试问题总结7_多任务 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Interview/" rel="tag">Interview</a></div><div class="post-time">2019-08-18</div></div></div><div class="container post-header"><h1>面试问题总结7_多任务</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">进程与线程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%A4%9A%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.1.</span> <span class="toc-text">使用多线程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%A7%E6%89%BFThread%E7%B1%BB"><span class="toc-number">1.1.1.</span> <span class="toc-text">继承Thread类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8Thread%E7%B1%BB"><span class="toc-number">1.1.2.</span> <span class="toc-text">直接使用Thread类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8ThreadPoolExecutor"><span class="toc-number">1.1.3.</span> <span class="toc-text">使用ThreadPoolExecutor</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%A4%9A%E8%BF%9B%E7%A8%8B"><span class="toc-number">1.2.</span> <span class="toc-text">使用多进程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Process%E7%B1%BB"><span class="toc-number">1.2.1.</span> <span class="toc-text">使用Process类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Pool"><span class="toc-number">1.2.2.</span> <span class="toc-text">使用Pool</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Queue"><span class="toc-number">1.2.3.</span> <span class="toc-text">使用Queue</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E9%99%90%E5%88%B6"><span class="toc-number">1.3.</span> <span class="toc-text">线程限制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA%E8%B5%84%E6%BA%90%E6%8A%A2%E5%8D%A0%E7%9A%84%E5%A4%9A%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.3.1.</span> <span class="toc-text">编写一个资源抢占的多线程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Lock"><span class="toc-number">1.3.2.</span> <span class="toc-text">使用Lock</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8RLock"><span class="toc-number">1.4.</span> <span class="toc-text">使用RLock</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8ThreadLocal"><span class="toc-number">1.4.1.</span> <span class="toc-text">使用ThreadLocal</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Semaphore"><span class="toc-number">1.4.2.</span> <span class="toc-text">使用Semaphore</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Barrier"><span class="toc-number">1.4.3.</span> <span class="toc-text">使用Barrier</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Timer"><span class="toc-number">1.4.4.</span> <span class="toc-text">使用Timer</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E9%80%9A%E8%AE%AF"><span class="toc-number">1.5.</span> <span class="toc-text">线程通讯</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Event"><span class="toc-number">1.5.1.</span> <span class="toc-text">使用Event</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Condition"><span class="toc-number">1.5.2.</span> <span class="toc-text">使用Condition</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.6.</span> <span class="toc-text">多任务的最佳实践</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%8F%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">协程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#asyncio%E7%9A%84%E7%BB%84%E4%BB%B6"><span class="toc-number">2.1.</span> <span class="toc-text">asyncio的组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%A0%E5%85%A5loop%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">2.2.</span> <span class="toc-text">传入loop的方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E4%BC%A0%E5%85%A5%E5%8D%8F%E7%A8%8B"><span class="toc-number">2.2.1.</span> <span class="toc-text">直接传入协程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8asyncio-wait%E4%BC%A0%E5%85%A5%E5%8D%8F%E7%A8%8B%E5%88%97%E8%A1%A8"><span class="toc-number">2.2.2.</span> <span class="toc-text">使用asyncio.wait传入协程列表</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8asyncio-gather%E4%BC%A0%E5%85%A5%E5%8D%8F%E7%A8%8B"><span class="toc-number">2.3.</span> <span class="toc-text">使用asyncio.gather传入协程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#task"><span class="toc-number">2.4.</span> <span class="toc-text">task</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAtask%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%96%B9%E6%B3%95"><span class="toc-number">2.4.1.</span> <span class="toc-text">创建task的两种方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#task%E7%BB%91%E5%AE%9A%E5%9B%9E%E8%B0%83"><span class="toc-number">2.4.2.</span> <span class="toc-text">task绑定回调</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#task%E8%8E%B7%E5%8F%96%E7%BB%93%E6%9E%9C"><span class="toc-number">2.5.</span> <span class="toc-text">task获取结果</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8task-result"><span class="toc-number">2.5.1.</span> <span class="toc-text">使用task.result()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8asyncio-wait-tasks"><span class="toc-number">2.5.2.</span> <span class="toc-text">使用asyncio.wait(tasks)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#asyncio-get-event-looloop-run-until-completep%E9%85%8D%E5%90%88asyncio-gather"><span class="toc-number">2.5.3.</span> <span class="toc-text">asyncio.get_event_looloop.run_until_completep配合asyncio.gather</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#loop-run-until-complete%E9%85%8D%E5%90%88asyncio-wait"><span class="toc-number">2.5.4.</span> <span class="toc-text">loop.run_until_complete配合asyncio.wait</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#asyncio%E7%9A%84as-completed%E6%96%B9%E6%B3%95"><span class="toc-number">2.5.5.</span> <span class="toc-text">asyncio的as_completed方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E6%B3%A8%E5%86%8C%E5%8D%8F%E7%A8%8B"><span class="toc-number">2.6.</span> <span class="toc-text">动态注册协程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5"><span class="toc-number">2.6.1.</span> <span class="toc-text">同步</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5"><span class="toc-number">2.6.2.</span> <span class="toc-text">异步</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#async-with-%E5%92%8Casync-for"><span class="toc-number">2.7.</span> <span class="toc-text">async with 和async for</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#async-with"><span class="toc-number">2.7.1.</span> <span class="toc-text">async with</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#async-for"><span class="toc-number">2.7.2.</span> <span class="toc-text">async for</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#loop-stop%E6%9A%82%E5%81%9C%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF"><span class="toc-number">2.8.</span> <span class="toc-text">loop.stop暂停事件循环</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E6%99%AE%E9%80%9A%E5%87%BD%E6%95%B0%E4%BD%9C%E4%B8%BA%E4%BB%BB%E5%8A%A1%E6%B3%A8%E5%85%A5%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E7%9A%84%E4%B8%89%E7%A7%8D%E6%96%B9%E6%B3%95"><span class="toc-number">2.9.</span> <span class="toc-text">将普通函数作为任务注入事件循环的三种方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#loop-call-soon"><span class="toc-number">2.9.1.</span> <span class="toc-text">loop.call_soon</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#loop-call-later"><span class="toc-number">2.9.2.</span> <span class="toc-text">loop.call_later</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#loop-call-at-amp-loop-time"><span class="toc-number">2.9.3.</span> <span class="toc-text">loop.call_at &amp; loop.time</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%8F%E7%A8%8B%E7%9A%84%E9%80%9A%E8%AE%AF%E6%96%B9%E6%B3%95"><span class="toc-number">2.10.</span> <span class="toc-text">协程的通讯方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#asyncio-lock"><span class="toc-number">2.10.1.</span> <span class="toc-text">asyncio.lock</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#asyncio-Event"><span class="toc-number">2.10.2.</span> <span class="toc-text">asyncio.Event</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#asyncio-condition"><span class="toc-number">2.10.3.</span> <span class="toc-text">asyncio.condition</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#asyncio-Queue"><span class="toc-number">2.10.4.</span> <span class="toc-text">asyncio.Queue</span></a></li></ol></li></ol></li></ol></details></div><div class="container post-content"><h2 id="进程与线程"><a href="#进程与线程" class="headerlink" title="进程与线程"></a>进程与线程</h2><h3 id="使用多线程"><a href="#使用多线程" class="headerlink" title="使用多线程"></a>使用多线程</h3><h4 id="继承Thread类"><a href="#继承Thread类" class="headerlink" title="继承Thread类"></a>继承Thread类</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">thread1</span>(<span class="params">Thread</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;------------&#x27;</span>)</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> each <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    thread1().start()</span><br></pre></td></tr></table></figure>

<h4 id="直接使用Thread类"><a href="#直接使用Thread类" class="headerlink" title="直接使用Thread类"></a>直接使用Thread类</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">num</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="built_in">print</span>(num)</span><br><span class="line">        num += <span class="number">1</span></span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">t = Thread(target=func,args=(<span class="number">1</span>,))</span><br><span class="line">t.start()</span><br></pre></td></tr></table></figure>

<h4 id="使用ThreadPoolExecutor"><a href="#使用ThreadPoolExecutor" class="headerlink" title="使用ThreadPoolExecutor"></a>使用ThreadPoolExecutor</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">num</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;---&#x27;</span>,num)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(<span class="number">3</span>) <span class="keyword">as</span> e:</span><br><span class="line">        e.<span class="built_in">map</span>(func,<span class="built_in">range</span>(<span class="number">10</span>))</span><br></pre></td></tr></table></figure>









<h3 id="使用多进程"><a href="#使用多进程" class="headerlink" title="使用多进程"></a>使用多进程</h3><h4 id="使用Process类"><a href="#使用Process类" class="headerlink" title="使用Process类"></a>使用Process类</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">num</span>):</span></span><br><span class="line">	<span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(num):</span><br><span class="line">		<span class="built_in">print</span>(n)</span><br><span class="line">		time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> each <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">	Process(target=func,args=(each,)).start()	</span><br></pre></td></tr></table></figure>

<h4 id="使用Pool"><a href="#使用Pool" class="headerlink" title="使用Pool"></a>使用Pool</h4><blockquote>
<p>注意 : 必须将它放在<code>if __name__ == &#39;__main__&#39;:</code>中</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">num</span>):</span></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(num):</span><br><span class="line">        <span class="built_in">print</span>(n)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    p = Pool(<span class="number">10</span>)</span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        p.apply_async(func,args=(n,))</span><br><span class="line"></span><br><span class="line">    p.close()</span><br><span class="line">    p.join()</span><br></pre></td></tr></table></figure>





<h4 id="使用Queue"><a href="#使用Queue" class="headerlink" title="使用Queue"></a>使用Queue</h4><blockquote>
<p>注意同样要使用<code>if __name__ == &#39;__main__&#39;:</code></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process,Queue</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span>(<span class="params">q</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        res = q.get()</span><br><span class="line">        <span class="built_in">print</span>(res)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span>(<span class="params">q</span>):</span></span><br><span class="line">    num = <span class="number">0</span> </span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        num += <span class="number">1</span></span><br><span class="line">        q.put(num)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    q = Queue()</span><br><span class="line">    r = Process(target=read,args=(q,))</span><br><span class="line">    w = Process(target=write,args=(q,))</span><br><span class="line"></span><br><span class="line">    w.start()</span><br><span class="line">    r.start()</span><br><span class="line"></span><br><span class="line">    time.sleep(<span class="number">5</span>)</span><br><span class="line">    <span class="comment"># 强制结束</span></span><br><span class="line">    r.terminate()</span><br><span class="line">    w.terminate()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;强制结束&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h3 id="线程限制"><a href="#线程限制" class="headerlink" title="线程限制"></a>线程限制</h3><h4 id="编写一个资源抢占的多线程"><a href="#编写一个资源抢占的多线程" class="headerlink" title="编写一个资源抢占的多线程"></a>编写一个资源抢占的多线程</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>():</span></span><br><span class="line">    <span class="keyword">global</span> num</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000000</span>):</span><br><span class="line">        num += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    num = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    t1 = Thread(target=func)</span><br><span class="line">    t2 = Thread(target=func)</span><br><span class="line"></span><br><span class="line">    t1.start()</span><br><span class="line">    t2.start()</span><br><span class="line">    </span><br><span class="line">    t1.join()</span><br><span class="line">    t2.join()</span><br><span class="line">    <span class="built_in">print</span>(num)</span><br></pre></td></tr></table></figure>

<h4 id="使用Lock"><a href="#使用Lock" class="headerlink" title="使用Lock"></a>使用Lock</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread,Lock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run1</span>():</span></span><br><span class="line">	<span class="keyword">global</span> num</span><br><span class="line">	<span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000000</span>):</span><br><span class="line">		<span class="keyword">with</span> lock:</span><br><span class="line">			num += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	num = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">	lock = Lock()</span><br><span class="line">	t1 = Thread(target=run1)</span><br><span class="line">	t2 = Thread(target=run1)</span><br><span class="line"></span><br><span class="line">	t1.start()</span><br><span class="line">	t2.start()</span><br><span class="line">	t1.join()</span><br><span class="line">	t2.join()</span><br><span class="line">	<span class="built_in">print</span>(num)</span><br></pre></td></tr></table></figure>



<h3 id="使用RLock"><a href="#使用RLock" class="headerlink" title="使用RLock"></a>使用RLock</h3><p>可重入锁</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread,RLock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun</span>():</span></span><br><span class="line">    <span class="keyword">global</span> num</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000</span>):</span><br><span class="line">        <span class="keyword">with</span> lock:</span><br><span class="line">            num += <span class="number">1</span></span><br><span class="line">            <span class="keyword">with</span> lock:</span><br><span class="line">                <span class="built_in">print</span>(num)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    lock = RLock()</span><br><span class="line">    num = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    Thread(target=fun).start()</span><br></pre></td></tr></table></figure>





<h4 id="使用ThreadLocal"><a href="#使用ThreadLocal" class="headerlink" title="使用ThreadLocal"></a>使用ThreadLocal</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread,local</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun</span>(<span class="params">num</span>):</span></span><br><span class="line">	local.num = num</span><br><span class="line">	<span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000000</span>):</span><br><span class="line">		local.num += <span class="number">1</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&#x27;-----&#x27;</span>,local.num)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	local = local()</span><br><span class="line">	num = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">	t1 = Thread(target=fun,args=(num,))</span><br><span class="line">	t2 = Thread(target=fun,args=(num,))</span><br><span class="line"></span><br><span class="line">	t1.start()</span><br><span class="line">	t2.start()</span><br><span class="line"></span><br><span class="line">	t1.join()</span><br><span class="line">	t2.join()</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&#x27;-----&#x27;</span>,num)</span><br></pre></td></tr></table></figure>

<h4 id="使用Semaphore"><a href="#使用Semaphore" class="headerlink" title="使用Semaphore"></a>使用Semaphore</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread,Semaphore</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun</span>(<span class="params">num</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        num += <span class="number">1</span></span><br><span class="line">        <span class="keyword">with</span> sem:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;--------&#x27;</span>,num)</span><br><span class="line">            time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    sem = Semaphore(<span class="number">3</span>)</span><br><span class="line">    num = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">        Thread(target=fun,args=(i,)).start()</span><br><span class="line"></span><br><span class="line">    time.sleep(<span class="number">15</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;*******&#x27;</span>,num)</span><br></pre></td></tr></table></figure>

<h4 id="使用Barrier"><a href="#使用Barrier" class="headerlink" title="使用Barrier"></a>使用Barrier</h4><p>凑够一定数量的线程才能执行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread,Barrier</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun</span>(<span class="params">num</span>):</span></span><br><span class="line">    bar.wait()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;--------&#x27;</span>,num)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    bar = Barrier(<span class="number">3</span>)</span><br><span class="line">    num = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        Thread(target=fun,args=(i,)).start()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    time.sleep(<span class="number">15</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;*******&#x27;</span>,num)</span><br></pre></td></tr></table></figure>

<h4 id="使用Timer"><a href="#使用Timer" class="headerlink" title="使用Timer"></a>使用Timer</h4><p>定时线程</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread,Timer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;--------&#x27;</span>)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    t = Timer(<span class="number">5</span>,fun)</span><br><span class="line"></span><br><span class="line">    t.start()</span><br><span class="line">    t.join()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;*******&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h3 id="线程通讯"><a href="#线程通讯" class="headerlink" title="线程通讯"></a>线程通讯</h3><h4 id="使用Event"><a href="#使用Event" class="headerlink" title="使用Event"></a>使用Event</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread,Event</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun</span>():</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        event.wait()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;--------&#x27;</span>)</span><br><span class="line">        event.clear()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    event = Event()</span><br><span class="line"></span><br><span class="line">    t = Thread(target=fun)</span><br><span class="line">    t.start()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        event.<span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;********&#x27;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>wait – set – clear</p>
<p>对应着<code>阻塞</code> – <code>解除阻塞</code> – <code>重新阻塞</code>整个流程</p>
</blockquote>
<h4 id="使用Condition"><a href="#使用Condition" class="headerlink" title="使用Condition"></a>使用Condition</h4><p>用于线程之间互相唤醒</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread,Condition</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun1</span>():</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">with</span> cond:</span><br><span class="line">            cond.wait()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;--------&#x27;</span>)</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line">            cond.notify()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun2</span>():</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">with</span> cond:</span><br><span class="line">            cond.notify()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;*******&#x27;</span>)</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line">            cond.wait()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    cond = Condition()</span><br><span class="line"></span><br><span class="line">    t1 = Thread(target=fun1)</span><br><span class="line">    t2 = Thread(target=fun2)</span><br><span class="line"></span><br><span class="line">    t1.start()</span><br><span class="line">    t2.start()</span><br></pre></td></tr></table></figure>



<h3 id="多任务的最佳实践"><a href="#多任务的最佳实践" class="headerlink" title="多任务的最佳实践"></a>多任务的最佳实践</h3><p>设计<code>Master-Worker</code>模式，Master负责分配任务，Worker负责执行任务</p>
<ul>
<li>主进程就是Master,其他进程就是Worker</li>
<li>优点:稳定性高:<br>一个子进程崩溃了，不会影响主进程和其他子进程，当然主进程挂掉了,所有进程就全挂了，但是Master进程只负责分配任务，挂掉的概率低</li>
<li>缺点:<ol>
<li>创建进程的代价大:<br>在Unix/Linux系统下，用fork调用还行，在Window创建进程开销巨大。</li>
<li>操作系统能同时运行的进程数有限:<br>在内存和CPU的限制下，如果有几千个进程同时运行，操作系统连调度都会成问题</li>
</ol>
</li>
</ul>
<h2 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h2><blockquote>
<ul>
<li>不能在生成器中使用<code>await</code></li>
<li>不能在 async 定义的协程中使用<code>yield</code></li>
<li><strong>协程对象不能直接运行，必须放入事件循环中或者由 yield from 语句调用</strong>。</li>
</ul>
<p>yield from的两大优势</p>
<ol>
<li>避免嵌套循环</li>
<li>转移控制权</li>
</ol>
</blockquote>
<h3 id="asyncio的组件"><a href="#asyncio的组件" class="headerlink" title="asyncio的组件"></a>asyncio的组件</h3><ul>
<li>event_loop 事件循环：<br><strong>程序开启一个无限的循环，程序员会把一些函数注册到事件循环上。当满足事件发生的时候，调用相应的协程函数。</strong></li>
<li>coroutine 协程：<br>协程对象，指一个使用async关键字定义的函数，它的调用不会立即执行函数，而是会返回一个协程对象。协程对象需要注册到事件循环，由事件循环调用。</li>
<li>task  任务：<br>一个协程对象就是一个原生可以挂起的函数，<strong>任务则是对协程进一步封装</strong>，其中包含任务的各种状态。</li>
<li>future：<br>代表将来执行或没有执行的任务的结果。它和task上没有本质的区别<br>(<strong>task对象是Future类的子类</strong>)</li>
<li>async/await 关键字：<br>python3.5 用于定义协程的关键字，async定义一个协程，await用于挂起阻塞的异步调用接口。</li>
</ul>
<h3 id="传入loop的方法"><a href="#传入loop的方法" class="headerlink" title="传入loop的方法"></a>传入loop的方法</h3><h4 id="直接传入协程"><a href="#直接传入协程" class="headerlink" title="直接传入协程"></a>直接传入协程</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read</span>():</span><span class="keyword">pass</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">write</span>():</span><span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">loop.run_until_complete(write())</span><br></pre></td></tr></table></figure>



<h4 id="使用asyncio-wait传入协程列表"><a href="#使用asyncio-wait传入协程列表" class="headerlink" title="使用asyncio.wait传入协程列表"></a>使用asyncio.wait传入协程列表</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">coro1</span>():</span><span class="keyword">pass</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">coro2</span>():</span><span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">loop.run_until_complete(asyncio.wait([</span><br><span class="line">    coro1(), </span><br><span class="line">    coro2(),</span><br><span class="line">]))</span><br></pre></td></tr></table></figure>



<h3 id="使用asyncio-gather传入协程"><a href="#使用asyncio-gather传入协程" class="headerlink" title="使用asyncio.gather传入协程"></a>使用asyncio.gather传入协程</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">group1 = asyncio.gather(*[func(<span class="string">&quot;A&quot;</span> ,i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">3</span>)])</span><br><span class="line">group2 = asyncio.gather(*[func(<span class="string">&quot;B&quot;</span>, i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">5</span>)])</span><br><span class="line">group3 = asyncio.gather(*[func(<span class="string">&quot;B&quot;</span>, i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">7</span>)])</span><br><span class="line"></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">loop.run_until_complete(asyncio.gather(group1, group2, group3))</span><br></pre></td></tr></table></figure>



<h3 id="task"><a href="#task" class="headerlink" title="task"></a>task</h3><h4 id="创建task的两种方法"><a href="#创建task的两种方法" class="headerlink" title="创建task的两种方法"></a>创建task的两种方法</h4><p>使用create_task</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">do_some_work</span>(<span class="params">x</span>):</span><span class="keyword">pass</span></span><br><span class="line">task = loop.create_task(do_some_work(<span class="number">2</span>))</span><br></pre></td></tr></table></figure>

<p>使用ensure_future</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">do_some_work</span>(<span class="params">x</span>):</span><span class="keyword">pass</span></span><br><span class="line">task = asyncio.ensure_future(coroutine)</span><br></pre></td></tr></table></figure>



<h4 id="task绑定回调"><a href="#task绑定回调" class="headerlink" title="task绑定回调"></a>task绑定回调</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">coroutine</span>(<span class="params">x</span>):</span><span class="keyword">pass</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">callback</span>(<span class="params">future</span>):</span><span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">task = asyncio.ensure_future(coroutine)</span><br><span class="line">task.add_done_callback(callback)</span><br></pre></td></tr></table></figure>



<h3 id="task获取结果"><a href="#task获取结果" class="headerlink" title="task获取结果"></a>task获取结果</h3><h4 id="使用task-result"><a href="#使用task-result" class="headerlink" title="使用task.result()"></a>使用task.result()</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">coroutine</span>(<span class="params">x</span>):</span><span class="keyword">pass</span></span><br><span class="line">task = asyncio.ensure_future(coroutine)</span><br><span class="line">loop.run_until_complete(task)</span><br><span class="line"><span class="built_in">print</span>(task.result())</span><br></pre></td></tr></table></figure>

<h4 id="使用asyncio-wait-tasks"><a href="#使用asyncio-wait-tasks" class="headerlink" title="使用asyncio.wait(tasks)"></a>使用asyncio.wait(tasks)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">tasks = [</span><br><span class="line">    asyncio.ensure_future(coroutine1),</span><br><span class="line">    asyncio.ensure_future(coroutine2),</span><br><span class="line">    asyncio.ensure_future(coroutine3)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">dones, pendings = <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> task <span class="keyword">in</span> dones:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Task ret: &#x27;</span>, task.result())</span><br></pre></td></tr></table></figure>



<h4 id="asyncio-get-event-looloop-run-until-completep配合asyncio-gather"><a href="#asyncio-get-event-looloop-run-until-completep配合asyncio-gather" class="headerlink" title="asyncio.get_event_looloop.run_until_completep配合asyncio.gather"></a>asyncio.get_event_looloop.run_until_completep配合asyncio.gather</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    coroutine1 = do_some_work(<span class="number">1</span>)</span><br><span class="line">    coroutine2 = do_some_work(<span class="number">2</span>)</span><br><span class="line">    coroutine3 = do_some_work(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    tasks = [</span><br><span class="line">        asyncio.ensure_future(coroutine1),</span><br><span class="line">        asyncio.ensure_future(coroutine2),</span><br><span class="line">        asyncio.ensure_future(coroutine3)</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> asyncio.gather(*tasks)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">results = loop.run_until_complete(main())</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Task ret: &#x27;</span>, result)</span><br></pre></td></tr></table></figure>



<h4 id="loop-run-until-complete配合asyncio-wait"><a href="#loop-run-until-complete配合asyncio-wait" class="headerlink" title="loop.run_until_complete配合asyncio.wait"></a>loop.run_until_complete配合asyncio.wait</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    coroutine1 = do_some_work(<span class="number">1</span>)</span><br><span class="line">    coroutine2 = do_some_work(<span class="number">2</span>)</span><br><span class="line">    coroutine3 = do_some_work(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    tasks = [</span><br><span class="line">        asyncio.ensure_future(coroutine1),</span><br><span class="line">        asyncio.ensure_future(coroutine2),</span><br><span class="line">        asyncio.ensure_future(coroutine3)</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line"></span><br><span class="line">start = now()</span><br><span class="line"></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">done, pending = loop.run_until_complete(main())</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> task <span class="keyword">in</span> done:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Task ret: &#x27;</span>, task.result())</span><br></pre></td></tr></table></figure>



<h4 id="asyncio的as-completed方法"><a href="#asyncio的as-completed方法" class="headerlink" title="asyncio的as_completed方法"></a>asyncio的as_completed方法</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    coroutine1 = do_some_work(<span class="number">1</span>)</span><br><span class="line">    coroutine2 = do_some_work(<span class="number">2</span>)</span><br><span class="line">    coroutine3 = do_some_work(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    tasks = [</span><br><span class="line">        asyncio.ensure_future(coroutine1),</span><br><span class="line">        asyncio.ensure_future(coroutine2),</span><br><span class="line">        asyncio.ensure_future(coroutine3)</span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">for</span> task <span class="keyword">in</span> asyncio.as_completed(tasks):</span><br><span class="line">        result = <span class="keyword">await</span> task   <span class="comment"># 注意这里有一个await</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">done = loop.run_until_complete(main())</span><br></pre></td></tr></table></figure>



<h3 id="动态注册协程"><a href="#动态注册协程" class="headerlink" title="动态注册协程"></a>动态注册协程</h3><h4 id="同步"><a href="#同步" class="headerlink" title="同步"></a>同步</h4><blockquote>
<p>当前线程创建一个事件循环，然后再新建一个线程，在新线程中启动事件循环。当前线程不会被block。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_loop</span>(<span class="params">loop</span>):</span></span><br><span class="line">    asyncio.set_event_loop(loop)</span><br><span class="line">    loop.run_forever()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">more_work</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;More work &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(x))</span><br><span class="line">    time.sleep(x)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Finished more work &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(x))</span><br><span class="line"></span><br><span class="line">start = time.time()</span><br><span class="line">new_loop = asyncio.new_event_loop()</span><br><span class="line">t = Thread(target=start_loop, args=(new_loop,))</span><br><span class="line">t.start()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;TIME: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(time.time() - start))</span><br><span class="line"></span><br><span class="line">new_loop.call_soon_threadsafe(more_work, <span class="number">6</span>)</span><br><span class="line">new_loop.call_soon_threadsafe(more_work, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># TIME: 0.0019989013671875</span></span><br><span class="line"><span class="comment"># More work 6</span></span><br><span class="line"><span class="comment"># Finished more work 6</span></span><br><span class="line"><span class="comment"># More work 3</span></span><br><span class="line"><span class="comment"># Finished more work 3</span></span><br></pre></td></tr></table></figure>

<h4 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_loop</span>(<span class="params">loop</span>):</span></span><br><span class="line">    <span class="comment"># 一个在后台永远运行的事件循环</span></span><br><span class="line">    asyncio.set_event_loop(loop)</span><br><span class="line">    loop.run_forever()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">do_sleep</span>(<span class="params">x, queue, msg=<span class="string">&quot;&quot;</span></span>):</span></span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(x)</span><br><span class="line">    queue.put(msg)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	queue = Queue()</span><br><span class="line"></span><br><span class="line">	new_loop = asyncio.new_event_loop()</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 定义一个线程，并传入一个事件循环对象</span></span><br><span class="line">	t = Thread(target=start_loop, args=(new_loop,))</span><br><span class="line">	t.start()</span><br><span class="line"></span><br><span class="line">	<span class="built_in">print</span>(time.ctime())</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 动态添加两个协程</span></span><br><span class="line">	<span class="comment"># 这种方法，在主线程是异步的</span></span><br><span class="line">	asyncio.run_coroutine_threadsafe(do_sleep(<span class="number">6</span>, queue, <span class="string">&quot;第一个&quot;</span>), new_loop)</span><br><span class="line">	asyncio.run_coroutine_threadsafe(do_sleep(<span class="number">3</span>, queue, <span class="string">&quot;第二个&quot;</span>), new_loop)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">	    msg = queue.get()</span><br><span class="line">	    <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; 协程运行完..&quot;</span>.<span class="built_in">format</span>(msg))</span><br><span class="line">	    <span class="built_in">print</span>(time.ctime())</span><br><span class="line"></span><br><span class="line"><span class="comment"># Sat Jul 13 10:39:27 2019</span></span><br><span class="line"><span class="comment"># 第二个 协程运行完..</span></span><br><span class="line"><span class="comment"># Sat Jul 13 10:39:30 2019</span></span><br><span class="line"><span class="comment"># 第一个 协程运行完..</span></span><br><span class="line"><span class="comment"># Sat Jul 13 10:39:33 2019</span></span><br></pre></td></tr></table></figure>



<h3 id="async-with-和async-for"><a href="#async-with-和async-for" class="headerlink" title="async with 和async for"></a>async with 和async for</h3><h4 id="async-with"><a href="#async-with" class="headerlink" title="async with"></a>async with</h4><p>异步上下文管理器指的是<strong>在enter和exit方法处能够暂停执行的上下文管理器</strong>。</p>
<blockquote>
<ul>
<li>实现这样的功能，需要加入两个新的方法：__aenter__ 和__aexit__。</li>
<li>这两个方法都要返回一个 awaitable 类型的值。</li>
</ul>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">with</span> EXPR <span class="keyword">as</span> VAR:</span><br><span class="line">    BLOCK</span><br><span class="line">    </span><br><span class="line"><span class="comment">## 上面代码等同于下面:</span></span><br><span class="line">mgr = (EXPR)</span><br><span class="line">aenter = <span class="built_in">type</span>(mgr).__aenter__(mgr)</span><br><span class="line">aexit = <span class="built_in">type</span>(mgr).__aexit__</span><br><span class="line">exc = <span class="literal">True</span></span><br><span class="line"> </span><br><span class="line">VAR = <span class="keyword">await</span> aenter</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    BLOCK</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">await</span> aexit(mgr, *sys.exc_info()):</span><br><span class="line">        <span class="keyword">raise</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">await</span> aexit(mgr, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>简单来说就是:</p>
<ul>
<li>进来的时候需要<code>await  aenter</code>(延时操作)</li>
<li>出去的时候需要<code>await  aexit</code>(延时操作)</li>
</ul>
</blockquote>
<h4 id="async-for"><a href="#async-for" class="headerlink" title="async for"></a>async for</h4><ul>
<li>异步迭代器就是<strong>能够在next方法中调用异步代码</strong>。</li>
<li>一个异步可迭代对象（asynchronous iterable）<strong>能够在迭代过程中调用异步代码</strong></li>
</ul>
<blockquote>
<p>为了支持异步迭代：</p>
<ol>
<li>一个对象必须实现__aiter__方法，该方法返回一个异步迭代器（asynchronous iterator）对象。 </li>
<li>一个异步迭代器对象必须实现__anext__方法，该方法返回一个awaitable 类型的值。 </li>
<li>为了停止迭代，__anext__必须抛出一个 StopAsyncIteration 异常。</li>
</ol>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">for</span> TARGET <span class="keyword">in</span> ITER:</span><br><span class="line">    BLOCK</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    BLOCK2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 上面代码等同于下面:</span></span><br><span class="line"><span class="built_in">iter</span> = (ITER)</span><br><span class="line"><span class="built_in">iter</span> = <span class="built_in">type</span>(<span class="built_in">iter</span>).__aiter__(<span class="built_in">iter</span>)</span><br><span class="line">running = <span class="literal">True</span></span><br><span class="line"><span class="keyword">while</span> running:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        TARGET = <span class="keyword">await</span> <span class="built_in">type</span>(<span class="built_in">iter</span>).__anext__(<span class="built_in">iter</span>)</span><br><span class="line">    <span class="keyword">except</span> StopAsyncIteration:</span><br><span class="line">        running = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        BLOCK</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    BLOCK2</span><br></pre></td></tr></table></figure>



<h3 id="loop-stop暂停事件循环"><a href="#loop-stop暂停事件循环" class="headerlink" title="loop.stop暂停事件循环"></a>loop.stop暂停事件循环</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">work</span>(<span class="params">loop, t</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;start&#x27;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(t) </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;after &#123;&#125;s stop&#x27;</span>.<span class="built_in">format</span>(t))</span><br><span class="line">    loop.stop()             <span class="comment"># 停止事件循环，stop 后仍可重新运行</span></span><br><span class="line"></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">task = asyncio.ensure_future(work(loop, <span class="number">1</span>))</span><br><span class="line">loop.run_forever()  <span class="comment"># 无限运行事件循环，直至 loop.stop 停止</span></span><br><span class="line">loop.close()        <span class="comment"># 关闭事件循环，只有 loop 处于停止状态才会执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># start</span></span><br><span class="line"><span class="comment"># after 1s stop</span></span><br></pre></td></tr></table></figure>



<h3 id="将普通函数作为任务注入事件循环的三种方法"><a href="#将普通函数作为任务注入事件循环的三种方法" class="headerlink" title="将普通函数作为任务注入事件循环的三种方法"></a>将普通函数作为任务注入事件循环的三种方法</h3><ul>
<li>loop.call_soon</li>
<li>loop.call_later</li>
<li>loop.call_at &amp; loop.time</li>
</ul>
<h4 id="loop-call-soon"><a href="#loop-call-soon" class="headerlink" title="loop.call_soon"></a>loop.call_soon</h4><p>将普通函数作为任务加入到事件循环并立即排定任务的执行顺序</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span>(<span class="params">name</span>):</span>          <span class="comment"># 普通函数</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[hello] Hello, &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(name))</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">work</span>(<span class="params">t, name</span>):</span>  <span class="comment"># 协程函数</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[work ] start&#x27;</span>, name)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(t)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[work ] &#123;&#125; after &#123;&#125;s stop&#x27;</span>.<span class="built_in">format</span>(name, t))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    loop = asyncio.get_event_loop() </span><br><span class="line">    <span class="comment"># 向事件循环中添加任务</span></span><br><span class="line">    asyncio.ensure_future(work(<span class="number">1</span>, <span class="string">&#x27;A&#x27;</span>))     <span class="comment"># 第 1 个执行</span></span><br><span class="line">    <span class="comment"># call_soon 将普通函数当作 task 加入到事件循环并排定执行顺序</span></span><br><span class="line">    <span class="comment"># 该方法的第一个参数为普通函数名字，普通函数的参数写在后面</span></span><br><span class="line">    loop.call_soon(hello, <span class="string">&#x27;Tom&#x27;</span>)            <span class="comment"># 第 2 个执行</span></span><br><span class="line">    <span class="comment"># 向事件循环中添加任务</span></span><br><span class="line">    loop.create_task(work(<span class="number">2</span>, <span class="string">&#x27;B&#x27;</span>))          <span class="comment"># 第 3 个执行</span></span><br><span class="line">    <span class="comment"># 阻塞启动事件循环，顺便再添加一个任务  </span></span><br><span class="line">    loop.run_until_complete(work(<span class="number">3</span>, <span class="string">&#x27;C&#x27;</span>))   <span class="comment"># 第 4 个执行</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br><span class="line"><span class="comment"># [work ] start A</span></span><br><span class="line"><span class="comment"># [hello] Hello, Tom</span></span><br><span class="line"><span class="comment"># [work ] start B</span></span><br><span class="line"><span class="comment"># [work ] start C</span></span><br><span class="line"><span class="comment"># [work ] A after 1s stop</span></span><br><span class="line"><span class="comment"># [work ] B after 2s stop</span></span><br><span class="line"><span class="comment"># [work ] C after 3s stop</span></span><br></pre></td></tr></table></figure>



<h4 id="loop-call-later"><a href="#loop-call-later" class="headerlink" title="loop.call_later"></a>loop.call_later</h4><p>可延时执行，第一个参数为延时时间</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span>(<span class="params">name</span>):</span>            <span class="comment"># 普通函数</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[hello]  Hello, &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(name))</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">work</span>(<span class="params">t, name</span>):</span>    <span class="comment"># 协程函数</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[work&#123;&#125;]  start&#x27;</span>.<span class="built_in">format</span>(name))</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(t)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[work&#123;&#125;]  stop&#x27;</span>.<span class="built_in">format</span>(name))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    asyncio.ensure_future(work(<span class="number">1</span>, <span class="string">&#x27;A&#x27;</span>))         <span class="comment"># 任务 1</span></span><br><span class="line">    loop.call_later(<span class="number">1.2</span>, hello, <span class="string">&#x27;Tom&#x27;</span>)          <span class="comment"># 任务 2</span></span><br><span class="line">    loop.call_soon(hello, <span class="string">&#x27;Kitty&#x27;</span>)              <span class="comment"># 任务 3</span></span><br><span class="line">    task4 = loop.create_task(work(<span class="number">2</span>, <span class="string">&#x27;B&#x27;</span>))      <span class="comment"># 任务 4</span></span><br><span class="line">    loop.call_later(<span class="number">1</span>, hello, <span class="string">&#x27;Jerry&#x27;</span>)          <span class="comment"># 任务 5</span></span><br><span class="line">    loop.run_until_complete(task4)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br><span class="line"><span class="comment"># [workA]  start</span></span><br><span class="line"><span class="comment"># [hello]  Hello, Kitty</span></span><br><span class="line"><span class="comment"># [workB]  start</span></span><br><span class="line"><span class="comment"># [hello]  Hello, Jerry</span></span><br><span class="line"><span class="comment"># [workA]  stop</span></span><br><span class="line"><span class="comment"># [hello]  Hello, Tom</span></span><br><span class="line"><span class="comment"># [workB]  stop</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意，call_later 这个延时 1.2 秒是事件循环启动时就开始计时的</p>
</blockquote>
<h4 id="loop-call-at-amp-loop-time"><a href="#loop-call-at-amp-loop-time" class="headerlink" title="loop.call_at &amp; loop.time"></a>loop.call_at &amp; loop.time</h4><ul>
<li>call_at 在某时刻执行</li>
<li>loop.time 就是事件循环内部的一个计时方法，返回值是时刻，数据类型是 float</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span>(<span class="params">name</span>):</span>            <span class="comment"># 普通函数</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[hello]  Hello, &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(name))</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">work</span>(<span class="params">t, name</span>):</span>    <span class="comment"># 协程函数</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[work&#123;&#125;]  start&#x27;</span>.<span class="built_in">format</span>(name))</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(t)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[work&#123;&#125;]  stop&#x27;</span>.<span class="built_in">format</span>(name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    start = loop.time()                         <span class="comment"># 事件循环内部时刻</span></span><br><span class="line">    asyncio.ensure_future(work(<span class="number">1</span>, <span class="string">&#x27;A&#x27;</span>))         <span class="comment"># 任务 1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># loop.call_later(1.2, hello, &#x27;Tom&#x27;)</span></span><br><span class="line">    <span class="comment"># 上面注释这行等同于下面这行</span></span><br><span class="line">    loop.call_at(start+<span class="number">1.2</span>, hello, <span class="string">&#x27;Tom&#x27;</span>)       <span class="comment"># 任务 2</span></span><br><span class="line"></span><br><span class="line">    loop.call_soon(hello, <span class="string">&#x27;Kitty&#x27;</span>)              <span class="comment"># 任务 3</span></span><br><span class="line">    </span><br><span class="line">    task4 = loop.create_task(work(<span class="number">2</span>, <span class="string">&#x27;B&#x27;</span>))      <span class="comment"># 任务 4</span></span><br><span class="line">    <span class="comment"># loop.call_later(1, hello, &#x27;Jerry&#x27;)</span></span><br><span class="line">    <span class="comment"># 上面注释这行等同于下面这行</span></span><br><span class="line">    loop.call_at(start+<span class="number">1</span>, hello, <span class="string">&#x27;Jerry&#x27;</span>)       <span class="comment"># 任务 5</span></span><br><span class="line"></span><br><span class="line">    loop.run_until_complete(task4)</span><br><span class="line"></span><br><span class="line">main()</span><br><span class="line"><span class="comment"># [workA]  start</span></span><br><span class="line"><span class="comment"># [hello]  Hello, Kitty</span></span><br><span class="line"><span class="comment"># [workB]  start</span></span><br><span class="line"><span class="comment"># [hello]  Hello, Jerry</span></span><br><span class="line"><span class="comment"># [workA]  stop</span></span><br><span class="line"><span class="comment"># [hello]  Hello, Tom</span></span><br><span class="line"><span class="comment"># [workB]  stop</span></span><br></pre></td></tr></table></figure>



<h3 id="协程的通讯方法"><a href="#协程的通讯方法" class="headerlink" title="协程的通讯方法"></a>协程的通讯方法</h3><h4 id="asyncio-lock"><a href="#asyncio-lock" class="headerlink" title="asyncio.lock"></a>asyncio.lock</h4><p>协程锁存在的意义 : </p>
<ul>
<li>协程锁锁住了一些代码A,在执行代码A的时候,有可能就切换协程了,此时的协程锁就会锁住</li>
<li>这样就保证了协程锁里面的代码一定会等待被执行完毕.</li>
</ul>
<blockquote>
<p>协程锁的固定用法是<strong>使用 async with 创建协程锁的上下文环境</strong>，将代码块写入其中。 </p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line">l = []</span><br><span class="line">lock = asyncio.Lock()   <span class="comment"># 协程锁</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">work</span>(<span class="params">name</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">r&#x27;\\\\\\\\\\\\&#x27;</span>,name)     <span class="comment"># 打印此信息是为了测试协程锁的控制范围</span></span><br><span class="line">    <span class="comment"># 这里加个锁，第一次调用该协程，运行到这个语句块，上锁</span></span><br><span class="line">    <span class="comment"># 当语句块结束后解锁，开锁前该语句块不可被运行第二次</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 如果上锁后有其它任务调用了这个协程函数，运行到这步会被阻塞，直至解锁</span></span><br><span class="line">    <span class="comment"># with 是普通上下文管理器关键字，async with 是异步上下文管理器关键字</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 能够使用 with 关键字的对象须有 __enter__ 和 __exit__ 方法</span></span><br><span class="line">    <span class="comment"># 能够使用 async with 关键字的对象须有 __aenter__ 和 __aexit__ 方法</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># async with 会自动运行 lock 的 __aenter__ 方法，该方法会调用 acquire 方法上锁</span></span><br><span class="line">    <span class="comment"># 在语句块结束时自动运行 __aexit__ 方法，该方法会调用 release 方法解锁</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 这和 with 一样，都是简化 try ... finally 语句</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> lock:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;&#123;&#125; start&#x27;</span>.<span class="built_in">format</span>(name))  <span class="comment"># 头一次运行该协程时打印</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;x&#x27;</span> <span class="keyword">in</span> l:                    <span class="comment"># 如果判断成功</span></span><br><span class="line">            <span class="keyword">return</span> name                 <span class="comment"># 直接返回结束协程，不再向下执行</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;++++++++++&#x27;</span>,name)</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">0</span>)          <span class="comment"># asyncio.sleep(0) 一样也会切换协程</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;----------&#x27;</span>,name)  </span><br><span class="line">        l.append(<span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;&#123;&#125; end&#x27;</span>.<span class="built_in">format</span>(name))</span><br><span class="line">        <span class="keyword">return</span> name</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">one</span>():</span></span><br><span class="line">    name = <span class="keyword">await</span> work(<span class="string">&#x27;one&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;&#123;&#125; ok&#x27;</span>.<span class="built_in">format</span>(name))</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">two</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;///////////&#x27;</span>)</span><br><span class="line">    name = <span class="keyword">await</span> work(<span class="string">&#x27;two&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;&#123;&#125; ok&#x27;</span>.<span class="built_in">format</span>(name))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    tasks = asyncio.wait([one(), two()])</span><br><span class="line">    loop.run_until_complete(tasks)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br><span class="line"><span class="comment"># \\\\\\\\\\\\ one</span></span><br><span class="line"><span class="comment"># one start</span></span><br><span class="line"><span class="comment"># ++++++++++ one</span></span><br><span class="line"><span class="comment"># ///////////</span></span><br><span class="line"><span class="comment"># \\\\\\\\\\\\ two</span></span><br><span class="line"><span class="comment"># ---------- one</span></span><br><span class="line"><span class="comment"># one end</span></span><br><span class="line"><span class="comment"># one ok</span></span><br><span class="line"><span class="comment"># two start</span></span><br><span class="line"><span class="comment"># two ok</span></span><br></pre></td></tr></table></figure>



<h4 id="asyncio-Event"><a href="#asyncio-Event" class="headerlink" title="asyncio.Event"></a>asyncio.Event</h4><p><code>asyncio.Event</code> 类似 <code>threading.Event</code> 用来<strong>允许多个消费者等待某个事情发生，不用通过监听一个特殊的值的来说实现类似通知</strong>的功能。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_event</span>(<span class="params">event</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;setting event in callback&#x27;</span>)</span><br><span class="line">    event.<span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">coro1</span>(<span class="params">event</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;coro1 waiting for event&#x27;</span>)</span><br><span class="line">    <span class="keyword">await</span> event.wait()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;coro1 triggered&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">coro2</span>(<span class="params">event</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;coro2 waiting for event&#x27;</span>)</span><br><span class="line">    <span class="keyword">await</span> event.wait()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;coro2 triggered&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">loop</span>):</span></span><br><span class="line">    event = asyncio.Event()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;event start state: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(event.is_set()))</span><br><span class="line">    loop.call_later(</span><br><span class="line">        <span class="number">0.1</span>, functools.partial(set_event, event)</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">await</span> asyncio.wait([coro1(event), coro2(event)])</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;event end state: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(event.is_set()))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    event_loop.run_until_complete(main(event_loop))</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    event_loop.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># event start state: False</span></span><br><span class="line"><span class="comment"># coro1 waiting for event</span></span><br><span class="line"><span class="comment"># coro2 waiting for event</span></span><br><span class="line"><span class="comment"># setting event in callback</span></span><br><span class="line"><span class="comment"># coro1 triggered</span></span><br><span class="line"><span class="comment"># coro2 triggered</span></span><br><span class="line"><span class="comment"># event end state: True</span></span><br></pre></td></tr></table></figure>



<h4 id="asyncio-condition"><a href="#asyncio-condition" class="headerlink" title="asyncio.condition"></a>asyncio.condition</h4><p><code>Condition</code> 的效果类似 <code>Event</code>，不同的是它不是唤醒所有等待中的 coroutine, 而是通过 <code>notify()</code> 唤醒指定数量的待唤醒 coroutine。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">consumer</span>(<span class="params">condition, n</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;----&#x27;</span>)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> condition:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;consumer &#123;&#125; is waiting&#x27;</span>.<span class="built_in">format</span>(n))</span><br><span class="line">        <span class="keyword">await</span> condition.wait()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;consumer &#123;&#125; triggered&#x27;</span>.<span class="built_in">format</span>(n))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;ending consumer &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(n))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">manipulate_condition</span>(<span class="params">condition</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;starting manipulate_condition&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">3</span>):</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> condition:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;notifying &#123;&#125; consumers&#x27;</span>.<span class="built_in">format</span>(i))</span><br><span class="line">            condition.notify(n=i)</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> condition:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;notifying remaining consumers&#x27;</span>)</span><br><span class="line">        condition.notify_all()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;ending manipulate_condition&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">loop</span>):</span></span><br><span class="line">    condition = asyncio.Condition()</span><br><span class="line"></span><br><span class="line">    consumers = [</span><br><span class="line">        consumer(condition, i)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)</span><br><span class="line">    ]</span><br><span class="line">    loop.create_task(manipulate_condition(condition))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">await</span> asyncio.wait(consumers)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    result = event_loop.run_until_complete(main(event_loop))</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    event_loop.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># starting manipulate_condition</span></span><br><span class="line"><span class="comment"># ----</span></span><br><span class="line"><span class="comment"># consumer 3 is waiting</span></span><br><span class="line"><span class="comment"># ----</span></span><br><span class="line"><span class="comment"># consumer 0 is waiting</span></span><br><span class="line"><span class="comment"># ----</span></span><br><span class="line"><span class="comment"># consumer 2 is waiting</span></span><br><span class="line"><span class="comment"># ----</span></span><br><span class="line"><span class="comment"># consumer 4 is waiting</span></span><br><span class="line"><span class="comment"># ----</span></span><br><span class="line"><span class="comment"># consumer 1 is waiting</span></span><br><span class="line"><span class="comment"># notifying 1 consumers</span></span><br><span class="line"><span class="comment"># consumer 3 triggered</span></span><br><span class="line"><span class="comment"># ending consumer 3</span></span><br><span class="line"><span class="comment"># notifying 2 consumers</span></span><br><span class="line"><span class="comment"># consumer 0 triggered</span></span><br><span class="line"><span class="comment"># ending consumer 0</span></span><br><span class="line"><span class="comment"># consumer 2 triggered</span></span><br><span class="line"><span class="comment"># ending consumer 2</span></span><br><span class="line"><span class="comment"># notifying remaining consumers</span></span><br><span class="line"><span class="comment"># ending manipulate_condition</span></span><br><span class="line"><span class="comment"># consumer 4 triggered</span></span><br><span class="line"><span class="comment"># ending consumer 4</span></span><br><span class="line"><span class="comment"># consumer 1 triggered</span></span><br><span class="line"><span class="comment"># ending consumer 1	</span></span><br></pre></td></tr></table></figure>



<h4 id="asyncio-Queue"><a href="#asyncio-Queue" class="headerlink" title="asyncio.Queue"></a>asyncio.Queue</h4><blockquote>
<p><code>queue.Queue</code>的queue.task_done()的功能 :<br>每<code>task_done</code>一次 就从队列里删掉一个元素，这样在最后queue.join()的时候根据队列长度是否为零来判断队列是否结束</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">consumer</span>(<span class="params">n, q</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;consumer &#123;&#125;: waiting for item&#x27;</span>.<span class="built_in">format</span>(n))</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;consumer &#123;&#125;: waiting for item&#x27;</span>.<span class="built_in">format</span>(n))</span><br><span class="line">        item = <span class="keyword">await</span> q.get()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;consumer &#123;&#125;: has item &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(n, item))</span><br><span class="line">        <span class="comment"># 在这个程序中 None 是个特殊的值，表示终止信号</span></span><br><span class="line">        <span class="keyword">if</span> item <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            q.task_done()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">await</span> asyncio.sleep(<span class="number">0.01</span> * item)</span><br><span class="line">            q.task_done()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;consumer &#123;&#125;: ending&#x27;</span>.<span class="built_in">format</span>(n))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">producer</span>(<span class="params">q, num_workers</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;producer: starting&#x27;</span>)</span><br><span class="line">    <span class="comment"># 向队列中添加一些数据</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_workers * <span class="number">3</span>):</span><br><span class="line">        <span class="comment"># 因为Queue长度为2,所以,当第三次的时候,就会await了(前两次不会)</span></span><br><span class="line">        <span class="keyword">await</span> q.put(i)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;producer: added task &#123;&#125; to the queue&#x27;</span>.<span class="built_in">format</span>(i))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 通过 None 这个特殊值来通知消费者退出</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;producer: adding stop signals to the queue&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_workers):</span><br><span class="line">        <span class="keyword">await</span> q.put(<span class="literal">None</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;producer: waiting for queue to empty&#x27;</span>)</span><br><span class="line">    <span class="keyword">await</span> q.join()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;producer: ending&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">loop, num_consumers</span>):</span></span><br><span class="line">    <span class="comment"># 创建指定大小的队列，这样的话生产者将会阻塞</span></span><br><span class="line">    <span class="comment"># 直到有消费者获取数据</span></span><br><span class="line">    q = asyncio.Queue(maxsize=num_consumers)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 调度消费者</span></span><br><span class="line">    consumers = [</span><br><span class="line">        loop.create_task(consumer(i, q))</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_consumers)</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 调度生产者</span></span><br><span class="line">    prod = loop.create_task(producer(q, num_consumers))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 等待所有 coroutines 都完成</span></span><br><span class="line">    <span class="keyword">await</span> asyncio.wait(consumers + [prod])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">event_loop = asyncio.get_event_loop()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    event_loop.run_until_complete(main(event_loop, <span class="number">2</span>))</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    event_loop.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># consumer 0: waiting for item</span></span><br><span class="line"><span class="comment"># consumer 0: waiting for item</span></span><br><span class="line"><span class="comment"># consumer 1: waiting for item</span></span><br><span class="line"><span class="comment"># consumer 1: waiting for item</span></span><br><span class="line"><span class="comment"># producer: starting</span></span><br><span class="line"><span class="comment"># producer: added task 0 to the queue</span></span><br><span class="line"><span class="comment"># producer: added task 1 to the queue</span></span><br><span class="line"><span class="comment"># consumer 0: has item 0</span></span><br><span class="line"><span class="comment"># consumer 1: has item 1</span></span><br><span class="line"><span class="comment"># producer: added task 2 to the queue</span></span><br><span class="line"><span class="comment"># producer: added task 3 to the queue</span></span><br><span class="line"><span class="comment"># consumer 0: waiting for item</span></span><br><span class="line"><span class="comment"># consumer 0: has item 2</span></span><br><span class="line"><span class="comment"># producer: added task 4 to the queue</span></span><br><span class="line"><span class="comment"># consumer 1: waiting for item</span></span><br><span class="line"><span class="comment"># consumer 1: has item 3</span></span><br><span class="line"><span class="comment"># producer: added task 5 to the queue</span></span><br><span class="line"><span class="comment"># producer: adding stop signals to the queue</span></span><br><span class="line"><span class="comment"># consumer 0: waiting for item</span></span><br><span class="line"><span class="comment"># consumer 0: has item 4</span></span><br><span class="line"><span class="comment"># consumer 1: waiting for item</span></span><br><span class="line"><span class="comment"># consumer 1: has item 5</span></span><br><span class="line"><span class="comment"># producer: waiting for queue to empty</span></span><br><span class="line"><span class="comment"># consumer 0: waiting for item</span></span><br><span class="line"><span class="comment"># consumer 0: has item None</span></span><br><span class="line"><span class="comment"># consumer 0: ending</span></span><br><span class="line"><span class="comment"># consumer 1: waiting for item</span></span><br><span class="line"><span class="comment"># consumer 1: has item None</span></span><br><span class="line"><span class="comment"># consumer 1: ending</span></span><br><span class="line"><span class="comment"># producer: ending </span></span><br></pre></td></tr></table></figure>







































</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>