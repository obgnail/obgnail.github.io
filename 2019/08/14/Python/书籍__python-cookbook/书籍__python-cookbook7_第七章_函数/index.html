<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;第七章：函数&quot;&gt;&lt;a href=&quot;#第七章：函数&quot; class=&quot;headerlink&quot; title=&quot;第七章：函数&quot;&gt;&lt;/a&gt;第七章：函数&lt;/h2&gt;&lt;h3 id=&quot;7-1-可接受任意数量参数的函数&quot;&gt;&lt;a href=&quot;#7-1-可接受任意数量参数的函数&quot; class=&quot;headerlink&quot; title=&quot;7.1 可接受任意数量参数的函数&quot;&gt;&lt;/a&gt;7.1 可接受任意数量参数的函数&lt;/h3&gt;&lt;p&gt;以使用 * 参数。"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>python-cookbook7_第七章_函数 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Python/" rel="tag">Python</a></div><div class="post-time">2019-08-14</div></div></div><div class="container post-header"><h1>python-cookbook7_第七章_函数</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%83%E7%AB%A0%EF%BC%9A%E5%87%BD%E6%95%B0"><span class="toc-number">1.</span> <span class="toc-text">第七章：函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E5%8F%AF%E6%8E%A5%E5%8F%97%E4%BB%BB%E6%84%8F%E6%95%B0%E9%87%8F%E5%8F%82%E6%95%B0%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.</span> <span class="toc-text">7.1 可接受任意数量参数的函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E5%8F%AA%E6%8E%A5%E5%8F%97%E5%85%B3%E9%94%AE%E5%AD%97%E5%8F%82%E6%95%B0%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.</span> <span class="toc-text">7.2 只接受关键字参数的函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-%E7%BB%99%E5%87%BD%E6%95%B0%E5%8F%82%E6%95%B0%E5%A2%9E%E5%8A%A0%E5%85%83%E4%BF%A1%E6%81%AF"><span class="toc-number">1.3.</span> <span class="toc-text">7.3 给函数参数增加元信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-%E8%BF%94%E5%9B%9E%E5%A4%9A%E4%B8%AA%E5%80%BC%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-number">1.4.</span> <span class="toc-text">7.4 返回多个值的函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-5-%E5%AE%9A%E4%B9%89%E6%9C%89%E9%BB%98%E8%AE%A4%E5%8F%82%E6%95%B0%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-number">1.5.</span> <span class="toc-text">7.5 定义有默认参数的函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-6-%E5%AE%9A%E4%B9%89%E5%8C%BF%E5%90%8D%E6%88%96%E5%86%85%E8%81%94%E5%87%BD%E6%95%B0"><span class="toc-number">1.6.</span> <span class="toc-text">7.6 定义匿名或内联函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-7-%E5%8C%BF%E5%90%8D%E5%87%BD%E6%95%B0%E6%8D%95%E8%8E%B7%E5%8F%98%E9%87%8F%E5%80%BC-%E9%87%8D%E8%A6%81"><span class="toc-number">1.7.</span> <span class="toc-text">7.7 匿名函数捕获变量值(重要)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-8-%E5%87%8F%E5%B0%91%E5%8F%AF%E8%B0%83%E7%94%A8%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%8F%82%E6%95%B0%E4%B8%AA%E6%95%B0"><span class="toc-number">1.8.</span> <span class="toc-text">7.8 减少可调用对象的参数个数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-9-%E5%B0%86%E5%8D%95%E6%96%B9%E6%B3%95%E7%9A%84%E7%B1%BB%E8%BD%AC%E6%8D%A2%E4%B8%BA%E5%87%BD%E6%95%B0"><span class="toc-number">1.9.</span> <span class="toc-text">7.9 将单方法的类转换为函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-10-%E5%B8%A6%E9%A2%9D%E5%A4%96%E7%8A%B6%E6%80%81%E4%BF%A1%E6%81%AF%E7%9A%84%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0"><span class="toc-number">1.10.</span> <span class="toc-text">7.10 带额外状态信息的回调函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-11-%E5%86%85%E8%81%94%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0"><span class="toc-number">1.11.</span> <span class="toc-text">7.11 内联回调函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-12-%E8%AE%BF%E9%97%AE%E9%97%AD%E5%8C%85%E4%B8%AD%E5%AE%9A%E4%B9%89%E7%9A%84%E5%8F%98%E9%87%8F"><span class="toc-number">1.12.</span> <span class="toc-text">7.12 访问闭包中定义的变量</span></a></li></ol></li></ol></details></div><div class="container post-content"><h2 id="第七章：函数"><a href="#第七章：函数" class="headerlink" title="第七章：函数"></a>第七章：函数</h2><h3 id="7-1-可接受任意数量参数的函数"><a href="#7-1-可接受任意数量参数的函数" class="headerlink" title="7.1 可接受任意数量参数的函数"></a>7.1 可接受任意数量参数的函数</h3><p>以使用 * 参数。</p>
<p>以 ** 开头的参数</p>
<h3 id="7-2-只接受关键字参数的函数"><a href="#7-2-只接受关键字参数的函数" class="headerlink" title="7.2 只接受关键字参数的函数"></a>7.2 只接受关键字参数的函数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">a</span>(<span class="params">x, *args, y</span>):</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>此时的y称为<code>强制关键字参数</code></p>
<h3 id="7-3-给函数参数增加元信息"><a href="#7-3-给函数参数增加元信息" class="headerlink" title="7.3 给函数参数增加元信息"></a>7.3 给函数参数增加元信息</h3><p>使用函数参数注解</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x:<span class="built_in">int</span>, y:<span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br></pre></td></tr></table></figure>

<p>函数注解只存储在函数的 <code>__annotations__ </code>属性</p>
<h3 id="7-4-返回多个值的函数"><a href="#7-4-返回多个值的函数" class="headerlink" title="7.4 返回多个值的函数"></a>7.4 返回多个值的函数</h3><p>函数直接 return 一个元组就行了</p>
<h3 id="7-5-定义有默认参数的函数"><a href="#7-5-定义有默认参数的函数" class="headerlink" title="7.5 定义有默认参数的函数"></a>7.5 定义有默认参数的函数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">spam</span>(<span class="params">a, b=<span class="number">42</span></span>):</span></span><br><span class="line">    <span class="built_in">print</span>(a, b)</span><br></pre></td></tr></table></figure>

<p>检查默认参数有没有值传进来</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">_no_value = <span class="built_in">object</span>()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">a,b=_no_value</span>):</span></span><br><span class="line">	<span class="keyword">if</span> b <span class="keyword">is</span> _no_value:</span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&#x27;b 没有被传进来&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">func(<span class="number">1</span>) <span class="comment"># b 没有被传进来</span></span><br><span class="line">func(<span class="number">1</span>,<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>object 是 python 中所有类的基类。</li>
<li>你可以创建 object 类的实例，但是这些实例没什么实际用处，因为它并没有任何有用的方法，也没有任何实例数据</li>
<li>因为它没有任何的实例字典，<strong>你甚至都不能设置任何属性值</strong></li>
<li>==object()唯一能做的就是测试同一性==。</li>
</ul>
</blockquote>
<h3 id="7-6-定义匿名或内联函数"><a href="#7-6-定义匿名或内联函数" class="headerlink" title="7.6 定义匿名或内联函数"></a>7.6 定义匿名或内联函数</h3><p>lambda 表达式</p>
<h3 id="7-7-匿名函数捕获变量值-重要"><a href="#7-7-匿名函数捕获变量值-重要" class="headerlink" title="7.7 匿名函数捕获变量值(重要)"></a>7.7 匿名函数捕获变量值(重要)</h3><blockquote>
<p>注意:</p>
<ul>
<li>python普通函数的默认值在定义时绑定</li>
<li>lambda 表达式的变量是自由变量，<strong>在运行时绑定值</strong>，而不是定义时就绑定</li>
<li>两者完全相反</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 普通函数的默认值在定义时绑定</span></span><br><span class="line"><span class="comment"># 所以y的默认值为1</span></span><br><span class="line">x = <span class="number">1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">y=x</span>):</span></span><br><span class="line">	<span class="built_in">print</span>(y)</span><br><span class="line">x = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">func() <span class="comment"># 1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 因为lambda在运行时绑定</span></span><br><span class="line"><span class="comment"># 所以x=2</span></span><br><span class="line">x = <span class="number">1</span></span><br><span class="line">func = <span class="keyword">lambda</span> y : x + y</span><br><span class="line">x = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(func(<span class="number">10</span>)) <span class="comment"># 12</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>lambda使用默认值:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">func = <span class="keyword">lambda</span> x=<span class="number">1</span> :x + <span class="number">5</span></span><br><span class="line"><span class="built_in">print</span>(func())  <span class="comment"># 6</span></span><br></pre></td></tr></table></figure>

<p><strong>通过使用函数默认值参数形式，lambda 函数在定义时就能绑定到值</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">funcs = [<span class="keyword">lambda</span> x: x+n <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)]</span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> funcs:</span><br><span class="line">	 <span class="built_in">print</span>(f(<span class="number">0</span>))</span><br><span class="line"><span class="comment"># 4</span></span><br><span class="line"><span class="comment"># 4</span></span><br><span class="line"><span class="comment"># 4</span></span><br><span class="line"><span class="comment"># 4</span></span><br><span class="line"><span class="comment"># 4</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">funcs = [<span class="keyword">lambda</span> x, n=n: x+n <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)]</span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> funcs:</span><br><span class="line">	 <span class="built_in">print</span>(f(<span class="number">0</span>))</span><br><span class="line"><span class="comment"># 0</span></span><br><span class="line"><span class="comment"># 1</span></span><br><span class="line"><span class="comment"># 2</span></span><br><span class="line"><span class="comment"># 3</span></span><br><span class="line"><span class="comment"># 4</span></span><br></pre></td></tr></table></figure>



<h3 id="7-8-减少可调用对象的参数个数"><a href="#7-8-减少可调用对象的参数个数" class="headerlink" title="7.8 减少可调用对象的参数个数"></a>7.8 减少可调用对象的参数个数</h3><p>使用 functools.partial() 。</p>
<p>functools.partial()经常用来<strong>绑定回调函数</strong> :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">output_result</span>(<span class="params">result, log=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> log:</span><br><span class="line">        log.debug(<span class="string">&#x27;Got: %r&#x27;</span>, result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x, y</span>):</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    logging.basicConfig(level=logging.DEBUG)</span><br><span class="line">    log = logging.getLogger(<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    p = Pool()</span><br><span class="line">    <span class="comment"># 通过使用 partial() 传递额外的 logging参数。</span></span><br><span class="line">    p.apply_async(add, (<span class="number">3</span>, <span class="number">4</span>), callback=partial(output_result, log=log))</span><br><span class="line">    p.close()</span><br><span class="line">    p.join()</span><br><span class="line"><span class="comment"># DE<span class="doctag">BUG:</span>test:Got: 7</span></span><br></pre></td></tr></table></figure>

<p><strong>很多时候 partial() 能实现的效果，lambda 表达式也能实现</strong>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p.apply_async(add, (<span class="number">3</span>, <span class="number">4</span>), callback=<span class="keyword">lambda</span> result: output_result(result,log))</span><br></pre></td></tr></table></figure>



<h3 id="7-9-将单方法的类转换为函数"><a href="#7-9-将单方法的类转换为函数" class="headerlink" title="7.9 将单方法的类转换为函数"></a>7.9 将单方法的类转换为函数</h3><p>使用闭包来将单个方法的类转换成函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlopen</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UrlTemplate</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, template</span>):</span></span><br><span class="line">		self.template = template</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">open</span>(<span class="params">self, **kwargs</span>):</span></span><br><span class="line">		<span class="keyword">return</span> urlopen(self.template.format_map(kwargs))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 转为闭包</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">urltemplate</span>(<span class="params">template</span>):</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">opener</span>(<span class="params">**kwargs</span>):</span></span><br><span class="line">		<span class="keyword">return</span> urlopen(template.format_map(kwargs))</span><br><span class="line">	<span class="keyword">return</span> opener</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>大部分情况下，你拥有一个单方法类的原因是<strong>需要存储某些额外的状态来给方法</strong><br><strong>使用。</strong></li>
<li>比如，定义 UrlTemplate 类的唯一目的就是先在某个地方存储模板值，以便将来可以在 open() 方法中使用。</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>简单来讲，一个闭包就是一个函数，只不过在函数内部带上了一个额外的变量环境。</li>
<li>闭包关键特点就是<strong>它会记住自己被定义时的环境</strong>。</li>
</ul>
</blockquote>
<h3 id="7-10-带额外状态信息的回调函数"><a href="#7-10-带额外状态信息的回调函数" class="headerlink" title="7.10 带额外状态信息的回调函数"></a>7.10 带额外状态信息的回调函数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">apply_async</span>(<span class="params">func, args, *, callback</span>):</span></span><br><span class="line">	result = func(*args)</span><br><span class="line">	callback(result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_result</span>(<span class="params">result</span>):</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&#x27;Got:&#x27;</span>, result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x, y</span>):</span></span><br><span class="line">	<span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line">apply_async(add, (<span class="number">2</span>, <span class="number">3</span>), callback=print_result)</span><br><span class="line"><span class="comment"># Got: 5</span></span><br><span class="line">apply_async(add, (<span class="string">&#x27;hello&#x27;</span>, <span class="string">&#x27;world&#x27;</span>), callback=print_result)</span><br><span class="line"><span class="comment"># Got: helloworld</span></span><br></pre></td></tr></table></figure>

<p>为了让回调函数访问外部信息，一种方法是使用一个绑定方法来代替一个简单函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResultHandler</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.sequence = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handler</span>(<span class="params">self, result</span>):</span></span><br><span class="line">        self.sequence += <span class="number">1</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;[&#123;&#125;] Got: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(self.sequence, result))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">apply_async</span>(<span class="params">func, args, *, callback</span>):</span></span><br><span class="line">    result = func(*args)</span><br><span class="line">    callback(result)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x, y</span>):</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r = ResultHandler()</span><br><span class="line">apply_async(add, (<span class="number">2</span>, <span class="number">3</span>), callback=r.handler)</span><br><span class="line"><span class="comment"># [1] Got: 5</span></span><br><span class="line">apply_async(add, (<span class="string">&#x27;hello&#x27;</span>, <span class="string">&#x27;world&#x27;</span>), callback=r.handler)</span><br><span class="line"><span class="comment"># [2] Got: helloworld</span></span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>至少有两种主要方式来捕获和保存状态信息，</li>
<li>在一个对象实例 (通过一个绑定方法) 或者在一个闭包中保存它。</li>
<li>两种方式相比，闭包或许是更加轻量级和自然一点，因为它们可以很简单的通过函数来构造。它们还能自动捕获所有被使用到的变量。因此，你无需去担心如何去存储额外的状态信息 (代码中自动判定)。</li>
<li>更高级的方式是使用协程</li>
</ul>
</blockquote>
<h3 id="7-11-内联回调函数"><a href="#7-11-内联回调函数" class="headerlink" title="7.11 内联回调函数"></a>7.11 内联回调函数</h3><p>回调函数很容易弄乱程序控制流。你希望找到某个方法来让代码看上去更像是一个普通的执行序列。</p>
<p><strong>使用生成器和协程可以使得回调函数内联在某个函数中</strong>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">apply_async</span>(<span class="params">func, args, *, callback</span>):</span></span><br><span class="line">	result = func(*args)</span><br><span class="line">	callback(result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Async</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, func, args</span>):</span></span><br><span class="line">		self.func = func</span><br><span class="line">		self.args = args</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">inlined_async</span>(<span class="params">func</span>):</span></span><br><span class="line"><span class="meta">	@wraps(<span class="params">func</span>)</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args</span>):</span></span><br><span class="line">		f = func(*args)</span><br><span class="line">		result_queue = Queue()</span><br><span class="line">		result_queue.put(<span class="literal">None</span>)</span><br><span class="line">		<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">			<span class="built_in">print</span>(<span class="string">&#x27;------------&#x27;</span>)</span><br><span class="line">			result = result_queue.get()</span><br><span class="line">			<span class="keyword">try</span>:</span><br><span class="line">				<span class="built_in">print</span>(<span class="string">&#x27;************&#x27;</span>,result)</span><br><span class="line">				a = f.send(result)</span><br><span class="line">				<span class="built_in">print</span>(<span class="string">&#x27;++++++++++++++++&#x27;</span>,a)</span><br><span class="line">				apply_async(a.func, a.args, callback=result_queue.put)</span><br><span class="line">			<span class="keyword">except</span> StopIteration:</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x, y</span>):</span></span><br><span class="line">	<span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"><span class="meta">@inlined_async</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&#x27;///////&#x27;</span>)</span><br><span class="line">	r = <span class="keyword">yield</span> Async(add, (<span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&#x27;111111111&#x27;</span>,r)</span><br><span class="line">	<span class="built_in">print</span>(r)</span><br><span class="line">	r = <span class="keyword">yield</span> Async(add, (<span class="string">&#x27;hello&#x27;</span>, <span class="string">&#x27;world&#x27;</span>))</span><br><span class="line">	<span class="built_in">print</span>(r)</span><br><span class="line">	<span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">		r = <span class="keyword">yield</span> Async(add, (n, n))</span><br><span class="line">		<span class="built_in">print</span>(r)</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&#x27;Goodbye&#x27;</span>)</span><br><span class="line"></span><br><span class="line">test()</span><br><span class="line"><span class="comment"># ------------</span></span><br><span class="line"><span class="comment"># ************ None</span></span><br><span class="line"><span class="comment"># ///////</span></span><br><span class="line"><span class="comment"># ++++++++++++++++ &lt;__main__.Async object at 0x0000020144B22E48&gt;</span></span><br><span class="line"><span class="comment"># ------------</span></span><br><span class="line"><span class="comment"># ************ 5</span></span><br><span class="line"><span class="comment"># 111111111 5</span></span><br><span class="line"><span class="comment"># 5</span></span><br><span class="line"><span class="comment"># ++++++++++++++++ &lt;__main__.Async object at 0x0000020144B28320&gt;</span></span><br><span class="line"><span class="comment"># ------------</span></span><br><span class="line"><span class="comment"># ************ helloworld</span></span><br><span class="line"><span class="comment"># helloworld</span></span><br><span class="line"><span class="comment"># ++++++++++++++++ &lt;__main__.Async object at 0x0000020144B22E48&gt;</span></span><br><span class="line"><span class="comment"># ------------</span></span><br><span class="line"><span class="comment"># ************ 0</span></span><br><span class="line"><span class="comment"># 0</span></span><br><span class="line"><span class="comment"># ++++++++++++++++ &lt;__main__.Async object at 0x0000020144B28320&gt;</span></span><br><span class="line"><span class="comment"># ------------</span></span><br><span class="line"><span class="comment"># ************ 2</span></span><br><span class="line"><span class="comment"># 2</span></span><br><span class="line"><span class="comment"># ++++++++++++++++ &lt;__main__.Async object at 0x0000020144B22E48&gt;</span></span><br><span class="line"><span class="comment"># ------------</span></span><br><span class="line"><span class="comment"># ************ 4</span></span><br><span class="line"><span class="comment"># 4</span></span><br><span class="line"><span class="comment"># ++++++++++++++++ &lt;__main__.Async object at 0x0000020144B28320&gt;</span></span><br><span class="line"><span class="comment"># ------------</span></span><br><span class="line"><span class="comment"># ************ 6</span></span><br><span class="line"><span class="comment"># 6</span></span><br><span class="line"><span class="comment"># ++++++++++++++++ &lt;__main__.Async object at 0x0000020144B22E48&gt;</span></span><br><span class="line"><span class="comment"># ------------</span></span><br><span class="line"><span class="comment"># ************ 8</span></span><br><span class="line"><span class="comment"># 8</span></span><br><span class="line"><span class="comment"># ++++++++++++++++ &lt;__main__.Async object at 0x0000020144B28320&gt;</span></span><br><span class="line"><span class="comment"># ------------</span></span><br><span class="line"><span class="comment"># ************ 10</span></span><br><span class="line"><span class="comment"># 10</span></span><br><span class="line"><span class="comment"># ++++++++++++++++ &lt;__main__.Async object at 0x0000020144B22E48&gt;</span></span><br><span class="line"><span class="comment"># ------------</span></span><br><span class="line"><span class="comment"># ************ 12</span></span><br><span class="line"><span class="comment"># 12</span></span><br><span class="line"><span class="comment"># ++++++++++++++++ &lt;__main__.Async object at 0x0000020144B28320&gt;</span></span><br><span class="line"><span class="comment"># ------------</span></span><br><span class="line"><span class="comment"># ************ 14</span></span><br><span class="line"><span class="comment"># 14</span></span><br><span class="line"><span class="comment"># ++++++++++++++++ &lt;__main__.Async object at 0x0000020144B22E48&gt;</span></span><br><span class="line"><span class="comment"># ------------</span></span><br><span class="line"><span class="comment"># ************ 16</span></span><br><span class="line"><span class="comment"># 16</span></span><br><span class="line"><span class="comment"># ++++++++++++++++ &lt;__main__.Async object at 0x0000020144B28320&gt;</span></span><br><span class="line"><span class="comment"># ------------</span></span><br><span class="line"><span class="comment"># ************ 18</span></span><br><span class="line"><span class="comment"># 18</span></span><br><span class="line"><span class="comment"># Goodbye</span></span><br></pre></td></tr></table></figure>



<h3 id="7-12-访问闭包中定义的变量"><a href="#7-12-访问闭包中定义的变量" class="headerlink" title="7.12 访问闭包中定义的变量"></a>7.12 访问闭包中定义的变量</h3><p>通常来讲，闭包的内部变量对于外界来讲是完全隐藏的。<br>但是，你可以通过<strong>编写访问函数并将其作为函数属性绑定到闭包上</strong>来实现这个目的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sample</span>():</span></span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">func</span>():</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;n=&#x27;</span>, n)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_n</span>():</span></span><br><span class="line">        <span class="keyword">return</span> n</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_n</span>(<span class="params">value</span>):</span></span><br><span class="line">        <span class="keyword">nonlocal</span> n</span><br><span class="line">        n = value</span><br><span class="line"></span><br><span class="line">    func.get_n = get_n</span><br><span class="line">    func.set_n = set_n</span><br><span class="line">    <span class="keyword">return</span> func</span><br><span class="line"></span><br><span class="line">f = sample()</span><br><span class="line">f()  <span class="comment"># n= 0</span></span><br><span class="line"></span><br><span class="line">f.set_n(<span class="number">10</span>)</span><br><span class="line">f()  <span class="comment"># n= 10</span></span><br></pre></td></tr></table></figure>

<p>甚至你还可以将它们封装成一个类:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClosureInstance</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, <span class="built_in">locals</span>=<span class="literal">None</span></span>):</span></span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">locals</span> <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">			<span class="built_in">locals</span> = sys._getframe(<span class="number">1</span>).f_locals</span><br><span class="line">		<span class="comment"># Update instance dictionary with callables</span></span><br><span class="line">		self.__dict__.update((key,value) <span class="keyword">for</span> key, value <span class="keyword">in</span> <span class="built_in">locals</span>.items() <span class="keyword">if</span> <span class="built_in">callable</span>(value))</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__len__</span>(<span class="params">self</span>):</span></span><br><span class="line">		<span class="keyword">return</span> self.__dict__[<span class="string">&#x27;__len__&#x27;</span>]()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Stack</span>():</span></span><br><span class="line">	items = []</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">push</span>(<span class="params">item</span>):</span></span><br><span class="line">		items.append(item)</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">pop</span>():</span></span><br><span class="line">		<span class="keyword">return</span> items.pop()</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__len__</span>():</span></span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">len</span>(items)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ClosureInstance()</span><br><span class="line"></span><br><span class="line">s = Stack()</span><br><span class="line">s.push(<span class="number">10</span>)</span><br><span class="line">s.push(<span class="number">20</span>)</span><br><span class="line">s.push(<span class="string">&#x27;Hello&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(s))<span class="comment"># 3</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(s.pop())<span class="comment"># Hello</span></span><br><span class="line"><span class="built_in">print</span>(s.pop())<span class="comment"># 20</span></span><br><span class="line"><span class="built_in">print</span>(s.pop())<span class="comment"># 10</span></span><br></pre></td></tr></table></figure>









</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>