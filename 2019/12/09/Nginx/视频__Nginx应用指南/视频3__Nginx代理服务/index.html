<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;Nginx代理服务&quot;&gt;&lt;a href=&quot;#Nginx代理服务&quot; class=&quot;headerlink&quot; title=&quot;Nginx代理服务&quot;&gt;&lt;/a&gt;Nginx代理服务&lt;/h1&gt;&lt;ol&gt;
&lt;li&gt;Nginx代理服务概述&lt;ul&gt;
&lt;li&gt;Nginx代理配置语法&lt;/li&gt;
&lt;li&gt;Nginx正向代理示例&lt;/li&gt;
&lt;li&gt;Nginx反向代理示例&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Nginx负载均衡&lt;ul&gt;
&lt;li&gt;Nginx负载均衡配置场景&lt;/li&gt;
&lt;li&gt;Nginx负载均衡状态配置&lt;/li&gt;
&lt;li&gt;Nginx负载均衡调度策略&lt;/li&gt;
&lt;li&gt;Nginx负载均衡TCP配置&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Nginx动静分离&lt;ul&gt;
&lt;li&gt;Nginx动静分离应⽤案例&lt;/li&gt;
&lt;li&gt;Nginx⼿机电脑应⽤案例&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;总结&quot;&gt;&lt;a href=&quot;#总结&quot; class=&quot;headerlink&quot; title=&quot;总结&quot;&gt;&lt;/a&gt;总结&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;按照范围划分 : &lt;code&gt;gslb&lt;/code&gt;和&lt;code&gt;slb&lt;/code&gt;(调度节点和应用节点在同内网段 ,常用)&lt;/li&gt;
&lt;li&gt;按照层级划分 : &lt;code&gt;4层(代理端口)&lt;/code&gt;和&lt;code&gt;7层(http,应用层转发)&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;调度算法 : &lt;code&gt;轮询&lt;/code&gt; , &lt;code&gt;加权轮询&lt;/code&gt; , &lt;code&gt;ip_hash&lt;/code&gt; , &lt;code&gt;url_hash&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;节点状态 : &lt;code&gt;提供支持&lt;/code&gt; , &lt;code&gt;提供备份&lt;/code&gt; , &lt;code&gt;不使用&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;负载均衡 : &lt;code&gt;动静分离&lt;/code&gt; , &lt;code&gt;按浏览器类型划分&lt;/code&gt; , &lt;code&gt;按手机类型划分&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;代理复习&quot;&gt;&lt;a href=&quot;#代理复习&quot; class=&quot;headerlink&quot; title=&quot;代理复习&quot;&gt;&lt;/a&gt;代理复习&lt;/h2&gt;&lt;p&gt;Nginx 作为代理服务可以实现很多的协议代理, 我们主要以 http 代理为主"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>Nginx代理服务 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Nginx/" rel="tag">Nginx</a></div><div class="post-time">2019-12-09</div></div></div><div class="container post-header"><h1>Nginx代理服务</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.</span> <span class="toc-text">Nginx代理服务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.1.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E5%A4%8D%E4%B9%A0"><span class="toc-number">1.2.</span> <span class="toc-text">代理复习</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86-%E5%86%85%E9%83%A8%E4%B8%8A%E2%BD%B9"><span class="toc-number">1.2.1.</span> <span class="toc-text">正向代理(内部上⽹)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">1.2.2.</span> <span class="toc-text">反向代理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE%E8%AF%AD%E6%B3%95"><span class="toc-number">1.3.</span> <span class="toc-text">Nginx代理配置语法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B1%BB%E4%BC%BC%E4%BA%8E-nopush-%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="toc-number">1.4.</span> <span class="toc-text">类似于 nopush 缓冲区</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%B3%E8%BD%AC%E9%87%8D%E5%AE%9A%E5%90%91"><span class="toc-number">1.5.</span> <span class="toc-text">跳转重定向</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%B4%E4%BF%A1%E6%81%AF"><span class="toc-number">1.6.</span> <span class="toc-text">头信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E5%88%B0%E5%90%8E%E7%AB%AF%E7%9A%84-TCP-%E8%BF%9E%E6%8E%A5%E8%B6%85%E6%97%B6"><span class="toc-number">1.7.</span> <span class="toc-text">代理到后端的 TCP 连接超时</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Proxy-%E5%B8%B8%E2%BB%85%E9%85%8D%E7%BD%AE%E9%A1%B9%E5%85%B7%E4%BD%93%E9%85%8D%E7%BD%AE"><span class="toc-number">1.8.</span> <span class="toc-text">Proxy 常⻅配置项具体配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">1.9.</span> <span class="toc-text">Nginx正向代理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.10.</span> <span class="toc-text">Nginx反向代理示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.11.</span> <span class="toc-text">Nginx负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%8C%89%E8%8C%83%E5%9B%B4%E5%88%92%E5%88%86"><span class="toc-number">1.11.1.</span> <span class="toc-text">负载均衡按范围划分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%8C%89%E5%B1%82%E7%BA%A7%E5%88%92%E5%88%86"><span class="toc-number">1.11.2.</span> <span class="toc-text">负载均衡按层级划分</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%85%8D%E7%BD%AE%E5%9C%BA%E6%99%AF"><span class="toc-number">1.12.</span> <span class="toc-text">Nginx负载均衡配置场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E5%92%8C%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">1.12.1.</span> <span class="toc-text">代理和负载均衡的区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx-upstream-%E8%99%9A%E6%8B%9F%E9%85%8D%E7%BD%AE%E8%AF%AD%E6%B3%95"><span class="toc-number">1.12.2.</span> <span class="toc-text">Nginx upstream 虚拟配置语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%8A%B6%E6%80%81%E9%85%8D%E7%BD%AE"><span class="toc-number">1.12.3.</span> <span class="toc-text">Nginx负载均衡状态配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5"><span class="toc-number">1.12.4.</span> <span class="toc-text">Nginx负载均衡调度策略</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1TCP%E9%85%8D%E7%BD%AE"><span class="toc-number">1.13.</span> <span class="toc-text">Nginx负载均衡TCP配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB"><span class="toc-number">1.14.</span> <span class="toc-text">Nginx动静分离</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E2%BC%BF%E6%9C%BA%E7%94%B5%E8%84%91%E5%BA%94%E2%BD%A4%E6%A1%88%E4%BE%8B"><span class="toc-number">1.15.</span> <span class="toc-text">Nginx⼿机电脑应⽤案例</span></a></li></ol></li></ol></details></div><div class="container post-content"><h1 id="Nginx代理服务"><a href="#Nginx代理服务" class="headerlink" title="Nginx代理服务"></a>Nginx代理服务</h1><ol>
<li>Nginx代理服务概述<ul>
<li>Nginx代理配置语法</li>
<li>Nginx正向代理示例</li>
<li>Nginx反向代理示例</li>
</ul>
</li>
<li>Nginx负载均衡<ul>
<li>Nginx负载均衡配置场景</li>
<li>Nginx负载均衡状态配置</li>
<li>Nginx负载均衡调度策略</li>
<li>Nginx负载均衡TCP配置</li>
</ul>
</li>
<li>Nginx动静分离<ul>
<li>Nginx动静分离应⽤案例</li>
<li>Nginx⼿机电脑应⽤案例</li>
</ul>
</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>按照范围划分 : <code>gslb</code>和<code>slb</code>(调度节点和应用节点在同内网段 ,常用)</li>
<li>按照层级划分 : <code>4层(代理端口)</code>和<code>7层(http,应用层转发)</code></li>
<li>调度算法 : <code>轮询</code> , <code>加权轮询</code> , <code>ip_hash</code> , <code>url_hash</code></li>
<li>节点状态 : <code>提供支持</code> , <code>提供备份</code> , <code>不使用</code></li>
<li>负载均衡 : <code>动静分离</code> , <code>按浏览器类型划分</code> , <code>按手机类型划分</code></li>
</ul>
<h2 id="代理复习"><a href="#代理复习" class="headerlink" title="代理复习"></a>代理复习</h2><p>Nginx 作为代理服务可以实现很多的协议代理, 我们主要以 http 代理为主</p>
<p><img src="/images/1575705252430.png" alt="1575705252430"></p>
<h3 id="正向代理-内部上⽹"><a href="#正向代理-内部上⽹" class="headerlink" title="正向代理(内部上⽹)"></a>正向代理(内部上⽹)</h3><p> 客户端&lt;–&gt;代理-&gt;服务端</p>
<p><img src="/images/1575705307271.png" alt="1575705307271"></p>
<h3 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h3><p>客户端-&gt;代理&lt;–&gt;服务端</p>
<p><img src="/images/1575705331731.png" alt="1575705331731"></p>
<p>代理区别 , 区别在于代理的对象不⼀样:</p>
<ul>
<li>正向代理代理的对象是客户端</li>
<li>反向代理代理的对象是服务端</li>
</ul>
<h2 id="Nginx代理配置语法"><a href="#Nginx代理配置语法" class="headerlink" title="Nginx代理配置语法"></a>Nginx代理配置语法</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: proxy_pass URL;</span><br><span class="line">Default: —</span><br><span class="line">Context: location, if in location, limit_except</span><br></pre></td></tr></table></figure>

<p>url举例 :</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://localhost:8000/uri/">http://localhost:8000/uri/</a></li>
<li><a target="_blank" rel="noopener" href="http://192.168.56.11:8000/uri/">http://192.168.56.11:8000/uri/</a></li>
<li><a target="_blank" rel="noopener" href="http://unix/tmp/backend.socket:/uri/">http://unix:/tmp/backend.socket:/uri/</a></li>
</ul>
<h2 id="类似于-nopush-缓冲区"><a href="#类似于-nopush-缓冲区" class="headerlink" title="类似于 nopush 缓冲区"></a>类似于 nopush 缓冲区</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 尽可能收集所有头请求,	</span></span><br><span class="line">Syntax: proxy_buffering on | off;</span><br><span class="line">Default:	</span><br><span class="line">proxy_buffering on;</span><br><span class="line">Context: http, server, location</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 扩展:</span></span><br><span class="line">proxy_buffer_size	</span><br><span class="line">proxy_buffers	</span><br><span class="line">proxy_busy_buffer_size</span><br></pre></td></tr></table></figure>



<h2 id="跳转重定向"><a href="#跳转重定向" class="headerlink" title="跳转重定向"></a>跳转重定向</h2><p>在代理之后 ,去拿资源的时候,资源做一个301的跳转 , 此配置基本不用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax: proxy_redirect default;</span><br><span class="line">proxy_redirect off;proxy_redirect redirect replacement;</span><br><span class="line">Default: proxy_redirect default;</span><br><span class="line">Context: http, server, location</span><br></pre></td></tr></table></figure>



<h2 id="头信息"><a href="#头信息" class="headerlink" title="头信息"></a>头信息</h2><ul>
<li>客户端通过代理 , 访问服务端 </li>
<li>那么服务端如何知道服务端的真实地址呢 ? 使用<code>头信息</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax: proxy_set_header field value;</span><br><span class="line">Default: proxy_set_header Host $proxy_host;</span><br><span class="line">	proxy_set_header Connection close;</span><br><span class="line">Context: http, server, location</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 扩展:	</span></span><br><span class="line">proxy_hide_header</span><br><span class="line">proxy_set_body</span><br></pre></td></tr></table></figure>



<h2 id="代理到后端的-TCP-连接超时"><a href="#代理到后端的-TCP-连接超时" class="headerlink" title="代理到后端的 TCP 连接超时"></a>代理到后端的 TCP 连接超时</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: proxy_connect_timeout time;</span><br><span class="line">Default: proxy_connect_timeout 60s;</span><br><span class="line">Context: http, server, location</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 扩展</span></span><br><span class="line">proxy_read_timeout <span class="comment"># 以及建⽴</span></span><br><span class="line">proxy_send_timeout <span class="comment"># 服务端请求完, 发送给客户端时间</span></span><br></pre></td></tr></table></figure>



<h2 id="Proxy-常⻅配置项具体配置"><a href="#Proxy-常⻅配置项具体配置" class="headerlink" title="Proxy 常⻅配置项具体配置"></a>Proxy 常⻅配置项具体配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /etc/nginx/proxy_params</span></span><br><span class="line">proxy_redirect	default;</span><br><span class="line">proxy_set_header	Host	<span class="variable">$http_host</span>;</span><br><span class="line">proxy_set_header	X-Real-IP	<span class="variable">$remote_addr</span>;</span><br><span class="line">proxy_set_header	X-Forwarded-For	<span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">proxy_connect_timeout	30;</span><br><span class="line">proxy_send_timeout	60;</span><br><span class="line">proxy_read_timeout	60;</span><br><span class="line">proxy_buffer_size	32k;</span><br><span class="line">proxy_buffering	on;</span><br><span class="line">proxy_buffers	4	128k;</span><br><span class="line">proxy_busy_buffers_size	256k;</span><br><span class="line">proxy_max_temp_file_size	256k;</span><br></pre></td></tr></table></figure>

<p>具体location实现</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">	proxy_pass http://127.0.0.1:8080;</span><br><span class="line">	include proxy_params;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Nginx正向代理"><a href="#Nginx正向代理" class="headerlink" title="Nginx正向代理"></a>Nginx正向代理</h2><p>Nginx 正向代理配置实例 :</p>
<ul>
<li>服务端只允许112访问</li>
<li>客户端要想访问服务端 , 那么就要想办法让112为我代理</li>
</ul>
<p><img src="/images/1575706383176.png" alt="1575706383176"></p>
<ol>
<li><p>配置69.113访问限制,仅允许同⽹段访问</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location ~ .*\.(jpg|gif|png)$ &#123;</span><br><span class="line">	allow 192.168.69.0/24;</span><br><span class="line">	deny all;</span><br><span class="line">	root /soft/code/images;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>112配置正向代理</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server	&#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	resolver 233.5.5.5;</span><br><span class="line">	location / &#123;</span><br><span class="line">		<span class="comment"># 当有人访问112的时候,就将其转发给http://$http_host$request_uri</span></span><br><span class="line">		proxy_pass http://$http_host<span class="variable">$request_uri</span>;</span><br><span class="line">		proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">		proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">		proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>$http_host</code> : 等于 request 中 header的值 , 客户端使用代理的时候 , 需要在header里告诉代理服务器需要代理的网站 , 就放在<code>$http_host</code></li>
<li><code>$request_uri</code> : 就是请求url</li>
</ul>
</li>
</ol>
<h2 id="Nginx反向代理示例"><a href="#Nginx反向代理示例" class="headerlink" title="Nginx反向代理示例"></a>Nginx反向代理示例</h2><p><img src="/images/1575711501885.png" alt="1575711501885"></p>
<p>proxy代理 :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server	&#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name nginx.bjstack.com;</span><br><span class="line">	location / &#123;</span><br><span class="line">		proxy_pass http://192.168.56.100;</span><br><span class="line">		include proxy_params;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>WEB站点 :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">server	&#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name nginx.bjstack.com;</span><br><span class="line">	root /soft/code;</span><br><span class="line">	location / &#123;</span><br><span class="line">		root /soft/code;</span><br><span class="line">		index index.html;</span><br><span class="line">	&#125;</span><br><span class="line">	location ~ .*\.(png|jpg|gif)$ &#123;</span><br><span class="line">		gzip on;</span><br><span class="line">		root /soft/code/images;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Nginx负载均衡"><a href="#Nginx负载均衡" class="headerlink" title="Nginx负载均衡"></a>Nginx负载均衡</h2><p>提升吞吐率, 提升请求性能, 提⾼容灾</p>
<p><img src="/images/1575711742181.png" alt="1575711742181"></p>
<h3 id="负载均衡按范围划分"><a href="#负载均衡按范围划分" class="headerlink" title="负载均衡按范围划分"></a>负载均衡按范围划分</h3><ul>
<li>GSLB全局负载均衡</li>
<li>SLB</li>
</ul>
<p><img src="/images/1575711798447.png" alt="1575711798447"></p>
<p><img src="/images/1575711812895.png" alt="1575711812895"></p>
<p>GSLB和SLB最大区别就是:</p>
<ul>
<li>SLB的调度节点和服务节点在同一个机房,用同一个网络</li>
<li>GSLB调度节点和服务节点不在同一个网络中 , <code>G</code> 即<code>global</code> , 在不同地区设立了多个数据中心</li>
</ul>
<blockquote>
<p>Nginx 是⼀个典型的 <code>SLB</code></p>
</blockquote>
<h3 id="负载均衡按层级划分"><a href="#负载均衡按层级划分" class="headerlink" title="负载均衡按层级划分"></a>负载均衡按层级划分</h3><ul>
<li>四层负载均衡</li>
<li>七层负载均衡</li>
</ul>
<p><img src="/images/1575712179822.png" alt="1575712179822"></p>
<p><img src="/images/1575712190187.png" alt="1575712190187"></p>
<blockquote>
<ul>
<li>这里的四层和七层就是<code>ISO网络模型</code></li>
<li>因为Nginx一般处理的HTTP转发,HTTP是应用层 , 所以 <strong>Nginx 是⼀个典型的七层 SLB</strong></li>
<li>同理 , 为什么Nginx还可以转发邮件 , 因为邮件协议<code>SMTP</code>就是在第七层</li>
<li><code>第四层</code>就是传输层 , 因此只能转发<code>端口</code>,<code>ip</code>之类的</li>
</ul>
</blockquote>
<h2 id="Nginx负载均衡配置场景"><a href="#Nginx负载均衡配置场景" class="headerlink" title="Nginx负载均衡配置场景"></a>Nginx负载均衡配置场景</h2><p>Nginx 实现负载均衡⽤到了 <code>proxy_pass</code> 代理模块核⼼配置, <strong>将客户端请求代理转发⾄⼀组 upstream 虚拟服务池</strong></p>
<p><img src="/images/1575712572955.png" alt="1575712572955"></p>
<h3 id="代理和负载均衡的区别"><a href="#代理和负载均衡的区别" class="headerlink" title="代理和负载均衡的区别"></a>代理和负载均衡的区别</h3><ul>
<li>代理 是Nginx将请求转发给具体的IP</li>
<li>负载均衡 是Nginx将请求转发给虚拟服务池</li>
</ul>
<blockquote>
<p>举例说明就是</p>
<ul>
<li>代理 是将任务交给指定的人去做</li>
<li>负载均衡 是将任务交给一个部门去做 , 而不去管是这个部门的哪个人去做</li>
</ul>
</blockquote>
<h3 id="Nginx-upstream-虚拟配置语法"><a href="#Nginx-upstream-虚拟配置语法" class="headerlink" title="Nginx upstream 虚拟配置语法"></a>Nginx upstream 虚拟配置语法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: upstream name &#123; ... &#125;</span><br><span class="line">Default: -</span><br><span class="line">Context: http</span><br></pre></td></tr></table></figure>

<p>upstream例⼦</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">upstream my_upstream &#123;</span><br><span class="line">	server backend1.example.com weight=5;</span><br><span class="line">	server backend2.example.com:8080;</span><br><span class="line">	server unix:/tmp/backend3;</span><br><span class="line">	server backup1.example.com:8080 backup;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	location / &#123;</span><br><span class="line">		proxy_pass http://my_upstream;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样 ,就会负载均衡到<code>backend1.example.com</code>,<code>backend2.example.com:8080</code>,<code>unix:/tmp/backend3</code>,<code>backup1.example.com:8080 backup</code></p>
<h3 id="Nginx负载均衡状态配置"><a href="#Nginx负载均衡状态配置" class="headerlink" title="Nginx负载均衡状态配置"></a>Nginx负载均衡状态配置</h3><p>后端服务器在负载均衡调度中的状态</p>
<table>
<thead>
<tr>
<th>状态</th>
<th>概述</th>
</tr>
</thead>
<tbody><tr>
<td>down</td>
<td>当前的server暂时不参与负载均衡</td>
</tr>
<tr>
<td>backup</td>
<td>预留的备份服务器(当其他的都down之后才使用这个服务器)</td>
</tr>
<tr>
<td>max_fails</td>
<td>允许请求失败的次数(绑定fail_timeout使用)</td>
</tr>
<tr>
<td>fail_timeout</td>
<td>经过max_fails失败后, 服务暂停时间(绑定max_fails使用)</td>
</tr>
<tr>
<td>max_conns</td>
<td>限制最⼤的接收连接数</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upstream my_upstream &#123;</span><br><span class="line">	server backend1.example.com weight=5;</span><br><span class="line">	server backend2.example.com:8080 down ;</span><br><span class="line">	server unix:/tmp/backend3 max_fails=2 fail_timeout=5;</span><br><span class="line">	server backup1.example.com:8080 backup;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Nginx负载均衡调度策略"><a href="#Nginx负载均衡调度策略" class="headerlink" title="Nginx负载均衡调度策略"></a>Nginx负载均衡调度策略</h3><table>
<thead>
<tr>
<th>调度算法</th>
<th>概述</th>
</tr>
</thead>
<tbody><tr>
<td>轮询</td>
<td>按时间顺序逐⼀分配到不同的后端服务器(默认)</td>
</tr>
<tr>
<td>weight</td>
<td>加权轮询,weight值越⼤,分配到的访问⼏率越⾼</td>
</tr>
<tr>
<td>ip_hash</td>
<td>每个请求按访问IP的hash结果分配,这样来⾃同⼀IP的固定访问⼀个后端服务器</td>
</tr>
<tr>
<td>url_hash</td>
<td>按照访问URL的hash结果来分配请求,是每个URL定向到同⼀个后端服务器</td>
</tr>
<tr>
<td>least_conn</td>
<td>最少链接数,那个机器链接数少就分发</td>
</tr>
<tr>
<td>hash关键数值</td>
<td>hash⾃定义的key</td>
</tr>
</tbody></table>
<p>Nginx负载均衡权重轮询具体配置 :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream load_pass &#123;</span><br><span class="line">	server 192.168.56.11:8001;</span><br><span class="line">	server 192.168.56.12:8002 weight=5;</span><br><span class="line">	server 192.168.56.13:8003;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Nginx负载均衡 ip_hash 具体配置 :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upstream load_pass &#123;</span><br><span class="line">	ip_hash;</span><br><span class="line">	server 192.168.56.11:8001;</span><br><span class="line">	server 192.168.56.12:8002;</span><br><span class="line">	server 192.168.56.13:8003;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Nginx负载均衡url_hash具体配置 :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upstream load_pass &#123;</span><br><span class="line">	<span class="built_in">hash</span> <span class="variable">$request_uri</span>;</span><br><span class="line">	server 192.168.56.11:8001;</span><br><span class="line">	server 192.168.56.12:8002;</span><br><span class="line">	server 192.168.56.13:8003;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Nginx负载均衡TCP配置"><a href="#Nginx负载均衡TCP配置" class="headerlink" title="Nginx负载均衡TCP配置"></a>Nginx负载均衡TCP配置</h2><p><strong>Nginx 四层代理仅能存在于 main 段</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># stream需定义在http外层</span></span><br><span class="line">stream &#123;</span><br><span class="line">	upstream ssh_proxy &#123;</span><br><span class="line">		<span class="comment"># 代理ssh</span></span><br><span class="line">		<span class="built_in">hash</span> <span class="variable">$remote_addr</span> consistent;</span><br><span class="line">		server 192.168.56.103:22;</span><br><span class="line">	&#125;</span><br><span class="line">	upstream mysql_proxy &#123;</span><br><span class="line">		<span class="comment"># 代理mysql</span></span><br><span class="line">		<span class="built_in">hash</span> <span class="variable">$remote_addr</span> consistent;</span><br><span class="line">		server 192.168.56.103:3306;</span><br><span class="line">	&#125;</span><br><span class="line">	server &#123;</span><br><span class="line">		<span class="comment"># 有人访问6666端口,就代理到192.168.56.103的22端口(ssh)</span></span><br><span class="line">		listen 6666;</span><br><span class="line">		proxy_connect_timeout  1s;</span><br><span class="line">		proxy_timeout 300s;</span><br><span class="line">		proxy_pass ssh_proxy;</span><br><span class="line">	&#125;</span><br><span class="line">	server &#123;</span><br><span class="line">		<span class="comment"># 有人访问5555端口,就代理到192.168.56.103:3306(mysql)</span></span><br><span class="line">		listen  5555;</span><br><span class="line">		proxy_connect_timeout  1s;</span><br><span class="line">		proxy_timeout 300s;</span><br><span class="line">		proxy_pass mysql_proxy;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="Nginx动静分离"><a href="#Nginx动静分离" class="headerlink" title="Nginx动静分离"></a>Nginx动静分离</h2><ul>
<li>动静分离,通过中间件将动态请求和静态请求进⾏分离, 分离资源, 减少不必要的请求消耗, 减少请求延时。</li>
<li>好处: 动静分离后, 即使动态服务不可⽤, 但静态资源不会受到影响</li>
<li><strong>通过<code>中间件</code>将动态请求和静态请求分离</strong></li>
</ul>
<p><img src="/images/1575723809932.png" alt="1575723809932"></p>
<ul>
<li>对于动态请求 , 中间件就直接将这个请求交给程序框架</li>
<li>对于静态请求 , Nginx直接响应 , 返回数据包 . 根本<strong>没有经过程序框架</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	root /soft/code;</span><br><span class="line">	index index.html;</span><br><span class="line">	location ~ .*\.(png|jpg|gif)$ &#123;</span><br><span class="line">		gzip on;</span><br><span class="line">		root /soft/code/images;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置负载均衡代理调度, 实现访问 jsp 和 png</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">upstream static &#123;</span><br><span class="line">	server 192.168.69.113:80;</span><br><span class="line">&#125;</span><br><span class="line">upstream java &#123;</span><br><span class="line">	server 192.168.69.113:8080;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen  80;</span><br><span class="line">	server_name 192.168.69.112;</span><br><span class="line">	location / &#123;</span><br><span class="line">		root /soft/code;</span><br><span class="line">		index index.html;</span><br><span class="line">	&#125;</span><br><span class="line">	location ~ .*\.(png|jpg|gif)$ &#123;</span><br><span class="line">		proxy_pass  http://static;</span><br><span class="line">		include proxy_params;</span><br><span class="line">	&#125;</span><br><span class="line">	location ~ .*\.jsp$ &#123;</span><br><span class="line">		proxy_pass http://java;</span><br><span class="line">		include proxy_params;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Nginx⼿机电脑应⽤案例"><a href="#Nginx⼿机电脑应⽤案例" class="headerlink" title="Nginx⼿机电脑应⽤案例"></a>Nginx⼿机电脑应⽤案例</h2><p>根据不同的浏览器, 以及不同的⼿机, 访问的效果都将不⼀样。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过浏览器来分别连接不同的浏览器访问不同的效果。</span></span><br><span class="line">http &#123;</span><br><span class="line">	...</span><br><span class="line">	upstream firefox &#123;</span><br><span class="line">		server 172.31.57.133:80;</span><br><span class="line">	&#125;</span><br><span class="line">	upstream chrome &#123;</span><br><span class="line">		server 172.31.57.133:8080;</span><br><span class="line">	&#125;</span><br><span class="line">	upstream iphone &#123;</span><br><span class="line">		server 172.31.57.134:8080;</span><br><span class="line">	&#125;</span><br><span class="line">	upstream android &#123;</span><br><span class="line">		server 172.31.57.134:8081;</span><br><span class="line">	&#125;</span><br><span class="line">	upstream default &#123;</span><br><span class="line">		server 172.31.57.134:80;</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;		</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># server根据判断来访问不同的⻚⾯</span></span><br><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name www.xuliangwei.com;</span><br><span class="line">	<span class="comment">#safari浏览器访问的效果</span></span><br><span class="line">	location / &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~* <span class="string">&quot;Safari&quot;</span>)&#123;</span><br><span class="line">			proxy_pass http://dynamic_pools;</span><br><span class="line">		&#125;		</span><br><span class="line">		<span class="comment">#firefox浏览器访问效果</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~* <span class="string">&quot;Firefox&quot;</span>)&#123;</span><br><span class="line">			proxy_pass http://static_pools;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">#chrome浏览器访问效果</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~* <span class="string">&quot;Chrome&quot;</span>)&#123;</span><br><span class="line">			proxy_pass http://chrome;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">#iphone⼿机访问效果</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~* <span class="string">&quot;iphone&quot;</span>)&#123;</span><br><span class="line">			proxy_pass http://iphone;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">#android⼿机访问效果</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~* <span class="string">&quot;android&quot;</span>)&#123;</span><br><span class="line">			proxy_pass http://and;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">#其他浏览器访问默认规则</span></span><br><span class="line">		proxy_pass http://dynamic_pools;</span><br><span class="line">		include proxy.conf;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>











</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>