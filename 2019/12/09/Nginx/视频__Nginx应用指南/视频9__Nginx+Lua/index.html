<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;Nginx-Lua&quot;&gt;&lt;a href=&quot;#Nginx-Lua&quot; class=&quot;headerlink&quot; title=&quot;Nginx+Lua&quot;&gt;&lt;/a&gt;Nginx+Lua&lt;/h1&gt;&lt;ol&gt;
&lt;li&gt;Lua脚本基础语法&lt;/li&gt;
&lt;li&gt;Nginx加载Lua环境&lt;/li&gt;
&lt;li&gt;Nginx调⽤Lua指令&lt;/li&gt;
&lt;li&gt;Nginx+Lua实现代码灰度发布&lt;/li&gt;
&lt;li&gt;Nginx+Lua实现WAF应⽤防⽕墙&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Nginx+Lua优势"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>Nginx+Lua | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Nginx/" rel="tag">Nginx</a></div><div class="post-time">2019-12-09</div></div></div><div class="container post-header"><h1>Nginx+Lua</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx-Lua"><span class="toc-number">1.</span> <span class="toc-text">Nginx+Lua</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#lua%E8%84%9A%E6%9C%AC"><span class="toc-number">1.1.</span> <span class="toc-text">lua脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lua%E7%9A%84%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95%E5%A4%8D%E4%B9%A0"><span class="toc-number">1.2.</span> <span class="toc-text">Lua的基础语法复习</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%98%E9%87%8F%E5%AE%9A%E4%B9%89"><span class="toc-number">1.2.1.</span> <span class="toc-text">变量定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#while-%E5%BE%AA%E7%8E%AF%E8%AF%AD%E5%8F%A5"><span class="toc-number">1.2.2.</span> <span class="toc-text">while 循环语句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#for-%E5%BE%AA%E7%8E%AF%E8%AF%AD%E5%8F%A5"><span class="toc-number">1.2.3.</span> <span class="toc-text">for 循环语句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#if-%E5%88%A4%E6%96%AD%E8%AF%AD%E5%8F%A5"><span class="toc-number">1.2.4.</span> <span class="toc-text">if 判断语句</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E5%8A%A0%E8%BD%BDLua%E7%8E%AF%E5%A2%83"><span class="toc-number">1.3.</span> <span class="toc-text">Nginx加载Lua环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E8%B0%83%E2%BD%A4Lua%E6%8C%87%E4%BB%A4"><span class="toc-number">1.4.</span> <span class="toc-text">Nginx调⽤Lua指令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-Lua%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83"><span class="toc-number">1.5.</span> <span class="toc-text">Nginx+Lua实现代码灰度发布</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%85%8D%E7%BD%AE-Memcached-%E5%B9%B6%E8%AE%A9%E5%85%B6%E2%BD%80%E6%8C%81-Lua-%E8%B0%83%E2%BD%A4"><span class="toc-number">1.5.1.</span> <span class="toc-text">1.配置 Memcached 并让其⽀持 Lua 调⽤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%85%8D%E7%BD%AE%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E8%B0%83%E5%BA%A6"><span class="toc-number">1.5.2.</span> <span class="toc-text">2.配置负载均衡调度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%BC%96%E5%86%99-Nginx-%E8%B0%83%E2%BD%A4%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83-Lua-%E8%84%9A%E6%9C%AC"><span class="toc-number">1.5.3.</span> <span class="toc-text">3.编写 Nginx 调⽤灰度发布 Lua 脚本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-Lua%E5%AE%9E%E7%8E%B0WAF%E5%BA%94%E2%BD%A4%E9%98%B2%E2%BD%95%E5%A2%99"><span class="toc-number">1.6.</span> <span class="toc-text">Nginx+Lua实现WAF应⽤防⽕墙</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%88%AC%E2%BE%8D%E2%BE%8F%E4%B8%BA%E5%92%8C%E6%81%B6%E6%84%8F%E6%8A%93%E5%8F%96%EF%BC%8C%E8%B5%84%E6%BA%90%E7%9B%97%E5%8F%96"><span class="toc-number">1.6.1.</span> <span class="toc-text">爬⾍⾏为和恶意抓取，资源盗取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E5%8F%B0%E5%AF%86%E7%A0%81%E6%92%9E%E5%BA%93%EF%BC%8CXRF%E6%94%BB%E5%87%BB"><span class="toc-number">1.6.2.</span> <span class="toc-text">后台密码撞库，XRF攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sql%E6%B3%A8%E2%BC%8A"><span class="toc-number">1.6.3.</span> <span class="toc-text">Sql注⼊</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%B2%E2%BD%8C-CC-%E6%94%BB%E5%87%BB"><span class="toc-number">1.7.</span> <span class="toc-text">防⽌ CC 攻击</span></a></li></ol></li></ol></details></div><div class="container post-content"><h1 id="Nginx-Lua"><a href="#Nginx-Lua" class="headerlink" title="Nginx+Lua"></a>Nginx+Lua</h1><ol>
<li>Lua脚本基础语法</li>
<li>Nginx加载Lua环境</li>
<li>Nginx调⽤Lua指令</li>
<li>Nginx+Lua实现代码灰度发布</li>
<li>Nginx+Lua实现WAF应⽤防⽕墙</li>
</ol>
<p>Nginx+Lua优势</p>
<blockquote>
<p>充分的结合Nginx的并发处理epool优势和Lua的轻量实现<strong>简单的功能</strong>且<strong>高并发</strong>的场景</p>
</blockquote>
<p>应用场景 : </p>
<ul>
<li>统计IP</li>
<li>统计⽤户信息</li>
<li>安全WAF</li>
</ul>
<h2 id="lua脚本"><a href="#lua脚本" class="headerlink" title="lua脚本"></a>lua脚本</h2><p>就像bash一样 , 需要在首行使用<code>#! /usr/bin/lua</code>说明解释器的位置</p>
<ol>
<li><p>创建文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch test.lua</span><br></pre></td></tr></table></figure></li>
<li><p>编辑文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /usr/bin/lua</span></span><br></pre></td></tr></table></figure></li>
<li><p>执行文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lua test.lua</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="Lua的基础语法复习"><a href="#Lua的基础语法复习" class="headerlink" title="Lua的基础语法复习"></a>Lua的基础语法复习</h2><h3 id="变量定义"><a href="#变量定义" class="headerlink" title="变量定义"></a>变量定义</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">123</span></span><br><span class="line"><span class="comment">-- 布尔类型只有nil和false</span></span><br><span class="line"><span class="comment">-- 数字0,空字符串都是true</span></span><br><span class="line"><span class="comment">-- lua中的变量如果没有特殊说明,	全是全局变量</span></span><br></pre></td></tr></table></figure>

<h3 id="while-循环语句"><a href="#while-循环语句" class="headerlink" title="while 循环语句"></a>while 循环语句</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sum = <span class="number">0</span></span><br><span class="line">num = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> num &lt;= <span class="number">100</span> <span class="keyword">do</span></span><br><span class="line">    sum = sum + num</span><br><span class="line">    num = num + <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;sum=&quot;</span>,sum)</span><br><span class="line"><span class="comment">-- /Lua没有++或是+=这样的操作</span></span><br></pre></td></tr></table></figure>

<h3 id="for-循环语句"><a href="#for-循环语句" class="headerlink" title="for 循环语句"></a>for 循环语句</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sum = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>,<span class="number">100</span> <span class="keyword">do</span></span><br><span class="line">    sum = sum + <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;sum=&quot;</span>, sum)</span><br></pre></td></tr></table></figure>

<h3 id="if-判断语句"><a href="#if-判断语句" class="headerlink" title="if 判断语句"></a>if 判断语句</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> age == <span class="number">40</span> <span class="keyword">and</span> sex == <span class="string">&quot;Man&quot;</span>  <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;男⼈⼤于40&quot;</span>)</span><br><span class="line"><span class="keyword">elseif</span> age &gt; <span class="number">60</span>  <span class="keyword">and</span> sex ~= <span class="string">&quot;Woman&quot;</span>  <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;⾮⼥⼈⽽且⼤于60&quot;</span>)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">local</span> age = <span class="built_in">io</span>.<span class="built_in">read</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Your age is&quot;</span> .. age)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- ~=是不等于</span></span><br><span class="line"><span class="comment">-- 字符串的拼接操作符&quot;..&quot;</span></span><br><span class="line"><span class="comment">-- io库的分别从stdin和stdout读写，read和write函数</span></span><br></pre></td></tr></table></figure>



<h2 id="Nginx加载Lua环境"><a href="#Nginx加载Lua环境" class="headerlink" title="Nginx加载Lua环境"></a>Nginx加载Lua环境</h2><p>默认情况下 Nginx 不⽀持 Lua 模块, 需要安装 LuaJIT 解释器, 并且需要重新编译 Nginx , 建议使⽤ openrestry</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">yum install -y readline-devel pcre-devel openssl-devel</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /soft/src</span><br><span class="line"></span><br><span class="line">wget https://openresty.org/download/ngx_openresty-1.9.3.2.tar.gz</span><br><span class="line"></span><br><span class="line">tar zxf ngx_openresty-1.9.3.2.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> ngx_openresty-1.9.3.2</span><br><span class="line"></span><br><span class="line">./configure --prefix=/soft/openresty-1.9.3.2 \</span><br><span class="line">--with-luajit --with-http_stub_status_module \</span><br><span class="line">--with-pcre --with-pcre-jit</span><br><span class="line"></span><br><span class="line">gmake &amp;&amp; gmake install</span><br><span class="line"></span><br><span class="line">ln -s /soft/openresty-1.9.3.2/soft/openresty</span><br></pre></td></tr></table></figure>



<p>测试openresty安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim	/soft/openresty/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	location /hello &#123;</span><br><span class="line">		default_type text/html;</span><br><span class="line">		content_by_lua_block &#123;</span><br><span class="line">			ngx.say(<span class="string">&quot;HelloWorld&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Nginx调⽤Lua指令"><a href="#Nginx调⽤Lua指令" class="headerlink" title="Nginx调⽤Lua指令"></a>Nginx调⽤Lua指令</h2><p>Nginx 调⽤ Lua 模块指令, Nginx的可插拔模块加载执⾏, 共11个处理阶段</p>
<table>
<thead>
<tr>
<th>语法</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>set_by_lua , set_by_lua_file</td>
<td>设置Nginx变量,可以实现负载的赋值逻辑</td>
</tr>
<tr>
<td>access_by_lua , access_by_lua_file</td>
<td>请求访问阶段处理, ⽤于访问控制</td>
</tr>
<tr>
<td>content_by_lua , content_by_lua_file</td>
<td>内容处理器, 接受请求处理并输出响应</td>
</tr>
</tbody></table>
<p>Nginx 调⽤ <code>Lua API</code></p>
<table>
<thead>
<tr>
<th>变量</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>ngx.var</td>
<td>nginx变量</td>
</tr>
<tr>
<td>ngx.req.get_headers</td>
<td>获取请求头</td>
</tr>
<tr>
<td>ngx.req.get_uri_args</td>
<td>获取url请求参数</td>
</tr>
<tr>
<td>ngx.redirect</td>
<td>重定向</td>
</tr>
<tr>
<td>ngx.print</td>
<td>输出响应内容体</td>
</tr>
<tr>
<td>ngx.say</td>
<td>输出响应内容体,最后输出⼀个换⾏符</td>
</tr>
<tr>
<td>ngx.header</td>
<td>输出响应头</td>
</tr>
</tbody></table>
<h2 id="Nginx-Lua实现代码灰度发布"><a href="#Nginx-Lua实现代码灰度发布" class="headerlink" title="Nginx+Lua实现代码灰度发布"></a>Nginx+Lua实现代码灰度发布</h2><blockquote>
<ul>
<li>灰度发布是指在黑与白之间，能够平滑过渡的一种发布方式。</li>
<li>AB test就是一种灰度发布方式，<strong>让一部分用户继续用A，一部分用户开始用B</strong>，如果用户对B没有什么反对意见，那么逐步扩大范围，把所有用户都迁移到B上面来。</li>
<li>灰度发布可以保证整体系统的稳定，在初始灰度的时候就可以发现、调整问题，以保证其影响度。</li>
</ul>
</blockquote>
<p> 按照⼀定的关系做区别，分不同的代码进行上线，使代码的发布能平滑过渡上线</p>
<ol>
<li>⽤户的信息cookie等信息区别</li>
<li>根据⽤户的ip地址, 颗粒度更⼴</li>
</ol>
<p>实践架构图</p>
<p>用于WEB系统新代码的测试发布，让一部分IP访问新版本，一部分IP仍然访问正常版本，其原理如图</p>
<p><img src="/images/1575809712262.png" alt="1575809712262"></p>
<p>执行过程：</p>
<ol>
<li>用户请求到达前端代理Nginx, 内嵌的lua模块会解析Nginx配置⽂件中Lua脚本</li>
<li>Lua脚本会获取客户端IP地址,<strong>查看Memcached缓存中是否存在该键值</strong></li>
<li>如果存在则执⾏@java_test(测试版本),否则执行@java_prod(稳定版本)<ul>
<li>如果是@java_test, 那么location会将请求转发⾄新版代码的集群组</li>
<li>如果是@java_prod, 那么location会将请求转发⾄原始版代码集群组</li>
</ul>
</li>
<li>最后整个过程执⾏后结束</li>
</ol>
<h3 id="1-配置-Memcached-并让其⽀持-Lua-调⽤"><a href="#1-配置-Memcached-并让其⽀持-Lua-调⽤" class="headerlink" title="1.配置 Memcached 并让其⽀持 Lua 调⽤"></a>1.配置 Memcached 并让其⽀持 Lua 调⽤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装memcached服务</span></span><br><span class="line">yum install memcached -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置memcached⽀持lua</span></span><br><span class="line"><span class="built_in">cd</span> /soft/src</span><br><span class="line">wget https://github.com/agentzh/lua-resty-memcached/archive/v0.11.tar.gz</span><br><span class="line">tar xf v0.11.tar.gz</span><br><span class="line">cp -r lua-resty-memcached-0.11/lib/resty/memcached.lua /etc/nginx/lua/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动memcached</span></span><br><span class="line">systemctl start memcached</span><br><span class="line">systemctl <span class="built_in">enable</span> memcached</span><br></pre></td></tr></table></figure>



<h3 id="2-配置负载均衡调度"><a href="#2-配置负载均衡调度" class="headerlink" title="2.配置负载均衡调度"></a>2.配置负载均衡调度</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#必须在http层</span></span><br><span class="line">lua_package_path <span class="string">&quot;/etc/nginx/lua/memcached.lua&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 稳定版本的服务器</span></span><br><span class="line">upstream java_prod &#123;</span><br><span class="line">	server 192.168.56.12:8080;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 测试版本的服务器</span></span><br><span class="line">upstream java_test &#123;</span><br><span class="line">	server 192.168.56.13:9090;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name 47.104.250.169;</span><br><span class="line">	location /hello &#123;</span><br><span class="line">		default_type <span class="string">&#x27;text/plain&#x27;</span>;</span><br><span class="line">		content_by_lua <span class="string">&#x27;ngx.say(&quot;hello ,lua scripts&quot;)&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	location /myip &#123;</span><br><span class="line">		default_type <span class="string">&#x27;text/plain&#x27;</span>;</span><br><span class="line">		content_by_lua </span><br><span class="line">		<span class="comment"># 获取客户端IP</span></span><br><span class="line">		clientIP = ngx.req.get_headers()[<span class="string">&quot;x_forwarded_for&quot;</span>]</span><br><span class="line">		<span class="keyword">if</span> clientIP == nil <span class="keyword">then</span></span><br><span class="line">			clientIP = ngx.var.remote_addr</span><br><span class="line">		ngx.say(<span class="string">&quot;Remote_IP:&quot;</span>,clientIP)</span><br><span class="line">		end;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment"># 重要,灰度发布 Lua 脚本</span></span><br><span class="line">	location / &#123;</span><br><span class="line">		default_type <span class="string">&#x27;text/plain&#x27;</span>;</span><br><span class="line">		content_by_lua_file /etc/nginx/lua/dep.lua;</span><br><span class="line">	&#125;</span><br><span class="line">	location @java_prod &#123;</span><br><span class="line">		proxy_pass http://java_prod;</span><br><span class="line">		include proxy_params;</span><br><span class="line">	&#125;</span><br><span class="line">	location @java_test &#123;</span><br><span class="line">		proxy_pass http://java_test;</span><br><span class="line">		include proxy_params;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p> nginx反向代理tomcat,必须配置头部信息否则返回400错误</p>
<p> <strong>开启代理必须添加<code>proxy_params</code></strong></p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat	../proxy_params	</span><br></pre></td></tr></table></figure>

 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">proxy_redirect default;</span><br><span class="line">proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">proxy_set_header  X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">proxy_connect_timeout 30;</span><br><span class="line">proxy_send_timeout 60;</span><br><span class="line">proxy_read_timeout 60;</span><br><span class="line">proxy_buffer_size 32k;</span><br><span class="line">proxy_buffering on;</span><br><span class="line">proxy_buffers 4 128k;</span><br><span class="line">proxy_busy_buffers_size 256k;</span><br><span class="line">proxy_max_temp_file_size 256k;</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="3-编写-Nginx-调⽤灰度发布-Lua-脚本"><a href="#3-编写-Nginx-调⽤灰度发布-Lua-脚本" class="headerlink" title="3.编写 Nginx 调⽤灰度发布 Lua 脚本"></a>3.编写 Nginx 调⽤灰度发布 Lua 脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat	/etc/nginx/lua/dep.lua</span><br></pre></td></tr></table></figure>

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--获取x-real-ip</span></span><br><span class="line">clientIP = ngx.req.get_headers()[<span class="string">&quot;X-Real-IP&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">--如果IP为空-取x_forwarded_for</span></span><br><span class="line"><span class="keyword">if</span> clientIP == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">    clientIP = ngx.req.get_headers()[<span class="string">&quot;x_forwarded_for&quot;</span>]</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--如果IP为空-取remote_addr</span></span><br><span class="line"><span class="keyword">if</span> clientIP == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">    clientIP = ngx.var.remote_addr</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--定义本地的memcached对象,加载memcached</span></span><br><span class="line"><span class="keyword">local</span> memcached = <span class="built_in">require</span> <span class="string">&quot;resty.memcached&quot;</span></span><br><span class="line"><span class="comment">--实例化对象</span></span><br><span class="line"><span class="keyword">local</span> memc, err = memcached:new()</span><br><span class="line"></span><br><span class="line"><span class="comment">--判断连接是否存在错误</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> memc <span class="keyword">then</span></span><br><span class="line">    ngx.say(<span class="string">&quot;failed to instantiate memc: &quot;</span>, err)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--建⽴memcache连接</span></span><br><span class="line"><span class="keyword">local</span> ok, err = memc:connect(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">11211</span>)</span><br><span class="line"><span class="comment">--⽆法连接往前端抛出错误信息</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></span><br><span class="line">    ngx.say(<span class="string">&quot;failed to connect: &quot;</span>, err)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--获取对象中的ip-存在值赋给res</span></span><br><span class="line"><span class="keyword">local</span> res, flags, err = memc:get(clientIP)</span><br><span class="line"></span><br><span class="line"><span class="comment">--ngx.say(&quot;value key: &quot;,res,clientIP)</span></span><br><span class="line"><span class="keyword">if</span> err <span class="keyword">then</span></span><br><span class="line">    ngx.say(<span class="string">&quot;failed to get clientIP &quot;</span>, err)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--如果值为1则调⽤local-@java_test</span></span><br><span class="line"><span class="keyword">if</span> res == <span class="string">&quot;1&quot;</span> <span class="keyword">then</span></span><br><span class="line">    ngx.exec(<span class="string">&quot;@java_test&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--否则调⽤local-@java_prod</span></span><br><span class="line">ngx.exec(<span class="string">&quot;@java_prod&quot;</span>)</span><br><span class="line"><span class="keyword">return</span></span><br></pre></td></tr></table></figure>



<h2 id="Nginx-Lua实现WAF应⽤防⽕墙"><a href="#Nginx-Lua实现WAF应⽤防⽕墙" class="headerlink" title="Nginx+Lua实现WAF应⽤防⽕墙"></a>Nginx+Lua实现WAF应⽤防⽕墙</h2><h3 id="爬⾍⾏为和恶意抓取，资源盗取"><a href="#爬⾍⾏为和恶意抓取，资源盗取" class="headerlink" title="爬⾍⾏为和恶意抓取，资源盗取"></a>爬⾍⾏为和恶意抓取，资源盗取</h3><p>防护⼿段</p>
<ul>
<li>基础防盗链功能不让恶意⽤户能够轻易的爬取⽹站对外数据</li>
<li>access_moudle-&gt;对后台，部分⽤户服务的数据提供IP防护(普通用户不允许访问/admin路径)</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name localhost;</span><br><span class="line">	<span class="built_in">set</span> <span class="variable">$ip</span>  0;</span><br><span class="line">	<span class="keyword">if</span> (<span class="variable">$http_x_forward_for</span> ~ 211.161.160.201)&#123;</span><br><span class="line">		<span class="built_in">set</span> <span class="variable">$ip</span> 1;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (<span class="variable">$remote_addr</span> ~ 211.161.160.201)&#123;</span><br><span class="line">		<span class="built_in">set</span> <span class="variable">$ip</span> 1;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment"># 如果$ip值为0,则返回403, 否则允许访问</span></span><br><span class="line">	location /hello &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="variable">$ip</span> = <span class="string">&quot;0&quot;</span>)&#123;</span><br><span class="line">			<span class="built_in">return</span> 403;</span><br><span class="line">		&#125;</span><br><span class="line">	default_type application/json;</span><br><span class="line">	<span class="built_in">return</span> 200 <span class="string">&#x27;&#123;&quot;status&quot;:&quot;success&quot;&#125;&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="后台密码撞库，XRF攻击"><a href="#后台密码撞库，XRF攻击" class="headerlink" title="后台密码撞库，XRF攻击"></a>后台密码撞库，XRF攻击</h3><ul>
<li>后台密码撞库，通过猜测密码字典不断对后台系统登陆性尝试，获取后台登陆密码</li>
<li>XRF攻击 : ⽂件上传漏洞,利⽤上传接⼝将恶意代码植⼊到服务器中，再通过url去访问执⾏代码 , 执⾏⽅式bgx.com/1.jpg/1.php</li>
</ul>
<p>防护⼿段</p>
<ul>
<li>后台登陆密码复杂度</li>
<li>使⽤access_module , 对后台提供IP防控</li>
<li>预警机制</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location ^~ /upload &#123;</span><br><span class="line">	root /soft/code/upload;</span><br><span class="line">	<span class="keyword">if</span> (<span class="variable">$request_filename</span> ~* (.*)\.php)&#123;</span><br><span class="line">		<span class="built_in">return</span> 403;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Sql注⼊"><a href="#Sql注⼊" class="headerlink" title="Sql注⼊"></a>Sql注⼊</h3><p>防护⼿段</p>
<ol>
<li>php配置开启安全相关限制</li>
<li>开发⼈员对sql提交进⾏审核,屏蔽常⻅的注⼊⼿段</li>
<li>Nginx+Lua构建WAF应⽤层防⽕墙, 防⽌Sql注⼊</li>
</ol>
<p><img src="/images/1575812230671.png" alt="1575812230671"></p>
<p>使⽤lua解决此类安全问题</p>
<p><img src="/images/1575812341593.png" alt="1575812341593"></p>
<p>详见 : <a target="_blank" rel="noopener" href="https://github.com/loveshell/ngx_lua_waf">ngx_lua_waf</a></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- waf.lua :</span></span><br><span class="line"><span class="keyword">local</span> content_length=<span class="built_in">tonumber</span>(ngx.req.get_headers()[<span class="string">&#x27;content-length&#x27;</span>])</span><br><span class="line"><span class="keyword">local</span> method=ngx.req.get_method()</span><br><span class="line"><span class="keyword">local</span> ngxmatch=ngx.re.<span class="built_in">match</span></span><br><span class="line"><span class="keyword">if</span> whiteip() <span class="keyword">then</span></span><br><span class="line"><span class="keyword">elseif</span> blockip() <span class="keyword">then</span></span><br><span class="line"><span class="keyword">elseif</span> denycc() <span class="keyword">then</span></span><br><span class="line"><span class="keyword">elseif</span> ngx.var.http_Acunetix_Aspect <span class="keyword">then</span></span><br><span class="line">    ngx.<span class="built_in">exit</span>(<span class="number">444</span>)</span><br><span class="line"><span class="keyword">elseif</span> ngx.var.http_X_Scan_Memo <span class="keyword">then</span></span><br><span class="line">    ngx.<span class="built_in">exit</span>(<span class="number">444</span>)</span><br><span class="line"><span class="keyword">elseif</span> whiteurl() <span class="keyword">then</span></span><br><span class="line"><span class="keyword">elseif</span> ua() <span class="keyword">then</span></span><br><span class="line"><span class="keyword">elseif</span> url() <span class="keyword">then</span></span><br><span class="line"><span class="keyword">elseif</span> args() <span class="keyword">then</span></span><br><span class="line"><span class="keyword">elseif</span> cookie() <span class="keyword">then</span></span><br><span class="line"><span class="keyword">elseif</span> PostCheck <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> method==<span class="string">&quot;POST&quot;</span> <span class="keyword">then</span>   </span><br><span class="line">            <span class="keyword">local</span> boundary = get_boundary()</span><br><span class="line">	    <span class="keyword">if</span> boundary <span class="keyword">then</span></span><br><span class="line">	    <span class="keyword">local</span> <span class="built_in">len</span> = <span class="built_in">string</span>.<span class="built_in">len</span></span><br><span class="line">            <span class="keyword">local</span> sock, err = ngx.req.socket()</span><br><span class="line">    	    <span class="keyword">if</span> <span class="keyword">not</span> sock <span class="keyword">then</span></span><br><span class="line">					<span class="keyword">return</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">	    ngx.req.init_body(<span class="number">128</span> * <span class="number">1024</span>)</span><br><span class="line">            sock:settimeout(<span class="number">0</span>)</span><br><span class="line">	    <span class="keyword">local</span> content_length = <span class="literal">nil</span></span><br><span class="line">    	    content_length=<span class="built_in">tonumber</span>(ngx.req.get_headers()[<span class="string">&#x27;content-length&#x27;</span>])</span><br><span class="line">    	    <span class="keyword">local</span> chunk_size = <span class="number">4096</span></span><br><span class="line">            <span class="keyword">if</span> content_length &lt; chunk_size <span class="keyword">then</span></span><br><span class="line">					chunk_size = content_length</span><br><span class="line">	    <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">local</span> size = <span class="number">0</span></span><br><span class="line">	    <span class="keyword">while</span> size &lt; content_length <span class="keyword">do</span></span><br><span class="line">		<span class="keyword">local</span> data, err, partial = sock:receive(chunk_size)</span><br><span class="line">		data = data <span class="keyword">or</span> partial</span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">not</span> data <span class="keyword">then</span></span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">		ngx.req.append_body(data)</span><br><span class="line">        	<span class="keyword">if</span> body(data) <span class="keyword">then</span></span><br><span class="line">	   	        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    	    	<span class="keyword">end</span></span><br><span class="line">		size = size + <span class="built_in">len</span>(data)</span><br><span class="line">		<span class="keyword">local</span> m = ngxmatch(data,<span class="string">[[Content-Disposition: form-data;(.+)filename=&quot;(.+)\\.(.*)&quot;]]</span>,<span class="string">&#x27;ijo&#x27;</span>)</span><br><span class="line">        	<span class="keyword">if</span> m <span class="keyword">then</span></span><br><span class="line">            		fileExtCheck(m[<span class="number">3</span>])</span><br><span class="line">            		filetranslate = <span class="literal">true</span></span><br><span class="line">        	<span class="keyword">else</span></span><br><span class="line">            		<span class="keyword">if</span> ngxmatch(data,<span class="string">&quot;Content-Disposition:&quot;</span>,<span class="string">&#x27;isjo&#x27;</span>) <span class="keyword">then</span></span><br><span class="line">                		filetranslate = <span class="literal">false</span></span><br><span class="line">            		<span class="keyword">end</span></span><br><span class="line">            		<span class="keyword">if</span> filetranslate==<span class="literal">false</span> <span class="keyword">then</span></span><br><span class="line">            			<span class="keyword">if</span> body(data) <span class="keyword">then</span></span><br><span class="line">                    			<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">                		<span class="keyword">end</span></span><br><span class="line">            		<span class="keyword">end</span></span><br><span class="line">        	<span class="keyword">end</span></span><br><span class="line">		<span class="keyword">local</span> less = content_length - size</span><br><span class="line">		<span class="keyword">if</span> less &lt; chunk_size <span class="keyword">then</span></span><br><span class="line">			chunk_size = less</span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">	 <span class="keyword">end</span></span><br><span class="line">	 ngx.req.finish_body()</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">			ngx.req.read_body()</span><br><span class="line">			<span class="keyword">local</span> args = ngx.req.get_post_args()</span><br><span class="line">			<span class="keyword">if</span> <span class="keyword">not</span> args <span class="keyword">then</span></span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			<span class="keyword">end</span></span><br><span class="line">			<span class="keyword">for</span> key, val <span class="keyword">in</span> <span class="built_in">pairs</span>(args) <span class="keyword">do</span></span><br><span class="line">				<span class="keyword">if</span> <span class="built_in">type</span>(val) == <span class="string">&quot;table&quot;</span> <span class="keyword">then</span></span><br><span class="line">					<span class="keyword">if</span> <span class="built_in">type</span>(val[<span class="number">1</span>]) == <span class="string">&quot;boolean&quot;</span> <span class="keyword">then</span></span><br><span class="line">						<span class="keyword">return</span></span><br><span class="line">					<span class="keyword">end</span></span><br><span class="line">					data=<span class="built_in">table</span>.<span class="built_in">concat</span>(val, <span class="string">&quot;, &quot;</span>)</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">					data=val</span><br><span class="line">				<span class="keyword">end</span></span><br><span class="line">				<span class="keyword">if</span> data <span class="keyword">and</span> <span class="built_in">type</span>(data) ~= <span class="string">&quot;boolean&quot;</span> <span class="keyword">and</span> body(data) <span class="keyword">then</span></span><br><span class="line">                			body(key)</span><br><span class="line">				<span class="keyword">end</span></span><br><span class="line">			<span class="keyword">end</span></span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<p>在nginx.conf的http段添加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">lua_package_path <span class="string">&quot;/etc/waf/?.lua&quot;</span>;</span><br><span class="line">lua_shared_dict <span class="built_in">limit</span> 10m;</span><br><span class="line">init_by_lua_file /etc/waf/init.lua;	</span><br><span class="line">access_by_lua_file /etc/waf/waf.lua;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置config.lua⾥的waf规则⽬录(⼀般在waf/conf/⽬录下)</span></span><br><span class="line"><span class="comment"># 绝对路径如有变动，需对应修改, 然后重启nginx即可</span></span><br><span class="line">RulePath = <span class="string">&quot;/etc/nginx/waf/wafconf/&quot;</span></span><br></pre></td></tr></table></figure>



<h2 id="防⽌-CC-攻击"><a href="#防⽌-CC-攻击" class="headerlink" title="防⽌ CC 攻击"></a>防⽌ CC 攻击</h2><p>攻击者借助代理服务器生成指向受害主机的合法请求，实现DDOS和伪装就叫：<code>CC</code>(<code>Challenge Collapsar</code>)。</p>
<blockquote>
<p>CC攻击是DDoS攻击的一种类型，使用代理服务器向受害服务器发送大量貌似合法的请求。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/nginx/waf/config.lua</span><br></pre></td></tr></table></figure>

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 60秒只允许100个请求</span></span><br><span class="line">CCrate=<span class="string">&quot;100/60&quot;</span></span><br></pre></td></tr></table></figure>















</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>