<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;第10章-数据聚合与分组运算&quot;&gt;&lt;a href=&quot;#第10章-数据聚合与分组运算&quot; class=&quot;headerlink&quot; title=&quot;第10章 数据聚合与分组运算&quot;&gt;&lt;/a&gt;第10章 数据聚合与分组运算&lt;/h1&gt;&lt;p&gt;pandas的gruopby功能，它使你能以⼀种⾃然的⽅式对数据集进⾏切⽚、切块、摘要等操作。"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>利用Python进行数据分析7_第10章_数据聚合与分组运算 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-none-link" href="/tags/Python/" rel="tag">Python</a></div><div class="post-time">2019-06-08</div></div></div><div class="container post-header"><h1>利用Python进行数据分析7_第10章_数据聚合与分组运算</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC10%E7%AB%A0-%E6%95%B0%E6%8D%AE%E8%81%9A%E5%90%88%E4%B8%8E%E5%88%86%E7%BB%84%E8%BF%90%E7%AE%97"><span class="toc-number">1.</span> <span class="toc-text">第10章 数据聚合与分组运算</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#10-1-GroupBy%E6%9C%BA%E5%88%B6"><span class="toc-number">1.1.</span> <span class="toc-text">10.1 GroupBy机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-2-%E6%95%B0%E6%8D%AE%E8%81%9A%E5%90%88"><span class="toc-number">1.2.</span> <span class="toc-text">10.2 数据聚合</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-3-apply%EF%BC%9A%E2%BC%80%E8%88%AC%E6%80%A7%E7%9A%84%E2%80%9C%E6%8B%86%E5%88%86%EF%BC%8D%E5%BA%94%E2%BD%A4%EF%BC%8D%E5%90%88%E5%B9%B6%E2%80%9D"><span class="toc-number">1.3.</span> <span class="toc-text">10.3 apply：⼀般性的“拆分－应⽤－合并”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-4-%E9%80%8F%E8%A7%86%E8%A1%A8%E5%92%8C%E4%BA%A4%E5%8F%89%E8%A1%A8"><span class="toc-number">1.4.</span> <span class="toc-text">10.4 透视表和交叉表</span></a></li></ol></li></ol></details></div><div class="container post-content"><h1 id="第10章-数据聚合与分组运算"><a href="#第10章-数据聚合与分组运算" class="headerlink" title="第10章 数据聚合与分组运算"></a>第10章 数据聚合与分组运算</h1><p>pandas的gruopby功能，它使你能以⼀种⾃然的⽅式对数据集进⾏切⽚、切块、摘要等操作。</p>
<p>本章内容:</p>
<ul>
<li>计算分组摘要统计，如计数、平均值、标准差，或⽤户⾃定义函数。</li>
<li>计算分组的概述统计，⽐如数量、平均值或标准差，或是⽤户定义的函数。</li>
<li>应⽤组内转换或其他运算，如规格化、线性回归、排名或选取⼦集等。</li>
<li>计算透视表或交叉表。</li>
<li>执⾏分位数分析以及其它统计分组分析。</li>
</ul>
<h2 id="10-1-GroupBy机制"><a href="#10-1-GroupBy机制" class="headerlink" title="10.1 GroupBy机制"></a>10.1 GroupBy机制</h2><p>分组运算:<br><code>split-apply-combine</code>（拆分－应⽤－合并）</p>
<ol>
<li>第⼀阶段，pandas对象中的数据会根据你所提供的⼀个或多个键被拆分（split）为多组。拆分操作是在对象的特定轴上执⾏的。<br>例如，DataFrame可以在其⾏（axis=0）或列（axis=1）上进⾏分组。</li>
<li>第二阶段，将⼀个函数应⽤（apply）到各个分组并产⽣⼀个新值。</li>
<li>第三阶段，所有这些函数的执⾏结果会被合并（combine）到最终的结果对象中。结果对象的形式⼀般取决于数据上所执⾏的操作。</li>
</ol>
<p><img src="/images/4202537.png" alt="4202537"></p>
<p>分组键可以有多种形式，且类型不必相同,但是其最终⽬的是<strong>产生一组用于拆分对象的值</strong>。：</p>
<ul>
<li>列表或数组，其⻓度与待分组的轴⼀样。</li>
<li>表示DataFrame某个列名的值。</li>
<li>字典或Series，给出待分组轴上的值与分组名之间的对应关系。</li>
<li>函数，⽤于处理轴索引或索引中的各个标签。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">np.random.seed(<span class="number">888</span>)</span><br><span class="line">df = pd.DataFrame(&#123;<span class="string">&#x27;key1&#x27;</span> : [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;a&#x27;</span>],</span><br><span class="line">                   <span class="string">&#x27;key2&#x27;</span> : [<span class="string">&#x27;one&#x27;</span>, <span class="string">&#x27;two&#x27;</span>, <span class="string">&#x27;one&#x27;</span>, <span class="string">&#x27;two&#x27;</span>, <span class="string">&#x27;one&#x27;</span>],</span><br><span class="line">                   <span class="string">&#x27;data1&#x27;</span> : np.random.randn(<span class="number">5</span>),</span><br><span class="line">                   <span class="string">&#x27;data2&#x27;</span> : np.random.randn(<span class="number">5</span>)&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(df)</span><br><span class="line"><span class="comment">#   key1 key2     data1     data2</span></span><br><span class="line"><span class="comment"># 0    a  one -0.176201 -0.105339</span></span><br><span class="line"><span class="comment"># 1    a  two  0.188876  0.217776</span></span><br><span class="line"><span class="comment"># 2    b  one  0.826747  0.587282</span></span><br><span class="line"><span class="comment"># 3    b  two -0.032447  0.100238</span></span><br><span class="line"><span class="comment"># 4    a  one -0.652499 -1.099947</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 按key1进⾏分组，并计算data1列的平均值。</span></span><br><span class="line"><span class="comment"># 访问data1，并根据key1调⽤groupby：</span></span><br><span class="line">grouped = df[<span class="string">&#x27;data1&#x27;</span>].groupby(df[<span class="string">&#x27;key1&#x27;</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用gruopby函数,生成GroupBy对象.这个GroupBy对象含有接下来对各分组执⾏运算所需的⼀切信息</span></span><br><span class="line"><span class="built_in">print</span>(grouped)</span><br><span class="line"><span class="comment"># &lt;pandas.core.groupby.groupby.SeriesGroupBy object at 0x00000238B9BC0908&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调⽤GroupBy的mean⽅法来计算分组平均值</span></span><br><span class="line">se = grouped.mean()</span><br><span class="line"><span class="built_in">print</span>(se)</span><br><span class="line"><span class="comment"># key1</span></span><br><span class="line"><span class="comment"># a   -0.213275</span></span><br><span class="line"><span class="comment"># b    0.397150</span></span><br><span class="line"><span class="comment"># Name: data1, dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(se))</span><br><span class="line"><span class="comment"># &lt;class &#x27;pandas.core.series.Series&#x27;&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用grouped对象的sum方法</span></span><br><span class="line"><span class="built_in">print</span>(grouped.<span class="built_in">sum</span>())</span><br><span class="line"><span class="comment"># key1</span></span><br><span class="line"><span class="comment"># a   -0.639824</span></span><br><span class="line"><span class="comment"># b    0.794300</span></span><br><span class="line"><span class="comment"># Name: data1, dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用grouped对象的count方法</span></span><br><span class="line"><span class="built_in">print</span>(grouped.count())</span><br><span class="line"><span class="comment"># key1</span></span><br><span class="line"><span class="comment"># a    3</span></span><br><span class="line"><span class="comment"># b    2</span></span><br><span class="line"><span class="comment"># Name: data1, dtype: int64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ⼀次传⼊多个数组的列表,通过两个键对数据进⾏了分组</span></span><br><span class="line">means = df[<span class="string">&#x27;data1&#x27;</span>].groupby([df[<span class="string">&#x27;key1&#x27;</span>], df[<span class="string">&#x27;key2&#x27;</span>]]).mean()</span><br><span class="line"><span class="built_in">print</span>(means)</span><br><span class="line"><span class="comment"># key1  key2</span></span><br><span class="line"><span class="comment"># a     one    -0.414350</span></span><br><span class="line"><span class="comment">#       two     0.188876</span></span><br><span class="line"><span class="comment"># b     one     0.826747</span></span><br><span class="line"><span class="comment">#       two    -0.032447</span></span><br><span class="line"><span class="comment"># Name: data1, dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(means.unstack())</span><br><span class="line"><span class="comment"># key2       one       two</span></span><br><span class="line"><span class="comment"># key1                    </span></span><br><span class="line"><span class="comment"># a    -0.414350  0.188876</span></span><br><span class="line"><span class="comment"># b     0.826747 -0.032447</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 还可以将列名（可以是字符串、数字或其他Python对象）⽤作分组键</span></span><br><span class="line"><span class="comment"># 因为key2是分类型变量,无法计算平均值,就直接忽略</span></span><br><span class="line"><span class="built_in">print</span>(df.groupby(<span class="string">&#x27;key1&#x27;</span>).mean())</span><br><span class="line"><span class="comment">#          data1    data2</span></span><br><span class="line"><span class="comment"># key1                   </span></span><br><span class="line"><span class="comment"># a    -0.213275 -0.32917</span></span><br><span class="line"><span class="comment"># b     0.397150  0.34376</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对比上面,分类型变量无法计算平均值,但是可以计算次数,所以这里保留了key2列</span></span><br><span class="line"><span class="built_in">print</span>(df.groupby(<span class="string">&#x27;key1&#x27;</span>).count())</span><br><span class="line"><span class="comment">#       key2  data1  data2</span></span><br><span class="line"><span class="comment"># key1                    </span></span><br><span class="line"><span class="comment"># a        3      3      3</span></span><br><span class="line"><span class="comment"># b        2      2      2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(df.groupby([<span class="string">&#x27;key1&#x27;</span>, <span class="string">&#x27;key2&#x27;</span>]).mean())</span><br><span class="line"><span class="comment">#               data1     data2</span></span><br><span class="line"><span class="comment"># key1 key2                    </span></span><br><span class="line"><span class="comment"># a    one  -0.414350 -0.602643</span></span><br><span class="line"><span class="comment">#      two   0.188876  0.217776</span></span><br><span class="line"><span class="comment"># b    one   0.826747  0.587282</span></span><br><span class="line"><span class="comment">#      two  -0.032447  0.100238</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># size方法返回⼀个含有分组⼤⼩的Series：</span></span><br><span class="line"><span class="built_in">print</span>(df.groupby([<span class="string">&#x27;key1&#x27;</span>, <span class="string">&#x27;key2&#x27;</span>]).size())</span><br><span class="line"><span class="comment"># key1  key2</span></span><br><span class="line"><span class="comment"># a     one     2</span></span><br><span class="line"><span class="comment">#       two     1</span></span><br><span class="line"><span class="comment"># b     one     1</span></span><br><span class="line"><span class="comment">#       two     1</span></span><br><span class="line"><span class="comment"># dtype: int64</span></span><br></pre></td></tr></table></figure>

<p>简单来说,</p>
<ul>
<li><p><code>grouped = df[&#39;data1&#39;].groupby(df[&#39;key1&#39;])</code>里的df[‘key1’]被称为<code>分组键</code></p>
</li>
<li><p>==你想对哪列分组计算,就调用哪列的groupby方法==.<br>或者可以直接将DataFrame作为分组键,那么所有列都会参与计算</p>
</li>
<li><p><code>df.groupby(&#39;key1&#39;).mean()</code>一句中</p>
<ol>
<li>==<code>df.groupby(&#39;key1&#39;)</code>确定了结果的行索引==</li>
<li>==<code>mean()</code>确定了单元格的值.==</li>
</ol>
<p>简单来讲:</p>
<ol>
<li>groupby确定分组键(按什么分组)</li>
<li>mean()确定聚合值(将数据用什么函数聚合)</li>
</ol>
</li>
<li><p>默认情况下，所有<code>数值列</code>(连续性变量列)都会被聚合.<br>但是如果列是分类型变量,可能会因为无法计算而被忽略<br>(eg:分类型变量无法计算平均值,当调用mean()方法时就会被直接抛弃)<br>这种列俗称<code>麻烦列</code></p>
</li>
<li><p>Groupby对象的size方法会返回⼀个含有分组⼤⼩的Series</p>
</li>
<li><p>分组关键词中的缺失值，都会被从结果中除去。</p>
</li>
</ul>
<p>对分组进行迭代</p>
<p>GroupBy对象⽀持迭代，可以产⽣⼀组⼆元元组（由<code>分组名</code>和<code>数据块</code>组成）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">np.random.seed(<span class="number">888</span>)</span><br><span class="line">df = pd.DataFrame(&#123;<span class="string">&#x27;key1&#x27;</span> : [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;a&#x27;</span>],</span><br><span class="line">                   <span class="string">&#x27;key2&#x27;</span> : [<span class="string">&#x27;one&#x27;</span>, <span class="string">&#x27;two&#x27;</span>, <span class="string">&#x27;one&#x27;</span>, <span class="string">&#x27;two&#x27;</span>, <span class="string">&#x27;one&#x27;</span>],</span><br><span class="line">                   <span class="string">&#x27;data1&#x27;</span> : np.random.randn(<span class="number">5</span>),</span><br><span class="line">                   <span class="string">&#x27;data2&#x27;</span> : np.random.randn(<span class="number">5</span>)&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(df)</span><br><span class="line"><span class="comment">#   key1 key2     data1     data2</span></span><br><span class="line"><span class="comment"># 0    a  one -0.176201 -0.105339</span></span><br><span class="line"><span class="comment"># 1    a  two  0.188876  0.217776</span></span><br><span class="line"><span class="comment"># 2    b  one  0.826747  0.587282</span></span><br><span class="line"><span class="comment"># 3    b  two -0.032447  0.100238</span></span><br><span class="line"><span class="comment"># 4    a  one -0.652499 -1.099947</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回 分组名:name 数据块group</span></span><br><span class="line"><span class="keyword">for</span> name, group <span class="keyword">in</span> df.groupby(<span class="string">&#x27;key1&#x27;</span>):</span><br><span class="line">    <span class="built_in">print</span>(name,<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(group)</span><br><span class="line"><span class="comment"># a</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#   key1 key2     data1     data2</span></span><br><span class="line"><span class="comment"># 0    a  one -0.176201 -0.105339</span></span><br><span class="line"><span class="comment"># 1    a  two  0.188876  0.217776</span></span><br><span class="line"><span class="comment"># 4    a  one -0.652499 -1.099947</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># b</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#   key1 key2     data1     data2</span></span><br><span class="line"><span class="comment"># 2    b  one  0.826747  0.587282</span></span><br><span class="line"><span class="comment"># 3    b  two -0.032447  0.100238</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 多重键的分组:</span></span><br><span class="line"><span class="comment"># 返回 分组名:(k1, k2) 数据块group</span></span><br><span class="line"><span class="keyword">for</span> (k1, k2), group <span class="keyword">in</span> df.groupby([<span class="string">&#x27;key1&#x27;</span>, <span class="string">&#x27;key2&#x27;</span>]):</span><br><span class="line">    <span class="built_in">print</span>((k1, k2),<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(group)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;--------------&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># (&#x27;a&#x27;, &#x27;one&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#   key1 key2     data1     data2</span></span><br><span class="line"><span class="comment"># 0    a  one -0.176201 -0.105339</span></span><br><span class="line"><span class="comment"># 4    a  one -0.652499 -1.099947</span></span><br><span class="line"><span class="comment"># --------------</span></span><br><span class="line"><span class="comment"># (&#x27;a&#x27;, &#x27;two&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#   key1 key2     data1     data2</span></span><br><span class="line"><span class="comment"># 1    a  two  0.188876  0.217776</span></span><br><span class="line"><span class="comment"># --------------</span></span><br><span class="line"><span class="comment"># (&#x27;b&#x27;, &#x27;one&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#   key1 key2     data1     data2</span></span><br><span class="line"><span class="comment"># 2    b  one  0.826747  0.587282</span></span><br><span class="line"><span class="comment"># --------------</span></span><br><span class="line"><span class="comment"># (&#x27;b&#x27;, &#x27;two&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#   key1 key2     data1     data2</span></span><br><span class="line"><span class="comment"># 3    b  two -0.032447  0.100238</span></span><br><span class="line"><span class="comment"># --------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">list</span>(df.groupby(<span class="string">&#x27;key1&#x27;</span>)))</span><br><span class="line"><span class="comment"># [(&#x27;a&#x27;,   key1 key2     data1     data2</span></span><br><span class="line"><span class="comment"># 0    a  one -0.176201 -0.105339</span></span><br><span class="line"><span class="comment"># 1    a  two  0.188876  0.217776</span></span><br><span class="line"><span class="comment"># 4    a  one -0.652499 -1.099947), (&#x27;b&#x27;,   key1 key2     data1     data2</span></span><br><span class="line"><span class="comment"># 2    b  one  0.826747  0.587282</span></span><br><span class="line"><span class="comment"># 3    b  two -0.032447  0.100238)]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 制作成字典,后续可用</span></span><br><span class="line">pieces = <span class="built_in">dict</span>(<span class="built_in">list</span>(df.groupby(<span class="string">&#x27;key1&#x27;</span>)))</span><br><span class="line"><span class="built_in">print</span>(pieces[<span class="string">&#x27;b&#x27;</span>])</span><br><span class="line"><span class="comment">#   key1 key2     data1     data2</span></span><br><span class="line"><span class="comment"># 2    b  one  0.826747  0.587282</span></span><br><span class="line"><span class="comment"># 3    b  two -0.032447  0.100238</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(df.dtypes)</span><br><span class="line"><span class="comment"># key1      object</span></span><br><span class="line"><span class="comment"># key2      object</span></span><br><span class="line"><span class="comment"># data1    float64</span></span><br><span class="line"><span class="comment"># data2    float64</span></span><br><span class="line"><span class="comment"># dtype: object</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用axis,根据dtypes进行分组</span></span><br><span class="line">grouped = df.groupby(df.dtypes, axis=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> dtype, group <span class="keyword">in</span> grouped:</span><br><span class="line">    <span class="built_in">print</span>(dtype,<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(group)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;----------------&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># float64 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#       data1     data2</span></span><br><span class="line"><span class="comment"># 0 -0.176201 -0.105339</span></span><br><span class="line"><span class="comment"># 1  0.188876  0.217776</span></span><br><span class="line"><span class="comment"># 2  0.826747  0.587282</span></span><br><span class="line"><span class="comment"># 3 -0.032447  0.100238</span></span><br><span class="line"><span class="comment"># 4 -0.652499 -1.099947</span></span><br><span class="line"><span class="comment"># ----------------</span></span><br><span class="line"><span class="comment"># object </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#   key1 key2</span></span><br><span class="line"><span class="comment"># 0    a  one</span></span><br><span class="line"><span class="comment"># 1    a  two</span></span><br><span class="line"><span class="comment"># 2    b  one</span></span><br><span class="line"><span class="comment"># 3    b  two</span></span><br><span class="line"><span class="comment"># 4    a  one</span></span><br><span class="line"><span class="comment"># ----------------</span></span><br></pre></td></tr></table></figure>



<p>选取⼀列或列的⼦集</p>
<p>从上面得出,要对某一列进行分组的代码为:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">df[<span class="string">&#x27;data1&#x27;</span>].groupby(df[<span class="string">&#x27;key1&#x27;</span>])</span><br><span class="line"></span><br><span class="line">df[[<span class="string">&#x27;data2&#x27;</span>]].groupby(df[<span class="string">&#x27;key1&#x27;</span>])</span><br></pre></td></tr></table></figure>

<p>这两句都有语法糖:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">df.groupby(<span class="string">&#x27;key1&#x27;</span>)[<span class="string">&#x27;data1&#x27;</span>]</span><br><span class="line"></span><br><span class="line">df.groupby(<span class="string">&#x27;key1&#x27;</span>)[[<span class="string">&#x27;data2&#x27;</span>]]</span><br></pre></td></tr></table></figure>

<p>示例:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">np.random.seed(<span class="number">888</span>)</span><br><span class="line">df = pd.DataFrame(&#123;<span class="string">&#x27;key1&#x27;</span> : [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;a&#x27;</span>],</span><br><span class="line">                   <span class="string">&#x27;key2&#x27;</span> : [<span class="string">&#x27;one&#x27;</span>, <span class="string">&#x27;two&#x27;</span>, <span class="string">&#x27;one&#x27;</span>, <span class="string">&#x27;two&#x27;</span>, <span class="string">&#x27;one&#x27;</span>],</span><br><span class="line">                   <span class="string">&#x27;data1&#x27;</span> : np.random.randn(<span class="number">5</span>),</span><br><span class="line">                   <span class="string">&#x27;data2&#x27;</span> : np.random.randn(<span class="number">5</span>)&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(df)</span><br><span class="line"><span class="comment">#   key1 key2     data1     data2</span></span><br><span class="line"><span class="comment"># 0    a  one -0.176201 -0.105339</span></span><br><span class="line"><span class="comment"># 1    a  two  0.188876  0.217776</span></span><br><span class="line"><span class="comment"># 2    b  one  0.826747  0.587282</span></span><br><span class="line"><span class="comment"># 3    b  two -0.032447  0.100238</span></span><br><span class="line"><span class="comment"># 4    a  one -0.652499 -1.099947</span></span><br><span class="line"></span><br><span class="line">s = df[<span class="string">&#x27;data2&#x27;</span>]</span><br><span class="line">d = df[[<span class="string">&#x27;data2&#x27;</span>]]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(s))</span><br><span class="line"><span class="comment"># &lt;class &#x27;pandas.core.series.Series&#x27;&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(d))</span><br><span class="line"><span class="comment"># &lt;class &#x27;pandas.core.frame.DataFrame&#x27;&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(s)</span><br><span class="line"><span class="comment"># 0   -0.105339</span></span><br><span class="line"><span class="comment"># 1    0.217776</span></span><br><span class="line"><span class="comment"># 2    0.587282</span></span><br><span class="line"><span class="comment"># 3    0.100238</span></span><br><span class="line"><span class="comment"># 4   -1.099947</span></span><br><span class="line"><span class="comment"># Name: data2, dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(d)</span><br><span class="line"><span class="comment">#       data2</span></span><br><span class="line"><span class="comment"># 0 -0.105339</span></span><br><span class="line"><span class="comment"># 1  0.217776</span></span><br><span class="line"><span class="comment"># 2  0.587282</span></span><br><span class="line"><span class="comment"># 3  0.100238</span></span><br><span class="line"><span class="comment"># 4 -1.099947</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">x = df.groupby([<span class="string">&#x27;key1&#x27;</span>, <span class="string">&#x27;key2&#x27;</span>])[<span class="string">&#x27;data2&#x27;</span>].mean()</span><br><span class="line">y = df.groupby([<span class="string">&#x27;key1&#x27;</span>, <span class="string">&#x27;key2&#x27;</span>])[[<span class="string">&#x27;data2&#x27;</span>]].mean()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(x)</span><br><span class="line"><span class="comment"># key1  key2</span></span><br><span class="line"><span class="comment"># a     one    -0.602643</span></span><br><span class="line"><span class="comment">#       two     0.217776</span></span><br><span class="line"><span class="comment"># b     one     0.587282</span></span><br><span class="line"><span class="comment">#       two     0.100238</span></span><br><span class="line"><span class="comment"># Name: data2, dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(y)</span><br><span class="line"><span class="comment">#               data2</span></span><br><span class="line"><span class="comment"># key1 key2          </span></span><br><span class="line"><span class="comment"># a    one  -0.602643</span></span><br><span class="line"><span class="comment">#      two   0.217776</span></span><br><span class="line"><span class="comment"># b    one   0.587282</span></span><br><span class="line"><span class="comment">#      two   0.100238</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(x))</span><br><span class="line"><span class="comment"># &lt;class &#x27;pandas.core.series.Series&#x27;&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(y))</span><br><span class="line"><span class="comment"># &lt;class &#x27;pandas.core.frame.DataFrame&#x27;&gt;</span></span><br></pre></td></tr></table></figure>



<p>通过字典或Series进⾏分组</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">people = pd.DataFrame(np.arange(<span class="number">25</span>).reshape(<span class="number">5</span>,<span class="number">5</span>),</span><br><span class="line">                      columns=[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>],</span><br><span class="line">                      index=[<span class="string">&#x27;Joe&#x27;</span>, <span class="string">&#x27;Steve&#x27;</span>, <span class="string">&#x27;Wes&#x27;</span>, <span class="string">&#x27;Jim&#x27;</span>, <span class="string">&#x27;Travis&#x27;</span>])</span><br><span class="line"></span><br><span class="line">people.iloc[<span class="number">2</span>, [<span class="number">1</span>, <span class="number">2</span>]] = np.nan</span><br><span class="line"><span class="built_in">print</span>(people)</span><br><span class="line"><span class="comment">#          a     b     c   d   e</span></span><br><span class="line"><span class="comment"># Joe      0   1.0   2.0   3   4</span></span><br><span class="line"><span class="comment"># Steve    5   6.0   7.0   8   9</span></span><br><span class="line"><span class="comment"># Wes     10   NaN   NaN  13  14</span></span><br><span class="line"><span class="comment"># Jim     15  16.0  17.0  18  19</span></span><br><span class="line"><span class="comment"># Travis  20  21.0  22.0  23  24</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mapping = &#123;<span class="string">&#x27;a&#x27;</span>: <span class="string">&#x27;red&#x27;</span>, <span class="string">&#x27;b&#x27;</span>: <span class="string">&#x27;red&#x27;</span>, <span class="string">&#x27;c&#x27;</span>: <span class="string">&#x27;blue&#x27;</span>,</span><br><span class="line">           <span class="string">&#x27;d&#x27;</span>: <span class="string">&#x27;blue&#x27;</span>, <span class="string">&#x27;e&#x27;</span>: <span class="string">&#x27;red&#x27;</span>, <span class="string">&#x27;f&#x27;</span> : <span class="string">&#x27;orange&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过传递字典来制作分组键</span></span><br><span class="line">by_column = people.groupby(mapping, axis=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(by_column.<span class="built_in">sum</span>())</span><br><span class="line"><span class="comment">#         blue   red</span></span><br><span class="line"><span class="comment"># Joe      5.0   5.0</span></span><br><span class="line"><span class="comment"># Steve   15.0  20.0</span></span><br><span class="line"><span class="comment"># Wes     13.0  24.0</span></span><br><span class="line"><span class="comment"># Jim     35.0  50.0</span></span><br><span class="line"><span class="comment"># Travis  45.0  65.0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过传递Series制作分组键,进⾏分组</span></span><br><span class="line">map_series = pd.Series(mapping)</span><br><span class="line"><span class="built_in">print</span>(map_series)</span><br><span class="line"><span class="comment"># a       red</span></span><br><span class="line"><span class="comment"># b       red</span></span><br><span class="line"><span class="comment"># c      blue</span></span><br><span class="line"><span class="comment"># d      blue</span></span><br><span class="line"><span class="comment"># e       red</span></span><br><span class="line"><span class="comment"># f    orange</span></span><br><span class="line"><span class="comment"># dtype: object</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(people.groupby(map_series, axis=<span class="number">1</span>).count())</span><br><span class="line"><span class="comment">#         blue  red</span></span><br><span class="line"><span class="comment"># Joe        2    3</span></span><br><span class="line"><span class="comment"># Steve      2    3</span></span><br><span class="line"><span class="comment"># Wes        1    2</span></span><br><span class="line"><span class="comment"># Jim        2    3</span></span><br><span class="line"><span class="comment"># Travis     2    3</span></span><br></pre></td></tr></table></figure>



<p>通过函数进⾏分组</p>
<p>任何被当做分组键的函数都会在各个索引值上被调⽤⼀次，<strong>其返回值就会被用作分组名称</strong>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">people = pd.DataFrame(np.arange(<span class="number">25</span>).reshape(<span class="number">5</span>,<span class="number">5</span>),</span><br><span class="line">                      columns=[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>],</span><br><span class="line">                      index=[<span class="string">&#x27;Joe&#x27;</span>, <span class="string">&#x27;Steve&#x27;</span>, <span class="string">&#x27;Wes&#x27;</span>, <span class="string">&#x27;Jim&#x27;</span>, <span class="string">&#x27;Travis&#x27;</span>])</span><br><span class="line"></span><br><span class="line">people.iloc[<span class="number">2</span>, [<span class="number">1</span>, <span class="number">2</span>]] = np.nan</span><br><span class="line"><span class="built_in">print</span>(people)</span><br><span class="line"><span class="comment">#          a     b     c   d   e</span></span><br><span class="line"><span class="comment"># Joe      0   1.0   2.0   3   4</span></span><br><span class="line"><span class="comment"># Steve    5   6.0   7.0   8   9</span></span><br><span class="line"><span class="comment"># Wes     10   NaN   NaN  13  14</span></span><br><span class="line"><span class="comment"># Jim     15  16.0  17.0  18  19</span></span><br><span class="line"><span class="comment"># Travis  20  21.0  22.0  23  24</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(people.groupby(<span class="built_in">len</span>).<span class="built_in">sum</span>())</span><br><span class="line"><span class="comment">#     a     b     c   d   e</span></span><br><span class="line"><span class="comment"># 3  25  17.0  19.0  34  37</span></span><br><span class="line"><span class="comment"># 5   5   6.0   7.0   8   9</span></span><br><span class="line"><span class="comment"># 6  20  21.0  22.0  23  24</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将函数跟数组、列表、字典、Series混合使⽤</span></span><br><span class="line">key_list = [<span class="string">&#x27;one&#x27;</span>, <span class="string">&#x27;one&#x27;</span>, <span class="string">&#x27;one&#x27;</span>, <span class="string">&#x27;two&#x27;</span>, <span class="string">&#x27;two&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(people.groupby([<span class="built_in">len</span>, key_list]).<span class="built_in">min</span>())</span><br><span class="line"><span class="comment">#         a     b     c   d   e</span></span><br><span class="line"><span class="comment"># 3 one   0   1.0   2.0   3   4</span></span><br><span class="line"><span class="comment">#   two  15  16.0  17.0  18  19</span></span><br><span class="line"><span class="comment"># 5 one   5   6.0   7.0   8   9</span></span><br><span class="line"><span class="comment"># 6 two  20  21.0  22.0  23  24</span></span><br></pre></td></tr></table></figure>

<p>实际上:<br>将函数跟数组、列表、字典、Series混合使⽤时，在内部都会被转换为数组</p>
<p>根据索引级别分组</p>
<p>层次化索引数据集最⽅便的地⽅就在于它能够根据<strong>轴索引的一个级别进行聚合</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">columns = pd.MultiIndex.from_arrays([[<span class="string">&#x27;US&#x27;</span>, <span class="string">&#x27;US&#x27;</span>, <span class="string">&#x27;US&#x27;</span>, <span class="string">&#x27;JP&#x27;</span>, <span class="string">&#x27;JP&#x27;</span>],</span><br><span class="line">                                    [<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">3</span>]],</span><br><span class="line">                                    names=[<span class="string">&#x27;cty&#x27;</span>, <span class="string">&#x27;tenor&#x27;</span>])</span><br><span class="line">hier_df = pd.DataFrame(np.arange(<span class="number">10000</span>,<span class="number">10020</span>).reshape(<span class="number">4</span>,<span class="number">5</span>), columns=columns)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(hier_df)</span><br><span class="line"><span class="comment"># cty       US                   JP       </span></span><br><span class="line"><span class="comment"># tenor      1      3      5      1      3</span></span><br><span class="line"><span class="comment"># 0      10000  10001  10002  10003  10004</span></span><br><span class="line"><span class="comment"># 1      10005  10006  10007  10008  10009</span></span><br><span class="line"><span class="comment"># 2      10010  10011  10012  10013  10014</span></span><br><span class="line"><span class="comment"># 3      10015  10016  10017  10018  10019</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据索引级别分组</span></span><br><span class="line"><span class="built_in">print</span>(hier_df.groupby(level=<span class="string">&#x27;cty&#x27;</span>, axis=<span class="number">1</span>).<span class="built_in">sum</span>())</span><br><span class="line"><span class="comment"># cty     JP     US</span></span><br><span class="line"><span class="comment"># 0    20007  30003</span></span><br><span class="line"><span class="comment"># 1    20017  30018</span></span><br><span class="line"><span class="comment"># 2    20027  30033</span></span><br><span class="line"><span class="comment"># 3    20037  30048</span></span><br></pre></td></tr></table></figure>



<hr>
<h2 id="10-2-数据聚合"><a href="#10-2-数据聚合" class="headerlink" title="10.2 数据聚合"></a>10.2 数据聚合</h2><p>聚合运算函数:</p>
<p><img src="/images/374722537.png" alt="374722537"></p>
<p>除了上面的函数,还可以使用Series或DataFrame的聚合函数,甚至支持自定义的聚合函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">np.random.seed(<span class="number">888</span>)</span><br><span class="line">df = pd.DataFrame(&#123;<span class="string">&#x27;key1&#x27;</span> : [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;a&#x27;</span>],</span><br><span class="line">                   <span class="string">&#x27;key2&#x27;</span> : [<span class="string">&#x27;one&#x27;</span>, <span class="string">&#x27;two&#x27;</span>, <span class="string">&#x27;one&#x27;</span>, <span class="string">&#x27;two&#x27;</span>, <span class="string">&#x27;one&#x27;</span>],</span><br><span class="line">                   <span class="string">&#x27;data1&#x27;</span> : np.random.randn(<span class="number">5</span>),</span><br><span class="line">                   <span class="string">&#x27;data2&#x27;</span> : np.random.randn(<span class="number">5</span>)&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(df)</span><br><span class="line"><span class="comment">#   key1 key2     data1     data2</span></span><br><span class="line"><span class="comment"># 0    a  one -0.176201 -0.105339</span></span><br><span class="line"><span class="comment"># 1    a  two  0.188876  0.217776</span></span><br><span class="line"><span class="comment"># 2    b  one  0.826747  0.587282</span></span><br><span class="line"><span class="comment"># 3    b  two -0.032447  0.100238</span></span><br><span class="line"><span class="comment"># 4    a  one -0.652499 -1.099947</span></span><br><span class="line"></span><br><span class="line">grouped = df.groupby(<span class="string">&#x27;key1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用Series或DataFrame的样本分位数聚合函数</span></span><br><span class="line"><span class="built_in">print</span>(grouped[<span class="string">&#x27;data1&#x27;</span>].quantile(<span class="number">0.9</span>))</span><br><span class="line"><span class="comment"># key1</span></span><br><span class="line"><span class="comment"># a    0.115861</span></span><br><span class="line"><span class="comment"># b    0.740828</span></span><br><span class="line"><span class="comment"># Name: data1, dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">peak_to_peak</span>(<span class="params">arr</span>):</span></span><br><span class="line">    <span class="keyword">return</span> arr.<span class="built_in">max</span>() - arr.<span class="built_in">min</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果要使用自己的聚合函数,就要传入aggregate或agg⽅法</span></span><br><span class="line"><span class="built_in">print</span>(grouped.agg(peak_to_peak))</span><br><span class="line"><span class="comment">#          data1     data2</span></span><br><span class="line"><span class="comment"># key1                    </span></span><br><span class="line"><span class="comment"># a     0.841376  1.317723</span></span><br><span class="line"><span class="comment"># b     0.859194  0.487044</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 甚至并非严格聚合运算的describe函数也可以使用</span></span><br><span class="line"><span class="built_in">print</span>(grouped.describe()[<span class="string">&#x27;data1&#x27;</span>])</span><br><span class="line"><span class="comment">#       count      mean       std    ...          50%       75%       max</span></span><br><span class="line"><span class="comment"># key1                               ...                                 </span></span><br><span class="line"><span class="comment"># a       3.0 -0.213275  0.421911    ...    -0.176201  0.006338  0.188876</span></span><br><span class="line"><span class="comment"># b       2.0  0.397150  0.607542    ...     0.397150  0.611949  0.826747</span></span><br><span class="line"><span class="comment"># [2 rows x 8 columns]</span></span><br></pre></td></tr></table></figure>

<p>注意:<br>⾃定义聚合函数要⽐那些经过优化的函数慢得多。这是因为在构造中间分组数据块时存在非常⼤的开销（函数调⽤、数据重排等）</p>
<p>⾯向列的多函数应⽤<br>(对不同的列使⽤不同的聚合函数，或⼀次应⽤多个函数)</p>
<ul>
<li>⼀次应⽤多个函数:<br>只要往agg函数里添加由函数组成的列表即可</li>
<li>不同的列使⽤不同的聚合函数:<ul>
<li>方法一:<br>使用形如<code>result[&#39;tip_pct&#39;]</code>的方式获取某些列.<br>这些列调用函数.<br>使用concat将结果组装到⼀起，</li>
<li>方法二:<br>向agg传⼊⼀个从列名映射到函数的字典：</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tips = pd.read_csv(<span class="string">&#x27;examples/tips.csv&#x27;</span>)</span><br><span class="line"></span><br><span class="line">tips[<span class="string">&#x27;tip_pct&#x27;</span>] = tips[<span class="string">&#x27;tip&#x27;</span>] / tips[<span class="string">&#x27;total_bill&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(tips[:<span class="number">6</span>])</span><br><span class="line"><span class="comment">#    total_bill   tip smoker  day    time  size   tip_pct</span></span><br><span class="line"><span class="comment"># 0       16.99  1.01     No  Sun  Dinner     2  0.059447</span></span><br><span class="line"><span class="comment"># 1       10.34  1.66     No  Sun  Dinner     3  0.160542</span></span><br><span class="line"><span class="comment"># 2       21.01  3.50     No  Sun  Dinner     3  0.166587</span></span><br><span class="line"><span class="comment"># 3       23.68  3.31     No  Sun  Dinner     2  0.139780</span></span><br><span class="line"><span class="comment"># 4       24.59  3.61     No  Sun  Dinner     4  0.146808</span></span><br><span class="line"><span class="comment"># 5       25.29  4.71     No  Sun  Dinner     4  0.186240</span></span><br><span class="line"></span><br><span class="line">grouped = tips.groupby([<span class="string">&#x27;day&#x27;</span>, <span class="string">&#x27;smoker&#x27;</span>])</span><br><span class="line"></span><br><span class="line">grouped_pct = grouped[<span class="string">&#x27;tip_pct&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(grouped_pct.agg(<span class="string">&#x27;mean&#x27;</span>))</span><br><span class="line"><span class="comment"># day   smoker</span></span><br><span class="line"><span class="comment"># Fri   No        0.151650</span></span><br><span class="line"><span class="comment">#       Yes       0.174783</span></span><br><span class="line"><span class="comment"># Sat   No        0.158048</span></span><br><span class="line"><span class="comment">#       Yes       0.147906</span></span><br><span class="line"><span class="comment"># Sun   No        0.160113</span></span><br><span class="line"><span class="comment">#       Yes       0.187250</span></span><br><span class="line"><span class="comment"># Thur  No        0.160298</span></span><br><span class="line"><span class="comment">#       Yes       0.163863</span></span><br><span class="line"><span class="comment"># Name: tip_pct, dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">peak_to_peak</span>(<span class="params">arr</span>):</span></span><br><span class="line">    <span class="keyword">return</span> arr.<span class="built_in">max</span>() - arr.<span class="built_in">min</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># agg函数参数变成由函数胡组成的列表</span></span><br><span class="line"><span class="comment"># 列表的元素可以是函数名,也可以是函数名的字符串</span></span><br><span class="line"><span class="built_in">print</span>(grouped_pct.agg([<span class="string">&#x27;mean&#x27;</span>, <span class="string">&#x27;std&#x27;</span>, peak_to_peak]))</span><br><span class="line"><span class="comment">#                  mean       std  peak_to_peak</span></span><br><span class="line"><span class="comment"># day  smoker                                  </span></span><br><span class="line"><span class="comment"># Fri  No      0.151650  0.028123      0.067349</span></span><br><span class="line"><span class="comment">#      Yes     0.174783  0.051293      0.159925</span></span><br><span class="line"><span class="comment"># Sat  No      0.158048  0.039767      0.235193</span></span><br><span class="line"><span class="comment">#      Yes     0.147906  0.061375      0.290095</span></span><br><span class="line"><span class="comment"># Sun  No      0.160113  0.042347      0.193226</span></span><br><span class="line"><span class="comment">#      Yes     0.187250  0.154134      0.644685</span></span><br><span class="line"><span class="comment"># Thur No      0.160298  0.038774      0.193350</span></span><br><span class="line"><span class="comment">#      Yes     0.163863  0.039389      0.151240</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 传入(name,function)元组组成的列表,这样就可以对计算列命名了</span></span><br><span class="line"><span class="built_in">print</span>(grouped_pct.agg([(<span class="string">&#x27;name1&#x27;</span>, <span class="string">&#x27;mean&#x27;</span>), (<span class="string">&#x27;name2&#x27;</span>, np.std)]))</span><br><span class="line"><span class="comment">#                 name1     name2</span></span><br><span class="line"><span class="comment"># day  smoker                    </span></span><br><span class="line"><span class="comment"># Fri  No      0.151650  0.028123</span></span><br><span class="line"><span class="comment">#      Yes     0.174783  0.051293</span></span><br><span class="line"><span class="comment"># Sat  No      0.158048  0.039767</span></span><br><span class="line"><span class="comment">#      Yes     0.147906  0.061375</span></span><br><span class="line"><span class="comment"># Sun  No      0.160113  0.042347</span></span><br><span class="line"><span class="comment">#      Yes     0.187250  0.154134</span></span><br><span class="line"><span class="comment"># Thur No      0.160298  0.038774</span></span><br><span class="line"><span class="comment">#      Yes     0.163863  0.039389</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">grouped = tips.groupby([<span class="string">&#x27;day&#x27;</span>, <span class="string">&#x27;smoker&#x27;</span>])</span><br><span class="line">functions = [<span class="string">&#x27;count&#x27;</span>, <span class="string">&#x27;mean&#x27;</span>, <span class="string">&#x27;max&#x27;</span>]</span><br><span class="line">result = grouped[<span class="string">&#x27;tip_pct&#x27;</span>, <span class="string">&#x27;total_bill&#x27;</span>].agg(functions)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"><span class="comment">#             tip_pct                     total_bill                  </span></span><br><span class="line"><span class="comment">#               count      mean       max      count       mean    max</span></span><br><span class="line"><span class="comment"># day  smoker                                                         </span></span><br><span class="line"><span class="comment"># Fri  No           4  0.151650  0.187735          4  18.420000  22.75</span></span><br><span class="line"><span class="comment">#      Yes         15  0.174783  0.263480         15  16.813333  40.17</span></span><br><span class="line"><span class="comment"># Sat  No          45  0.158048  0.291990         45  19.661778  48.33</span></span><br><span class="line"><span class="comment">#      Yes         42  0.147906  0.325733         42  21.276667  50.81</span></span><br><span class="line"><span class="comment"># Sun  No          57  0.160113  0.252672         57  20.506667  48.17</span></span><br><span class="line"><span class="comment">#      Yes         19  0.187250  0.710345         19  24.120000  45.35</span></span><br><span class="line"><span class="comment"># Thur No          45  0.160298  0.266312         45  17.113111  41.19</span></span><br><span class="line"><span class="comment">#      Yes         17  0.163863  0.241255         17  19.190588  43.11</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">grouped = tips.groupby([<span class="string">&#x27;day&#x27;</span>, <span class="string">&#x27;smoker&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用字典,对不同的列使用不同的聚合函数.</span></span><br><span class="line"><span class="comment"># tip列使用np.max函数,size列使用sum函数</span></span><br><span class="line"><span class="built_in">print</span>(grouped.agg(&#123;<span class="string">&#x27;tip&#x27;</span> : np.<span class="built_in">max</span>, <span class="string">&#x27;size&#x27;</span> : <span class="string">&#x27;sum&#x27;</span>&#125;))</span><br><span class="line"><span class="comment">#                tip  size</span></span><br><span class="line"><span class="comment"># day  smoker             </span></span><br><span class="line"><span class="comment"># Fri  No       3.50     9</span></span><br><span class="line"><span class="comment">#      Yes      4.73    31</span></span><br><span class="line"><span class="comment"># Sat  No       9.00   115</span></span><br><span class="line"><span class="comment">#      Yes     10.00   104</span></span><br><span class="line"><span class="comment"># Sun  No       6.00   167</span></span><br><span class="line"><span class="comment">#      Yes      6.50    49</span></span><br><span class="line"><span class="comment"># Thur No       6.70   112</span></span><br><span class="line"><span class="comment">#      Yes      5.00    40</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对tip_pct的外层column使用一系列函数,,size列使用sum函数</span></span><br><span class="line"><span class="built_in">print</span>(grouped.agg(&#123;<span class="string">&#x27;tip_pct&#x27;</span> : [<span class="string">&#x27;min&#x27;</span>, <span class="string">&#x27;max&#x27;</span>, <span class="string">&#x27;mean&#x27;</span>, <span class="string">&#x27;std&#x27;</span>],<span class="string">&#x27;size&#x27;</span> : <span class="string">&#x27;sum&#x27;</span>&#125;))</span><br><span class="line"><span class="comment">#               tip_pct                               size</span></span><br><span class="line"><span class="comment">#                   min       max      mean       std  sum</span></span><br><span class="line"><span class="comment"># day  smoker                                             </span></span><br><span class="line"><span class="comment"># Fri  No      0.120385  0.187735  0.151650  0.028123    9</span></span><br><span class="line"><span class="comment">#      Yes     0.103555  0.263480  0.174783  0.051293   31</span></span><br><span class="line"><span class="comment"># Sat  No      0.056797  0.291990  0.158048  0.039767  115</span></span><br><span class="line"><span class="comment">#      Yes     0.035638  0.325733  0.147906  0.061375  104</span></span><br><span class="line"><span class="comment"># Sun  No      0.059447  0.252672  0.160113  0.042347  167</span></span><br><span class="line"><span class="comment">#      Yes     0.065660  0.710345  0.187250  0.154134   49</span></span><br><span class="line"><span class="comment"># Thur No      0.072961  0.266312  0.160298  0.038774  112</span></span><br><span class="line"><span class="comment">#      Yes     0.090014  0.241255  0.163863  0.039389   40</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(tips.groupby([<span class="string">&#x27;day&#x27;</span>, <span class="string">&#x27;smoker&#x27;</span>]).mean())</span><br><span class="line"><span class="comment">#              total_bill       tip      size   tip_pct</span></span><br><span class="line"><span class="comment"># day  smoker                                          </span></span><br><span class="line"><span class="comment"># Fri  No       18.420000  2.812500  2.250000  0.151650</span></span><br><span class="line"><span class="comment">#      Yes      16.813333  2.714000  2.066667  0.174783</span></span><br><span class="line"><span class="comment"># Sat  No       19.661778  3.102889  2.555556  0.158048</span></span><br><span class="line"><span class="comment">#      Yes      21.276667  2.875476  2.476190  0.147906</span></span><br><span class="line"><span class="comment"># Sun  No       20.506667  3.167895  2.929825  0.160113</span></span><br><span class="line"><span class="comment">#      Yes      24.120000  3.516842  2.578947  0.187250</span></span><br><span class="line"><span class="comment"># Thur No       17.113111  2.673778  2.488889  0.160298</span></span><br><span class="line"><span class="comment">#      Yes      19.190588  3.030000  2.352941  0.163863</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 以“没有⾏索引”的形式返回聚合数据</span></span><br><span class="line"><span class="built_in">print</span>(tips.groupby([<span class="string">&#x27;day&#x27;</span>, <span class="string">&#x27;smoker&#x27;</span>], as_index=<span class="literal">False</span>).mean())</span><br><span class="line"><span class="comment">#     day smoker  total_bill       tip      size   tip_pct</span></span><br><span class="line"><span class="comment"># 0   Fri     No   18.420000  2.812500  2.250000  0.151650</span></span><br><span class="line"><span class="comment"># 1   Fri    Yes   16.813333  2.714000  2.066667  0.174783</span></span><br><span class="line"><span class="comment"># 2   Sat     No   19.661778  3.102889  2.555556  0.158048</span></span><br><span class="line"><span class="comment"># 3   Sat    Yes   21.276667  2.875476  2.476190  0.147906</span></span><br><span class="line"><span class="comment"># 4   Sun     No   20.506667  3.167895  2.929825  0.160113</span></span><br><span class="line"><span class="comment"># 5   Sun    Yes   24.120000  3.516842  2.578947  0.187250</span></span><br><span class="line"><span class="comment"># 6  Thur     No   17.113111  2.673778  2.488889  0.160298</span></span><br><span class="line"><span class="comment"># 7  Thur    Yes   19.190588  3.030000  2.352941  0.163863</span></span><br></pre></td></tr></table></figure>

<p>以“没有⾏索引”的形式返回聚合数据:<br>就是把所有的行索引改为RangeIndex</p>
<hr>
<h2 id="10-3-apply：⼀般性的“拆分－应⽤－合并”"><a href="#10-3-apply：⼀般性的“拆分－应⽤－合并”" class="headerlink" title="10.3 apply：⼀般性的“拆分－应⽤－合并”"></a>10.3 apply：⼀般性的“拆分－应⽤－合并”</h2><p>最通⽤的GroupBy⽅法是apply</p>
<p>回忆这张图</p>
<p><img src="/images/d24cb7ff-4202537.png" alt="4202537"></p>
<p>apply会将待处理的对象拆分成多个⽚段，然后对各⽚段调⽤传⼊的函数，最后尝试将各⽚段组合到⼀起。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tips = pd.read_csv(<span class="string">&#x27;examples/tips.csv&#x27;</span>)</span><br><span class="line"></span><br><span class="line">tips[<span class="string">&#x27;tip_pct&#x27;</span>] = tips[<span class="string">&#x27;tip&#x27;</span>] / tips[<span class="string">&#x27;total_bill&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(tips[:<span class="number">6</span>])</span><br><span class="line"><span class="comment">#    total_bill   tip smoker  day    time  size   tip_pct</span></span><br><span class="line"><span class="comment"># 0       16.99  1.01     No  Sun  Dinner     2  0.059447</span></span><br><span class="line"><span class="comment"># 1       10.34  1.66     No  Sun  Dinner     3  0.160542</span></span><br><span class="line"><span class="comment"># 2       21.01  3.50     No  Sun  Dinner     3  0.166587</span></span><br><span class="line"><span class="comment"># 3       23.68  3.31     No  Sun  Dinner     2  0.139780</span></span><br><span class="line"><span class="comment"># 4       24.59  3.61     No  Sun  Dinner     4  0.146808</span></span><br><span class="line"><span class="comment"># 5       25.29  4.71     No  Sun  Dinner     4  0.186240</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">top</span>(<span class="params">df, n=<span class="number">5</span>, column=<span class="string">&#x27;tip_pct&#x27;</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> df.sort_values(by=column)[-n:]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(top(tips, n=<span class="number">6</span>))</span><br><span class="line"><span class="comment">#      total_bill   tip smoker  day    time  size   tip_pct</span></span><br><span class="line"><span class="comment"># 109       14.31  4.00    Yes  Sat  Dinner     2  0.279525</span></span><br><span class="line"><span class="comment"># 183       23.17  6.50    Yes  Sun  Dinner     4  0.280535</span></span><br><span class="line"><span class="comment"># 232       11.61  3.39     No  Sat  Dinner     2  0.291990</span></span><br><span class="line"><span class="comment"># 67         3.07  1.00    Yes  Sat  Dinner     1  0.325733</span></span><br><span class="line"><span class="comment"># 178        9.60  4.00    Yes  Sun  Dinner     2  0.416667</span></span><br><span class="line"><span class="comment"># 172        7.25  5.15    Yes  Sun  Dinner     2  0.710345</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对smoker分组并⽤该函数调⽤apply</span></span><br><span class="line"><span class="comment"># 对smoker分组,然后对分组后的结果排序并返回前n项</span></span><br><span class="line"><span class="built_in">print</span>(tips.groupby(<span class="string">&#x27;smoker&#x27;</span>).apply(top))</span><br><span class="line"><span class="comment">#             total_bill   tip smoker   day    time  size   tip_pct</span></span><br><span class="line"><span class="comment"># smoker                                                           </span></span><br><span class="line"><span class="comment"># No     88        24.71  5.85     No  Thur   Lunch     2  0.236746</span></span><br><span class="line"><span class="comment">#        185       20.69  5.00     No   Sun  Dinner     5  0.241663</span></span><br><span class="line"><span class="comment">#        51        10.29  2.60     No   Sun  Dinner     2  0.252672</span></span><br><span class="line"><span class="comment">#        149        7.51  2.00     No  Thur   Lunch     2  0.266312</span></span><br><span class="line"><span class="comment">#        232       11.61  3.39     No   Sat  Dinner     2  0.291990</span></span><br><span class="line"><span class="comment"># Yes    109       14.31  4.00    Yes   Sat  Dinner     2  0.279525</span></span><br><span class="line"><span class="comment">#        183       23.17  6.50    Yes   Sun  Dinner     4  0.280535</span></span><br><span class="line"><span class="comment">#        67         3.07  1.00    Yes   Sat  Dinner     1  0.325733</span></span><br><span class="line"><span class="comment">#        178        9.60  4.00    Yes   Sun  Dinner     2  0.416667</span></span><br><span class="line"><span class="comment">#        172        7.25  5.15    Yes   Sun  Dinner     2  0.710345</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 上面代码解释:</span></span><br><span class="line"><span class="comment"># top函数在DataFrame的各个⽚段上调⽤，</span></span><br><span class="line"><span class="comment"># 然后结果由pandas.concat组装到⼀起，并以分组名称进⾏了标记。</span></span><br><span class="line"><span class="comment"># 于是，最终结果就有了⼀个层次化索引，其内层索引值来⾃原DataFrame。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 向top函数传递参数</span></span><br><span class="line"><span class="built_in">print</span>(tips.groupby([<span class="string">&#x27;smoker&#x27;</span>, <span class="string">&#x27;day&#x27;</span>]).apply(top, n=<span class="number">1</span>, column=<span class="string">&#x27;total_bill&#x27;</span>))</span><br><span class="line"><span class="comment">#                  total_bill    tip smoker   day    time  size   tip_pct</span></span><br><span class="line"><span class="comment"># smoker day                                                             </span></span><br><span class="line"><span class="comment"># No     Fri  94        22.75   3.25     No   Fri  Dinner     2  0.142857</span></span><br><span class="line"><span class="comment">#        Sat  212       48.33   9.00     No   Sat  Dinner     4  0.186220</span></span><br><span class="line"><span class="comment">#        Sun  156       48.17   5.00     No   Sun  Dinner     6  0.103799</span></span><br><span class="line"><span class="comment">#        Thur 142       41.19   5.00     No  Thur   Lunch     5  0.121389</span></span><br><span class="line"><span class="comment"># Yes    Fri  95        40.17   4.73    Yes   Fri  Dinner     4  0.117750</span></span><br><span class="line"><span class="comment">#        Sat  170       50.81  10.00    Yes   Sat  Dinner     3  0.196812</span></span><br><span class="line"><span class="comment">#        Sun  182       45.35   3.50    Yes   Sun  Dinner     3  0.077178</span></span><br><span class="line"><span class="comment">#        Thur 197       43.11   5.00    Yes  Thur   Lunch     4  0.115982</span></span><br><span class="line"><span class="comment"># [8 rows x 7 columns]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调⽤过describe</span></span><br><span class="line">result = tips.groupby(<span class="string">&#x27;smoker&#x27;</span>)[<span class="string">&#x27;tip_pct&#x27;</span>].describe()</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"><span class="comment">#         count      mean       std    ...          50%       75%       max</span></span><br><span class="line"><span class="comment"># smoker                               ...                                 </span></span><br><span class="line"><span class="comment"># No      151.0  0.159328  0.039910    ...     0.155625  0.185014  0.291990</span></span><br><span class="line"><span class="comment"># Yes      93.0  0.163196  0.085119    ...     0.153846  0.195059  0.710345</span></span><br><span class="line"><span class="comment"># [2 rows x 8 columns]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(result.unstack(<span class="string">&#x27;smoker&#x27;</span>))</span><br><span class="line"><span class="comment">#        smoker</span></span><br><span class="line"><span class="comment"># count  No        151.000000</span></span><br><span class="line"><span class="comment">#        Yes        93.000000</span></span><br><span class="line"><span class="comment"># mean   No          0.159328</span></span><br><span class="line"><span class="comment">#        Yes         0.163196</span></span><br><span class="line"><span class="comment"># std    No          0.039910</span></span><br><span class="line"><span class="comment">#        Yes         0.085119</span></span><br><span class="line"><span class="comment"># min    No          0.056797</span></span><br><span class="line"><span class="comment">#        Yes         0.035638</span></span><br><span class="line"><span class="comment"># 25%    No          0.136906</span></span><br><span class="line"><span class="comment">#        Yes         0.106771</span></span><br><span class="line"><span class="comment"># 50%    No          0.155625</span></span><br><span class="line"><span class="comment">#        Yes         0.153846</span></span><br><span class="line"><span class="comment"># 75%    No          0.185014</span></span><br><span class="line"><span class="comment">#        Yes         0.195059</span></span><br><span class="line"><span class="comment"># max    No          0.291990</span></span><br><span class="line"><span class="comment">#        Yes         0.710345</span></span><br><span class="line"><span class="comment"># dtype: float64</span></span><br></pre></td></tr></table></figure>

<p>前面为什么说describe不是严格意义的聚合函数?</p>
<blockquote>
<p>实际上这只是应⽤了下⾯两条代码的快捷⽅式⽽已：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">f = <span class="keyword">lambda</span> x: x.describe()</span><br><span class="line">grouped.apply(f)</span><br></pre></td></tr></table></figure>
</blockquote>
<p>禁⽌分组键</p>
<p>从上⾯的例⼦中可以看出，<strong>分组键会跟原始对象的索引共同构成结果对象中的层次化索引</strong>。</p>
<p>将<code>group_keys=False</code>传⼊groupby即可禁⽌该效果</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(tips.groupby(<span class="string">&#x27;smoker&#x27;</span>).apply(top))</span><br><span class="line"><span class="comment">#             total_bill   tip smoker   day    time  size   tip_pct</span></span><br><span class="line"><span class="comment"># smoker                                                           </span></span><br><span class="line"><span class="comment"># No     88        24.71  5.85     No  Thur   Lunch     2  0.236746</span></span><br><span class="line"><span class="comment">#        185       20.69  5.00     No   Sun  Dinner     5  0.241663</span></span><br><span class="line"><span class="comment">#        51        10.29  2.60     No   Sun  Dinner     2  0.252672</span></span><br><span class="line"><span class="comment">#        149        7.51  2.00     No  Thur   Lunch     2  0.266312</span></span><br><span class="line"><span class="comment">#        232       11.61  3.39     No   Sat  Dinner     2  0.291990</span></span><br><span class="line"><span class="comment"># Yes    109       14.31  4.00    Yes   Sat  Dinner     2  0.279525</span></span><br><span class="line"><span class="comment">#        183       23.17  6.50    Yes   Sun  Dinner     4  0.280535</span></span><br><span class="line"><span class="comment">#        67         3.07  1.00    Yes   Sat  Dinner     1  0.325733</span></span><br><span class="line"><span class="comment">#        178        9.60  4.00    Yes   Sun  Dinner     2  0.416667</span></span><br><span class="line"><span class="comment">#        172        7.25  5.15    Yes   Sun  Dinner     2  0.710345</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(tips.groupby(<span class="string">&#x27;smoker&#x27;</span>, group_keys=<span class="literal">False</span>).apply(top))</span><br><span class="line"><span class="comment">#      total_bill   tip smoker   day    time  size   tip_pct</span></span><br><span class="line"><span class="comment"># 88        24.71  5.85     No  Thur   Lunch     2  0.236746</span></span><br><span class="line"><span class="comment"># 185       20.69  5.00     No   Sun  Dinner     5  0.241663</span></span><br><span class="line"><span class="comment"># 51        10.29  2.60     No   Sun  Dinner     2  0.252672</span></span><br><span class="line"><span class="comment"># 149        7.51  2.00     No  Thur   Lunch     2  0.266312</span></span><br><span class="line"><span class="comment"># 232       11.61  3.39     No   Sat  Dinner     2  0.291990</span></span><br><span class="line"><span class="comment"># 109       14.31  4.00    Yes   Sat  Dinner     2  0.279525</span></span><br><span class="line"><span class="comment"># 183       23.17  6.50    Yes   Sun  Dinner     4  0.280535</span></span><br><span class="line"><span class="comment"># 67         3.07  1.00    Yes   Sat  Dinner     1  0.325733</span></span><br><span class="line"><span class="comment"># 178        9.60  4.00    Yes   Sun  Dinner     2  0.416667</span></span><br><span class="line"><span class="comment"># 172        7.25  5.15    Yes   Sun  Dinner     2  0.710345</span></span><br></pre></td></tr></table></figure>



<p>分位数和桶分析</p>
<p>根据指定⾯元或样本分位数将数据拆分成多块的函数（⽐如cut和qcut）跟groupby结合起来就可以实现桶（bucket）分析,分位数（quantile）分析:<br><strong>由cut返回的Categorical对象可直接传递到groupby</strong>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">np.random.seed(<span class="number">888</span>)</span><br><span class="line">frame = pd.DataFrame(&#123;<span class="string">&#x27;data1&#x27;</span>: np.random.randn(<span class="number">1000</span>),</span><br><span class="line">                      <span class="string">&#x27;data2&#x27;</span>: np.random.randn(<span class="number">1000</span>)&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(frame)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切成4个分类</span></span><br><span class="line">quartiles = pd.cut(frame.data1, <span class="number">4</span>)</span><br><span class="line"><span class="built_in">print</span>(quartiles[:<span class="number">10</span>])</span><br><span class="line"><span class="comment"># 0    (-1.446, 0.101]</span></span><br><span class="line"><span class="comment"># 1     (0.101, 1.649]</span></span><br><span class="line"><span class="comment"># 2     (0.101, 1.649]</span></span><br><span class="line"><span class="comment"># 3    (-1.446, 0.101]</span></span><br><span class="line"><span class="comment"># 4    (-1.446, 0.101]</span></span><br><span class="line"><span class="comment"># 5    (-1.446, 0.101]</span></span><br><span class="line"><span class="comment"># 6     (0.101, 1.649]</span></span><br><span class="line"><span class="comment"># 7     (0.101, 1.649]</span></span><br><span class="line"><span class="comment"># 8    (-1.446, 0.101]</span></span><br><span class="line"><span class="comment"># 9    (-1.446, 0.101]</span></span><br><span class="line"><span class="comment"># Name: data1, dtype: category</span></span><br><span class="line"><span class="comment"># Categories (4, interval[float64]): [(-2.999, -1.446] &lt; (-1.446, 0.101] &lt; (0.101, 1.649] &lt;</span></span><br><span class="line"><span class="comment">#                                     (1.649, 3.196]]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_stats</span>(<span class="params">group</span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&#x27;min&#x27;</span>: group.<span class="built_in">min</span>(), <span class="string">&#x27;max&#x27;</span>: group.<span class="built_in">max</span>(),</span><br><span class="line">            <span class="string">&#x27;count&#x27;</span>: group.count(), <span class="string">&#x27;mean&#x27;</span>: group.mean()&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 直接将cut函数返回的Categories对象传给groupby函数</span></span><br><span class="line">grouped = frame.data2.groupby(quartiles)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 得出每个分类的聚合数据:</span></span><br><span class="line"><span class="built_in">print</span>(grouped.apply(get_stats).unstack())</span><br><span class="line"><span class="comment">#                   count       max      mean       min</span></span><br><span class="line"><span class="comment"># data1                                                </span></span><br><span class="line"><span class="comment"># (-2.999, -1.446]   72.0  2.654189 -0.056724 -2.421468</span></span><br><span class="line"><span class="comment"># (-1.446, 0.101]   452.0  3.033133  0.016806 -3.636365</span></span><br><span class="line"><span class="comment"># (0.101, 1.649]    433.0  3.557303  0.028364 -3.362788</span></span><br><span class="line"><span class="comment"># (1.649, 3.196]     43.0  2.086797  0.125453 -1.510303</span></span><br></pre></td></tr></table></figure>

<p>我们将这四个分类称之为<code>桶</code>.<br>上面这段代码我们得到了四个桶的聚合数据,这就是<code>桶分析</code></p>
<p>现在要使用<code>分位数分析</code>,只要根据样本分位数得到⼤⼩相等的桶，使⽤qcut即可。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">np.random.seed(<span class="number">888</span>)</span><br><span class="line">frame = pd.DataFrame(&#123;<span class="string">&#x27;data1&#x27;</span>: np.random.randn(<span class="number">1000</span>),</span><br><span class="line">                      <span class="string">&#x27;data2&#x27;</span>: np.random.randn(<span class="number">1000</span>)&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(frame)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切成4个分类</span></span><br><span class="line">quartiles = pd.cut(frame.data1, <span class="number">4</span>)</span><br><span class="line"><span class="built_in">print</span>(quartiles[:<span class="number">10</span>])</span><br><span class="line"><span class="comment"># 0    (-1.446, 0.101]</span></span><br><span class="line"><span class="comment"># 1     (0.101, 1.649]</span></span><br><span class="line"><span class="comment"># 2     (0.101, 1.649]</span></span><br><span class="line"><span class="comment"># 3    (-1.446, 0.101]</span></span><br><span class="line"><span class="comment"># 4    (-1.446, 0.101]</span></span><br><span class="line"><span class="comment"># 5    (-1.446, 0.101]</span></span><br><span class="line"><span class="comment"># 6     (0.101, 1.649]</span></span><br><span class="line"><span class="comment"># 7     (0.101, 1.649]</span></span><br><span class="line"><span class="comment"># 8    (-1.446, 0.101]</span></span><br><span class="line"><span class="comment"># 9    (-1.446, 0.101]</span></span><br><span class="line"><span class="comment"># Name: data1, dtype: category</span></span><br><span class="line"><span class="comment"># Categories (4, interval[float64]): [(-2.999, -1.446] &lt; (-1.446, 0.101] &lt; (0.101, 1.649] &lt;</span></span><br><span class="line"><span class="comment">#                                     (1.649, 3.196]]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_stats</span>(<span class="params">group</span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&#x27;min&#x27;</span>: group.<span class="built_in">min</span>(), <span class="string">&#x27;max&#x27;</span>: group.<span class="built_in">max</span>(),</span><br><span class="line">            <span class="string">&#x27;count&#x27;</span>: group.count(), <span class="string">&#x27;mean&#x27;</span>: group.mean()&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 直接将cut函数返回的Categories对象传给groupby函数</span></span><br><span class="line">grouped = frame.data2.groupby(quartiles)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(grouped.apply(get_stats))</span><br><span class="line"><span class="comment"># data1                  </span></span><br><span class="line"><span class="comment"># (-2.999, -1.446]  count     72.000000</span></span><br><span class="line"><span class="comment">#                   max        2.654189</span></span><br><span class="line"><span class="comment">#                   mean      -0.056724</span></span><br><span class="line"><span class="comment">#                   min       -2.421468</span></span><br><span class="line"><span class="comment"># (-1.446, 0.101]   count    452.000000</span></span><br><span class="line"><span class="comment">#                   max        3.033133</span></span><br><span class="line"><span class="comment">#                   mean       0.016806</span></span><br><span class="line"><span class="comment">#                   min       -3.636365</span></span><br><span class="line"><span class="comment"># (0.101, 1.649]    count    433.000000</span></span><br><span class="line"><span class="comment">#                   max        3.557303</span></span><br><span class="line"><span class="comment">#                   mean       0.028364</span></span><br><span class="line"><span class="comment">#                   min       -3.362788</span></span><br><span class="line"><span class="comment"># (1.649, 3.196]    count     43.000000</span></span><br><span class="line"><span class="comment">#                   max        2.086797</span></span><br><span class="line"><span class="comment">#                   mean       0.125453</span></span><br><span class="line"><span class="comment">#                   min       -1.510303</span></span><br><span class="line"><span class="comment"># Name: data2, dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 得出每个分类的聚合数据:</span></span><br><span class="line"><span class="built_in">print</span>(grouped.apply(get_stats).unstack())</span><br><span class="line"><span class="comment">#                   count       max      mean       min</span></span><br><span class="line"><span class="comment"># data1                                                </span></span><br><span class="line"><span class="comment"># (-2.999, -1.446]   72.0  2.654189 -0.056724 -2.421468</span></span><br><span class="line"><span class="comment"># (-1.446, 0.101]   452.0  3.033133  0.016806 -3.636365</span></span><br><span class="line"><span class="comment"># (0.101, 1.649]    433.0  3.557303  0.028364 -3.362788</span></span><br><span class="line"><span class="comment"># (1.649, 3.196]     43.0  2.086797  0.125453 -1.510303</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">grouping = pd.qcut(frame.data1, <span class="number">10</span>)</span><br><span class="line">grouped = frame.data2.groupby(grouping)</span><br><span class="line"><span class="built_in">print</span>(grouped.apply(get_stats).unstack())</span><br><span class="line"><span class="comment">#                                count       max      mean       min</span></span><br><span class="line"><span class="comment"># data1                                                             </span></span><br><span class="line"><span class="comment"># (-2.9939999999999998, -1.276]  100.0  2.654189  0.035025 -2.421468</span></span><br><span class="line"><span class="comment"># (-1.276, -0.832]               100.0  3.033133  0.005532 -2.630387</span></span><br><span class="line"><span class="comment"># (-0.832, -0.494]               100.0  2.414314  0.018984 -2.816920</span></span><br><span class="line"><span class="comment"># (-0.494, -0.221]               100.0  2.520152 -0.014124 -2.066315</span></span><br><span class="line"><span class="comment"># (-0.221, 0.0408]               100.0  2.183119  0.003323 -3.636365</span></span><br><span class="line"><span class="comment"># (0.0408, 0.25]                 100.0  2.689091 -0.045195 -3.226533</span></span><br><span class="line"><span class="comment"># (0.25, 0.501]                  100.0  2.263420  0.088561 -2.077910</span></span><br><span class="line"><span class="comment"># (0.501, 0.829]                 100.0  2.376516  0.107365 -2.232905</span></span><br><span class="line"><span class="comment"># (0.829, 1.265]                 100.0  3.557303 -0.033168 -3.362788</span></span><br><span class="line"><span class="comment"># (1.265, 3.196]                 100.0  2.323520  0.045576 -1.779255</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 传⼊labels=False即可只获取分位数的编号：</span></span><br><span class="line">grouping = pd.qcut(frame.data1, <span class="number">10</span>, labels=<span class="literal">False</span>)</span><br><span class="line">grouped = frame.data2.groupby(grouping)</span><br><span class="line"><span class="built_in">print</span>(grouped.apply(get_stats).unstack())</span><br><span class="line"><span class="comment">#        count       max      mean       min</span></span><br><span class="line"><span class="comment"># data1                                     </span></span><br><span class="line"><span class="comment"># 0      100.0  2.654189  0.035025 -2.421468</span></span><br><span class="line"><span class="comment"># 1      100.0  3.033133  0.005532 -2.630387</span></span><br><span class="line"><span class="comment"># 2      100.0  2.414314  0.018984 -2.816920</span></span><br><span class="line"><span class="comment"># 3      100.0  2.520152 -0.014124 -2.066315</span></span><br><span class="line"><span class="comment"># 4      100.0  2.183119  0.003323 -3.636365</span></span><br><span class="line"><span class="comment"># 5      100.0  2.689091 -0.045195 -3.226533</span></span><br><span class="line"><span class="comment"># 6      100.0  2.263420  0.088561 -2.077910</span></span><br><span class="line"><span class="comment"># 7      100.0  2.376516  0.107365 -2.232905</span></span><br><span class="line"><span class="comment"># 8      100.0  3.557303 -0.033168 -3.362788</span></span><br><span class="line"><span class="comment"># 9      100.0  2.323520  0.045576 -1.779255</span></span><br></pre></td></tr></table></figure>



<p>示例：⽤特定于分组的值填充缺失值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">np.random.seed(<span class="number">888</span>)</span><br><span class="line">s = pd.Series(np.random.randn(<span class="number">6</span>))</span><br><span class="line">s[::<span class="number">2</span>] = np.nan</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(s)</span><br><span class="line"><span class="comment"># 0         NaN</span></span><br><span class="line"><span class="comment"># 1    0.188876</span></span><br><span class="line"><span class="comment"># 2         NaN</span></span><br><span class="line"><span class="comment"># 3   -0.032447</span></span><br><span class="line"><span class="comment"># 4         NaN</span></span><br><span class="line"><span class="comment"># 5   -0.105339</span></span><br><span class="line"><span class="comment"># dtype: float64</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用平均值填充NA</span></span><br><span class="line"><span class="built_in">print</span>(s.fillna(s.mean()))</span><br><span class="line"><span class="comment"># 0    0.017030</span></span><br><span class="line"><span class="comment"># 1    0.188876</span></span><br><span class="line"><span class="comment"># 2    0.017030</span></span><br><span class="line"><span class="comment"># 3   -0.032447</span></span><br><span class="line"><span class="comment"># 4    0.017030</span></span><br><span class="line"><span class="comment"># 5   -0.105339</span></span><br><span class="line"><span class="comment"># dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">states = [<span class="string">&#x27;Ohio&#x27;</span>, <span class="string">&#x27;New York&#x27;</span>, <span class="string">&#x27;Vermont&#x27;</span>, <span class="string">&#x27;Florida&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;Oregon&#x27;</span>, <span class="string">&#x27;Nevada&#x27;</span>, <span class="string">&#x27;California&#x27;</span>, <span class="string">&#x27;Idaho&#x27;</span>]</span><br><span class="line">data = pd.Series(np.random.randn(<span class="number">8</span>), index=states)</span><br><span class="line">data[[<span class="string">&#x27;Vermont&#x27;</span>, <span class="string">&#x27;Nevada&#x27;</span>, <span class="string">&#x27;Idaho&#x27;</span>]] = np.nan</span><br><span class="line"><span class="built_in">print</span>(data)</span><br><span class="line"><span class="comment"># Ohio          0.217776</span></span><br><span class="line"><span class="comment"># New York      0.587282</span></span><br><span class="line"><span class="comment"># Vermont            NaN</span></span><br><span class="line"><span class="comment"># Florida      -1.099947</span></span><br><span class="line"><span class="comment"># Oregon       -0.255305</span></span><br><span class="line"><span class="comment"># Nevada             NaN</span></span><br><span class="line"><span class="comment"># California    0.162664</span></span><br><span class="line"><span class="comment"># Idaho              NaN</span></span><br><span class="line"><span class="comment"># dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用group_key作为分组键</span></span><br><span class="line">group_key = [<span class="string">&#x27;East&#x27;</span>] * <span class="number">4</span> + [<span class="string">&#x27;West&#x27;</span>] * <span class="number">4</span></span><br><span class="line"><span class="comment"># 比如-0.046321=(-0.255305+0.162664)/2</span></span><br><span class="line"><span class="built_in">print</span>(data.groupby(group_key).mean())</span><br><span class="line"><span class="comment"># East   -0.098296</span></span><br><span class="line"><span class="comment"># West   -0.046321</span></span><br><span class="line"><span class="comment"># dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用fillna填充NA值:</span></span><br><span class="line"><span class="built_in">print</span>(data.fillna(data.mean()))</span><br><span class="line"><span class="comment"># Ohio          0.217776</span></span><br><span class="line"><span class="comment"># New York      0.587282</span></span><br><span class="line"><span class="comment"># Vermont      -0.077506</span></span><br><span class="line"><span class="comment"># Florida      -1.099947</span></span><br><span class="line"><span class="comment"># Oregon       -0.255305</span></span><br><span class="line"><span class="comment"># Nevada       -0.077506</span></span><br><span class="line"><span class="comment"># California    0.162664</span></span><br><span class="line"><span class="comment"># Idaho        -0.077506</span></span><br><span class="line"><span class="comment"># dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ⽤分组平均值去填充NA值:</span></span><br><span class="line">fill_mean = <span class="keyword">lambda</span> g: g.fillna(g.mean())</span><br><span class="line"><span class="built_in">print</span>(data.groupby(group_key).apply(fill_mean))</span><br><span class="line"><span class="comment"># Ohio          0.217776</span></span><br><span class="line"><span class="comment"># New York      0.587282</span></span><br><span class="line"><span class="comment"># Vermont      -0.098296</span></span><br><span class="line"><span class="comment"># Florida      -1.099947</span></span><br><span class="line"><span class="comment"># Oregon       -0.255305</span></span><br><span class="line"><span class="comment"># Nevada       -0.046321</span></span><br><span class="line"><span class="comment"># California    0.162664</span></span><br><span class="line"><span class="comment"># Idaho        -0.046321</span></span><br><span class="line"><span class="comment"># dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用字典预定义各组的填充值。</span></span><br><span class="line"><span class="comment"># 使用分组的name属性</span></span><br><span class="line">fill_values = &#123;<span class="string">&#x27;East&#x27;</span>: <span class="number">0.5</span>, <span class="string">&#x27;West&#x27;</span>: -<span class="number">1</span>&#125;</span><br><span class="line">fill_func = <span class="keyword">lambda</span> g: g.fillna(fill_values[g.name])</span><br><span class="line"><span class="built_in">print</span>(data.groupby(group_key).apply(fill_func))</span><br><span class="line"><span class="comment"># Ohio          0.217776</span></span><br><span class="line"><span class="comment"># New York      0.587282</span></span><br><span class="line"><span class="comment"># Vermont       0.500000</span></span><br><span class="line"><span class="comment"># Florida      -1.099947</span></span><br><span class="line"><span class="comment"># Oregon       -0.255305</span></span><br><span class="line"><span class="comment"># Nevada       -1.000000</span></span><br><span class="line"><span class="comment"># California    0.162664</span></span><br><span class="line"><span class="comment"># Idaho        -1.000000</span></span><br><span class="line"><span class="comment"># dtype: float64</span></span><br></pre></td></tr></table></figure>



<p>示例：随机采样和排列</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">np.random.seed(<span class="number">888</span>)</span><br><span class="line">suits = [<span class="string">&#x27;H&#x27;</span>, <span class="string">&#x27;S&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;D&#x27;</span>]</span><br><span class="line">base_names = [<span class="string">&#x27;A&#x27;</span>] + <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">2</span>, <span class="number">11</span>)) + [<span class="string">&#x27;J&#x27;</span>, <span class="string">&#x27;K&#x27;</span>, <span class="string">&#x27;Q&#x27;</span>]</span><br><span class="line">cards = []</span><br><span class="line"><span class="keyword">for</span> suit <span class="keyword">in</span> [<span class="string">&#x27;H&#x27;</span>, <span class="string">&#x27;S&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;D&#x27;</span>]:</span><br><span class="line">    cards.extend(<span class="built_in">str</span>(num) + suit <span class="keyword">for</span> num <span class="keyword">in</span> base_names)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 不同的扑克牌对应不同的分数</span></span><br><span class="line">card_val = (<span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">1</span>, <span class="number">11</span>)) + [<span class="number">10</span>] * <span class="number">3</span>) * <span class="number">4</span></span><br><span class="line">deck = pd.Series(card_val, index=cards)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(deck[:<span class="number">13</span>])</span><br><span class="line"><span class="comment"># AH      1</span></span><br><span class="line"><span class="comment"># 2H      2</span></span><br><span class="line"><span class="comment"># 3H      3</span></span><br><span class="line"><span class="comment"># 4H      4</span></span><br><span class="line"><span class="comment"># 5H      5</span></span><br><span class="line"><span class="comment"># 6H      6</span></span><br><span class="line"><span class="comment"># 7H      7</span></span><br><span class="line"><span class="comment"># 8H      8</span></span><br><span class="line"><span class="comment"># 9H      9</span></span><br><span class="line"><span class="comment"># 10H    10</span></span><br><span class="line"><span class="comment"># JH     10</span></span><br><span class="line"><span class="comment"># KH     10</span></span><br><span class="line"><span class="comment"># QH     10</span></span><br><span class="line"><span class="comment"># dtype: int64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对Series使⽤sample⽅法：</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">draw</span>(<span class="params">deck, n=<span class="number">5</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> deck.sample(n)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(draw(deck))</span><br><span class="line"><span class="comment"># KH    10</span></span><br><span class="line"><span class="comment"># QS    10</span></span><br><span class="line"><span class="comment"># 6H     6</span></span><br><span class="line"><span class="comment"># 2C     2</span></span><br><span class="line"><span class="comment"># 3C     3</span></span><br><span class="line"><span class="comment"># dtype: int64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 最后一个字母是花色</span></span><br><span class="line">get_suit = <span class="keyword">lambda</span> card: card[-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 按花色分组并且随机抽样出2个</span></span><br><span class="line"><span class="built_in">print</span>(deck.groupby(get_suit).apply(draw, n=<span class="number">2</span>))</span><br><span class="line"><span class="comment"># C  QC    10</span></span><br><span class="line"><span class="comment">#    2C     2</span></span><br><span class="line"><span class="comment"># D  QD    10</span></span><br><span class="line"><span class="comment">#    KD    10</span></span><br><span class="line"><span class="comment"># H  3H     3</span></span><br><span class="line"><span class="comment">#    4H     4</span></span><br><span class="line"><span class="comment"># S  JS    10</span></span><br><span class="line"><span class="comment">#    3S     3</span></span><br><span class="line"><span class="comment"># dtype: int64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 取消分组的索引</span></span><br><span class="line"><span class="built_in">print</span>(deck.groupby(get_suit, group_keys=<span class="literal">False</span>).apply(draw, n=<span class="number">2</span>))</span><br><span class="line"><span class="comment"># 7C      7</span></span><br><span class="line"><span class="comment"># AC      1</span></span><br><span class="line"><span class="comment"># 4D      4</span></span><br><span class="line"><span class="comment"># QD     10</span></span><br><span class="line"><span class="comment"># 7H      7</span></span><br><span class="line"><span class="comment"># JH     10</span></span><br><span class="line"><span class="comment"># 10S    10</span></span><br><span class="line"><span class="comment"># QS     10</span></span><br><span class="line"><span class="comment"># dtype: int64</span></span><br></pre></td></tr></table></figure>



<p>示例：分组加权平均数和相关系数</p>
<p>进⾏DataFrame的列与列之间或两个Series之间的运算（⽐如分组加权平均）</p>
<ul>
<li><p><code>spx_corr = lambda x: x.corrwith(x[&#39;SPX&#39;])</code>:</p>
<p>计算x每一列与SPX列的相关系数</p>
</li>
<li><p><code>rets = close_px.pct_change().dropna()</code>:<br>计算close_px的百分比变化,并且丢掉na.<br>(pct_change()函数:将每个元素与其前一个元素进行比较，并计算变化百分比.默认情况下，<code>pct_change()</code>对列进行操作; 如果想应用到行上，那么可使用<code>axis = 1</code>参数。)</p>
<p>计算变化率：（后一个值 - 前一个值）／前一个值</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">np.random.seed(<span class="number">888</span>)</span><br><span class="line">df = pd.DataFrame(&#123;<span class="string">&#x27;category&#x27;</span>: [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;a&#x27;</span>,</span><br><span class="line">                                <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;b&#x27;</span>],</span><br><span class="line">                   <span class="string">&#x27;data&#x27;</span>: np.random.randn(<span class="number">8</span>),</span><br><span class="line">                   <span class="string">&#x27;weights&#x27;</span>: np.random.rand(<span class="number">8</span>)&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(df)</span><br><span class="line"><span class="comment">#   category      data   weights</span></span><br><span class="line"><span class="comment"># 0        a -0.176201  0.132953</span></span><br><span class="line"><span class="comment"># 1        a  0.188876  0.533449</span></span><br><span class="line"><span class="comment"># 2        a  0.826747  0.899478</span></span><br><span class="line"><span class="comment"># 3        a -0.032447  0.248365</span></span><br><span class="line"><span class="comment"># 4        b -0.652499  0.030172</span></span><br><span class="line"><span class="comment"># 5        b -0.105339  0.072447</span></span><br><span class="line"><span class="comment"># 6        b  0.217776  0.874164</span></span><br><span class="line"><span class="comment"># 7        b  0.587282  0.558430</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">grouped = df.groupby(<span class="string">&#x27;category&#x27;</span>)</span><br><span class="line">get_wavg = <span class="keyword">lambda</span> g: np.average(g[<span class="string">&#x27;data&#x27;</span>], weights=g[<span class="string">&#x27;weights&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据category分组,然后计算data的加权平均数</span></span><br><span class="line"><span class="built_in">print</span>(grouped.apply(get_wavg))</span><br><span class="line"><span class="comment"># category</span></span><br><span class="line"><span class="comment"># a    0.448072</span></span><br><span class="line"><span class="comment"># b    0.319831</span></span><br><span class="line"><span class="comment"># dtype: float64</span></span><br></pre></td></tr></table></figure>

<p>计算相关系数:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">close_px = pd.read_csv(<span class="string">&#x27;examples/stock_px_2.csv&#x27;</span>, parse_dates=<span class="literal">True</span>,</span><br><span class="line">                       index_col=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(close_px.info())</span><br><span class="line"><span class="comment"># &lt;class &#x27;pandas.core.frame.DataFrame&#x27;&gt;</span></span><br><span class="line"><span class="comment"># DatetimeIndex: 2214 entries, 2003-01-02 to 2011-10-14</span></span><br><span class="line"><span class="comment"># Data columns (total 4 columns):</span></span><br><span class="line"><span class="comment"># AAPL    2214 non-null float64</span></span><br><span class="line"><span class="comment"># MSFT    2214 non-null float64</span></span><br><span class="line"><span class="comment"># XOM     2214 non-null float64</span></span><br><span class="line"><span class="comment"># SPX     2214 non-null float64</span></span><br><span class="line"><span class="comment"># dtypes: float64(4)</span></span><br><span class="line"><span class="comment"># memory usage: 86.5 KB</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(close_px[-<span class="number">4</span>:])</span><br><span class="line"><span class="comment">#               AAPL   MSFT    XOM      SPX</span></span><br><span class="line"><span class="comment"># 2011-10-11  400.29  27.00  76.27  1195.54</span></span><br><span class="line"><span class="comment"># 2011-10-12  402.19  26.96  77.16  1207.25</span></span><br><span class="line"><span class="comment"># 2011-10-13  408.43  27.18  76.37  1203.66</span></span><br><span class="line"><span class="comment"># 2011-10-14  422.00  27.27  78.11  1224.58</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算x每一列与SPX列的相关系数</span></span><br><span class="line">spx_corr = <span class="keyword">lambda</span> x: x.corrwith(x[<span class="string">&#x27;SPX&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算close_px的百分比变化,并且丢掉na</span></span><br><span class="line">rets = close_px.pct_change().dropna()</span><br><span class="line"></span><br><span class="line">get_year = <span class="keyword">lambda</span> x: x.year</span><br><span class="line"></span><br><span class="line">by_year = rets.groupby(get_year)</span><br><span class="line"><span class="built_in">print</span>(by_year.apply(spx_corr))</span><br><span class="line"><span class="comment">#           AAPL      MSFT       XOM  SPX</span></span><br><span class="line"><span class="comment"># 2003  0.541124  0.745174  0.661265  1.0</span></span><br><span class="line"><span class="comment"># 2004  0.374283  0.588531  0.557742  1.0</span></span><br><span class="line"><span class="comment"># 2005  0.467540  0.562374  0.631010  1.0</span></span><br><span class="line"><span class="comment"># 2006  0.428267  0.406126  0.518514  1.0</span></span><br><span class="line"><span class="comment"># 2007  0.508118  0.658770  0.786264  1.0</span></span><br><span class="line"><span class="comment"># 2008  0.681434  0.804626  0.828303  1.0</span></span><br><span class="line"><span class="comment"># 2009  0.707103  0.654902  0.797921  1.0</span></span><br><span class="line"><span class="comment"># 2010  0.710105  0.730118  0.839057  1.0</span></span><br><span class="line"><span class="comment"># 2011  0.691931  0.800996  0.859975  1.0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据年份分组,计算AAPL列与MSFT列的相关系数</span></span><br><span class="line"><span class="built_in">print</span>(by_year.apply(<span class="keyword">lambda</span> g: g[<span class="string">&#x27;AAPL&#x27;</span>].corr(g[<span class="string">&#x27;MSFT&#x27;</span>])))</span><br><span class="line"><span class="comment"># 2003    0.480868</span></span><br><span class="line"><span class="comment"># 2004    0.259024</span></span><br><span class="line"><span class="comment"># 2005    0.300093</span></span><br><span class="line"><span class="comment"># 2006    0.161735</span></span><br><span class="line"><span class="comment"># 2007    0.417738</span></span><br><span class="line"><span class="comment"># 2008    0.611901</span></span><br><span class="line"><span class="comment"># 2009    0.432738</span></span><br><span class="line"><span class="comment"># 2010    0.571946</span></span><br><span class="line"><span class="comment"># 2011    0.581987</span></span><br><span class="line"><span class="comment"># dtype: float64</span></span><br></pre></td></tr></table></figure>



<p>示例：组级别的线性回归</p>
<p>观察上面的代码,得知:<br>==只要函数返回的是pandas对象或标量值,我们就可以把这个函数应用到groupby语句中==</p>
<p>所以,我们可以用各种杂七杂八的函数来groupby</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> statsmodels.api <span class="keyword">as</span> sm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">close_px = pd.read_csv(<span class="string">&#x27;examples/stock_px_2.csv&#x27;</span>, parse_dates=<span class="literal">True</span>,index_col=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(close_px[-<span class="number">4</span>:])</span><br><span class="line"><span class="comment">#               AAPL   MSFT    XOM      SPX</span></span><br><span class="line"><span class="comment"># 2011-10-11  400.29  27.00  76.27  1195.54</span></span><br><span class="line"><span class="comment"># 2011-10-12  402.19  26.96  77.16  1207.25</span></span><br><span class="line"><span class="comment"># 2011-10-13  408.43  27.18  76.37  1203.66</span></span><br><span class="line"><span class="comment"># 2011-10-14  422.00  27.27  78.11  1224.58</span></span><br><span class="line"></span><br><span class="line">rets = close_px.pct_change().dropna()</span><br><span class="line">by_year = rets.groupby(<span class="keyword">lambda</span> x: x.year)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对各数据块执⾏普通最⼩⼆乘法回归</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">regress</span>(<span class="params">data, yvar, xvars</span>):</span></span><br><span class="line">    Y = data[yvar]</span><br><span class="line">    X = data[xvars]</span><br><span class="line">    X[<span class="string">&#x27;intercept&#x27;</span>] = <span class="number">1.</span></span><br><span class="line">    result = sm.OLS(Y, X).fit()</span><br><span class="line">    <span class="keyword">return</span> result.params</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(by_year.apply(regress, <span class="string">&#x27;AAPL&#x27;</span>, [<span class="string">&#x27;SPX&#x27;</span>]))</span><br><span class="line"><span class="comment">#            SPX  intercept</span></span><br><span class="line"><span class="comment"># 2003  1.195406   0.000710</span></span><br><span class="line"><span class="comment"># 2004  1.363463   0.004201</span></span><br><span class="line"><span class="comment"># 2005  1.766415   0.003246</span></span><br><span class="line"><span class="comment"># 2006  1.645496   0.000080</span></span><br><span class="line"><span class="comment"># 2007  1.198761   0.003438</span></span><br><span class="line"><span class="comment"># 2008  0.968016  -0.001110</span></span><br><span class="line"><span class="comment"># 2009  0.879103   0.002954</span></span><br><span class="line"><span class="comment"># 2010  1.052608   0.001261</span></span><br><span class="line"><span class="comment"># 2011  0.806605   0.001514import numpy as np</span></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> statsmodels.api <span class="keyword">as</span> sm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">close_px = pd.read_csv(<span class="string">&#x27;examples/stock_px_2.csv&#x27;</span>, parse_dates=<span class="literal">True</span>,index_col=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(close_px[-<span class="number">4</span>:])</span><br><span class="line"><span class="comment">#               AAPL   MSFT    XOM      SPX</span></span><br><span class="line"><span class="comment"># 2011-10-11  400.29  27.00  76.27  1195.54</span></span><br><span class="line"><span class="comment"># 2011-10-12  402.19  26.96  77.16  1207.25</span></span><br><span class="line"><span class="comment"># 2011-10-13  408.43  27.18  76.37  1203.66</span></span><br><span class="line"><span class="comment"># 2011-10-14  422.00  27.27  78.11  1224.58</span></span><br><span class="line"></span><br><span class="line">rets = close_px.pct_change().dropna()</span><br><span class="line">by_year = rets.groupby(<span class="keyword">lambda</span> x: x.year)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对各数据块执⾏普通最⼩⼆乘法回归</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">regress</span>(<span class="params">data, yvar, xvars</span>):</span></span><br><span class="line">    Y = data[yvar]</span><br><span class="line">    X = data[xvars]</span><br><span class="line">    X[<span class="string">&#x27;intercept&#x27;</span>] = <span class="number">1.</span></span><br><span class="line">    result = sm.OLS(Y, X).fit()</span><br><span class="line">    <span class="keyword">return</span> result.params</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(by_year.apply(regress, <span class="string">&#x27;AAPL&#x27;</span>, [<span class="string">&#x27;SPX&#x27;</span>]))</span><br><span class="line"><span class="comment">#            SPX  intercept</span></span><br><span class="line"><span class="comment"># 2003  1.195406   0.000710</span></span><br><span class="line"><span class="comment"># 2004  1.363463   0.004201</span></span><br><span class="line"><span class="comment"># 2005  1.766415   0.003246</span></span><br><span class="line"><span class="comment"># 2006  1.645496   0.000080</span></span><br><span class="line"><span class="comment"># 2007  1.198761   0.003438</span></span><br><span class="line"><span class="comment"># 2008  0.968016  -0.001110</span></span><br><span class="line"><span class="comment"># 2009  0.879103   0.002954</span></span><br><span class="line"><span class="comment"># 2010  1.052608   0.001261</span></span><br><span class="line"><span class="comment"># 2011  0.806605   0.001514</span></span><br></pre></td></tr></table></figure>



<hr>
<h2 id="10-4-透视表和交叉表"><a href="#10-4-透视表和交叉表" class="headerlink" title="10.4 透视表和交叉表"></a>10.4 透视表和交叉表</h2><p>透视表（pivot table）:<br>它根据⼀个或多个键对数据进⾏聚合，并根据⾏和列上的分组键将数据分配到各个矩形区域中。</p>
<p>制作透视表的函数</p>
<ul>
<li><p>可以通过本章所介绍的groupby功能以及（能够利⽤层次化索引的）重塑运算制作透视表。</p>
</li>
<li><p>DataFrame的pivot_table⽅法</p>
</li>
<li><p>顶级的pandas.pivot_table函数。<br>(pivot_table的默认聚合类型为平均数)</p>
<p>(这个函数和除能为groupby提供便利之外，pivot_table还可以添加分项⼩计，也叫做margins。)</p>
</li>
</ul>
<p>pivot_table参数:</p>
<ul>
<li>values:要聚合的列</li>
<li>index:根据什么列进行分组(放到行索引)</li>
<li>columns:根据什么列进行分组(放到列索引)</li>
<li>aggfunc:聚合函数,确定分组的数据如何聚合</li>
<li>fill_value:替换缺失值</li>
<li>margins:添加分项⼩计</li>
<li>margins_name:小计列/小计行名称</li>
<li>dropna:是否丢掉全是NaN的行/列</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tips = pd.read_csv(<span class="string">&#x27;examples/tips.csv&#x27;</span>)</span><br><span class="line"></span><br><span class="line">tips[<span class="string">&#x27;tip_pct&#x27;</span>] = tips[<span class="string">&#x27;tip&#x27;</span>] / tips[<span class="string">&#x27;total_bill&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(tips[:<span class="number">6</span>])</span><br><span class="line"><span class="comment">#    total_bill   tip smoker  day    time  size   tip_pct</span></span><br><span class="line"><span class="comment"># 0       16.99  1.01     No  Sun  Dinner     2  0.059447</span></span><br><span class="line"><span class="comment"># 1       10.34  1.66     No  Sun  Dinner     3  0.160542</span></span><br><span class="line"><span class="comment"># 2       21.01  3.50     No  Sun  Dinner     3  0.166587</span></span><br><span class="line"><span class="comment"># 3       23.68  3.31     No  Sun  Dinner     2  0.139780</span></span><br><span class="line"><span class="comment"># 4       24.59  3.61     No  Sun  Dinner     4  0.146808</span></span><br><span class="line"><span class="comment"># 5       25.29  4.71     No  Sun  Dinner     4  0.186240</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据day和smoker计算分组平均数</span></span><br><span class="line"><span class="comment"># 将day和smoker放到⾏,单元格的值为各个分组的平均数</span></span><br><span class="line"><span class="built_in">print</span>(tips.pivot_table(index=[<span class="string">&#x27;day&#x27;</span>, <span class="string">&#x27;smoker&#x27;</span>]))</span><br><span class="line"><span class="comment">#                  size       tip  total_bill</span></span><br><span class="line"><span class="comment"># day  smoker                                </span></span><br><span class="line"><span class="comment"># Fri  No      2.250000  2.812500   18.420000</span></span><br><span class="line"><span class="comment">#      Yes     2.066667  2.714000   16.813333</span></span><br><span class="line"><span class="comment"># Sat  No      2.555556  3.102889   19.661778</span></span><br><span class="line"><span class="comment">#      Yes     2.476190  2.875476   21.276667</span></span><br><span class="line"><span class="comment"># Sun  No      2.929825  3.167895   20.506667</span></span><br><span class="line"><span class="comment">#      Yes     2.578947  3.516842   24.120000</span></span><br><span class="line"><span class="comment"># Thur No      2.488889  2.673778   17.113111</span></span><br><span class="line"><span class="comment">#      Yes     2.352941  3.030000   19.190588</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据time和day进⾏分组,聚合tip_pct和size</span></span><br><span class="line"><span class="comment"># 将smoker放到列上，把day放到⾏上：</span></span><br><span class="line"><span class="built_in">print</span>(tips.pivot_table([<span class="string">&#x27;tip_pct&#x27;</span>, <span class="string">&#x27;size&#x27;</span>], index=[<span class="string">&#x27;time&#x27;</span>, <span class="string">&#x27;day&#x27;</span>],columns=<span class="string">&#x27;smoker&#x27;</span>))</span><br><span class="line"><span class="comment">#                  size             tip_pct          </span></span><br><span class="line"><span class="comment"># smoker             No       Yes        No       Yes</span></span><br><span class="line"><span class="comment"># time   day                                         </span></span><br><span class="line"><span class="comment"># Dinner Fri   2.000000  2.222222  0.139622  0.165347</span></span><br><span class="line"><span class="comment">#        Sat   2.555556  2.476190  0.158048  0.147906</span></span><br><span class="line"><span class="comment">#        Sun   2.929825  2.578947  0.160113  0.187250</span></span><br><span class="line"><span class="comment">#        Thur  2.000000       NaN  0.159744       NaN</span></span><br><span class="line"><span class="comment"># Lunch  Fri   3.000000  1.833333  0.187735  0.188937</span></span><br><span class="line"><span class="comment">#        Thur  2.500000  2.352941  0.160311  0.163863</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># margins:添加标签为All的⾏和列</span></span><br><span class="line"><span class="built_in">print</span>(tips.pivot_table([<span class="string">&#x27;tip_pct&#x27;</span>, <span class="string">&#x27;size&#x27;</span>], index=[<span class="string">&#x27;time&#x27;</span>, <span class="string">&#x27;day&#x27;</span>],columns=<span class="string">&#x27;smoker&#x27;</span>, margins=<span class="literal">True</span>))</span><br><span class="line"><span class="comment">#                  size                       tip_pct                    </span></span><br><span class="line"><span class="comment"># smoker             No       Yes       All        No       Yes       All</span></span><br><span class="line"><span class="comment"># time   day                                                             </span></span><br><span class="line"><span class="comment"># Dinner Fri   2.000000  2.222222  2.166667  0.139622  0.165347  0.158916</span></span><br><span class="line"><span class="comment">#        Sat   2.555556  2.476190  2.517241  0.158048  0.147906  0.153152</span></span><br><span class="line"><span class="comment">#        Sun   2.929825  2.578947  2.842105  0.160113  0.187250  0.166897</span></span><br><span class="line"><span class="comment">#        Thur  2.000000       NaN  2.000000  0.159744       NaN  0.159744</span></span><br><span class="line"><span class="comment"># Lunch  Fri   3.000000  1.833333  2.000000  0.187735  0.188937  0.188765</span></span><br><span class="line"><span class="comment">#        Thur  2.500000  2.352941  2.459016  0.160311  0.163863  0.161301</span></span><br><span class="line"><span class="comment"># All          2.668874  2.408602  2.569672  0.159328  0.163196  0.160803</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 传入len,得到有关分组大小的交叉表</span></span><br><span class="line"><span class="built_in">print</span>(tips.pivot_table(<span class="string">&#x27;tip_pct&#x27;</span>, index=[<span class="string">&#x27;time&#x27;</span>, <span class="string">&#x27;smoker&#x27;</span>], columns=<span class="string">&#x27;day&#x27;</span>,aggfunc=<span class="built_in">len</span>, margins=<span class="literal">True</span>))</span><br><span class="line"><span class="comment"># day             Fri   Sat   Sun  Thur    All</span></span><br><span class="line"><span class="comment"># time   smoker                               </span></span><br><span class="line"><span class="comment"># Dinner No       3.0  45.0  57.0   1.0  106.0</span></span><br><span class="line"><span class="comment">#        Yes      9.0  42.0  19.0   NaN   70.0</span></span><br><span class="line"><span class="comment"># Lunch  No       1.0   NaN   NaN  44.0   45.0</span></span><br><span class="line"><span class="comment">#        Yes      6.0   NaN   NaN  17.0   23.0</span></span><br><span class="line"><span class="comment"># All            19.0  87.0  76.0  62.0  244.0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># fill_value:替换掉NA</span></span><br><span class="line"><span class="built_in">print</span>(tips.pivot_table(<span class="string">&#x27;tip_pct&#x27;</span>, index=[<span class="string">&#x27;time&#x27;</span>, <span class="string">&#x27;size&#x27;</span>, <span class="string">&#x27;smoker&#x27;</span>],columns=<span class="string">&#x27;day&#x27;</span>, aggfunc=<span class="string">&#x27;mean&#x27;</span>, fill_value=<span class="number">0</span>))</span><br><span class="line"><span class="comment"># day                      Fri       Sat       Sun      Thur</span></span><br><span class="line"><span class="comment"># time   size smoker                                        </span></span><br><span class="line"><span class="comment"># Dinner 1    No      0.000000  0.137931  0.000000  0.000000</span></span><br><span class="line"><span class="comment">#             Yes     0.000000  0.325733  0.000000  0.000000</span></span><br><span class="line"><span class="comment">#        2    No      0.139622  0.162705  0.168859  0.159744</span></span><br><span class="line"><span class="comment">#             Yes     0.171297  0.148668  0.207893  0.000000</span></span><br><span class="line"><span class="comment">#        3    No      0.000000  0.154661  0.152663  0.000000</span></span><br><span class="line"><span class="comment">#             Yes     0.000000  0.144995  0.152660  0.000000</span></span><br><span class="line"><span class="comment">#        4    No      0.000000  0.150096  0.148143  0.000000</span></span><br><span class="line"><span class="comment">#             Yes     0.117750  0.124515  0.193370  0.000000</span></span><br><span class="line"><span class="comment">#        5    No      0.000000  0.000000  0.206928  0.000000</span></span><br><span class="line"><span class="comment">#             Yes     0.000000  0.106572  0.065660  0.000000</span></span><br><span class="line"><span class="comment">#        6    No      0.000000  0.000000  0.103799  0.000000</span></span><br><span class="line"><span class="comment"># Lunch  1    No      0.000000  0.000000  0.000000  0.181728</span></span><br><span class="line"><span class="comment">#             Yes     0.223776  0.000000  0.000000  0.000000</span></span><br><span class="line"><span class="comment">#        2    No      0.000000  0.000000  0.000000  0.166005</span></span><br><span class="line"><span class="comment">#             Yes     0.181969  0.000000  0.000000  0.158843</span></span><br><span class="line"><span class="comment">#        3    No      0.187735  0.000000  0.000000  0.084246</span></span><br><span class="line"><span class="comment">#             Yes     0.000000  0.000000  0.000000  0.204952</span></span><br><span class="line"><span class="comment">#        4    No      0.000000  0.000000  0.000000  0.138919</span></span><br><span class="line"><span class="comment">#             Yes     0.000000  0.000000  0.000000  0.155410</span></span><br><span class="line"><span class="comment">#        5    No      0.000000  0.000000  0.000000  0.121389</span></span><br><span class="line"><span class="comment">#        6    No      0.000000  0.000000  0.000000  0.173706</span></span><br></pre></td></tr></table></figure>



<p>交叉表：crosstab</p>
<p>交叉表（cross-tabulation，简称crosstab）是⼀种⽤于<strong>计算分组频率</strong>的特殊透视表。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> StringIO</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data = <span class="string">&quot;&quot;&quot;\</span></span><br><span class="line"><span class="string">Sample  Nationality  Handedness</span></span><br><span class="line"><span class="string">1   USA  Right-handed</span></span><br><span class="line"><span class="string">2   Japan    Left-handed</span></span><br><span class="line"><span class="string">3   USA  Right-handed</span></span><br><span class="line"><span class="string">4   Japan    Right-handed</span></span><br><span class="line"><span class="string">5   Japan    Left-handed</span></span><br><span class="line"><span class="string">6   Japan    Right-handed</span></span><br><span class="line"><span class="string">7   USA  Right-handed</span></span><br><span class="line"><span class="string">8   USA  Left-handed</span></span><br><span class="line"><span class="string">9   Japan    Right-handed</span></span><br><span class="line"><span class="string">10  USA  Right-handed&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data = pd.read_table(StringIO(data), sep=<span class="string">&#x27;\s+&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(data)</span><br><span class="line"><span class="comment">#    Sample Nationality    Handedness</span></span><br><span class="line"><span class="comment"># 0       1         USA  Right-handed</span></span><br><span class="line"><span class="comment"># 1       2       Japan   Left-handed</span></span><br><span class="line"><span class="comment"># 2       3         USA  Right-handed</span></span><br><span class="line"><span class="comment"># 3       4       Japan  Right-handed</span></span><br><span class="line"><span class="comment"># 4       5       Japan   Left-handed</span></span><br><span class="line"><span class="comment"># 5       6       Japan  Right-handed</span></span><br><span class="line"><span class="comment"># 6       7         USA  Right-handed</span></span><br><span class="line"><span class="comment"># 7       8         USA   Left-handed</span></span><br><span class="line"><span class="comment"># 8       9       Japan  Right-handed</span></span><br><span class="line"><span class="comment"># 9      10         USA  Right-handed</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据Nationality分组,对Handedness进行频率统计</span></span><br><span class="line"><span class="built_in">print</span>(pd.crosstab(data.Nationality, data.Handedness, margins=<span class="literal">True</span>))</span><br><span class="line"><span class="comment"># Handedness   Left-handed  Right-handed  All</span></span><br><span class="line"><span class="comment"># Nationality                                </span></span><br><span class="line"><span class="comment"># Japan                  2             3    5</span></span><br><span class="line"><span class="comment"># USA                    1             4    5</span></span><br><span class="line"><span class="comment"># All                    3             7   10</span></span><br></pre></td></tr></table></figure>







</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>