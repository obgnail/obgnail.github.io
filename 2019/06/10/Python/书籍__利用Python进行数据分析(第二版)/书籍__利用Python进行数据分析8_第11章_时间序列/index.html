<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;第11章-时间序列&quot;&gt;&lt;a href=&quot;#第11章-时间序列&quot; class=&quot;headerlink&quot; title=&quot;第11章 时间序列&quot;&gt;&lt;/a&gt;第11章 时间序列&lt;/h1&gt;&lt;p&gt;时间序列数据的意义取决于具体的应⽤场景，主要有以下⼏种："><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>利用Python进行数据分析8_第11章_时间序列 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Python/" rel="tag">Python</a></div><div class="post-time">2019-06-10</div></div></div><div class="container post-header"><h1>利用Python进行数据分析8_第11章_时间序列</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC11%E7%AB%A0-%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97"><span class="toc-number">1.</span> <span class="toc-text">第11章 时间序列</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#11-1-%E6%97%A5%E6%9C%9F%E5%92%8C%E6%97%B6%E9%97%B4%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%8F%8A%E2%BC%AF%E5%85%B7"><span class="toc-number">1.1.</span> <span class="toc-text">11.1 日期和时间数据类型及⼯具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-1-%E2%BD%87%E6%9C%9F%E5%92%8C%E6%97%B6%E9%97%B4%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%8F%8A%E2%BC%AF%E5%85%B7"><span class="toc-number">1.2.</span> <span class="toc-text">11.1 ⽇期和时间数据类型及⼯具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-2-%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E5%9F%BA%E7%A1%80"><span class="toc-number">1.3.</span> <span class="toc-text">11.2 时间序列基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-3-%E6%97%A5%E6%9C%9F%E7%9A%84%E8%8C%83%E5%9B%B4%E3%80%81%E9%A2%91%E7%8E%87%E4%BB%A5%E5%8F%8A%E7%A7%BB%E5%8A%A8"><span class="toc-number">1.4.</span> <span class="toc-text">11.3 日期的范围、频率以及移动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-4-%E6%97%B6%E5%8C%BA%E5%A4%84%E7%90%86"><span class="toc-number">1.5.</span> <span class="toc-text">11.4 时区处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-5-%E6%97%B6%E6%9C%9F%E5%8F%8A%E5%85%B6%E7%AE%97%E6%9C%AF%E8%BF%90%E7%AE%97"><span class="toc-number">1.6.</span> <span class="toc-text">11.5 时期及其算术运算</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-6-%E9%87%8D%E9%87%87%E6%A0%B7%E5%8F%8A%E9%A2%91%E7%8E%87%E8%BD%AC%E6%8D%A2"><span class="toc-number">1.7.</span> <span class="toc-text">11.6 重采样及频率转换</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-7-%E7%A7%BB%E5%8A%A8%E7%AA%97%E2%BC%9D%E5%87%BD%E6%95%B0"><span class="toc-number">1.8.</span> <span class="toc-text">11.7 移动窗⼝函数</span></a></li></ol></li></ol></details></div><div class="container post-content"><h1 id="第11章-时间序列"><a href="#第11章-时间序列" class="headerlink" title="第11章 时间序列"></a>第11章 时间序列</h1><p>时间序列数据的意义取决于具体的应⽤场景，主要有以下⼏种：</p>
<ul>
<li>时间戳（timestamp），特定的时刻。</li>
<li>固定时期（period），如2007年1⽉或2010年全年。</li>
<li>时间间隔（interval），由起始和结束时间戳表示。时期<br>（period）可以被看做间隔（interval）的特例。</li>
<li>实验或过程时间，每个时间点都是相对于特定起始时间的⼀个度量。例如，从放⼊烤箱时起，每秒钟饼⼲的直径。</li>
</ul>
<h2 id="11-1-日期和时间数据类型及⼯具"><a href="#11-1-日期和时间数据类型及⼯具" class="headerlink" title="11.1 日期和时间数据类型及⼯具"></a>11.1 日期和时间数据类型及⼯具</h2><p>Python时间日期相关的常用标准库:</p>
<ul>
<li>datetime</li>
<li>time</li>
<li>calendar</li>
</ul>
<h2 id="11-1-⽇期和时间数据类型及⼯具"><a href="#11-1-⽇期和时间数据类型及⼯具" class="headerlink" title="11.1 ⽇期和时间数据类型及⼯具"></a>11.1 ⽇期和时间数据类型及⼯具</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime,timedelta</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">now = datetime.now()</span><br><span class="line"><span class="built_in">print</span>(now)</span><br><span class="line"><span class="comment"># 2019-05-12 11:52:03.148521</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(now.year, now.month, now.day)</span><br><span class="line"><span class="comment"># 2019 5 12</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(now.hour, now.<span class="built_in">min</span>, now.second)</span><br><span class="line"><span class="comment"># 11 0001-01-01 00:00:00 31</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">delta = datetime(<span class="number">2011</span>, <span class="number">1</span>, <span class="number">7</span>) - datetime(<span class="number">2008</span>, <span class="number">6</span>, <span class="number">24</span>, <span class="number">8</span>, <span class="number">15</span>)</span><br><span class="line"><span class="built_in">print</span>(delta)</span><br><span class="line"><span class="comment"># 926 days, 15:45:00</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(delta.days)</span><br><span class="line"><span class="comment"># 926</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(delta.seconds)</span><br><span class="line"><span class="comment"># 56700</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">start = datetime(<span class="number">2011</span>, <span class="number">1</span>, <span class="number">7</span>)</span><br><span class="line"><span class="built_in">print</span>(start + timedelta(<span class="number">12</span>))</span><br><span class="line"><span class="comment"># 2011-01-19 00:00:00</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(start - <span class="number">2</span> * timedelta(<span class="number">12</span>))</span><br><span class="line"><span class="comment"># 2010-12-14 00:00:00</span></span><br></pre></td></tr></table></figure>

<p>datetime模块中的数据类型</p>
<p><img src="/images/42023537.png" alt="42023537"></p>
<p>字符串和datetime的相互转换</p>
<p>利⽤str或strftime⽅法（传⼊⼀个格式化字符串），datetime对象和pandas的Timestamp对象可以被格式化为字符串：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime,timedelta</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">stamp = datetime(<span class="number">2011</span>, <span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">str</span>(stamp))</span><br><span class="line"><span class="comment"># 2011-01-03 00:00:00</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># datetime对象转为字符串对象</span></span><br><span class="line"><span class="built_in">print</span>(stamp.strftime(<span class="string">&#x27;%Y-%m-%d&#x27;</span>))</span><br><span class="line"><span class="comment"># 2011-01-03</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 字符串对象转为datetime对象</span></span><br><span class="line">value = <span class="string">&#x27;2011-01-03&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(datetime.strptime(value, <span class="string">&#x27;%Y-%m-%d&#x27;</span>))</span><br><span class="line"><span class="comment"># 2011-01-03 00:00:00</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">datestrs = [<span class="string">&#x27;7/6/2011&#x27;</span>, <span class="string">&#x27;8/6/2011&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>([datetime.strptime(x, <span class="string">&#x27;%m/%d/%Y&#x27;</span>) <span class="keyword">for</span> x <span class="keyword">in</span> datestrs])</span><br><span class="line"><span class="comment"># [datetime.datetime(2011, 7, 6, 0, 0), datetime.datetime(2011, 8, 6, 0, 0)]</span></span><br></pre></td></tr></table></figure>

<p>datetime格式化编码。</p>
<p><img src="/images/32852537.png" alt="32852537"></p>
<p>datetime.strptime通过将字符串对象转为datetime对象,但是每次都要编写格式定义是很麻烦的事情，这时候就可以使用<code>from dateutil.parser import parse</code>.<br><strong>dateutil可以解析几乎所有人类能够理解的日期表示形式</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> dateutil.parser <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(parse(<span class="string">&#x27;2011-01-03&#x27;</span>))</span><br><span class="line"><span class="comment"># 2011-01-03 00:00:00</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(parse(<span class="string">&#x27;Jan 31, 1997 10:45 PM&#x27;</span>))</span><br><span class="line"><span class="comment"># 1997-01-31 22:45:00</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># dayfirst:日出现在⽉的前⾯</span></span><br><span class="line"><span class="built_in">print</span>(parse(<span class="string">&#x27;6/12/2011&#x27;</span>, dayfirst=<span class="literal">True</span>))</span><br><span class="line"><span class="comment"># 2011-12-06 00:00:00</span></span><br></pre></td></tr></table></figure>

<p>pandas使用<code>to_datetime</code>方法解析多种不同的日期表示形式.<br>NaT（Not a Time）是pandas中时间戳数据的null值。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">datestrs = [<span class="string">&#x27;2011-07-06 12:00:00&#x27;</span>, <span class="string">&#x27;2011-08-06 00:00:00&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(pd.to_datetime(datestrs))</span><br><span class="line"><span class="comment"># DatetimeIndex([&#x27;2011-07-06 12:00:00&#x27;, &#x27;2011-08-06 00:00:00&#x27;], dtype=&#x27;datetime64[ns]&#x27;, freq=None)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加一个缺失值</span></span><br><span class="line">idx = pd.to_datetime(datestrs + [<span class="literal">None</span>])</span><br><span class="line"><span class="comment"># 缺失值自动转为NaT(Not a Time)</span></span><br><span class="line"><span class="built_in">print</span>(idx)</span><br><span class="line"><span class="comment"># DatetimeIndex([&#x27;2011-07-06 12:00:00&#x27;, &#x27;2011-08-06 00:00:00&#x27;, &#x27;NaT&#x27;], dtype=&#x27;datetime64[ns]&#x27;, freq=None)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(idx[<span class="number">2</span>])</span><br><span class="line"><span class="comment"># NaT</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># NaT就是null</span></span><br><span class="line"><span class="built_in">print</span>(pd.isnull(idx))</span><br><span class="line"><span class="comment"># [False False  True]</span></span><br></pre></td></tr></table></figure>

<p>特定于当前环境的⽇期格式</p>
<p><img src="/images/169702537.png" alt="169702537"></p>
<hr>
<h2 id="11-2-时间序列基础"><a href="#11-2-时间序列基础" class="headerlink" title="11.2 时间序列基础"></a>11.2 时间序列基础</h2><p>知识预备:<br>==两个series的运算,当匹配之后series数量不匹配时,没有被匹配到的行会变成NaN==.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">x = pd.Series(np.arange(<span class="number">10</span>))</span><br><span class="line"><span class="built_in">print</span>(x)</span><br><span class="line"><span class="comment"># 0    0</span></span><br><span class="line"><span class="comment"># 1    1</span></span><br><span class="line"><span class="comment"># 2    2</span></span><br><span class="line"><span class="comment"># 3    3</span></span><br><span class="line"><span class="comment"># 4    4</span></span><br><span class="line"><span class="comment"># 5    5</span></span><br><span class="line"><span class="comment"># 6    6</span></span><br><span class="line"><span class="comment"># 7    7</span></span><br><span class="line"><span class="comment"># 8    8</span></span><br><span class="line"><span class="comment"># 9    9</span></span><br><span class="line"><span class="comment"># dtype: int32</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">y = pd.Series(np.arange(<span class="number">10</span>))</span><br><span class="line"><span class="built_in">print</span>(y[::<span class="number">2</span>])</span><br><span class="line"><span class="comment"># 0    0</span></span><br><span class="line"><span class="comment"># 2    2</span></span><br><span class="line"><span class="comment"># 4    4</span></span><br><span class="line"><span class="comment"># 6    6</span></span><br><span class="line"><span class="comment"># 8    8</span></span><br><span class="line"><span class="comment"># dtype: int32</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 当匹配之后series数量不匹配时,没有被匹配到的行会变成NaN</span></span><br><span class="line"><span class="built_in">print</span>(x + y[::<span class="number">2</span>])</span><br><span class="line"><span class="comment"># 0     0.0</span></span><br><span class="line"><span class="comment"># 1     NaN</span></span><br><span class="line"><span class="comment"># 2     4.0</span></span><br><span class="line"><span class="comment"># 3     NaN</span></span><br><span class="line"><span class="comment"># 4     8.0</span></span><br><span class="line"><span class="comment"># 5     NaN</span></span><br><span class="line"><span class="comment"># 6    12.0</span></span><br><span class="line"><span class="comment"># 7     NaN</span></span><br><span class="line"><span class="comment"># 8    16.0</span></span><br><span class="line"><span class="comment"># 9     NaN</span></span><br><span class="line"><span class="comment"># dtype: float64</span></span><br></pre></td></tr></table></figure>



<p>pandas最基本的时间序列类型就是以时间戳Datetime为索引的Series.</p>
<ul>
<li>以Datetime为index的类型是<code>DatetimeIndex</code></li>
<li> pandas⽤NumPy的datetime64数据类型以纳秒形式存储==时间戳==</li>
<li>DatetimeIndex中的各个标量值是pandas的<strong>Timestamp</strong>对象<br>简记:<strong>DatetimeIndex的元素是时间戳</strong></li>
<li><strong>TimeStamp</strong>可以随时⾃动转换为<strong>datetime</strong>对象。此外，它还可以存储频率信息（如果有的话），且知道如何执⾏时区转换以及其他操作</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">np.random.seed(<span class="number">888</span>)</span><br><span class="line">dates = [datetime(<span class="number">2011</span>, <span class="number">1</span>, <span class="number">2</span>), datetime(<span class="number">2011</span>, <span class="number">1</span>, <span class="number">5</span>),</span><br><span class="line">         datetime(<span class="number">2011</span>, <span class="number">1</span>, <span class="number">7</span>), datetime(<span class="number">2011</span>, <span class="number">1</span>, <span class="number">8</span>),</span><br><span class="line">         datetime(<span class="number">2011</span>, <span class="number">1</span>, <span class="number">10</span>), datetime(<span class="number">2011</span>, <span class="number">1</span>, <span class="number">12</span>)]</span><br><span class="line">ts = pd.Series(np.random.randn(<span class="number">6</span>), index=dates)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ts)</span><br><span class="line"><span class="comment"># 2011-01-02   -0.176201</span></span><br><span class="line"><span class="comment"># 2011-01-05    0.188876</span></span><br><span class="line"><span class="comment"># 2011-01-07    0.826747</span></span><br><span class="line"><span class="comment"># 2011-01-08   -0.032447</span></span><br><span class="line"><span class="comment"># 2011-01-10   -0.652499</span></span><br><span class="line"><span class="comment"># 2011-01-12   -0.105339</span></span><br><span class="line"><span class="comment"># dtype: float64</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># datetime对象的index是DatetimeIndex</span></span><br><span class="line"><span class="built_in">print</span>(ts.index)</span><br><span class="line"><span class="comment"># DatetimeIndex([&#x27;2011-01-02&#x27;, &#x27;2011-01-05&#x27;, &#x27;2011-01-07&#x27;, &#x27;2011-01-08&#x27;,</span></span><br><span class="line"><span class="comment">#                &#x27;2011-01-10&#x27;, &#x27;2011-01-12&#x27;],</span></span><br><span class="line"><span class="comment">#               dtype=&#x27;datetime64[ns]&#x27;, freq=None)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ts[::<span class="number">2</span>])</span><br><span class="line"><span class="comment"># 2011-01-02   -0.176201</span></span><br><span class="line"><span class="comment"># 2011-01-07    0.826747</span></span><br><span class="line"><span class="comment"># 2011-01-10   -0.652499</span></span><br><span class="line"><span class="comment"># dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 跟其他Series⼀样，不同索引的时间序列之间的算术运算会⾃动按⽇期对⻬：</span></span><br><span class="line"><span class="built_in">print</span>(ts + ts[::<span class="number">2</span>])</span><br><span class="line"><span class="comment"># 2011-01-02   -0.352402</span></span><br><span class="line"><span class="comment"># 2011-01-05         NaN</span></span><br><span class="line"><span class="comment"># 2011-01-07    1.653494</span></span><br><span class="line"><span class="comment"># 2011-01-08         NaN</span></span><br><span class="line"><span class="comment"># 2011-01-10   -1.304999</span></span><br><span class="line"><span class="comment"># 2011-01-12         NaN</span></span><br><span class="line"><span class="comment"># dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># pandas⽤NumPy的datetime64数据类型以纳秒形式存储时间戳：</span></span><br><span class="line"><span class="built_in">print</span>(ts.index.dtype)</span><br><span class="line"><span class="comment"># datetime64[ns]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># DatetimeIndex中的各个标量值是pandas的Timestamp对象</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(ts.index[<span class="number">0</span>]))</span><br><span class="line"><span class="comment"># &lt;class &#x27;pandas._libs.tslibs.timestamps.Timestamp&#x27;&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ts.index[<span class="number">0</span>])</span><br><span class="line"><span class="comment"># 2011-01-02 00:00:00</span></span><br></pre></td></tr></table></figure>



<p>索引、选取、子集构造</p>
<p>DatetimeIndex索引有一种专属索引方法:</p>
<ul>
<li>传⼊⼀个可以被解释为日期的字符串</li>
<li>甚至只传入不部分字符串(如传入“年”或“年⽉”)就可以索引得到</li>
<li>传入Datatime对象</li>
<li>使用<strong>不存在于该时间序列中的时间戳</strong>对其进⾏切⽚（即范围查询）</li>
<li>使用truncate方法</li>
</ul>
<p>注意,以上五种方法产⽣的都是源时间序列的<strong>视图</strong>,这意味着，没有数据被复制，对切⽚进⾏修改会反映到原始数据上。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">np.random.seed(<span class="number">888</span>)</span><br><span class="line">dates = [datetime(<span class="number">2011</span>, <span class="number">1</span>, <span class="number">2</span>), datetime(<span class="number">2011</span>, <span class="number">1</span>, <span class="number">5</span>),</span><br><span class="line">         datetime(<span class="number">2011</span>, <span class="number">1</span>, <span class="number">7</span>), datetime(<span class="number">2011</span>, <span class="number">1</span>, <span class="number">8</span>),</span><br><span class="line">         datetime(<span class="number">2011</span>, <span class="number">1</span>, <span class="number">10</span>), datetime(<span class="number">2011</span>, <span class="number">1</span>, <span class="number">12</span>)]</span><br><span class="line">ts = pd.Series(np.random.randn(<span class="number">6</span>), index=dates)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ts)</span><br><span class="line"><span class="comment"># 2011-01-02   -0.176201</span></span><br><span class="line"><span class="comment"># 2011-01-05    0.188876</span></span><br><span class="line"><span class="comment"># 2011-01-07    0.826747</span></span><br><span class="line"><span class="comment"># 2011-01-08   -0.032447</span></span><br><span class="line"><span class="comment"># 2011-01-10   -0.652499</span></span><br><span class="line"><span class="comment"># 2011-01-12   -0.105339</span></span><br><span class="line"><span class="comment"># dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 普通索引</span></span><br><span class="line">stamp = ts.index[<span class="number">2</span>]</span><br><span class="line"><span class="built_in">print</span>(stamp)</span><br><span class="line"><span class="comment"># 2011-01-07 00:00:00</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ts[stamp])</span><br><span class="line"><span class="comment"># 0.8267471802513613</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># DatetimeIndex专属索引方式</span></span><br><span class="line"><span class="comment"># 传⼊⼀个可以被解释为⽇期的字符串进行索引</span></span><br><span class="line"><span class="built_in">print</span>(ts[<span class="string">&#x27;1/10/2011&#x27;</span>])</span><br><span class="line"><span class="comment"># -0.6524994181480014</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ts[<span class="string">&#x27;20110110&#x27;</span>])</span><br><span class="line"><span class="comment"># -0.6524994181480014</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">longer_ts = pd.Series(np.random.randn(<span class="number">1000</span>),</span><br><span class="line">                      index=pd.date_range(<span class="string">&#x27;1/1/2000&#x27;</span>, periods=<span class="number">1000</span>))</span><br><span class="line"><span class="built_in">print</span>(longer_ts)</span><br><span class="line"><span class="comment"># 2000-01-01    0.217776</span></span><br><span class="line"><span class="comment"># 2000-01-02    0.587282</span></span><br><span class="line"><span class="comment">#                 ...   </span></span><br><span class="line"><span class="comment"># 2002-09-25    0.731959</span></span><br><span class="line"><span class="comment"># 2002-09-26    0.903034</span></span><br><span class="line"><span class="comment"># Freq: D, Length: 1000, dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 只传入部分字符串就可以进行索引</span></span><br><span class="line"><span class="comment"># 只传入年</span></span><br><span class="line"><span class="built_in">print</span>(longer_ts[<span class="string">&#x27;2001&#x27;</span>])</span><br><span class="line"><span class="comment"># 2001-01-01   -0.252939</span></span><br><span class="line"><span class="comment"># 2001-01-02    0.612337</span></span><br><span class="line"><span class="comment">#                 ...   </span></span><br><span class="line"><span class="comment"># 2001-12-30    0.843535</span></span><br><span class="line"><span class="comment"># 2001-12-31    0.364403</span></span><br><span class="line"><span class="comment"># Freq: D, Length: 365, dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 传入年月</span></span><br><span class="line"><span class="built_in">print</span>(longer_ts[<span class="string">&#x27;2001-05&#x27;</span>])</span><br><span class="line"><span class="comment"># 2001-05-01    1.011072</span></span><br><span class="line"><span class="comment"># 2001-05-02   -1.197178</span></span><br><span class="line"><span class="comment">#                 ...   </span></span><br><span class="line"><span class="comment"># 2001-05-30   -0.493460</span></span><br><span class="line"><span class="comment"># 2001-05-31    1.545260</span></span><br><span class="line"><span class="comment"># Freq: D, dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 传入datetime对象进行索引</span></span><br><span class="line"><span class="built_in">print</span>(ts[datetime(<span class="number">2011</span>, <span class="number">1</span>, <span class="number">7</span>):])</span><br><span class="line"><span class="comment"># 2011-01-07    0.826747</span></span><br><span class="line"><span class="comment"># 2011-01-08   -0.032447</span></span><br><span class="line"><span class="comment"># 2011-01-10   -0.652499</span></span><br><span class="line"><span class="comment"># 2011-01-12   -0.105339</span></span><br><span class="line"><span class="comment"># dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ts)</span><br><span class="line"><span class="comment"># 2011-01-02   -0.176201</span></span><br><span class="line"><span class="comment"># 2011-01-05    0.188876</span></span><br><span class="line"><span class="comment"># 2011-01-07    0.826747</span></span><br><span class="line"><span class="comment"># 2011-01-08   -0.032447</span></span><br><span class="line"><span class="comment"># 2011-01-10   -0.652499</span></span><br><span class="line"><span class="comment"># 2011-01-12   -0.105339</span></span><br><span class="line"><span class="comment"># dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 不传入存在于该时间序列中的时间戳对其进⾏切⽚索引</span></span><br><span class="line"><span class="built_in">print</span>(ts[<span class="string">&#x27;1/6/2011&#x27;</span>:<span class="string">&#x27;1/11/2011&#x27;</span>])</span><br><span class="line"><span class="comment"># 2011-01-07    0.826747</span></span><br><span class="line"><span class="comment"># 2011-01-08   -0.032447</span></span><br><span class="line"><span class="comment"># 2011-01-10   -0.652499</span></span><br><span class="line"><span class="comment"># dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用truncate方法</span></span><br><span class="line"><span class="built_in">print</span>(ts.truncate(after=<span class="string">&#x27;1/9/2011&#x27;</span>))</span><br><span class="line"><span class="comment"># 2011-01-02   -0.176201</span></span><br><span class="line"><span class="comment"># 2011-01-05    0.188876</span></span><br><span class="line"><span class="comment"># 2011-01-07    0.826747</span></span><br><span class="line"><span class="comment"># 2011-01-08   -0.032447</span></span><br><span class="line"><span class="comment"># dtype: float64</span></span><br></pre></td></tr></table></figure>



<p>带有重复索引的时间序列</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">dates = pd.DatetimeIndex([<span class="string">&#x27;1/1/2000&#x27;</span>, <span class="string">&#x27;1/2/2000&#x27;</span>, <span class="string">&#x27;1/2/2000&#x27;</span>,</span><br><span class="line">                          <span class="string">&#x27;1/2/2000&#x27;</span>, <span class="string">&#x27;1/3/2000&#x27;</span>])</span><br><span class="line"></span><br><span class="line">dup_ts = pd.Series(np.arange(<span class="number">5</span>), index=dates)</span><br><span class="line"><span class="built_in">print</span>(dup_ts)</span><br><span class="line"><span class="comment"># 2000-01-01    0</span></span><br><span class="line"><span class="comment"># 2000-01-02    1</span></span><br><span class="line"><span class="comment"># 2000-01-02    2</span></span><br><span class="line"><span class="comment"># 2000-01-02    3</span></span><br><span class="line"><span class="comment"># 2000-01-03    4</span></span><br><span class="line"><span class="comment"># dtype: int32</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 索引存在重复</span></span><br><span class="line"><span class="built_in">print</span>(dup_ts.index.is_unique)</span><br><span class="line"><span class="comment"># False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 不存在重复索引</span></span><br><span class="line"><span class="built_in">print</span>(dup_ts[<span class="string">&#x27;1/3/2000&#x27;</span>])</span><br><span class="line"><span class="comment"># 4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 存在重复索引</span></span><br><span class="line"><span class="built_in">print</span>(dup_ts[<span class="string">&#x27;1/2/2000&#x27;</span>])</span><br><span class="line"><span class="comment"># 2000-01-02    1</span></span><br><span class="line"><span class="comment"># 2000-01-02    2</span></span><br><span class="line"><span class="comment"># 2000-01-02    3</span></span><br><span class="line"><span class="comment"># dtype: int32</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 假设想要对具有非唯⼀时间戳的数据进⾏聚合。⼀个办法是使⽤groupby，并传⼊level=0：</span></span><br><span class="line">grouped = dup_ts.groupby(level=<span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(grouped.mean())</span><br><span class="line"><span class="comment"># 2000-01-01    0</span></span><br><span class="line"><span class="comment"># 2000-01-02    2</span></span><br><span class="line"><span class="comment"># 2000-01-03    4</span></span><br><span class="line"><span class="comment"># dtype: int32</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(grouped.count())</span><br><span class="line"><span class="comment"># 2000-01-01    1</span></span><br><span class="line"><span class="comment"># 2000-01-02    3</span></span><br><span class="line"><span class="comment"># 2000-01-03    1</span></span><br><span class="line"><span class="comment"># dtype: int64</span></span><br></pre></td></tr></table></figure>



<h2 id="11-3-日期的范围、频率以及移动"><a href="#11-3-日期的范围、频率以及移动" class="headerlink" title="11.3 日期的范围、频率以及移动"></a>11.3 日期的范围、频率以及移动</h2><p>部分基本的时间序列频率(freq参数)</p>
<table>
<thead>
<tr>
<th>别名</th>
<th>偏移量类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>D</td>
<td>Day</td>
<td>每日历日</td>
</tr>
<tr>
<td>B</td>
<td>BusinessDay</td>
<td>每工作日</td>
</tr>
<tr>
<td>H</td>
<td>Hour</td>
<td>每小时</td>
</tr>
<tr>
<td>T或min</td>
<td>Minute</td>
<td>每分</td>
</tr>
<tr>
<td>S</td>
<td>Second</td>
<td>每秒</td>
</tr>
<tr>
<td>L或ms</td>
<td>Milli</td>
<td>每毫秒</td>
</tr>
<tr>
<td>U</td>
<td>Micro</td>
<td>每微秒</td>
</tr>
<tr>
<td>M</td>
<td>MonthEnd</td>
<td>每月最后一个日历日</td>
</tr>
<tr>
<td>BM</td>
<td>BusinessMonthEnd</td>
<td>每月最后一个工作日</td>
</tr>
<tr>
<td>MS</td>
<td>MonthBegin</td>
<td>每月第一个日历日</td>
</tr>
<tr>
<td>BMS</td>
<td>BusinessMonthBegin</td>
<td>每月第一个工作日</td>
</tr>
<tr>
<td>W-MON<br />W-TUE…</td>
<td>Week</td>
<td>从指定的星球几开始算起,每周</td>
</tr>
<tr>
<td>WOM-1MON<br />WOM-2MON…</td>
<td>WeekOfMonth</td>
<td>每月第一,第二…个星期几<br />(例如:WOM-3FRI表示每月第三个星期五)</td>
</tr>
</tbody></table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># date_range:根据指定的频率⽣成指定⻓度的DatetimeIndex：(注意包含上下限)</span></span><br><span class="line"><span class="comment"># freq=&#x27;D&#x27;是每天的意思。</span></span><br><span class="line">index = pd.date_range(<span class="string">&#x27;2012-04-01&#x27;</span>, <span class="string">&#x27;2012-05-01&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(index)</span><br><span class="line"><span class="comment"># DatetimeIndex([&#x27;2012-04-01&#x27;, &#x27;2012-04-02&#x27;, &#x27;2012-04-03&#x27;, &#x27;2012-04-04&#x27;,</span></span><br><span class="line"><span class="comment">#                &#x27;2012-04-05&#x27;, &#x27;2012-04-06&#x27;, &#x27;2012-04-07&#x27;, &#x27;2012-04-08&#x27;,</span></span><br><span class="line"><span class="comment">#                &#x27;2012-04-09&#x27;, &#x27;2012-04-10&#x27;, &#x27;2012-04-11&#x27;, &#x27;2012-04-12&#x27;,</span></span><br><span class="line"><span class="comment">#                &#x27;2012-04-13&#x27;, &#x27;2012-04-14&#x27;, &#x27;2012-04-15&#x27;, &#x27;2012-04-16&#x27;,</span></span><br><span class="line"><span class="comment">#                &#x27;2012-04-17&#x27;, &#x27;2012-04-18&#x27;, &#x27;2012-04-19&#x27;, &#x27;2012-04-20&#x27;,</span></span><br><span class="line"><span class="comment">#                &#x27;2012-04-21&#x27;, &#x27;2012-04-22&#x27;, &#x27;2012-04-23&#x27;, &#x27;2012-04-24&#x27;,</span></span><br><span class="line"><span class="comment">#                &#x27;2012-04-25&#x27;, &#x27;2012-04-26&#x27;, &#x27;2012-04-27&#x27;, &#x27;2012-04-28&#x27;,</span></span><br><span class="line"><span class="comment">#                &#x27;2012-04-29&#x27;, &#x27;2012-04-30&#x27;, &#x27;2012-05-01&#x27;],</span></span><br><span class="line"><span class="comment">#               dtype=&#x27;datetime64[ns]&#x27;, freq=&#x27;D&#x27;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用periods,按天计算的时间点</span></span><br><span class="line"><span class="built_in">print</span>(pd.date_range(start=<span class="string">&#x27;2012-04-01&#x27;</span>, periods=<span class="number">3</span>))</span><br><span class="line"><span class="comment"># DatetimeIndex([&#x27;2012-04-01&#x27;, &#x27;2012-04-02&#x27;, &#x27;2012-04-03&#x27;], dtype=&#x27;datetime64[ns]&#x27;, freq=&#x27;D&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(pd.date_range(end=<span class="string">&#x27;2012-06-01&#x27;</span>, periods=<span class="number">3</span>))</span><br><span class="line"><span class="comment"># DatetimeIndex([&#x27;2012-05-30&#x27;, &#x27;2012-05-31&#x27;, &#x27;2012-06-01&#x27;], dtype=&#x27;datetime64[ns]&#x27;, freq=&#x27;D&#x27;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过传入频率freq作为时间间隔</span></span><br><span class="line"><span class="built_in">print</span>(pd.date_range(<span class="string">&#x27;2000-01-01&#x27;</span>, <span class="string">&#x27;2000-12-01&#x27;</span>, freq=<span class="string">&#x27;BM&#x27;</span>))</span><br><span class="line"><span class="comment"># DatetimeIndex([&#x27;2000-01-31&#x27;, &#x27;2000-02-29&#x27;, &#x27;2000-03-31&#x27;, &#x27;2000-04-28&#x27;,</span></span><br><span class="line"><span class="comment">#                &#x27;2000-05-31&#x27;, &#x27;2000-06-30&#x27;, &#x27;2000-07-31&#x27;, &#x27;2000-08-31&#x27;,</span></span><br><span class="line"><span class="comment">#                &#x27;2000-09-29&#x27;, &#x27;2000-10-31&#x27;, &#x27;2000-11-30&#x27;],</span></span><br><span class="line"><span class="comment">#               dtype=&#x27;datetime64[ns]&#x27;, freq=&#x27;BM&#x27;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># date_range默认会保留时间信息(12:56:31)</span></span><br><span class="line"><span class="built_in">print</span>(pd.date_range(<span class="string">&#x27;2012-05-02 12:56:31&#x27;</span>, periods=<span class="number">5</span>))</span><br><span class="line"><span class="comment"># DatetimeIndex([&#x27;2012-05-02 12:56:31&#x27;, &#x27;2012-05-03 12:56:31&#x27;,</span></span><br><span class="line"><span class="comment">#                &#x27;2012-05-04 12:56:31&#x27;, &#x27;2012-05-05 12:56:31&#x27;,</span></span><br><span class="line"><span class="comment">#                &#x27;2012-05-06 12:56:31&#x27;],</span></span><br><span class="line"><span class="comment">#               dtype=&#x27;datetime64[ns]&#x27;, freq=&#x27;D&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># normalize:去除时间信息,规范化（normalize）到午夜的时间戳。</span></span><br><span class="line"><span class="built_in">print</span>(pd.date_range(<span class="string">&#x27;2012-05-02 12:56:31&#x27;</span>, periods=<span class="number">5</span>, normalize=<span class="literal">True</span>))</span><br><span class="line"><span class="comment"># DatetimeIndex([&#x27;2012-05-02&#x27;, &#x27;2012-05-03&#x27;, &#x27;2012-05-04&#x27;, &#x27;2012-05-05&#x27;,</span></span><br><span class="line"><span class="comment">#                &#x27;2012-05-06&#x27;],</span></span><br><span class="line"><span class="comment">#               dtype=&#x27;datetime64[ns]&#x27;, freq=&#x27;D&#x27;)</span></span><br></pre></td></tr></table></figure>



<p>频率和⽇期偏移量</p>
<p>pandas中的频率是由⼀个基础频率（base frequency）和⼀个乘数组成的。<br>简单来说.</p>
<blockquote>
<p>频率  = 基础频率 * 日期偏移量</p>
</blockquote>
<p>而且偏移量可以进行加减乘除运算连接,<br>偏移量可以随意组合,这称为<code>频率字符串</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> pandas.tseries.offsets <span class="keyword">import</span> Hour, Minute</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">hour = Hour()</span><br><span class="line"><span class="built_in">print</span>(hour)</span><br><span class="line"><span class="comment"># &lt;Hour&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># offsets.Hour对象</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(hour))</span><br><span class="line"><span class="comment"># &lt;class &#x27;pandas.tseries.offsets.Hour&#x27;&gt;</span></span><br><span class="line"></span><br><span class="line">four_hours = Hour(<span class="number">4</span>)</span><br><span class="line"><span class="built_in">print</span>(four_hours)</span><br><span class="line"><span class="comment"># &lt;4 * Hours&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 偏移量对象可以通过运算连接</span></span><br><span class="line"><span class="built_in">print</span>(Hour(<span class="number">2</span>) + Minute(<span class="number">30</span>))</span><br><span class="line"><span class="comment"># &lt;150 * Minutes&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ⽆需明确创建对象，只需使⽤诸如&quot;H&quot;或&quot;4H&quot;这样的字符串别名即可。</span></span><br><span class="line"><span class="built_in">print</span>(pd.date_range(<span class="string">&#x27;2000-01-01&#x27;</span>, <span class="string">&#x27;2000-01-01 23:59&#x27;</span>, freq=<span class="string">&#x27;4h&#x27;</span>))</span><br><span class="line"><span class="comment"># DatetimeIndex([&#x27;2000-01-01 00:00:00&#x27;, &#x27;2000-01-01 04:00:00&#x27;,</span></span><br><span class="line"><span class="comment">#                &#x27;2000-01-01 08:00:00&#x27;, &#x27;2000-01-01 12:00:00&#x27;,</span></span><br><span class="line"><span class="comment">#                &#x27;2000-01-01 16:00:00&#x27;, &#x27;2000-01-01 20:00:00&#x27;],</span></span><br><span class="line"><span class="comment">#               dtype=&#x27;datetime64[ns]&#x27;, freq=&#x27;4H&#x27;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 偏移量可以随意组合,这称为&#x27;频率字符串&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(pd.date_range(<span class="string">&#x27;2000-01-01&#x27;</span>, periods=<span class="number">3</span>, freq=<span class="string">&#x27;1h30min&#x27;</span>))</span><br><span class="line"><span class="comment"># DatetimeIndex([&#x27;2000-01-01 00:00:00&#x27;, &#x27;2000-01-01 01:30:00&#x27;,</span></span><br><span class="line"><span class="comment">#                &#x27;2000-01-01 03:00:00&#x27;],</span></span><br><span class="line"><span class="comment">#               dtype=&#x27;datetime64[ns]&#x27;, freq=&#x27;90T&#x27;)</span></span><br></pre></td></tr></table></figure>



<p>WOM日期</p>
<p><code>WOM</code>（Week Of Month）是⼀种⾮常实⽤的频率类，它以WOM开头。它使你能获得诸如“每⽉第3个星期五”之类的⽇期：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 每月第三个星期五</span></span><br><span class="line">rng = pd.date_range(<span class="string">&#x27;2012-01-01&#x27;</span>, <span class="string">&#x27;2012-06-01&#x27;</span>, freq=<span class="string">&#x27;WOM-3FRI&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">list</span>(rng))</span><br><span class="line"><span class="comment"># [Timestamp(&#x27;2012-01-20 00:00:00&#x27;, freq=&#x27;WOM-3FRI&#x27;), </span></span><br><span class="line"><span class="comment">#  Timestamp(&#x27;2012-02-17 00:00:00&#x27;, freq=&#x27;WOM-3FRI&#x27;), </span></span><br><span class="line"><span class="comment">#  Timestamp(&#x27;2012-03-16 00:00:00&#x27;, freq=&#x27;WOM-3FRI&#x27;), </span></span><br><span class="line"><span class="comment">#  Timestamp(&#x27;2012-04-20 00:00:00&#x27;, freq=&#x27;WOM-3FRI&#x27;), </span></span><br><span class="line"><span class="comment">#  Timestamp(&#x27;2012-05-18 00:00:00&#x27;, freq=&#x27;WOM-3FRI&#x27;)]</span></span><br></pre></td></tr></table></figure>



<p>移动（超前和滞后）数据</p>
<ul>
<li>移动（shifting）指的是沿着时间轴<strong>将数据前移或后移</strong>。</li>
<li>使用Series或者DataFrame的shift方法实现移动:<br>⽤于执行单纯的前移或后移操作，保持索引不变</li>
<li>使用shift方法的freq参数,实现对<strong>Index的位移</strong></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">np.random.seed(<span class="number">888</span>)</span><br><span class="line">ts = pd.Series(np.random.randn(<span class="number">4</span>),</span><br><span class="line">               index=pd.date_range(<span class="string">&#x27;1/1/2000&#x27;</span>, periods=<span class="number">4</span>, freq=<span class="string">&#x27;Y&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ts)</span><br><span class="line"><span class="comment"># 2000-12-31   -0.176201</span></span><br><span class="line"><span class="comment"># 2001-12-31    0.188876</span></span><br><span class="line"><span class="comment"># 2002-12-31    0.826747</span></span><br><span class="line"><span class="comment"># 2003-12-31   -0.032447</span></span><br><span class="line"><span class="comment"># Freq: A-DEC, dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将数据移动两个索引</span></span><br><span class="line"><span class="built_in">print</span>(ts.shift(<span class="number">2</span>))</span><br><span class="line"><span class="comment"># 2000-12-31         NaN</span></span><br><span class="line"><span class="comment"># 2001-12-31         NaN</span></span><br><span class="line"><span class="comment"># 2002-12-31   -0.176201</span></span><br><span class="line"><span class="comment"># 2003-12-31    0.188876</span></span><br><span class="line"><span class="comment"># Freq: A-DEC, dtype: float64</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ts.shift(-<span class="number">2</span>))</span><br><span class="line"><span class="comment"># 2000-12-31    0.826747</span></span><br><span class="line"><span class="comment"># 2001-12-31   -0.032447</span></span><br><span class="line"><span class="comment"># 2002-12-31         NaN</span></span><br><span class="line"><span class="comment"># 2003-12-31         NaN</span></span><br><span class="line"><span class="comment"># Freq: A-DEC, dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ts)</span><br><span class="line"><span class="comment"># 2000-12-31   -0.176201</span></span><br><span class="line"><span class="comment"># 2001-12-31    0.188876</span></span><br><span class="line"><span class="comment"># 2002-12-31    0.826747</span></span><br><span class="line"><span class="comment"># 2003-12-31   -0.032447</span></span><br><span class="line"><span class="comment"># Freq: A-DEC, dtype: float64</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ts.shift(<span class="number">1</span>))</span><br><span class="line"><span class="comment"># 2000-12-31         NaN</span></span><br><span class="line"><span class="comment"># 2001-12-31   -0.176201</span></span><br><span class="line"><span class="comment"># 2002-12-31    0.188876</span></span><br><span class="line"><span class="comment"># 2003-12-31    0.826747</span></span><br><span class="line"><span class="comment"># Freq: A-DEC, dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算时间序列的百分⽐变化</span></span><br><span class="line"><span class="comment"># -2.071938 = (0.188876 / -0.176201) - 1</span></span><br><span class="line"><span class="comment"># 3.377187  = (0.826747 / 0.188876)  - 1</span></span><br><span class="line"><span class="built_in">print</span>(ts / ts.shift(<span class="number">1</span>) - <span class="number">1</span>)</span><br><span class="line"><span class="comment"># 2000-12-31         NaN</span></span><br><span class="line"><span class="comment"># 2001-12-31   -2.071938</span></span><br><span class="line"><span class="comment"># 2002-12-31    3.377187</span></span><br><span class="line"><span class="comment"># 2003-12-31   -1.039247</span></span><br><span class="line"><span class="comment"># Freq: A-DEC, dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ts)</span><br><span class="line"><span class="comment"># 2000-12-31   -0.176201</span></span><br><span class="line"><span class="comment"># 2001-12-31    0.188876</span></span><br><span class="line"><span class="comment"># 2002-12-31    0.826747</span></span><br><span class="line"><span class="comment"># 2003-12-31   -0.032447</span></span><br><span class="line"><span class="comment"># Freq: A-DEC, dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 传入freq,实现对时间戳位移(index的位移)</span></span><br><span class="line"><span class="built_in">print</span>(ts.shift(<span class="number">2</span>, freq=<span class="string">&#x27;M&#x27;</span>))</span><br><span class="line"><span class="comment"># 2001-02-28   -0.176201</span></span><br><span class="line"><span class="comment"># 2002-02-28    0.188876</span></span><br><span class="line"><span class="comment"># 2003-02-28    0.826747</span></span><br><span class="line"><span class="comment"># 2004-02-29   -0.032447</span></span><br><span class="line"><span class="comment"># Freq: A-FEB, dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ts.shift(<span class="number">3</span>, freq=<span class="string">&#x27;D&#x27;</span>))</span><br><span class="line"><span class="comment"># 2001-01-03   -0.176201</span></span><br><span class="line"><span class="comment"># 2002-01-03    0.188876</span></span><br><span class="line"><span class="comment"># 2003-01-03    0.826747</span></span><br><span class="line"><span class="comment"># 2004-01-03   -0.032447</span></span><br><span class="line"><span class="comment"># Freq: 365D, dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ts.shift(<span class="number">1</span>, freq=<span class="string">&#x27;90T&#x27;</span>))</span><br><span class="line"><span class="comment"># 2000-12-31 01:30:00   -0.176201</span></span><br><span class="line"><span class="comment"># 2001-12-31 01:30:00    0.188876</span></span><br><span class="line"><span class="comment"># 2002-12-31 01:30:00    0.826747</span></span><br><span class="line"><span class="comment"># 2003-12-31 01:30:00   -0.032447</span></span><br><span class="line"><span class="comment"># Freq: A-DEC, dtype: float64</span></span><br></pre></td></tr></table></figure>



<p>通过偏移量对日期进行位移</p>
<ul>
<li>pandas的日期偏移量还可以⽤在datetime或Timestamp对象上</li>
<li>还可以添加<code>锚点偏移量</code>（⽐如MonthEnd）:<br>第⼀次增量会将原⽇期向前滚动到符合频率规则的下⼀个⽇期</li>
<li>如果想要将日期向后滚动<code>锚点偏移量</code>:<br>可以使用锚点偏移量的rollforward和rollback⽅法，可明确地将⽇期向前或向后“滚动”</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> pandas.tseries.offsets <span class="keyword">import</span> Day, MonthEnd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># pandas的日期偏移量用在datetime或Timestamp对象</span></span><br><span class="line">now = datetime(<span class="number">2011</span>, <span class="number">11</span>, <span class="number">17</span>)</span><br><span class="line"><span class="built_in">print</span>(now + <span class="number">3</span> * Day())</span><br><span class="line"><span class="comment"># 2011-11-20 00:00:00</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 锚点偏移量</span></span><br><span class="line"><span class="built_in">print</span>(MonthEnd())</span><br><span class="line"><span class="comment"># &lt;MonthEnd&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(MonthEnd(<span class="number">2</span>))</span><br><span class="line"><span class="comment"># &lt;2 * MonthEnds&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 向前滚动到符合规则的下一个日期(跳到这个月月底)</span></span><br><span class="line"><span class="built_in">print</span>(now + MonthEnd())</span><br><span class="line"><span class="comment"># 2011-11-30 00:00:00</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 跳到下两个月月底</span></span><br><span class="line"><span class="built_in">print</span>(now + MonthEnd(<span class="number">2</span>))</span><br><span class="line"><span class="comment"># 2011-12-31 00:00:00</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用锚点偏移量的rollforward和rollback⽅法,</span></span><br><span class="line"><span class="comment"># 明确是向前还是向后滚动</span></span><br><span class="line">offset = MonthEnd()</span><br><span class="line"><span class="built_in">print</span>(offset.rollforward(now))</span><br><span class="line"><span class="comment"># 2011-11-30 00:00:00</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(offset.rollback(now))</span><br><span class="line"><span class="comment"># 2011-10-31 00:00:00</span></span><br></pre></td></tr></table></figure>

<p>日期偏移量结合groupby使用:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> pandas.tseries.offsets <span class="keyword">import</span> MonthEnd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">np.random.seed(<span class="number">888</span>)</span><br><span class="line">ts = pd.Series(np.random.randn(<span class="number">10</span>),</span><br><span class="line">               index=pd.date_range(<span class="string">&#x27;1/15/2000&#x27;</span>, periods=<span class="number">10</span>, freq=<span class="string">&#x27;4d&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ts)</span><br><span class="line"><span class="comment"># 2000-01-15   -0.176201</span></span><br><span class="line"><span class="comment"># 2000-01-19    0.188876</span></span><br><span class="line"><span class="comment"># 2000-01-23    0.826747</span></span><br><span class="line"><span class="comment"># 2000-01-27   -0.032447</span></span><br><span class="line"><span class="comment"># 2000-01-31   -0.652499</span></span><br><span class="line"><span class="comment"># 2000-02-04   -0.105339</span></span><br><span class="line"><span class="comment"># 2000-02-08    0.217776</span></span><br><span class="line"><span class="comment"># 2000-02-12    0.587282</span></span><br><span class="line"><span class="comment"># 2000-02-16    0.100238</span></span><br><span class="line"><span class="comment"># 2000-02-20   -1.099947</span></span><br><span class="line"><span class="comment"># Freq: 4D, dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将offset.rollforward传给groupby函数</span></span><br><span class="line">offset = MonthEnd()</span><br><span class="line"><span class="built_in">print</span>(ts.groupby(offset.rollforward).mean())</span><br><span class="line"><span class="comment"># 2000-01-31    0.030895</span></span><br><span class="line"><span class="comment"># 2000-02-29   -0.059998</span></span><br><span class="line"><span class="comment"># dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 当然,使用resample更加方便快速</span></span><br><span class="line"><span class="built_in">print</span>(ts.resample(<span class="string">&#x27;M&#x27;</span>).mean())</span><br><span class="line"><span class="comment"># 2000-01-31    0.030895</span></span><br><span class="line"><span class="comment"># 2000-02-29   -0.059998</span></span><br><span class="line"><span class="comment"># Freq: M, dtype: float64</span></span><br></pre></td></tr></table></figure>



<hr>
<h2 id="11-4-时区处理"><a href="#11-4-时区处理" class="headerlink" title="11.4 时区处理"></a>11.4 时区处理</h2><p>时区是以UTC偏移量的形式表示的.</p>
<p>在Python中，时区信息来⾃第三⽅库pytz，它使Python可以使⽤Olson数据库</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pytz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取时区名称列表</span></span><br><span class="line"><span class="built_in">print</span>(pytz.common_timezones[-<span class="number">5</span>:])</span><br><span class="line"><span class="comment"># [&#x27;US/Eastern&#x27;, &#x27;US/Hawaii&#x27;, &#x27;US/Mountain&#x27;, &#x27;US/Pacific&#x27;, &#x27;UTC&#x27;]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取时区对象</span></span><br><span class="line">tz = pytz.timezone(<span class="string">&#x27;America/New_York&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(tz))</span><br><span class="line"><span class="comment"># &lt;class &#x27;pytz.tzfile.America/New_York&#x27;&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(tz)</span><br><span class="line"><span class="comment"># America/New_York</span></span><br></pre></td></tr></table></figure>



<p>时区本地化和转换</p>
<p>默认情况下，pandas中的时间序列是单纯的（naive）时区。</p>
<ul>
<li><strong>默认情况下,pandas中的时间序列的tz属性为None</strong></li>
<li>使用<code>tz_localize</code>方法转为本地化时区</li>
<li>使用<code>tz_convert</code>方法将本地化时区转换到别的时区</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">np.random.seed(<span class="number">888</span>)</span><br><span class="line">rng = pd.date_range(<span class="string">&#x27;3/9/2012 9:30&#x27;</span>, periods=<span class="number">6</span>, freq=<span class="string">&#x27;D&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(rng))</span><br><span class="line"><span class="comment"># 6</span></span><br><span class="line"></span><br><span class="line">ts = pd.Series(np.random.randn(<span class="built_in">len</span>(rng)), index=rng)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ts)</span><br><span class="line"><span class="comment"># 2012-03-09 09:30:00   -0.176201</span></span><br><span class="line"><span class="comment"># 2012-03-10 09:30:00    0.188876</span></span><br><span class="line"><span class="comment"># 2012-03-11 09:30:00    0.826747</span></span><br><span class="line"><span class="comment"># 2012-03-12 09:30:00   -0.032447</span></span><br><span class="line"><span class="comment"># 2012-03-13 09:30:00   -0.652499</span></span><br><span class="line"><span class="comment"># 2012-03-14 09:30:00   -0.105339</span></span><br><span class="line"><span class="comment"># Freq: D, dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ts.index)</span><br><span class="line"><span class="comment"># DatetimeIndex([&#x27;2012-03-09 09:30:00&#x27;, &#x27;2012-03-10 09:30:00&#x27;,</span></span><br><span class="line"><span class="comment">#                &#x27;2012-03-11 09:30:00&#x27;, &#x27;2012-03-12 09:30:00&#x27;,</span></span><br><span class="line"><span class="comment">#                &#x27;2012-03-13 09:30:00&#x27;, &#x27;2012-03-14 09:30:00&#x27;],</span></span><br><span class="line"><span class="comment">#               dtype=&#x27;datetime64[ns]&#x27;, freq=&#x27;D&#x27;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 索引的tz字段为None</span></span><br><span class="line"><span class="comment"># 默认情况下,pandas中的时间序列的tz属性为None</span></span><br><span class="line"><span class="built_in">print</span>(ts.index.tz)</span><br><span class="line"><span class="comment"># None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># tz_localize⽅法:将单纯转化为本地化</span></span><br><span class="line">ts_utc = ts.tz_localize(<span class="string">&#x27;UTC&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(ts_utc)</span><br><span class="line"><span class="comment"># 2012-03-09 09:30:00+00:00   -0.176201</span></span><br><span class="line"><span class="comment"># 2012-03-10 09:30:00+00:00    0.188876</span></span><br><span class="line"><span class="comment"># 2012-03-11 09:30:00+00:00    0.826747</span></span><br><span class="line"><span class="comment"># 2012-03-12 09:30:00+00:00   -0.032447</span></span><br><span class="line"><span class="comment"># 2012-03-13 09:30:00+00:00   -0.652499</span></span><br><span class="line"><span class="comment"># 2012-03-14 09:30:00+00:00   -0.105339</span></span><br><span class="line"><span class="comment"># Freq: D, dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># index具有tz属性了</span></span><br><span class="line"><span class="built_in">print</span>(ts_utc.index)</span><br><span class="line"><span class="comment"># DatetimeIndex([&#x27;2012-03-09 09:30:00+00:00&#x27;, &#x27;2012-03-10 09:30:00+00:00&#x27;,</span></span><br><span class="line"><span class="comment">#                &#x27;2012-03-11 09:30:00+00:00&#x27;, &#x27;2012-03-12 09:30:00+00:00&#x27;,</span></span><br><span class="line"><span class="comment">#                &#x27;2012-03-13 09:30:00+00:00&#x27;, &#x27;2012-03-14 09:30:00+00:00&#x27;],</span></span><br><span class="line"><span class="comment">#               dtype=&#x27;datetime64[ns, UTC]&#x27;, freq=&#x27;D&#x27;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ts_utc.index.tz)</span><br><span class="line"><span class="comment"># UTC</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用tz_convert将本地化时区转换到别的时区</span></span><br><span class="line"><span class="built_in">print</span>(ts_utc.tz_convert(<span class="string">&#x27;America/New_York&#x27;</span>))</span><br><span class="line"><span class="comment"># 2012-03-09 04:30:00-05:00   -0.176201</span></span><br><span class="line"><span class="comment"># 2012-03-10 04:30:00-05:00    0.188876</span></span><br><span class="line"><span class="comment"># 2012-03-11 05:30:00-04:00    0.826747</span></span><br><span class="line"><span class="comment"># 2012-03-12 05:30:00-04:00   -0.032447</span></span><br><span class="line"><span class="comment"># 2012-03-13 05:30:00-04:00   -0.652499</span></span><br><span class="line"><span class="comment"># 2012-03-14 05:30:00-04:00   -0.105339</span></span><br><span class="line"><span class="comment"># Freq: D, dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 本地化到America/New_York,然后转为UTC</span></span><br><span class="line">ts_eastern = ts.tz_localize(<span class="string">&#x27;America/New_York&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(ts_eastern.tz_convert(<span class="string">&#x27;UTC&#x27;</span>))</span><br><span class="line"><span class="comment"># 2012-03-09 14:30:00+00:00   -0.176201</span></span><br><span class="line"><span class="comment"># 2012-03-10 14:30:00+00:00    0.188876</span></span><br><span class="line"><span class="comment"># 2012-03-11 13:30:00+00:00    0.826747</span></span><br><span class="line"><span class="comment"># 2012-03-12 13:30:00+00:00   -0.032447</span></span><br><span class="line"><span class="comment"># 2012-03-13 13:30:00+00:00   -0.652499</span></span><br><span class="line"><span class="comment"># 2012-03-14 13:30:00+00:00   -0.105339</span></span><br><span class="line"><span class="comment"># Freq: D, dtype: float64</span></span><br></pre></td></tr></table></figure>

<p>值得注意的是:<br>tz_localize和tz_convert是DataFrame和Serise的方法.也还是DatetimeIndex的实例⽅法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(ts.index.tz_localize(<span class="string">&#x27;Asia/Shanghai&#x27;</span>))</span><br><span class="line"><span class="comment"># DatetimeIndex([&#x27;2012-03-09 09:30:00+08:00&#x27;, &#x27;2012-03-10 09:30:00+08:00&#x27;,</span></span><br><span class="line"><span class="comment">#                &#x27;2012-03-11 09:30:00+08:00&#x27;, &#x27;2012-03-12 09:30:00+08:00&#x27;,</span></span><br><span class="line"><span class="comment">#                &#x27;2012-03-13 09:30:00+08:00&#x27;, &#x27;2012-03-14 09:30:00+08:00&#x27;],</span></span><br><span class="line"><span class="comment">#               dtype=&#x27;datetime64[ns, Asia/Shanghai]&#x27;, freq=&#x27;D&#x27;)</span></span><br></pre></td></tr></table></figure>



<p>操作时区意识型Timestamp对象</p>
<p>跟时间序列和⽇期范围差不多，独立的Timestamp对象也能被从单纯型（naive）本地化为时区意识型（time zone-aware），并从⼀个时区转换到另⼀个时区：</p>
<ul>
<li>Timestamp对象也能使用<code>tz_localize</code>方法和<code>tz_convert</code>方法</li>
<li>默认情况下,pandas中的时间序列的tz属性为None,但是Timestamp对象支持传入tz属性,在初始化的时候就有tx属性了</li>
<li>使用Timestamp.value获取Timestamp对象的时间戳属性</li>
<li>Timestamp对象能和DateOffset对象运算</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">stamp = pd.Timestamp(<span class="string">&#x27;2011-03-12 04:00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Timestamp对象一样能使用tz_localize,tz_convert函数</span></span><br><span class="line">stamp_utc = stamp.tz_localize(<span class="string">&#x27;utc&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(stamp_utc.tz_convert(<span class="string">&#x27;America/New_York&#x27;</span>))</span><br><span class="line"><span class="comment"># 2011-03-11 23:00:00-05:00</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Timestamp在初始化的时候就可以传⼊⼀个时区信息</span></span><br><span class="line">stamp_moscow = pd.Timestamp(<span class="string">&#x27;2011-03-12 04:00&#x27;</span>, tz=<span class="string">&#x27;Europe/Moscow&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(stamp_moscow)</span><br><span class="line"><span class="comment"># 2011-03-12 04:00:00+03:00</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 拥有tz属性(拥有时区信息)</span></span><br><span class="line"><span class="built_in">print</span>(stamp_moscow.tz)</span><br><span class="line"><span class="comment"># Europe/Moscow</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Timestamp对象在内部保存了⼀个UTC时间戳值</span></span><br><span class="line"><span class="comment"># （自UNIX纪元（1970年1⽉1⽇）算起的纳秒数）</span></span><br><span class="line"><span class="built_in">print</span>(stamp_utc.value)</span><br><span class="line"><span class="comment"># 1299902400000000000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 时间戳是不会因为转换时区而改变的</span></span><br><span class="line"><span class="built_in">print</span>(stamp_utc.tz_convert(<span class="string">&#x27;America/New_York&#x27;</span>).value)</span><br><span class="line"><span class="comment"># 1299902400000000000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pandas.tseries.offsets <span class="keyword">import</span> Hour</span><br><span class="line"></span><br><span class="line"><span class="comment"># Hour()属于DateOffset对象</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(Hour()))</span><br><span class="line"><span class="comment"># &lt;class &#x27;pandas.tseries.offsets.Hour&#x27;&gt;</span></span><br><span class="line"></span><br><span class="line">stamp = pd.Timestamp(<span class="string">&#x27;2012-03-12 01:30&#x27;</span>, tz=<span class="string">&#x27;US/Eastern&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(stamp)</span><br><span class="line"><span class="comment"># 2012-03-12 01:30:00-04:00</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Timestamp对象能和DateOffset对象运算</span></span><br><span class="line"><span class="built_in">print</span>(stamp + Hour())</span><br><span class="line"><span class="comment"># 2012-03-12 02:30:00-04:00</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">stamp = pd.Timestamp(<span class="string">&#x27;2012-11-04 00:30&#x27;</span>, tz=<span class="string">&#x27;US/Eastern&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(stamp)</span><br><span class="line"><span class="comment"># 2012-11-04 00:30:00-04:00</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(stamp + <span class="number">2</span> * Hour())</span><br><span class="line"><span class="comment"># 2012-11-04 01:30:00-05:00</span></span><br></pre></td></tr></table></figure>



<p>不同时区之间的运算</p>
<p>两个不同时区Datetime对象相加减的最终结果就会是UTC。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rng = pd.date_range(<span class="string">&#x27;3/7/2012 9:30&#x27;</span>, periods=<span class="number">10</span>, freq=<span class="string">&#x27;B&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(rng)</span><br><span class="line"><span class="comment"># DatetimeIndex([&#x27;2012-03-07 09:30:00&#x27;, &#x27;2012-03-08 09:30:00&#x27;,</span></span><br><span class="line"><span class="comment">#                &#x27;2012-03-09 09:30:00&#x27;, &#x27;2012-03-12 09:30:00&#x27;,</span></span><br><span class="line"><span class="comment">#                &#x27;2012-03-13 09:30:00&#x27;, &#x27;2012-03-14 09:30:00&#x27;,</span></span><br><span class="line"><span class="comment">#                &#x27;2012-03-15 09:30:00&#x27;, &#x27;2012-03-16 09:30:00&#x27;,</span></span><br><span class="line"><span class="comment">#                &#x27;2012-03-19 09:30:00&#x27;, &#x27;2012-03-20 09:30:00&#x27;],</span></span><br><span class="line"><span class="comment">#               dtype=&#x27;datetime64[ns]&#x27;, freq=&#x27;B&#x27;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">np.random.seed(<span class="number">888</span>)</span><br><span class="line">ts = pd.Series(np.random.randn(<span class="built_in">len</span>(rng)), index=rng)</span><br><span class="line"><span class="built_in">print</span>(ts)</span><br><span class="line"><span class="comment"># 2012-03-07 09:30:00   -0.176201</span></span><br><span class="line"><span class="comment"># 2012-03-08 09:30:00    0.188876</span></span><br><span class="line"><span class="comment"># 2012-03-09 09:30:00    0.826747</span></span><br><span class="line"><span class="comment"># 2012-03-12 09:30:00   -0.032447</span></span><br><span class="line"><span class="comment"># 2012-03-13 09:30:00   -0.652499</span></span><br><span class="line"><span class="comment"># 2012-03-14 09:30:00   -0.105339</span></span><br><span class="line"><span class="comment"># 2012-03-15 09:30:00    0.217776</span></span><br><span class="line"><span class="comment"># 2012-03-16 09:30:00    0.587282</span></span><br><span class="line"><span class="comment"># 2012-03-19 09:30:00    0.100238</span></span><br><span class="line"><span class="comment"># 2012-03-20 09:30:00   -1.099947</span></span><br><span class="line"><span class="comment"># Freq: B, dtype: float64</span></span><br><span class="line"></span><br><span class="line">ts1 = ts[:<span class="number">7</span>].tz_localize(<span class="string">&#x27;Europe/London&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ts1)</span><br><span class="line"><span class="comment"># 2012-03-07 09:30:00+00:00   -0.176201</span></span><br><span class="line"><span class="comment"># 2012-03-08 09:30:00+00:00    0.188876</span></span><br><span class="line"><span class="comment"># 2012-03-09 09:30:00+00:00    0.826747</span></span><br><span class="line"><span class="comment"># 2012-03-12 09:30:00+00:00   -0.032447</span></span><br><span class="line"><span class="comment"># 2012-03-13 09:30:00+00:00   -0.652499</span></span><br><span class="line"><span class="comment"># 2012-03-14 09:30:00+00:00   -0.105339</span></span><br><span class="line"><span class="comment"># 2012-03-15 09:30:00+00:00    0.217776</span></span><br><span class="line"><span class="comment"># Freq: B, dtype: float64</span></span><br><span class="line"></span><br><span class="line">ts2 = ts1[<span class="number">2</span>:].tz_convert(<span class="string">&#x27;Europe/Moscow&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ts2)</span><br><span class="line"><span class="comment"># 2012-03-09 13:30:00+04:00    0.826747</span></span><br><span class="line"><span class="comment"># 2012-03-12 13:30:00+04:00   -0.032447</span></span><br><span class="line"><span class="comment"># 2012-03-13 13:30:00+04:00   -0.652499</span></span><br><span class="line"><span class="comment"># 2012-03-14 13:30:00+04:00   -0.105339</span></span><br><span class="line"><span class="comment"># 2012-03-15 13:30:00+04:00    0.217776</span></span><br><span class="line"><span class="comment"># Freq: B, dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 不同时区的DateTime对象相加减</span></span><br><span class="line">result = ts1 + ts2</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"><span class="comment"># 2012-03-07 09:30:00+00:00         NaN</span></span><br><span class="line"><span class="comment"># 2012-03-08 09:30:00+00:00         NaN</span></span><br><span class="line"><span class="comment"># 2012-03-09 09:30:00+00:00    1.653494</span></span><br><span class="line"><span class="comment"># 2012-03-12 09:30:00+00:00   -0.064895</span></span><br><span class="line"><span class="comment"># 2012-03-13 09:30:00+00:00   -1.304999</span></span><br><span class="line"><span class="comment"># 2012-03-14 09:30:00+00:00   -0.210679</span></span><br><span class="line"><span class="comment"># 2012-03-15 09:30:00+00:00    0.435552</span></span><br><span class="line"><span class="comment"># Freq: B, dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 两个不同时区Datetime对象相加减的最终结果就会是UTC。</span></span><br><span class="line"><span class="built_in">print</span>(result.index)</span><br><span class="line"><span class="comment"># DatetimeIndex([&#x27;2012-03-07 09:30:00+00:00&#x27;, &#x27;2012-03-08 09:30:00+00:00&#x27;,</span></span><br><span class="line"><span class="comment">#                &#x27;2012-03-09 09:30:00+00:00&#x27;, &#x27;2012-03-12 09:30:00+00:00&#x27;,</span></span><br><span class="line"><span class="comment">#                &#x27;2012-03-13 09:30:00+00:00&#x27;, &#x27;2012-03-14 09:30:00+00:00&#x27;,</span></span><br><span class="line"><span class="comment">#                &#x27;2012-03-15 09:30:00+00:00&#x27;],</span></span><br><span class="line"><span class="comment">#               dtype=&#x27;datetime64[ns, UTC]&#x27;, freq=&#x27;B&#x27;)</span></span><br></pre></td></tr></table></figure>



<hr>
<h2 id="11-5-时期及其算术运算"><a href="#11-5-时期及其算术运算" class="headerlink" title="11.5 时期及其算术运算"></a>11.5 时期及其算术运算</h2><p>Period类:</p>
<ul>
<li>时期（period）表示的是<strong>时间区间</strong>，⽐如数日、数⽉、数季、数年等。(例如:<code>p=pd.Period(2007,freq=&#39;A-DEC&#39;)</code>,p对象表示的从2007年1⽉1⽇到2007年12⽉31⽇之间的整段时间。)</li>
<li>因为是时间区间,所以可以传入freq频率参数</li>
<li>period_range函数可⽤于创建规则的时期范围,返回的是<code>PeriodIndex</code>对象</li>
<li>既然有<code>PeriodIndex</code>对象,自然可以用来做Index</li>
<li>就像DateTimeIndex一样,<code>DateTimeIndex索引</code>不一定传入要DateTimeIndex对象,传入字符串组成的列表也可以</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p = pd.Period(<span class="number">2007</span>, freq=<span class="string">&#x27;A-DEC&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(p)</span><br><span class="line"><span class="comment"># 2007</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(p + <span class="number">5</span>)</span><br><span class="line"><span class="comment"># 2012</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(p - <span class="number">2</span>)</span><br><span class="line"><span class="comment"># 2005</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 两个Period对象拥有相同的频率，则它们的差就是它们之间的单位数量</span></span><br><span class="line"><span class="built_in">print</span>(pd.Period(<span class="string">&#x27;2014&#x27;</span>, freq=<span class="string">&#x27;A-DEC&#x27;</span>) - p)</span><br><span class="line"><span class="comment"># 7</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># period_range函数可⽤于创建规则的时期范围,返回PeriodIndex对象</span></span><br><span class="line">rng = pd.period_range(<span class="string">&#x27;2000-01-01&#x27;</span>, <span class="string">&#x27;2000-03-30&#x27;</span>, freq=<span class="string">&#x27;M&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(rng)</span><br><span class="line"><span class="comment"># PeriodIndex([&#x27;2000-01&#x27;, &#x27;2000-02&#x27;, &#x27;2000-03&#x27;], dtype=&#x27;period[M]&#x27;, freq=&#x27;M&#x27;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用PeriodIndex作为Index</span></span><br><span class="line">np.random.seed(<span class="number">888</span>)</span><br><span class="line"><span class="built_in">print</span>(pd.Series(np.random.randn(<span class="number">3</span>), index=rng))</span><br><span class="line"><span class="comment"># 2000-01   -0.176201</span></span><br><span class="line"><span class="comment"># 2000-02    0.188876</span></span><br><span class="line"><span class="comment"># 2000-03    0.826747</span></span><br><span class="line"><span class="comment"># Freq: M, dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 就像DateTimeIndex一样,DateTimeIndex索引不一定传入要DateTimeIndex对象</span></span><br><span class="line"><span class="comment"># 传入字符串组成的列表也可以</span></span><br><span class="line">values = [<span class="string">&#x27;2001Q3&#x27;</span>, <span class="string">&#x27;2002Q2&#x27;</span>, <span class="string">&#x27;2003Q1&#x27;</span>]</span><br><span class="line">index = pd.PeriodIndex(values, freq=<span class="string">&#x27;Q-DEC&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(index)</span><br><span class="line"><span class="comment"># PeriodIndex([&#x27;2001Q3&#x27;, &#x27;2002Q2&#x27;, &#x27;2003Q1&#x27;], dtype=&#x27;period[Q-DEC]&#x27;, freq=&#x27;Q-DEC&#x27;)</span></span><br></pre></td></tr></table></figure>



<p>时期的频率转换</p>
<p>Period和PeriodIndex对象都可以通过其<code>asfreq</code>⽅法被转换成别的频率。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p = pd.Period(<span class="string">&#x27;2007&#x27;</span>, freq=<span class="string">&#x27;A-DEC&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(p)</span><br><span class="line"><span class="comment"># 2007</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将时间转为年初第一个月</span></span><br><span class="line"><span class="built_in">print</span>(p.asfreq(<span class="string">&#x27;M&#x27;</span>, how=<span class="string">&#x27;start&#x27;</span>))</span><br><span class="line"><span class="comment"># 2007-01</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将时间站位年末最后一个月</span></span><br><span class="line"><span class="built_in">print</span>(p.asfreq(<span class="string">&#x27;M&#x27;</span>, how=<span class="string">&#x27;end&#x27;</span>))</span><br><span class="line"><span class="comment"># 2007-12</span></span><br></pre></td></tr></table></figure>

<p>以将<code>Period(&#39;2007&#39;,&#39;A-DEC&#39;)</code>看做⼀个被划分为多个⽉度时期的时间段中的游标<br><img src="/images/1557729803602.png" alt="1557729803602"></p>
<p>在A-JUN频率中:一年的范围是从7月到下一年的6月</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在A-JUN频率中，⽉份“2007年8⽉”实际上是属于周期“2008年”的</span></span><br><span class="line"><span class="comment"># 一年的范围是从7月到下一年的6月</span></span><br><span class="line">p = pd.Period(<span class="string">&#x27;2007&#x27;</span>, freq=<span class="string">&#x27;A-JUN&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(p)</span><br><span class="line"><span class="comment"># 2007</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(p.asfreq(<span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;start&#x27;</span>))</span><br><span class="line"><span class="comment"># 2006-07</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(p.asfreq(<span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;end&#x27;</span>))</span><br><span class="line"><span class="comment"># 2007-06</span></span><br></pre></td></tr></table></figure>

<p>高频率转换为低频率时，父时期（superperiod）是由子时期（subperiod）所属的位置决定的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p = pd.Period(<span class="string">&#x27;Aug-2007&#x27;</span>, <span class="string">&#x27;M&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(p)</span><br><span class="line"><span class="comment"># 2007-08</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(p.asfreq(<span class="string">&#x27;A-JUN&#x27;</span>))</span><br><span class="line"><span class="comment"># 2008</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(p.freq)</span><br><span class="line"><span class="comment"># &lt;MonthEnd&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">np.random.seed(<span class="number">888</span>)</span><br><span class="line">rng = pd.period_range(<span class="string">&#x27;2006&#x27;</span>, <span class="string">&#x27;2009&#x27;</span>, freq=<span class="string">&#x27;A-DEC&#x27;</span>)</span><br><span class="line">ts = pd.Series(np.random.randn(<span class="built_in">len</span>(rng)), index=rng)</span><br><span class="line"><span class="built_in">print</span>(ts)</span><br><span class="line"><span class="comment"># 2006   -0.176201</span></span><br><span class="line"><span class="comment"># 2007    0.188876</span></span><br><span class="line"><span class="comment"># 2008    0.826747</span></span><br><span class="line"><span class="comment"># 2009   -0.032447</span></span><br><span class="line"><span class="comment"># Freq: A-DEC, dtype: float64</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ts.asfreq(<span class="string">&#x27;M&#x27;</span>, how=<span class="string">&#x27;start&#x27;</span>))</span><br><span class="line"><span class="comment"># 2006-01   -0.176201</span></span><br><span class="line"><span class="comment"># 2007-01    0.188876</span></span><br><span class="line"><span class="comment"># 2008-01    0.826747</span></span><br><span class="line"><span class="comment"># 2009-01   -0.032447</span></span><br><span class="line"><span class="comment"># Freq: M, dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ts.asfreq(<span class="string">&#x27;B&#x27;</span>, how=<span class="string">&#x27;end&#x27;</span>))</span><br><span class="line"><span class="comment"># 2006-12-29   -0.176201</span></span><br><span class="line"><span class="comment"># 2007-12-31    0.188876</span></span><br><span class="line"><span class="comment"># 2008-12-31    0.826747</span></span><br><span class="line"><span class="comment"># 2009-12-31   -0.032447</span></span><br><span class="line"><span class="comment"># Freq: B, dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ts.asfreq(<span class="string">&#x27;B&#x27;</span>, how=<span class="string">&#x27;start&#x27;</span>))</span><br><span class="line"><span class="comment"># 2006-01-02   -0.176201</span></span><br><span class="line"><span class="comment"># 2007-01-01    0.188876</span></span><br><span class="line"><span class="comment"># 2008-01-01    0.826747</span></span><br><span class="line"><span class="comment"># 2009-01-01   -0.032447</span></span><br><span class="line"><span class="comment"># Freq: B, dtype: float64</span></span><br></pre></td></tr></table></figure>



<p>按季度计算的时期频率</p>
<p>pandas⽀持12种季度型频率，即QJAN到Q-DEC：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p = pd.Period(<span class="string">&#x27;2012Q4&#x27;</span>, freq=<span class="string">&#x27;Q-JAN&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(p)</span><br><span class="line"><span class="comment"># 2012Q4</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在以1⽉结束的财年中，2012Q4是从11⽉到1⽉</span></span><br><span class="line"><span class="built_in">print</span>(p.asfreq(<span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;start&#x27;</span>))</span><br><span class="line"><span class="comment"># 2011-11-01</span></span><br><span class="line"><span class="built_in">print</span>(p.asfreq(<span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;end&#x27;</span>))</span><br><span class="line"><span class="comment"># 2012-01-31</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p = pd.Period(<span class="string">&#x27;2012Q4&#x27;</span>, freq=<span class="string">&#x27;Q-JAN&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取该季度倒数第⼆个⼯作⽇下午4点的时间戳，</span></span><br><span class="line">p4pm = (p.asfreq(<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;e&#x27;</span>) - <span class="number">1</span>).asfreq(<span class="string">&#x27;T&#x27;</span>, <span class="string">&#x27;s&#x27;</span>) + <span class="number">16</span> * <span class="number">60</span></span><br><span class="line"><span class="built_in">print</span>(p4pm)</span><br><span class="line"><span class="comment"># 2012-01-30 16:00</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(p4pm.to_timestamp())</span><br><span class="line"><span class="comment"># 2012-01-30 16:00:00</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/20190513150924.png" alt="20190513150924"></p>
<p>period_range传入像Q-JAN一样的freq可以生成季度型范围</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># period_range传入像Q-JAN一样的freq可以生成季度型范围</span></span><br><span class="line">rng = pd.period_range(<span class="string">&#x27;2011Q3&#x27;</span>, <span class="string">&#x27;2012Q4&#x27;</span>, freq=<span class="string">&#x27;Q-JAN&#x27;</span>)</span><br><span class="line">ts = pd.Series(np.arange(<span class="built_in">len</span>(rng)), index=rng)</span><br><span class="line"><span class="built_in">print</span>(ts)</span><br><span class="line"><span class="comment"># 2011Q3    0</span></span><br><span class="line"><span class="comment"># 2011Q4    1</span></span><br><span class="line"><span class="comment"># 2012Q1    2</span></span><br><span class="line"><span class="comment"># 2012Q2    3</span></span><br><span class="line"><span class="comment"># 2012Q3    4</span></span><br><span class="line"><span class="comment"># 2012Q4    5</span></span><br><span class="line"><span class="comment"># Freq: Q-JAN, dtype: int32</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取该季度倒数第⼆个⼯作⽇下午4点的时间戳，</span></span><br><span class="line">new_rng = (rng.asfreq(<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;e&#x27;</span>) - <span class="number">1</span>).asfreq(<span class="string">&#x27;T&#x27;</span>, <span class="string">&#x27;s&#x27;</span>) + <span class="number">16</span> * <span class="number">60</span></span><br><span class="line">ts.index = new_rng.to_timestamp()</span><br><span class="line"><span class="built_in">print</span>(ts)</span><br><span class="line"><span class="comment"># 2010-10-28 16:00:00    0</span></span><br><span class="line"><span class="comment"># 2011-01-28 16:00:00    1</span></span><br><span class="line"><span class="comment"># 2011-04-28 16:00:00    2</span></span><br><span class="line"><span class="comment"># 2011-07-28 16:00:00    3</span></span><br><span class="line"><span class="comment"># 2011-10-28 16:00:00    4</span></span><br><span class="line"><span class="comment"># 2012-01-30 16:00:00    5</span></span><br><span class="line"><span class="comment"># dtype: int32</span></span><br></pre></td></tr></table></figure>



<p>将Timestamp转换为Period（及其反向过程）</p>
<ul>
<li><code>to_period()</code>方法:<br>将<strong>时间戳索引</strong>转换为<strong>时期索引</strong><br>(也就是TimestampIndex转为PeriodIndex)</li>
<li><code>to_timestamp</code>方法:<br>将时期索引转为时间戳索引<br>(也就是说PeriodIndex转为TimestampIndex)</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">np.random.seed(<span class="number">888</span>)</span><br><span class="line">rng = pd.date_range(<span class="string">&#x27;2000-01-01&#x27;</span>, periods=<span class="number">3</span>, freq=<span class="string">&#x27;M&#x27;</span>)</span><br><span class="line">ts = pd.Series(np.random.randn(<span class="number">3</span>), index=rng)</span><br><span class="line"><span class="built_in">print</span>(ts)</span><br><span class="line"><span class="comment"># 2000-01-31   -0.176201</span></span><br><span class="line"><span class="comment"># 2000-02-29    0.188876</span></span><br><span class="line"><span class="comment"># 2000-03-31    0.826747</span></span><br><span class="line"><span class="comment"># Freq: M, dtype: float64</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ts的行索引为DatetimeIndex</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(ts.index))</span><br><span class="line"><span class="comment"># &lt;class &#x27;pandas.core.indexes.datetimes.DatetimeIndex&#x27;&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pts = ts.to_period()</span><br><span class="line"><span class="built_in">print</span>(pts)</span><br><span class="line"><span class="comment"># 2000-01   -0.176201</span></span><br><span class="line"><span class="comment"># 2000-02    0.188876</span></span><br><span class="line"><span class="comment"># 2000-03    0.826747</span></span><br><span class="line"><span class="comment"># Freq: M, dtype: float64</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pts的行索引为PeriodIndex</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(pts.index))</span><br><span class="line"><span class="comment"># &lt;class &#x27;pandas.core.indexes.period.PeriodIndex&#x27;&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 新PeriodIndex的频率默认是从时间戳推断⽽来的，你也可以指定任何别的频率</span></span><br><span class="line">rng = pd.date_range(<span class="string">&#x27;1/29/2000&#x27;</span>, periods=<span class="number">6</span>, freq=<span class="string">&#x27;D&#x27;</span>)</span><br><span class="line">ts2 = pd.Series(np.random.randn(<span class="number">6</span>), index=rng)</span><br><span class="line"><span class="built_in">print</span>(ts2)</span><br><span class="line"><span class="comment"># 2000-01-29   -0.032447</span></span><br><span class="line"><span class="comment"># 2000-01-30   -0.652499</span></span><br><span class="line"><span class="comment"># 2000-01-31   -0.105339</span></span><br><span class="line"><span class="comment"># 2000-02-01    0.217776</span></span><br><span class="line"><span class="comment"># 2000-02-02    0.587282</span></span><br><span class="line"><span class="comment"># 2000-02-03    0.100238</span></span><br><span class="line"><span class="comment"># Freq: D, dtype: float64</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(ts2.index))</span><br><span class="line"><span class="comment"># &lt;class &#x27;pandas.core.indexes.datetimes.DatetimeIndex&#x27;&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ts2.to_period(<span class="string">&#x27;M&#x27;</span>))</span><br><span class="line"><span class="comment"># 2000-01   -0.032447</span></span><br><span class="line"><span class="comment"># 2000-01   -0.652499</span></span><br><span class="line"><span class="comment"># 2000-01   -0.105339</span></span><br><span class="line"><span class="comment"># 2000-02    0.217776</span></span><br><span class="line"><span class="comment"># 2000-02    0.587282</span></span><br><span class="line"><span class="comment"># 2000-02    0.100238</span></span><br><span class="line"><span class="comment"># Freq: M, dtype: float64</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ts2.to_period(<span class="string">&#x27;M&#x27;</span>).index)</span><br><span class="line"><span class="comment"># PeriodIndex([&#x27;2000-01&#x27;, &#x27;2000-01&#x27;, &#x27;2000-01&#x27;, &#x27;2000-02&#x27;, &#x27;2000-02&#x27;, &#x27;2000-02&#x27;], dtype=&#x27;period[M]&#x27;, freq=&#x27;M&#x27;)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">np.random.seed(<span class="number">888</span>)</span><br><span class="line">rng = pd.date_range(<span class="string">&#x27;1/29/2000&#x27;</span>, periods=<span class="number">6</span>, freq=<span class="string">&#x27;D&#x27;</span>)</span><br><span class="line">ts2 = pd.Series(np.random.randn(<span class="number">6</span>), index=rng)</span><br><span class="line"><span class="built_in">print</span>(ts2)</span><br><span class="line"><span class="comment"># 2000-01-29   -0.176201</span></span><br><span class="line"><span class="comment"># 2000-01-30    0.188876</span></span><br><span class="line"><span class="comment"># 2000-01-31    0.826747</span></span><br><span class="line"><span class="comment"># 2000-02-01   -0.032447</span></span><br><span class="line"><span class="comment"># 2000-02-02   -0.652499</span></span><br><span class="line"><span class="comment"># 2000-02-03   -0.105339</span></span><br><span class="line"><span class="comment"># Freq: D, dtype: float64</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(ts2.index))</span><br><span class="line"><span class="comment"># &lt;class &#x27;pandas.core.indexes.datetimes.DatetimeIndex&#x27;&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用to_period将DateTimeIndex改为PeriodIndex</span></span><br><span class="line">ts3 = ts2.to_period(<span class="string">&#x27;M&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(ts3)</span><br><span class="line"><span class="comment"># 2000-01   -0.176201</span></span><br><span class="line"><span class="comment"># 2000-01    0.188876</span></span><br><span class="line"><span class="comment"># 2000-01    0.826747</span></span><br><span class="line"><span class="comment"># 2000-02   -0.032447</span></span><br><span class="line"><span class="comment"># 2000-02   -0.652499</span></span><br><span class="line"><span class="comment"># 2000-02   -0.105339</span></span><br><span class="line"><span class="comment"># Freq: M, dtype: float64</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(ts3.index))</span><br><span class="line"><span class="comment"># &lt;class &#x27;pandas.core.indexes.period.PeriodIndex&#x27;&gt;</span></span><br></pre></td></tr></table></figure>



<p>通过数组创建PeriodIndex</p>
<p>有可能年度(year)和季度(quarter)不再同一列,这时就可以使用PeriodIndex的year参数和quarter参数将二者合起来,创建一个新的PeriodIndex</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data = pd.read_csv(<span class="string">&#x27;examples/macrodata.csv&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 年度(year)和季度(quarter)在不同列</span></span><br><span class="line"><span class="built_in">print</span>(data.head(<span class="number">3</span>))</span><br><span class="line"><span class="comment">#      year  quarter   realgdp  realcons  realinv  realgovt  realdpi    cpi  \</span></span><br><span class="line"><span class="comment"># 0  1959.0      1.0  2710.349    1707.4  286.898   470.045   1886.9  28.98   </span></span><br><span class="line"><span class="comment"># 1  1959.0      2.0  2778.801    1733.7  310.859   481.301   1919.7  29.15   </span></span><br><span class="line"><span class="comment"># 2  1959.0      3.0  2775.488    1751.8  289.226   491.260   1916.4  29.35   </span></span><br><span class="line"><span class="comment">#       m1  tbilrate  unemp      pop  infl  realint  </span></span><br><span class="line"><span class="comment"># 0  139.7      2.82    5.8  177.146  0.00     0.00  </span></span><br><span class="line"><span class="comment"># 1  141.7      3.08    5.1  177.830  2.34     0.74  </span></span><br><span class="line"><span class="comment"># 2  140.5      3.82    5.3  178.657  2.74     1.09  </span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(data.year)</span><br><span class="line"><span class="comment"># 0      1959.0</span></span><br><span class="line"><span class="comment"># 1      1959.0</span></span><br><span class="line"><span class="comment">#         ...  </span></span><br><span class="line"><span class="comment"># 201    2009.0</span></span><br><span class="line"><span class="comment"># 202    2009.0</span></span><br><span class="line"><span class="comment"># Name: year, Length: 203, dtype: float64</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(data.quarter)</span><br><span class="line"><span class="comment"># 0      1.0</span></span><br><span class="line"><span class="comment"># 1      2.0</span></span><br><span class="line"><span class="comment">#       ... </span></span><br><span class="line"><span class="comment"># 201    2.0</span></span><br><span class="line"><span class="comment"># 202    3.0</span></span><br><span class="line"><span class="comment"># Name: quarter, Length: 203, dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将不同的列传入PeriodIndex不同的参数,组合年度和季度</span></span><br><span class="line">index = pd.PeriodIndex(year=data.year, quarter=data.quarter,</span><br><span class="line">                       freq=<span class="string">&#x27;Q-DEC&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(index)</span><br><span class="line"><span class="comment"># PeriodIndex([&#x27;1959Q1&#x27;, &#x27;1959Q2&#x27;, &#x27;1959Q3&#x27;, &#x27;1959Q4&#x27;, &#x27;1960Q1&#x27;, &#x27;1960Q2&#x27;,</span></span><br><span class="line"><span class="comment">#              &#x27;1960Q3&#x27;, &#x27;1960Q4&#x27;, &#x27;1961Q1&#x27;, &#x27;1961Q2&#x27;,</span></span><br><span class="line"><span class="comment">#              ...</span></span><br><span class="line"><span class="comment">#              &#x27;2007Q2&#x27;, &#x27;2007Q3&#x27;, &#x27;2007Q4&#x27;, &#x27;2008Q1&#x27;, &#x27;2008Q2&#x27;, &#x27;2008Q3&#x27;,</span></span><br><span class="line"><span class="comment">#              &#x27;2008Q4&#x27;, &#x27;2009Q1&#x27;, &#x27;2009Q2&#x27;, &#x27;2009Q3&#x27;],</span></span><br><span class="line"><span class="comment">#             dtype=&#x27;period[Q-DEC]&#x27;, length=203, freq=&#x27;Q-DEC&#x27;)</span></span><br><span class="line"></span><br><span class="line">data.index = index</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(data.infl)</span><br><span class="line"><span class="comment"># 1959Q1    0.00</span></span><br><span class="line"><span class="comment"># 1959Q2    2.34</span></span><br><span class="line"><span class="comment">#           ... </span></span><br><span class="line"><span class="comment"># 2009Q2    3.37</span></span><br><span class="line"><span class="comment"># 2009Q3    3.56</span></span><br><span class="line"><span class="comment"># Freq: Q-DEC, Name: infl, Length: 203, dtype: float64</span></span><br></pre></td></tr></table></figure>



<hr>
<h2 id="11-6-重采样及频率转换"><a href="#11-6-重采样及频率转换" class="headerlink" title="11.6 重采样及频率转换"></a>11.6 重采样及频率转换</h2><p>重采样（resampling）指的是将时间序列<strong>从⼀个频率转换到另⼀个频率</strong>的处理过程。</p>
<ul>
<li>将<strong>高频率数据聚合到低频率</strong>称为<code>降采样</code>（downsampling）。</li>
<li>将<strong>低频率数据转换到高频率</strong>称为<code>升采样</code>（upsampling）。</li>
<li>并不是所有的重采样都能被划分到这两个⼤类中。</li>
</ul>
<p>升采样与降采样:</p>
<ul>
<li><p>降采样：时间粒度变大。例如，原来是按天统计的数据，现在变成按周统计。降采样会涉及到<strong>数据的聚合</strong>，比如天数据变成周数据，那么就得对一周的7天数据聚合，聚合的方式可以是求和，求均值等等。</p>
</li>
<li><p>升采样：时间粒度变小。例如，原来是按周统计的数据，现在变成按天统计。升采样会涉及到<strong>数据的填充</strong>，根据填充的方法不同填充的数据也就不同。</p>
</li>
</ul>
<p>各种频率转换⼯作:<code>resample⽅法</code></p>
<p>==resample有类似于groupby的API==，调⽤resample可以分组数据，然后会调⽤⼀个聚合函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rng = pd.date_range(<span class="string">&#x27;2000-01-01&#x27;</span>, periods=<span class="number">100</span>, freq=<span class="string">&#x27;D&#x27;</span>)</span><br><span class="line">ts = pd.Series(np.arange(<span class="built_in">len</span>(rng)), index=rng)</span><br><span class="line"><span class="built_in">print</span>(ts)</span><br><span class="line"><span class="comment"># 2000-01-01     0</span></span><br><span class="line"><span class="comment"># 2000-01-02     1</span></span><br><span class="line"><span class="comment">#               ..</span></span><br><span class="line"><span class="comment"># 2000-04-08    98</span></span><br><span class="line"><span class="comment"># 2000-04-09    99</span></span><br><span class="line"><span class="comment"># Freq: D, Length: 100, dtype: int32</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据月来聚合PeriodIndex,计算平均值</span></span><br><span class="line"><span class="built_in">print</span>(ts.resample(<span class="string">&#x27;M&#x27;</span>).mean())</span><br><span class="line"><span class="comment"># 2000-01-31    15</span></span><br><span class="line"><span class="comment"># 2000-02-29    45</span></span><br><span class="line"><span class="comment"># 2000-03-31    75</span></span><br><span class="line"><span class="comment"># 2000-04-30    95</span></span><br><span class="line"><span class="comment"># Freq: M, dtype: int32</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ts.resample(<span class="string">&#x27;M&#x27;</span>, kind=<span class="string">&#x27;period&#x27;</span>).mean())</span><br><span class="line"><span class="comment"># 2000-01    15</span></span><br><span class="line"><span class="comment"># 2000-02    45</span></span><br><span class="line"><span class="comment"># 2000-03    75</span></span><br><span class="line"><span class="comment"># 2000-04    95</span></span><br><span class="line"><span class="comment"># Freq: M, dtype: int32</span></span><br></pre></td></tr></table></figure>

<p> resample⽅法的参数</p>
<p><img src="/images/9656e742f7.png" alt="9656e742f7"></p>
<p>降采样</p>
<p>使用降采样必须保证<strong>所有时间段的并集必须能组成整个时间帧</strong>。</p>
<p>使用resample对数据进⾏降采样时，需要考虑两样东⻄：</p>
<ul>
<li>各区间哪边是闭合的。</li>
<li>如何标记各个聚合⾯元，用区间的开头还是末尾。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rng = pd.date_range(<span class="string">&#x27;2000-01-01&#x27;</span>, periods=<span class="number">12</span>, freq=<span class="string">&#x27;T&#x27;</span>)</span><br><span class="line">ts = pd.Series(np.arange(<span class="number">12</span>), index=rng)</span><br><span class="line"><span class="built_in">print</span>(ts)</span><br><span class="line"><span class="comment"># 2000-01-01 00:00:00     0</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:01:00     1</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:02:00     2</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:03:00     3</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:04:00     4</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:05:00     5</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:06:00     6</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:07:00     7</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:08:00     8</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:09:00     9</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:10:00    10</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:11:00    11</span></span><br><span class="line"><span class="comment"># Freq: T, dtype: int32</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将高频的1分钟聚合成5分钟</span></span><br><span class="line"><span class="comment"># 默认情况下，⾯元的右边界是包含的,因此00:00到00:05的区间中是包含00:05的。</span></span><br><span class="line"><span class="built_in">print</span>(ts.resample(<span class="string">&#x27;5min&#x27;</span>, closed=<span class="string">&#x27;right&#x27;</span>).count())</span><br><span class="line"><span class="comment"># 1999-12-31 23:55:00    1</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:00:00    5</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:05:00    5</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:10:00    1</span></span><br><span class="line"><span class="comment"># Freq: 5T, dtype: int64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 传⼊label=&#x27;right&#x27;即使用区间的右边值作为索引：</span></span><br><span class="line"><span class="built_in">print</span>(ts.resample(<span class="string">&#x27;5min&#x27;</span>, closed=<span class="string">&#x27;right&#x27;</span>, label=<span class="string">&#x27;right&#x27;</span>).count())</span><br><span class="line"><span class="comment"># 2000-01-01 00:00:00    1</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:05:00    5</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:10:00    5</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:15:00    1</span></span><br><span class="line"><span class="comment"># Freq: 5T, dtype: int64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 传⼊closed=&#x27;left&#x27;会让区间以左边界闭合</span></span><br><span class="line"><span class="built_in">print</span>(ts.resample(<span class="string">&#x27;5min&#x27;</span>, closed=<span class="string">&#x27;left&#x27;</span>).count())</span><br><span class="line"><span class="comment"># #2000-01-01 00:00:00    5</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:05:00    5</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:10:00    2</span></span><br><span class="line"><span class="comment"># Freq: 5T, dtype: int64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># loffset:对索引做位移</span></span><br><span class="line"><span class="built_in">print</span>(ts.resample(<span class="string">&#x27;5min&#x27;</span>, closed=<span class="string">&#x27;right&#x27;</span>,label=<span class="string">&#x27;right&#x27;</span>, loffset=<span class="string">&#x27;-1s&#x27;</span>).count())</span><br><span class="line"><span class="comment"># 1999-12-31 23:59:59    1</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:04:59    5</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:09:59    5</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:14:59    1</span></span><br><span class="line"><span class="comment"># Freq: 5T, dtype: int64</span></span><br></pre></td></tr></table></figure>



<p>closed参数说明:</p>
<ul>
<li><p>closed用于区间的开闭.<br>closed = ‘right’ 左开右闭<br>closed = ‘left’ 左闭右开</p>
</li>
<li><p>区间的范围:<br>比如periods范围是2018年1月1号-12号.</p>
<ol>
<li><p>执行<code>a = ts.resample(&#39;5D&#39;, closed=&#39;left&#39;).sum()</code><br>那么区间就是:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">区间1：[1, 6)</span><br><span class="line">区间2: [6, 11)</span><br><span class="line">区间3：[11, 16)</span><br></pre></td></tr></table></figure></li>
<li><p>执行<code>a = ts.resample(&#39;5D&#39;, closed=&#39;right&#39;).sum()</code><br>那么区间就是:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">区间1：(27, 1]</span><br><span class="line">区间2：(1, 6]</span><br><span class="line">区间3: (6, 11]</span><br><span class="line">区间4：(11, 16]</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>总结:<br>==区间只需看看第一天==:</p>
<ol>
<li>如果<code>closed=&#39;left&#39;</code>,那么就是以第一天开始,往后推</li>
<li>如果<code>closed=&#39;right&#39;</code>,那么就是以第一天结束,往前推</li>
</ol>
</li>
</ul>
<p>label参数说明:</p>
<ul>
<li>label参数决定索引的值</li>
<li>label为left的时候，就以区间左边的那个日期作为索引；label为right的时候，就以区间的右边那个日期作为索引。</li>
</ul>
<p><img src="/images/29702537.png" alt="29702537"></p>
<p>loffset参数:<br>对<strong>行索引</strong>做位移</p>
<hr>
<p>升采样</p>
<p>就像前面说的,升采样时间粒度变小。例如，原来是按周统计的数据，现在变成按天统计。升采样会涉及到<strong>数据的填充</strong></p>
<p>四种填充方法（实际是三种）：</p>
<ul>
<li><code>asfreq</code>:<br>不填充。那么对应无值的地方，用NaN代替。</li>
<li><code>ffill</code>/<code>pad</code>:<br>用前值填充。用前面的值填充无值的地方。</li>
<li><code>bfill</code>:<br>用后值填充。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rng = pd.date_range(<span class="string">&#x27;20180101&#x27;</span>, periods=<span class="number">2</span>)</span><br><span class="line">ts = pd.Series(np.arange(<span class="number">2</span>), index=rng)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ts)</span><br><span class="line"><span class="comment"># 2018-01-01    0</span></span><br><span class="line"><span class="comment"># 2018-01-02    1</span></span><br><span class="line"><span class="comment"># Freq: D, dtype: int32</span></span><br><span class="line"></span><br><span class="line">ts_6h_asfreq = ts.resample(<span class="string">&#x27;6H&#x27;</span>).asfreq()</span><br><span class="line"><span class="built_in">print</span>(ts_6h_asfreq)</span><br><span class="line"><span class="comment"># 2018-01-01 00:00:00    0.0</span></span><br><span class="line"><span class="comment"># 2018-01-01 06:00:00    NaN</span></span><br><span class="line"><span class="comment"># 2018-01-01 12:00:00    NaN</span></span><br><span class="line"><span class="comment"># 2018-01-01 18:00:00    NaN</span></span><br><span class="line"><span class="comment"># 2018-01-02 00:00:00    1.0</span></span><br><span class="line"><span class="comment"># Freq: 6H, dtype: float64</span></span><br><span class="line"></span><br><span class="line">ts_6h_pad = ts.resample(<span class="string">&#x27;6H&#x27;</span>).pad()</span><br><span class="line"><span class="built_in">print</span>(ts_6h_pad)</span><br><span class="line"><span class="comment"># 2018-01-01 00:00:00    0</span></span><br><span class="line"><span class="comment"># 2018-01-01 06:00:00    0</span></span><br><span class="line"><span class="comment"># 2018-01-01 12:00:00    0</span></span><br><span class="line"><span class="comment"># 2018-01-01 18:00:00    0</span></span><br><span class="line"><span class="comment"># 2018-01-02 00:00:00    1</span></span><br><span class="line"><span class="comment"># Freq: 6H, dtype: int32</span></span><br><span class="line"></span><br><span class="line">ts_6h_ffill = ts.resample(<span class="string">&#x27;6H&#x27;</span>).ffill()</span><br><span class="line"><span class="built_in">print</span>(ts_6h_ffill)</span><br><span class="line"><span class="comment"># 2018-01-01 00:00:00    0</span></span><br><span class="line"><span class="comment"># 2018-01-01 06:00:00    0</span></span><br><span class="line"><span class="comment"># 2018-01-01 12:00:00    0</span></span><br><span class="line"><span class="comment"># 2018-01-01 18:00:00    0</span></span><br><span class="line"><span class="comment"># 2018-01-02 00:00:00    1</span></span><br><span class="line"><span class="comment"># Freq: 6H, dtype: int32</span></span><br><span class="line"></span><br><span class="line">ts_6h_bfill = ts.resample(<span class="string">&#x27;6H&#x27;</span>).bfill()</span><br><span class="line"><span class="built_in">print</span>(ts_6h_bfill)</span><br><span class="line"><span class="comment"># 2018-01-01 00:00:00    0</span></span><br><span class="line"><span class="comment"># 2018-01-01 06:00:00    1</span></span><br><span class="line"><span class="comment"># 2018-01-01 12:00:00    1</span></span><br><span class="line"><span class="comment"># 2018-01-01 18:00:00    1</span></span><br><span class="line"><span class="comment"># 2018-01-02 00:00:00    1</span></span><br><span class="line"><span class="comment"># Freq: 6H, dtype: int32</span></span><br></pre></td></tr></table></figure>



<p>OHLC重采样</p>
<blockquote>
<p>OHLC重采样:<br>计算各⾯元的四个值：第⼀个值（open，开盘）、最后⼀个值（close，收盘）、最⼤值（high，最⾼）以及最⼩值（low，最低）。</p>
</blockquote>
<p>使用how参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rng = pd.date_range(<span class="string">&#x27;2000-01-01&#x27;</span>, periods=<span class="number">12</span>, freq=<span class="string">&#x27;T&#x27;</span>)</span><br><span class="line">ts = pd.Series(np.arange(<span class="number">12</span>), index=rng)</span><br><span class="line"><span class="built_in">print</span>(ts)</span><br><span class="line"><span class="comment"># 2000-01-01 00:00:00     0</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:01:00     1</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:02:00     2</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:03:00     3</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:04:00     4</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:05:00     5</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:06:00     6</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:07:00     7</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:08:00     8</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:09:00     9</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:10:00    10</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:11:00    11</span></span><br><span class="line"><span class="comment"># Freq: T, dtype: int32</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用how参数</span></span><br><span class="line"><span class="built_in">print</span>(ts.resample(<span class="string">&#x27;5min&#x27;</span>).ohlc())</span><br><span class="line"><span class="comment">#                      open  high  low  close</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:00:00     0     4    0      4</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:05:00     5     9    5      9</span></span><br><span class="line"><span class="comment"># 2000-01-01 00:10:00    10    11   10     11</span></span><br></pre></td></tr></table></figure>



<p>升采样和插值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">frame = pd.DataFrame(np.arange(<span class="number">10000</span>,<span class="number">10008</span>).reshape(<span class="number">2</span>,<span class="number">4</span>),</span><br><span class="line">                     index=pd.date_range(<span class="string">&#x27;1/1/2000&#x27;</span>, periods=<span class="number">2</span>,freq=<span class="string">&#x27;W-WED&#x27;</span>),</span><br><span class="line">                     columns=[<span class="string">&#x27;Colorado&#x27;</span>, <span class="string">&#x27;Texas&#x27;</span>, <span class="string">&#x27;New York&#x27;</span>, <span class="string">&#x27;Ohio&#x27;</span>])</span><br><span class="line"><span class="built_in">print</span>(frame)</span><br><span class="line"><span class="comment">#             Colorado  Texas  New York   Ohio</span></span><br><span class="line"><span class="comment"># 2000-01-05     10000  10001     10002  10003</span></span><br><span class="line"><span class="comment"># 2000-01-12     10004  10005     10006  10007</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># asfreq不填充数据</span></span><br><span class="line">df_daily = frame.resample(<span class="string">&#x27;D&#x27;</span>).asfreq()</span><br><span class="line"><span class="built_in">print</span>(df_daily)</span><br><span class="line"><span class="comment">#             Colorado    Texas  New York     Ohio</span></span><br><span class="line"><span class="comment"># 2000-01-05   10000.0  10001.0   10002.0  10003.0</span></span><br><span class="line"><span class="comment"># 2000-01-06       NaN      NaN       NaN      NaN</span></span><br><span class="line"><span class="comment"># 2000-01-07       NaN      NaN       NaN      NaN</span></span><br><span class="line"><span class="comment"># 2000-01-08       NaN      NaN       NaN      NaN</span></span><br><span class="line"><span class="comment"># 2000-01-09       NaN      NaN       NaN      NaN</span></span><br><span class="line"><span class="comment"># 2000-01-10       NaN      NaN       NaN      NaN</span></span><br><span class="line"><span class="comment"># 2000-01-11       NaN      NaN       NaN      NaN</span></span><br><span class="line"><span class="comment"># 2000-01-12   10004.0  10005.0   10006.0  10007.0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ffill:前向填充</span></span><br><span class="line"><span class="built_in">print</span>(frame.resample(<span class="string">&#x27;D&#x27;</span>).ffill())</span><br><span class="line"><span class="comment">#             Colorado  Texas  New York   Ohio</span></span><br><span class="line"><span class="comment"># 2000-01-05     10000  10001     10002  10003</span></span><br><span class="line"><span class="comment"># 2000-01-06     10000  10001     10002  10003</span></span><br><span class="line"><span class="comment"># 2000-01-07     10000  10001     10002  10003</span></span><br><span class="line"><span class="comment"># 2000-01-08     10000  10001     10002  10003</span></span><br><span class="line"><span class="comment"># 2000-01-09     10000  10001     10002  10003</span></span><br><span class="line"><span class="comment"># 2000-01-10     10000  10001     10002  10003</span></span><br><span class="line"><span class="comment"># 2000-01-11     10000  10001     10002  10003</span></span><br><span class="line"><span class="comment"># 2000-01-12     10004  10005     10006  10007</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># limit:限制填充数量</span></span><br><span class="line"><span class="built_in">print</span>(frame.resample(<span class="string">&#x27;D&#x27;</span>).ffill(limit=<span class="number">2</span>))</span><br><span class="line"><span class="comment">#             Colorado    Texas  New York     Ohio</span></span><br><span class="line"><span class="comment"># 2000-01-05   10000.0  10001.0   10002.0  10003.0</span></span><br><span class="line"><span class="comment"># 2000-01-06   10000.0  10001.0   10002.0  10003.0</span></span><br><span class="line"><span class="comment"># 2000-01-07   10000.0  10001.0   10002.0  10003.0</span></span><br><span class="line"><span class="comment"># 2000-01-08       NaN      NaN       NaN      NaN</span></span><br><span class="line"><span class="comment"># 2000-01-09       NaN      NaN       NaN      NaN</span></span><br><span class="line"><span class="comment"># 2000-01-10       NaN      NaN       NaN      NaN</span></span><br><span class="line"><span class="comment"># 2000-01-11       NaN      NaN       NaN      NaN</span></span><br><span class="line"><span class="comment"># 2000-01-12   10004.0  10005.0   10006.0  10007.0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 每周的星期二,所以一行就是一周(周二到下周一)</span></span><br><span class="line"><span class="built_in">print</span>(frame.resample(<span class="string">&#x27;W-THU&#x27;</span>).ffill())</span><br><span class="line"><span class="comment">#             Colorado  Texas  New York   Ohio</span></span><br><span class="line"><span class="comment"># 2000-01-06     10000  10001     10002  10003</span></span><br><span class="line"><span class="comment"># 2000-01-13     10004  10005     10006  10007</span></span><br></pre></td></tr></table></figure>



<p>通过时期进行重采样</p>
<p>对那些使⽤时期索引的数据进行重采样与时间戳很像：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">frame = pd.DataFrame(np.arange(<span class="number">10000</span>,<span class="number">10096</span>).reshape(<span class="number">24</span>,<span class="number">4</span>),</span><br><span class="line">                     index=pd.period_range(<span class="string">&#x27;1-2000&#x27;</span>, <span class="string">&#x27;12-2001&#x27;</span>,freq=<span class="string">&#x27;M&#x27;</span>),</span><br><span class="line">                     columns=[<span class="string">&#x27;Colorado&#x27;</span>, <span class="string">&#x27;Texas&#x27;</span>, <span class="string">&#x27;New York&#x27;</span>, <span class="string">&#x27;Ohio&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(frame[:<span class="number">5</span>])</span><br><span class="line"><span class="comment">#          Colorado  Texas  New York   Ohio</span></span><br><span class="line"><span class="comment"># 2000-01     10000  10001     10002  10003</span></span><br><span class="line"><span class="comment"># 2000-02     10004  10005     10006  10007</span></span><br><span class="line"><span class="comment"># 2000-03     10008  10009     10010  10011</span></span><br><span class="line"><span class="comment"># 2000-04     10012  10013     10014  10015</span></span><br><span class="line"><span class="comment"># 2000-05     10016  10017     10018  10019</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">annual_frame = frame.resample(<span class="string">&#x27;A-DEC&#x27;</span>).mean()</span><br><span class="line"><span class="built_in">print</span>(annual_frame)</span><br><span class="line"><span class="comment">#       Colorado  Texas  New York   Ohio</span></span><br><span class="line"><span class="comment"># 2000     10022  10023     10024  10025</span></span><br><span class="line"><span class="comment"># 2001     10070  10071     10072  10073</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(annual_frame.resample(<span class="string">&#x27;Q-DEC&#x27;</span>).ffill())</span><br><span class="line"><span class="comment">#         Colorado  Texas  New York   Ohio</span></span><br><span class="line"><span class="comment"># 2000Q1     10022  10023     10024  10025</span></span><br><span class="line"><span class="comment"># 2000Q2     10022  10023     10024  10025</span></span><br><span class="line"><span class="comment"># 2000Q3     10022  10023     10024  10025</span></span><br><span class="line"><span class="comment"># 2000Q4     10022  10023     10024  10025</span></span><br><span class="line"><span class="comment"># 2001Q1     10070  10071     10072  10073</span></span><br><span class="line"><span class="comment"># 2001Q2     10070  10071     10072  10073</span></span><br><span class="line"><span class="comment"># 2001Q3     10070  10071     10072  10073</span></span><br><span class="line"><span class="comment"># 2001Q4     10070  10071     10072  10073</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># convention参数默认为&#x27;end&#x27;，可设置为&#x27;start&#x27;：</span></span><br><span class="line"><span class="built_in">print</span>(annual_frame.resample(<span class="string">&#x27;Q-DEC&#x27;</span>, convention=<span class="string">&#x27;end&#x27;</span>).ffill())</span><br><span class="line"><span class="comment">#         Colorado  Texas  New York   Ohio</span></span><br><span class="line"><span class="comment"># 2000Q4     10022  10023     10024  10025</span></span><br><span class="line"><span class="comment"># 2001Q1     10022  10023     10024  10025</span></span><br><span class="line"><span class="comment"># 2001Q2     10022  10023     10024  10025</span></span><br><span class="line"><span class="comment"># 2001Q3     10022  10023     10024  10025</span></span><br><span class="line"><span class="comment"># 2001Q4     10070  10071     10072  10073</span></span><br></pre></td></tr></table></figure>

<p>由于时期指的是时间区间，所以升采样和降采样的规则就⽐较严格：</p>
<ul>
<li>在降采样中，⽬标频率必须是源频率的子时期（subperiod）。</li>
<li>在升采样中，⽬标频率必须是源频率的超时期（superperiod）。</li>
</ul>
<hr>
<h2 id="11-7-移动窗⼝函数"><a href="#11-7-移动窗⼝函数" class="headerlink" title="11.7 移动窗⼝函数"></a>11.7 移动窗⼝函数</h2><p>什么是滑动(移动)窗口？</p>
<blockquote>
<p>为了提升数据的准确性，将某个点的取值扩大到包含这个点的一段区间，用区间来进行判断，这个区间就是窗口。</p>
</blockquote>
<p>例如想使用2011年1月1日的一个数据，单取这个时间点的数据当然是可行的，但是太过绝对，有没有更好的办法呢？可以选取2010年12月16日到2011年1月15日，通过求均值来评估1月1日这个点的值，2010-12-16到2011-1-15就是一个窗口，窗口的长度window=30. </p>
<p>移动窗口就是窗口向一端滑行，每次滑动(行)并不是区间整块的滑行，而是一个单位一个单位的滑行。例如窗口2010-12-16到2011-1-15，下一个窗口并不是2011-1-15到2011-2-15，而是<strong>2010-12-17到2011-1-16</strong>（假设数据的截取是以天为单位），==整体向右移动一个单位，而不是一个窗口==。这样统计的每个值始终都是30单位的均值。 窗口中的值从覆盖整个窗口的位置开始产生，在此之前即为NaN,举例如下：窗口大小为10，前9个都不足够为一个一个窗口的长度，因此都无法取值。</p>
<p>rolling函数返回的是<code>window对象</code>或<code>rolling子类</code>，可以<strong>通过调用该对象的mean(),sum(),std(),count()等函数计算返回窗口的值</strong>，还可以通过该对象的apply(func)函数，通过自定义函数计算窗口的特定的值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">df = pd.DataFrame(&#123;<span class="string">&#x27;B&#x27;</span>: [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, np.nan, <span class="number">4</span>]&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.0 = 0+1</span></span><br><span class="line"><span class="comment"># 3.0 = 1+2</span></span><br><span class="line"><span class="comment"># NaN = 2+NaN</span></span><br><span class="line"><span class="comment"># NaN = NaN+4</span></span><br><span class="line"><span class="built_in">print</span>(df.rolling(<span class="number">2</span>).<span class="built_in">sum</span>())</span><br><span class="line"><span class="comment">#      B</span></span><br><span class="line"><span class="comment"># 0  NaN</span></span><br><span class="line"><span class="comment"># 1  1.0</span></span><br><span class="line"><span class="comment"># 2  3.0</span></span><br><span class="line"><span class="comment"># 3  NaN</span></span><br><span class="line"><span class="comment"># 4  NaN</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">s = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">10</span>,<span class="number">12</span>,<span class="number">14</span>,<span class="number">12</span>,<span class="number">30</span>]</span><br><span class="line"><span class="built_in">print</span>(pd.Series(s))</span><br><span class="line"><span class="comment"># 0     1</span></span><br><span class="line"><span class="comment"># 1     2</span></span><br><span class="line"><span class="comment"># 2     3</span></span><br><span class="line"><span class="comment"># 3     5</span></span><br><span class="line"><span class="comment"># 4     6</span></span><br><span class="line"><span class="comment"># 5    10</span></span><br><span class="line"><span class="comment"># 6    12</span></span><br><span class="line"><span class="comment"># 7    14</span></span><br><span class="line"><span class="comment"># 8    12</span></span><br><span class="line"><span class="comment"># 9    30</span></span><br><span class="line"><span class="comment"># dtype: int64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(pd.Series(s).rolling(window=<span class="number">3</span>).mean())</span><br><span class="line"><span class="comment"># 0          NaN</span></span><br><span class="line"><span class="comment"># 1          NaN</span></span><br><span class="line"><span class="comment"># 2     2.000000</span></span><br><span class="line"><span class="comment"># 3     3.333333</span></span><br><span class="line"><span class="comment"># 4     4.666667</span></span><br><span class="line"><span class="comment"># 5     7.000000</span></span><br><span class="line"><span class="comment"># 6     9.333333</span></span><br><span class="line"><span class="comment"># 7    12.000000</span></span><br><span class="line"><span class="comment"># 8    12.666667</span></span><br><span class="line"><span class="comment"># 9    18.666667</span></span><br><span class="line"><span class="comment"># dtype: float64</span></span><br></pre></td></tr></table></figure>

<p>在移动窗口上计算的各种统计函数也是⼀类常⻅于时间序列的数组变换。这样可以圆滑噪⾳数据或断裂数据。这种函数称为<code>移动窗口函数</code>（moving windowfunction），其中还包括那些窗⼝不定⻓的函数（如指数加权移动平均）。跟其他统计函数⼀样，<strong>移动窗口函数也会自动排除缺失值</strong>。</p>
<p>rolling运算符，它与resample和groupby很像。可以在TimeSeries或DataFrame以及⼀个window上调⽤它：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt </span><br><span class="line"></span><br><span class="line">close_px_all = pd.read_csv(<span class="string">&#x27;examples/stock_px_2.csv&#x27;</span>,parse_dates=<span class="literal">True</span>, index_col=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(close_px_all.head())</span><br><span class="line"><span class="comment">#             AAPL   MSFT    XOM     SPX</span></span><br><span class="line"><span class="comment"># 2003-01-02  7.40  21.11  29.22  909.03</span></span><br><span class="line"><span class="comment"># 2003-01-03  7.45  21.14  29.24  908.59</span></span><br><span class="line"><span class="comment"># 2003-01-06  7.45  21.52  29.96  929.01</span></span><br><span class="line"><span class="comment"># 2003-01-07  7.43  21.93  28.95  922.93</span></span><br><span class="line"><span class="comment"># 2003-01-08  7.28  21.31  28.83  909.93</span></span><br><span class="line"></span><br><span class="line">close_px = close_px_all[[<span class="string">&#x27;AAPL&#x27;</span>, <span class="string">&#x27;MSFT&#x27;</span>, <span class="string">&#x27;XOM&#x27;</span>]]</span><br><span class="line"></span><br><span class="line">close_px = close_px.resample(<span class="string">&#x27;B&#x27;</span>).ffill()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(close_px.AAPL.plot())</span><br><span class="line"><span class="comment"># AxesSubplot(0.125,0.11;0.775x0.77)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用rolling</span></span><br><span class="line"><span class="built_in">print</span>(close_px.AAPL.rolling(<span class="number">250</span>).mean().plot())</span><br><span class="line"><span class="comment"># AxesSubplot(0.125,0.11;0.775x0.77)</span></span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="/images/Figure_10-1557749017217.png" alt="Figure_10"></p>
<p>表达式rolling(250)与groupby很像，但不是对其进⾏分组、<strong>创建⼀个按照250天分组的滑动窗⼝对象</strong>。然后，我们就得到了苹果公司股价的250天的移动窗⼝。</p>
<p><code>DataFrame.rolling(window, min_periods=None, center=False, win_type=None, on=None, axis=0, closed=None)</code></p>
<ul>
<li>min_periods参数:<br>最少需要有值的观测点的数量,就是说滑动窗口最少需要多少个非NaN的数字</li>
<li>center参数:<br>如果设为True，表示在取窗口覆盖的区间时，以当前label为中心，向两边取，若为False则表示以当前label为窗口的最右侧，向左侧取，默认为False.<br>要注意的是，当为True时，如果窗口长度为奇数，则中心位置很好确定，就是最中间的位置，但是如果长度为偶数，则默认中心位置为中间偏右的那一个位置</li>
<li>win_type参数:<br>表示不同的窗口类型，可以通过这个参数给窗口成员赋予不同的权重，默认为等权重</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt </span><br><span class="line"></span><br><span class="line">close_px_all = pd.read_csv(<span class="string">&#x27;examples/stock_px_2.csv&#x27;</span>,parse_dates=<span class="literal">True</span>, index_col=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(close_px_all.head())</span><br><span class="line"><span class="comment">#             AAPL   MSFT    XOM     SPX</span></span><br><span class="line"><span class="comment"># 2003-01-02  7.40  21.11  29.22  909.03</span></span><br><span class="line"><span class="comment"># 2003-01-03  7.45  21.14  29.24  908.59</span></span><br><span class="line"><span class="comment"># 2003-01-06  7.45  21.52  29.96  929.01</span></span><br><span class="line"><span class="comment"># 2003-01-07  7.43  21.93  28.95  922.93</span></span><br><span class="line"><span class="comment"># 2003-01-08  7.28  21.31  28.83  909.93</span></span><br><span class="line"></span><br><span class="line">close_px = close_px_all[[<span class="string">&#x27;AAPL&#x27;</span>, <span class="string">&#x27;MSFT&#x27;</span>, <span class="string">&#x27;XOM&#x27;</span>]]</span><br><span class="line"></span><br><span class="line">close_px = close_px.resample(<span class="string">&#x27;B&#x27;</span>).ffill()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># min_periods:最少需要有值的观测点的数量,就是说滑动窗口最少需要多少个非NaN的数字</span></span><br><span class="line">appl_std250 = close_px.AAPL.rolling(<span class="number">250</span>, min_periods=<span class="number">10</span>).std()</span><br><span class="line"><span class="built_in">print</span>(appl_std250[<span class="number">5</span>:<span class="number">12</span>])</span><br><span class="line"><span class="comment"># 2003-01-09         NaN</span></span><br><span class="line"><span class="comment"># 2003-01-10         NaN</span></span><br><span class="line"><span class="comment"># 2003-01-13         NaN</span></span><br><span class="line"><span class="comment"># 2003-01-14         NaN</span></span><br><span class="line"><span class="comment"># 2003-01-15    0.077496</span></span><br><span class="line"><span class="comment"># 2003-01-16    0.074760</span></span><br><span class="line"><span class="comment"># 2003-01-17    0.112368</span></span><br><span class="line"><span class="comment"># Freq: B, Name: AAPL, dtype: float64</span></span><br><span class="line"></span><br><span class="line">appl_std250.plot()</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="/images/Figure_12-1557750797961.png" alt="Figure_12"></p>
<p>rolling还可以接受一个指定固定⼤⼩时间补偿字符串作为一个窗口</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt </span><br><span class="line"></span><br><span class="line">close_px_all = pd.read_csv(<span class="string">&#x27;examples/stock_px_2.csv&#x27;</span>,parse_dates=<span class="literal">True</span>, index_col=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(close_px_all.head())</span><br><span class="line"><span class="comment">#             AAPL   MSFT    XOM     SPX</span></span><br><span class="line"><span class="comment"># 2003-01-02  7.40  21.11  29.22  909.03</span></span><br><span class="line"><span class="comment"># 2003-01-03  7.45  21.14  29.24  908.59</span></span><br><span class="line"><span class="comment"># 2003-01-06  7.45  21.52  29.96  929.01</span></span><br><span class="line"><span class="comment"># 2003-01-07  7.43  21.93  28.95  922.93</span></span><br><span class="line"><span class="comment"># 2003-01-08  7.28  21.31  28.83  909.93</span></span><br><span class="line"></span><br><span class="line">close_px = close_px_all[[<span class="string">&#x27;AAPL&#x27;</span>, <span class="string">&#x27;MSFT&#x27;</span>, <span class="string">&#x27;XOM&#x27;</span>]]</span><br><span class="line"></span><br><span class="line">close_px = close_px.resample(<span class="string">&#x27;B&#x27;</span>).ffill()</span><br><span class="line"></span><br><span class="line"><span class="comment"># rolling还可以接受一个指定固定⼤⼩时间补偿字符串作为一个窗口</span></span><br><span class="line"><span class="comment"># 计算计算20天的滚动均值</span></span><br><span class="line"><span class="built_in">print</span>(close_px.rolling(<span class="string">&#x27;20D&#x27;</span>).mean())</span><br><span class="line"><span class="comment">#                   AAPL       MSFT        XOM</span></span><br><span class="line"><span class="comment"># 2003-01-02    7.400000  21.110000  29.220000</span></span><br><span class="line"><span class="comment"># 2003-01-03    7.425000  21.125000  29.230000</span></span><br><span class="line"><span class="comment"># ...                ...        ...        ...</span></span><br><span class="line"><span class="comment"># 2011-10-13  388.826429  25.961429  73.905000</span></span><br><span class="line"><span class="comment"># 2011-10-14  391.038000  26.048667  74.185333</span></span><br><span class="line"><span class="comment"># [2292 rows x 3 columns]</span></span><br></pre></td></tr></table></figure>



<p>扩展窗口:</p>
<blockquote>
<p>“扩展”意味着，从时间序列的起始处开始窗口，<strong>增加窗口直到它超过所有的序列</strong>。</p>
</blockquote>
<p><code>DataFrame.expanding(min_periods=1, center=False, axis=0)</code><br>其中参数的意义和rolling一样，只是<strong>不是固定窗口长度，其长度是不断的扩大的</strong>。</p>
<p>rolling和expanding都是类似的，假设目的是查看股票市场价格随着时间的变化，不同的是rolling average算的是最近一个窗口期（比如说20天）的一个平均值，过了一天这个窗口又会向下滑动一天算20天的平均值；<strong>expanding的话，是从第一个值就开始累加地计算平均值</strong>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">df = pd.DataFrame(&#123;<span class="string">&#x27;B&#x27;</span>: [<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>]&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(df.rolling(<span class="number">2</span>).<span class="built_in">sum</span>())</span><br><span class="line"><span class="comment">#      B</span></span><br><span class="line"><span class="comment"># 0  NaN</span></span><br><span class="line"><span class="comment"># 1  2.0</span></span><br><span class="line"><span class="comment"># 2  2.0</span></span><br><span class="line"><span class="comment"># 3  2.0</span></span><br><span class="line"><span class="comment"># 4  2.0</span></span><br><span class="line"><span class="comment"># 5  2.0</span></span><br><span class="line"><span class="comment"># 6  2.0</span></span><br><span class="line"><span class="comment"># 7  2.0</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(df.expanding().<span class="built_in">sum</span>())</span><br><span class="line"><span class="comment">#      B</span></span><br><span class="line"><span class="comment"># 0  1.0</span></span><br><span class="line"><span class="comment"># 1  2.0</span></span><br><span class="line"><span class="comment"># 2  3.0</span></span><br><span class="line"><span class="comment"># 3  4.0</span></span><br><span class="line"><span class="comment"># 4  5.0</span></span><br><span class="line"><span class="comment"># 5  6.0</span></span><br><span class="line"><span class="comment"># 6  7.0</span></span><br><span class="line"><span class="comment"># 7  8.0</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(df.expanding(<span class="number">3</span>).<span class="built_in">sum</span>())</span><br><span class="line"><span class="comment">#      B</span></span><br><span class="line"><span class="comment"># 0  NaN</span></span><br><span class="line"><span class="comment"># 1  NaN</span></span><br><span class="line"><span class="comment"># 2  3.0</span></span><br><span class="line"><span class="comment"># 3  4.0</span></span><br><span class="line"><span class="comment"># 4  5.0</span></span><br><span class="line"><span class="comment"># 5  6.0</span></span><br><span class="line"><span class="comment"># 6  7.0</span></span><br><span class="line"><span class="comment"># 7  8.0</span></span><br></pre></td></tr></table></figure>



<p>指数加权函数</p>
<ul>
<li>rolling:简单移动</li>
<li>ewm:指数加权滑动</li>
</ul>
<p>指数加权函数<strong>会赋予近期的观测值更大的权数</strong>，因此，它能适应更快的变化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt </span><br><span class="line"></span><br><span class="line">close_px_all = pd.read_csv(<span class="string">&#x27;examples/stock_px_2.csv&#x27;</span>,parse_dates=<span class="literal">True</span>, index_col=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(close_px_all.head())</span><br><span class="line"><span class="comment">#             AAPL   MSFT    XOM     SPX</span></span><br><span class="line"><span class="comment"># 2003-01-02  7.40  21.11  29.22  909.03</span></span><br><span class="line"><span class="comment"># 2003-01-03  7.45  21.14  29.24  908.59</span></span><br><span class="line"><span class="comment"># 2003-01-06  7.45  21.52  29.96  929.01</span></span><br><span class="line"><span class="comment"># 2003-01-07  7.43  21.93  28.95  922.93</span></span><br><span class="line"><span class="comment"># 2003-01-08  7.28  21.31  28.83  909.93</span></span><br><span class="line"></span><br><span class="line">close_px = close_px_all[[<span class="string">&#x27;AAPL&#x27;</span>, <span class="string">&#x27;MSFT&#x27;</span>, <span class="string">&#x27;XOM&#x27;</span>]]</span><br><span class="line"></span><br><span class="line">close_px = close_px.resample(<span class="string">&#x27;B&#x27;</span>).ffill()</span><br><span class="line"></span><br><span class="line">aapl_px = close_px.AAPL[<span class="string">&#x27;2006&#x27;</span>:<span class="string">&#x27;2007&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ma60 = aapl_px.rolling(<span class="number">30</span>, min_periods=<span class="number">20</span>).mean()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加权指数函数</span></span><br><span class="line">ewma60 = aapl_px.ewm(span=<span class="number">30</span>).mean()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ma60.plot(style=<span class="string">&#x27;b--&#x27;</span>, label=<span class="string">&#x27;Simple MA&#x27;</span>)</span><br><span class="line">ewma60.plot(style=<span class="string">&#x27;r-&#x27;</span>, label=<span class="string">&#x27;EW MA&#x27;</span>)</span><br><span class="line">plt.legend()</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="/images/Figure_15.png" alt="Figure_15"></p>
<p>⼆元移动窗口函数</p>
<p>一些统计计算符，比如相关性和协方差，需要在两个时间序列上进行计算。<br>例如，经济分析通常喜欢比较一只股票与基础指数标普500之间的相关性</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt </span><br><span class="line"></span><br><span class="line">close_px_all = pd.read_csv(<span class="string">&#x27;examples/stock_px_2.csv&#x27;</span>,parse_dates=<span class="literal">True</span>, index_col=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(close_px_all.head())</span><br><span class="line"><span class="comment">#             AAPL   MSFT    XOM     SPX</span></span><br><span class="line"><span class="comment"># 2003-01-02  7.40  21.11  29.22  909.03</span></span><br><span class="line"><span class="comment"># 2003-01-03  7.45  21.14  29.24  908.59</span></span><br><span class="line"><span class="comment"># 2003-01-06  7.45  21.52  29.96  929.01</span></span><br><span class="line"><span class="comment"># 2003-01-07  7.43  21.93  28.95  922.93</span></span><br><span class="line"><span class="comment"># 2003-01-08  7.28  21.31  28.83  909.93</span></span><br><span class="line"></span><br><span class="line">close_px = close_px_all[[<span class="string">&#x27;AAPL&#x27;</span>, <span class="string">&#x27;MSFT&#x27;</span>, <span class="string">&#x27;XOM&#x27;</span>]]</span><br><span class="line">close_px = close_px.resample(<span class="string">&#x27;B&#x27;</span>).ffill()</span><br><span class="line"></span><br><span class="line">spx_px = close_px_all[<span class="string">&#x27;SPX&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(spx_px.head())</span><br><span class="line"><span class="comment"># 2003-01-02    909.03</span></span><br><span class="line"><span class="comment"># 2003-01-03    908.59</span></span><br><span class="line"><span class="comment"># 2003-01-06    929.01</span></span><br><span class="line"><span class="comment"># 2003-01-07    922.93</span></span><br><span class="line"><span class="comment"># 2003-01-08    909.93</span></span><br><span class="line"><span class="comment"># Name: SPX, dtype: float64</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(close_px.head())</span><br><span class="line"><span class="comment">#             AAPL   MSFT    XOM</span></span><br><span class="line"><span class="comment"># 2003-01-02  7.40  21.11  29.22</span></span><br><span class="line"><span class="comment"># 2003-01-03  7.45  21.14  29.24</span></span><br><span class="line"><span class="comment"># 2003-01-06  7.45  21.52  29.96</span></span><br><span class="line"><span class="comment"># 2003-01-07  7.43  21.93  28.95</span></span><br><span class="line"><span class="comment"># 2003-01-08  7.28  21.31  28.83</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># pct_change()函数。此函数将每个元素与其前一个元素进行比较，并计算变化百分比。</span></span><br><span class="line">spx_rets = spx_px.pct_change()</span><br><span class="line">returns = close_px.pct_change()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(spx_rets.head())</span><br><span class="line"><span class="comment"># 2003-01-02         NaN</span></span><br><span class="line"><span class="comment"># 2003-01-03   -0.000484</span></span><br><span class="line"><span class="comment"># 2003-01-06    0.022474</span></span><br><span class="line"><span class="comment"># 2003-01-07   -0.006545</span></span><br><span class="line"><span class="comment"># 2003-01-08   -0.014086</span></span><br><span class="line"><span class="comment"># Name: SPX, dtype: float64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(returns.head())</span><br><span class="line"><span class="comment">#                 AAPL      MSFT       XOM</span></span><br><span class="line"><span class="comment"># 2003-01-02       NaN       NaN       NaN</span></span><br><span class="line"><span class="comment"># 2003-01-03  0.006757  0.001421  0.000684</span></span><br><span class="line"><span class="comment"># 2003-01-06  0.000000  0.017975  0.024624</span></span><br><span class="line"><span class="comment"># 2003-01-07 -0.002685  0.019052 -0.033712</span></span><br><span class="line"><span class="comment"># 2003-01-08 -0.020188 -0.028272 -0.004145</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># corr聚合函数计算AAPL与spx_rets滚动相关系数</span></span><br><span class="line">corr = returns.AAPL.rolling(<span class="number">125</span>, min_periods=<span class="number">100</span>).corr(spx_rets)</span><br><span class="line"></span><br><span class="line">corr.plot()</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="/images/Figure_16.png" alt="Figure_16"></p>
<p>⽤户定义的移动窗口函数</p>
<p>通过<code>rolling().apply()</code>方法，可以在移动窗口上使用自己定义的函数。唯一需要满足的是，在数组的每一个片段上，<strong>函数必须产生单个值</strong>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt </span><br><span class="line"><span class="keyword">from</span> scipy.stats <span class="keyword">import</span> percentileofscore</span><br><span class="line"></span><br><span class="line">close_px_all = pd.read_csv(<span class="string">&#x27;examples/stock_px_2.csv&#x27;</span>,parse_dates=<span class="literal">True</span>, index_col=<span class="number">0</span>)</span><br><span class="line">close_px = close_px_all[[<span class="string">&#x27;AAPL&#x27;</span>, <span class="string">&#x27;MSFT&#x27;</span>, <span class="string">&#x27;XOM&#x27;</span>]].resample(<span class="string">&#x27;B&#x27;</span>).ffill()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(close_px.head())</span><br><span class="line"><span class="comment">#             AAPL   MSFT    XOM</span></span><br><span class="line"><span class="comment"># 2003-01-02  7.40  21.11  29.22</span></span><br><span class="line"><span class="comment"># 2003-01-03  7.45  21.14  29.24</span></span><br><span class="line"><span class="comment"># 2003-01-06  7.45  21.52  29.96</span></span><br><span class="line"><span class="comment"># 2003-01-07  7.43  21.93  28.95</span></span><br><span class="line"><span class="comment"># 2003-01-08  7.28  21.31  28.83</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># pct_change()函数。此函数将每个元素与其前一个元素进行比较，并计算变化百分比。</span></span><br><span class="line">returns = close_px.pct_change()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(returns.head())</span><br><span class="line"><span class="comment">#                 AAPL      MSFT       XOM</span></span><br><span class="line"><span class="comment"># 2003-01-02       NaN       NaN       NaN</span></span><br><span class="line"><span class="comment"># 2003-01-03  0.006757  0.001421  0.000684</span></span><br><span class="line"><span class="comment"># 2003-01-06  0.000000  0.017975  0.024624</span></span><br><span class="line"><span class="comment"># 2003-01-07 -0.002685  0.019052 -0.033712</span></span><br><span class="line"><span class="comment"># 2003-01-08 -0.020188 -0.028272 -0.004145</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义的函数</span></span><br><span class="line">score_at_2percent = <span class="keyword">lambda</span> x: percentileofscore(x, <span class="number">0.02</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># rolling().apply()</span></span><br><span class="line">result = returns.AAPL.rolling(<span class="number">250</span>).apply(score_at_2percent)</span><br><span class="line">result.plot()</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="/images/Figure_17.png" alt="Figure_17"></p>
</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>