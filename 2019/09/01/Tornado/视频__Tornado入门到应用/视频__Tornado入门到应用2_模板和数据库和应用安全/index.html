<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;模板&quot;&gt;&lt;a href=&quot;#模板&quot; class=&quot;headerlink&quot; title=&quot;模板&quot;&gt;&lt;/a&gt;模板&lt;/h1&gt;&lt;h2 id=&quot;走个流程&quot;&gt;&lt;a href=&quot;#走个流程&quot; class=&quot;headerlink&quot; title=&quot;走个流程&quot;&gt;&lt;/a&gt;走个流程&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;&lt;p&gt;配置模板路径"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>Tornado入门到应用2_模板和数据库和应用安全 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Tornado/" rel="tag">Tornado</a></div><div class="post-time">2019-09-01</div></div></div><div class="container post-header"><h1>Tornado入门到应用2_模板和数据库和应用安全</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.</span> <span class="toc-text">模板</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%B0%E4%B8%AA%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.</span> <span class="toc-text">走个流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%98%E9%87%8F%E4%B8%8E%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">1.2.</span> <span class="toc-text">变量与表达式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6"><span class="toc-number">1.3.</span> <span class="toc-text">流程控制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%BD%E6%95%B0"><span class="toc-number">1.4.</span> <span class="toc-text">函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#static-url"><span class="toc-number">1.4.1.</span> <span class="toc-text">static_url()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%87%BD%E6%95%B0"><span class="toc-number">1.4.2.</span> <span class="toc-text">自定义函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BD%AC%E4%B9%89"><span class="toc-number">1.5.</span> <span class="toc-text">转义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%A7%E6%89%BF"><span class="toc-number">1.6.</span> <span class="toc-text">继承</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6"><span class="toc-number">1.7.</span> <span class="toc-text">静态文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#static-url-1"><span class="toc-number">1.7.1.</span> <span class="toc-text">static_url()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#StaticFileHandler%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.7.2.</span> <span class="toc-text">StaticFileHandler对象</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">2.</span> <span class="toc-text">数据库</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%AE%89%E5%85%A8"><span class="toc-number">3.</span> <span class="toc-text">应用安全</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Cookies"><span class="toc-number">3.1.</span> <span class="toc-text">Cookies</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%99%AE%E9%80%9Acookies"><span class="toc-number">3.1.1.</span> <span class="toc-text">普通cookies</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E5%85%A8cookies"><span class="toc-number">3.1.2.</span> <span class="toc-text">安全cookies</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XSRF"><span class="toc-number">3.2.</span> <span class="toc-text">XSRF</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%A8%E7%AB%99%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0"><span class="toc-number">3.2.1.</span> <span class="toc-text">跨站请求伪造</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XSRF%E4%BF%9D%E6%8A%A4"><span class="toc-number">3.2.2.</span> <span class="toc-text">XSRF保护</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E9%AA%8C%E8%AF%81"><span class="toc-number">3.3.</span> <span class="toc-text">用户验证</span></a></li></ol></li></ol></details></div><div class="container post-content"><h1 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h1><h2 id="走个流程"><a href="#走个流程" class="headerlink" title="走个流程"></a>走个流程</h2><ol>
<li><p>配置模板路径</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">settings = &#123;</span><br><span class="line">	<span class="string">&#x27;static_path&#x27;</span>:os.path.join(BASE_DIRS,<span class="string">&#x27;static&#x27;</span>),</span><br><span class="line">	<span class="string">&#x27;template_path&#x27;</span>:os.path.join(BASE_DIRS,<span class="string">&#x27;templates&#x27;</span>),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>模板为</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123; static_url(&#x27;css/style.css&#x27;) &#125;&#125;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;&#123; num &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>使用<code>self.render</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestHandler5</span>(<span class="params">tornado.web.RequestHandler</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,*args,**kwargs</span>):</span></span><br><span class="line">        context = &#123;</span><br><span class="line">            <span class="string">&#x27;num&#x27;</span>:<span class="number">55</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        self.render(<span class="string">&#x27;index2.html&#x27;</span>,**context)</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="变量与表达式"><a href="#变量与表达式" class="headerlink" title="变量与表达式"></a>变量与表达式</h2><ul>
<li><p>变量 : <code>&#123;&#123; var &#125;&#125;</code></p>
</li>
<li><p>tornado模板系统更为强大 , 支持表达式<code>&#123;&#123; expression &#125;&#125;</code></p>
<ul>
<li><code>&#123;&#123; num +10 &#125;&#125;</code></li>
<li><code>&#123;&#123; num==200 &#125;&#125;</code></li>
</ul>
</li>
<li><p>这就造成了在tornado中,<strong>不能使用Django中的点号语法</strong>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestHandler5</span>(<span class="params">tornado.web.RequestHandler</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,*args,**kwargs</span>):</span></span><br><span class="line">        context = &#123;</span><br><span class="line">            <span class="string">&#x27;num&#x27;</span>:<span class="number">55</span>,</span><br><span class="line">            <span class="string">&#x27;d&#x27;</span>:&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;hyl&#x27;</span>&#125;,</span><br><span class="line">        &#125;</span><br><span class="line">        self.render(<span class="string">&#x27;index2.html&#x27;</span>,**context)</span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">a</span>&gt;</span></span><span class="template-variable">&#123;&#123; d &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="comment">&#123;# 使用字典的索引 #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">a</span>&gt;</span></span><span class="template-variable">&#123;&#123; d[&#x27;name&#x27;] &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>在jango中是</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">a</span>&gt;</span></span><span class="template-variable">&#123;&#123; d &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="comment">&#123;# 使用点号索引 #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">a</span>&gt;</span></span><span class="template-variable">&#123;&#123; d.name &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br></pre></td></tr></table></figure></blockquote>
</li>
</ul>
<h2 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h2><ul>
<li><p>if</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-variable">&#123;&#123;% if 表达式 %&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">语句</span></span><br><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123;% elif 表达式 %&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">语句</span></span><br><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123;% end %&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Django是<code>&#123;&#123;% endif %&#125;&#125;</code></p>
</blockquote>
</li>
<li><p>for</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-variable">&#123;&#123;% for 变量 in 集合 %&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">语句</span></span><br><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123;% end %&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Django是<code>&#123;&#123;% endfor %&#125;&#125;</code></p>
</blockquote>
</li>
<li><p>while</p>
</li>
</ul>
<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><h3 id="static-url"><a href="#static-url" class="headerlink" title="static_url()"></a>static_url()</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">settings = &#123;</span><br><span class="line">	<span class="string">&#x27;static_path&#x27;</span>:os.path.join(BASE_DIRS,<span class="string">&#x27;static&#x27;</span>),</span><br><span class="line">	<span class="string">&#x27;template_path&#x27;</span>:os.path.join(BASE_DIRS,<span class="string">&#x27;templates&#x27;</span>),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; static_url(&#x27;css/style.css&#x27;) &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">li</span>&gt;</span></span><span class="template-variable">&#123;&#123; num &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>static_url创建了一个基于文件内容的hash值，并将其添加到URL末尾当一个查词参数</li>
<li>这个hash值总能保证加载的都是最新的文件，而不是以前的缓存版本，</li>
<li>不论是开发阶段还是上线阶段都是很有必要的</li>
</ul>
</blockquote>
<h3 id="自定义函数"><a href="#自定义函数" class="headerlink" title="自定义函数"></a>自定义函数</h3><p>在Handler里面定义函数 , 然后将其传给模板</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestHandler5</span>(<span class="params">tornado.web.RequestHandler</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">mysum</span>(<span class="params">a,b</span>):</span></span><br><span class="line">            <span class="keyword">return</span> a+b</span><br><span class="line">        </span><br><span class="line">        context = &#123;</span><br><span class="line">            <span class="string">&#x27;mysum&#x27;</span>:mysum,</span><br><span class="line">        &#125;</span><br><span class="line">        self.render(<span class="string">&#x27;index2.html&#x27;</span>,**context)</span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">li</span>&gt;</span></span><span class="template-variable">&#123;&#123; mysum(100,2) &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br></pre></td></tr></table></figure>



<h2 id="转义"><a href="#转义" class="headerlink" title="转义"></a>转义</h2><ul>
<li><p> tornado默认开启了自动转义功能，能防止网站受到恶意攻击</p>
</li>
<li><p>关闭转义:</p>
<ul>
<li><p>raw标签 : 单次关闭 <code>&#123;&#123;% raw data %&#125;&#125;</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestHandler8</span>(<span class="params">tornado.web.RequestHandler</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,*args,**kwargs</span>):</span></span><br><span class="line">        context = &#123;</span><br><span class="line">            <span class="string">&#x27;data&#x27;</span>:<span class="string">&#x27;&lt;a&gt;a标签&lt;/a&gt;&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> self.render(<span class="string">&#x27;index2.html&#x27;</span>,**context)</span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">li</span>&gt;</span></span><span class="template-tag">&#123;% <span class="name">raw</span> data %&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br></pre></td></tr></table></figure></li>
<li><p>autoescape标签 : 关闭当前模板<code>&#123;% autoescape None %&#125;</code></p>
</li>
<li><p>在配置中设置: 关闭全部模板</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">settings = &#123;</span><br><span class="line">	<span class="string">&#x27;autoescape&#x27;</span> : <span class="literal">None</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>escape()函数</strong> : 在关闭自动转义后，可以使用该方法刘特定的变量进行转义</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">autoescape</span></span> None %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123; data &#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="comment">&lt;!-- 转义 --&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123; escape(data) &#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-variable">&#123;&#123; data &#125;&#125;</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h2><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="comment">&lt;!-- base.html --&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="comment">&lt;!-- 挖坑 --&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> main %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">end</span> %&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">extends</span></span> &#x27;base.html&#x27; %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="comment">&lt;!-- 填坑 --&gt;</span></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> main %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"></span><span class="template-tag">&#123;% <span class="name">end</span> %&#125;</span></span><br></pre></td></tr></table></figure>



<h2 id="静态文件"><a href="#静态文件" class="headerlink" title="静态文件"></a>静态文件</h2><h3 id="static-url-1"><a href="#static-url-1" class="headerlink" title="static_url()"></a>static_url()</h3><ul>
<li><p>作用 : 告诉 tornado从文件系统中的某一个特定的位置提供静态文件 : <code>&#39;static_path&#39;:os.path.join(BASE_DIRS,&#39;static&#39;),</code></p>
</li>
<li><p>一般我们的static文件下的子文件夹为<code>css</code>,<code>js</code>,<code>img</code> . 有可能还有<code>html</code>页面 . 也就是说,我们<strong>可以直接访问这个html页面资源</strong></p>
<blockquote>
<ul>
<li>访问<code>www.baidu.com/index.html</code> 返回百度首页 , 此时并不是使用url的重定向 , 而是直接访问<code>index.html</code>这个文件</li>
<li>就像我们使用<code>&#123;% static css/style.css %&#125;</code>一样,获取<code>&#123;% static html/index.html %&#125;</code></li>
<li>一般这种html都是<code>静态</code>的 , 意思就是这个html不含有<code>&#123;&#123; var &#125;&#125;</code> ,<code>&#123;% if... %&#125;</code>等变量或标签</li>
</ul>
</blockquote>
<blockquote>
<p>也就是说说 ,当前的staic文件夹如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">static</span><br><span class="line">	├─js</span><br><span class="line">	├─img</span><br><span class="line">	├─css</span><br><span class="line">	└─html</span><br><span class="line">		└─index.html</span><br></pre></td></tr></table></figure>

<p>通过<code>http://127.0.0.1:8000/static/html/index.html</code>来直接访问index.html这个页面</p>
</blockquote>
</li>
<li><p>但是<code>http://127.0.0.1:8000/static/html/index.html</code>层次过深 , 我们希望改为<code>http://127.0.0.1:8000/index.html</code> . 此时就需要使用到<code>StaticFileHandler</code>对象</p>
</li>
</ul>
<h3 id="StaticFileHandler对象"><a href="#StaticFileHandler对象" class="headerlink" title="StaticFileHandler对象"></a>StaticFileHandler对象</h3><ul>
<li><p>使用原因 : <code>http://127.0.0.1:8000/static/html/index.html</code>对于用户来说体验不佳</p>
</li>
<li><p>本质 : tornado预制的用来提供静态资文件的 handler</p>
</li>
<li><p>作用 : <strong>通过<code>tornado.web.StaticFileHandler</code>来映射静态文件</strong></p>
</li>
<li><p>使用 :<br>只要在路由里添加:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意在最后添加此路由</span></span><br><span class="line"><span class="comment"># path为文件查找的路径</span></span><br><span class="line"><span class="comment"># default_filename为默认寻找的文件</span></span><br><span class="line">(<span class="string">r&#x27;/(.*)$&#x27;</span>,tornado.web.StaticFileHandler,&#123;<span class="string">&#x27;path&#x27;</span>:os.path.join(config.BASE_DIRS,<span class="string">&#x27;static/html&#x27;</span>)&#125;,<span class="string">&#x27;default_filename&#x27;</span>:<span class="string">&#x27;index.html&#x27;</span>),</span><br></pre></td></tr></table></figure>

<p>然后在static/html添加<code>index.html</code>,<code>main.html</code>等等 ,当用户访问<code>http://127.0.0.1:8000/index.html</code>,<code>http://127.0.0.1:8000/main.html</code>的时候就可以直接映射寻找文件了</p>
<blockquote>
<ul>
<li>path : 用来指定提供静态文件的根路径</li>
<li>default_filename : 用来指定访同路由中末指明文件名时，默认提供的静态文件</li>
</ul>
</blockquote>
</li>
</ul>
<h1 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h1><p>tornado没有自带的ORM，对于数据库需要自己去适配</p>
<blockquote>
<ol>
<li><strong>类似于aiohttp</strong> , 在应用启动时创建一个数据库链接实例，供各个 RequestHandler 使用</li>
<li>在 RequestHandler 中通过 <code>self.application</code>来获取其应用对象<br>(如 : <code>self.application.db</code>)</li>
</ol>
</blockquote>
<h1 id="应用安全"><a href="#应用安全" class="headerlink" title="应用安全"></a>应用安全</h1><h2 id="Cookies"><a href="#Cookies" class="headerlink" title="Cookies"></a>Cookies</h2><h3 id="普通cookies"><a href="#普通cookies" class="headerlink" title="普通cookies"></a>普通cookies</h3><ul>
<li><p>设置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.set_cookie(name,value,domain=<span class="literal">None</span>,expires=<span class="literal">None</span>,path=<span class="string">&#x27;/&#x27;</span>,expries_days=<span class="literal">None</span>,**kwargs)</span><br></pre></td></tr></table></figure>

<ul>
<li>domain : 提交cookie时匹配的域名</li>
<li>path : 提交cookie是匹配的路径</li>
<li>expires : 有效期,可以是时间戳 , 时间元组 , datetime</li>
<li>expries_days : 有效期天数 , 优先级低于expires </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestHandler9</span>(<span class="params">tornado.web.RequestHandler</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,*args,**kwargs</span>):</span></span><br><span class="line">        self.set_cookie(<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;hyl&#x27;</span>,expires=<span class="number">60</span>*<span class="number">60</span>*<span class="number">24</span>)</span><br><span class="line">        self.write(<span class="string">&#x27;hello&#x27;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>设置cookie实际上就是<strong>设置header的set_cookie字段</strong></li>
<li>可以这么写 :</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.set_header(<span class="string">&#x27;Set-Cookie&#x27;</span>,<span class="string">&#x27;name=hyl; Path=/&#x27;</span>)</span><br></pre></td></tr></table></figure></blockquote>
</li>
<li><p>获取</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestHandler9</span>(<span class="params">tornado.web.RequestHandler</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="comment"># &#x27;未登录&#x27;是default,当不存在时被赋值</span></span><br><span class="line">        self.get_cookie(<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;未登录&#x27;</span>)</span><br><span class="line">        self.write(<span class="string">&#x27;hello&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>清除:</p>
<ul>
<li>clear_cookie()</li>
<li>clear_all_cookie()</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestHandler9</span>(<span class="params">tornado.web.RequestHandler</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,*args,**kwargs</span>):</span></span><br><span class="line">        self.clear_cookie(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">        self.write(<span class="string">&#x27;hello&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>删除名为name，井同时匹配 domain 和 path 的 cookie</p>
<blockquote>
<ul>
<li>执行清除 Cookie操作后，并不是立即删除浏器的cookie，而是给 cookie 值设置空，并改其有限期限为失效，</li>
<li>真正删除cookie是由浏克器白己去清理的</li>
</ul>
</blockquote>
</li>
</ul>
<h3 id="安全cookies"><a href="#安全cookies" class="headerlink" title="安全cookies"></a>安全cookies</h3><ul>
<li><p>Cookie是存在客户浏览需的数据，很容易被篡改，<strong>Tornado提供了一种对 Cockie进行简易加密方式，来防止Cookie被篡改</strong></p>
</li>
<li><p>设置 : </p>
<ol>
<li><p>需要为应用配置一个用来给 Cookie进行混清加密的秘钥</p>
<p>生成密钥</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="built_in">print</span>(base64.b64encode(uuid.uuid4().<span class="built_in">bytes</span> + uuid.uuid4().<span class="built_in">bytes</span>))</span><br><span class="line"><span class="comment"># &#x27;fq/tqtjCRGG9kIAOtu2QQp0MbOtQ8kxdnYsS8lLQZlg=&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li><p>将密钥放入cookie_secret</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># config.py</span></span><br><span class="line">settings = &#123;</span><br><span class="line">	<span class="string">&#x27;debug&#x27;</span> : <span class="literal">True</span>,</span><br><span class="line">	<span class="string">&#x27;cookie_secret&#x27;</span>:<span class="string">&#x27;fq/tqtjCRGG9kIAOtu2QQp0MbOtQ8kxdnYsS8lLQZlg=&#x27;</span></span><br><span class="line">	<span class="string">&#x27;static_path&#x27;</span>:os.path.join(BASE_DIRS,<span class="string">&#x27;static&#x27;</span>),</span><br><span class="line">	<span class="string">&#x27;template_path&#x27;</span>:os.path.join(BASE_DIRS,<span class="string">&#x27;templates&#x27;</span>),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>set_secure_cookie</code> : 设置一个带有签名和时间的 cookie，防止cookie被伪造</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.set_secure_cookie(name,value,expires_day=<span class="number">30</span>,version=<span class="literal">None</span>,**kwargs)</span><br></pre></td></tr></table></figure></li>
<li><p>示例:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestHandler9</span>(<span class="params">tornado.web.RequestHandler</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,*args,**kwargs</span>):</span></span><br><span class="line">        self.set_secure_cookie(<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;hyl&#x27;</span>)</span><br><span class="line">        self.write(<span class="string">&#x27;hello&#x27;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>对比<code>self.set_secure_cookie(&#39;name&#39;,&#39;hyl&#39;)</code> 和<code>self.set_cookie(&#39;name&#39;,&#39;hyl&#39;)</code>:</p>
<p>后者明文显示<code>&#123;name : hyl&#125;</code> , 前者cookie值被加密:<code>&#123;name : 2|1:0|10:1567322102|4:name|4:aHls|c148ef76d7172335b55b52d0aaa0e00652be9ab8f57fba8a5679e9fb2735e1aa&#125;</code></p>
<ul>
<li>第一个字符 <code>2</code> : 安全cookie的版本，默认使用版本2</li>
<li><code>1:0</code> : 1表示冒号后面有多少位</li>
<li><code>10:1567322102</code> : 冒号后面是时间戳</li>
<li><code>4:name</code> : cookies名</li>
<li><code>4:aHls</code> : base64编码的cookies值</li>
<li>最后是签名值,不带长度说明</li>
</ul>
</blockquote>
</li>
</ol>
</li>
<li><p>获取:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.get_secure_cookie(name,value=<span class="literal">None</span>,max_age_days=<span class="number">31</span>,min_version=<span class="literal">None</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestHandler9</span>(<span class="params">tornado.web.RequestHandler</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,*args,**kwargs</span>):</span></span><br><span class="line">        name = self.get_secure_cookie(<span class="string">&#x27;name&#x27;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>max_age_days</code> 不同于 <code>expires_days</code> :</p>
<ul>
<li><code>expires_days</code> : 设置浏览器中cookie的有效时间</li>
<li><code>max_age_days</code> : 是<strong>过滤安全cookie的时间戳</strong></li>
</ul>
</blockquote>
</li>
</ul>
<h2 id="XSRF"><a href="#XSRF" class="headerlink" title="XSRF"></a>XSRF</h2><h3 id="跨站请求伪造"><a href="#跨站请求伪造" class="headerlink" title="跨站请求伪造"></a>跨站请求伪造</h3><ul>
<li><p>cookie计数 : 通过对cookie计数获取<code>用户请求次数</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestHandler9</span>(<span class="params">tornado.web.RequestHandler</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,*args,**kwargs</span>):</span></span><br><span class="line">        count = <span class="built_in">str</span>(<span class="built_in">int</span>(self.get_cookie(<span class="string">&#x27;count&#x27;</span>,<span class="number">0</span>)) + <span class="number">1</span>)</span><br><span class="line">        self.set_cookie(<span class="string">&#x27;count&#x27;</span>,count)</span><br><span class="line">        self.write(count)</span><br></pre></td></tr></table></figure>

<p>一般上面的操作到放在了<code>prepare()</code>方法里:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestHandler9</span>(<span class="params">tornado.web.RequestHandler</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">prepare</span>(<span class="params">self</span>):</span></span><br><span class="line">        count = <span class="built_in">str</span>(<span class="built_in">int</span>(self.get_cookie(<span class="string">&#x27;count&#x27;</span>,<span class="number">0</span>)) + <span class="number">1</span>)</span><br><span class="line">        self.set_cookie(<span class="string">&#x27;count&#x27;</span>,count)</span><br><span class="line">        self.count = count</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,*args,**kwargs</span>):</span></span><br><span class="line">        self.write(self.count)</span><br></pre></td></tr></table></figure></li>
<li><p>上面这种cookie操作很容易被伪造请求.</p>
<blockquote>
<p>原因 : 上面我们使用的是get请求.</p>
<p>所以我们一般使用post请求来传递重要数据</p>
</blockquote>
</li>
</ul>
<h3 id="XSRF保护"><a href="#XSRF保护" class="headerlink" title="XSRF保护"></a>XSRF保护</h3><ul>
<li><p>本质 : 同源策略</p>
</li>
<li><p>使用流程 :</p>
<ol>
<li><p>开启<code>xsrf_cookies</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">settings = &#123;</span><br><span class="line">	<span class="string">&#x27;debug&#x27;</span> : <span class="literal">True</span>,</span><br><span class="line">	<span class="string">&#x27;cookie_secret&#x27;</span>:<span class="string">&#x27;fq/tqtjCRGG9kIAOtu2QQp0MbOtQ8kxdnYsS8lLQZlg=&#x27;</span>,</span><br><span class="line">	<span class="comment"># 开启保护</span></span><br><span class="line">	<span class="string">&#x27;xsrf_cookies&#x27;</span>:<span class="literal">True</span>,</span><br><span class="line">	<span class="string">&#x27;static_path&#x27;</span>:os.path.join(BASE_DIRS,<span class="string">&#x27;static&#x27;</span>),</span><br><span class="line">	<span class="string">&#x27;template_path&#x27;</span>:os.path.join(BASE_DIRS,<span class="string">&#x27;templates&#x27;</span>),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>在 post 中设置cookies</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestHandler9</span>(<span class="params">tornado.web.RequestHandler</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.render(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self,*args,**kwargs</span>):</span></span><br><span class="line">        count = <span class="built_in">str</span>(<span class="built_in">int</span>(self.get_cookie(<span class="string">&#x27;count&#x27;</span>,<span class="number">0</span>)) + <span class="number">1</span>)</span><br><span class="line">        self.set_cookie(<span class="string">&#x27;count&#x27;</span>,count)</span><br><span class="line">        self.write(count)</span><br></pre></td></tr></table></figure></li>
<li><p>在模板中使用取消xsrf , <code>&#123;% module xsrf_form_html() %&#125;</code></p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#123;# index.html #&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/test9&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;% <span class="name">module</span> xsrf_form_html() %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span>/&gt;</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>在django中使用<code>&#123;% csrf_token %&#125;</code></li>
<li>在tornado中使用<code> &#123;% module xsrf_form_html() %&#125;</code></li>
</ul>
</blockquote>
<blockquote>
<p>注意 : </p>
<ul>
<li>使用XSRF保护必须同时设置<code>xsrf_cookies</code>和<code>cookie_secret</code></li>
<li>Django是因为已经默认帮我们在settings里设置好了 , 名字为<code>secret_key</code></li>
</ul>
</blockquote>
</li>
</ol>
</li>
<li><p><code>&#123;% module xsrf_form_html() %&#125;</code>的本质 :</p>
<p><strong>就是最主流了防止CSRF功能手段</strong></p>
<ul>
<li><p>为浏览器设置<code>_xsrf</code>的安全cookies , 这个cookies 在关闭浏览器后会失效</p>
</li>
<li><p>同时添加了隐藏的表单域</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;_xsrf&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2|cd737260|f175d50f1fc88fa839f2d92205a200e3|1567326465&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>在Ajax中使用:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    <span class="attr">url</span>:<span class="string">&#x27;/postfile&#x27;</span></span><br><span class="line">    <span class="attr">method</span>:<span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">    <span class="attr">data</span>:...,</span><br><span class="line">    <span class="attr">success</span>:<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    alert(<span class="string">&#x27;ok&#x27;</span>)</span><br><span class="line">&#125;,</span><br><span class="line">    headers;&#123;</span><br><span class="line">        <span class="string">&#x27;X-XSRFToken&#x27;</span>:getCookie(<span class="string">&#x27;_xsrf&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li>
<li><p>在StaticFileHandler中使用:</p>
<p>需要自动添加<code>_xsrf</code>的cookies</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StaticFileHandle</span>(<span class="params">tornado.web.StaticFileHandler</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 添加token</span></span><br><span class="line">        self.xsrf_token</span><br><span class="line">        <span class="built_in">super</span>().__init__(*args,**kwargs)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 路由</span></span><br><span class="line">(<span class="string">r&#x27;/(.*)$&#x27;</span>,index.StaticFileHandler,&#123;<span class="string">&#x27;path&#x27;</span>:os.path.join(config.BASE_DIRS,<span class="string">&#x27;static/html&#x27;</span>,<span class="string">&#x27;default_filename&#x27;</span>:<span class="string">&#x27;index.html&#x27;</span>)&#125;)</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="用户验证"><a href="#用户验证" class="headerlink" title="用户验证"></a>用户验证</h2><ul>
<li><p>指在收到用户请求后进行预先判断用户的认证状态是否登录），若验证通过则正常处理，否则进入到登录界面</p>
</li>
<li><p>使用<code>tornado.web.anthenticated装饰器</code> :<br>Tornade将确保这个方法的主体只有合法的用户才能调用</p>
</li>
<li><p>使用:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginHandler</span>(<span class="params">RequestHandler</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gt</span>(<span class="params">self,*args,**kwargs</span>):</span></span><br><span class="line">        self.render(RequestHandler)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeHandler</span>(<span class="params">RequestHandler</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_current_user</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"><span class="meta">    @tornado.web.authenticated</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,*args,**kwargs</span>):</span></span><br><span class="line">        self.render(<span class="string">&#x27;home.html&#x27;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li><p><code>@tornado.web.authenticated</code>装饰器会调用<code>get_current_user()</code>方法</p>
</li>
<li><p>验证用户的逻辑应该写在<code>get_current_user()</code>方法中，如果该方法返回的为True说明验证成功，否则验证失败</p>
</li>
<li><p>验证失败请求会重定向到配置中的<code>login_url</code>所指定的路由</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">settings = &#123;</span><br><span class="line">	<span class="string">&#x27;debug&#x27;</span> : <span class="literal">True</span>,</span><br><span class="line">	<span class="string">&#x27;cookie_secret&#x27;</span>:<span class="string">&#x27;fq/tqtjCRGG9kIAOtu2QQp0MbOtQ8kxdnYsS8lLQZlg=&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;xsrf_cookies&#x27;</span>:<span class="literal">True</span>,</span><br><span class="line">	<span class="string">&#x27;login_url&#x27;</span>:<span class="string">&#x27;/login&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;static_path&#x27;</span>:os.path.join(BASE_DIRS,<span class="string">&#x27;static&#x27;</span>),</span><br><span class="line">	<span class="string">&#x27;template_path&#x27;</span>:os.path.join(BASE_DIRS,<span class="string">&#x27;templates&#x27;</span>),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</blockquote>
</li>
</ul>
</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>