<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="ORM 是英文 Object Relational Mapping 的缩写，意为对象关系映射。"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>SQLAlchemy基础教程 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Python/" rel="tag">Python</a></div><div class="post-time">2019-07-22</div></div></div><div class="container post-header"><h1>SQLAlchemy基础教程</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%B0%E4%B8%AA%E6%B5%81%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">走个流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%BC%95%E6%93%8E-%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">2.</span> <span class="toc-text">创建引擎(连接数据库)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%A1%A8%E7%BB%93%E6%9E%84"><span class="toc-number">3.</span> <span class="toc-text">创建表结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Session"><span class="toc-number">4.</span> <span class="toc-text">Session</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#session-add-%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-number">4.1.</span> <span class="toc-text">session.add 插入数据</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E6%8F%92%E5%85%A5"><span class="toc-number">4.1.1.</span> <span class="toc-text">简单插入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%92%E5%85%A5%E4%B8%80%E5%AF%B9%E5%A4%9A"><span class="toc-number">4.1.2.</span> <span class="toc-text">插入一对多</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%92%E5%85%A5%E5%A4%9A%E5%AF%B9%E5%A4%9A"><span class="toc-number">4.1.3.</span> <span class="toc-text">插入多对多</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#session-query-filter-%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE"><span class="toc-number">4.2.</span> <span class="toc-text">session.query.filter 查询数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#session-delete-%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE"><span class="toc-number">4.3.</span> <span class="toc-text">session.delete 删除数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#session-update-%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE"><span class="toc-number">4.4.</span> <span class="toc-text">session.update 更新数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#session-rollback-%E4%BA%8B%E5%8A%A1%E5%9B%9E%E6%BB%9A"><span class="toc-number">4.5.</span> <span class="toc-text">session.rollback 事务回滚</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E7%9A%84%E8%BF%87%E6%BB%A4%E6%93%8D%E4%BD%9C"><span class="toc-number">4.6.</span> <span class="toc-text">常用的过滤操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%BB%84-%E8%AE%A1%E6%95%B0-%E6%8E%92%E5%BA%8F-%E9%99%90%E5%88%B6"><span class="toc-number">4.7.</span> <span class="toc-text">分组,计数,排序,限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B5%8C%E5%85%A5%E4%BD%BF%E7%94%A8SQL"><span class="toc-number">4.8.</span> <span class="toc-text">嵌入使用SQL</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Relationship-%E5%85%B3%E7%B3%BB%E5%AE%9A%E4%B9%89"><span class="toc-number">5.</span> <span class="toc-text">Relationship(关系定义)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E5%AF%B9%E5%A4%9A"><span class="toc-number">5.1.</span> <span class="toc-text">一对多</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E5%AF%B9%E4%B8%80"><span class="toc-number">5.2.</span> <span class="toc-text">一对一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E5%AF%B9%E5%A4%9A"><span class="toc-number">5.3.</span> <span class="toc-text">多对多</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E7%B3%BB%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.</span> <span class="toc-text">关系查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%96%E9%94%AE%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.1.</span> <span class="toc-text">外键查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8join%E8%BF%9B%E8%A1%8C%E6%9F%A5%E8%AF%A2"><span class="toc-number">6.2.</span> <span class="toc-text">使用join进行查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Aliases"><span class="toc-number">6.3.</span> <span class="toc-text">使用Aliases</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%AD%90%E6%9F%A5%E8%AF%A2-Subqueries"><span class="toc-number">6.4.</span> <span class="toc-text">使用子查询(Subqueries)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8EXISTS"><span class="toc-number">6.5.</span> <span class="toc-text">使用EXISTS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93"><span class="toc-number">7.</span> <span class="toc-text">问题总结</span></a></li></ol></details></div><div class="container post-content"><p>ORM 是英文 Object Relational Mapping 的缩写，意为对象关系映射。</p>
<p>在SQLAlchemy中，所有数据库都是使用引擎(engine)进行链接，引擎将链接不同数据库的差异磨平，让你可以非常快速的进行数据的链接。</p>
<p>SQLAlchemy涉及概念:</p>
<table>
<thead>
<tr>
<th>概念</th>
<th>对应数据库</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Engine</td>
<td>连接</td>
<td></td>
</tr>
<tr>
<td>Session</td>
<td>连接池,事务</td>
<td>查询</td>
</tr>
<tr>
<td>Model</td>
<td>表</td>
<td>类定义和表定义类似,类实例本质上就是其中一行</td>
</tr>
<tr>
<td>Column</td>
<td>列</td>
<td>在各个地方支持运算符操作</td>
</tr>
<tr>
<td>Query</td>
<td>若干行</td>
<td>可以链式操作<br />添加条件:<br />1.查展开成SELECT<br />2.删除展开成DELETE <br />3.修改展开成UPDATE</td>
</tr>
</tbody></table>
<blockquote>
<p>session(会话)的概念，可以看成一个管理数据库持久连接的对象,在此下面是完全透明的连接池和事务等东西</p>
</blockquote>
<h2 id="走个流程"><a href="#走个流程" class="headerlink" title="走个流程"></a>走个流程</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Table, MetaData, Column, Integer, String</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> mapper, sessionmaker</span><br><span class="line"></span><br><span class="line">pymysql.install_as_MySQLdb()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建实例，并连接test库</span></span><br><span class="line">engine = create_engine(<span class="string">&#x27;mysql://root:5KVp2y7,k96o@localhost/testlalchemy?charset=utf8&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>, echo=<span class="literal">True</span>) <span class="comment"># echo=False 显示信息</span></span><br><span class="line">Base = declarative_base()  <span class="comment"># 生成orm基类</span></span><br><span class="line">metadata = MetaData()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;user&#x27;</span>  <span class="comment"># 表名</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">32</span>))</span><br><span class="line">    password = Column(String(<span class="number">64</span>))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 创建与数据库的会话session class ,注意,这里sessionmaker返回给session的是个class,不是实例</span></span><br><span class="line">        self.session_class = sessionmaker(bind=engine)  <span class="comment"># 实例和engine绑定</span></span><br><span class="line">        self.session = self.session_class()  <span class="comment"># 生成session实例，相当于游标</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建表</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_user</span>(<span class="params">self</span>):</span></span><br><span class="line">        Base.metadata.create_all(engine)  <span class="comment"># 创建表结构 （这里是父类调子类）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 新增数据</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">insert_user</span>(<span class="params">self, user</span>):</span></span><br><span class="line">        self.session.add(use)  <span class="comment"># 把要创建的数据对象添加到这个session里， 一会统一创建</span></span><br><span class="line">        <span class="keyword">return</span> self.session.commit()  <span class="comment"># 现此才统一提交，创建数据</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 根据一个字段查询</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sel_user</span>(<span class="params">self</span>):</span></span><br><span class="line">        my_user = self.session.query(User).filter_by(name=<span class="string">&quot;12&quot;</span>).first()  <span class="comment"># 查询</span></span><br><span class="line">        <span class="keyword">return</span> my_user</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    ----------------     条件查询    ----------------</span></span><br><span class="line"><span class="string">        my_user1 = self.session.query(User).filter(User.id &gt; 2).all()</span></span><br><span class="line"><span class="string">        my_user2 = self.session.query(User).filter_by(id=27).all()  # filter_by相等用‘=’</span></span><br><span class="line"><span class="string">        my_user3 = self.session.query(User).filter(User.id == 27).all()  # filter相等用‘==’</span></span><br><span class="line"><span class="string">    ----------------     多条件查询  ----------------</span></span><br><span class="line"><span class="string">        objs = self.session.query(User).filter(User.id&gt;0).filter(User.id&lt;7).all()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    --------------     模糊查询，返回count    ------------</span></span><br><span class="line"><span class="string">        self.session.query(User).filter(User.name.like(&quot;f%&quot;)).count()  # mysql不区分大小写</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    ----------------     分组查询    ----------------</span></span><br><span class="line"><span class="string">        self.session.query(User.name,func.count(User.name)).group_by(User.name).all()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    ----------------     连表查询    ----------------</span></span><br><span class="line"><span class="string">        ret = self.session.query(Users, Favor).filter(Users.id == Favor.nid).all()</span></span><br><span class="line"><span class="string">        # 以下两种 必须表之间有外键关联才能查</span></span><br><span class="line"><span class="string">        ret = session.query(Person).join(Favor).all()</span></span><br><span class="line"><span class="string">        ret = session.query(Person).join(Favor, isouter=True).all()</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># 查询所有</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sel_user_all</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.session.query(User).<span class="built_in">all</span>()</span><br><span class="line">        <span class="comment"># return self.session.query(User.id,User.name).all() #查询所有，结果集只包含 id，name</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 修改操作</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">up_user</span>(<span class="params">self</span>):</span></span><br><span class="line">        my_user = self.session.query(User).filter_by(name=<span class="string">&quot;fgf&quot;</span>).first()</span><br><span class="line">        my_user.name = <span class="string">&quot;fenggf&quot;</span>  <span class="comment"># 查询出来之后直接赋值修改</span></span><br><span class="line">        my_user.passwork = <span class="string">&quot;123qwe&quot;</span></span><br><span class="line">        self.session.commit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    use = User()</span><br><span class="line">    user_list = use.sel_user_all()</span><br><span class="line">    <span class="keyword">for</span> us <span class="keyword">in</span> user_list:</span><br><span class="line">        <span class="built_in">print</span>(us.name)</span><br></pre></td></tr></table></figure>


<h2 id="创建引擎-连接数据库"><a href="#创建引擎-连接数据库" class="headerlink" title="创建引擎(连接数据库)"></a>创建引擎(连接数据库)</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"></span><br><span class="line">pymysql.install_as_MySQLdb()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 参数字符串说明：数据库类型+驱动://用户名:密码@主机:端口号/数据库名字?charset=编码格式</span></span><br><span class="line">engine = create_engine(<span class="string">&#x27;mysql://root:5KVp2y7,k96o@localhost/testlalchemy?charset=utf8&#x27;</span>,echo=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>echo 的的作用类似<code>debug</code>,True的时候可以在控制台看到所有关于SQL语言的操作</p>
</blockquote>
<blockquote>
<p>create_engine返回的是一个Engine实例，此实例代表了操作数据库的核心接口。</p>
<p>engine其实是懒连接,真正要访问数据库的时候才会去连接数据库</p>
</blockquote>
<p>当我们使用ORM的时候，其配置过程主要分为两个部分：</p>
<ul>
<li>描述我们要处理的数据库表的信息，</li>
<li>将我们的Python类映射到这些表上。</li>
</ul>
<blockquote>
<p>这两个过程在SQLAlchemy中是一起完成的，我们将这个过程称之为<code>声明（Declarative）</code>。</p>
<p>这个系统作用就是 : <strong>帮我们定义类以及实现类与表的对应</strong>。</p>
</blockquote>
<p>声明系统实现<code>类与表的对应</code>是通过一系列基类(声明基类declarative base class)实现的</p>
<p>这个基类我们可以通过declarative_base来创建</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"> Base = declarative_base()</span><br></pre></td></tr></table></figure>

<p><strong>已经有了一个基类，我们可以基于这个基类来创建我们的自定义类了</strong>。</p>
<h2 id="创建表结构"><a href="#创建表结构" class="headerlink" title="创建表结构"></a>创建表结构</h2><p>所有的映射类都需要继承基类(Base class)，而声明系统的实例可以使用declarative_base() 函数来创建：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"><span class="keyword">import</span> sqlalchemy</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine, Column, Integer, String</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"></span><br><span class="line">pymysql.install_as_MySQLdb()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 参数字符串说明：数据库类型+驱动://用户名:密码@主机:端口号/数据库名字?charset=编码格式</span></span><br><span class="line">engine = create_engine(<span class="string">&#x27;mysql://root:5KVp2y7,k96o@localhost/testlalchemy?charset=utf8&#x27;</span>,echo=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 创建声明基类时传入引擎</span></span><br><span class="line">Base = declarative_base(engine)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">Base</span>):</span>           <span class="comment"># 继承声明基类</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;user&#x27;</span>  <span class="comment"># 设置数据表名字，不可省略</span></span><br><span class="line">    <span class="built_in">id</span>        = Column(Integer, primary_key=<span class="literal">True</span>)   <span class="comment"># 设置该字段为主键</span></span><br><span class="line">    name = Column(String(<span class="number">64</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>,index=<span class="literal">True</span>)</span><br><span class="line">    email = Column(String(<span class="number">64</span>), unique=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 此特殊方法定义实例的打印样式</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&lt;User: &#123;&#125;&gt;&#x27;</span>.<span class="built_in">format</span>(self.name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 创建表</span></span><br><span class="line">    Base.metadata.create_all(engine)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>nullable=False 代表这一列不可以为空，index=True 表示在该列创建索引。</p>
</blockquote>
<blockquote>
<p>常用的类型:</p>
<ul>
<li>Text</li>
<li>String</li>
<li>Integer</li>
<li>Boolean</li>
<li>SmallInteger</li>
<li>DateTime</li>
<li>ForeignKey</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>当构建类的时候，Declarative使用特殊的Python访问器(accessors)<code>descriptors</code>去取代所有的Column对象；这个过程称之为instrumentation（中文意思：乐器）</li>
<li>descriptors这个类为我们的表提供了一种使用sql语句访问数据库中表的方式，同时也提供读取表中数据的方式</li>
<li>通过Declarative系统构建了类之后，我们也定义了被称之为表的<code>元数据信息</code>。被SQLAlchemy用来为某特定的表呈现这些信息的对象被称之为Table对象，Declarative系统为我们实现了这些。我们可以通过检测 <strong>table</strong> 参数来查看这个对象</li>
<li>元数据是一堆包含的可以在数据库里执行的命令集。是我们与数据库打交道的一个接口。</li>
<li>当我们使用<code>Declarative system</code> ，<code>Declarative system</code> 会帮我们使用Python的<code>metaclass</code> 类来对我们创建的映射类进行深加工。<code>Declarative system</code> 会创建一个与<code>User</code>类相关的<code>Table</code>对象，然后构造一个<code>Mapper</code>对象与之关联，这一步在<code>Classical Mappings</code>中是由程序员手动操作，但是使用<code>Declarative system</code> 后这些将自动完成。</li>
</ul>
</blockquote>
<h2 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h2><p>Session 在SQLAlchemy中是一个非常重要的概念，session可以理解为<strong>缓冲区</strong>，因为session的存在，所以很多功能得以方便的实现，比如Rollback。</p>
<blockquote>
<ul>
<li>在SQLAlchemy中对数据库的数据CDRU都是通过Session来实现的</li>
<li>Session 和 Engine 是同一级别下的类，相同的重要。</li>
</ul>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker</span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line">session = Session()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Session同样是懒连接,不会执行SQL语句,只有真正要用到数据的时候才会去连接数据库</p>
</blockquote>
<h3 id="session-add-插入数据"><a href="#session-add-插入数据" class="headerlink" title="session.add 插入数据"></a>session.add 插入数据</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># id字段可要可不要</span></span><br><span class="line">ed_user = User(name=<span class="string">&#x27;heyingliang&#x27;</span>, email=<span class="string">&#x27;yyyxxx@qq.com&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(ed_user.name)  <span class="comment">#  heyingliang</span></span><br><span class="line"><span class="built_in">print</span>(ed_user.<span class="built_in">id</span>)  <span class="comment"># None</span></span><br></pre></td></tr></table></figure>

<p>我们并没有在构造器内填入id,插入成功，但是当我们想看看id是多少的时候，返回了None，SQLAlchemy 官方文档说，为了防止出现AttributeError的出现，我们帮你添加了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line">session = Session()</span><br><span class="line"></span><br><span class="line">ed_user = User(<span class="built_in">id</span>=<span class="number">5</span>,name=<span class="string">&#x27;heyingliang&#x27;</span>, email=<span class="string">&#x27;yyyxxx@qq.com&#x27;</span>)</span><br><span class="line">session.add(ed_user)</span><br><span class="line">session.commit()</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>identity map</code> : 标识映射,当一个拥有特定主键的对象出现在Session中时，所有的查询操作对这个主键都会返回一个相同的Python对象。</p>
<p>说人话:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user1 = User(<span class="built_in">id</span>=<span class="number">5</span>,name=<span class="string">&#x27;46&#x27;</span>)</span><br><span class="line">user2 = session.query(User).filter_by(<span class="built_in">id</span>=<span class="number">5</span>).first()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(user1 <span class="keyword">is</span> user2)  <span class="comment"># True</span></span><br></pre></td></tr></table></figure>

<p>也就是说,<strong>只要user1和user2指向数据表的同一行,那么他们就指向同样的内存</strong>.</p>
</blockquote>
<p>通过add_all()来一次加入多个对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">session.add_all([</span><br><span class="line">    User(name=<span class="string">&#x27;wendy&#x27;</span>, fullname=<span class="string">&#x27;Wendy Williams&#x27;</span>, password=<span class="string">&#x27;foobar&#x27;</span>),</span><br><span class="line">    User(name=<span class="string">&#x27;mary&#x27;</span>, fullname=<span class="string">&#x27;Mary Contrary&#x27;</span>, password=<span class="string">&#x27;xxg527&#x27;</span>),</span><br><span class="line">    User(name=<span class="string">&#x27;fred&#x27;</span>, fullname=<span class="string">&#x27;Fred Flinstone&#x27;</span>, password=<span class="string">&#x27;blah&#x27;</span>)</span><br><span class="line">])</span><br></pre></td></tr></table></figure>



<ul>
<li><p><code>session.dirty</code>查看被修改的对象</p>
</li>
<li><p><code>session.new</code>查看已经被<code>session.add()</code>,等待提交的==新建对象==</p>
<blockquote>
<p>但是已经存在于session里的对象,修改后,并不会出现在session,new里</p>
<p>也就是说:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">user2  = User(name=<span class="string">&#x27;name2&#x27;</span>) <span class="comment"># 新建对象</span></span><br><span class="line">session.add(user2) <span class="comment"># 将新建对象放在session里</span></span><br><span class="line"><span class="built_in">print</span>(session.new)  <span class="comment"># IdentitySet([&lt;User: name2&gt;])</span></span><br></pre></td></tr></table></figure>

<p>简单来说<code>session.new</code>保存插入操作</p>
</blockquote>
</li>
</ul>
<p>实例</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"><span class="keyword">import</span> sqlalchemy</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine, Column, Integer, String, Text, ForeignKey ,Table</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> relationship,mapper, sessionmaker</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"></span><br><span class="line">pymysql.install_as_MySQLdb()</span><br><span class="line"></span><br><span class="line">engine = create_engine(<span class="string">&#x27;mysql://root:5KVp2y7,k96o@localhost/aiohttpweb?charset=utf8&#x27;</span>,echo=<span class="literal">True</span>)</span><br><span class="line">Base = declarative_base(engine)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">article_tag = Table(</span><br><span class="line">    <span class="string">&quot;article_tag&quot;</span>,</span><br><span class="line">    Base.metadata,</span><br><span class="line">    Column(<span class="string">&quot;article_id&quot;</span>, Integer, ForeignKey(<span class="string">&quot;article.id&quot;</span>), nullable=<span class="literal">False</span>, primary_key=<span class="literal">True</span>),</span><br><span class="line">    Column(<span class="string">&quot;tag_id&quot;</span>, Integer, ForeignKey(<span class="string">&quot;tag.id&quot;</span>), nullable=<span class="literal">False</span>, primary_key=<span class="literal">True</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span>(<span class="params">Base</span>):</span>           </span><br><span class="line">    __tablename__ = <span class="string">&#x27;article&#x27;</span>  </span><br><span class="line">    <span class="built_in">id</span>       = Column(Integer, primary_key=<span class="literal">True</span> , autoincrement=<span class="literal">True</span>)</span><br><span class="line">    title    = Column(String(<span class="number">64</span>))</span><br><span class="line">    text     = Column(Text)</span><br><span class="line"></span><br><span class="line">    category_name = Column(String(<span class="number">64</span>),ForeignKey(<span class="string">&#x27;category.name&#x27;</span>,ondelete=<span class="string">&#x27;CASCADE&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    category = relationship(<span class="string">&#x27;Category&#x27;</span>)</span><br><span class="line">    tag      = relationship(<span class="string">&quot;Tag&quot;</span>, secondary=article_tag)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&lt;Article: &#123;&#125;&gt;&#x27;</span>.<span class="built_in">format</span>(self.title)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">cls,**kwargs</span>):</span></span><br><span class="line">        article = cls(**kwargs)</span><br><span class="line">        session.add(article)</span><br><span class="line">        <span class="keyword">return</span> session.commit()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Category</span>(<span class="params">Base</span>):</span>           </span><br><span class="line">    __tablename__ = <span class="string">&#x27;category&#x27;</span>  </span><br><span class="line">    <span class="built_in">id</span>   = Column(Integer, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">64</span>),nullable=<span class="literal">True</span>,unique=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    article = relationship(<span class="string">&quot;Article&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&lt;Category: &#123;&#125;&gt;&#x27;</span>.<span class="built_in">format</span>(self.name)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">cls,**kwargs</span>):</span></span><br><span class="line">        cate = cls(**kwargs)</span><br><span class="line">        session.add(cate)</span><br><span class="line">        <span class="keyword">return</span> session.commit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tag</span>(<span class="params">Base</span>):</span>           </span><br><span class="line">    __tablename__ = <span class="string">&#x27;tag&#x27;</span>  </span><br><span class="line">    <span class="built_in">id</span>    = Column(Integer, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>)</span><br><span class="line">    name  = Column(String(<span class="number">64</span>))</span><br><span class="line">    article = relationship(<span class="string">&quot;Article&quot;</span>, secondary=article_tag)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&lt;Tag: &#123;&#125;&gt;&#x27;</span>.<span class="built_in">format</span>(self.name)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">cls,**kwargs</span>):</span></span><br><span class="line">        tag = cls(**kwargs)</span><br><span class="line">        session.add(tag)</span><br><span class="line">        <span class="keyword">return</span> session.commit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 创建表</span></span><br><span class="line">    Base.metadata.create_all(engine)</span><br><span class="line">    session = sessionmaker(bind=engine)()</span><br></pre></td></tr></table></figure>

<h4 id="简单插入"><a href="#简单插入" class="headerlink" title="简单插入"></a>简单插入</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">c = Category(<span class="built_in">id</span>=<span class="number">1</span>,name=<span class="string">&#x27;acg&#x27;</span>)</span><br><span class="line">session.add(c)</span><br><span class="line">session.commit()</span><br></pre></td></tr></table></figure>

<h4 id="插入一对多"><a href="#插入一对多" class="headerlink" title="插入一对多"></a>插入一对多</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">article1 = Article(title=<span class="string">&#x27;this is title&#x27;</span>,text=<span class="string">&#x27;this is text&#x27;</span>,category_name=<span class="string">&#x27;acg&#x27;</span>)</span><br><span class="line">session.add(article1)</span><br><span class="line">session.commit()</span><br></pre></td></tr></table></figure>

<h4 id="插入多对多"><a href="#插入多对多" class="headerlink" title="插入多对多"></a>插入多对多</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">session = sessionmaker(bind=engine)()</span><br><span class="line"><span class="comment"># 这里并没有tag字段(实际上Article表也没有tag字段)</span></span><br><span class="line">article1 = Article(title=<span class="string">&#x27;this is title&#x27;</span>,text=<span class="string">&#x27;this is text&#x27;</span>,category_name=<span class="string">&#x27;acg&#x27;</span>)</span><br><span class="line"><span class="comment"># 创建两个tag</span></span><br><span class="line">tag3 = Tag(name=<span class="string">&#x27;tag3&#x27;</span>)</span><br><span class="line">tag4 = Tag(name=<span class="string">&#x27;tag4&#x27;</span>)</span><br><span class="line"><span class="comment"># 重要:</span></span><br><span class="line">article1.tag = [tag3,tag4]</span><br><span class="line"></span><br><span class="line">session.add(article1)</span><br><span class="line">session.commit()</span><br></pre></td></tr></table></figure>



<h3 id="session-query-filter-查询数据"><a href="#session-query-filter-查询数据" class="headerlink" title="session.query.filter 查询数据"></a>session.query.filter 查询数据</h3><ul>
<li><code>Query</code>对象是通过<code>Session</code>里的<code>query()</code>方法来创建的。</li>
<li><code>query()</code>方法的参数可以是一些内置的类或者描述符。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 返回</span></span><br><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> s.query(User).order_by(User.<span class="built_in">id</span>):</span><br><span class="line">    <span class="built_in">print</span>(row)</span><br><span class="line"><span class="comment"># &lt;User: name3&gt;    类型为&lt;class &#x27;training2.User&#x27;&gt;(表对象)</span></span><br><span class="line"><span class="comment"># &lt;User: name2&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> s.query(User.<span class="built_in">id</span>,User.name).order_by(User.<span class="built_in">id</span>):</span><br><span class="line">    <span class="built_in">print</span>(row)</span><br><span class="line"><span class="comment"># (5, &#x27;name3&#x27;)   类型为&lt;class &#x27;sqlalchemy.util._collections.result&#x27;&gt;,可以当成是tuple</span></span><br><span class="line"><span class="comment"># (6, &#x27;name2&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 混合使用.同时传入User和User.name</span></span><br><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> s.query(User,User.name).order_by(User.<span class="built_in">id</span>):</span><br><span class="line">    <span class="built_in">print</span>(row.User,row)</span><br><span class="line"><span class="comment"># &lt;User: name3&gt; (&lt;User: name3&gt;, &#x27;name3&#x27;)</span></span><br><span class="line"><span class="comment"># &lt;User: name2&gt; (&lt;User: name2&gt;, &#x27;name2&#x27;)</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>简单来说:</p>
<ul>
<li>s.query(User)返回某行</li>
<li>s.query(User.name)返回某行的字段</li>
<li>row对应的是User, 想获取name就使用row.name</li>
</ul>
</blockquote>
<p>使用label为某列起别名:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> session.query(User.name.label(<span class="string">&#x27;new_column&#x27;</span>)).<span class="built_in">all</span>():</span><br><span class="line">    <span class="built_in">print</span>(row.new_column)</span><br><span class="line"><span class="comment">#name2</span></span><br><span class="line"><span class="comment">#name3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对应的SQL语句: SELECT user.name AS new_column FROM user</span></span><br></pre></td></tr></table></figure>

<p>我们不仅可以为Column取别名,还可以<strong>为数据表取别名</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> aliased</span><br><span class="line">new_table = aliased(User,name=<span class="string">&#x27;new_table&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> session.query(new_table,new_table.name).<span class="built_in">all</span>():</span><br><span class="line">    <span class="built_in">print</span>(row.name)</span><br><span class="line"><span class="comment"># name2</span></span><br><span class="line"><span class="comment"># name3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对应的SQL语句 : SELECT new_table.id AS new_table_id, new_table.name AS new_table_name FROM user AS new_table</span></span><br></pre></td></tr></table></figure>

<p>过滤使用<code>filter_by()</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> name <span class="keyword">in</span> session.query(User.name).filter_by(<span class="built_in">id</span>=<span class="number">5</span>):</span><br><span class="line">    <span class="built_in">print</span>(name)</span><br><span class="line"></span><br><span class="line"><span class="comment"># SELECT user.name AS user_name FROM user WHERE user.id = %(id_1)s</span></span><br></pre></td></tr></table></figure>

<p><code>Query对象</code>是可以链式调用的,即query对象的方法返回的依旧还是query对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session.query(User).<span class="built_in">filter</span>(User.<span class="built_in">id</span>=<span class="number">5</span>).<span class="built_in">filter</span>(User.name=<span class="string">&#x27;hyl&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="session-delete-删除数据"><a href="#session-delete-删除数据" class="headerlink" title="session.delete 删除数据"></a>session.delete 删除数据</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session.delete(session.query(User).<span class="built_in">filter</span>(User.<span class="built_in">id</span>==<span class="number">1</span>).one())</span><br></pre></td></tr></table></figure>

<h3 id="session-update-更新数据"><a href="#session-update-更新数据" class="headerlink" title="session.update 更新数据"></a>session.update 更新数据</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">query = session.query(User).filter_by(<span class="built_in">id</span>=<span class="number">1</span>).update(&#123;<span class="string">&quot;username&quot;</span>:User.username + <span class="string">&quot;a&quot;</span>&#125;,synchronize_session=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>



<h3 id="session-rollback-事务回滚"><a href="#session-rollback-事务回滚" class="headerlink" title="session.rollback 事务回滚"></a>session.rollback 事务回滚</h3><p>一般的使用方法:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    session.commit()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    session.rollback()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>也就是说<strong>rollback()会回退到上一个commit()的状态</strong>.</p>
</blockquote>
<h3 id="常用的过滤操作"><a href="#常用的过滤操作" class="headerlink" title="常用的过滤操作"></a>常用的过滤操作</h3><ul>
<li><p>equals<br><code>query.filter(User.name == &#39;hyl&#39;)</code></p>
</li>
<li><p>not equals<br><code>query.filter(User.name != &#39;hyl&#39;)</code></p>
</li>
<li><p>LIKE<br><code>query.filter(User.name.like(&#39;%h%&#39;))</code></p>
<blockquote>
<p>% 匹配任意数量的任意字符，_ 匹配单个任意字符：</p>
</blockquote>
</li>
<li><p>IN<br><code>query.filter(User.name.in_([&#39;heyingliang&#39;,&#39;liangbo&#39;,&#39;name3&#39;]))</code><br>或者:<br><code>query.filter(User.name.in_(query.filter(User.name.like(&#39;%h%&#39;))))</code></p>
</li>
<li><p>NOT IN<br><code>query.filter(~User.name.in_(query.filter(User.name.like(&#39;%he%&#39;))))</code></p>
</li>
<li><p>IS NULL<br><code>query.filter(User.name == None)</code><br>或者<br><code>query.filter(User.name.is_(None))</code></p>
</li>
<li><p>IS NOT NULL<br><code>query.filter(User.name != None)</code><br>或者<br><code>query.filter(User.name.isnot(None))</code></p>
</li>
<li><p>AND<br><code>query.filter(and_(User.name==&#39;ed&#39;,User.id==&#39;hyl&#39;))</code><br>或者<br><code>query.filter(User.name==&#39;hyl&#39;).filter(User.id==5)</code></p>
<p>或者<br><code>query.filter(User.name==&#39;hyl&#39;,id==5)</code></p>
</li>
<li><p>OR<br><code>query.filter(or_(User.name==&#39;hyl&#39;,User.id==5))</code></p>
</li>
<li><p>MATCH:<br><code>query.filter(User.name.match(&#39;wendy&#39;))</code></p>
</li>
</ul>
<p>query返回值的限制:</p>
<ul>
<li>all():以列表的形式返回<br><code>query.filter(User.name == &#39;hyl&#39;).all()</code></li>
<li>first():返回第一个结果<br><code>query.filter(User.name == &#39;hyl&#39;).first()</code></li>
<li>one():返回第一个结果,如果没有则报错<br><code>query.filter(User.name==&#39;hyl&#39;).one()</code></li>
<li>one_or_none():如果没有返回None,如果有一个返回数据,如果有多个报错</li>
<li>.scalar() 这个方法与one_or_none()的效果一样。<br> 如果查询到很多结果，抛出sqlalchemy.orm.exc.MultipleResultsFound异常。如果只有一个结果，返回它，没有结果返回None。</li>
</ul>
<h3 id="分组-计数-排序-限制"><a href="#分组-计数-排序-限制" class="headerlink" title="分组,计数,排序,限制"></a>分组,计数,排序,限制</h3><p>计算行数:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session.query(User).<span class="built_in">filter</span>(User.name.like(‘%ed’)).count()</span><br></pre></td></tr></table></figure>

<p>需要我们对每一项分别计数的时候，我们需要在<code>func</code>模块里通过<code>func.count()</code>来直接指定<code>count()</code>函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> func</span><br><span class="line">    </span><br><span class="line"> session.query(func.count(User.name), User.name).group_by(User.name).<span class="built_in">all</span>()</span><br><span class="line"><span class="comment"># [(1, u&#x27;ed&#x27;), (1, u&#x27;fred&#x27;), (1, u&#x27;mary&#x27;), (1, u&#x27;wendy&#x27;)]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SELECT count(user.name) AS count_1, user.name AS user_name FROM user GROUP BY user.name</span></span><br></pre></td></tr></table></figure>

<p>排序：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">session.query(User).order_by(User.email).<span class="built_in">all</span>()   <span class="comment"># 默认升序</span></span><br><span class="line">session.query(User).order_by(User.email.desc()).<span class="built_in">all</span>()  <span class="comment"># 降序</span></span><br></pre></td></tr></table></figure>

<p>限制:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session.query(User).<span class="built_in">filter</span>(User.<span class="built_in">id</span>=<span class="number">5</span>).<span class="built_in">filter</span>(User.name=<span class="string">&#x27;hyl&#x27;</span>).limit(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>



<h3 id="嵌入使用SQL"><a href="#嵌入使用SQL" class="headerlink" title="嵌入使用SQL"></a>嵌入使用SQL</h3><p>在Query中通过text()使用SQL语句。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 直接将参数写进字符串的方式</span></span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> session.query(User).<span class="built_in">filter</span>(text(<span class="string">&quot;id&gt;2&quot;</span>)).<span class="built_in">all</span>():</span><br><span class="line">    <span class="built_in">print</span>(user.name)</span><br></pre></td></tr></table></figure>

<p>通过params()方法来传递参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意:val,要将冒号</span></span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> session.query(User).<span class="built_in">filter</span>(text(<span class="string">&quot;id&gt;:val&quot;</span>)).params(val=<span class="number">2</span>).<span class="built_in">all</span>():</span><br><span class="line">    <span class="built_in">print</span>(user.name)</span><br></pre></td></tr></table></figure>

<p>直接使用完整的SQL语句</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session.query(User).from_statement(text(<span class="string">&#x27;select * from user where name=:name&#x27;</span>.params(name=<span class="string">&#x27;name2&#x27;</span>).<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>为了使用完全基于字符串的语句，可以使用<code>from_statement()</code>来实现。</p>
</blockquote>
<h2 id="Relationship-关系定义"><a href="#Relationship-关系定义" class="headerlink" title="Relationship(关系定义)"></a>Relationship(关系定义)</h2><h3 id="一对多"><a href="#一对多" class="headerlink" title="一对多"></a>一对多</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">Base</span>):</span>           <span class="comment"># 继承声明基类</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String)</span><br><span class="line">    fullname = Column(String)</span><br><span class="line">    password = Column(String)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 此特殊方法定义实例的打印样式</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&lt;User(name=&#x27;%s&#x27;, fullname=&#x27;%s&#x27;, password=&#x27;%s&#x27;)&gt;&quot;</span> % (self.name, self.fullname, self.password)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Address</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;addresses&#x27;</span></span><br><span class="line">    address_id = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    email_address = Column(String, nullable=<span class="literal">False</span>)</span><br><span class="line">    user_id = Column(Integer, ForeignKey(<span class="string">&#x27;users.id&#x27;</span>))    <span class="comment"># 使用foreignkey</span></span><br><span class="line">    <span class="comment"># relationship()的参数配置中,指向被连接的类的字符串</span></span><br><span class="line">    user = relationship(<span class="string">&quot;users&quot;</span>, back_populates=<span class="string">&quot;addresses&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&lt;Address(email_address=&#x27;%s&#x27;)&gt;&quot;</span> % self.email_address</span><br></pre></td></tr></table></figure>

<blockquote>
<p>relationship，来告诉ORM，Address类需要被连接到User类。relationship和ForeignKey这个两个属性决定了表之间关系的属性，决定了Address与User关系是多对一的。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User.addresses = relationship(<span class="string">&quot;address&quot;</span>, back_populates=<span class="string">&quot;user&quot;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在完成对Address类的声明之后，我们还定义另一个relationship，将其赋值给了User.addresses。在两个relationship中，我们都有传入了一个relationship.back_populates的属性来为<strong>反向关系</strong>所对应的属性进行命名。</p>
</blockquote>
<blockquote>
<p>SQLAlchemy中定义关系要比Django的ORM要麻烦许多。Django中只需要一行就可以了。而且<strong>这里的两个relationship的定义明显是冗余的</strong>。</p>
<ul>
<li>我们定义的两个互补的关系Address.user和User.addresses被称为<code>双向关系</code>,这是SQLAlchemy的核心特性之一。</li>
</ul>
</blockquote>
<blockquote>
<p>注意:<br><code> user = relationship(&quot;users&quot;, back_populates=&quot;addresses&quot;)</code>中第一参数users是<code>__tablename__= &#39;users&#39; </code>中的users,而不是<code>class User(Base): </code>中的User</p>
</blockquote>
<p>如果要添加级联删除等约束:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">addresses = relationship(<span class="string">&quot;Address&quot;</span>, back_populates=<span class="string">&#x27;user&#x27;</span>, cascade=<span class="string">&quot;all, delete, delete-orphan&quot;</span>)</span><br></pre></td></tr></table></figure>



<p>relationship的属性:</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>backref</td>
<td>在关系的另一个映射类中添加反向引用</td>
</tr>
<tr>
<td>lazy</td>
<td>指定如何加载查询记录。可选值有 select (首次访问时按需加载)、immediate (源对象加载后就加载)、joined (加载记录，但使用联结)， noload (永不加载)和 dynamic (不加载记录，但提供加载记录的查询，比较常用)</td>
</tr>
<tr>
<td>cascade</td>
<td>设置级联删除的方式</td>
</tr>
<tr>
<td>uselist</td>
<td>如果设为 False ，查询结果不使用列表，而使用映射类实例</td>
</tr>
<tr>
<td>order_by</td>
<td>指定查询记录的排序方式</td>
</tr>
<tr>
<td>secondary</td>
<td>指定多对多关系中关系表的名字</td>
</tr>
</tbody></table>
<p>示例二:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    username = Column(String(<span class="number">64</span>), nullable=<span class="literal">False</span>, index=<span class="literal">True</span>)</span><br><span class="line">    password = Column(String(<span class="number">64</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    email = Column(String(<span class="number">64</span>), nullable=<span class="literal">False</span>, index=<span class="literal">True</span>)</span><br><span class="line">    articles = relationship(<span class="string">&#x27;Article&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;%s(%r)&quot;</span> % (self.__class__.__name__, self.username)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;articles&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    title = Column(String(<span class="number">255</span>), nullable=<span class="literal">False</span>, index=<span class="literal">True</span>, name=<span class="string">&quot;标题&quot;</span>)</span><br><span class="line">    content = Column(Text)</span><br><span class="line">    user_id = Column(Integer, ForeignKey(<span class="string">&quot;users.id&quot;</span>))</span><br><span class="line">    author = relationship(<span class="string">&#x27;User&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;%s(%r)&quot;</span> % (self.__class__.__name__, self.title)</span><br></pre></td></tr></table></figure>

<p>除了ForeignKey之外，我们还引入了一个relationship，<strong>来告诉ORM，Article类需要被连接到User类</strong>。relationship和ForeignKey这个两个属性决定了表之间关系的属性，决定了这个关系是多对一的。</p>
<blockquote>
<p>SQLAlchemy 提供了 backref 让我们可以只需要定义一个关系：<br><code>articles = relationship(&#39;Article&#39;, backref=&#39;author&#39;)</code></p>
<ul>
<li><code>backref</code>称为<code>反向查询接口</code></li>
<li>添加了这个就可以不用再在 Article 中定义 relationship 了！(只用定义一边,另一边不用定义)</li>
</ul>
</blockquote>
<h3 id="一对一"><a href="#一对一" class="headerlink" title="一对一"></a>一对一</h3><p>一对一关系定义方法和一对多相同，只是<strong>需要添加 userlist=False 参数</strong>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    username = Column(String(<span class="number">64</span>), nullable=<span class="literal">False</span>, index=<span class="literal">True</span>)</span><br><span class="line">    password = Column(String(<span class="number">64</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    email = Column(String(<span class="number">64</span>), nullable=<span class="literal">False</span>, index=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># 定义方法和一对多相同，只是需要添加 userlist=False</span></span><br><span class="line">    userinfo = relationship(<span class="string">&#x27;UserInfo&#x27;</span>, backref=<span class="string">&#x27;user&#x27;</span>, uselist=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;userinfos&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">64</span>))</span><br><span class="line">    qq = Column(String(<span class="number">11</span>))</span><br><span class="line">    phone = Column(String(<span class="number">11</span>))</span><br><span class="line">    link = Column(String(<span class="number">64</span>))</span><br><span class="line">    user_id = Column(Integer, ForeignKey(<span class="string">&#x27;users.id&#x27;</span>))</span><br></pre></td></tr></table></figure>

<blockquote>
<p>uselist : 如果设为 False ，<strong>查询结果不使用列表，而使用映射类实例</strong></p>
</blockquote>
<p>示例二:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">Base</span>):</span>           <span class="comment"># 继承声明基类</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;user&#x27;</span>  <span class="comment"># 设置数据表名字，不可省略</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)   <span class="comment"># 设置该字段为主键</span></span><br><span class="line">    <span class="comment"># unique 设置唯一约束，nullable 设置非空约束</span></span><br><span class="line">    name = Column(String(<span class="number">64</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)</span><br><span class="line">    email = Column(String(<span class="number">64</span>), unique=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 此特殊方法定义实例的打印样式</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&lt;User: &#123;&#125;&gt;&#x27;</span>.<span class="built_in">format</span>(self.name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Course</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;course&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">64</span>))</span><br><span class="line">    <span class="comment"># ForeignKey 设置外键关联，第一个参数为字符串，user 为数据表名，id 为字段名</span></span><br><span class="line">    user_id = Column(Integer, ForeignKey(<span class="string">&#x27;user.id&#x27;</span>, ondelete=<span class="string">&#x27;CASCADE&#x27;</span>))</span><br><span class="line">    <span class="comment"># relationship 设置查询接口，以便后期进行数据库查询操作</span></span><br><span class="line">    <span class="comment"># 第一个参数为位置参数，参数值为外键关联的映射类名，数据类型为字符串</span></span><br><span class="line">    <span class="comment"># 第二个参数 backref 设置反向查询接口</span></span><br><span class="line">    <span class="comment"># backref 的第一个参数 &#x27;course&#x27; 为查询属性，User 实例使用该属性可以获得相关课程实例的列表</span></span><br><span class="line">    <span class="comment"># backref 的第二个参数 cascade 如此设置即可实现 Python 语句删除用户数据时级联删除课程数据</span></span><br><span class="line">    user = relationship(<span class="string">&#x27;User&#x27;</span>, </span><br><span class="line">            backref=backref(<span class="string">&#x27;course&#x27;</span>, cascade=<span class="string">&#x27;all, delete-orphan&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&lt;Course: &#123;&#125;&gt;&#x27;</span>.<span class="built_in">format</span>(self.name)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每个课程只有一个实验,课程和实验就是一对一的关系</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lab</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;lab&#x27;</span></span><br><span class="line">    <span class="comment"># 设置主键为外键，关联 course 表的 id 字段</span></span><br><span class="line">    <span class="comment"># 注意参数顺序，先定义外键，再定义主键</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, ForeignKey(<span class="string">&#x27;course.id&#x27;</span>), primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">128</span>))</span><br><span class="line">    <span class="comment"># 设置查询接口，Lab 实例的 course 属性值为 Course 实例</span></span><br><span class="line">    <span class="comment"># Course 实例的 lab 属性值默认为列表，列表中有一个 Lab 实例</span></span><br><span class="line">    <span class="comment"># uselist 参数可以设置 Course 实例的 lab 属性值为 Lab 实例而非列表</span></span><br><span class="line">    course = relationship(<span class="string">&#x27;Course&#x27;</span>, backref=backref(<span class="string">&#x27;lab&#x27;</span>, uselist=<span class="literal">False</span>))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&lt;Lab: &#123;&#125;&gt;&#x27;</span>.<span class="built_in">format</span>(self.name)       </span><br></pre></td></tr></table></figure>

<blockquote>
<p>把 lab 的主键 id 设置为外键关联到 course 的主键 id</p>
</blockquote>
<h3 id="多对多"><a href="#多对多" class="headerlink" title="多对多"></a>多对多</h3><p>多对多关系不能直接定义，需要分解成俩个一对多的关系，为此，需要一张额外的表来协助完成：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个多对多的关系(老师与学生的关系)需要创建一个中间表</span></span><br><span class="line"><span class="comment"># 创建一个中间表</span></span><br><span class="line">teacher_classes = Table(</span><br><span class="line">    <span class="string">&quot;teacher_classes&quot;</span>,</span><br><span class="line">    Base.metadata,</span><br><span class="line">    Column(<span class="string">&quot;teacher_id&quot;</span>, Integer, ForeignKey(<span class="string">&quot;teacher.id&quot;</span>), nullable=<span class="literal">False</span>, primary_key=<span class="literal">True</span>),</span><br><span class="line">    Column(<span class="string">&quot;classes_id&quot;</span>, Integer, ForeignKey(<span class="string">&quot;classes.id&quot;</span>), nullable=<span class="literal">False</span>, primary_key=<span class="literal">True</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建老师的映射</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Teacher</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&quot;teacher&quot;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>)</span><br><span class="line">    teacher_name = Column(String(<span class="number">100</span>))</span><br><span class="line">    classes = relationship(<span class="string">&quot;Classes&quot;</span>, secondary=teacher_classes)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建学生的映射</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Classes</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&quot;classes&quot;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>, autoincrement=<span class="literal">True</span>)</span><br><span class="line">    classes_name = Column(String(<span class="number">100</span>))</span><br><span class="line">    teacher = relationship(<span class="string">&quot;teacher&quot;</span>, secondary=teacher_classes)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>不用定义<code>foreignkey</code>,只需定义两个relationship,然后定义一个中间表即可</p>
<p>不同于我们之前的典型的ORM方法，在上面的代码中我们直接声明了一个<code>Table</code>，而没有制定与之对应的Python类。Table是一个构造函数，其参数中的每个Colomn以逗号分隔。</p>
</blockquote>
<blockquote>
<ul>
<li>和OneToMany关系不同，<code>relationship()</code>中多了一个<code>secondary</code>的参数，<strong>secondary参数指向了中间表</strong>。</li>
<li>这个中间表只包含了指向多对多关系两侧的表的主键的列。</li>
<li>如果这个表包含了其他属性，甚至是自身的主键，SQLAlchemy需要你使用另一种，称为<code>association object</code>的机制来处理。</li>
</ul>
</blockquote>
<p>示例二:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 引入 Table 类</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Table</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 Table 类的实例，即中间表映射类，赋值给变量 Rela</span></span><br><span class="line"><span class="comment"># 该类在实例化时，接收 4 个参数：</span></span><br><span class="line"><span class="comment"># 1、数据表名字 </span></span><br><span class="line"><span class="comment"># 2、Base.metadata</span></span><br><span class="line"><span class="comment"># 3 和 4、两个 Column（列名，数据类型，外键，主键）</span></span><br><span class="line">Rela = Table(<span class="string">&#x27;rela&#x27;</span>, Base.metadata,</span><br><span class="line">        Column(<span class="string">&#x27;tag_id&#x27;</span>, Integer, ForeignKey(<span class="string">&#x27;tag.id&#x27;</span>), primary_key=<span class="literal">True</span>),</span><br><span class="line">        Column(<span class="string">&#x27;course_id&#x27;</span>, Integer, ForeignKey(<span class="string">&#x27;course.id&#x27;</span>), primary_key=<span class="literal">True</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tag</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;tag&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">64</span>), unique=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># 设置查询接口，secondary 指定多对多关系的中间表，注意数据类型不是字符串</span></span><br><span class="line">    course = relationship(<span class="string">&#x27;Course&#x27;</span>, secondary=Rela, backref=<span class="string">&#x27;tag&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&lt;Tag: &#123;&#125;&gt;&#x27;</span>.<span class="built_in">format</span>(self.name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Course</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;course&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">64</span>))</span><br><span class="line">    <span class="comment"># ForeignKey 设置外键关联，第一个参数为字符串，user 为数据表名，id 为字段名</span></span><br><span class="line">    user_id = Column(Integer, ForeignKey(<span class="string">&#x27;user.id&#x27;</span>, ondelete=<span class="string">&#x27;CASCADE&#x27;</span>))</span><br><span class="line">    <span class="comment"># relationship 设置查询接口，以便后期进行数据库查询操作</span></span><br><span class="line">    <span class="comment"># 第一个参数为位置参数，参数值为外键关联的映射类名，数据类型为字符串</span></span><br><span class="line">    <span class="comment"># 第二个参数 backref 设置反向查询接口</span></span><br><span class="line">    <span class="comment"># backref 的第一个参数 &#x27;course&#x27; 为查询属性，User 实例使用该属性可以获得相关课程实例的列表</span></span><br><span class="line">    <span class="comment"># backref 的第二个参数 cascade 如此设置即可实现 Python 语句删除用户数据时级联删除课程数据</span></span><br><span class="line">    user = relationship(<span class="string">&#x27;User&#x27;</span>, </span><br><span class="line">            backref=backref(<span class="string">&#x27;course&#x27;</span>, cascade=<span class="string">&#x27;all, delete-orphan&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&lt;Course: &#123;&#125;&gt;&#x27;</span>.<span class="built_in">format</span>(self.name)</span><br></pre></td></tr></table></figure>





<h2 id="关系查询"><a href="#关系查询" class="headerlink" title="关系查询"></a>关系查询</h2><h3 id="外键查询"><a href="#外键查询" class="headerlink" title="外键查询"></a>外键查询</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"><span class="keyword">import</span> sqlalchemy</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine, Column, Integer, String,ForeignKey</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> mapper, sessionmaker,relationship</span><br><span class="line"></span><br><span class="line">pymysql.install_as_MySQLdb()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 参数字符串说明：数据库类型+驱动://用户名:密码@主机:端口号/数据库名字?charset=编码格式</span></span><br><span class="line">engine = create_engine(<span class="string">&#x27;mysql://root:5KVp2y7,k96o@localhost/testlalchemy?charset=utf8&#x27;</span>,echo=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 创建声明基类时传入引擎</span></span><br><span class="line">Base = declarative_base(engine)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">Base</span>):</span>           <span class="comment"># 继承声明基类</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">64</span>))</span><br><span class="line">    fullname = Column(String(<span class="number">64</span>))</span><br><span class="line">    password = Column(String(<span class="number">64</span>))</span><br><span class="line">    addresses = relationship(<span class="string">&quot;Address&quot;</span>, back_populates=<span class="string">&quot;user&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 此特殊方法定义实例的打印样式</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&lt;User(name=&#x27;%s&#x27;, fullname=&#x27;%s&#x27;, password=&#x27;%s&#x27;)&gt;&quot;</span> % (self.name, self.fullname, self.password)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Address</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;addresses&#x27;</span></span><br><span class="line">    address_id = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    email_address = Column(String(<span class="number">64</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    user_id = Column(Integer, ForeignKey(<span class="string">&#x27;users.id&#x27;</span>))    <span class="comment"># 使用foreignkey</span></span><br><span class="line">    <span class="comment"># relationship()的参数配置中,指向被连接的类的字符串</span></span><br><span class="line">    user = relationship(<span class="string">&quot;User&quot;</span>, back_populates=<span class="string">&quot;addresses&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&lt;Address(email_address=&#x27;%s&#x27;)&gt;&quot;</span> % self.email_address</span><br><span class="line"></span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line">session = Session()</span><br><span class="line">Base.metadata.create_all(engine)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jack = User(name=<span class="string">&#x27;jack&#x27;</span>,fullname=<span class="string">&#x27;jack bean&#x27;</span>,password=<span class="string">&#x27;123456&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(jack.addresses) <span class="comment"># []</span></span><br></pre></td></tr></table></figure>

<p>添加User对象:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">jack.addresses = [</span><br><span class="line">    Address(email_address=<span class="string">&#x27;123@qq.com&#x27;</span>),</span><br><span class="line">    Address(email_address=<span class="string">&#x27;456@gmail.com&#x27;</span>)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(jack.addresses)</span><br><span class="line"><span class="comment"># [&lt;Address(email_address=&#x27;123@qq.com&#x27;)&gt;, &lt;Address(email_address=&#x27;456@gmail.com&#x27;)&gt;]</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(jack.addresses[<span class="number">0</span>].user)</span><br><span class="line"><span class="comment"># &lt;User(name=&#x27;jack&#x27;, fullname=&#x27;jack bean&#x27;, password=&#x27;123456&#x27;)&gt;</span></span><br></pre></td></tr></table></figure>

<p>添加至session并提交:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">session.add(jack)</span><br><span class="line">session.commit()</span><br><span class="line"></span><br><span class="line"><span class="comment"># INSERT INTO users (name, fullname, password) VALUES (?, ?, ?)</span></span><br><span class="line"><span class="comment"># (&#x27;jack&#x27;, &#x27;Jack Bean&#x27;, &#x27;gjffdd&#x27;)</span></span><br><span class="line"><span class="comment"># INSERT INTO addresses (email_address, user_id) VALUES (?, ?)</span></span><br><span class="line"><span class="comment"># (&#x27;jack@google.com&#x27;, 5)</span></span><br><span class="line"><span class="comment"># INSERT INTO addresses (email_address, user_id) VALUES (?, ?)</span></span><br><span class="line"><span class="comment"># (&#x27;j25@yahoo.com&#x27;, 5)</span></span><br><span class="line"><span class="comment"># COMMIT</span></span><br></pre></td></tr></table></figure>

<p>说明一次性insert了三条数据,也就是说与jack关联的两个Address对象也被提交了</p>
<p>获取外键:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">person = session.query(User).filter_by(name=<span class="string">&#x27;jack&#x27;</span>).one()</span><br><span class="line"><span class="built_in">print</span>(person..addresses)</span><br></pre></td></tr></table></figure>



<h3 id="使用join进行查询"><a href="#使用join进行查询" class="headerlink" title="使用join进行查询"></a>使用join进行查询</h3><p>一般会造成1+N问题的查询:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session.query(User).<span class="built_in">filter</span>(User.<span class="built_in">id</span>==<span class="number">1</span>).one().addresses</span><br></pre></td></tr></table></figure>

<p>使用join查询:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">session.query(User).join(Address).<span class="built_in">filter</span>(User.<span class="built_in">id</span>==<span class="number">1</span>).one().addresses</span><br><span class="line"></span><br><span class="line"><span class="comment"># 完整写法 : join(Address, User.id==Address.user_id)</span></span><br><span class="line">session.query(User).join(Address, User.<span class="built_in">id</span>==Address.user_id) .<span class="built_in">filter</span>(User.<span class="built_in">id</span>==<span class="number">1</span>).one().addresses</span><br></pre></td></tr></table></figure>

<p>左外连接 : <code>query.outerjoin(User.addresses)</code> </p>
<h3 id="使用Aliases"><a href="#使用Aliases" class="headerlink" title="使用Aliases"></a>使用Aliases</h3><p>当你的查询涉及多个表，而其中同一个表出现了多次时，你需要的为重复的表aliase一个新的名字来避免冲突。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> username, email1, email2 <span class="keyword">in</span> (session.query(User.name, adalias1.email_address, adalias2.email_address)</span><br><span class="line">	.join(adalias1, User.addresses)</span><br><span class="line">	.join(adalias2, User.addresses)</span><br><span class="line">	.<span class="built_in">filter</span>(adalias1.email_address==<span class="string">&#x27;jack@google.com&#x27;</span>)</span><br><span class="line">	.<span class="built_in">filter</span>(adalias2.email_address==<span class="string">&#x27;j25@yahoo.com&#x27;</span>)):</span><br><span class="line">		<span class="built_in">print</span>(username, email1, email2)</span><br></pre></td></tr></table></figure>

<h3 id="使用子查询-Subqueries"><a href="#使用子查询-Subqueries" class="headerlink" title="使用子查询(Subqueries)"></a>使用子查询(Subqueries)</h3><p>我们想要取出User记录，并且同时<strong>计算各个用户的Address的数量</strong>。<br>产生这种功能的SQL指令最好的办法是按照user的id分组统计地址的数量，然后join到外层查询。此时我们需要LEFT JOIN，这样可以使得没有地址的用户也会出现在查询结果中（地址数量为0）。 </p>
<blockquote>
<p>我们期望的SQL命令是这样的：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> users.<span class="operator">*</span>, adr_count.address_count <span class="keyword">FROM</span> users <span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span></span><br><span class="line">    (<span class="keyword">SELECT</span> user_id, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">AS</span> address_count</span><br><span class="line">        <span class="keyword">FROM</span> addresses <span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id) <span class="keyword">AS</span> adr_count</span><br><span class="line">    <span class="keyword">ON</span> users.id<span class="operator">=</span>adr_count.user_id</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.sql <span class="keyword">import</span> func</span><br><span class="line"></span><br><span class="line">stmt = session.query(Address.user_id, func.count(<span class="string">&#x27;*&#x27;</span>).label(<span class="string">&#x27;address_count&#x27;</span>)).group_by(Address.user_id).subquery()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> u, count <span class="keyword">in</span> session.query(User, stmt.c.address_count).outerjoin(stmt, User.<span class="built_in">id</span>==stmt.c.user_id).order_by(User.<span class="built_in">id</span>):</span><br><span class="line">    <span class="built_in">print</span>(u, count)</span><br></pre></td></tr></table></figure>

<p>subquery()可以产生一个内嵌了alias（是一个query.statement.alias()）的查询(SELECT)语句的表达。</p>
<h3 id="使用EXISTS"><a href="#使用EXISTS" class="headerlink" title="使用EXISTS"></a>使用EXISTS</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.sql <span class="keyword">import</span> exists</span><br><span class="line"></span><br><span class="line">stmt = session.query(Address.user_id, func.count(<span class="string">&#x27;*&#x27;</span>).label(<span class="string">&#x27;address_count&#x27;</span>)).group_by(Address.user_id).subquery()</span><br><span class="line"></span><br><span class="line">stmt = exists().where(Address.user_id==User.<span class="built_in">id</span>)</span><br><span class="line"><span class="keyword">for</span> name, <span class="keyword">in</span> session.query(User.name).<span class="built_in">filter</span>(stmt):</span><br><span class="line">	<span class="built_in">print</span>(name)</span><br></pre></td></tr></table></figure>

<p>exists问题还可以使用<code>any()</code>函数解决:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> name, <span class="keyword">in</span> session.query(User.name).<span class="built_in">filter</span>(User.addresses.<span class="built_in">any</span>()):</span><br><span class="line">	<span class="built_in">print</span>(name)</span><br></pre></td></tr></table></figure>





<h2 id="问题总结"><a href="#问题总结" class="headerlink" title="问题总结"></a>问题总结</h2><ol>
<li><p><code>sqlalchemy.exc.IntegrityError: (pymysql.err.IntegrityError) (1215, &#39;Cannot add foreign key constraint&#39;) [SQL: &#39;\nCREATE TABLE article (\n\tid INTEGER NOT NULL AUTO_INCREMENT, \n\ttitle VARCHAR(64), \n\ttext TEXT, \n\tcategory VARCHAR(64), \n\tPRIMARY KEY (id), \n\tFOREIGN KEY(category) REFERENCES category (name) ON DELETE CASCADE\n)\n\n&#39;] (Background on this error at: http://sqlalche.me/e/gkpj)</code><br>没有将外键设置为unique和nullable</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">category = Column(String(<span class="number">64</span>),ForeignKey(<span class="string">&#x27;category.name&#x27;</span>,ondelete=<span class="string">&#x27;CASCADE&#x27;</span>))</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改前</span></span><br><span class="line">name = Column(String(<span class="number">64</span>))</span><br><span class="line"><span class="comment"># 修改后</span></span><br><span class="line">name = Column(String(<span class="number">64</span>),nullable=<span class="literal">True</span>,unique=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure></li>
<li><p><code>NoReferencedTableError: Foreign key associated with column</code><br>要将外键引用的键不是<code>class Article(Base): </code>的值,而是<code>__tablename__ = &#39;article&#39;</code>的值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Category</span>(<span class="params">Base</span>):</span>           </span><br><span class="line">    __tablename__ = <span class="string">&#x27;category&#x27;</span>  </span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改前</span></span><br><span class="line">category = Column(String(<span class="number">64</span>),ForeignKey(<span class="string">&#x27;Category.name&#x27;</span>,ondelete=<span class="string">&#x27;CASCADE&#x27;</span>))</span><br><span class="line"><span class="comment"># 修改后</span></span><br><span class="line">category = Column(String(<span class="number">64</span>),ForeignKey(<span class="string">&#x27;category.name&#x27;</span>,ondelete=<span class="string">&#x27;CASCADE&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>但是:relationship要用大写 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">category = relationship(<span class="string">&#x27;Category&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
<li><p><code>Warning: (1366, &quot;Incorrect string value: &#39;\\xD6\\xD0\\xB9\\xFA\\xB1\\xEA...&#39;</code>警告:<br>原因 : 驱动暂时使用是pymysql</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install mysql-connector-python</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">engine = create_engine(<span class="string">&quot;mysql+pymysql://root:password@localhost/my_db&quot;</span>)</span><br><span class="line"><span class="comment"># 改为：</span></span><br><span class="line">engine = create_engine(<span class="string">&quot;mysql+mysqlconnector://root:password@localhost/my_db&quot;</span>)</span><br></pre></td></tr></table></figure></li>
</ol>
</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>