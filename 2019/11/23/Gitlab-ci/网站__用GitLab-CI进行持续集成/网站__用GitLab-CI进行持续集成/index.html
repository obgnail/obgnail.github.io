<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;地址&quot;&gt;&lt;a href=&quot;#地址&quot; class=&quot;headerlink&quot; title=&quot;地址&quot;&gt;&lt;/a&gt;地址&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://linux.cn/article-9926-1.html&quot;&gt;什么是 CI/CD？&lt;/a&gt;"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>用GitLab-CI进行持续集成 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-none-link" href="/tags/Gitlab-ci/" rel="tag">Gitlab-ci</a></div><div class="post-time">2019-11-23</div></div></div><div class="container post-header"><h1>用GitLab-CI进行持续集成</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9C%B0%E5%9D%80"><span class="toc-number">1.</span> <span class="toc-text">地址</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90Continuous-Integration%EF%BC%88CI%EF%BC%89%E5%92%8C%E6%8C%81%E7%BB%AD%E4%BA%A4%E4%BB%98Continuous-Delivery%EF%BC%88CD%EF%BC%89"><span class="toc-number">1.1.</span> <span class="toc-text">持续集成Continuous Integration（CI）和持续交付Continuous Delivery（CD）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%80%9C%E6%8C%81%E7%BB%AD%E2%80%9D%E6%98%AF%E4%BB%80%E4%B9%88%E6%84%8F%E6%80%9D%EF%BC%9F"><span class="toc-number">1.1.1.</span> <span class="toc-text">“持续”是什么意思？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E2%80%9C%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E2%80%9D%EF%BC%9F"><span class="toc-number">1.1.2.</span> <span class="toc-text">什么是“持续集成”？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E2%80%9C%E6%8C%81%E7%BB%AD%E9%83%A8%E7%BD%B2%E2%80%9D%EF%BC%9F"><span class="toc-number">1.1.3.</span> <span class="toc-text">什么是“持续部署”？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E5%92%8C%E9%83%A8%E7%BD%B2%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">1.2.</span> <span class="toc-text">持续集成和部署完整流程图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GitLab-CI-%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">1.3.</span> <span class="toc-text">GitLab CI 是什么？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Gitlab-Runner"><span class="toc-number">1.4.</span> <span class="toc-text">Gitlab Runner</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.4.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Runner%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.4.2.</span> <span class="toc-text">Runner类型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-number">1.5.</span> <span class="toc-text">相关概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%A1%E9%81%93%EF%BC%88pipeline%EF%BC%89"><span class="toc-number">1.5.1.</span> <span class="toc-text">管道（pipeline）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B6%E6%AE%B5%EF%BC%88Stage%EF%BC%89"><span class="toc-number">1.5.2.</span> <span class="toc-text">阶段（Stage）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%9C%E4%B8%9A%EF%BC%88Job%EF%BC%89"><span class="toc-number">1.5.3.</span> <span class="toc-text">作业（Job）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GitLab-CI%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.6.</span> <span class="toc-text">GitLab CI的工作流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Job%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.7.</span> <span class="toc-text">Job执行流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.8.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-gitlab-ci-yml"><span class="toc-number">1.9.</span> <span class="toc-text">什么是.gitlab-ci.yml</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Job"><span class="toc-number">1.9.1.</span> <span class="toc-text">Job</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stages"><span class="toc-number">1.9.2.</span> <span class="toc-text">stages</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stage"><span class="toc-number">1.9.3.</span> <span class="toc-text">stage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#script"><span class="toc-number">1.9.4.</span> <span class="toc-text">script</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#image-%E5%92%8C-services"><span class="toc-number">1.9.5.</span> <span class="toc-text">image 和 services</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#before-script%E5%92%8Cafter-script"><span class="toc-number">1.9.6.</span> <span class="toc-text">before_script和after_script</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#only-%E5%92%8C-except"><span class="toc-number">1.9.7.</span> <span class="toc-text">only 和 except</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#variables"><span class="toc-number">1.9.8.</span> <span class="toc-text">variables</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cache"><span class="toc-number">1.9.9.</span> <span class="toc-text">cache</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#include"><span class="toc-number">1.9.10.</span> <span class="toc-text">include</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Job-artifacts"><span class="toc-number">1.9.11.</span> <span class="toc-text">Job.artifacts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Job-tags"><span class="toc-number">1.9.12.</span> <span class="toc-text">Job.tags</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Job-allow-failure"><span class="toc-number">1.9.13.</span> <span class="toc-text">Job.allow_failure</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Job-when"><span class="toc-number">1.9.14.</span> <span class="toc-text">Job.when</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Job-dependencies"><span class="toc-number">1.9.15.</span> <span class="toc-text">Job.dependencies</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Job-environment"><span class="toc-number">1.9.16.</span> <span class="toc-text">Job.environment</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E9%BB%98%E8%AE%A4%E5%8F%82%E6%95%B0"><span class="toc-number">1.10.</span> <span class="toc-text">设置默认参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B1%87%E6%80%BB"><span class="toc-number">1.11.</span> <span class="toc-text">汇总</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.12.</span> <span class="toc-text">示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%B8%80"><span class="toc-number">1.12.1.</span> <span class="toc-text">示例一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%BA%8C"><span class="toc-number">1.12.2.</span> <span class="toc-text">示例二</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%B8%89"><span class="toc-number">1.12.3.</span> <span class="toc-text">示例三</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E5%9B%9B"><span class="toc-number">1.12.4.</span> <span class="toc-text">示例四</span></a></li></ol></li></ol></li></ol></details></div><div class="container post-content"><h1 id="地址"><a href="#地址" class="headerlink" title="地址"></a>地址</h1><p><a target="_blank" rel="noopener" href="https://linux.cn/article-9926-1.html">什么是 CI/CD？</a></p>
<p><a target="_blank" rel="noopener" href="https://choerodon.io/zh/blog/introduction-to-gitlab-ci/">GitLab CI介绍——入门篇</a></p>
<p><a target="_blank" rel="noopener" href="https://scarletsky.github.io/2016/07/29/use-gitlab-ci-for-continuous-integration/">用 GitLab CI 进行持续集成</a></p>
<p><a target="_blank" rel="noopener" href="https://www.webq.top/doc/ci">Gitlab CI/CD管道配置参考</a></p>
<h2 id="持续集成Continuous-Integration（CI）和持续交付Continuous-Delivery（CD）"><a href="#持续集成Continuous-Integration（CI）和持续交付Continuous-Delivery（CD）" class="headerlink" title="持续集成Continuous Integration（CI）和持续交付Continuous Delivery（CD）"></a>持续集成Continuous Integration（CI）和持续交付Continuous Delivery（CD）</h2><p>工厂里的装配线以快速、自动化、可重复的方式从原材料生产出消费品。同样，软件交付管道以快速、自动化和可重复的方式从源代码生成发布版本。</p>
<ul>
<li>如何完成这项工作的总体设计称为<code>持续交付</code>（CD）。</li>
<li>启动装配线的过程称为<code>持续集成</code>（CI）。</li>
<li>确保质量的过程称为<code>持续测试</code>，</li>
<li>将最终产品提供给用户的过程称为<code>持续部署</code>。</li>
</ul>
<p>一些专家让这一切简单、顺畅、高效地运行，这些人被称为运维开发( DevOps )践行者。</p>
<h3 id="“持续”是什么意思？"><a href="#“持续”是什么意思？" class="headerlink" title="“持续”是什么意思？"></a>“持续”是什么意思？</h3><p>“持续”用于描述遵循我在此提到的许多不同流程实践。这并不意味着<code>一直在运行</code>，而是<code>随时可运行</code>。</p>
<h3 id="什么是“持续集成”？"><a href="#什么是“持续集成”？" class="headerlink" title="什么是“持续集成”？"></a>什么是“持续集成”？</h3><ul>
<li>持续集成（CI）是在源代码变更后自动检测、拉取、构建和（在大多数情况下）进行单元测试的过程。</li>
<li>持续集成是启动管道的环节（尽管某些预验证 —— 通常称为上线前检查pre-flight checks —— 有时会被归在持续集成之前）。</li>
<li><strong>持续集成的目标是快速确保开发人员新提交的变更是好的，并且适合在代码库中进一步使用</strong>。</li>
<li>持续集成的基本思想是<strong>让一个自动化过程监测一个或多个源代码仓库是否有变更。当变更被推送到仓库时，它会监测到更改、下载副本、构建并运行任何相关的单元测试。</strong></li>
</ul>
<h3 id="什么是“持续部署”？"><a href="#什么是“持续部署”？" class="headerlink" title="什么是“持续部署”？"></a>什么是“持续部署”？</h3><ul>
<li>持续部署（CD）是指<strong>能够自动提供持续交付管道中发布版本给最终用户使用</strong>的想法。根据用户的安装方式，可能是在云环境中自动部署、app 升级（如手机上的应用程序）、更新网站或只更新可用版本列表。</li>
<li>这里的一个重点是，仅仅因为可以进行持续部署并不意味着始终部署来自管道的每组可交付成果。它实际上指，通过管道每套可交付成果都被证明是“可部署的”。这在很大程度上是由持续测试的连续级别完成的（参见本文中的持续测试部分）。</li>
<li>管道构建的发布成果是否被部署可以通过人工决策，或利用在完全部署之前“试用”发布的各种方法来进行控制。</li>
</ul>
<h2 id="持续集成和部署完整流程图"><a href="#持续集成和部署完整流程图" class="headerlink" title="持续集成和部署完整流程图"></a>持续集成和部署完整流程图</h2><p><img src="/images/221380_01_devops%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B.jpg" alt="devops"></p>
<h2 id="GitLab-CI-是什么？"><a href="#GitLab-CI-是什么？" class="headerlink" title="GitLab CI 是什么？"></a>GitLab CI 是什么？</h2><ul>
<li>GitLab CI 是GitLab内置的进行持续集成的工具，只需要在仓库根目录下创建.gitlab-ci.yml 文件，并配置GitLab Runner；</li>
<li>每次提交的时候，gitlab将自动识别到.gitlab-ci.yml文件，并且使用Gitlab Runner执行该脚本。</li>
</ul>
<p><img src="/images/O1CN01kBFBAT1fRsNBSN0uR_!!2-rate.png_800x800.jpg" alt="Runner"></p>
<h2 id="Gitlab-Runner"><a href="#Gitlab-Runner" class="headerlink" title="Gitlab Runner"></a>Gitlab Runner</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><ul>
<li>GitLab-Runner就是一个用来执行.gitlab-ci.yml 脚本的工具。也就是用来构建任务的</li>
<li>可以理解成，<strong>Runner就像认真工作的工人，GitLab-CI就是管理工人的中心，所有工人都要在GitLab-CI里面注册，并且表明自己是为哪个项目服务。</strong>当相应的项目发生变化时，GitLab-CI就会通知相应的工人执行对应的脚本。</li>
</ul>
<blockquote>
<p>为什么不是 GitLab CI 来运行那些构建任务？ </p>
<ul>
<li>一般来说，构建任务都会占用很多的系统资源 (譬如编译代码)，而 GitLab CI 又是 GitLab 的一部分，如果由 GitLab CI 来运行构建任务的话，在执行构建任务的时候，GitLab 的性能会大幅下降。</li>
<li>GitLab CI 最大的作用是管理各个项目的构建状态，因此，运行构建任务这种浪费资源的事情就交给 GitLab Runner 来做</li>
<li>因为 GitLab Runner 可以安装到不同的机器上，所以在构建任务运行期间并不会影响到 GitLab 的性能</li>
</ul>
</blockquote>
<h3 id="Runner类型"><a href="#Runner类型" class="headerlink" title="Runner类型"></a>Runner类型</h3><p>GitLab-Runner可以分类两种类型：<code>Shared Runner</code>（共享型）和<code>Specific Runner</code>（指定型）。</p>
<ul>
<li>Shared Runner：所有工程都能够用的，且只有系统管理员能够创建。</li>
<li>Specific Runner：只有特定的项目可以使用。</li>
</ul>
<h2 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h2><h3 id="管道（pipeline）"><a href="#管道（pipeline）" class="headerlink" title="管道（pipeline）"></a>管道（pipeline）</h3><p>每个推送到 Gitlab 的提交都会产生一个与该提交关联的管道(pipeline)，若一次推送包含了多个提交，则管道与最后那个提交相关联，<strong>管道(pipeline)就是一个分成不同阶段(stage)的作业(job)的集合</strong>。</p>
<h3 id="阶段（Stage）"><a href="#阶段（Stage）" class="headerlink" title="阶段（Stage）"></a>阶段（Stage）</h3><p>阶段是对批量的作业的一个逻辑上的划分，每个 GitLab CI/CD 都必须包含至少一个 Stage。多个 Stage 是按照顺序执行的，如果其中任何一个 Stage 失败，则后续的 Stage 不会被执行，整个 CI 过程被认为失败。</p>
<p><img src="/images/4.png" alt="4"></p>
<p>以图中所示为例，整个 CI 环节包含三个 Stage：build、test 和deploy。</p>
<ul>
<li>build 被首先执行。如果发生错误，本次 CI 立刻失败；</li>
<li>test 在 build 成功执行完毕后执行。如果发生错误，本次 CI 立刻失败；</li>
<li>deploy 在 test 成功执行完毕后执行。如果发生错误，本次 CI 失败。</li>
</ul>
<h3 id="作业（Job）"><a href="#作业（Job）" class="headerlink" title="作业（Job）"></a>作业（Job）</h3><ul>
<li>作业就是运行器(Runner)要执行的指令集合，Job 被关联到一个 Stage。<strong>当一个 Stage 执行的时候，与其关联的所有 Job 都会被执行。</strong>在有足够运行器的前提下,同一阶段的所有作业会并发执行。作业状态与阶段状态是一样的，实际上，阶段的状态就是继承自作业的。</li>
<li>作业必须包含script（由Runner执行的shell脚本），随着项目越来越大，Job 越来越多，Job 中包含的重复逻辑可能会让配置文件臃肿不堪。.gitlab-ci.yml 中提供了 before_script 和 after_script 两个全局配置项。这两个配置项在所有 Job 的 script 执行前和执行后调用。</li>
<li>Job 的执行过程中往往会产生一些数据，默认情况下 GitLab Runner 会保存 Job 生成的这些数据，然后在下一个 Job 执行之前（甚至不局限于当次 CI/CD）将这些数据恢复。这样即便是不同的 Job 运行在不同的 Runner 上，它也能看到彼此生成的数据。</li>
</ul>
<h2 id="GitLab-CI的工作流程"><a href="#GitLab-CI的工作流程" class="headerlink" title="GitLab CI的工作流程"></a>GitLab CI的工作流程</h2><p><img src="/images/217990-a1768d803ceffec7.png" alt="流程图.png"></p>
<h2 id="Job执行流程"><a href="#Job执行流程" class="headerlink" title="Job执行流程"></a>Job执行流程</h2><p><img src="/images/7.png" alt="7"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>Gitlab-ci管理多个runner , 一个runner管理多个管道(每次commit都是一个管道)</li>
<li>一个管道有多个阶段 , 一个阶段有多个作业</li>
<li>同一个阶段的作业并发执行</li>
<li>作业必须包含script语句</li>
</ol>
<h2 id="什么是-gitlab-ci-yml"><a href="#什么是-gitlab-ci-yml" class="headerlink" title="什么是.gitlab-ci.yml"></a>什么是.gitlab-ci.yml</h2><p>.gitlab-ci.yml文件使用一系列约束叙述定义了Job启动时所要做的事情。</p>
<h3 id="Job"><a href="#Job" class="headerlink" title="Job"></a>Job</h3><ul>
<li><strong>Job是.gitlab-ci.yml文件中最基本的元素</strong>，由一系列参数定义了任务启动时所要做的事情，用户可以创建任意个任务；</li>
<li>每个任务必须有一个独一无二的名字，但有一些保留keywords不能用于Job名称，image，services，stages，types，before_script，after_script，variables，cache。</li>
<li>Job被定义为顶级元素，并且至少包括一条script语句，<strong>如果一个 Job 没有显式地关联某个 Stage，则会被默认关联到 test Stage</strong>。</li>
</ul>
<h3 id="stages"><a href="#stages" class="headerlink" title="stages"></a>stages</h3><ul>
<li><strong>用于定义所有作业(job)可以使用的全局阶段，</strong>gitlab-ci.yml允许灵活定义多个阶段，<strong>stages元素的顺序定义了作业执行的顺序</strong>。</li>
<li>同一阶段的job并行运行。下一阶段的job在上一阶段的job之后运行成功完成。</li>
<li>默认包含 build、test 和 deploy 三个 stage。</li>
<li>Stage 中并不能直接配置任何具体的执行逻辑，具体的执行逻辑应该在 Job 中配置。</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br></pre></td></tr></table></figure>



<h3 id="stage"><a href="#stage" class="headerlink" title="stage"></a>stage</h3><p>阶段是根据每个Job定义的，并且依赖于全局定义的阶段。它允许将作业(Job)分组到不同的阶段。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">job 1:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">script:</span> <span class="string">make</span> <span class="string">build</span> <span class="string">dependencies</span></span><br><span class="line"></span><br><span class="line"><span class="attr">job 2:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">script:</span> <span class="string">make</span> <span class="string">build</span> <span class="string">artifacts</span></span><br><span class="line"></span><br><span class="line"><span class="attr">job 3:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">script:</span> <span class="string">make</span> <span class="string">test</span></span><br><span class="line"></span><br><span class="line"><span class="attr">job 4:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">script:</span> <span class="string">make</span> <span class="string">deploy</span></span><br></pre></td></tr></table></figure>



<h3 id="script"><a href="#script" class="headerlink" title="script"></a>script</h3><p>script是一段由Runner执行的<code>shell脚本</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">job:</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">uname</span> <span class="string">-a</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">bundle</span> <span class="string">exec</span> <span class="string">rspec</span></span><br></pre></td></tr></table></figure>

<ul>
<li>有些时候，script命令需要被单引号或者双引号所包裹。</li>
<li>举个例子，命令中包涵冒号的时候，该命令需要被引号所包裹，这样YAML解析器才知道该命令语句不是“key: value”语法的一部分。</li>
<li>当命令中包涵以下字符时需要注意打引号:<code>: &#123; &#125; [ ] , &amp; * #? | - &lt; &gt; = ! % @</code> </li>
</ul>
<h3 id="image-和-services"><a href="#image-和-services" class="headerlink" title="image 和 services"></a>image 和 services</h3><p>这两个选项允许开发者指定任务运行时所需的自定义的<code>docker镜像</code>和<code>服务</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#为每个作业定义不同的映像和服务</span></span><br><span class="line"><span class="attr">test:2.1:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">ruby:2.1</span></span><br><span class="line">  <span class="attr">services:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">postgres:9.3</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">bundle</span> <span class="string">exec</span> <span class="string">rake</span> <span class="string">spec</span></span><br><span class="line"></span><br><span class="line"><span class="attr">test:2.2:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">ruby:2.2</span></span><br><span class="line">  <span class="attr">services:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">postgres:9.4</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">bundle</span> <span class="string">exec</span> <span class="string">rake</span> <span class="string">spec</span></span><br></pre></td></tr></table></figure>



<h3 id="before-script和after-script"><a href="#before-script和after-script" class="headerlink" title="before_script和after_script"></a>before_script和after_script</h3><ul>
<li>before_script是用于定义一些在所有任务执行前所需执行的命令, 包括部署工作，可以接受一个数组或者多行字符串。</li>
<li>after_script用于定义所有job执行过后需要执行的命令，可以接受一个数组或者多行字符串。</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#定义全局 before_script:</span></span><br><span class="line"><span class="attr">default:</span></span><br><span class="line">  <span class="attr">before_script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">global</span> <span class="string">before</span> <span class="string">script</span></span><br><span class="line"><span class="comment">#覆盖全局before_script</span></span><br><span class="line"><span class="attr">job:</span></span><br><span class="line">  <span class="attr">before_script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">execute</span> <span class="string">this</span> <span class="string">instead</span> <span class="string">of</span> <span class="string">global</span> <span class="string">before</span> <span class="string">script</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">my</span> <span class="string">command</span></span><br><span class="line">  <span class="attr">after_script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">execute</span> <span class="string">this</span> <span class="string">after</span> <span class="string">my</span> <span class="string">script</span></span><br></pre></td></tr></table></figure>



<h3 id="only-和-except"><a href="#only-和-except" class="headerlink" title="only 和 except"></a>only 和 except</h3><ul>
<li>only和except两个参数说明了job什么时候将会被创建</li>
<li>only定义了job需要执行的<code>所在分支</code>或者<code>标签</code></li>
<li>except定义了job不会执行的所在分支或者标签</li>
</ul>
<p>注意 :</p>
<ul>
<li>only和except如果都存在在一个job声明中，则所需引用将会被only和except所定义的分支过滤</li>
<li>only和except允许使用正则</li>
<li>only和except允许使用指定仓库地址，但是不forks仓库</li>
</ul>
<p>only和except允许使用以下一些特殊关键字：</p>
<table>
<thead>
<tr>
<th align="left">值</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">branches</td>
<td align="left">当一个分支被push上来</td>
</tr>
<tr>
<td align="left">tags</td>
<td align="left">当一个打了tag的分支被push上来</td>
</tr>
<tr>
<td align="left">api</td>
<td align="left">当一个pipline被piplines api所触发调起，详见piplines api（<a target="_blank" rel="noopener" href="https://docs.gitlab.com/ce/api/pipelines.html%EF%BC%89">https://docs.gitlab.com/ce/api/pipelines.html）</a></td>
</tr>
<tr>
<td align="left">external</td>
<td align="left">当使用了GitLab以外的CI服务</td>
</tr>
<tr>
<td align="left">pipelines</td>
<td align="left">针对多项目触发器而言，当使用CI_JOB_TOKEN并使用gitlab所提供的api创建多个pipelines的时候</td>
</tr>
<tr>
<td align="left">pushes</td>
<td align="left">当pipeline被用户的git push操作所触发的时候</td>
</tr>
<tr>
<td align="left">schedules</td>
<td align="left">针对预定好的pipline而言（每日构建一类~，具体请看<a target="_blank" rel="noopener" href="https://docs.gitlab.com/ce/user/project/pipelines/schedules.html%EF%BC%89">https://docs.gitlab.com/ce/user/project/pipelines/schedules.html）</a></td>
</tr>
<tr>
<td align="left">triggers</td>
<td align="left">用token创建piplines的时候</td>
</tr>
<tr>
<td align="left">web</td>
<td align="left">在GitLab页面上Pipelines标签页下，你按了run pipline的时候</td>
</tr>
</tbody></table>
<p>job将会只在issue-开头的refs下执行，反之则其他所有分支被跳过：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">job:</span></span><br><span class="line">  <span class="comment"># use regexp</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/^issue-.*$/</span></span><br><span class="line">  <span class="comment"># use special keyword</span></span><br><span class="line">  <span class="attr">except:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">branches</span></span><br></pre></td></tr></table></figure>



<h3 id="variables"><a href="#variables" class="headerlink" title="variables"></a>variables</h3><ul>
<li><p>定义环境变量。 如果定义了 Job 级别的环境变量的话，该 Job 会优先使用 Job 级别的环境变量。</p>
</li>
<li><p>GitLab CI允许你为.gitlab-ci.yml增加变量，该变量将会被设置入任务环境。这些变量是你存储在git仓库里，并且<code>非敏感</code>的项目配置，例如:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">variables:</span></span><br><span class="line">    <span class="attr">DATABASE_URL:</span> <span class="string">&quot;postgres://postgres@postgres/my_database&quot;</span></span><br><span class="line"><span class="comment"># 注意:整数和字符串一样，对于设置变量名和变量值来说都是合法的。但浮点数是非法的。</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="cache"><a href="#cache" class="headerlink" title="cache"></a>cache</h3><ul>
<li>定义需要缓存的文件。 </li>
<li>每个 Job 开始的时候，Runner 都会删掉 <code>.gitignore</code> 里面的文件。 如果有些文件 (如 <code>node_modules/</code>) 需要多个 Jobs 共用的话，我们只能让每个 Job 都先执行一遍 <code>npm install</code>。 这样很不方便，因此我们需要对这些文件进行缓存。</li>
<li>缓存了的文件除了可以跨 Jobs 使用外，还<code>可以跨 Pipeline 使用</code>。</li>
</ul>
<h3 id="include"><a href="#include" class="headerlink" title="include"></a>include</h3><p>使用include关键字，可以允许包含外部yaml文件。include要求外部yaml文件具有扩展名.yml或.yaml，否则将不包括外部文件。</p>
<p>include中定义的文件：</p>
<ul>
<li><p>与.gitlab-ci.yml中的合并。</p>
</li>
<li><p>始终首先评估并与.gitlab-ci.yml的内容合并，而不管include关键字的位置如何。</p>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">include:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">local:</span> <span class="string">&#x27;/templates/.gitlab-ci-template.yml&#x27;</span></span><br></pre></td></tr></table></figure>



<h3 id="Job-artifacts"><a href="#Job-artifacts" class="headerlink" title="Job.artifacts"></a>Job.artifacts</h3><ul>
<li>定义 Job 中生成的附件。 </li>
<li>当该 Job 运行成功后，生成的文件可以作为附件 (如生成的二进制文件) 保留下来，打包发送到 GitLab，之后我们可以在 GitLab 的项目页面下下载该附件。 </li>
<li>注意，不要把 <code>artifacts</code> 和 <code>cache</code> 混淆了。</li>
</ul>
<p>传递所有binaries和.config：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">artifacts:</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">binaries/</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">.config</span></span><br></pre></td></tr></table></figure>



<h3 id="Job-tags"><a href="#Job-tags" class="headerlink" title="Job.tags"></a>Job.tags</h3><p>定义一列tags，用来指定选择哪个Runner（同时Runner也要设置tags）</p>
<blockquote>
<p>简单来讲 , <code>tags</code> 用来确定使用哪个 <code>runner</code> 运行当前Job，如果不设置的话将使用通用 <code>runner</code> 运行.</p>
</blockquote>
<p>给定一个带有标签OSX的Runner和带有标签的Windows运行程序Windows，以下job在各自的平台上运行：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">windows job:</span></span><br><span class="line">  <span class="attr">stage:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">windows</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">Hello,</span> <span class="string">%USERNAME%!</span></span><br><span class="line"></span><br><span class="line"><span class="attr">osx job:</span></span><br><span class="line">  <span class="attr">stage:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">osx</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Hello, $USER!&quot;</span></span><br></pre></td></tr></table></figure>



<h3 id="Job-allow-failure"><a href="#Job-allow-failure" class="headerlink" title="Job.allow_failure"></a>Job.allow_failure</h3><p>允许job失败。失败的job不影响commit状态</p>
<h3 id="Job-when"><a href="#Job-when" class="headerlink" title="Job.when"></a>Job.when</h3><p>定义何时开始job。可以是on_success，on_failure，always或者manual</p>
<ul>
<li><p>on_success-仅当<code>先前阶段</code>的所有job成功时执行job（或由于标记为“允许失败”而被视为成功）。这是默认设置。</p>
</li>
<li><p>on_failure-仅当先前阶段中的至少一个job失败时才执行job。</p>
</li>
<li><p>always-执行job，而不管先前阶段的job状态如何。</p>
</li>
<li><p>manual-手动执行job（在Gitlab 8.10中添加）。</p>
</li>
</ul>
<h3 id="Job-dependencies"><a href="#Job-dependencies" class="headerlink" title="Job.dependencies"></a>Job.dependencies</h3><p>定义job依赖关系，这样他们就可以互相传递artifacts</p>
<h3 id="Job-environment"><a href="#Job-environment" class="headerlink" title="Job.environment"></a>Job.environment</h3><p>定义此作业完成部署的环境名称</p>
<h2 id="设置默认参数"><a href="#设置默认参数" class="headerlink" title="设置默认参数"></a>设置默认参数</h2><p>某些参数可以全局设置为所有job的默认值，使用默认值：关键字。然后，默认参数可以被特定于job的参数覆盖配置。</p>
<p>可以在默认块内定义以下job参数：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">image</span></span><br><span class="line"><span class="string">services</span></span><br><span class="line"><span class="string">before_script</span></span><br><span class="line"><span class="string">after_script</span></span><br><span class="line"><span class="string">cache</span></span><br></pre></td></tr></table></figure>



<h2 id="汇总"><a href="#汇总" class="headerlink" title="汇总"></a>汇总</h2><table>
<thead>
<tr>
<th>Keyword</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>script</td>
<td>由运行程序执行的shell脚本。</td>
</tr>
<tr>
<td>image</td>
<td>使用Docker镜像。还提供：image:name和image:entrypoint。</td>
</tr>
<tr>
<td>services</td>
<td>使用Docker服务镜像。还提供：services:name、services:alias、services:entrypoint和services:command。</td>
</tr>
<tr>
<td>before_script</td>
<td>重写在job之前执行的一组命令。</td>
</tr>
<tr>
<td>after_script</td>
<td>重写在job后执行的一组命令。</td>
</tr>
<tr>
<td>stages</td>
<td>定义管道中的阶段。</td>
</tr>
<tr>
<td>stage</td>
<td>定义job阶段（default: test）。</td>
</tr>
<tr>
<td>only</td>
<td>限制创建 when jobs。还可用：only：refs，only：kubernetes，only：variables，only：changes。</td>
</tr>
<tr>
<td>except</td>
<td>限制未创建 when jobs。还可用：except:refs，except:kubernetes，except:variables和except:changes。</td>
</tr>
<tr>
<td>tags</td>
<td>用于选择运行程序的标记列表。</td>
</tr>
<tr>
<td>allow_failure</td>
<td>允许job失败。失败的job不影响提交状态。</td>
</tr>
<tr>
<td>when</td>
<td>何时运行job。还可用：when:manual and when:delayed。</td>
</tr>
<tr>
<td>environment</td>
<td>job部署到的环境的名称。还可用：environment:name, environment:url, environment:on_stop, and environment:action.</td>
</tr>
<tr>
<td>cache</td>
<td>在后续运行之间应缓存的文件列表。还可用：cache:paths, cache:key, cache:untracked, and cache:policy.。</td>
</tr>
<tr>
<td>artifacts</td>
<td>成功时要附加到job的文件和目录列表。还可用：artifacts:paths, artifacts:name, artifacts:untracked, artifacts:when, artifacts:expire_in, artifacts:reports, and artifacts:reports:junit。在Gitlab企业版中，这些可用：artifacts:reports:codequality, artifacts:reports:sast, artifacts:reports:dependency_scanning, artifacts:reports:container_scanning, artifacts:reports:dast, artifacts:reports:license_management, artifacts:reports:performance and artifacts:reports:metrics。</td>
</tr>
<tr>
<td>dependencies</td>
<td>job所依赖的其他job，以便在它们之间传递artifacts。</td>
</tr>
<tr>
<td>coverage</td>
<td>给定job的代码覆盖率设置。</td>
</tr>
<tr>
<td>retry</td>
<td>如果出现故障，一个job可以自动重试的时间和次数。</td>
</tr>
<tr>
<td>parallel</td>
<td>一个job应并行运行多少个实例。</td>
</tr>
<tr>
<td>trigger</td>
<td>定义下游管道触发器。</td>
</tr>
<tr>
<td>include</td>
<td>允许此job包含外部yaml文件。还提供：include:local、include:file、include:template和include:remote。</td>
</tr>
<tr>
<td>extends</td>
<td>此job将从中继承的配置项。</td>
</tr>
<tr>
<td>pages</td>
<td>上载job的结果以用于Gitlab页面。</td>
</tr>
<tr>
<td>variables</td>
<td>在job级别定义job变量。</td>
</tr>
</tbody></table>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><h3 id="示例一"><a href="#示例一" class="headerlink" title="示例一"></a>示例一</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">image:</span> <span class="string">python:3.7.0</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">postgres:12.0-alpine</span></span><br><span class="line"></span><br><span class="line"><span class="attr">variables:</span></span><br><span class="line">    <span class="attr">POSTGRES_DB:</span> <span class="string">zkyouxi_oa_test</span></span><br><span class="line">    <span class="attr">POSTGRES_USER:</span> <span class="string">postgres</span></span><br><span class="line">    <span class="attr">POSTGRES_PASSWORD:</span> <span class="string">liangbo4869</span></span><br><span class="line">    <span class="attr">POSTGRES_URL:</span> <span class="string">postgresql://$POSTGRES_USER:$POSTGRES_PASSWORD@postgres/$POSTGRES_DB</span></span><br><span class="line">    <span class="attr">PIP_CACHE_DIR:</span> <span class="string">&quot;~/.cache/pip/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">cache:</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">$&#123;PIP_CACHE_DIR&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">stages:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line"></span><br><span class="line"><span class="attr">build_job:</span></span><br><span class="line">    <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">    <span class="attr">script:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&#x27;build started&#x27;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&#x27;build finished&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">UnitTest_job:</span></span><br><span class="line">    <span class="attr">stage:</span> <span class="string">test</span></span><br><span class="line">    <span class="attr">before_script:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&#x27;UnitTest started&#x27;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">python</span> <span class="string">-m</span> <span class="string">venv</span> <span class="string">venv</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">source</span> <span class="string">venv/bin/activate</span></span><br><span class="line">        <span class="comment"># - pip install --upgrade pip</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">pip</span> <span class="string">install</span> <span class="string">-r</span> <span class="string">requirements.txt</span> <span class="string">-i</span> <span class="string">http://mirrors.aliyun.com/pypi/simple/</span> <span class="string">--trusted-host</span> <span class="string">mirrors.aliyun.com</span></span><br><span class="line">    <span class="attr">script:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">coverage</span> <span class="string">run</span> <span class="string">-m</span> <span class="string">pytest</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">coverage</span> <span class="string">report</span></span><br><span class="line">    </span><br><span class="line">    <span class="attr">after_script:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&#x27;UnitTest finished&#x27;</span></span><br><span class="line">    <span class="attr">only:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">test</span></span><br></pre></td></tr></table></figure>



<h3 id="示例二"><a href="#示例二" class="headerlink" title="示例二"></a>示例二</h3><p>下面是一个Ruby on Rails项目的示例。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">before_script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apt-get</span> <span class="string">update</span> <span class="string">-qq</span> <span class="string">&amp;&amp;</span> <span class="string">apt-get</span> <span class="string">install</span> <span class="string">-y</span> <span class="string">-qq</span> <span class="string">sqlite3</span> <span class="string">libsqlite3-dev</span> <span class="string">nodejs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ruby</span> <span class="string">-v</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">which</span> <span class="string">ruby</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">gem</span> <span class="string">install</span> <span class="string">bundler</span> <span class="string">--no-ri</span> <span class="string">--no-rdoc</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">bundle</span> <span class="string">install</span> <span class="string">--jobs</span> <span class="string">$(nproc)</span>  <span class="string">&quot;$&#123;FLAGS[@]&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">rspec:</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">bundle</span> <span class="string">exec</span> <span class="string">rspec</span></span><br><span class="line"></span><br><span class="line"><span class="attr">rubocop:</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">bundle</span> <span class="string">exec</span> <span class="string">rubocop</span></span><br></pre></td></tr></table></figure>

<ul>
<li>定义了两个jobs，<code>rspec</code>和<code>rubocop</code>（名字可以随便取），他们执行不同的命令。</li>
<li>在每个jobs之前，<code>before_script</code>定义的命令都将会被执行。</li>
</ul>
<ol>
<li><code>.gitlab-ci.yml</code>定义了一系列的jobs，其中包含如何运行和何时运行的限制。</li>
<li>jobs必须定义一个名称（在示例中分别是<code>rspec</code>和<code>rubocop</code>）作为顶级元素，而且总是必须包含<code>script</code>关键字。</li>
<li>Jobs被用来创建任务，它们会被Runners接受和环境中的Runner执行。</li>
</ol>
<h3 id="示例三"><a href="#示例三" class="headerlink" title="示例三"></a>示例三</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">install_deps</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy_test</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy_production</span></span><br><span class="line"></span><br><span class="line"><span class="attr">cache:</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">$&#123;CI_BUILD_REF_NAME&#125;</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">node_modules/</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">dist/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line"><span class="attr">install_deps:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">install_deps</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">develop</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行测试用例</span></span><br><span class="line"><span class="attr">test:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">develop</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">test</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译</span></span><br><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">develop</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">clean</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build:client</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build:server</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署测试服务器</span></span><br><span class="line"><span class="attr">deploy_test:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy_test</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">develop</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">pm2</span> <span class="string">delete</span> <span class="string">app</span> <span class="string">||</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">pm2</span> <span class="string">start</span> <span class="string">app.js</span> <span class="string">--name</span> <span class="string">app</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署生产服务器</span></span><br><span class="line"><span class="attr">deploy_production:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy_production</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">bash</span> <span class="string">scripts/deploy/deploy.sh</span></span><br></pre></td></tr></table></figure>

<p>上面的配置把一次 Pipeline 分成五个阶段：</p>
<ul>
<li>安装依赖(<code>install_deps</code>)</li>
<li>运行测试(<code>test</code>)</li>
<li>编译(<code>build</code>)</li>
<li>部署测试服务器(<code>deploy_test</code>)</li>
<li>部署生产服务器(<code>deploy_production</code>)</li>
</ul>
<h3 id="示例四"><a href="#示例四" class="headerlink" title="示例四"></a>示例四</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">redis:alpine</span></span><br><span class="line"></span><br><span class="line"><span class="attr">variables:</span></span><br><span class="line">  <span class="attr">PIP_CACHE_DIR:</span> <span class="string">&quot;$CI_PROJECT_DIR/.cache/pip&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">cache:</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">$CI_JOB_NAME-$CI_COMMIT_REF_SLUG</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">$&#123;PIP_CACHE_DIR&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">test_job:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">python:3.7</span></span><br><span class="line">  <span class="attr">before_script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">pip</span> <span class="string">install</span> <span class="string">-r</span> <span class="string">test-requirements.txt</span> <span class="string">-i</span> <span class="string">http://mirrors.aliyun.com/pypi/simple/</span> <span class="string">--trusted-host</span> <span class="string">mirrors.aliyun.com</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Test started.&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">coverage</span> <span class="string">run</span> <span class="string">--source</span> <span class="string">app</span> <span class="string">-m</span> <span class="string">pytest</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">coverage</span> <span class="string">report</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Test finished.&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy_job:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">manual</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">&quot;instrumentisto/rsync-ssh&quot;</span></span><br><span class="line">  <span class="attr">before_script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">target_address=172.16.1.61</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ssh-keyscan</span> <span class="string">$&#123;target_address&#125;</span> <span class="string">&gt;</span> <span class="string">~/.ssh/known_hosts</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">chmod</span> <span class="number">644</span> <span class="string">~/.ssh/known_hosts</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Deploy started.&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">project_name=op-gateway</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">stage_srv=root@$&#123;target_address&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">work_dir=/root/apps/operat-platform</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">rsync</span> <span class="string">-arzv</span> <span class="string">--exclude=&#x27;*.git&#x27;</span> <span class="string">./</span> <span class="string">$&#123;stage_srv&#125;:$&#123;work_dir&#125;/$&#123;project_name&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ssh</span> <span class="string">$&#123;stage_srv&#125;</span> <span class="string">&quot;chmod 755 $&#123;work_dir&#125;/$&#123;project_name&#125;&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ssh</span> <span class="string">$&#123;stage_srv&#125;</span> <span class="string">&quot;docker-compose -f $&#123;work_dir&#125;/$&#123;project_name&#125;/docker-compose.yml up -d --build&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ssh</span> <span class="string">$&#123;stage_srv&#125;</span> <span class="string">&quot;docker-compose -f $&#123;work_dir&#125;/$&#123;project_name&#125;/docker-compose.yml ps&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;Deploy finished.&quot;</span></span><br></pre></td></tr></table></figure>









































</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>