<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="gure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;golang.org/x/crypto/ssh&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;



&lt;h2 id=&quot;发送指令执行-session-Run&quot;&gt;&lt;a href=&quot;#发送指令执行-session-Run&quot; class=&quot;headerlink&quot; title=&quot;发送指令执行 session.Run()&quot;&gt;&lt;/a&gt;发送指令执行 session.Run()&lt;/h2&gt;&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&amp;quot;bytes&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&amp;quot;fmt&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&amp;quot;golang.org/x/crypto/ssh&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&amp;quot;log&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 建立SSH客户端连接&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    client, err := ssh.Dial(&lt;span class=&quot;string&quot;&gt;&amp;quot;tcp&amp;quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;127.0.0.1:2222&amp;quot;&lt;/span&gt;, &amp;amp;ssh.ClientConfig&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        User:            &lt;span class=&quot;string&quot;&gt;&amp;quot;root&amp;quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        Auth:            []ssh.AuthMethod&amp;#123;ssh.Password(&lt;span class=&quot;string&quot;&gt;&amp;quot;123456&amp;quot;&lt;/span&gt;)&amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        HostKeyCallback: ssh.InsecureIgnoreHostKey(),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      	&lt;span class=&quot;comment&quot;&gt;// Timeout: time.Second, //ssh 连接timeout时间一秒钟, 如果ssh验证错误，会在一秒内返回&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        log.Fatalf(&lt;span class=&quot;string&quot;&gt;&amp;quot;SSH dial error: %s&amp;quot;&lt;/span&gt;, err.Error())&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 建立新会话&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// A Session only accepts one call to Run, Start, Shell, Output, or CombinedOutput.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  	&lt;span class=&quot;comment&quot;&gt;// session只能执行一次Run, Start, Shell, Output, or CombinedOutput&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    session, err := client.NewSession()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        log.Fatalf(&lt;span class=&quot;string&quot;&gt;&amp;quot;new session error: %s&amp;quot;&lt;/span&gt;, err.Error())&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;defer&lt;/span&gt; session.Close()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt; b bytes.Buffer&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    session.Stdout = &amp;amp;b&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  	&lt;span class=&quot;comment&quot;&gt;//  Session.Run allows only one command per session &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; err := session.Run(&lt;span class=&quot;string&quot;&gt;&amp;quot;ls&amp;quot;&lt;/span&gt;); err != &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;panic&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&amp;quot;Failed to run: &amp;quot;&lt;/span&gt; + err.Error())&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    fmt.Println(b.String())&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;



&lt;h2 id=&quot;发送指令执行-session-Output&quot;&gt;&lt;a href=&quot;#发送指令执行-session-Output&quot; class=&quot;headerlink&quot; title=&quot;发送指令执行 session.Output()&quot;&gt;&lt;/a&gt;发送指令执行 session.Output()&lt;/h2&gt;&lt;p&gt;session.run(command) 是直接在 host 执行命令，不关心执行结果。session.Output 是将执行命令之后的 Stdout 返回"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>ssh | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Golang/" rel="tag">Golang</a></div><div class="post-time">2022-01-18</div></div></div><div class="container post-header"><h1>ssh</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E6%8C%87%E4%BB%A4%E6%89%A7%E8%A1%8C-session-Run"><span class="toc-number">1.</span> <span class="toc-text">发送指令执行 session.Run()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E6%8C%87%E4%BB%A4%E6%89%A7%E8%A1%8C-session-Output"><span class="toc-number">2.</span> <span class="toc-text">发送指令执行 session.Output()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E6%8B%9F%E4%BA%A4%E4%BA%92-terminal"><span class="toc-number">3.</span> <span class="toc-text">模拟交互 terminal</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ssh-%E5%85%AC%E9%92%A5%E7%99%BB%E5%BD%95"><span class="toc-number">4.</span> <span class="toc-text">ssh 公钥登录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3-SSH-%E8%BF%9C%E7%A8%8B%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%E6%89%BE%E4%B8%8D%E5%88%B0%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">5.</span> <span class="toc-text">解决 SSH 远程执行命令找不到环境变量的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%80%9A%E8%BF%87-SSH-%E7%99%BB%E5%BD%95%E5%90%8E%E5%86%8D%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%E5%92%8C%E8%84%9A%E6%9C%AC"><span class="toc-number">5.1.</span> <span class="toc-text">1. 通过 SSH 登录后再执行命令和脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%80%9A%E8%BF%87-SSH-%E7%9B%B4%E6%8E%A5%E6%89%A7%E8%A1%8C%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E5%92%8C%E8%84%9A%E6%9C%AC"><span class="toc-number">5.2.</span> <span class="toc-text">2. 通过 SSH 直接执行远程命令和脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%BB%93%E8%AE%BA"><span class="toc-number">5.3.</span> <span class="toc-text">3. 结论</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E7%A4%BA%E4%BE%8B"><span class="toc-number">5.4.</span> <span class="toc-text">4.  示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%9C%A8-crypto-ssh-%E5%BA%93%E4%B8%AD%E8%AE%BE%E7%BD%AE%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">5.5.</span> <span class="toc-text">5. 在 crypto&#x2F;ssh 库中设置环境变量</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%9E%E4%BA%A4%E4%BA%92%E6%A8%A1%E5%BC%8F%E6%98%AF%E4%B8%8D%E8%83%BD%E4%BB%8E-shell-%E8%BF%9B%E5%85%A5%E5%88%B0%E5%8F%A6%E4%B8%80%E4%B8%AA-shell-%E7%9A%84"><span class="toc-number">6.</span> <span class="toc-text">非交互模式是不能从 shell 进入到另一个 shell 的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">7.</span> <span class="toc-text">Reference</span></a></li></ol></details></div><div class="container post-content"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">golang.org/x/crypto/ssh</span><br></pre></td></tr></table></figure>



<h2 id="发送指令执行-session-Run"><a href="#发送指令执行-session-Run" class="headerlink" title="发送指令执行 session.Run()"></a>发送指令执行 session.Run()</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;bytes&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;golang.org/x/crypto/ssh&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 建立SSH客户端连接</span></span><br><span class="line">    client, err := ssh.Dial(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;127.0.0.1:2222&quot;</span>, &amp;ssh.ClientConfig&#123;</span><br><span class="line">        User:            <span class="string">&quot;root&quot;</span>,</span><br><span class="line">        Auth:            []ssh.AuthMethod&#123;ssh.Password(<span class="string">&quot;123456&quot;</span>)&#125;,</span><br><span class="line">        HostKeyCallback: ssh.InsecureIgnoreHostKey(),</span><br><span class="line">      	<span class="comment">// Timeout: time.Second, //ssh 连接timeout时间一秒钟, 如果ssh验证错误，会在一秒内返回</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatalf(<span class="string">&quot;SSH dial error: %s&quot;</span>, err.Error())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 建立新会话</span></span><br><span class="line">    <span class="comment">// A Session only accepts one call to Run, Start, Shell, Output, or CombinedOutput.</span></span><br><span class="line">  	<span class="comment">// session只能执行一次Run, Start, Shell, Output, or CombinedOutput</span></span><br><span class="line">    session, err := client.NewSession()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatalf(<span class="string">&quot;new session error: %s&quot;</span>, err.Error())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">defer</span> session.Close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> b bytes.Buffer</span><br><span class="line">    session.Stdout = &amp;b</span><br><span class="line">  	<span class="comment">//  Session.Run allows only one command per session </span></span><br><span class="line">    <span class="keyword">if</span> err := session.Run(<span class="string">&quot;ls&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;Failed to run: &quot;</span> + err.Error())</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(b.String())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="发送指令执行-session-Output"><a href="#发送指令执行-session-Output" class="headerlink" title="发送指令执行 session.Output()"></a>发送指令执行 session.Output()</h2><p>session.run(command) 是直接在 host 执行命令，不关心执行结果。session.Output 是将执行命令之后的 Stdout 返回</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;golang.org/x/crypto/ssh&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">test</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 建立SSH客户端连接</span></span><br><span class="line">    client, err := ssh.Dial(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;127.0.0.1:2222&quot;</span>, &amp;ssh.ClientConfig&#123;</span><br><span class="line">        User:            <span class="string">&quot;root&quot;</span>,</span><br><span class="line">        Auth:            []ssh.AuthMethod&#123;ssh.Password(<span class="string">&quot;123456&quot;</span>)&#125;,</span><br><span class="line">        HostKeyCallback: ssh.InsecureIgnoreHostKey(),</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatalf(<span class="string">&quot;SSH dial error: %s&quot;</span>, err.Error())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 建立新会话</span></span><br><span class="line">    session, err := client.NewSession()</span><br><span class="line">    <span class="keyword">defer</span> session.Close()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatalf(<span class="string">&quot;new session error: %s&quot;</span>, err.Error())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    result, err := session.Output(<span class="string">&quot;ls -al&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Fprintf(os.Stdout, <span class="string">&quot;Failed to run command, Err:%s&quot;</span>, err.Error())</span><br><span class="line">        os.Exit(<span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(<span class="keyword">string</span>(result))</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//执行远程命令</span></span><br><span class="line">    combo,err := session.CombinedOutput(<span class="string">&quot;whoami; cd /; ls -al;echo https://github.com/dejavuzhou/felix&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(<span class="string">&quot;远程执行cmd 失败&quot;</span>,err)</span><br><span class="line">    &#125;</span><br><span class="line">    log.Println(<span class="string">&quot;命令输出:&quot;</span>,<span class="keyword">string</span>(combo))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="模拟交互-terminal"><a href="#模拟交互-terminal" class="headerlink" title="模拟交互 terminal"></a>模拟交互 terminal</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;golang.org/x/crypto/ssh&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 建立SSH客户端连接</span></span><br><span class="line">    client, err := ssh.Dial(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;127.0.0.1:2222&quot;</span>, &amp;ssh.ClientConfig&#123;</span><br><span class="line">        User:            <span class="string">&quot;root&quot;</span>,</span><br><span class="line">        Auth:            []ssh.AuthMethod&#123;ssh.Password(<span class="string">&quot;123456&quot;</span>)&#125;,</span><br><span class="line">        HostKeyCallback: ssh.InsecureIgnoreHostKey(),</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatalf(<span class="string">&quot;SSH dial error: %s&quot;</span>, err.Error())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 建立新会话</span></span><br><span class="line">    session, err := client.NewSession()</span><br><span class="line">    <span class="keyword">defer</span> session.Close()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatalf(<span class="string">&quot;new session error: %s&quot;</span>, err.Error())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    session.Stdout = os.Stdout  <span class="comment">// 会话输出关联到系统标准输出设备</span></span><br><span class="line">    session.Stderr = os.Stderr  <span class="comment">// 会话错误输出关联到系统标准错误输出设备</span></span><br><span class="line">    session.Stdin = os.Stdin    <span class="comment">// 会话输入关联到系统标准输入设备</span></span><br><span class="line">    modes := ssh.TerminalModes&#123;</span><br><span class="line">        ssh.ECHO:          <span class="number">0</span>,     <span class="comment">// 禁用回显（0禁用，1启动）</span></span><br><span class="line">        ssh.TTY_OP_ISPEED: <span class="number">14400</span>, <span class="comment">// input speed = 14.4kbaud</span></span><br><span class="line">        ssh.TTY_OP_OSPEED: <span class="number">14400</span>, <span class="comment">// output speed = 14.4kbaud</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err = session.RequestPty(<span class="string">&quot;linux&quot;</span>, <span class="number">32</span>, <span class="number">160</span>, modes); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatalf(<span class="string">&quot;request pty error: %s&quot;</span>, err.Error())</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err = session.Shell(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatalf(<span class="string">&quot;start shell error: %s&quot;</span>, err.Error())</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err = session.Wait(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatalf(<span class="string">&quot;return error: %s&quot;</span>, err.Error())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//如果不禁用回显</span><br><span class="line">[root@65a9c031a770 ~]# ls</span><br><span class="line">ls</span><br><span class="line">anaconda-ks.cfg</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//禁用回显</span><br><span class="line">[root@65a9c031a770 ~]# ls</span><br><span class="line">anaconda-ks.cfg</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<p>这里的 ssh.InsecureIgnoreHostKey 是不检查 host key，需要检查的话得参考 client 源码重写函数</p>
<h2 id="ssh-公钥登录"><a href="#ssh-公钥登录" class="headerlink" title="ssh 公钥登录"></a>ssh 公钥登录</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SSHConnect</span><span class="params">(user, host <span class="keyword">string</span>, port <span class="keyword">int</span>)</span> <span class="params">(*ssh.Client, error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        addr         <span class="keyword">string</span></span><br><span class="line">        clientConfig *ssh.ClientConfig</span><br><span class="line">        client       *ssh.Client</span><br><span class="line">        err          error</span><br><span class="line">    )</span><br><span class="line">         </span><br><span class="line">    homePath, err := os.UserHomeDir()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    key, err := ioutil.ReadFile(path.Join(homePath, <span class="string">&quot;.ssh&quot;</span>, <span class="string">&quot;id_rsa&quot;</span>))</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    signer, err := ssh.ParsePrivateKey(key)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    clientConfig = &amp;ssh.ClientConfig&#123;</span><br><span class="line">        User: user,</span><br><span class="line">        Auth: []ssh.AuthMethod&#123;</span><br><span class="line">            ssh.PublicKeys(signer),</span><br><span class="line">        &#125;,</span><br><span class="line">        Timeout:         <span class="number">30</span> * time.Second,</span><br><span class="line">        HostKeyCallback: ssh.InsecureIgnoreHostKey(),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// connet to ssh</span></span><br><span class="line">    addr = fmt.Sprintf(<span class="string">&quot;%s:%d&quot;</span>, host, port)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> client, err = ssh.Dial(<span class="string">&quot;tcp&quot;</span>, addr, clientConfig); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        err = errors.Wrapf(err, <span class="string">&quot;&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> client, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;golang.org/x/crypto/ssh&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> privateKey = <span class="string">`content of id_rsa`</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	signer, _ := ssh.ParsePrivateKey([]<span class="keyword">byte</span>(privateKey))</span><br><span class="line">	clientConfig := &amp;ssh.ClientConfig&#123;</span><br><span class="line">		User: <span class="string">&quot;jedy&quot;</span>,</span><br><span class="line">		Auth: []ssh.AuthMethod&#123;</span><br><span class="line">			ssh.PublicKeys(signer),</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	client, err := ssh.Dial(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;127.0.0.1:22&quot;</span>, clientConfig)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">&quot;Failed to dial: &quot;</span> + err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	session, err := client.NewSession()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">&quot;Failed to create session: &quot;</span> + err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> session.Close()</span><br><span class="line">  </span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		w, _ := session.StdinPipe()</span><br><span class="line">		<span class="keyword">defer</span> w.Close()</span><br><span class="line">		content := <span class="string">&quot;123456789\n&quot;</span></span><br><span class="line">		fmt.Fprintln(w, <span class="string">&quot;D0755&quot;</span>, <span class="number">0</span>, <span class="string">&quot;testdir&quot;</span>) <span class="comment">// mkdir</span></span><br><span class="line">		fmt.Fprintln(w, <span class="string">&quot;C0644&quot;</span>, <span class="built_in">len</span>(content), <span class="string">&quot;testfile1&quot;</span>)</span><br><span class="line">		fmt.Fprint(w, content)</span><br><span class="line">		fmt.Fprint(w, <span class="string">&quot;\x00&quot;</span>) <span class="comment">// transfer end with \x00</span></span><br><span class="line">		fmt.Fprintln(w, <span class="string">&quot;C0644&quot;</span>, <span class="built_in">len</span>(content), <span class="string">&quot;testfile2&quot;</span>)</span><br><span class="line">		fmt.Fprint(w, content)</span><br><span class="line">		fmt.Fprint(w, <span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">if</span> err := session.Run(<span class="string">&quot;/usr/bin/scp -tr ./&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">&quot;Failed to run: &quot;</span> + err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="解决-SSH-远程执行命令找不到环境变量的问题"><a href="#解决-SSH-远程执行命令找不到环境变量的问题" class="headerlink" title="解决 SSH 远程执行命令找不到环境变量的问题"></a><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhenyuyaodidiao/p/9287497.html">解决 SSH 远程执行命令找不到环境变量的问题</a></h2><ul>
<li>通过 SSH 执行远程主机的命令或脚本时，经常会出现找不到自定义环境变量的问题。但是，如果通过 SSH 登录远程主机，然后再执行相同的命令或脚本，那么此时执行又是成功的。</li>
<li>两种相似的方法，得到的结果却截然不同，看起来很诡异的现象，根本原因在于这两种方式使用的 bash 模式不同！</li>
</ul>
<h3 id="1-通过-SSH-登录后再执行命令和脚本"><a href="#1-通过-SSH-登录后再执行命令和脚本" class="headerlink" title="1. 通过 SSH 登录后再执行命令和脚本"></a>1. 通过 SSH 登录后再执行命令和脚本</h3><p>这种方式会使用 Bash 的 interactive + login shell 模式，这里面有两个概念需要解释：<code>interactive</code> 和 <code>login</code>。</p>
<ul>
<li><code>login</code>： 故名思义，即登陆。login shell 是指用户以非图形化界面或者以 ssh 登陆到机器上时获得的第一个 shell，简单些说就是需要输入用户名和密码的 shell。因此通常不管以何种方式登陆机器后用户获得的第一个 shell 就是 login shell。</li>
<li><code>interactive</code>： 意为交互式，这也很好理解，interactive shell 会有一个输入提示符，并且它的标准输入、输出和错误输出都会显示在控制台上。所以一般来说只要是需要用户交互的，即一个命令一个命令的输入的 shell 都是 interactive shell。而如果无需用户交互，它便是 non-interactive shell。通常来说如 <code>bash script.sh</code> 此类执行脚本的命令就会启动一个 non-interactive shell，它不需要与用户进行交互，执行完后它便会退出创建的 Shell。</li>
</ul>
<p>在 interactive + login shell 模式中，Shell 首先会加载 <code>/etc/profile</code> 文件，然后再尝试依次去加载下列三个配置文件之一，一旦找到其中一个便不再接着寻找：</p>
<ul>
<li>~/.bash_profile</li>
<li>~/.bash_login</li>
<li>~/.profile</li>
</ul>
<h3 id="2-通过-SSH-直接执行远程命令和脚本"><a href="#2-通过-SSH-直接执行远程命令和脚本" class="headerlink" title="2. 通过 SSH 直接执行远程命令和脚本"></a>2. 通过 SSH 直接执行远程命令和脚本</h3><p>这种方式会使用 Bash 的 non-interactive + non-login shell 模式，它会创建一个 shell，执行完脚本之后便退出，不再需要与用户交互。</p>
<p>no-login shell，顾名思义就是不是在登录 Linux 系统时启动的（比如你在命令行提示符上输入 bash 启动）。它不会去执行 <code>/etc/profile</code> 文件，而会去用户的 HOME 目录检查<code>.bashrc</code> 并加载。</p>
<p>系统执行 Shell 脚本的时候，就是属于这种 non-interactive shell。Bash 通过 <code>BASH_ENV</code> 环境变量来记录要加载的文件，默认情况下这个环境变量并没有设置。如果有指定文件，那么 Shell 会先去加载这个文件里面的内容，然后再开始执行 Shell 脚本。</p>
<h3 id="3-结论"><a href="#3-结论" class="headerlink" title="3. 结论"></a>3. 结论</h3><p>由此可见，如果要解决 SSH 远程执行命令时找不到自定义环境变量的问题，那么可以在登录用户的 HOME 目录的<code>.bashrc</code> 中添加需要的环境变量。</p>
<h3 id="4-示例"><a href="#4-示例" class="headerlink" title="4.  示例"></a>4.  示例</h3><p>当登录之后，直接在某台远程主机：10.0.63.9 上执行日期格式化的命令时，打印的是正确的，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@dev-appserver2 ~]<span class="comment"># buildTimeStamp=2017-09-27T16:58:47.291+08:00; buildTimeStampStr=$(date -d $buildTimeStamp &quot;+%y%m%d%H%M%S&quot;); echo $buildTimeStampStr</span></span><br><span class="line">170927165847</span><br></pre></td></tr></table></figure>



<p>当在另外一台主机（10.0.251.216）上远程执行 ssh 命令时，打印的结果不正确（差了八个时区），如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@host-10-0-251-216 ~]<span class="comment"># cat sshtime</span></span><br><span class="line">buildTimeStamp=2017-09-27T16:58:47.291+08:00; buildTimeStampStr=$(date -d <span class="variable">$buildTimeStamp</span> <span class="string">&quot;+%y%m%d%H%M%S&quot;</span>); <span class="built_in">echo</span> <span class="variable">$buildTimeStampStr</span></span><br><span class="line"></span><br><span class="line">[root@host-10-0-251-216 ~]<span class="comment"># a=`cat sshtime `</span></span><br><span class="line">[root@host-10-0-251-216 ~]<span class="comment"># echo $a</span></span><br><span class="line">buildTimeStamp=2017-09-27T16:58:47.291+08:00; buildTimeStampStr=$(date -d <span class="variable">$buildTimeStamp</span> <span class="string">&quot;+%y%m%d%H%M%S&quot;</span>); <span class="built_in">echo</span> <span class="variable">$buildTimeStampStr</span></span><br><span class="line">[root@host-10-0-251-216 ~]<span class="comment"># ssh root@10.0.63.9 $a</span></span><br><span class="line">root@10.0.63.9<span class="string">&#x27;s password:</span></span><br><span class="line"><span class="string">170927085847</span></span><br></pre></td></tr></table></figure>



<p>此时修改 10.0.63.9 上，root 根目录下的.bashrc 文件，增加 TZ 的设置，再次执行 ssh 打印的结果是正确的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@dev-appserver2 ~]<span class="comment"># cat .bashrc</span></span><br><span class="line"><span class="comment"># .bashrc</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># User specific aliases and functions</span></span><br><span class="line"> </span><br><span class="line"><span class="built_in">alias</span> rm=<span class="string">&#x27;rm -i&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> cp=<span class="string">&#x27;cp -i&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> mv=<span class="string">&#x27;mv -i&#x27;</span></span><br><span class="line"> </span><br><span class="line"><span class="built_in">export</span> TZ=<span class="string">&quot;Asia/Shanghai&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Source global definitions</span></span><br><span class="line"><span class="keyword">if</span> [ -f /etc/bashrc ]; <span class="keyword">then</span></span><br><span class="line">    . /etc/bashrc</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">[root@dev-appserver2 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@host-10-0-251-216 ~]<span class="comment"># ssh root@10.0.63.9 $a</span></span><br><span class="line">root@10.0.63.9<span class="string">&#x27;s password:</span></span><br><span class="line"><span class="string">170927165847</span></span><br></pre></td></tr></table></figure>

<h3 id="5-在-crypto-ssh-库中设置环境变量"><a href="#5-在-crypto-ssh-库中设置环境变量" class="headerlink" title="5. 在 crypto/ssh 库中设置环境变量"></a>5. 在 crypto/ssh 库中设置环境变量</h3><p>简单来说就是，需要执行<code>source /etc/profile</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;golang.org/x/crypto/ssh&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 建立SSH客户端连接</span></span><br><span class="line">	client, err := ssh.Dial(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;127.0.0.1:22&quot;</span>, &amp;ssh.ClientConfig&#123;</span><br><span class="line">		User:            <span class="string">&quot;heyingliang&quot;</span>,</span><br><span class="line">		Auth:            []ssh.AuthMethod&#123;ssh.Password(<span class="string">&quot;liangbo4869&quot;</span>)&#125;,</span><br><span class="line">		HostKeyCallback: ssh.InsecureIgnoreHostKey(),</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;SSH dial error: %s&quot;</span>, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 建立新会话</span></span><br><span class="line">	session, err := client.NewSession()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;new session error: %s&quot;</span>, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> session.Close()</span><br><span class="line"></span><br><span class="line">	combo,err := session.CombinedOutput(<span class="string">&quot;source /etc/profile; docker ps&quot;</span>)</span><br><span class="line">  <span class="comment">// 如果不使用source /etc/profile，只能如下:</span></span><br><span class="line">  <span class="comment">// combo,err := session.CombinedOutput(&quot;/usr/local/bin/docker ps&quot;)</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(<span class="string">&quot;远程执行cmd 失败&quot;</span>,err)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Println(<span class="string">&quot;命令输出:&quot;</span>,<span class="keyword">string</span>(combo))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="非交互模式是不能从-shell-进入到另一个-shell-的"><a href="#非交互模式是不能从-shell-进入到另一个-shell-的" class="headerlink" title="非交互模式是不能从 shell 进入到另一个 shell 的"></a>非交互模式是不能从 shell 进入到另一个 shell 的</h2><p>所以，执行<code>docker exec -i redis bash -c &quot;ls;pwd&quot;</code>。注意 exec 的参数是<code>-i</code>，而不是<code>-it</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;golang.org/x/crypto/ssh&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	client, err := ssh.Dial(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;127.0.0.1:22&quot;</span>, &amp;ssh.ClientConfig&#123;</span><br><span class="line">		User:            <span class="string">&quot;heyingliang&quot;</span>,</span><br><span class="line">		Auth:            []ssh.AuthMethod&#123;ssh.Password(<span class="string">&quot;liangbo4869&quot;</span>)&#125;,</span><br><span class="line">		HostKeyCallback: ssh.InsecureIgnoreHostKey(),</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;SSH dial error: %s&quot;</span>, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	session, err := client.NewSession()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;new session error: %s&quot;</span>, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> session.Close()</span><br><span class="line"></span><br><span class="line">	combo,err := session.CombinedOutput(<span class="string">`source /etc/profile; docker exec -i redis bash -c &quot;ls;pwd&quot;`</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(<span class="string">&quot;远程执行cmd 失败&quot;</span>,err)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Println(<span class="string">&quot;命令输出:&quot;</span>,<span class="keyword">string</span>(combo))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>使用 GO 语言灵活批量 ssh 登录服务器执行操作: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/findumars/p/5930584.html">https://www.cnblogs.com/findumars/p/5930584.html</a></p>
<p>github 一个非常好的 web ssh 项目： <a target="_blank" rel="noopener" href="https://github.com/libragen/felix">https://github.com/libragen/felix</a></p>
</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>