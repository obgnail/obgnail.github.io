<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;Binlog-简介&quot;&gt;&lt;a href=&quot;#Binlog-简介&quot; class=&quot;headerlink&quot; title=&quot;Binlog 简介&quot;&gt;&lt;/a&gt;Binlog 简介&lt;/h1&gt;&lt;ol&gt;
&lt;li&gt;binlog 是记录所有数据库表结构变更（例如CREATE、ALTER TABLE…）以及表数据修改（INSERT、UPDATE、DELETE…）的二进制日志。&lt;/li&gt;
&lt;li&gt;binlog不会记录SELECT和SHOW这类操作，因为这类操作对数据本身并没有修改，但你可以通过查询通用日志来查看MySQL执行过的所有语句。&lt;/li&gt;
&lt;li&gt;如果update操作没有造成数据变化，也是会记入binlog。&lt;/li&gt;
&lt;li&gt;实际上，mysql的主从复制就是依靠binlog进行同步的。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;MySQL中一般有以下几种日志："><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>MySQL binlog全解 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/MySQL/" rel="tag">MySQL</a></div><div class="post-time">2022-06-22</div></div></div><div class="container post-header"><h1>MySQL binlog全解</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Binlog-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">Binlog 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Binlog%E6%97%A5%E5%BF%97%E7%9A%84%E4%B8%A4%E4%B8%AA%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.1.</span> <span class="toc-text">Binlog日志的两个最重要的使用场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E7%94%A8-Binlog"><span class="toc-number">1.2.</span> <span class="toc-text">启用 Binlog</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E7%9A%84Binlog%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4"><span class="toc-number">1.3.</span> <span class="toc-text">常用的Binlog操作命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99-Binlog-%E7%9A%84%E6%97%B6%E6%9C%BA"><span class="toc-number">1.4.</span> <span class="toc-text">写 Binlog 的时机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Binlog-%E6%96%87%E4%BB%B6%E4%BB%A5%E5%8F%8A%E6%89%A9%E5%B1%95"><span class="toc-number">1.5.</span> <span class="toc-text">Binlog 文件以及扩展</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Binlog-%E7%9A%84%E6%97%A5%E5%BF%97%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.6.</span> <span class="toc-text">Binlog 的日志格式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Statement"><span class="toc-number">1.6.1.</span> <span class="toc-text">Statement</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Row"><span class="toc-number">1.6.2.</span> <span class="toc-text">Row</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mixed"><span class="toc-number">1.6.3.</span> <span class="toc-text">Mixed</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysqlbinlog-%E5%91%BD%E4%BB%A4%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">1.7.</span> <span class="toc-text">mysqlbinlog 命令的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Binlog-%E4%BA%8B%E4%BB%B6%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.8.</span> <span class="toc-text">Binlog 事件类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Binlog-%E4%BA%8B%E4%BB%B6%E7%9A%84%E7%BB%93%E6%9E%84"><span class="toc-number">1.9.</span> <span class="toc-text">Binlog 事件的结构</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MySQL-%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86%E5%9F%BA%E7%A1%80"><span class="toc-number">2.</span> <span class="toc-text">MySQL 复制原理基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#binlog-%E6%96%87%E4%BB%B6"><span class="toc-number">2.1.</span> <span class="toc-text">binlog 文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#binlog-%E6%96%87%E4%BB%B6%E7%BB%84%E6%88%90"><span class="toc-number">2.2.</span> <span class="toc-text">binlog 文件组成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#BINLOG-MAGIC"><span class="toc-number">2.2.1.</span> <span class="toc-text">BINLOG_MAGIC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#event"><span class="toc-number">2.2.2.</span> <span class="toc-text">event</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MySQL-binlog-event-%E8%A7%A3%E6%9E%90-%E2%80%94%E2%80%94-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-number">3.</span> <span class="toc-text">MySQL binlog event 解析 —— 基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#event-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-number">3.1.</span> <span class="toc-text">event 基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#event-%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.1.1.</span> <span class="toc-text">event 类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#event-%E7%B1%BB%E5%9E%8B%E5%90%AB%E4%B9%89"><span class="toc-number">3.1.2.</span> <span class="toc-text">event 类型含义</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#event-%E5%AD%97%E8%8A%82%E8%A7%A3%E6%9E%90"><span class="toc-number">3.2.</span> <span class="toc-text">event 字节解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#event-%E7%BB%84%E7%BB%87%E6%9E%B6%E6%9E%84"><span class="toc-number">3.2.1.</span> <span class="toc-text">event 组织架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#event-%E5%85%AC%E5%85%B1%E5%A4%B4%E9%83%A8"><span class="toc-number">3.2.2.</span> <span class="toc-text">event 公共头部</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MySQL-%E5%B8%B8%E8%A7%81-binlog-event-%E8%A7%A3%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">MySQL 常见 binlog event 解析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Format-description-event"><span class="toc-number">4.1.</span> <span class="toc-text">Format_description_event</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#post-header-%E9%83%A8%E5%88%86"><span class="toc-number">4.1.1.</span> <span class="toc-text">post-header 部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#event-body-%E9%83%A8%E5%88%86"><span class="toc-number">4.1.2.</span> <span class="toc-text">event-body 部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E8%A7%A3%E6%9E%90%E7%A4%BA%E4%BE%8B"><span class="toc-number">4.1.3.</span> <span class="toc-text">字节解析示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rotate-event"><span class="toc-number">4.2.</span> <span class="toc-text">Rotate_event</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#post-header-%E9%83%A8%E5%88%86-1"><span class="toc-number">4.2.1.</span> <span class="toc-text">post-header 部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#event-body-%E9%83%A8%E5%88%86-1"><span class="toc-number">4.2.2.</span> <span class="toc-text">event-body 部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E8%A7%A3%E6%9E%90%E7%A4%BA%E4%BE%8B-1"><span class="toc-number">4.2.3.</span> <span class="toc-text">字节解析示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Query-log-event"><span class="toc-number">4.3.</span> <span class="toc-text">Query_log_event</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#post-header-%E9%83%A8%E5%88%86-2"><span class="toc-number">4.3.1.</span> <span class="toc-text">post-header 部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#event-body-%E9%83%A8%E5%88%86-2"><span class="toc-number">4.3.2.</span> <span class="toc-text">event-body 部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E8%A7%A3%E6%9E%90%E7%A4%BA%E4%BE%8B-2"><span class="toc-number">4.3.3.</span> <span class="toc-text">字节解析示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rows-query-log-event"><span class="toc-number">4.4.</span> <span class="toc-text">Rows_query_log_event</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#post-header-%E9%83%A8%E5%88%86-3"><span class="toc-number">4.4.1.</span> <span class="toc-text">post-header 部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#event-body-%E9%83%A8%E5%88%86-3"><span class="toc-number">4.4.2.</span> <span class="toc-text">event-body 部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E8%A7%A3%E6%9E%90%E7%A4%BA%E4%BE%8B-3"><span class="toc-number">4.4.3.</span> <span class="toc-text">字节解析示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Table-map-event"><span class="toc-number">4.5.</span> <span class="toc-text">Table_map_event</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#post-header-%E9%83%A8%E5%88%86-4"><span class="toc-number">4.5.1.</span> <span class="toc-text">post-header 部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#event-body-%E9%83%A8%E5%88%86-4"><span class="toc-number">4.5.2.</span> <span class="toc-text">event-body 部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E8%A7%A3%E6%9E%90%E7%A4%BA%E4%BE%8B-4"><span class="toc-number">4.5.3.</span> <span class="toc-text">字节解析示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Write-rows-log-event"><span class="toc-number">4.6.</span> <span class="toc-text">Write_rows_log_event</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#post-header-%E9%83%A8%E5%88%86-5"><span class="toc-number">4.6.1.</span> <span class="toc-text">post-header 部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#event-body-%E9%83%A8%E5%88%86-5"><span class="toc-number">4.6.2.</span> <span class="toc-text">event-body 部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E8%A7%A3%E6%9E%90%E7%A4%BA%E4%BE%8B-5"><span class="toc-number">4.6.3.</span> <span class="toc-text">字节解析示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Update-rows-log-event"><span class="toc-number">4.7.</span> <span class="toc-text">Update_rows_log_event</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#post-header-%E9%83%A8%E5%88%86-6"><span class="toc-number">4.7.1.</span> <span class="toc-text">post-header 部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#event-body-%E9%83%A8%E5%88%86-6"><span class="toc-number">4.7.2.</span> <span class="toc-text">event-body 部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E8%A7%A3%E6%9E%90%E7%A4%BA%E4%BE%8B-6"><span class="toc-number">4.7.3.</span> <span class="toc-text">字节解析示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Delete-rows-log-event"><span class="toc-number">4.8.</span> <span class="toc-text">Delete_rows_log_event</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#post-header-%E9%83%A8%E5%88%86-7"><span class="toc-number">4.8.1.</span> <span class="toc-text">post-header 部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#event-body-%E9%83%A8%E5%88%86-7"><span class="toc-number">4.8.2.</span> <span class="toc-text">event-body 部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E8%A7%A3%E6%9E%90%E7%A4%BA%E4%BE%8B-7"><span class="toc-number">4.8.3.</span> <span class="toc-text">字节解析示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Xid-event"><span class="toc-number">4.9.</span> <span class="toc-text">Xid_event</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#post-header-%E9%83%A8%E5%88%86-8"><span class="toc-number">4.9.1.</span> <span class="toc-text">post-header 部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#event-body-%E9%83%A8%E5%88%86-8"><span class="toc-number">4.9.2.</span> <span class="toc-text">event-body 部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E8%A7%A3%E6%9E%90%E7%A4%BA%E4%BE%8B-8"><span class="toc-number">4.9.3.</span> <span class="toc-text">字节解析示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Gtid-log-event"><span class="toc-number">4.10.</span> <span class="toc-text">Gtid_log_event</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#post-header-%E9%83%A8%E5%88%86-9"><span class="toc-number">4.10.1.</span> <span class="toc-text">post-header 部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#event-body-%E9%83%A8%E5%88%86-9"><span class="toc-number">4.10.2.</span> <span class="toc-text">event-body 部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E8%A7%A3%E6%9E%90%E7%A4%BA%E4%BE%8B-9"><span class="toc-number">4.10.3.</span> <span class="toc-text">字节解析示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Previous-gtid-log-event"><span class="toc-number">4.11.</span> <span class="toc-text">Previous_gtid_log_event</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#post-header-%E9%83%A8%E5%88%86-10"><span class="toc-number">4.11.1.</span> <span class="toc-text">post-header 部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#event-body-%E9%83%A8%E5%88%86-10"><span class="toc-number">4.11.2.</span> <span class="toc-text">event-body 部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E8%A7%A3%E6%9E%90%E7%A4%BA%E4%BE%8B-10"><span class="toc-number">4.11.3.</span> <span class="toc-text">字节解析示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Anonymous-gtid-log-event"><span class="toc-number">4.12.</span> <span class="toc-text">Anonymous_gtid_log_event</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#post-header-%E9%83%A8%E5%88%86-11"><span class="toc-number">4.12.1.</span> <span class="toc-text">post-header 部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#event-body-%E9%83%A8%E5%88%86-11"><span class="toc-number">4.12.2.</span> <span class="toc-text">event-body 部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E8%A7%A3%E6%9E%90%E7%A4%BA%E4%BE%8B-11"><span class="toc-number">4.12.3.</span> <span class="toc-text">字节解析示例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MySQL-binlog-event-%E8%A7%A3%E6%9E%90%E5%AE%9E%E4%BE%8B"><span class="toc-number">5.</span> <span class="toc-text">MySQL binlog event 解析实例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9AINSERT-%E8%AF%AD%E5%8F%A5%E5%9C%A8-binlog-%E4%B8%AD-event-%E8%A1%A8%E7%8E%B0%E5%BD%A2%E5%BC%8F"><span class="toc-number">5.1.</span> <span class="toc-text">示例：INSERT 语句在 binlog 中 event 表现形式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ROW-%E6%A0%BC%E5%BC%8F%E4%B8%8B%E8%A1%A8%E7%8E%B0%E5%BD%A2%E5%BC%8F"><span class="toc-number">5.1.1.</span> <span class="toc-text">ROW 格式下表现形式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#STATEMENT-%E6%A0%BC%E5%BC%8F%E4%B8%8B%E8%A1%A8%E7%8E%B0%E5%BD%A2%E5%BC%8F"><span class="toc-number">5.1.2.</span> <span class="toc-text">STATEMENT 格式下表现形式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9AUPDATE-%E8%AF%AD%E5%8F%A5%E5%9C%A8-binlog-%E4%B8%AD-event-%E8%A1%A8%E7%8E%B0%E5%BD%A2%E5%BC%8F"><span class="toc-number">5.2.</span> <span class="toc-text">示例：UPDATE 语句在 binlog 中 event 表现形式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ROW-%E6%A0%BC%E5%BC%8F%E4%B8%8B%E8%A1%A8%E7%8E%B0%E5%BD%A2%E5%BC%8F-1"><span class="toc-number">5.2.1.</span> <span class="toc-text">ROW 格式下表现形式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#STATEMENT-%E6%A0%BC%E5%BC%8F%E4%B8%8B%E8%A1%A8%E7%8E%B0%E5%BD%A2%E5%BC%8F-1"><span class="toc-number">5.2.2.</span> <span class="toc-text">STATEMENT 格式下表现形式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9ADELETE-%E8%AF%AD%E5%8F%A5%E5%9C%A8-binlog-%E4%B8%AD-event-%E8%A1%A8%E7%8E%B0%E5%BD%A2%E5%BC%8F"><span class="toc-number">5.3.</span> <span class="toc-text">示例：DELETE 语句在 binlog 中 event 表现形式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ROW-%E6%A0%BC%E5%BC%8F%E4%B8%8B%E8%A1%A8%E7%8E%B0%E5%BD%A2%E5%BC%8F-2"><span class="toc-number">5.3.1.</span> <span class="toc-text">ROW 格式下表现形式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#STATEMENT-%E6%A0%BC%E5%BC%8F%E4%B8%8B%E8%A1%A8%E7%8E%B0%E5%BD%A2%E5%BC%8F-2"><span class="toc-number">5.3.2.</span> <span class="toc-text">STATEMENT 格式下表现形式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#binlog-checksum"><span class="toc-number">6.</span> <span class="toc-text">binlog checksum</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#reference"><span class="toc-number">7.</span> <span class="toc-text">reference</span></a></li></ol></details></div><div class="container post-content"><h1 id="Binlog-简介"><a href="#Binlog-简介" class="headerlink" title="Binlog 简介"></a>Binlog 简介</h1><ol>
<li>binlog 是记录所有数据库表结构变更（例如CREATE、ALTER TABLE…）以及表数据修改（INSERT、UPDATE、DELETE…）的二进制日志。</li>
<li>binlog不会记录SELECT和SHOW这类操作，因为这类操作对数据本身并没有修改，但你可以通过查询通用日志来查看MySQL执行过的所有语句。</li>
<li>如果update操作没有造成数据变化，也是会记入binlog。</li>
<li>实际上，mysql的主从复制就是依靠binlog进行同步的。</li>
</ol>
<p>MySQL中一般有以下几种日志：</p>
<table>
<thead>
<tr>
<th align="left">日志类型</th>
<th align="left">写入日志的信息</th>
</tr>
</thead>
<tbody><tr>
<td align="left">错误日志</td>
<td align="left">记录在启动，运行或停止mysqld时遇到的问题</td>
</tr>
<tr>
<td align="left">通用查询日志</td>
<td align="left">记录建立的客户端连接和执行的语句</td>
</tr>
<tr>
<td align="left">二进制日志</td>
<td align="left">记录更改数据的语句</td>
</tr>
<tr>
<td align="left">中继日志</td>
<td align="left">从复制主服务器接收的数据更改</td>
</tr>
<tr>
<td align="left">慢查询日志</td>
<td align="left">记录所有执行时间超过 <code>long_query_time</code> 秒的所有查询或不使用索引的查询</td>
</tr>
<tr>
<td align="left">DDL日志（元数据日志）</td>
<td align="left">元数据操作由DDL语句执行</td>
</tr>
</tbody></table>
<p>MySQL 的二进制日志 binlog 可以说是 MySQL 最重要的日志，它记录了所有的 <code>DDL</code> 和 <code>DML</code> 语句（除了数据查询语句select、show等），<strong>以事件形式记录</strong>，还包含语句所执行的消耗的时间，MySQL的二进制日志是事务安全型的。binlog 的主要目的是<strong>复制和恢复</strong>。</p>
<h2 id="Binlog日志的两个最重要的使用场景"><a href="#Binlog日志的两个最重要的使用场景" class="headerlink" title="Binlog日志的两个最重要的使用场景"></a>Binlog日志的两个最重要的使用场景</h2><ul>
<li><strong>MySQL主从复制</strong>：MySQL Replication在Master端开启binlog，Master把它的二进制日志传递给slaves来达到master-slave数据一致的目的</li>
<li><strong>数据恢复</strong>：通过使用 mysqlbinlog工具来使恢复数据</li>
</ul>
<h2 id="启用-Binlog"><a href="#启用-Binlog" class="headerlink" title="启用 Binlog"></a>启用 Binlog</h2><p>一般来说开启binlog日志大概会有1%的性能损耗。</p>
<p>启用binlog，通过配置 <code>/etc/my.cnf</code> 或 <code>/etc/mysql/mysql.conf.d/mysqld.cnf</code> 配置文件的 <code>log-bin</code> 选项：</p>
<p>在配置文件中加入 <code>log-bin</code> 配置，表示启用binlog，如果没有给定值，写成 <code>log-bin=</code>，则默认名称为主机名。（注：名称若带有小数点，则只取第一个小数点前的部分作为名称）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">log-bin=my-binlog-name</span><br></pre></td></tr></table></figure>

<p>也可以通过 <code>SET SQL_LOG_BIN=1</code> 命令来启用 binlog，通过 <code>SET SQL_LOG_BIN=0</code> 命令停用 binlog。启用 binlog 之后须重启MySQL才能生效。</p>
<h2 id="常用的Binlog操作命令"><a href="#常用的Binlog操作命令" class="headerlink" title="常用的Binlog操作命令"></a>常用的Binlog操作命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 是否启用binlog日志</span></span><br><span class="line">show variables like <span class="string">&#x27;log_bin&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看详细的日志配置信息</span></span><br><span class="line">show global variables like <span class="string">&#x27;%log%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># mysql数据存储目录</span></span><br><span class="line">show variables like <span class="string">&#x27;%dir%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看binlog的目录</span></span><br><span class="line">show global variables like <span class="string">&quot;%log_bin%&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前服务器使用的biglog文件及大小</span></span><br><span class="line">show binary logs;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看主服务器使用的biglog文件及大小</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看最新一个binlog日志文件名称和Position</span></span><br><span class="line">show master status;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 事件查询命令</span></span><br><span class="line"><span class="comment"># IN &#x27;log_name&#x27; ：指定要查询的binlog文件名(不指定就是第一个binlog文件)</span></span><br><span class="line"><span class="comment"># FROM pos ：指定从哪个pos起始点开始查起(不指定就是从整个文件首个pos点开始算)</span></span><br><span class="line"><span class="comment"># LIMIT [offset,] ：偏移量(不指定就是0)</span></span><br><span class="line"><span class="comment"># row_count ：查询总条数(不指定就是所有行)</span></span><br><span class="line">show binlog events [IN <span class="string">&#x27;log_name&#x27;</span>] [FROM pos] [LIMIT [offset,] row_count];</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 binlog 内容</span></span><br><span class="line">show binlog events;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看具体一个binlog文件的内容 （in 后面为binlog的文件名）</span></span><br><span class="line">show binlog events <span class="keyword">in</span> <span class="string">&#x27;master.000003&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置binlog文件保存事件，过期删除，单位天</span></span><br><span class="line"><span class="built_in">set</span> global expire_log_days=3; </span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除当前的binlog文件</span></span><br><span class="line">reset master; </span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除slave的中继日志</span></span><br><span class="line">reset slave;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除指定日期前的日志索引中binlog日志文件</span></span><br><span class="line">purge master logs before <span class="string">&#x27;2019-03-09 14:00:00&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除指定日志文件</span></span><br><span class="line">purge master logs to <span class="string">&#x27;master.000003&#x27;</span>;</span><br></pre></td></tr></table></figure>



<h2 id="写-Binlog-的时机"><a href="#写-Binlog-的时机" class="headerlink" title="写 Binlog 的时机"></a>写 Binlog 的时机</h2><p>对支持事务的引擎如InnoDB而言，必须要提交了事务才会记录binlog。binlog 什么时候<strong>刷新到磁盘</strong>跟参数 <code>sync_binlog</code> 相关。</p>
<ul>
<li>如果设置为0，则表示MySQL不控制binlog的刷新，由文件系统去控制它缓存的刷新；</li>
<li>如果设置为不为0的值，则表示每 <code>sync_binlog</code> 次事务，MySQL调用文件系统的刷新操作刷新binlog到磁盘中。</li>
<li>设为1是最安全的，在系统故障时最多丢失一个事务的更新，但是会对性能有所影响。</li>
</ul>
<blockquote>
<p>如果 <code>sync_binlog=0</code> 或 <code>sync_binlog大于1</code>，当发生电源故障或操作系统崩溃时，可能有一部分已提交但其binlog未被同步到磁盘的事务会被丢失，恢复程序将无法恢复这部分事务。</p>
</blockquote>
<p>在MySQL 5.7.7之前，默认值 sync_binlog 是0，MySQL 5.7.7和更高版本使用默认值1，这是最安全的选择。一般情况下会设置为100或者0，牺牲一定的一致性来获取更好的性能。</p>
<h2 id="Binlog-文件以及扩展"><a href="#Binlog-文件以及扩展" class="headerlink" title="Binlog 文件以及扩展"></a>Binlog 文件以及扩展</h2><p>binlog日志包括两类文件:</p>
<ul>
<li>二进制日志索引文件（文件名后缀为.index）用于记录所有有效的的二进制文件</li>
<li>二进制日志文件（文件名后缀为.00000*）记录数据库所有的DDL和DML语句事件</li>
</ul>
<p>binlog是一个二进制文件集合，每个binlog文件以一个4字节的魔数开头，接着是一组Events:</p>
<ul>
<li>魔数：0xfe62696e对应的是0xfebin；</li>
<li>Event：每个Event包含header和data两个部分；<ul>
<li>header提供了Event的创建时间，哪个服务器等信息，</li>
<li>data部分提供的是针对该Event的具体信息，如具体数据的修改；</li>
</ul>
</li>
<li>第一个Event用于描述binlog文件的格式版本，这个格式就是event写入binlog文件的格式；</li>
<li>其余的Event按照第一个Event的格式版本写入；</li>
<li>最后一个Event用于说明下一个binlog文件；</li>
<li>binlog的索引文件是一个文本文件，其中内容为当前的binlog文件列表</li>
</ul>
<p>当遇到以下3种情况时，MySQL会重新生成一个新的日志文件，文件序号递增：</p>
<ul>
<li>MySQL服务器停止或重启时</li>
<li>使用 <code>flush logs</code> 命令；</li>
<li>当 binlog 文件大小超过 <code>max_binlog_size</code> 变量的值时；</li>
</ul>
<blockquote>
<p><code>max_binlog_size</code> 的最小值是4096字节，最大值和默认值是 1GB (1073741824字节)。</p>
<p>一个事务一定会在同一份binlog文件，不会被拆分。因此，如果你有很大的事务，为了保证事务的完整性，不可能做切换日志的动作，只能将该事务的日志都记录到当前日志文件中，直到事务结束，所以可能会出现binlog文件大于 max_binlog_size 的情况。</p>
</blockquote>
<h2 id="Binlog-的日志格式"><a href="#Binlog-的日志格式" class="headerlink" title="Binlog 的日志格式"></a>Binlog 的日志格式</h2><p>记录在二进制日志中的事件的格式取决于二进制记录格式。支持三种格式类型：</p>
<ul>
<li>STATEMENT：基于SQL语句的复制（statement-based replication, SBR）</li>
<li>ROW：基于行的复制（row-based replication, RBR）</li>
<li>MIXED：混合模式复制（mixed-based replication, MBR）</li>
</ul>
<blockquote>
<ul>
<li><code>STATEMENT 模式</code>只记录了 sql 语句，但是没有记录上下文信息，在进行数据恢复的时候可能会导致数据的丢失情况</li>
<li><code>ROW 模式</code>除了记录 sql 语句之外，还会记录每个字段的变化情况，能够清楚的记录每行数据的变化历史，但是会占用较多的空间，需要使用 mysqlbinlog 工具进行查看。</li>
<li><code>MIX 模式</code>比较灵活的记录，例如说当遇到了表结构变更的时候，就会记录为 statement 模式。当遇到了数据更新或者删除情况下就会变为 row 模式</li>
</ul>
</blockquote>
<p>在 <code>MySQL 5.7.7</code> 之前，默认的格式是 <code>STATEMENT</code>，在 <code>MySQL 5.7.7</code> 及更高版本中，默认值是 <code>ROW</code>。</p>
<p>日志格式通过 <code>binlog-format</code> 指定，如 <code>binlog-format=STATEMENT</code>、<code>binlog-format=ROW</code>、<code>binlog-format=MIXED</code>。</p>
<p>设置mysql的binlog日志格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> global binlog_format=<span class="string">&#x27;mixed&#x27;</span></span><br></pre></td></tr></table></figure>



<h3 id="Statement"><a href="#Statement" class="headerlink" title="Statement"></a>Statement</h3><p>记录mysql中每一条会修改数据的sql语句</p>
<ul>
<li>优点：不需要记录每一行的变化，减少了binlog日志量，节约了IO，提高了性能。</li>
<li>缺点：由于记录的只是执行语句，为了这些语句能在slave上正确运行，因此还必须记录每条语句在执行的时候的一些相关信息，以保证所有语句能在slave得到和在master端执行的时候相同的结果。另外mysql的复制，像一些特定函数的功能，slave与master要保持一致会有很多相关问题。</li>
</ul>
<h3 id="Row"><a href="#Row" class="headerlink" title="Row"></a>Row</h3><p>5.1.5版本的MySQL才开始支持 <code>row level</code> 的复制，它不记录sql语句上下文相关信息，仅保存哪条记录被修改。</p>
<ul>
<li>优点： binlog中可以不记录执行的sql语句的上下文相关的信息，仅需要记录那一条记录被修改成什么了。所以row的日志内容会非常清楚的记录下每一行数据修改的细节。而且不会出现某些特定情况下的存储过程，或function，以及trigger的调用和触发无法被正确复制的问题.</li>
<li>缺点：所有的执行的语句当记录到日志中的时候，都将以每行记录的修改来记录，这样可能会产生大量的日志内容。</li>
</ul>
<blockquote>
<p>注：将二进制日志格式设置为ROW时，有些更改仍然使用基于语句的格式，包括所有DDL语句，例如CREATE TABLE， ALTER TABLE，或 DROP TABLE。</p>
</blockquote>
<h3 id="Mixed"><a href="#Mixed" class="headerlink" title="Mixed"></a>Mixed</h3><p>从5.1.8版本开始，MySQL提供了Mixed格式，实际上就是Statement与Row的结合。</p>
<p>在Mixed模式下，一般的语句修改使用statment格式保存binlog，如一些函数，statement无法完成主从复制的操作，则采用row格式保存binlog，MySQL会根据执行的每一条具体的sql语句来区分对待记录的日志形式，也就是<strong>在Statement和Row之间选择一种</strong>。</p>
<h2 id="mysqlbinlog-命令的使用"><a href="#mysqlbinlog-命令的使用" class="headerlink" title="mysqlbinlog 命令的使用"></a>mysqlbinlog 命令的使用</h2><p>服务器以二进制格式将binlog日志写入binlog文件，如何要以文本格式显示其内容，可以使用 mysqlbinlog 命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mysqlbinlog 的执行格式</span></span><br><span class="line">mysqlbinlog [options] log_file ...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看bin-log二进制文件（shell方式）</span></span><br><span class="line">mysqlbinlog -v --base64-output=decode-rows /var/lib/mysql/master.000003</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看bin-log二进制文件（带查询条件）</span></span><br><span class="line">mysqlbinlog -v --base64-output=decode-rows /var/lib/mysql/master.000003 \</span><br><span class="line">    --start-datetime=<span class="string">&quot;2019-03-01 00:00:00&quot;</span>  \</span><br><span class="line">    --stop-datetime=<span class="string">&quot;2019-03-10 00:00:00&quot;</span>   \</span><br><span class="line">    --start-position=<span class="string">&quot;5000&quot;</span>    \</span><br><span class="line">    --stop-position=<span class="string">&quot;20000&quot;</span></span><br></pre></td></tr></table></figure>

<p>设置日志格式为ROW时，在我的机器上输出了以下信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=1*/;</span><br><span class="line">/*!50003 SET @OLD_COMPLETION_TYPE=@@COMPLETION_TYPE,COMPLETION_TYPE=0*/;</span><br><span class="line">DELIMITER /*!*/;</span><br><span class="line"># at 4</span><br><span class="line">#190308 10:05:03 server id 1  end_log_pos 123 CRC32 0xff02e23d     Start: binlog v 4, server v 5.7.22-log created 190308 10:05:03</span><br><span class="line"># Warning: this binlog is either in use or was not closed properly.</span><br><span class="line"># at 123</span><br><span class="line">#190308 10:05:03 server id 1  end_log_pos 154 CRC32 0xb81da4c5     Previous-GTIDs</span><br><span class="line"># [empty]</span><br><span class="line"># at 154</span><br><span class="line">#190308 10:05:09 server id 1  end_log_pos 219 CRC32 0xfb30d42c     Anonymous_GTID    last_committed=0    sequence_number=1    rbr_only=yes</span><br><span class="line">/*!50718 SET TRANSACTION ISOLATION LEVEL READ COMMITTED*//*!*/;</span><br><span class="line">SET @@SESSION.GTID_NEXT= &#x27;ANONYMOUS&#x27;/*!*/;</span><br><span class="line"># at 219</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"># at 21019</span><br><span class="line">#190308 10:10:09 server id 1  end_log_pos 21094 CRC32 0x7a405abc     Query    thread_id=113    exec_time=0    error_code=0</span><br><span class="line">SET TIMESTAMP=1552011009/*!*/;</span><br><span class="line">BEGIN</span><br><span class="line">/*!*/;</span><br><span class="line"># at 21094</span><br><span class="line">#190308 10:10:09 server id 1  end_log_pos 21161 CRC32 0xdb7a2b35     Table_map: `maxwell`.`positions` mapped to number 110</span><br><span class="line"># at 21161</span><br><span class="line">#190308 10:10:09 server id 1  end_log_pos 21275 CRC32 0xec3be372     Update_rows: table id 110 flags: STMT_END_F</span><br><span class="line">### UPDATE `maxwell`.`positions`</span><br><span class="line">### WHERE</span><br><span class="line">###   @1=1</span><br><span class="line">###   @2=&#x27;master.000003&#x27;</span><br><span class="line">###   @3=20262</span><br><span class="line">###   @4=NULL</span><br><span class="line">###   @5=&#x27;maxwell&#x27;</span><br><span class="line">###   @6=NULL</span><br><span class="line">###   @7=1552011005707</span><br><span class="line">### SET</span><br><span class="line">###   @1=1</span><br><span class="line">###   @2=&#x27;master.000003&#x27;</span><br><span class="line">###   @3=20923</span><br><span class="line">###   @4=NULL</span><br><span class="line">###   @5=&#x27;maxwell&#x27;</span><br><span class="line">###   @6=NULL</span><br><span class="line">###   @7=1552011009790</span><br><span class="line"># at 21275</span><br><span class="line">#190308 10:10:09 server id 1  end_log_pos 21306 CRC32 0xe6c4346d     Xid = 13088</span><br><span class="line">COMMIT/*!*/;</span><br><span class="line">SET @@SESSION.GTID_NEXT= &#x27;AUTOMATIC&#x27; /* added by mysqlbinlog */ /*!*/;</span><br><span class="line">DELIMITER ;</span><br><span class="line"># End of log file</span><br><span class="line">/*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*/;</span><br><span class="line">/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=0*/;</span><br></pre></td></tr></table></figure>

<p>截取其中的一段进行分析：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># at 21019</span><br><span class="line">#190308 10:10:09 server id 1  end_log_pos 21094 CRC32 0x7a405abc     Query    thread_id=113    exec_time=0    error_code=0</span><br><span class="line">SET TIMESTAMP=1552011009/*!*/;</span><br><span class="line">BEGIN</span><br><span class="line">/*!*/;</span><br></pre></td></tr></table></figure>

<p>上面输出包括信息：</p>
<ul>
<li>position: 位于文件中的位置，即第一行的（# at 21019）,说明该事件记录从文件第21019个字节开始</li>
<li>timestamp: 事件发生的时间戳，即第二行的（#190308 10:10:09）</li>
<li>server id: 服务器标识（1）</li>
<li>end_log_pos 表示下一个事件开始的位置（即当前事件的结束位置+1）</li>
<li>thread_id: 执行该事件的线程id （thread_id=113）</li>
<li>exec_time: 事件执行的花费时间</li>
<li>error_code: 错误码，0意味着没有发生错误</li>
<li>type:事件类型Query</li>
</ul>
<h2 id="Binlog-事件类型"><a href="#Binlog-事件类型" class="headerlink" title="Binlog 事件类型"></a>Binlog 事件类型</h2><p>binlog 事件的结构主要有3个版本：</p>
<ul>
<li>v1: 在 MySQL 3.23 中使用</li>
<li>v3: 在 MySQL 4.0.2 到 4.1 中使用</li>
<li>v4: 在 MySQL 5.0 及以上版本中使用</li>
</ul>
<p>现在一般不会使用MySQL5.0以下版本，所以下面仅介绍v4版本的binlog事件类型。binlog 的事件类型较多，本文在此做一些简单的汇总</p>
<table>
<thead>
<tr>
<th align="left">事件类型</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">UNKNOWN_EVENT</td>
<td align="left">此事件从不会被触发，也不会被写入binlog中；发生在当读取binlog时，不能被识别其他任何事件，那被视为UNKNOWN_EVENT</td>
</tr>
<tr>
<td align="left">START_EVENT_V3</td>
<td align="left">每个binlog文件开始的时候写入的事件，此事件被用在MySQL3.23 – 4.1，MYSQL5.0以后已经被 FORMAT_DESCRIPTION_EVENT 取代</td>
</tr>
<tr>
<td align="left">QUERY_EVENT</td>
<td align="left">执行更新语句时会生成此事件，包括：create，insert，update，delete；</td>
</tr>
<tr>
<td align="left">STOP_EVENT</td>
<td align="left">当mysqld停止时生成此事件</td>
</tr>
<tr>
<td align="left">ROTATE_EVENT</td>
<td align="left">当mysqld切换到新的binlog文件生成此事件，切换到新的binlog文件可以通过执行flush logs命令或者binlog文件大于 <code>max_binlog_size</code> 参数配置的大小；</td>
</tr>
<tr>
<td align="left">INTVAR_EVENT</td>
<td align="left">当sql语句中使用了AUTO_INCREMENT的字段或者LAST_INSERT_ID()函数；此事件没有被用在binlog_format为ROW模式的情况下</td>
</tr>
<tr>
<td align="left">LOAD_EVENT</td>
<td align="left">执行LOAD DATA INFILE 语句时产生此事件，在MySQL 3.23版本中使用</td>
</tr>
<tr>
<td align="left">SLAVE_EVENT</td>
<td align="left">未使用</td>
</tr>
<tr>
<td align="left">CREATE_FILE_EVENT</td>
<td align="left">执行LOAD DATA INFILE 语句时产生此事件，在MySQL4.0和4.1版本中使用</td>
</tr>
<tr>
<td align="left">APPEND_BLOCK_EVENT</td>
<td align="left">执行LOAD DATA INFILE 语句时产生此事件，在MySQL4.0版本中使用</td>
</tr>
<tr>
<td align="left">EXEC_LOAD_EVENT</td>
<td align="left">执行LOAD DATA INFILE 语句时产生此事件，在MySQL4.0和4.1版本中使用</td>
</tr>
<tr>
<td align="left">DELETE_FILE_EVENT</td>
<td align="left">执行LOAD DATA INFILE 语句时产生此事件，在MySQL4.0版本中使用</td>
</tr>
<tr>
<td align="left">NEW_LOAD_EVENT</td>
<td align="left">执行LOAD DATA INFILE 语句时产生此事件，在MySQL4.0和4.1版本中使用</td>
</tr>
<tr>
<td align="left">RAND_EVENT</td>
<td align="left">执行包含RAND()函数的语句产生此事件，此事件没有被用在binlog_format为ROW模式的情况下</td>
</tr>
<tr>
<td align="left">USER_VAR_EVENT</td>
<td align="left">执行包含了用户变量的语句产生此事件，此事件没有被用在binlog_format为ROW模式的情况下</td>
</tr>
<tr>
<td align="left">FORMAT_DESCRIPTION_EVENT</td>
<td align="left">描述事件，被写在每个binlog文件的开始位置，用在MySQL5.0以后的版本中，代替了START_EVENT_V3</td>
</tr>
<tr>
<td align="left">XID_EVENT</td>
<td align="left">支持XA的存储引擎才有，本地测试的数据库存储引擎是innodb，所有上面出现了XID_EVENT；innodb事务提交产生了QUERY_EVENT的BEGIN声明，QUERY_EVENT以及COMMIT声明，如果是myIsam存储引擎也会有BEGIN和COMMIT声明，只是COMMIT类型不是XID_EVENT</td>
</tr>
<tr>
<td align="left">BEGIN_LOAD_QUERY_EVENT</td>
<td align="left">执行LOAD DATA INFILE 语句时产生此事件，在MySQL5.0版本中使用</td>
</tr>
<tr>
<td align="left">EXECUTE_LOAD_QUERY_EVENT</td>
<td align="left">执行LOAD DATA INFILE 语句时产生此事件，在MySQL5.0版本中使用</td>
</tr>
<tr>
<td align="left">TABLE_MAP_EVENT</td>
<td align="left">用在binlog_format为ROW模式下，将表的定义映射到一个数字，在行操作事件之前记录（包括：WRITE_ROWS_EVENT，UPDATE_ROWS_EVENT，DELETE_ROWS_EVENT）</td>
</tr>
<tr>
<td align="left">PRE_GA_WRITE_ROWS_EVENT</td>
<td align="left">已过期，被 WRITE_ROWS_EVENT 代替</td>
</tr>
<tr>
<td align="left">PRE_GA_UPDATE_ROWS_EVENT</td>
<td align="left">已过期，被 UPDATE_ROWS_EVENT 代替</td>
</tr>
<tr>
<td align="left">PRE_GA_DELETE_ROWS_EVENT</td>
<td align="left">已过期，被 DELETE_ROWS_EVENT 代替</td>
</tr>
<tr>
<td align="left">WRITE_ROWS_EVENT</td>
<td align="left">用在binlog_format为ROW模式下，对应 insert 操作</td>
</tr>
<tr>
<td align="left">UPDATE_ROWS_EVENT</td>
<td align="left">用在binlog_format为ROW模式下，对应 update 操作</td>
</tr>
<tr>
<td align="left">DELETE_ROWS_EVENT</td>
<td align="left">用在binlog_format为ROW模式下，对应 delete 操作</td>
</tr>
<tr>
<td align="left">INCIDENT_EVENT</td>
<td align="left">主服务器发生了不正常的事件，通知从服务器并告知可能会导致数据处于不一致的状态</td>
</tr>
<tr>
<td align="left">HEARTBEAT_LOG_EVENT</td>
<td align="left">主服务器告诉从服务器，主服务器还活着，不写入到日志文件中</td>
</tr>
</tbody></table>
<h2 id="Binlog-事件的结构"><a href="#Binlog-事件的结构" class="headerlink" title="Binlog 事件的结构"></a>Binlog 事件的结构</h2><p>一个事件对象分为事件头和事件体，事件的结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">+=====================================+</span><br><span class="line">| event  | timestamp         0 : 4    |</span><br><span class="line">| header +----------------------------+</span><br><span class="line">|        | type_code         4 : 1    |</span><br><span class="line">|        +----------------------------+</span><br><span class="line">|        | server_id         5 : 4    |</span><br><span class="line">|        +----------------------------+</span><br><span class="line">|        | event_length      9 : 4    |</span><br><span class="line">|        +----------------------------+</span><br><span class="line">|        | next_position    13 : 4    |</span><br><span class="line">|        +----------------------------+</span><br><span class="line">|        | flags            17 : 2    |</span><br><span class="line">|        +----------------------------+</span><br><span class="line">|        | extra_headers    19 : x-19 |</span><br><span class="line">+=====================================+</span><br><span class="line">| event  | fixed part        x : y    |</span><br><span class="line">| data   +----------------------------+</span><br><span class="line">|        | variable part              |</span><br><span class="line">+=====================================+</span><br></pre></td></tr></table></figure>

<p>如果事件头的长度是 <code>x</code> 字节，那么事件体的长度为 <code>(event_length - x)</code> 字节；</p>
<p>设事件体中 <code>fixed part</code> 的长度为 <code>y</code> 字节，那么 <code>variable part</code> 的长度为 <code>(event_length - (x + y))</code> 字节</p>
<h1 id="MySQL-复制原理基础"><a href="#MySQL-复制原理基础" class="headerlink" title="MySQL 复制原理基础"></a>MySQL 复制原理基础</h1><h2 id="binlog-文件"><a href="#binlog-文件" class="headerlink" title="binlog 文件"></a>binlog 文件</h2><p>binlog 文件主要包括：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql-bin.00000x</span><br><span class="line">mysql-bin.index</span><br></pre></td></tr></table></figure>

<p><code>mysql-bin.index</code> 记录了数据库中还未被 purge 的 binlog 文件名。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@10-10-90-177 binlog]# cat mysql-bin.index</span><br><span class="line">/home/mysql/data/mysqldata1/binlog/mysql-bin.000001</span><br><span class="line">/home/mysql/data/mysqldata1/binlog/mysql-bin.000002</span><br><span class="line">/home/mysql/data/mysqldata1/binlog/mysql-bin.000003</span><br></pre></td></tr></table></figure>

<p><code>mysql-bin.00000x</code> 是真正的 binlog 文件 ，x 表示 binlog 文件的序号，这些二进制文件里面的数据是以二进制的形式保存，可以通过特殊的工具 (mysqlbinlog) 进行解析，获取人类可读的信息。</p>
<h2 id="binlog-文件组成"><a href="#binlog-文件组成" class="headerlink" title="binlog 文件组成"></a>binlog 文件组成</h2><p>binlog 文件格式有以下特点：</p>
<ol>
<li>binlog 是由 event 组成，<strong>event 是 binlog 的最小组成单元</strong></li>
<li> binlog 文件头部固定以 4 个字节开头，这四个字节称为 <code>BINLOG_MAGIC</code> (fe 62 69 6e)</li>
<li>每个 binlog 文件以一个 Format_desc 类型的 event 开始</li>
<li>每个 binlog 文件以一个 Rotate 类型的 event 结束（但也有特殊情况，当数据库出现宕机的情况，重新启动数据库会生成一个新的 binlog 文件，但是宕机之前的最新 binlog 文件中，不是以 ROTATE_EVENT 结束的）</li>
<li>在 FORMAT_DESCRIPTION_EVENT 和 ROTATE_EVENT 之间是各种不同 event，每个 event 代表 Master 上不同的操作。</li>
</ol>
<h3 id="BINLOG-MAGIC"><a href="#BINLOG-MAGIC" class="headerlink" title="BINLOG_MAGIC"></a>BINLOG_MAGIC</h3><p>每个 binlog 文件以固定的 4 个字节（fe 62 69 6e）开始，以表示是一个 binlog 文件，在 Linux 环境下，我们可以通过 <code>hexdump</code> 命令查看 binlog 文件的字节组成。</p>
<p><img src="/images/20191117093140.png" alt="img"></p>
<h3 id="event"><a href="#event" class="headerlink" title="event"></a>event</h3><p>我们有两种方式可以查看，binlog 文件中的 event 组成方式。一种是在 MySQL 数据库中通过 <code>SHOW BINLOG EVENTS IN &#39;binlog-file-name&#39;</code> 的方式查看，还有一种就是通过 mysqlbinlog 工具查看 binlog 文件的组成。</p>
<p>在数据库中查看：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">root@localhost : (none) 10:50:48&gt; show binlog events in &#x27;mysql-bin.000004&#x27;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+-----------------------------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                                      |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+-----------------------------------------------------------+</span><br><span class="line">| mysql-bin.000004 |  4 | Format_desc |  3306114 |        120 | Server ver: 5.6.34-log, Binlog ver: 4                    |</span><br><span class="line">| mysql-bin.000004 | 120 | Query      |  3306114 |        201 | BEGIN                                                    |</span><br><span class="line">| mysql-bin.000004 | 201 | Rows_query  |  3306114 |        265 | # insert into test1(`name`) values(&#x27;woqu&#x27;)                |</span><br><span class="line">| mysql-bin.000004 | 265 | Table_map  |  3306114 |        320 | table_id: 70 (gangshen.test1)                            |</span><br><span class="line">| mysql-bin.000004 | 320 | Write_rows  |  3306114 |        365 | table_id: 70 flags: STMT_END_F                            |</span><br><span class="line">| mysql-bin.000004 | 365 | Xid        |  3306114 |        396 | COMMIT /* xid=24 */                                      |</span><br><span class="line">| mysql-bin.000004 | 396 | Query      |  3306114 |        477 | BEGIN                                                    |</span><br><span class="line">| mysql-bin.000004 | 477 | Rows_query  |  3306114 |        556 | # update test1 set name=&#x27;woqu-change&#x27; where name = &#x27;woqu&#x27; |</span><br><span class="line">| mysql-bin.000004 | 556 | Table_map  |  3306114 |        611 | table_id: 70 (gangshen.test1)                            |</span><br><span class="line">| mysql-bin.000004 | 611 | Update_rows |  3306114 |        674 | table_id: 70 flags: STMT_END_F                            |</span><br><span class="line">| mysql-bin.000004 | 674 | Xid        |  3306114 |        705 | COMMIT /* xid=27 */                                      |</span><br><span class="line">| mysql-bin.000004 | 705 | Query      |  3306114 |        786 | BEGIN                                                    |</span><br><span class="line">| mysql-bin.000004 | 786 | Rows_query  |  3306114 |        854 | # delete from test1 where name = &#x27;woqu-change&#x27;            |</span><br><span class="line">| mysql-bin.000004 | 854 | Table_map  |  3306114 |        909 | table_id: 70 (gangshen.test1)                            |</span><br><span class="line">| mysql-bin.000004 | 909 | Delete_rows |  3306114 |        961 | table_id: 70 flags: STMT_END_F                            |</span><br><span class="line">| mysql-bin.000004 | 961 | Xid        |  3306114 |        992 | COMMIT /* xid=28 */                                      |</span><br><span class="line">| mysql-bin.000004 | 992 | Rotate      |  3306114 |        1039 | mysql-bin.000005;pos=4                                    |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+-----------------------------------------------------------+</span><br><span class="line">17 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>可以看到 <code>mysql-bin.000004</code> 文件中，是以一个 Format_desc 类型的 event 开头，以一个 Rotate 类型的 event 结尾，中间是各种类型 event，这是看 binlog 文件中 event 的组成，如果想要查看更详细的 event 信息，可以通过 mysqlbinlog 工具来查看</p>
<p>mysqlbinlog 工具查看：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">/*!40019 SET @@session.max_insert_delayed_threads=0*/;</span><br><span class="line">/*!50003 SET @OLD_COMPLETION_TYPE=@@COMPLETION_TYPE,COMPLETION_TYPE=0*/;</span><br><span class="line">DELIMITER /*!*/;</span><br><span class="line"># at 4</span><br><span class="line">#171205 10:35:43 server id 3306114  end_log_pos 120 CRC32 0x7d7e496c    Start: binlog v 4, server v 5.6.34-log created 171205 10:35:43</span><br><span class="line"># at 120</span><br><span class="line">#171205 10:49:25 server id 3306114  end_log_pos 201 CRC32 0x24d309ef    Query  thread_id=2    exec_time=0    error_code=0</span><br><span class="line">SET TIMESTAMP=1512442165/*!*/;</span><br><span class="line">SET @@session.pseudo_thread_id=2/*!*/;</span><br><span class="line">SET @@session.foreign_key_checks=1, @@session.sql_auto_is_null=0, @@session.unique_checks=1, @@session.autocommit=1/*!*/;</span><br><span class="line">SET @@session.sql_mode=1075838976/*!*/;</span><br><span class="line">SET @@session.auto_increment_increment=2, @@session.auto_increment_offset=2/*!*/;</span><br><span class="line">/*!\C utf8 *//*!*/;</span><br><span class="line">SET @@session.character_set_client=33,@@session.collation_connection=33,@@session.collation_server=83/*!*/;</span><br><span class="line">SET @@session.lc_time_names=0/*!*/;</span><br><span class="line">SET @@session.collation_database=DEFAULT/*!*/;</span><br><span class="line">BEGIN</span><br><span class="line">/*!*/;</span><br><span class="line"># at 201</span><br><span class="line">#171205 10:49:25 server id 3306114  end_log_pos 265 CRC32 0xef0e9a3a    Rows_query</span><br><span class="line"># insert into test1(`name`) values(&#x27;woqu&#x27;)</span><br><span class="line"># at 265</span><br><span class="line">#171205 10:49:25 server id 3306114  end_log_pos 320 CRC32 0xf86a076e    Table_map: `gangshen`.`test1` mapped to number 70</span><br><span class="line"># at 320</span><br><span class="line">#171205 10:49:25 server id 3306114  end_log_pos 365 CRC32 0x653b8de4    Write_rows: table id 70 flags: STMT_END_F</span><br><span class="line">### INSERT INTO `gangshen`.`test1`</span><br><span class="line">### SET</span><br><span class="line">###  @1=4 /* INT meta=0 nullable=0 is_null=0 */</span><br><span class="line">###  @2=&#x27;woqu&#x27; /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span><br><span class="line"># at 365</span><br><span class="line">#171205 10:49:25 server id 3306114  end_log_pos 396 CRC32 0x53ca8e9d    Xid = 24</span><br><span class="line">COMMIT/*!*/;</span><br><span class="line">............</span><br><span class="line"># at 705</span><br><span class="line">#171205 10:50:20 server id 3306114  end_log_pos 786 CRC32 0x815b7a14    Query  thread_id=2    exec_time=0    error_code=0</span><br><span class="line">SET TIMESTAMP=1512442220/*!*/;</span><br><span class="line">BEGIN</span><br><span class="line">/*!*/;</span><br><span class="line"># at 786</span><br><span class="line">#171205 10:50:20 server id 3306114  end_log_pos 854 CRC32 0xc265e50d    Rows_query</span><br><span class="line"># delete from test1 where name = &#x27;woqu-change&#x27;</span><br><span class="line"># at 854</span><br><span class="line">#171205 10:50:20 server id 3306114  end_log_pos 909 CRC32 0x3a62ecaf    Table_map: `gangshen`.`test1` mapped to number 70</span><br><span class="line"># at 909</span><br><span class="line">#171205 10:50:20 server id 3306114  end_log_pos 961 CRC32 0x2bf4c689    Delete_rows: table id 70 flags: STMT_END_F</span><br><span class="line">### DELETE FROM `gangshen`.`test1`</span><br><span class="line">### WHERE</span><br><span class="line">###  @1=4 /* INT meta=0 nullable=0 is_null=0 */</span><br><span class="line">###  @2=&#x27;woqu-change&#x27; /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span><br><span class="line"># at 961</span><br><span class="line">#171205 10:50:20 server id 3306114  end_log_pos 992 CRC32 0x412de6a3    Xid = 28</span><br><span class="line">COMMIT/*!*/;</span><br><span class="line"># at 992</span><br><span class="line">#171205 10:50:23 server id 3306114  end_log_pos 1039 CRC32 0x8372f001  Rotate to mysql-bin.000005  pos: 4</span><br><span class="line">DELIMITER ;</span><br><span class="line"># End of log file</span><br><span class="line">ROLLBACK /* added by mysqlbinlog */;</span><br><span class="line">/*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*/;</span><br><span class="line">/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=0*/;</span><br></pre></td></tr></table></figure>

<p>可以看到第一个 event 是 FORMAT_DESCRIPTION_EVENT，记录了 binlog 的版本为 v4。最后一个 event，是 ROTATE_EVENT，它记录了下一个 binlog 文件的文件名以及对应的位置点。</p>
<h1 id="MySQL-binlog-event-解析-——-基础知识"><a href="#MySQL-binlog-event-解析-——-基础知识" class="headerlink" title="MySQL binlog event 解析 —— 基础知识"></a>MySQL binlog event 解析 —— 基础知识</h1><p>这篇文章介绍 binlog 里面的内容，看看主从之间同步具体同步了哪些内容。</p>
<h2 id="event-基础知识"><a href="#event-基础知识" class="headerlink" title="event 基础知识"></a>event 基础知识</h2><h3 id="event-类型"><a href="#event-类型" class="headerlink" title="event 类型"></a>event 类型</h3><p>5.6.34 版本的 MySQL 的 event 类型有：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">enum Log_event_type</span><br><span class="line">&#123; UNKNOWN_EVENT= 0,</span><br><span class="line">  START_EVENT_V3= 1,</span><br><span class="line">  QUERY_EVENT= 2,</span><br><span class="line">  STOP_EVENT= 3,</span><br><span class="line">  ROTATE_EVENT= 4,</span><br><span class="line">  INTVAR_EVENT= 5,</span><br><span class="line">  LOAD_EVENT= 6,</span><br><span class="line">  SLAVE_EVENT= 7,  </span><br><span class="line">  CREATE_FILE_EVENT= 8,</span><br><span class="line">  APPEND_BLOCK_EVENT= 9,</span><br><span class="line">  EXEC_LOAD_EVENT= 10,</span><br><span class="line">  DELETE_FILE_EVENT= 11,</span><br><span class="line">  NEW_LOAD_EVENT= 12,</span><br><span class="line">  RAND_EVENT= 13,</span><br><span class="line">  USER_VAR_EVENT= 14,</span><br><span class="line">  FORMAT_DESCRIPTION_EVENT= 15,</span><br><span class="line">  XID_EVENT= 16,</span><br><span class="line">  BEGIN_LOAD_QUERY_EVENT= 17,</span><br><span class="line">  EXECUTE_LOAD_QUERY_EVENT= 18,</span><br><span class="line">  TABLE_MAP_EVENT = 19,</span><br><span class="line">  PRE_GA_WRITE_ROWS_EVENT = 20,</span><br><span class="line">  PRE_GA_UPDATE_ROWS_EVENT = 21,</span><br><span class="line">  PRE_GA_DELETE_ROWS_EVENT = 22,</span><br><span class="line">  WRITE_ROWS_EVENT_V1 = 23,</span><br><span class="line">  UPDATE_ROWS_EVENT_V1 = 24,</span><br><span class="line">  DELETE_ROWS_EVENT_V1 = 25,</span><br><span class="line">  INCIDENT_EVENT= 26,</span><br><span class="line">  HEARTBEAT_LOG_EVENT= 27,</span><br><span class="line">  IGNORABLE_LOG_EVENT= 28,</span><br><span class="line">  ROWS_QUERY_LOG_EVENT= 29,</span><br><span class="line">  WRITE_ROWS_EVENT = 30,</span><br><span class="line">  UPDATE_ROWS_EVENT = 31,</span><br><span class="line">  DELETE_ROWS_EVENT = 32,</span><br><span class="line">  GTID_LOG_EVENT= 33,</span><br><span class="line">  ANONYMOUS_GTID_LOG_EVENT= 34,</span><br><span class="line">  PREVIOUS_GTIDS_LOG_EVENT= 35,</span><br><span class="line">  ENUM_END_EVENT /* end marker */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h3 id="event-类型含义"><a href="#event-类型含义" class="headerlink" title="event 类型含义"></a>event 类型含义</h3><p>介绍几个常见的 event 类型所对应的含义，对于不常见或者现在基本上已经不用了的 event 类型，这边不做过多的描述</p>
<ul>
<li><p><code>FORMAT_DESCRIPTION_EVENT</code>：每个 binlog 文件开头的一个 event。</p>
</li>
<li><p><code>ROTATE_EVENT</code>：当 MySQL 切换至新的 binlog 文件的时候，MySQL 会在旧的 binlog 文件中写入一个 ROTATE_EVENT，表示新的 binlog 文件的文件名，以及第一个偏移地址。当在数据库中执行 <code>FLUSH LOGS</code> 语句或者 binlog 文件的大小超过 max_binlog_size 就会切换新的 binlog 文件。</p>
</li>
<li><p><code>TABLE_MAP_EVENT</code>：</p>
<ul>
<li>只有在 binlog 文件是以 ROW 格式记录的时候才会使用。</li>
<li>binlog 中记录的每个更改的记录之前都会有一个对应要操作的表的 TABLE_MAP_EVENT。TABLE_MAP_EVENT 中记录了表的定义（包括 database name,table name，字段定义），并且会将这个表的定义对应于一个数字，称为 table_id。</li>
<li>设计 TABLE_MAP_EVENT 类型 event 的目的是为了当主库和从库之间有不同的表定义的时候，复制仍能进行。如果一个事务中操作了多个表，多行记录，在 binlog 中会将对多行记录的操作 event 进行分组，每组行记录操作 event 前面会出现对应表的 TABLE_MAP_EVENT。</li>
</ul>
</li>
<li><p><code>QUERY_EVENT</code>：记录更新操作的语句。</p>
</li>
<li><p><code>WRITE_ROWS_EVENT</code>：在以 ROW 格式记录的 binlog 文件中，WRITE_ROWS_EVENT 记录了插入的行记录。</p>
</li>
<li><p><code>UPDATE_ROWS_EVENT</code>：在以 ROW 格式记录的 binlog 文件中，UPDATE_ROWS_EVENT 记录了更新的行记录。</p>
</li>
<li><p><code>DELETE_ROWS_EVENT</code>：在以 ROW 格式记录的 binlog 文件中，DELETE_ROWS_EVENT 记录了删除的行记录。</p>
</li>
</ul>
<h2 id="event-字节解析"><a href="#event-字节解析" class="headerlink" title="event 字节解析"></a>event 字节解析</h2><p>在 MySQL 的发展过程中，一共出现过三个版本的 event 结构：</p>
<ul>
<li>v1: 在 MySQL 3.23 中使用</li>
<li>v2: 在 MySQL4.0.2 至 4.1 中使用</li>
<li>v4: 在 MySQL5.0 及以上版本中使用</li>
</ul>
<p>因为目前 MySQL 数据库版本基本上都是 5.0 版本以上的，所以只介绍 v4 版本的 event 架构。</p>
<h3 id="event-组织架构"><a href="#event-组织架构" class="headerlink" title="event 组织架构"></a>event 组织架构</h3><p>v4 版本的 event 主要由 <code>event header</code> 部分和 <code>post-header</code> 以及 <code>variable part</code> 部分组成。</p>
<p>event 字节结构表示如下图：</p>
<p><img src="/images/image-20220309160154958.png" alt="image-20220309160154958"></p>
<ul>
<li><p><code>event header</code>：每个 event 都会有的部分，并且每个 event header 的格式是相同的，固定为 19 个字节长度，在 event header 中记录了 event_length、type_code 等信息，可以表示 event 的长度，event 的类型，下一个 event 的偏移位置等信息，都可以再 event header 中获取到。</p>
</li>
<li><p><code>extra_headers</code>：指定了除公共头部外的内容，但是目前版本的 binlog 格式中，这一部分不存在的。</p>
</li>
<li><p><code>fixed_part</code>：也被称做 post-header，每个类型的 event 之间的 post-header 部分是不相同的，但是同一类型的 event 占用的 post-header 字节数是一样的。每个类型的 event 占用多少字节为 post-header，这个定义在了 Format_description_event 中。<code>x:y</code> 中 x 表示该部分从多少字节偏移开始，y 表示该部分占用多少字节。</p>
</li>
<li><p><code>variable part</code>：是 event 真实记录具体信息的部分。</p>
</li>
<li><p>timestamp 记录的是该事务记录的时间</p>
</li>
<li><p>type_code，记录的是该 event 的类型，具体的 event 类型，见上面的 Log_event_type</p>
</li>
<li><p>server_id，记录的是执行该 event 的 server 的 server_id 号</p>
</li>
<li><p>event_length，该 event 的长度，共占多少字节</p>
</li>
<li><p>next_position，下一个 event 在 binlog 文件中的偏移位置</p>
</li>
<li><p>flag: 标记</p>
</li>
<li><p>extra_headers，额外的头部内容，现在是空的，不存在</p>
</li>
<li><p>fixed part 有些时候也被称作 post-header</p>
</li>
<li><p>variable part 有些时候也被称作 payload 或者 body</p>
</li>
</ul>
<blockquote>
<p><code>event_length - event_header_length</code>：就是 event_data 的长度</p>
</blockquote>
<h3 id="event-公共头部"><a href="#event-公共头部" class="headerlink" title="event 公共头部"></a>event 公共头部</h3><p>从上述的 event 结构中，可以看到，每个 event 的 header 部分的内容结构是一致的，所有的 event，都会记录这些信息，这是所有的 event 的公共头部。所以我们把这块内容单独拿出来讲。</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>timestamp</td>
<td>4 字节</td>
<td>时间戳</td>
</tr>
<tr>
<td>type_code</td>
<td>1 字节</td>
<td>记录 event 类型</td>
</tr>
<tr>
<td>server_id</td>
<td>4 字节</td>
<td>记录 event 生成的 MySQL 所对应的 server_id</td>
</tr>
<tr>
<td>event_length</td>
<td>4 字节</td>
<td>这个 event 的字节长度，包括 event header</td>
</tr>
<tr>
<td>next_position</td>
<td>4 字节</td>
<td>下一个 event 在 binlog 文件中的偏移位置</td>
</tr>
<tr>
<td>flags</td>
<td>2 字节</td>
<td></td>
</tr>
</tbody></table>
<p>示例：我们拿一个 Write_rows_event 的字节内容作为示例，解析 event 内容:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">b6 <span class="number">1</span>e <span class="number">1</span>c <span class="number">5</span>a   <span class="comment">//timestamp:小端存储，将16进制转换成10进制为1511792310，将时间戳转换为时间为2017-11-27 22:18:30</span></span><br><span class="line"><span class="number">1</span>e            <span class="comment">//type_code:event类型，0x1e转换为10进制为30，查看Log_event_type中，看到30的为WRITE_ROWS_EVENT</span></span><br><span class="line"><span class="number">0</span>f <span class="number">27</span> <span class="number">00</span> <span class="number">00</span>   <span class="comment">//server_id :小端存储，将16进制转换为10进制为9999</span></span><br><span class="line"><span class="number">31</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>   <span class="comment">//event_length :小端存储，将16进制转换为10进制为49</span></span><br><span class="line">b1 <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>   <span class="comment">//next_position:小端存储，将16进制转换为10进制为945</span></span><br><span class="line"><span class="number">00</span> <span class="number">00</span>         <span class="comment">//flags:</span></span><br><span class="line">body部分省略</span><br></pre></td></tr></table></figure>



<h1 id="MySQL-常见-binlog-event-解析"><a href="#MySQL-常见-binlog-event-解析" class="headerlink" title="MySQL 常见 binlog event 解析"></a>MySQL 常见 binlog event 解析</h1><p>具体来解析 binlog 中常见的 event，了解其具体代表的意义。本文会介绍 Format_description_event、Rotate_event、Query_log_event、Rows_query_log_event 几种 event。</p>
<p><img src="/images/1679665-20191029150402950-1427650324.jpg" alt="img"></p>
<h2 id="Format-description-event"><a href="#Format-description-event" class="headerlink" title="Format_description_event"></a>Format_description_event</h2><p>Format_description_event 是每个 binlog 文件开头的一个描述信息的 event。</p>
<h3 id="post-header-部分"><a href="#post-header-部分" class="headerlink" title="post-header 部分"></a>post-header 部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>binlog_version</td>
<td>2 字节</td>
<td>binlog 结构的版本，v1,v2,v4</td>
</tr>
<tr>
<td>server_version</td>
<td>50 字节</td>
<td>MySQL server 的数据库版本</td>
</tr>
<tr>
<td>timestamp</td>
<td>4 字节</td>
<td>创建该 binlog 文件的时间，单位为秒</td>
</tr>
<tr>
<td>header_length</td>
<td>1 字节</td>
<td>指定公共头部的长度，v4 版本中这个值一直为 19，说明其他所有的 event 的 extra_header 部分都是空，extra_header 长度为 header_length-19</td>
</tr>
<tr>
<td>event_post_header_length</td>
<td>variable size，跟各个版本支持的 event 类型总数一致</td>
<td>每个 event 类型，占用一个字节，表示该 event 类型 post-header 部分的长度</td>
</tr>
</tbody></table>
<h3 id="event-body-部分"><a href="#event-body-部分" class="headerlink" title="event-body 部分"></a>event-body 部分</h3><p>无</p>
<h3 id="字节解析示例"><a href="#字节解析示例" class="headerlink" title="字节解析示例"></a>字节解析示例</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略</span><br><span class="line">04 00 //binlog_version :v4版本</span><br><span class="line">35 2e 36 2e 33 34 2d 6c 6f 67 </span><br><span class="line">00 00 00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00 00 00 </span><br><span class="line">00 00 00 00 00 00 00 00 00 00 </span><br><span class="line">00 00 00 00 00 00 00 00 00 00  //mysql server version :16进制转换为ascii之后，值为5.6.34-log</span><br><span class="line">00 00 00 00 //timestamp:</span><br><span class="line">13 //header length :19,说明该版本的event类型公共头部长度都为19，extra_header长度为header_length-19</span><br><span class="line">38 0d 00 08 00 12 00 04 04 04 </span><br><span class="line">04 12 00 00 5c 00 04 1a 08 00 </span><br><span class="line">00 00 08 08 08 02 00 00 00 0a </span><br><span class="line">0a 0a 19 19 00 //event_post_header_len:各个类型event的post-header部分长度</span><br><span class="line">01 2e ef 23 e2</span><br></pre></td></tr></table></figure>



<h2 id="Rotate-event"><a href="#Rotate-event" class="headerlink" title="Rotate_event"></a>Rotate_event</h2><p>当 MySQL 切换至新的 binlog 文件的时候，MySQL 会在旧的 binlog 文件中写入一个 ROTATE_EVENT，其内容包含新的 binlog 文件的文件名以及第一个偏移地址。当在数据库中执行 <code>FLUSH LOGS</code> 语句或者 binlog 文件的大小超过 max_binlog_size 参数设定的值就会切换新的 binlog 文件。</p>
<h3 id="post-header-部分-1"><a href="#post-header-部分-1" class="headerlink" title="post-header 部分"></a>post-header 部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>next_binlog_po</td>
<td>8 字节</td>
<td>下一个 binlog 文件起始的偏移地址</td>
</tr>
</tbody></table>
<h3 id="event-body-部分-1"><a href="#event-body-部分-1" class="headerlink" title="event-body 部分"></a>event-body 部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>next_binlog_filename</td>
<td>variable string</td>
<td>下一个 binlog 文件的文件名</td>
</tr>
</tbody></table>
<h3 id="字节解析示例-1"><a href="#字节解析示例-1" class="headerlink" title="字节解析示例"></a>字节解析示例</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略</span><br><span class="line">04 00 00 00 00 00 00 00 //next_binlog_pos：下一个binlog的起始偏移地址,小端存储，16进制转换为10进制之后为4</span><br><span class="line">6d 79 73 71 6c 2d 62 69 6e 2e 30 30 30 30 30 32  //next_binlog_filename：下一个binlog的文件名,16进制转换为ascii之后，值为mysql-bin.000002</span><br><span class="line">b3 db 0b 9a checksum</span><br></pre></td></tr></table></figure>



<h2 id="Query-log-event"><a href="#Query-log-event" class="headerlink" title="Query_log_event"></a>Query_log_event</h2><p>记录更新操作的语句。</p>
<h3 id="post-header-部分-2"><a href="#post-header-部分-2" class="headerlink" title="post-header 部分"></a>post-header 部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>thread_id</td>
<td>4 字节</td>
<td>小端存储，执行语句的线程 ID 号</td>
</tr>
<tr>
<td>exec_time</td>
<td>4 字节</td>
<td>小端存储，语句执行的时间</td>
</tr>
<tr>
<td>db_len</td>
<td>1 字节</td>
<td>database 名的长度</td>
</tr>
<tr>
<td>error_code</td>
<td>2 字节</td>
<td>错误号</td>
</tr>
<tr>
<td>status_vars_len</td>
<td>2 字节</td>
<td>小端存储，这部分，在 v1 和 v3 版本的 event 中是没有的，指定状态值的长度</td>
</tr>
</tbody></table>
<h3 id="event-body-部分-2"><a href="#event-body-部分-2" class="headerlink" title="event-body 部分"></a>event-body 部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>status_vars</td>
<td>status_vars_len 字节</td>
<td>记录状态值，具体的解析见下表</td>
</tr>
<tr>
<td>database_name</td>
<td>db_len+1 字节</td>
<td>null-terminaled 类型的字符串，记录 database 的名字</td>
</tr>
<tr>
<td>query_statement</td>
<td>不定</td>
<td>执行的语句</td>
</tr>
<tr>
<td>check_sum</td>
<td>4 字节</td>
<td>校验码</td>
</tr>
</tbody></table>
<p>status_vars 的解析是，一个字节表示状态的类型，在类型之后按照类型不同紧接着不同字节数的状态值，状态的类型一共有：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">enum Query_event_status_vars</span><br><span class="line">  &#123;</span><br><span class="line">    Q_FLAGS2_CODE= 0,</span><br><span class="line">    Q_SQL_MODE_CODE,</span><br><span class="line">    Q_CATALOG_CODE,</span><br><span class="line">    Q_AUTO_INCREMENT,</span><br><span class="line">    Q_CHARSET_CODE,</span><br><span class="line">    Q_TIME_ZONE_CODE,</span><br><span class="line">    Q_CATALOG_NZ_CODE,</span><br><span class="line">    Q_LC_TIME_NAMES_CODE,</span><br><span class="line">    Q_CHARSET_DATABASE_CODE,</span><br><span class="line">    Q_TABLE_MAP_FOR_UPDATE_CODE,</span><br><span class="line">    Q_MASTER_DATA_WRITTEN_CODE,</span><br><span class="line">    Q_INVOKER,</span><br><span class="line">    Q_UPDATED_DB_NAMES,</span><br><span class="line">    Q_MICROSECONDS,</span><br><span class="line">    Q_COMMIT_TS,</span><br><span class="line">    Q_COMMIT_TS2,</span><br><span class="line">    Q_EXPLICIT_DEFAULTS_FOR_TIMESTAMP</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p>不同状态对应的状态值的字节数</p>
<table>
<thead>
<tr>
<th>状态</th>
<th>对用的 code</th>
<th>状态值占用的字节数</th>
</tr>
</thead>
<tbody><tr>
<td>Q_FLAGS2_CODE</td>
<td>0</td>
<td>4 字节</td>
</tr>
<tr>
<td>Q_SQL_MODE_CODE</td>
<td>1</td>
<td>8 字节</td>
</tr>
<tr>
<td>Q_CATALOG_CODE</td>
<td>2</td>
<td>第一个字节表示 catalog_len，总共 catalog_len+2 个字节</td>
</tr>
<tr>
<td>Q_AUTO_INCREMENT</td>
<td>3</td>
<td>4 字节</td>
</tr>
<tr>
<td>Q_CHARSET_CODE</td>
<td>4</td>
<td>6 字节</td>
</tr>
<tr>
<td>Q_TIME_ZONE_CODE</td>
<td>5</td>
<td>第一个字节表示 time_zone_len，总共 time_zone_len+1 字节</td>
</tr>
<tr>
<td>Q_CATALOG_NZ_CODE</td>
<td>6</td>
<td>第一个字节表示 catalog_len，总共 catalog_len+1 个字节</td>
</tr>
<tr>
<td>Q_LC_TIME_NAMES_CODE</td>
<td>7</td>
<td>2 字节</td>
</tr>
<tr>
<td>Q_CHARSET_DATABASE_CODE</td>
<td>8</td>
<td>2 字节</td>
</tr>
<tr>
<td>Q_TABLE_MAP_FOR_UPDATE_CODE</td>
<td>9</td>
<td>8 字节</td>
</tr>
<tr>
<td>Q_MASTER_DATA_WRITTEN_CODE</td>
<td>10</td>
<td>4 字节</td>
</tr>
<tr>
<td>Q_INVOKER</td>
<td>11</td>
<td>包含两部分，一部分是 user，一部分是 host。user 部分，一个字节表示 user_len，接着 user_len 个字节表示 user。host 部分，一个字节表示 host_len，接着 host_len 个字节表示 host。</td>
</tr>
<tr>
<td>Q_UPDATED_DB_NAMES</td>
<td>12</td>
<td></td>
</tr>
<tr>
<td>Q_MICROSECONDS</td>
<td>13</td>
<td>3 字节</td>
</tr>
<tr>
<td>Q_COMMIT_TS</td>
<td>14</td>
<td></td>
</tr>
<tr>
<td>Q_COMMIT_TS2</td>
<td>15</td>
<td></td>
</tr>
<tr>
<td>Q_EXPLICIT_DEFAULTS_FOR_TIMESTAMP</td>
<td>16</td>
<td>1 字节</td>
</tr>
</tbody></table>
<h3 id="字节解析示例-2"><a href="#字节解析示例-2" class="headerlink" title="字节解析示例"></a>字节解析示例</h3><p>执行语句:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">insert into test1(`name`) values(&#x27;beijing&#x27;);</span><br><span class="line"></span><br><span class="line">root@localhost : (none) 06:07:04&gt; show binlog events  in &#x27;mysql-bin.000012&#x27;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+-------------------------------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                                        |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+-------------------------------------------------------------+</span><br><span class="line">| mysql-bin.000012 |  4 | Format_desc |    330619 |        120 | Server ver: 5.6.34-log, Binlog ver: 4                      |</span><br><span class="line">| mysql-bin.000012 | 120 | Query      |    330619 |        212 | BEGIN                                                      |</span><br><span class="line">| mysql-bin.000012 | 212 | Intvar      |    330619 |        244 | INSERT_ID=28                                                |</span><br><span class="line">| mysql-bin.000012 | 244 | Query      |    330619 |        374 | use `gangshen`; insert into test1(`name`) values(&#x27;beijing&#x27;) |</span><br><span class="line">| mysql-bin.000012 | 374 | Xid        |    330619 |        405 | COMMIT /* xid=2961 */                                      |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+-------------------------------------------------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>使用 mysqlbinlog 工具解析 binlog 文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># at 244</span><br><span class="line">#180105 15:20:29 server id 330619  end_log_pos 244 CRC32 0xf41b5eaa    Intvar</span><br><span class="line">SET INSERT_ID=28/*!*/;</span><br><span class="line">#180105 15:20:29 server id 330619  end_log_pos 374 CRC32 0x98379221    Query    thread_id=106404    exec_time=0    error_code=0</span><br><span class="line">use `gangshen`/*!*/;</span><br><span class="line">SET TIMESTAMP=1515183629/*!*/;</span><br><span class="line">insert into test1(`name`) values(&#x27;beijing&#x27;)</span><br><span class="line">/*!*/;</span><br><span class="line"># at 374</span><br></pre></td></tr></table></figure>

<p>解析二进制文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略。。。。</span><br><span class="line">a4 9f 01 00 //thread_id:执行语句的线程号，小端存储，转换为16进制为106404</span><br><span class="line">00 00 00 00 //exec_time:执行语句的时间，小端存储，转化为16进制为0</span><br><span class="line">08 //db_len:database name的长度，转换为10进制为8</span><br><span class="line">00 00 //error_code:错误号，小端存储，转换为10进制为0</span><br><span class="line">2a 00 //status_vars_len:状态值的长度，小端存储，转换为10进制为42，表示后续的42个字节为状态值的内容</span><br><span class="line">//status_vars_len</span><br><span class="line">00 00 00 00 00 </span><br><span class="line">01 00 00 20 40 00 00 00 00</span><br><span class="line">06 03 73 74 64 </span><br><span class="line">03 02 00 02 00</span><br><span class="line">04 21 00 21 00 53 00 </span><br><span class="line">0c 01 67 61 6e 67 73 68 65 6e 00 </span><br><span class="line">67 61 6e 67 73 68 65 6e 00 //database_name:数据库名称，null-terminaled string类型 ，转换为字符串为gangshen</span><br><span class="line">696e7365727420696e746f20746573743128606e616d6560292076616c75657328276265696a696e672729 //query_statement:执行的语句，转换为字符串为:insert into test1(`name`) values(&#x27;beijing&#x27;)</span><br><span class="line">21 92 37 98//checksum</span><br></pre></td></tr></table></figure>



<h2 id="Rows-query-log-event"><a href="#Rows-query-log-event" class="headerlink" title="Rows_query_log_event"></a>Rows_query_log_event</h2><p>在 row 格式复制模式下，将 query 以语句形式记录。在 5.6.2 版本之后，可以通过设置 <code>binlog_rows_query_log_events</code> 参数来控制在 row 格式复制模式下是否需要将 query 语句记录到 binlog 文件中。</p>
<h3 id="post-header-部分-3"><a href="#post-header-部分-3" class="headerlink" title="post-header 部分"></a>post-header 部分</h3><p>无</p>
<h3 id="event-body-部分-3"><a href="#event-body-部分-3" class="headerlink" title="event-body 部分"></a>event-body 部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>str_len</td>
<td>1 字节</td>
<td>记录语句长度</td>
</tr>
<tr>
<td>statement</td>
<td>str_len 字节</td>
<td>对应的语句</td>
</tr>
<tr>
<td>checksum</td>
<td>4 字节</td>
<td>校验码</td>
</tr>
</tbody></table>
<h3 id="字节解析示例-3"><a href="#字节解析示例-3" class="headerlink" title="字节解析示例"></a>字节解析示例</h3><p>执行语句:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@localhost : gangshen 09:11:56&gt; insert into test1(`name`) values(&#x27;rows_query&#x27;);</span><br><span class="line">Query OK, 1 row affected (0.04 sec)</span><br><span class="line"></span><br><span class="line">root@localhost : gangshen 09:12:06&gt; show binlog events in &#x27;mysql-bin.000014&#x27;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+--------------------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                            |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+--------------------------------------------------+</span><br><span class="line">| mysql-bin.000014 |  4 | Format_desc |    330619 |        120 | Server ver: 5.6.34-log, Binlog ver: 4            |</span><br><span class="line">| mysql-bin.000014 | 120 | Query      |    330619 |        201 | BEGIN                                            |</span><br><span class="line">| mysql-bin.000014 | 201 | Rows_query  |    330619 |        271 | # insert into test1(`name`) values(&#x27;rows_query&#x27;) |</span><br><span class="line">| mysql-bin.000014 | 271 | Table_map  |    330619 |        326 | table_id: 98 (gangshen.test1)                    |</span><br><span class="line">| mysql-bin.000014 | 326 | Write_rows  |    330619 |        377 | table_id: 98 flags: STMT_END_F                  |</span><br><span class="line">| mysql-bin.000014 | 377 | Xid        |    330619 |        408 | COMMIT /* xid=3032 */                            |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+--------------------------------------------------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>使用 mysqlbinlog 工具解析 binlog 文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># at 201</span><br><span class="line">#180108  9:12:06 server id 330619  end_log_pos 271 CRC32 0xdc68af8a    Rows_query</span><br><span class="line"># insert into test1(`name`) values(&#x27;rows_query&#x27;)</span><br><span class="line"># at 271</span><br></pre></td></tr></table></figure>

<p>解析二进制文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略。。。</span><br><span class="line">2e //str_len:执行语句的长度，转换为10进制为46</span><br><span class="line">696e7365727420696e746f20746573743128606e616d6560292076616c7565732827726f77735f71756572792729  //statement:执行的语句，转换为ascii为insert into test1(`name`) values(&#x27;rows_query&#x27;)</span><br><span class="line">8a af 68 dc //check_sum</span><br></pre></td></tr></table></figure>



<h2 id="Table-map-event"><a href="#Table-map-event" class="headerlink" title="Table_map_event"></a>Table_map_event</h2><p>TABLE_MAP_EVENT 只有在 binlog 文件是以 ROW 格式记录的时候，才会使用。</p>
<p>binlog 中记录的每个更改的记录之前都会有一个对应要操作的表的 TABLE_MAP_EVENT。TABLE_MAP_EVENT 中记录了表的定义（包括 database name,table name，字段定义），并且会将这个表的定义对应于一个数字，称为 table_id。</p>
<p>设计 TABLE_MAP_EVENT 类型 event 的目的是为了当主库和从库之间有不同的表定义的时候，复制仍能进行。如果一个事务中操作了多个表，多行记录，在 binlog 中会将对多行记录的操作 event 进行分组，每组行记录操作 event 前面会出现对应表的 TABLE_MAP_EVENT。</p>
<blockquote>
<p>TABLE_MAP_EVENT 用于描述即将发生数据变化的表的结构。当用户提交一条修改语句时 (如，insert, update, delete)，MySQL 会产生 2 个 Binlog 事件：第一个就是 TABLE_MAP_EVENT，用于描述改变对应表的结构 (表名，列的数据类型等信息)；紧接着的是 ROWS_EVENT，用于描述对应表的行的实际变化值</p>
</blockquote>
<ul>
<li>binlog 中存储的表结构信息，只有字段类型，没有字段名称。</li>
<li>binlog 中存储的整型，没有 signed 或者 unsigned 信息，同样使用 mysqlbinlog 解析也无法分辨出整型值是否有符号。</li>
</ul>
<h3 id="post-header-部分-4"><a href="#post-header-部分-4" class="headerlink" title="post-header 部分"></a>post-header 部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>table_id</td>
<td>6 字节</td>
<td>操作的表的 table_id</td>
</tr>
<tr>
<td>flags</td>
<td>2 字节</td>
<td>目前版本没有用，都是 0，保留给之后的版本使用</td>
</tr>
</tbody></table>
<h3 id="event-body-部分-4"><a href="#event-body-部分-4" class="headerlink" title="event-body 部分"></a>event-body 部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>database_name</td>
<td>1 个字节表示字符串长度，之后接一个 null-terminated 类型的字符串</td>
<td></td>
</tr>
<tr>
<td>table_name</td>
<td>1 个字节表示字符串长度，之后接一个 null-terminated 类型的字符串</td>
<td>操作的表的名称</td>
</tr>
<tr>
<td>column_count</td>
<td>packed integer (1 或 3 或 4 或 9 个字节)</td>
<td>对应表中的字段数量</td>
</tr>
<tr>
<td>column_type</td>
<td>每个字段占用一个字节，字段类型定义在 enum_field_types 中</td>
<td>字段类型</td>
</tr>
<tr>
<td>metadata_length</td>
<td>packed integer (1 或 3 或 4 或 9 个字节)</td>
<td>对应字段的元数据信息的长度</td>
</tr>
<tr>
<td>metadata</td>
<td>根据 enum_field_type 中的定义确定不同字段的元数据，如果某字段类型没有元数据，则不记录</td>
<td>每个字段的元数据信息，比如 varchar 字段需要记录最长长度</td>
</tr>
<tr>
<td>null_bits</td>
<td>int ((column_count + 7)/8) 字节</td>
<td>一个 bit 表示一个字段是否可以为 NULL，顺序是：第一个字节的最低位开始向最高位增长，之后第二个字节的最低位开始向最高位增长，以此类推</td>
</tr>
<tr>
<td>check_sum</td>
<td>4 字节</td>
<td>校验码</td>
</tr>
</tbody></table>
<h3 id="字节解析示例-4"><a href="#字节解析示例-4" class="headerlink" title="字节解析示例"></a>字节解析示例</h3><p>建表语句:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `test1` (</span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(20) COLLATE utf8_bin DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=20 DEFAULT CHARSET=utf8 COLLATE=utf8_bin</span><br></pre></td></tr></table></figure>

<p>二进制内容解析：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略</span><br><span class="line">6c <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="comment">//table_id :小端存储，16进制转换为10进制为108</span></span><br><span class="line"><span class="number">01</span> <span class="number">00</span> <span class="comment">//flag :</span></span><br><span class="line"><span class="number">08</span> <span class="number">67</span> <span class="number">61</span> 6e <span class="number">67</span> <span class="number">73</span> <span class="number">68</span> <span class="number">65</span> 6e <span class="number">00</span> <span class="comment">//database_name :1个字节是字符串长度，后接一个null-terminated string 第一个字节表示字符串长度为8，后面内容将16进制转换为ascii字符为gangshen</span></span><br><span class="line"><span class="number">05</span> <span class="number">74</span> <span class="number">65</span> <span class="number">73</span> <span class="number">74</span> <span class="number">31</span> <span class="number">00</span> <span class="comment">//table_name: 1个字节是字符串长度，后接一个null-terminated string第一个字节表示字符串长度为5，后面内容将16进制转换为ascii字符为test1</span></span><br><span class="line"><span class="number">02</span> <span class="comment">//columns count :packet integer类型，转换之后，数值为2 表示表中有两个字段</span></span><br><span class="line"><span class="number">03</span> 0f <span class="comment">//column type : 一个字节表示一个字段的类型，字段类型定义在enum enum_field_types ，分别是一个int类型以及一个varchar类型,具体的字段类型及记录格式等信息可以查看《MySQL中Rows_event中字段表示》文档</span></span><br><span class="line"><span class="number">02</span> <span class="comment">//metadata length : packet integer类型,转换之后，数值为2，表示记录表中的metadata内容占用2个字节</span></span><br><span class="line"><span class="number">14</span> <span class="number">00</span> <span class="comment">// :varchar 的max length 因为int没有metadata所以跳过</span></span><br><span class="line"><span class="number">02</span> <span class="comment">//null_bits :int((column_count + 7) / 8)个字节 一个bit表示一个字段是否可以为null </span></span><br><span class="line"><span class="number">52</span> <span class="number">53</span> 4a d9 checksum</span><br></pre></td></tr></table></figure>



<h2 id="Write-rows-log-event"><a href="#Write-rows-log-event" class="headerlink" title="Write_rows_log_event"></a>Write_rows_log_event</h2><p>ROWS_EVENT 包含了 insert，update，以及 delete 三种 event ，并且有 v0，v1，v2 三个版本。ROWS_EVENT 的基本格式如下：</p>
<p><img src="/images/rows_event.png" alt="rows_event"></p>
<p>在以 ROW 格式记录的 binlog 文件中，Write_rows_log_event 记录了插入的行记录。</p>
<h3 id="post-header-部分-5"><a href="#post-header-部分-5" class="headerlink" title="post-header 部分"></a>post-header 部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>table_id</td>
<td>6 字节</td>
<td>操作的表的 table_id</td>
</tr>
<tr>
<td>flags</td>
<td>2 字节</td>
<td>目前版本没有用，都是 0，保留给之后的版本使用</td>
</tr>
</tbody></table>
<h3 id="event-body-部分-5"><a href="#event-body-部分-5" class="headerlink" title="event-body 部分"></a>event-body 部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>var_header</td>
<td>2 字节</td>
<td></td>
</tr>
<tr>
<td>m_width</td>
<td>packed integer (1 或 3 或 4 或 9 个字节)</td>
<td>表中字段数量</td>
</tr>
<tr>
<td>before_image</td>
<td>(m_width + 7)/8 字节</td>
<td></td>
</tr>
<tr>
<td>after_bitmap_bits</td>
<td>(m_with +7)/8 字节</td>
<td>字段值是否为空标记，一个 bit 表示一个字段是否为 NULL，顺序是：第一个字节的最低位开始向最高位增长，之后第二个字节的最低位开始向最高位增长，以此类推</td>
</tr>
<tr>
<td>after_column_content</td>
<td>不定</td>
<td>按照顺序每个字段的内容</td>
</tr>
<tr>
<td>check_sum</td>
<td>4 字节</td>
<td>校验码</td>
</tr>
</tbody></table>
<h3 id="字节解析示例-5"><a href="#字节解析示例-5" class="headerlink" title="字节解析示例"></a>字节解析示例</h3><p>建表语句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `int_table` (</span><br><span class="line">  `col1` tinyint(4) DEFAULT NULL,</span><br><span class="line">  `col2` smallint(6) DEFAULT NULL,</span><br><span class="line">  `col3` mediumint(9) DEFAULT NULL,</span><br><span class="line">  `col4` int(11) DEFAULT NULL,</span><br><span class="line">  `col5` bigint(20) DEFAULT NULL,</span><br><span class="line">  `col6` tinyint(1) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin</span><br></pre></td></tr></table></figure>

<p>插入数据:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into int_table values(1,11,111,1111,11111,true);</span><br></pre></td></tr></table></figure>

<p>对应 Write_rows_log_event 使用 mysqlbinlog 解析</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># at 340</span><br><span class="line">#180103 10:21:20 server id 330619  end_log_pos 395 CRC32 0x50177e10    Write_rows: table id 100 flags: STMT_END_F</span><br><span class="line">### INSERT INTO `gangshen`.`int_table`</span><br><span class="line">### SET</span><br><span class="line">###  @1=1 /* TINYINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @2=11 /* SHORTINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @3=111 /* MEDIUMINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @4=1111 /* INT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @5=11111 /* LONGINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @6=1 /* TINYINT meta=0 nullable=1 is_null=0 */</span><br><span class="line"># at 395</span><br></pre></td></tr></table></figure>

<p>解析二进制文件:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略</span><br><span class="line"><span class="number">64</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="comment">//table_id: 小端存储，16进制转换为10进制为100</span></span><br><span class="line"><span class="number">01</span> <span class="number">00</span> <span class="comment">//flag:</span></span><br><span class="line"><span class="number">02</span> <span class="number">00</span> <span class="comment">//var header length :小端存储，16进制转换为10进制为2</span></span><br><span class="line"><span class="number">06</span> <span class="comment">//m_width :packet integer，表示表中字段数量</span></span><br><span class="line">ff <span class="comment">//before image: (m_width + 7) / 8字节</span></span><br><span class="line">c0 <span class="comment">//after_bitmap_bits :insert插入之后的记录的NULL标记，表中六个字段，插入的值都不为NULL</span></span><br><span class="line"><span class="comment">//after_columns_content：insert插入记录之后的记录值</span></span><br><span class="line"><span class="number">01</span> </span><br><span class="line">0b <span class="number">00</span> </span><br><span class="line">6f <span class="number">00</span> <span class="number">00</span> </span><br><span class="line"><span class="number">57</span> <span class="number">04</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line"><span class="number">67</span> 2b <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line"><span class="number">01</span> </span><br><span class="line"><span class="number">10</span> 7e <span class="number">17</span> <span class="number">50</span> <span class="comment">//checksum</span></span><br></pre></td></tr></table></figure>



<h2 id="Update-rows-log-event"><a href="#Update-rows-log-event" class="headerlink" title="Update_rows_log_event"></a>Update_rows_log_event</h2><p>在以 ROW 格式记录的 binlog 文件中，Update_rows_log_event 记录了更新的行记录。</p>
<h3 id="post-header-部分-6"><a href="#post-header-部分-6" class="headerlink" title="post-header 部分"></a>post-header 部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>table_id</td>
<td>6 字节</td>
<td>操作的表的 table_id</td>
</tr>
<tr>
<td>flags</td>
<td>2 字节</td>
<td>目前版本没有用，都是 0，保留给之后的版本使用</td>
</tr>
</tbody></table>
<h3 id="event-body-部分-6"><a href="#event-body-部分-6" class="headerlink" title="event-body 部分"></a>event-body 部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>var_header</td>
<td>2 字节</td>
<td></td>
</tr>
<tr>
<td>m_width</td>
<td>packed integer (1 或 3 或 4 或 9 个字节)</td>
<td>表中字段数量</td>
</tr>
<tr>
<td>before_image</td>
<td>(m_with+7)/8 字节</td>
<td></td>
</tr>
<tr>
<td>after_image</td>
<td>(m_with+7)/8 字节</td>
<td></td>
</tr>
<tr>
<td>before_bitmap_bits</td>
<td>(m_with+7)/8 字节</td>
<td>before_bitmap_bits 记录的是 update 更改之前的记录中，字段值是否为 NULL 标记，一个 bit 表示一个字段是否为 NULL，顺序是：第一个字节的最低位开始向最高位开始增长，之后第二个字节的最低位开始向最高位增长，以此类推</td>
</tr>
<tr>
<td>before_column_content</td>
<td>不定</td>
<td>update 更新之前的记录值，按照顺序每个字段的内容</td>
</tr>
<tr>
<td>after_bitmap_bits</td>
<td>(m_with+7)/8 字节</td>
<td>after_bitmap_bits 记录的是 update 更改之前的记录中，字段值是否为 NULL 标记，一个 bit 表示一个字段是否为 NULL，顺序是：第一个字节的最低位开始向最高位开始增长，之后第二个字节的最低位开始向最高位增长，以此类推</td>
</tr>
<tr>
<td>after_column_content</td>
<td>不定</td>
<td>update 更新之后的记录值，按照顺序每个字段的内容</td>
</tr>
<tr>
<td>check_sum</td>
<td>4 字节</td>
<td>校验码</td>
</tr>
</tbody></table>
<h3 id="字节解析示例-6"><a href="#字节解析示例-6" class="headerlink" title="字节解析示例"></a>字节解析示例</h3><p>建表语句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `int_table` (</span><br><span class="line">  `col1` tinyint(4) DEFAULT NULL,</span><br><span class="line">  `col2` smallint(6) DEFAULT NULL,</span><br><span class="line">  `col3` mediumint(9) DEFAULT NULL,</span><br><span class="line">  `col4` int(11) DEFAULT NULL,</span><br><span class="line">  `col5` bigint(20) DEFAULT NULL,</span><br><span class="line">  `col6` tinyint(1) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin</span><br></pre></td></tr></table></figure>

<p>插入数据并更新:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@localhost : gangshen 10:20:49&gt; insert into int_table values(1,11,111,1111,11111,true);</span><br><span class="line">Query OK, 1 row affected (0.03 sec)</span><br><span class="line"></span><br><span class="line">root@localhost : gangshen 10:21:20&gt; update int_table set col2=22,col3=222 where col1=1;</span><br><span class="line">Query OK, 1 row affected (0.02 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">root@localhost : gangshen 10:21:44&gt; select * from int_table;</span><br><span class="line">+------+------+------+------+-------+------+</span><br><span class="line">| col1 | col2 | col3 | col4 | col5  | col6 |</span><br><span class="line">+------+------+------+------+-------+------+</span><br><span class="line">|    1 |  22 |  222 | 1111 | 11111 |    1 |</span><br><span class="line">+------+------+------+------+-------+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>对应 Update_rows_log_event 使用 mysqlbinlog 解析</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># at 644</span><br><span class="line">#180103 10:41:37 server id 9999  end_log_pos 720 CRC32 0x5576b52f    Update_rows: table id 231 flags: STMT_END_F</span><br><span class="line">### UPDATE `gangshen`.`int_table`</span><br><span class="line">### WHERE</span><br><span class="line">###  @1=1 /* TINYINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @2=11 /* SHORTINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @3=111 /* MEDIUMINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @4=1111 /* INT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @5=11111 /* LONGINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @6=1 /* TINYINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">### SET</span><br><span class="line">###  @1=1 /* TINYINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @2=22 /* SHORTINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @3=222 /* MEDIUMINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @4=1111 /* INT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @5=11111 /* LONGINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @6=1 /* TINYINT meta=0 nullable=1 is_null=0 */</span><br><span class="line"># at 720</span><br></pre></td></tr></table></figure>

<p>解析二进制文件:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略。。。</span><br><span class="line">64 00 00 00 00 00 //table_id: 小端存储，16进制转换为10进制为100</span><br><span class="line">01 00 //flag:</span><br><span class="line">02 00 //var header length :小端存储，16进制转换为10进制为2</span><br><span class="line">06 //m_width :packet integer，表示表中字段数量</span><br><span class="line">ff //before image: (m_width + 7) / 8字节</span><br><span class="line">ff //after image: (m_width + 7) / 8字节</span><br><span class="line">c0 //before_bitmap_bits :update更新之前记录中NULL标记，表中六个字段，值都不为NULL</span><br><span class="line">//before_column_content接下来是update更新之前记录的值</span><br><span class="line">01 </span><br><span class="line">0b 00</span><br><span class="line">6f 00 00 </span><br><span class="line">57 04 00 00</span><br><span class="line">67 2b 00 00 00 00 00 00</span><br><span class="line">01 </span><br><span class="line">c0 //after_bitmap_bits :update更新之后记录中NULL标记，表中六个字段，值都不为NULL</span><br><span class="line">//after_column_content接下来是update更新之前记录的值</span><br><span class="line">01 </span><br><span class="line">16 00 </span><br><span class="line">de 00 00 </span><br><span class="line">57 04 00 00</span><br><span class="line">67 2b 00 00 00 00 00 00 </span><br><span class="line">01 </span><br><span class="line">16 a3 de bb //checksum</span><br></pre></td></tr></table></figure>



<h2 id="Delete-rows-log-event"><a href="#Delete-rows-log-event" class="headerlink" title="Delete_rows_log_event"></a>Delete_rows_log_event</h2><p>在以 ROW 格式记录的 binlog 文件中，Delete_rows_log_event 记录了删除的行记录。</p>
<h3 id="post-header-部分-7"><a href="#post-header-部分-7" class="headerlink" title="post-header 部分"></a>post-header 部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>table_id</td>
<td>6 字节</td>
<td>操作的表的 table_id</td>
</tr>
<tr>
<td>flags</td>
<td>2 字节</td>
<td>目前版本没有用，都是 0，保留给之后的版本使用</td>
</tr>
</tbody></table>
<h3 id="event-body-部分-7"><a href="#event-body-部分-7" class="headerlink" title="event-body 部分"></a>event-body 部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>var_header</td>
<td>2 字节</td>
<td></td>
</tr>
<tr>
<td>m_width</td>
<td>packed integer (1 或 3 或 4 或 9 个字节)</td>
<td>表中字段数量</td>
</tr>
<tr>
<td>after_image</td>
<td>(m_width + 7)/8 字节</td>
<td></td>
</tr>
<tr>
<td>before_bitmap_bits</td>
<td>(m_with+7)/8 字节</td>
<td>before_bitmap_bits 记录的是 update 更改之前的记录中，字段值是否为 NULL 标记，一个 bit 表示一个字段是否为 NULL，顺序是：第一个字节的最低位开始向最高位开始增长，之后第二个字节的最低位开始向最高位增长，以此类推</td>
</tr>
<tr>
<td>before_column_content</td>
<td>不定</td>
<td>delete 删除之前的记录值，按照顺序每个字段的内容</td>
</tr>
<tr>
<td>check_sum</td>
<td>4 字节</td>
<td>校验码</td>
</tr>
</tbody></table>
<h3 id="字节解析示例-7"><a href="#字节解析示例-7" class="headerlink" title="字节解析示例"></a>字节解析示例</h3><p>建表语句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `int_table` (</span><br><span class="line">  `col1` tinyint(4) DEFAULT NULL,</span><br><span class="line">  `col2` smallint(6) DEFAULT NULL,</span><br><span class="line">  `col3` mediumint(9) DEFAULT NULL,</span><br><span class="line">  `col4` int(11) DEFAULT NULL,</span><br><span class="line">  `col5` bigint(20) DEFAULT NULL,</span><br><span class="line">  `col6` tinyint(1) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin</span><br></pre></td></tr></table></figure>

<p>删除数据:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete from int_table where col1=1;</span><br></pre></td></tr></table></figure>

<p>对应 Delete_rows_log_event 使用 mysqlbinlog 解析</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># at 320</span><br><span class="line">#180103 14:24:54 server id 330619  end_log_pos 375 CRC32 0xce4818b2    Delete_rows: table id 100 flags: STMT_END_F</span><br><span class="line">### DELETE FROM `gangshen`.`int_table`</span><br><span class="line">### WHERE</span><br><span class="line">###  @1=1 /* TINYINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @2=22 /* SHORTINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @3=222 /* MEDIUMINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @4=1111 /* INT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @5=11111 /* LONGINT meta=0 nullable=1 is_null=0 */</span><br><span class="line">###  @6=1 /* TINYINT meta=0 nullable=1 is_null=0 */</span><br><span class="line"># at 375</span><br></pre></td></tr></table></figure>

<p>解析二进制文件:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略</span><br><span class="line">64 00 00 00 00 00 //table_id: 小端存储，16进制转换为10进制为100</span><br><span class="line">01 00 //flag:</span><br><span class="line">02 00 //var header length :小端存储，16进制转换为10进制为2</span><br><span class="line">06 //m_width :packet integer，表示表中字段数量</span><br><span class="line">ff //after image: (m_width + 7) / 8字节</span><br><span class="line">c0 //before_bitmap_bits :delete删除之前的记录的NULL标记，表中六个字段，值都不为NULL</span><br><span class="line">//before_columns_content：delete删除记录之前的记录值</span><br><span class="line">01 </span><br><span class="line">16 00 </span><br><span class="line">de 00 00 </span><br><span class="line">57 04 00 00</span><br><span class="line">67 2b 00 00 00 00 00 00</span><br><span class="line">01 </span><br><span class="line">10 7e 17 50 //checksum</span><br></pre></td></tr></table></figure>



<h2 id="Xid-event"><a href="#Xid-event" class="headerlink" title="Xid_event"></a>Xid_event</h2><p>表示支持内部 XA 的存储引擎上的事务提交。正常的事务是通过 <code>QUERY_EVENT</code> 来发送一个 <code>BEGIN</code> 语句并且通过 <code>QUERY_EVENT</code> 来发送一个 <code>COMMIT</code> 语句（如果事务回滚则发送的是 <code>ROLLBACK</code>）实现。</p>
<h3 id="post-header-部分-8"><a href="#post-header-部分-8" class="headerlink" title="post-header 部分"></a>post-header 部分</h3><p>无</p>
<h3 id="event-body-部分-8"><a href="#event-body-部分-8" class="headerlink" title="event-body 部分"></a>event-body 部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>xid</td>
<td>8 字节</td>
<td>xid 号，小端存储，无符号数</td>
</tr>
<tr>
<td>check_sum</td>
<td>4 字节</td>
<td>校验码</td>
</tr>
</tbody></table>
<h3 id="字节解析示例-8"><a href="#字节解析示例-8" class="headerlink" title="字节解析示例"></a>字节解析示例</h3><p>使用 mysqlbinlog 工具解析对应的 Xid_event</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># at 1691</span><br><span class="line">#180103 15:30:45 server id 330619  end_log_pos 1722 CRC32 0x8816181c    Xid = 2698</span><br><span class="line">COMMIT/*!*/;</span><br><span class="line"># at 1722</span><br></pre></td></tr></table></figure>

<p>解析二进制文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略...</span><br><span class="line">8a 0a 00 00 00 00 00 00 //xid,因为是小端存储，所以实际为0x 00 00 00 00 00 00 0a 8a，转换为10进制为2698</span><br><span class="line">1c 18 16 88 //check_sum</span><br></pre></td></tr></table></figure>



<h2 id="Gtid-log-event"><a href="#Gtid-log-event" class="headerlink" title="Gtid_log_event"></a>Gtid_log_event</h2><p>开启 GTID 模式的场景下，每次事务 commit 提交时，MySQL 会在 binlog 中事务开始写入一个 Gtid_log_event，记录该事务的 GTID 事务号。</p>
<h3 id="post-header-部分-9"><a href="#post-header-部分-9" class="headerlink" title="post-header 部分"></a>post-header 部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>commit_flag</td>
<td>1 字节</td>
<td>标记事务是否提交，非 0 为已提交，为 0 表示，事务未提交</td>
</tr>
<tr>
<td>sid</td>
<td>16 字节</td>
<td>记录 GTID 中 uuid 的部分（不记录‘-’），每 1 个字节表示 uuid 中 2 个字符</td>
</tr>
<tr>
<td>gno</td>
<td>8 字节</td>
<td>小端存储，GTID 中的事务号部分</td>
</tr>
</tbody></table>
<h3 id="event-body-部分-9"><a href="#event-body-部分-9" class="headerlink" title="event-body 部分"></a>event-body 部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>checksum</td>
<td>4 字节</td>
<td>校验码</td>
</tr>
</tbody></table>
<h3 id="字节解析示例-9"><a href="#字节解析示例-9" class="headerlink" title="字节解析示例"></a>字节解析示例</h3><p>使用 mysqlbinlog 工具解析 binlog 文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># at 191</span><br><span class="line">#180109 18:31:08 server id 330619  end_log_pos 239 CRC32 0xd20330e8    GTID [commit=yes]</span><br><span class="line">SET @@SESSION.GTID_NEXT= &#x27;89fbcea2-da65-11e7-a851-fa163e618bac:5&#x27;/*!*/;</span><br><span class="line"># at 239</span><br></pre></td></tr></table></figure>

<p>解析二进制文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略。。。。</span><br><span class="line">01 //commit_flag:标记事务是否已提交，表示已提交</span><br><span class="line">89 fb ce a2 da 65 11 e7 a8 51 fa 16 3e 61 8b ac //sid:GTID中uuid部分，转换为uuid为89fbcea2-da65-11e7-a851-fa163e618bac</span><br><span class="line">05 00 00 00 00 00 00 00 //gno:GTID中的事务号，小端存储，转换为10进制为5</span><br><span class="line">e8 30 03 d2 //checksum</span><br></pre></td></tr></table></figure>



<h2 id="Previous-gtid-log-event"><a href="#Previous-gtid-log-event" class="headerlink" title="Previous_gtid_log_event"></a>Previous_gtid_log_event</h2><p>在开启 GTID 的模式下，每个 binlog 文件开始会记录一个 Previous_gtid_log_event，Previous_gtid_log_event 中会包含当前 binlog 之前所有 binlog 中的 GTID 集合。</p>
<h3 id="post-header-部分-10"><a href="#post-header-部分-10" class="headerlink" title="post-header 部分"></a>post-header 部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>n_sids</td>
<td>8 字节</td>
<td>小端存储，记录之后有几个 GTID 中的 uuid 号</td>
</tr>
<tr>
<td>sid</td>
<td>16 字节</td>
<td>记录 GTID 中 uuid 的部分（不记录‘-’），每 1 个字节表示 uuid 中 2 个字符</td>
</tr>
<tr>
<td>n_intervals</td>
<td>8 字节</td>
<td>记录每个 sid 对应有几个间隔，指的是事务号间隔</td>
</tr>
<tr>
<td>start</td>
<td>8 字节</td>
<td>每个事务号间隔中的起始事务号</td>
</tr>
<tr>
<td>end</td>
<td>8 字节</td>
<td>每个事务号间隔中的结束事务号 + 1</td>
</tr>
</tbody></table>
<h3 id="event-body-部分-10"><a href="#event-body-部分-10" class="headerlink" title="event-body 部分"></a>event-body 部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>checksum</td>
<td>4 字节</td>
<td>校验码</td>
</tr>
</tbody></table>
<h3 id="字节解析示例-10"><a href="#字节解析示例-10" class="headerlink" title="字节解析示例"></a>字节解析示例</h3><p>使用 mysqlbinlog 工具解析 binlog 文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># at 120</span><br><span class="line">#180111 14:10:27 server id 330619  end_log_pos 279 CRC32 0x94a92478    Previous-GTIDs</span><br><span class="line"># 89fbcea2-da65-11e7-a851-fa163e618bac:1-5:999:1050-1052,</span><br><span class="line"># aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1-2:5-7</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<p>解析二进制文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略。。。</span><br><span class="line">02 00 00 00 00 00 00 00 //n_sids:记录之后有几个GTID中的uuid号，小端存储，转换为10进制为2，表后后续有2个uuid号</span><br><span class="line">89 fb ce a2 da 65 11 e7 a8 51 fa 16 3e 61 8b ac //sid:GTID中的uuid号转换为uuid为89fbcea2-da65-11e7-a851-fa163e618bac</span><br><span class="line">03 00 00 00 00 00 00 00 //n_intervals:对应的sid中中对应几个事务号间隔，小端存储，转换为10进制为3，表示有3个事务号间隔</span><br><span class="line">01 00 00 00 00 00 00 00 //start:事务号间隔中的起始事务号，小端存储，转换为10进制为1</span><br><span class="line">06 00 00 00 00 00 00 00 //end:事务号间隔中的结束事务号+1，小端存储，转换为10进制为6，实际的间隔结束事务号为5</span><br><span class="line">e7 03 00 00 00 00 00 00 //start:事务号间隔中的起始事务号，小端存储，转换为10进制为999</span><br><span class="line">e8 03 00 00 00 00 00 00 //end:事务号间隔中的结束事务号+1，小端存储，转换为10进制为1000，实际的间隔结束事务号为999</span><br><span class="line">1a 04 00 00 00 00 00 00 //start:事务号间隔中的起始事务号，小端存储，转换为10进制为1050</span><br><span class="line">1d 04 00 00 00 00 00 00 //end:事务号间隔中的结束事务号+1，小端存储，转换为10进制为1053，实际的间隔结束事务号为1052</span><br><span class="line">aa aa aa aa aa aa aa aa aa aa aa aa aa aa aa aa //sid:GTID中的uuid号转换为uuid为aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa</span><br><span class="line">02 00 00 00 00 00 00 00 //n_intervals:对应的sid中中对应几个事务号间隔，小端存储，转换为10进制为2，表示有2个事务号间隔</span><br><span class="line">01 00 00 00 00 00 00 00 //start:事务号间隔中的起始事务号，小端存储，转换为10进制为1</span><br><span class="line">03 00 00 00 00 00 00 00 //end:事务号间隔中的结束事务号+1，小端存储，转换为10进制为3，实际的间隔结束事务号为2</span><br><span class="line">05 00 00 00 00 00 00 00 //start:事务号间隔中的起始事务号，小端存储，转换为10进制为5</span><br><span class="line">08 00 00 00 00 00 00 00 //end:事务号间隔中的结束事务号+1，小端存储，转换为10进制为8，实际的间隔结束事务号为7</span><br><span class="line">78 24 a9 94 //checksum</span><br></pre></td></tr></table></figure>



<h2 id="Anonymous-gtid-log-event"><a href="#Anonymous-gtid-log-event" class="headerlink" title="Anonymous_gtid_log_event"></a>Anonymous_gtid_log_event</h2><p>MySQL 在 binlog 中记录每一个匿名事务之前会记录一个 Anonymous_gtid_log_event 表示接下来的事务是一个匿名事务。 <strong>注意：因为在 5.6.34 中并不会产生 Anonymous_gtid_log_event，所以以下内容是基于 5.7.19 版本解析</strong></p>
<h3 id="post-header-部分-11"><a href="#post-header-部分-11" class="headerlink" title="post-header 部分"></a>post-header 部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>gtid_flags</td>
<td>1 字节</td>
<td>记录 binlog 格式，如果 gtid_flags 值为 1，表示 binlog 中可能有以 statement 方式记录的 binlog，如果为 0 表示，binlog 中只有以 row 格式记录的 binlog</td>
</tr>
<tr>
<td>sid</td>
<td>16 字节</td>
<td>记录 GTID 中 uuid 的部分（不记录‘-’），每 1 个字节表示 uuid 中 2 个字符</td>
</tr>
<tr>
<td>gno</td>
<td>8 字节</td>
<td>小端存储，GTID 中的事务号部分</td>
</tr>
<tr>
<td>logical_timestamp_typecode</td>
<td>1 字节</td>
<td>判断是否有 last_commit 和 sequence_no，在 logical_tmiestamp_typecode=2 的情况下，有 last_commit 和 sequence_no</td>
</tr>
<tr>
<td>last_commit</td>
<td>8 字节</td>
<td>小端存储，上次提交的事务号</td>
</tr>
<tr>
<td>sequence_no</td>
<td>8 字节</td>
<td>小端存储，本次提交的序列号</td>
</tr>
</tbody></table>
<h3 id="event-body-部分-11"><a href="#event-body-部分-11" class="headerlink" title="event-body 部分"></a>event-body 部分</h3><table>
<thead>
<tr>
<th>字段</th>
<th>字节数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>checksum</td>
<td>4 字节</td>
<td>校验码</td>
</tr>
</tbody></table>
<h3 id="字节解析示例-11"><a href="#字节解析示例-11" class="headerlink" title="字节解析示例"></a>字节解析示例</h3><p>使用 mysqlbinlog 工具解析 binlog 文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#180109 10:53:54 server id 9999  end_log_pos 5681 CRC32 0x46be0639    Anonymous_GTID    last_committed=20    sequence_number=21    rbr_only=yes</span><br><span class="line">/*!50718 SET TRANSACTION ISOLATION LEVEL READ COMMITTED*//*!*/;</span><br><span class="line">SET @@SESSION.GTID_NEXT= &#x27;ANONYMOUS&#x27;/*!*/;</span><br><span class="line"># at 5681</span><br></pre></td></tr></table></figure>

<p>解析二进制文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">公共头部部分省略。。。</span><br><span class="line">00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 //sid:</span><br><span class="line">00 00 00 00 00 00 00 00 //gno:</span><br><span class="line">02 //logical_timestamp_typecode:判断是否有last_commit和sequence_no，在logical_tmiestamp_typecode=2的情况下，有last_commit和sequence_no，所以这边的话，后续有last_commit和sequence_no部分的内容</span><br><span class="line">14 00 00 00 00 00 00 00 //last_commit:上次提交的事务号，小端存储，转换为10机制为20</span><br><span class="line">15 00 00 00 00 00 00 00 //sequence_no:本次提交的序列号，小端存储，转换为10进制为21</span><br><span class="line">39 06 be 46 //checksum:校验码</span><br></pre></td></tr></table></figure>



<h1 id="MySQL-binlog-event-解析实例"><a href="#MySQL-binlog-event-解析实例" class="headerlink" title="MySQL binlog event 解析实例"></a>MySQL binlog event 解析实例</h1><p>进行实际 binlog 的解析，看看常见的 insert、update、delete 语句在 binlog 中存储的形式。</p>
<h2 id="示例：INSERT-语句在-binlog-中-event-表现形式"><a href="#示例：INSERT-语句在-binlog-中-event-表现形式" class="headerlink" title="示例：INSERT 语句在 binlog 中 event 表现形式"></a>示例：INSERT 语句在 binlog 中 event 表现形式</h2><p>下面，我们就看一下一条 INSERT 语句在会产生哪些类型的 event，这些 event 在数据库中查看是怎么样的，在 binlog 文件中查看是怎么样的。</p>
<h3 id="ROW-格式下表现形式"><a href="#ROW-格式下表现形式" class="headerlink" title="ROW 格式下表现形式"></a>ROW 格式下表现形式</h3><p>以下显示内容是在 MySQL-5.6.34 版本上，且 binlog 日志记录格式为 ROW 模式的情况下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">root@localhost : gangshen 09:34:02&gt; show binary logs;</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name        | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql-bin.000001 |      120 |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost : gangshen 09:34:22&gt; show binlog events in &#x27;mysql-bin.000001&#x27;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                  |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------+</span><br><span class="line">| mysql-bin.000001 |  4 | Format_desc |    330619 |        120 | Server ver: 5.6.34-log, Binlog ver: 4 |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost : gangshen 09:34:32&gt; insert into test1(`name`) values(&#x27;woqutech&#x27;);</span><br><span class="line">Query OK, 1 row affected (0.03 sec)</span><br><span class="line"></span><br><span class="line">root@localhost : gangshen 09:36:01&gt; show binlog events in &#x27;mysql-bin.000001&#x27;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+------------------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                          |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+------------------------------------------------+</span><br><span class="line">| mysql-bin.000001 |  4 | Format_desc |    330619 |        120 | Server ver: 5.6.34-log, Binlog ver: 4          |</span><br><span class="line">| mysql-bin.000001 | 120 | Query      |    330619 |        201 | BEGIN                                          |</span><br><span class="line">| mysql-bin.000001 | 201 | Rows_query  |    330619 |        269 | # insert into test1(`name`) values(&#x27;woqutech&#x27;) |</span><br><span class="line">| mysql-bin.000001 | 269 | Table_map  |    330619 |        324 | table_id: 70 (gangshen.test1)                  |</span><br><span class="line">| mysql-bin.000001 | 324 | Write_rows  |    330619 |        373 | table_id: 70 flags: STMT_END_F                |</span><br><span class="line">| mysql-bin.000001 | 373 | Xid        |    330619 |        404 | COMMIT /* xid=13 */                            |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+------------------------------------------------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>从数据库中，我们可以看到 <code>insert into test1(</code>name<code>) values(&#39;woqutech&#39;);</code> 语句，在 binlog 日志文件中转换成了 5 个 event 存储，分别为 Query,Rows_query,Table_map,Write_rows,Xid 类型的 event，这些 event 中，Query event 表示一个更新语句的开始，Rows_query event 记录了更新语句的语句内容，Table_map event 中记录了 insert 语句操作的表的信息，Write_rows event 记录了真实更新的记录的内容，最后一个 Xid event 中表示 COMMIT 操作。</p>
<p>在数据库中查看 binlog 文件内容可以很直观的看到，event 的类型以及主要内容，那我们接着来看看，在 binlog 文件中，通过 mysqlbinlog 工具可以看到的具体内容是什么样的。</p>
<p>可以看到通过 mysqlbinlog 工具查看 binlog 文件，可以看到每个 event 中更加详细的内容。</p>
<h3 id="STATEMENT-格式下表现形式"><a href="#STATEMENT-格式下表现形式" class="headerlink" title="STATEMENT 格式下表现形式"></a>STATEMENT 格式下表现形式</h3><p>以下显示内容是在 MySQL-5.6.34 版本上，且 binlog 日志记录格式为 STATEMENT 模式的情况下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">root@localhost : gangshen 04:31:35&gt; show binary logs;</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name        | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql-bin.000001 |      143 |</span><br><span class="line">| mysql-bin.000002 |      120 |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost : gangshen 04:31:48&gt; show binlog events in &#x27;mysql-bin.000002&#x27;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                  |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------+</span><br><span class="line">| mysql-bin.000002 |  4 | Format_desc |    330619 |        120 | Server ver: 5.6.34-log, Binlog ver: 4 |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost : gangshen 04:32:02&gt; insert into test1(`name`) values(&#x27;woqu112233&#x27;);</span><br><span class="line">Query OK, 1 row affected (0.05 sec)</span><br><span class="line"></span><br><span class="line">root@localhost : gangshen 04:32:29&gt; show binlog events in &#x27;mysql-bin.000002&#x27;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+----------------------------------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                                          |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+----------------------------------------------------------------+</span><br><span class="line">| mysql-bin.000002 |  4 | Format_desc |    330619 |        120 | Server ver: 5.6.34-log, Binlog ver: 4                          |</span><br><span class="line">| mysql-bin.000002 | 120 | Query      |    330619 |        212 | BEGIN                                                          |</span><br><span class="line">| mysql-bin.000002 | 212 | Intvar      |    330619 |        244 | INSERT_ID=8                                                    |</span><br><span class="line">| mysql-bin.000002 | 244 | Query      |    330619 |        377 | use `gangshen`; insert into test1(`name`) values(&#x27;woqu112233&#x27;) |</span><br><span class="line">| mysql-bin.000002 | 377 | Xid        |    330619 |        408 | COMMIT /* xid=17 */                                            |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+----------------------------------------------------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>从数据库中我们可以看到 <code>insert into test1(</code>name<code>) values(&#39;woqu112233&#39;);</code> 这个 insert 语句转换成了 4 个 event，分别是 Query,Intvar,Quert,Xid4 个 event。第一个 Query 的 event 表示语句开始执行，第二个 Intvar 的 event，是因为表结构中的 id 字段定义的是 auto_increment，这个 Intvar event 是对自增的主键生成主键值的，接着的 Query 的 event 就是真实执行的语句了，最后一个 Xid 表示语句的提交。 在数据库中查看 binlog 文件内容可以很直观的看到，event 的类型以及主要内容，那我们接着来看看，在 binlog 文件中，通过 mysqlbinlog 工具可以看到的具体内容是什么样的。</p>
<h2 id="示例：UPDATE-语句在-binlog-中-event-表现形式"><a href="#示例：UPDATE-语句在-binlog-中-event-表现形式" class="headerlink" title="示例：UPDATE 语句在 binlog 中 event 表现形式"></a>示例：UPDATE 语句在 binlog 中 event 表现形式</h2><p>下面，我们就看一下一条 UPDATE 语句在会产生哪些类型的 event，这些 event 在数据库中查看是怎么样的，在 binlog 文件中查看是怎么样的。</p>
<h3 id="ROW-格式下表现形式-1"><a href="#ROW-格式下表现形式-1" class="headerlink" title="ROW 格式下表现形式"></a>ROW 格式下表现形式</h3><p>以下显示内容是在 MySQL-5.6.34 版本上，且 binlog 日志记录格式为 ROW 模式的情况下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show binary logs;</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name        | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql-bin.000001 |      120 |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show binlog events in &#x27;mysql-bin.000001&#x27;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                        |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------+</span><br><span class="line">| mysql-bin.000001 |  4 | Format_desc |      9999 |        120 | Server ver: 5.6.34-debug-log, Binlog ver: 4 |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; update test1 set name=&#x27;woqutech_new&#x27; where name=&#x27;woqutech&#x27;;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; show binlog events in &#x27;mysql-bin.000001&#x27;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+--------------------------------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                                        |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+--------------------------------------------------------------+</span><br><span class="line">| mysql-bin.000001 |  4 | Format_desc |      9999 |        120 | Server ver: 5.6.34-debug-log, Binlog ver: 4                  |</span><br><span class="line">| mysql-bin.000001 | 120 | Query      |      9999 |        196 | BEGIN                                                        |</span><br><span class="line">| mysql-bin.000001 | 196 | Rows_query  |      9999 |        278 | # update test1 set name=&#x27;woqutech_new&#x27; where name=&#x27;woqutech&#x27; |</span><br><span class="line">| mysql-bin.000001 | 278 | Table_map  |      9999 |        333 | table_id: 70 (gangshen.test1)                                |</span><br><span class="line">| mysql-bin.000001 | 333 | Update_rows |      9999 |        401 | table_id: 70 flags: STMT_END_F                              |</span><br><span class="line">| mysql-bin.000001 | 401 | Xid        |      9999 |        432 | COMMIT /* xid=16 */                                          |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+--------------------------------------------------------------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>从数据库中，我们可以看到 <code>update test1 set name=&#39;woqutech_new&#39; where name=&#39;woqutech&#39;;</code> 语句，在 binlog 日志文件中转换成了 5 个 event 存储，分别为 Query,Rows_query,Table_map,Update_rows,Xid 类型的 event，这些 event 中，Query event 表示一个更新语句的开始，Rows_query event 记录了更新语句的语句内容，Table_map event 中记录了 insert 语句操作的表的信息，Update_rows event 记录了真实更新的记录的内容，最后一个 Xid event 中表示 COMMIT 操作。</p>
<p>在数据库中查看 binlog 文件内容可以很直观的看到，event 的类型以及主要内容，那我们接着来看看，在 binlog 文件中，通过 mysqlbinlog 工具可以看到的具体内容是什么样的。</p>
<p>可以看到通过 mysqlbinlog 工具查看 binlog 文件，可以看到每个 event 中更加详细的内容。</p>
<h3 id="STATEMENT-格式下表现形式-1"><a href="#STATEMENT-格式下表现形式-1" class="headerlink" title="STATEMENT 格式下表现形式"></a>STATEMENT 格式下表现形式</h3><p>以下显示内容是在 MySQL-5.6.34 版本上，且 binlog 日志记录格式为 STATEMENT 模式的情况下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show binary logs;</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name        | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql-bin.000001 |      120 |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show binlog events in &#x27;mysql-bin.000001&#x27;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                        |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------+</span><br><span class="line">| mysql-bin.000001 |  4 | Format_desc |      9999 |        120 | Server ver: 5.6.34-debug-log, Binlog ver: 4 |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; update test1 set name=&#x27;woqutech_new&#x27; where name=&#x27;woqutech&#x27;;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; show binlog events in &#x27;mysql-bin.000001&#x27;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+----------------------------------------------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                                                      |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+----------------------------------------------------------------------------+</span><br><span class="line">| mysql-bin.000001 |  4 | Format_desc |      9999 |        120 | Server ver: 5.6.34-debug-log, Binlog ver: 4                                |</span><br><span class="line">| mysql-bin.000001 | 120 | Query      |      9999 |        207 | BEGIN                                                                      |</span><br><span class="line">| mysql-bin.000001 | 207 | Query      |      9999 |        347 | use `gangshen`; update test1 set name=&#x27;woqutech_new&#x27; where name=&#x27;woqutech&#x27; |</span><br><span class="line">| mysql-bin.000001 | 347 | Xid        |      9999 |        378 | COMMIT /* xid=46 */                                                        |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+----------------------------------------------------------------------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>从数据库中我们可以看到 <code>update test1 set name=&#39;woqutech_new&#39; where name=&#39;woqutech&#39;;</code> 这个 insert 语句转换成了 3 个 event，分别是 Query,Quert,Xid4 个 event。第一个 Query 的 event 表示语句开始执行，接着的 Query 的 event 就是真实执行的语句了，最后一个 Xid 表示语句的提交。 在数据库中查看 binlog 文件内容可以很直观的看到，event 的类型以及主要内容，那我们接着来看看，在 binlog 文件中，通过 mysqlbinlog 工具可以看到的具体内容是什么样的。</p>
<h2 id="示例：DELETE-语句在-binlog-中-event-表现形式"><a href="#示例：DELETE-语句在-binlog-中-event-表现形式" class="headerlink" title="示例：DELETE 语句在 binlog 中 event 表现形式"></a>示例：DELETE 语句在 binlog 中 event 表现形式</h2><p>下面，我们就看一下一条 DELETE 语句在会产生哪些类型的 event，这些 event 在数据库中查看是怎么样的，在 binlog 文件中查看是怎么样的。</p>
<h3 id="ROW-格式下表现形式-2"><a href="#ROW-格式下表现形式-2" class="headerlink" title="ROW 格式下表现形式"></a>ROW 格式下表现形式</h3><p>以下显示内容是在 MySQL-5.6.34 版本上，且 binlog 日志记录格式为 ROW 模式的情况下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">root@localhost : gangshen 09:34:02&gt; show binary logs;</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name        | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql-bin.000001 |      120 |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">root@localhost : gangshen 09:34:22&gt; show binlog events in &#x27;mysql-bin.000001&#x27;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                  |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------+</span><br><span class="line">| mysql-bin.000001 |  4 | Format_desc |    330619 |        120 | Server ver: 5.6.34-log, Binlog ver: 4 |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; delete from test1 where id = 1;</span><br><span class="line">Query OK, 1 row affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show binlog events in &#x27;mysql-bin.000001&#x27;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                        |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------+</span><br><span class="line">| mysql-bin.000001 |  4 | Format_desc |      9999 |        120 | Server ver: 5.6.34-debug-log, Binlog ver: 4 |</span><br><span class="line">| mysql-bin.000001 | 120 | Query      |      9999 |        196 | BEGIN                                      |</span><br><span class="line">| mysql-bin.000001 | 196 | Rows_query  |      9999 |        250 | # delete from test1 where id = 1            |</span><br><span class="line">| mysql-bin.000001 | 250 | Table_map  |      9999 |        305 | table_id: 70 (gangshen.test1)              |</span><br><span class="line">| mysql-bin.000001 | 305 | Delete_rows |      9999 |        358 | table_id: 70 flags: STMT_END_F              |</span><br><span class="line">| mysql-bin.000001 | 358 | Xid        |      9999 |        389 | COMMIT /* xid=27 */                        |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>从数据库中，我们可以看到 <code>delete from test1 where id = 1;</code> 语句，在 binlog 日志文件中转换成了 5 个 event 存储，分别为 Query,Rows_query,Table_map,Delete_rows,Xid 类型的 event，这些 event 中，Query event 表示一个更新语句的开始，Rows_query event 记录了更新语句的语句内容，Table_map event 中记录了 insert 语句操作的表的信息，Delete_rows event 记录了真实更新的记录的内容，最后一个 Xid event 中表示 COMMIT 操作。</p>
<p>在数据库中查看 binlog 文件内容可以很直观的看到，event 的类型以及主要内容，那我们接着来看看，在 binlog 文件中，通过 mysqlbinlog 工具可以看到的具体内容是什么样的。</p>
<p>可以看到通过 mysqlbinlog 工具查看 binlog 文件，可以看到每个 event 中更加详细的内容。</p>
<h3 id="STATEMENT-格式下表现形式-2"><a href="#STATEMENT-格式下表现形式-2" class="headerlink" title="STATEMENT 格式下表现形式"></a>STATEMENT 格式下表现形式</h3><p>以下显示内容是在 MySQL-5.6.34 版本上，且 binlog 日志记录格式为 STATEMENT 模式的情况下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show binary logs;</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| Log_name        | File_size |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| mysql-bin.000001 |      120 |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show binlog events in &#x27;mysql-bin.000001&#x27;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                        |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------+</span><br><span class="line">| mysql-bin.000001 |  4 | Format_desc |      9999 |        120 | Server ver: 5.6.34-debug-log, Binlog ver: 4 |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; delete from test1 where name = &#x27;woqutech_new&#x27;;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show binlog events in &#x27;mysql-bin.000001&#x27;;</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------------------------+</span><br><span class="line">| Log_name        | Pos | Event_type  | Server_id | End_log_pos | Info                                                          |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------------------------+</span><br><span class="line">| mysql-bin.000001 |  4 | Format_desc |      9999 |        120 | Server ver: 5.6.34-debug-log, Binlog ver: 4                  |</span><br><span class="line">| mysql-bin.000001 | 120 | Query      |      9999 |        207 | BEGIN                                                        |</span><br><span class="line">| mysql-bin.000001 | 207 | Query      |      9999 |        334 | use `gangshen`; delete from test1 where name = &#x27;woqutech_new&#x27; |</span><br><span class="line">| mysql-bin.000001 | 334 | Xid        |      9999 |        365 | COMMIT /* xid=58 */                                          |</span><br><span class="line">+------------------+-----+-------------+-----------+-------------+---------------------------------------------------------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>从数据库中我们可以看到 <code>delete from test1 where name = &#39;woqutech_new&#39;;</code> 这个 insert 语句转换成了 3 个 event，分别是 Query,Quert,Xid4 个 event。第一个 Query 的 event 表示语句开始执行，接着的 Query 的 event 就是真实执行的语句了，最后一个 Xid 表示语句的提交。 在数据库中查看 binlog 文件内容可以很直观的看到，event 的类型以及主要内容，那我们接着来看看，在 binlog 文件中，通过 mysqlbinlog 工具可以看到的具体内容是什么样的。</p>
<h1 id="binlog-checksum"><a href="#binlog-checksum" class="headerlink" title="binlog checksum"></a>binlog checksum</h1><p>从 MySQL5.6 开始，写 binlog 时会为每个 event 写入一个校验值。</p>
<p>当 binlog_checksum=NONE，则通过检查每个 event 的长度来验证写入 binlog event 的完整性。默认值为 CRC32。</p>
<p>启用 binlog_checksum 后，slave io 线程会检查通过网络接收到的 binlog event 的校验值是否正确，如果检查到损坏的 event，将停止复制并报错。</p>
<p>另外，还可以通过配置指定在以下两个地方通过校验值验证 event 的完整性：</p>
<ul>
<li>master_verify_checksum，默认值为 OFF，如果设置为 ON，则在从 master 上读取 binlog event 时，会进行校验。具体在以下场景会触发读取 binlog：<ul>
<li>show binlog events 时</li>
<li>binlog dump 线程向 slave 发送 binlog 时</li>
</ul>
</li>
<li>slave_sql_verify_checksum，默认值为 ON，在 slave sql 线程从 relay log 中读取 event 时，验证校验值。</li>
</ul>
<p>默认情况下 mysqlbinlog 客户端程序在解析 binlog 文件时不会验证校验值，但是也可以使用 verify-binlog-checksum 参数进行校验。</p>
<h1 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h1><ul>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904053441298439">MySQL Binlog (一)——MySQL 复制原理基础</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904053445492750">MySQL Binlog (四)—— MySQL binlog event 解析 —— 基础知识</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904053449687048">MySQL Binlog (五)——MySQL 常见 binlog event 解析（上）</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904053449687047">MySQL Binlog (六)——MySQL 常见 binlog event 解析（中）</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904053449703432">MySQL Binlog (七)——MySQL 常见 binlog event 解析（下）</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904053453881357">MySQL Binlog (十一)——MySQL binlog event 解析实例</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/0957a89d4fb4">MySQL:binlog_checksum</a></li>
</ul>
</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>