<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="gure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;go get github.com/spf13/cobra/cobra&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;



&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;http://github.com/spf13/cobra&quot;&gt;cobra&lt;/a&gt; 是一个命令行程序库，可以用来编写命令行程序。同时，它也提供了一个脚手架， 用于生成基于 cobra 的应用程序框架。非常多知名的开源项目使用了 cobra 库构建命令行，如 &lt;a href=&quot;http://kubernetes.io/&quot;&gt;Kubernetes&lt;/a&gt;、&lt;a href=&quot;http://gohugo.io/&quot;&gt;Hugo&lt;/a&gt;、&lt;a href=&quot;https://github.com/coreos/etcd&quot;&gt;etcd&lt;/a&gt; 等等。 "><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>cobra | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Golang/" rel="tag">Golang</a></div><div class="post-time">2022-02-23</div></div></div><div class="container post-header"><h1>cobra</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%B9%E6%80%A7"><span class="toc-number">2.</span> <span class="toc-text">特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#quick-start"><span class="toc-number">3.</span> <span class="toc-text">quick start</span></a></li></ol></details></div><div class="container post-content"><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/spf13/cobra/cobra</span><br></pre></td></tr></table></figure>



<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><a target="_blank" rel="noopener" href="http://github.com/spf13/cobra">cobra</a> 是一个命令行程序库，可以用来编写命令行程序。同时，它也提供了一个脚手架， 用于生成基于 cobra 的应用程序框架。非常多知名的开源项目使用了 cobra 库构建命令行，如 <a target="_blank" rel="noopener" href="http://kubernetes.io/">Kubernetes</a>、<a target="_blank" rel="noopener" href="http://gohugo.io/">Hugo</a>、<a target="_blank" rel="noopener" href="https://github.com/coreos/etcd">etcd</a> 等等。 </p>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><p>cobra 提供非常丰富的功能：</p>
<ul>
<li>轻松支持子命令，如 <code>app server</code>，<code>app fetch</code> 等；</li>
<li>完全兼容 POSIX 选项（包括短、长选项）；</li>
<li>嵌套子命令；</li>
<li>全局、本地层级选项。可以在多处设置选项，按照一定的顺序取用；</li>
<li>使用脚手架轻松生成程序框架和命令。</li>
</ul>
<p>首先需要明确 3 个基本概念：</p>
<ul>
<li>命令（Command）：就是需要执行的操作；</li>
<li>参数（Arg）：命令的参数，即要操作的对象；</li>
<li>选项（Flag）：命令选项可以调整命令的行为。</li>
</ul>
<p>下面示例中，<code>server</code> 是一个（子）命令，<code>--port</code> 是选项：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hugo server --port=1313</span><br></pre></td></tr></table></figure>

<p>下面示例中，<code>clone</code> 是一个（子）命令，<code>URL</code> 是参数，<code>--bare</code> 是选项：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone URL --bare</span><br></pre></td></tr></table></figure>



<h2 id="quick-start"><a href="#quick-start" class="headerlink" title="quick start"></a>quick start</h2><p>实现一个简单的命令行程序 git，当然这不是真的 git，只是模拟其命令行。最终还是通过 <code>os/exec</code> 库调用外部程序执行真实的 git 命令，返回结果。 所以我们的系统上要安装 git，且 git 在可执行路径中。目前我们只添加一个子命令 <code>version</code>。目录结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">▾ get-started/</span><br><span class="line">    ▾ cmd/</span><br><span class="line">        helper.go</span><br><span class="line">        root.go</span><br><span class="line">        version.go</span><br><span class="line">    main.go</span><br></pre></td></tr></table></figure>



<p><code>root.go</code>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cmd</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;errors&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="string">&quot;github.com/spf13/cobra&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> rootCmd = &amp;cobra.Command &#123;</span><br><span class="line">  Use: <span class="string">&quot;git&quot;</span>,</span><br><span class="line">  Short: <span class="string">&quot;Git is a distributed version control system.&quot;</span>,</span><br><span class="line">  Long: <span class="string">`Git is a free and open source distributed version control system</span></span><br><span class="line"><span class="string">designed to handle everything from small to very large projects </span></span><br><span class="line"><span class="string">with speed and efficiency.`</span>,</span><br><span class="line">  Run: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    Error(cmd, args, errors.New(<span class="string">&quot;unrecognized command&quot;</span>))</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Execute</span><span class="params">()</span></span> &#123;</span><br><span class="line">  rootCmd.Execute()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>version.go</code>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cmd</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;os&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="string">&quot;github.com/spf13/cobra&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> versionCmd = &amp;cobra.Command &#123;</span><br><span class="line">  Use: <span class="string">&quot;version&quot;</span>,</span><br><span class="line">  Short: <span class="string">&quot;version subcommand show git version info.&quot;</span>,</span><br><span class="line">  </span><br><span class="line">  Run: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    output, err := ExecuteCommand(<span class="string">&quot;git&quot;</span>, <span class="string">&quot;version&quot;</span>, args...)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      Error(cmd, args, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fmt.Fprint(os.Stdout, output)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">  rootCmd.AddCommand(versionCmd)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>main.go</code> 文件中只是调用命令入口：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;github.com/darjun/go-daily-lib/cobra/get-started/cmd&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  cmd.Execute()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>为了编码方便，在 <code>helpers.go</code> 中封装了调用外部程序和错误处理函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cmd</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;os&quot;</span></span><br><span class="line">  <span class="string">&quot;os/exec&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="string">&quot;github.com/spf13/cobra&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ExecuteCommand</span><span class="params">(name <span class="keyword">string</span>, subname <span class="keyword">string</span>, args ...<span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">  args = <span class="built_in">append</span>([]<span class="keyword">string</span>&#123;subname&#125;, args...)</span><br><span class="line"></span><br><span class="line">  cmd := exec.Command(name, args...)</span><br><span class="line">  bytes, err := cmd.CombinedOutput()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">string</span>(bytes), err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Error</span><span class="params">(cmd *cobra.Command, args []<span class="keyword">string</span>, err error)</span></span> &#123;</span><br><span class="line">  fmt.Fprintf(os.Stderr, <span class="string">&quot;execute %s args:%v error:%v\n&quot;</span>, cmd.Name(), args, err)</span><br><span class="line">  os.Exit(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每个 cobra 程序都有一个根命令，可以给它添加任意多个子命令。我们在 <code>version.go</code> 的 <code>init</code> 函数中将子命令添加到根命令中。</p>
<p>调用子命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./main.exe version</span><br><span class="line">git version 2.19.1.windows.1</span><br></pre></td></tr></table></figure>



<p>未识别的子命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ./main.exe <span class="built_in">clone</span></span><br><span class="line">Error: unknown <span class="built_in">command</span> <span class="string">&quot;clone&quot;</span> <span class="keyword">for</span> <span class="string">&quot;git&quot;</span></span><br><span class="line">Run <span class="string">&#x27;git --help&#x27;</span> <span class="keyword">for</span> usage.</span><br></pre></td></tr></table></figure>



<p>使用 cobra 构建命令行时，程序的目录结构一般比较简单，推荐使用下面这种结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">▾ appName/</span><br><span class="line">    ▾ cmd/</span><br><span class="line">        cmd1.go</span><br><span class="line">        cmd2.go</span><br><span class="line">        cmd3.go</span><br><span class="line">        root.go</span><br><span class="line">    main.go</span><br></pre></td></tr></table></figure>

<p>每个命令实现一个文件，所有命令文件存放在 <code>cmd</code> 目录下。外层的 <code>main.go</code> 仅初始化 cobra。</p>
</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>