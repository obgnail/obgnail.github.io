<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;第-14-章-任务和特权级保护&quot;&gt;&lt;a href=&quot;#第-14-章-任务和特权级保护&quot; class=&quot;headerlink&quot; title=&quot;第 14 章 任务和特权级保护&quot;&gt;&lt;/a&gt;第 14 章 任务和特权级保护&lt;/h1&gt;&lt;h2 id=&quot;为何要使用特权级保护&quot;&gt;&lt;a href=&quot;#为何要使用特权级保护&quot; class=&quot;headerlink&quot; title=&quot;为何要使用特权级保护&quot;&gt;&lt;/a&gt;为何要使用特权级保护&lt;/h2&gt;&lt;p&gt;在保护模式下，通过将内存分成大小不等的段，并用描述符对每个段的用途、类型和长度进行指定，就可以在程序运行时由处理器硬件施加访问保护。"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>2 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Assembly-Language/" rel="tag">Assembly Language</a></div><div class="post-time">2022-02-18</div></div></div><div class="container post-header"><h1>2</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC-14-%E7%AB%A0-%E4%BB%BB%E5%8A%A1%E5%92%8C%E7%89%B9%E6%9D%83%E7%BA%A7%E4%BF%9D%E6%8A%A4"><span class="toc-number">1.</span> <span class="toc-text">第 14 章 任务和特权级保护</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BD%95%E8%A6%81%E4%BD%BF%E7%94%A8%E7%89%B9%E6%9D%83%E7%BA%A7%E4%BF%9D%E6%8A%A4"><span class="toc-number">1.1.</span> <span class="toc-text">为何要使用特权级保护</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E3%80%81%E4%BB%BB%E5%8A%A1%E7%9A%84-LDT-%E5%92%8C-TSS"><span class="toc-number">1.2.</span> <span class="toc-text">任务、任务的 LDT 和 TSS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1"><span class="toc-number">1.2.1.</span> <span class="toc-text">任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%80%E9%83%A8%E6%8F%8F%E8%BF%B0%E7%AC%A6%E8%A1%A8%E5%AF%84%E5%AD%98%E5%99%A8-LDT"><span class="toc-number">1.2.2.</span> <span class="toc-text">局部描述符表寄存器(LDT)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E7%8A%B6%E6%80%81%E6%AE%B5-TSS-%E5%92%8CTR%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-number">1.2.3.</span> <span class="toc-text">任务状态段(TSS)和TR寄存器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E7%A9%BA%E9%97%B4%E5%92%8C%E5%B1%80%E9%83%A8%E7%A9%BA%E9%97%B4"><span class="toc-number">1.3.</span> <span class="toc-text">全局空间和局部空间</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%B9%E6%9D%83%E7%BA%A7%E6%A6%82%E8%BF%B0"><span class="toc-number">1.4.</span> <span class="toc-text">特权级概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%8F%E8%BF%B0%E7%AC%A6%E7%89%B9%E6%9D%83%E7%BA%A7-DPL"><span class="toc-number">1.4.1.</span> <span class="toc-text">描述符特权级 DPL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E7%89%B9%E6%9D%83%E7%BA%A7-RPL"><span class="toc-number">1.4.2.</span> <span class="toc-text">请求特权级 RPL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BD%93%E5%89%8D%E7%89%B9%E6%9D%83%E7%BA%A7-CPL"><span class="toc-number">1.4.3.</span> <span class="toc-text">当前特权级 CPL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E6%9D%83%E6%8C%87%E4%BB%A4"><span class="toc-number">1.4.4.</span> <span class="toc-text">特权指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%93%E5%85%A5-%E8%BE%93%E5%87%BA%E7%89%B9%E6%9D%83%E7%BA%A7"><span class="toc-number">1.4.5.</span> <span class="toc-text">输入&#x2F;输出特权级</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%B9%E6%9D%83%E7%BA%A7%E6%A3%80%E6%9F%A5"><span class="toc-number">1.5.</span> <span class="toc-text">特权级检查</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%9D%E4%BB%8E%E4%BB%A3%E7%A0%81%E6%AE%B5"><span class="toc-number">1.5.1.</span> <span class="toc-text">依从代码段</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E5%8F%AB%E2%80%9C%E4%BE%9D%E4%BB%8E%E2%80%9D"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">为什么叫“依从”</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%A8%E6%8F%8F%E8%BF%B0%E7%AC%A6"><span class="toc-number">1.5.2.</span> <span class="toc-text">门描述符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RPL%E3%80%81CPL-%E5%92%8C-DPL"><span class="toc-number">1.5.3.</span> <span class="toc-text">RPL、CPL 和 DPL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%BC%95%E5%85%A5-RPL"><span class="toc-number">1.5.4.</span> <span class="toc-text">为什么要引入 RPL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%9A%84%E7%89%B9%E6%9D%83%E7%BA%A7%E6%A3%80%E6%9F%A5%E8%A7%84%E5%88%99"><span class="toc-number">1.5.5.</span> <span class="toc-text">基本的特权级检查规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">1.5.6.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.6.</span> <span class="toc-text">内核程序的初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F%E5%BE%AE%E5%9E%8B%E6%A0%B8%E5%BF%83%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.6.1.</span> <span class="toc-text">保护模式微型核心程序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E5%86%85%E6%A0%B8%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.6.2.</span> <span class="toc-text">加载内核程序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%97%A8"><span class="toc-number">1.6.3.</span> <span class="toc-text">调用门</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%97%A8%E6%8F%8F%E8%BF%B0%E7%AC%A6%E5%AD%98%E5%82%A8%E7%9A%84%E6%98%AF%E9%80%89%E6%8B%A9%E5%AD%90%E8%80%8C%E4%B8%8D%E6%98%AF%E7%BA%BF%E6%80%A7%E5%9C%B0%E5%9D%80"><span class="toc-number">1.6.3.1.</span> <span class="toc-text">为什么门描述符存储的是选择子而不是线性地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%A8%E6%8F%8F%E8%BF%B0%E7%AC%A6%E7%9A%84%E5%B1%9E%E6%80%A7%E4%BD%8D"><span class="toc-number">1.6.3.2.</span> <span class="toc-text">门描述符的属性位</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E8%B0%83%E7%94%A8%E9%97%A8%E8%BF%9B%E8%A1%8C%E6%8E%A7%E5%88%B6%E8%BD%AC%E7%A7%BB"><span class="toc-number">1.6.3.3.</span> <span class="toc-text">通过调用门进行控制转移</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%93%AA%E4%BA%9B%E7%A8%8B%E5%BA%8F%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AE%E9%97%A8"><span class="toc-number">1.6.3.4.</span> <span class="toc-text">哪些程序可以访问门</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%97%A8%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E6%B5%8B%E8%AF%95"><span class="toc-number">1.6.4.</span> <span class="toc-text">调用门的安装和测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E7%94%A8%E6%88%B7%E7%A8%8B%E5%BA%8F%E5%B9%B6%E5%88%9B%E5%BB%BA%E4%BB%BB%E5%8A%A1"><span class="toc-number">1.7.</span> <span class="toc-text">加载用户程序并创建任务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E6%8E%A7%E5%88%B6%E5%9D%97%E5%92%8C-TCB-%E9%93%BE"><span class="toc-number">1.7.1.</span> <span class="toc-text">任务控制块和 TCB 链</span></a></li></ol></li></ol></li></ol></details></div><div class="container post-content"><h1 id="第-14-章-任务和特权级保护"><a href="#第-14-章-任务和特权级保护" class="headerlink" title="第 14 章 任务和特权级保护"></a>第 14 章 任务和特权级保护</h1><h2 id="为何要使用特权级保护"><a href="#为何要使用特权级保护" class="headerlink" title="为何要使用特权级保护"></a>为何要使用特权级保护</h2><p>在保护模式下，通过将内存分成大小不等的段，并用描述符对每个段的用途、类型和长度进行指定，就可以在程序运行时由处理器硬件施加访问保护。</p>
<blockquote>
<p>比如，当程序试图让处理器去写一个可执行的代码段时， 处理器就会阻止这种企图；当程序试图让处理器访问超过段界限的内存区域时，处理器也会引发异常中断。</p>
</blockquote>
<p>段保护是处理器提供的基本保护功能，但是还是不够。当一个程序老老实实地访问只属于它自己的段时，基本的段保护机制是很有效的。一个失控的程序，或者一个恶意的程序，依然可以<strong>通过追踪和修改描述符表来达到它们访问任何内存位置的目的</strong>。</p>
<blockquote>
<p>比如说，如果用户程序知道 GDT 的位置，它可以通过向段寄存器加载操作系统的数据段描述符，或者在 GDT 中增加一个指向操作系统数据区的描述符，来修改只属于操作系统的私有数据。</p>
</blockquote>
<p>其次，32 位处理器是为多任务系统而设计的。多任务系统，对任务之间的隔离和保护，以及任务和操作系统之间的隔离和保护都提出了要求，这可以看做对段保护机制的进一步强化。 同时，在多任务系统中，操作系统居于核心软件的位置，为各个任务服务，负责任务的加载、创建和执行环境的管理，并执行任务之间的调度，对操作系统的保护显得尤为重要。事实上，对于这种要求，基本的段保护机制已经无能为力了。</p>
<p>为何要使用特权级保护？</p>
<ul>
<li>防止恶意代码访问内核。</li>
<li>多任务系统要求对任务和操作系统进行隔离和保护。</li>
</ul>
<h2 id="任务、任务的-LDT-和-TSS"><a href="#任务、任务的-LDT-和-TSS" class="headerlink" title="任务、任务的 LDT 和 TSS"></a>任务、任务的 LDT 和 TSS</h2><h3 id="任务"><a href="#任务" class="headerlink" title="任务"></a>任务</h3><p>程序（Program）是记录在载体上的指令和数据，为了完成某个特定的工作，其正在执行中的一个副本，叫做<code>任务</code>（Task）。这句话的意思是说，如果一个程序有多个副本正在内存中运行，那么它对应着多个任务，每一个副本都是一个任务。在上一章里，用户程序就是任务，而内核程序就是操作系统的缩影。</p>
<p>为了有效地在任务之间实施隔离，处理器建议<strong>每个任务都应当具有自己的描述符表</strong>，称为<code>局部描述符表LDT</code>（Local Descriptor Table），并且把专属于自己的那些段放到 LDT 中。</p>
<p>和 GDT 一样，LDT 也是用来存放描述符的。不同之处在于，<strong>LDT 只属于某个任务</strong>。或者说，每个任务都有自己的 LDT，每个任务私有的段，都应当在 LDT 中进行描述。</p>
<blockquote>
<p>LDT 的第 1 个描述符，也就是 0 号槽位，也是有效的。</p>
</blockquote>
<p><img src="/images/image-20220217115434331.png" alt="image-20220217115434331"></p>
<h3 id="局部描述符表寄存器-LDT"><a href="#局部描述符表寄存器-LDT" class="headerlink" title="局部描述符表寄存器(LDT)"></a>局部描述符表寄存器(LDT)</h3><p>全局描述符表（GDT）是全局性的，为所有任务服务，所以只需要一个全局描述符表（GDT）和一个 GDTR 寄存器就够了。</p>
<p>局部描述符表（LDT）的数量则不止一个，具体有多少，视任务的多少而定。为了追踪和访问这些 LDT，处理器使用了<code>局部描述符表寄存器</code>（LDT Register：LDTR）。</p>
<p>在一个多任务的系统中，会有很多任务在轮流执行，正在执行中的那个任务，称为<code>当前任务</code>（Current Task）。因为 LDTR 寄存器只有一个，所以它只用于指向当前任务的 LDT。每当发生任务切换时，LDTR 的内容被更新，指向新任务的 LDT。</p>
<p><strong>LDTR 的结构和 GDTR 一样</strong>，LDTR 包含了 32 位线性基地址字段和 16 位段界限字段，以指示当前 LDT 的位置和大小。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov cx, 0x005c</span><br><span class="line">mov ds, cx</span><br></pre></td></tr></table></figure>

<p>0x005C 的二进制形式为 0000 0000 0101 1100，这很容易看出 TI 位是 1 ，索引号为11（十进制）。</p>
<p>处理器执行以上指令时，必然会访问当前任务的 LDT（该 LDT 在内存中的位置由 LDTR 指定），从它的 11 号槽位取出描述符，并传送到段寄存器 DS 的描述符高速缓存器中去。</p>
<h3 id="任务状态段-TSS-和TR寄存器"><a href="#任务状态段-TSS-和TR寄存器" class="headerlink" title="任务状态段(TSS)和TR寄存器"></a>任务状态段(TSS)和TR寄存器</h3><p>在一个多任务的环境中，当任务切换发生时，必须保护旧任务的运行状态，或者说是<strong>保护现场</strong>，保护的内容包括通用寄存器、段寄存器、 栈指针寄存器 ESP、指令指针寄存器 EIP、状态寄存器 EFLAGS，等等。 否则的话，等下次该任务又恢复执行时，一切都会变得茫然而毫无头绪。</p>
<p>为了保存任务的状态，并在下次重新执行时恢复它们，每个任务都应当用一个额外的<strong>内存区域</strong>保存相关信息，这叫做<code>任务状态段</code>（Task State Segment：TSS）。处理器固件能够识别 TSS 中的每个元素，并在任务切换的时候读取其中的信息。</p>
<p>任务状态段 TSS 有固定的格式，最小尺寸是 104 字节，图中所标注的偏移量是十进制的 。</p>
<p><img src="/images/image-20220217122115613.png" alt="image-20220217122115613"></p>
<p>处理器用 <code>TR寄存器</code> 来指向当前任务的 TSS，其内容为 TSS 的基地址和界限。TR 寄存器在处理器中也只有一个。</p>
<p>当任务切换发生的时候，TR 寄存器的内容也会跟着指向新任务的 TSS。这个过程是这样的：</p>
<ol>
<li>首先，处理器将当前任务的现场信息保存到由 TR 寄存器指向的 TSS；</li>
<li>然后，再使 TR 寄存器指向新任务的 TSS，并从新任务的 TSS 中恢复现场。</li>
</ol>
<blockquote>
<p>为什么这个寄存器叫 TR，而不是 TSSR。原因很简单，TSS 是一个任务存在的标志，用于区别一个任务和其他任务。所以，这个寄存器叫做<code>任务寄存器</code>（Task Register：TR）。</p>
</blockquote>
<h2 id="全局空间和局部空间"><a href="#全局空间和局部空间" class="headerlink" title="全局空间和局部空间"></a>全局空间和局部空间</h2><p>每个任务实际上包括两个部分：<code>全局部分</code>和<code>私有部分</code>。</p>
<ul>
<li>全局部分是所有任务共有的，含有操作系统的软件和库程序，以及可以调用的系统服务和数据；</li>
<li>私有部分是每个任务各自的数据和代码，与任务所要解决的具体问题有关，彼此并不相同。</li>
</ul>
<p><img src="/images/image-20220217123318708.png" alt="image-20220217123318708"></p>
<p>任务实际上是在内存中运行的，所以所谓的全局部分和私有部分，<strong>其实是地址空间的划分</strong>，即全局地址空间和局部地址空间，简称<code>全局空间</code>和<code>局部空间</code>。</p>
<p>全局地址空间是用全局描述符表（GDT）来指定的，而局部地址空间则是由每个任务私有的局部描述符表（LDT）来定义的。</p>
<p>从程序员的角度来看，任务的全局空间包含了操作系统的段，是由别人编写的，但是他可以调用这些段的代码，或者获取这些段中的数据；任务局部空间的内容是由程序员自己创建的。通常任务会在自己的局部空间运行，当它需要操作系统提供的服务时，转入全局空间执行。</p>
<h2 id="特权级概述"><a href="#特权级概述" class="headerlink" title="特权级概述"></a>特权级概述</h2><h3 id="描述符特权级-DPL"><a href="#描述符特权级-DPL" class="headerlink" title="描述符特权级 DPL"></a>描述符特权级 DPL</h3><p>特权级（Privilege Level），是存在于描述符及其选择子中的一个数值，当这些描述符或者选择子所指向的对象要进行某种操作，或者被别的对象访问时，该数值用于控制它们所能进行的操作， 或者限制它们的可访问性。</p>
<p>这其实对应的就是描述符中的 DPL 字段，可以取值为 00、01、10 和 11，分别对应特权级 0、1、2 和 3。描述符总是指向它所描述的目标对象， 代表着该对象，因此该字段实际上是目标对象的特权级。</p>
<p><img src="/images/image-20220212222908156.png" alt="image-20220212222908156"></p>
<p>对于数据段来说，<strong>DPL 决定了访问它们所应当具备的最低特权级别</strong>。</p>
<blockquote>
<p>如果有一个数据段，其描述符的 DPL 字段为 2，那么，只有特权级为 0、1 和 2 的程序才能访问它。当一个特权级为 3 的程序也试图去读写该段时，将会被处理器阻止，并引发异常中断。</p>
</blockquote>
<p>处理器的 4 级环状保护结构：</p>
<p><img src="/images/image-20220217131816118-5075096.png" alt="image-20220217131816118"></p>
<h3 id="请求特权级-RPL"><a href="#请求特权级-RPL" class="headerlink" title="请求特权级 RPL"></a>请求特权级 RPL</h3><blockquote>
<p>段选择子由三部分组成：</p>
<ul>
<li><code>描述符的索引号</code>：用来在描述符表中选择一个段描述符。</li>
<li><code>TI</code>：描述符表指示器（Table Indicator），TI ＝0 时，表示描述符在 GDT 中；TI＝1 时，描述符在 LDT 中。</li>
<li><code>RPL</code>：请求者的特权级别（Requestor’s Privilege Level），表示给出当前选择子的那个**程序的特权级别(访问者的特权级)**，正是该程序要求访问这个内存段。每个程序都有特权级别。</li>
</ul>
<p><img src="/images/image-20220214143748597.png" alt="image-20220214143748597"></p>
</blockquote>
<p>我们知道：</p>
<ul>
<li>要将控制从一个代码段转移到另一个代码段，通常是使用 jmp 或者 call 指令，并在指令中提供目标代码的段选择子，以及段内偏移量。</li>
<li>为了访问内存中的数据，也必须将段选择子加载到寄存器 DS、ES、FS 或者 GS。</li>
</ul>
<p>不管是实施控制转移，还是访问数据，这都可以看成是一个请求，请求者提供一个段选择子，请求访问指定的段。从这个意义上来讲，<strong>RPL 也就是指请求者的特权级别</strong>。</p>
<h3 id="当前特权级-CPL"><a href="#当前特权级-CPL" class="headerlink" title="当前特权级 CPL"></a>当前特权级 CPL</h3><p>当处理器正在一个代码段中取指令和执行指令时，那个代码段的特权级叫做<code>当前特权级</code>（Current Privilege Level，CPL）。正在执行的这个代码段，其选择子位于段寄存器 CS 中，其最低两位就是当前特权级的数值。</p>
<p>应用程序编写时，不需要考虑 <strong>GDT、LDT、分段、描述符这些东西，它们是在程序加载时，由操作系统负责创建的</strong>，应用程序的编写者只负责具体的功能就可以了。应用程序的加载和开始执行，也是由操作系统所主导的，而操作系统一定会将它放在特权级 3 上。当应用程序开始执行时，当前特权级 CPL 自然就会是 3。</p>
<h3 id="特权指令"><a href="#特权指令" class="headerlink" title="特权指令"></a>特权指令</h3><p>计算机系统的脆弱性在于一条指令就能改变它的整体运行状态，比如停机指令 hlt 和对控制寄存器 CR0 的写操作，像这样的指令只能由最高特权级别的程序来做。</p>
<p>因此，那些只有在当前特权级 CPL 为 0 时 才能执行的指令，称为<code>特权指令</code>（Privileged Instructions）。</p>
<blockquote>
<p>典型的特权指令包括加载全局描述符表的指令 lgdt（它在实模式下也可执行）、加载局部描述符表的指令 lldt、加载任务寄存器的指令 ltr、读写控制寄存器的 mov 指令、停机指令 hlt 等十几条。</p>
</blockquote>
<h3 id="输入-输出特权级"><a href="#输入-输出特权级" class="headerlink" title="输入/输出特权级"></a>输入/输出特权级</h3><p>处理器允许对各个特权级别所能执行的 I/O 操作进行控制。通常这指的是<strong>端口访问的许可权</strong>，因为对设备的访问都是通过端口进行的。</p>
<p>在处理器的标志寄存器 EFLAGS 中，位 13、位 12 是 IOPL 位，也就是输入/输出特权级（I/O Privilege Level），它代表着当前任务的 I/O 特权级别。</p>
<p><img src="/images/image-20220217133125108.png" alt="image-20220217133125108"></p>
<p>任务是由操作系统加载和创建的，与任务相关的信息都在它自己的<strong>任务状态段（TSS）中，其中就包括一个 EFLAGS 寄存器的副本</strong>，用于指示与当前任务相关的机器状态。</p>
<h2 id="特权级检查"><a href="#特权级检查" class="headerlink" title="特权级检查"></a>特权级检查</h2><p>代码段的特权级检查是很严格的。一般来说，控制转移只允许发生在两个<strong>特权级相同</strong>的代码段之间。如果当前特权级为 2，那么，它可以转移到另一个 DPL 为 2 的代码段接着执行，但不允许转移到 DPL 为 0、1 和 3 的代码段执行。</p>
<p>为了让特权级低的应用程序可以调用特权级高的操作系统例程（从低特权级到高特权级的代码段转移），有两种方式：</p>
<ul>
<li>依从代码段：将高特权级的代码段定义为依从的</li>
<li>使用调用门</li>
</ul>
<h3 id="依从代码段"><a href="#依从代码段" class="headerlink" title="依从代码段"></a>依从代码段</h3><p>描述符的 TYPE 字段中的 C 位：</p>
<ul>
<li><p>如果 C＝0，这样的代码段只能供<strong>同特权级</strong>的程序使用；</p>
</li>
<li><p>如果 C＝1，这样的代码段称为<code>依从的代码段</code>，允许从同特权级和低特权级的程序转移到该段执行。也就是说：当前特权级 CPL 必须低于或者和目标代码段描述符的 DPL 相同时，可以从特权级比它低的程序调用并进入。</p>
<p>因为低特权级的数值比较小，在数值上：<code>CPL &gt;= 目标代码段描述符的DPL</code>。</p>
</li>
</ul>
<p><img src="/images/image-20220212231925753.png" alt="image-20220212231925753"></p>
<blockquote>
<p>Eg：如果一个依从的代码段，其描述符的 DPL 为 1，则只有特权级别为 1、2、3 的程序可以调用，而特权级为 0 的程序则不能。<strong>除了从高特权级别的例程（通常是操作系统例程）返回外，在任何时候，都不允许将控制从较高的特权级转移到较低的特权级</strong>。</p>
<p>原因：内核的代码已经很牛逼了，它是不会想要调用你的用户程序的代码的，就是这个道理。也可以解释为：<strong>操作系统不会引用可靠性比自己低的代码</strong>。</p>
</blockquote>
<blockquote>
<p><strong>代码段</strong>不会从高特权级转移到低特权级。但是<strong>数据段</strong>不一样，高特权级的代码可以访问低特权级的数据段。</p>
</blockquote>
<h4 id="为什么叫“依从”"><a href="#为什么叫“依从”" class="headerlink" title="为什么叫“依从”"></a>为什么叫“依从”</h4><p><strong>依从的代码段不是在它的 DPL 特权级上运行，而是在调用程序的特权级上运行</strong>。</p>
<p>就是说，当控制转移到依从的代码段上执行时，不改变当前特权级 CPL，段寄存器 CS 的 CPL 字段不发生变化，被调用过程的特权 级依从于调用者的特权级，这就是为什么它被称为“依从的”代码段。</p>
<blockquote>
<p>简单来说就是：我明明是高特权级别的代码，却可以被低特权级别的代码调用，并且被调用的时候，不使用我的 DPL 作为 CPL，而是使用低特权级别代码的 DPL 作为 CPL。</p>
<p>说文绉绉一点就是：依从代码段转移后的特权级不与自己的特权级（DPL）为主，而是与转移前的低特权级一致，依从转移前的低特权级。</p>
</blockquote>
<p>低特权级的代码段可以在不切换进程特权级的情况下执行高特权级的代码，这看似很不安全，但由于访问权限还受制于 RPL，因此低特权级的程序并不能为所欲为。</p>
<h3 id="门描述符"><a href="#门描述符" class="headerlink" title="门描述符"></a>门描述符</h3><p>门（Gate）是另一种形式的描述符，称为<code>门描述符</code>（Gate Descriptor），简称门。它本身只是一个描述符，可以安装在 GDT 或 LDT 中。</p>
<p>可以对比段描述符，<strong>段描述符用于描述内存段，门描述符用于描述可执行的代码</strong>，比如一段程序、一个过程（例程）或者一个任务。</p>
<p>在保护模式下，中断描述符表（IDT）中的每个表项由 8 个字节组成，其中的每个表项叫做一个门描述符。 “门” 的含义是指当中断发生时必须先访问这些 “门”，能够 “开门”（即：将要进行的处理需通过特权检查，符合设定的权限等约束）后，才能进入相应的处理程序。而门描述符则描述了 “门” 的属性（如特权级、段内偏移量等）。</p>
<p>门的类型：</p>
<ul>
<li>调用门：用于不同特权级之间的过程调用；</li>
<li>中断门/陷阱门：作为中断处理过程使用的；</li>
<li> 任务门：对应着单个的任务，用来执行任务切换。</li>
</ul>
<p>调用门描述符格式：</p>
<p>门描述符中定义了例程所在代码段的选择子，以及段内偏移等信息。</p>
<p><img src="/images/f55a1c902a8cd3c6c362a8f0c07a21e2.jpg" alt="img"></p>
<h3 id="RPL、CPL-和-DPL"><a href="#RPL、CPL-和-DPL" class="headerlink" title="RPL、CPL 和 DPL"></a>RPL、CPL 和 DPL</h3><ul>
<li>RPL：访问者的特权级</li>
<li>CPL：处理器的当前特权级</li>
<li>DPL：描述符的特权级</li>
</ul>
<p><strong>在 CPU 中运行的是指令，指令总会属于某个代码段，该代码段的特权级，也就是代码段描述符中的 DPL，便是当前 CPU 所处的特权级，它表示处理器正在执行的代码的特权级</strong>。</p>
<p>除依从代码外，转移后的目标代码段的 DPL 是将来处理器的当前特权级 CPL。当前正在执行的代码所在的代码段的 DPL 就是处理器的当前特权级 CPL，当处理器从一个代码段跳到另一个代码段时就有可能发生特权级改变，CPL 也要随之改变。</p>
<p>要判断请求者是谁，最简单的方法是看谁提供的选择子，谁就是请求者。</p>
<ul>
<li><p>在绝大多数情况下，请求者都是当前程序自己，因此 CPL=RPL。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov eax, 0x0008  ; 加载数据段(0-4G)选择子</span><br><span class="line">mov ds, eax</span><br></pre></td></tr></table></figure>

<p>当前程序自己拿着段选择子 0x0008 来“请求”代入段寄存器 DS，以便在随后的指令中访问该段中的数据。</p>
</li>
<li><p>应用程序通过调用门调用内核例程，请求者是用户程序，即 RPL=3。但是真正读硬盘的是内核例程，通过调用门会改变当前特权级，进入内核示例后，CPL=0。 此时 RPL 与 CPL 就不相同。</p>
<p><img src="/images/image-20220217174957341.png" alt="image-20220217174957341"></p>
</li>
</ul>
<h3 id="为什么要引入-RPL"><a href="#为什么要引入-RPL" class="headerlink" title="为什么要引入 RPL"></a>为什么要引入 RPL</h3><p>想象一下，应用程序的编写者通过钻研，得知了操作系统内核的数据段的选择子，而且希望用这个选择子访问操作系统的数据段。当然，他不可能在应用程序里访问操作系统数据段，因为那个数据段的 DPL 为 0，而应用程序工作时的当前特权级为 3，处理器会很机警地把来访者拒之门外。</p>
<p><img src="/images/image-20220217233457947.png" alt="image-20220217233457947"></p>
<p>但是，他可以借助于调用门。调用门工作在目标代码段的特权级上，一旦处理器的执行流离开应用程序，通过调用门进入操作系统例程时，当前特权级从 3 变为 0。当那个不怀好意的程序将一个指向操作系统数据段的选择子，通过 CX 寄存器作为参数传入调用门时，因为当前特权级已经从 3 变为 0，可以从硬盘读出数据，并且允许向操作系统数据段写入扇区数据，他得逞了！</p>
<p><strong>处理器的智商很低，它不可能知道谁是真正的请求者</strong>。</p>
<blockquote>
<p>也就是说，对于 <code>mov ds, ax</code> 这条指令来说，AX 寄存器中的选择子可能是操作系统自己提供的，也可能来自于恶意的用户程序，处理器是无法区分出来的。</p>
</blockquote>
<p>引入请求特权级（RPL）的原因是处理器在遇到一条将选择子传送到段寄存器的指令时，无法区分真正的请求者是谁。</p>
<p>但是，引入RPL 本身并不能完全解决这个问题，这只是处理器和操作系统之间的一种协议，处理器负责检查请求特权级 RPL，判断它是否有权访问，但前提是提供了正确的 RPL；内核或者操作系统负责鉴别请求者的身份，并有义务保证 RPL 的值和它的请求者身份相符，因为这是处理器无能为力的。</p>
<blockquote>
<p>简单来说：在引入 RPL 这件事上，处理器的潜台词是，仅依靠现有的 CPL 和 DPL，无法解决由请求者不同而带来的安全隐患。那么，再增加一道门卫，但前提是操作系统只将通行证发放给正确的人。</p>
</blockquote>
<p>操作系统的编写者很清楚段选择子的来源，即，真正的请求者是谁。</p>
<ul>
<li>当它自己读写一个段时，这没有什么好说的；</li>
<li>当它提供一个服务例程时，3 特权级别的用户程序给出的选择子在哪里，也是由它定的，它也知道。在这种情况下，它所要做的，就是将该选择子的 RPL 字段设置为请求者的特权级。</li>
</ul>
<p>剩下的工作就看处理器了。每当处理器执行一个将段选择子传送到段寄存器 （DS、ES、FS、GS）的指令时，会检查以下两个条件是否都能满足：</p>
<ul>
<li>当前特权级 CPL 高于或者和数据段描述符的 DPL 相同。即，在数值上，CPL ≤ 数据段描述符的 DPL；</li>
<li>请求特权级 RPL 高于或者和数据段描述符的 DPL 相同。即，在数值上，RPL ≤ 数据段描述符的 DPL。</li>
</ul>
<p>如果以上两个条件不能同时成立，处理器就会阻止这种操作，并引发异常中断。</p>
<blockquote>
<p>所以在上面的例子中，当用户程序想要写内核的数据段，通过调用门调用内核例程后，当前特权级 CPL 与数据段描述符的 DPL 都是 0，满足第一个条件。但是 RPL=3，数据段的 DPL=0，不满足第二个条件，所以处理器引发异常中断。</p>
</blockquote>
<blockquote>
<p>按照 Intel 公司的说法，引入 RPL 的意图是“<strong>确保特权代码不会代替应用程序访问一个段，除非应用程序自己拥有访问那个段的权限</strong>”。</p>
</blockquote>
<h3 id="基本的特权级检查规则"><a href="#基本的特权级检查规则" class="headerlink" title="基本的特权级检查规则"></a>基本的特权级检查规则</h3><ul>
<li><p>将控制直接转移到非依从的代码段，要求当前特权级 CPL 和请求特权级 RPL 都等于目标代码段描述符的 DPL。</p>
<p>即，在数值上：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CPL = 目标代码段描述符的DPL</span><br><span class="line">RPL = 目标代码段描述符的DPL</span><br></pre></td></tr></table></figure>

<p>一个典型的例子就是使用 jmp 指令进行控制转移：<code>jmp 0x0012:0x000020000</code>，因为两个代码段的特权级相同，故转移后当前特权级不变。</p>
</li>
<li><p>将控制直接转移到依从的代码段，要求当前特权级 CPL 和请求特权级 RPL 都低于或等于目标代码段描述符的 DPL。</p>
<p>即，在数值上：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CPL &gt;= 目标代码段描述符的DPL</span><br><span class="line">RPL &gt;= 目标代码段描述符的DPL</span><br></pre></td></tr></table></figure>

<p>控制转移后，当前特权级保持不变。</p>
</li>
<li><p>高特权级别的程序可以访问低特权级别的<strong>数据段</strong>，但低特权级别的程序不能访问高特权级别的数据段。</p>
<p>访问数据段之前，肯定要对段寄存器 DS、ES、FS 和 GS 进行修改，比如 <code>mov fs, ax</code>，在这个时候，要求当前特权级 CPL 和请求特权级 RPL 都必须高于或等于目标数据段描述符的 DPL。</p>
<p>即，在数值上：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CPL &lt;= 目标代码段描述符的DPL</span><br><span class="line">RPL &lt;= 目标代码段描述符的DPL</span><br></pre></td></tr></table></figure></li>
<li><p>最后，处理器要求，在任何时候，栈段的特权级别必须和当前特权级 CPL 相同。因此随着程序的执行，要对段寄存器 SS 的内容进行修改时：<code>mov ss, ax</code>，必须进行特权级检查，要求当前特权级 CPL 和请求特权级 RPL 必须等于目标栈段描述符的 DPL。</p>
<p>即，在数值上：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CPL = 目标代码段描述符的DPL</span><br><span class="line">RPL = 目标代码段描述符的DPL</span><br></pre></td></tr></table></figure>

<blockquote>
<p>要求栈段的特权级别必须和当前特权级 CPL 相同，主要是为了防止因栈空间不足而产生不可预料的问题， 同时也是为了防止栈数据的交叉引用。</p>
</blockquote>
</li>
</ul>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><ol>
<li>程序员在写程序时，不需要指定特权级别。当程序运行时，操作系统将程序创建为任务局部空间的内容，并赋予较低特权级别，比如 3， 操作系统对应着任务全局空间的内容。如果有多个任务，则操作系统属于所有任务的公共部分。</li>
<li> 当任务运行在局部空间时，可以在各个段之间转移控制，并访问私有数据，因为它们具有相同的特权级别，但不允许直接将控制转移到高特权级别的全局空间的段，除非通过调用门，或者目标段是依从的代码段。</li>
<li>当通过调用门进入全局空间执行时，操作系统可以在全局空间内的各个段之间转移控制并访问数据，因为它们也具有相同的特权级别。 同时，操作系统还可以访问任务局部空间的数据，即低特权级别的<strong>数据段</strong>。但除了调用门返回外，不允许将控制转移到低特权级别的局部空间内的<strong>代码段</strong>。</li>
<li>任何时候，当前栈的特权级别必须和 CPL 是一样的。进入不同特权级别的段执行时，要切换栈。</li>
</ol>
<h2 id="内核程序的初始化"><a href="#内核程序的初始化" class="headerlink" title="内核程序的初始化"></a>内核程序的初始化</h2><h3 id="保护模式微型核心程序"><a href="#保护模式微型核心程序" class="headerlink" title="保护模式微型核心程序"></a>保护模式微型核心程序</h3><p>这是前一章内核程序的修改版本，使用了任务、LDT、TSS 和特权级等最新的处理器特性和工作机制。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br></pre></td><td class="code"><pre><span class="line">         ;代码清单14-1</span><br><span class="line">         ;文件名：c14_core.asm</span><br><span class="line">         ;文件说明：保护模式微型核心程序 </span><br><span class="line">         ;创建日期：2011-11-6 18:37</span><br><span class="line"></span><br><span class="line">         ;以下常量定义部分。内核的大部分内容都应当固定 </span><br><span class="line">         core_code_seg_sel     equ  0x38    ;内核代码段选择子</span><br><span class="line">         core_data_seg_sel     equ  0x30    ;内核数据段选择子 </span><br><span class="line">         sys_routine_seg_sel   equ  0x28    ;系统公共例程代码段的选择子 </span><br><span class="line">         video_ram_seg_sel     equ  0x20    ;视频显示缓冲区的段选择子</span><br><span class="line">         core_stack_seg_sel    equ  0x18    ;内核堆栈段选择子</span><br><span class="line">         mem_0_4_gb_seg_sel    equ  0x08    ;整个0-4GB内存的段的选择子</span><br><span class="line"></span><br><span class="line">;-------------------------------------------------------------------------------</span><br><span class="line">         ;以下是系统核心的头部，用于加载核心程序 </span><br><span class="line">         core_length      dd core_end       ;核心程序总长度#00</span><br><span class="line"></span><br><span class="line">         sys_routine_seg  dd section.sys_routine.start</span><br><span class="line">                                            ;系统公用例程段位置#04</span><br><span class="line"></span><br><span class="line">         core_data_seg    dd section.core_data.start</span><br><span class="line">                                            ;核心数据段位置#08</span><br><span class="line"></span><br><span class="line">         core_code_seg    dd section.core_code.start</span><br><span class="line">                                            ;核心代码段位置#0c</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">         core_entry       dd start          ;核心代码段入口点#10</span><br><span class="line">                          dw core_code_seg_sel</span><br><span class="line"></span><br><span class="line">;===============================================================================</span><br><span class="line">         [bits 32]</span><br><span class="line">;===============================================================================</span><br><span class="line">SECTION sys_routine vstart=0                ;系统公共例程代码段 </span><br><span class="line">;-------------------------------------------------------------------------------</span><br><span class="line">         ;字符串显示例程</span><br><span class="line">put_string:                                 ;显示0终止的字符串并移动光标 </span><br><span class="line">                                            ;输入：DS:EBX=串地址</span><br><span class="line">         push ecx</span><br><span class="line">  .getc:</span><br><span class="line">         mov cl,[ebx]</span><br><span class="line">         or cl,cl</span><br><span class="line">         jz .exit</span><br><span class="line">         call put_char</span><br><span class="line">         inc ebx</span><br><span class="line">         jmp .getc</span><br><span class="line"></span><br><span class="line">  .exit:</span><br><span class="line">         pop ecx</span><br><span class="line">         retf                               ;段间返回</span><br><span class="line"></span><br><span class="line">;-------------------------------------------------------------------------------</span><br><span class="line">put_char:                                   ;在当前光标处显示一个字符,并推进</span><br><span class="line">                                            ;光标。仅用于段内调用 </span><br><span class="line">                                            ;输入：CL=字符ASCII码 </span><br><span class="line">         pushad</span><br><span class="line"></span><br><span class="line">         ;以下取当前光标位置</span><br><span class="line">         mov dx,0x3d4</span><br><span class="line">         mov al,0x0e</span><br><span class="line">         out dx,al</span><br><span class="line">         inc dx                             ;0x3d5</span><br><span class="line">         in al,dx                           ;高字</span><br><span class="line">         mov ah,al</span><br><span class="line"></span><br><span class="line">         dec dx                             ;0x3d4</span><br><span class="line">         mov al,0x0f</span><br><span class="line">         out dx,al</span><br><span class="line">         inc dx                             ;0x3d5</span><br><span class="line">         in al,dx                           ;低字</span><br><span class="line">         mov bx,ax                          ;BX=代表光标位置的16位数</span><br><span class="line"></span><br><span class="line">         cmp cl,0x0d                        ;回车符？</span><br><span class="line">         jnz .put_0a</span><br><span class="line">         mov ax,bx</span><br><span class="line">         mov bl,80</span><br><span class="line">         div bl</span><br><span class="line">         mul bl</span><br><span class="line">         mov bx,ax</span><br><span class="line">         jmp .set_cursor</span><br><span class="line"></span><br><span class="line">  .put_0a:</span><br><span class="line">         cmp cl,0x0a                        ;换行符？</span><br><span class="line">         jnz .put_other</span><br><span class="line">         add bx,80</span><br><span class="line">         jmp .roll_screen</span><br><span class="line"></span><br><span class="line">  .put_other:                               ;正常显示字符</span><br><span class="line">         push es</span><br><span class="line">         mov eax,video_ram_seg_sel          ;0xb8000段的选择子</span><br><span class="line">         mov es,eax</span><br><span class="line">         shl bx,1</span><br><span class="line">         mov [es:bx],cl</span><br><span class="line">         pop es</span><br><span class="line"></span><br><span class="line">         ;以下将光标位置推进一个字符</span><br><span class="line">         shr bx,1</span><br><span class="line">         inc bx</span><br><span class="line"></span><br><span class="line">  .roll_screen:</span><br><span class="line">         cmp bx,2000                        ;光标超出屏幕？滚屏</span><br><span class="line">         jl .set_cursor</span><br><span class="line"></span><br><span class="line">         push ds</span><br><span class="line">         push es</span><br><span class="line">         mov eax,video_ram_seg_sel</span><br><span class="line">         mov ds,eax</span><br><span class="line">         mov es,eax</span><br><span class="line">         cld</span><br><span class="line">         mov esi,0xa0                       ;小心！32位模式下movsb/w/d </span><br><span class="line">         mov edi,0x00                       ;使用的是esi/edi/ecx </span><br><span class="line">         mov ecx,1920</span><br><span class="line">         rep movsd</span><br><span class="line">         mov bx,3840                        ;清除屏幕最底一行</span><br><span class="line">         mov ecx,80                         ;32位程序应该使用ECX</span><br><span class="line">  .cls:</span><br><span class="line">         mov word[es:bx],0x0720</span><br><span class="line">         add bx,2</span><br><span class="line">         loop .cls</span><br><span class="line"></span><br><span class="line">         pop es</span><br><span class="line">         pop ds</span><br><span class="line"></span><br><span class="line">         mov bx,1920</span><br><span class="line"></span><br><span class="line">  .set_cursor:</span><br><span class="line">         mov dx,0x3d4</span><br><span class="line">         mov al,0x0e</span><br><span class="line">         out dx,al</span><br><span class="line">         inc dx                             ;0x3d5</span><br><span class="line">         mov al,bh</span><br><span class="line">         out dx,al</span><br><span class="line">         dec dx                             ;0x3d4</span><br><span class="line">         mov al,0x0f</span><br><span class="line">         out dx,al</span><br><span class="line">         inc dx                             ;0x3d5</span><br><span class="line">         mov al,bl</span><br><span class="line">         out dx,al</span><br><span class="line"></span><br><span class="line">         popad</span><br><span class="line">         </span><br><span class="line">         ret                                </span><br><span class="line"></span><br><span class="line">;-------------------------------------------------------------------------------</span><br><span class="line">read_hard_disk_0:                           ;从硬盘读取一个逻辑扇区</span><br><span class="line">                                            ;EAX=逻辑扇区号</span><br><span class="line">                                            ;DS:EBX=目标缓冲区地址</span><br><span class="line">                                            ;返回：EBX=EBX+512</span><br><span class="line">         push eax </span><br><span class="line">         push ecx</span><br><span class="line">         push edx</span><br><span class="line">      </span><br><span class="line">         push eax</span><br><span class="line">         </span><br><span class="line">         mov dx,0x1f2</span><br><span class="line">         mov al,1</span><br><span class="line">         out dx,al                          ;读取的扇区数</span><br><span class="line"></span><br><span class="line">         inc dx                             ;0x1f3</span><br><span class="line">         pop eax</span><br><span class="line">         out dx,al                          ;LBA地址7~0</span><br><span class="line"></span><br><span class="line">         inc dx                             ;0x1f4</span><br><span class="line">         mov cl,8</span><br><span class="line">         shr eax,cl</span><br><span class="line">         out dx,al                          ;LBA地址15~8</span><br><span class="line"></span><br><span class="line">         inc dx                             ;0x1f5</span><br><span class="line">         shr eax,cl</span><br><span class="line">         out dx,al                          ;LBA地址23~16</span><br><span class="line"></span><br><span class="line">         inc dx                             ;0x1f6</span><br><span class="line">         shr eax,cl</span><br><span class="line">         or al,0xe0                         ;第一硬盘  LBA地址27~24</span><br><span class="line">         out dx,al</span><br><span class="line"></span><br><span class="line">         inc dx                             ;0x1f7</span><br><span class="line">         mov al,0x20                        ;读命令</span><br><span class="line">         out dx,al</span><br><span class="line"></span><br><span class="line">  .waits:</span><br><span class="line">         in al,dx</span><br><span class="line">         and al,0x88</span><br><span class="line">         cmp al,0x08</span><br><span class="line">         jnz .waits                         ;不忙，且硬盘已准备好数据传输 </span><br><span class="line"></span><br><span class="line">         mov ecx,256                        ;总共要读取的字数</span><br><span class="line">         mov dx,0x1f0</span><br><span class="line">  .readw:</span><br><span class="line">         in ax,dx</span><br><span class="line">         mov [ebx],ax</span><br><span class="line">         add ebx,2</span><br><span class="line">         loop .readw</span><br><span class="line"></span><br><span class="line">         pop edx</span><br><span class="line">         pop ecx</span><br><span class="line">         pop eax</span><br><span class="line">      </span><br><span class="line">         retf                               ;段间返回 </span><br><span class="line"></span><br><span class="line">;-------------------------------------------------------------------------------</span><br><span class="line">;汇编语言程序是极难一次成功，而且调试非常困难。这个例程可以提供帮助 </span><br><span class="line">put_hex_dword:                              ;在当前光标处以十六进制形式显示</span><br><span class="line">                                            ;一个双字并推进光标 </span><br><span class="line">                                            ;输入：EDX=要转换并显示的数字</span><br><span class="line">                                            ;输出：无</span><br><span class="line">         pushad</span><br><span class="line">         push ds</span><br><span class="line">      </span><br><span class="line">         mov ax,core_data_seg_sel           ;切换到核心数据段 </span><br><span class="line">         mov ds,ax</span><br><span class="line">      </span><br><span class="line">         mov ebx,bin_hex                    ;指向核心数据段内的转换表</span><br><span class="line">         mov ecx,8</span><br><span class="line">  .xlt:    </span><br><span class="line">         rol edx,4</span><br><span class="line">         mov eax,edx</span><br><span class="line">         and eax,0x0000000f</span><br><span class="line">         xlat</span><br><span class="line">      </span><br><span class="line">         push ecx</span><br><span class="line">         mov cl,al                           </span><br><span class="line">         call put_char</span><br><span class="line">         pop ecx</span><br><span class="line">       </span><br><span class="line">         loop .xlt</span><br><span class="line">      </span><br><span class="line">         pop ds</span><br><span class="line">         popad</span><br><span class="line">         retf</span><br><span class="line">      </span><br><span class="line">;-------------------------------------------------------------------------------</span><br><span class="line">allocate_memory:                            ;分配内存</span><br><span class="line">                                            ;输入：ECX=希望分配的字节数</span><br><span class="line">                                            ;输出：ECX=起始线性地址 </span><br><span class="line">         push ds</span><br><span class="line">         push eax</span><br><span class="line">         push ebx</span><br><span class="line">      </span><br><span class="line">         mov eax,core_data_seg_sel</span><br><span class="line">         mov ds,eax</span><br><span class="line">      </span><br><span class="line">         mov eax,[ram_alloc]</span><br><span class="line">         add eax,ecx                        ;下一次分配时的起始地址</span><br><span class="line">      </span><br><span class="line">         ;这里应当有检测可用内存数量的指令</span><br><span class="line">          </span><br><span class="line">         mov ecx,[ram_alloc]                ;返回分配的起始地址</span><br><span class="line"></span><br><span class="line">         mov ebx,eax</span><br><span class="line">         and ebx,0xfffffffc</span><br><span class="line">         add ebx,4                          ;强制对齐 </span><br><span class="line">         test eax,0x00000003                ;下次分配的起始地址最好是4字节对齐</span><br><span class="line">         cmovnz eax,ebx                     ;如果没有对齐，则强制对齐 </span><br><span class="line">         mov [ram_alloc],eax                ;下次从该地址分配内存</span><br><span class="line">                                            ;cmovcc指令可以避免控制转移 </span><br><span class="line">         pop ebx</span><br><span class="line">         pop eax</span><br><span class="line">         pop ds</span><br><span class="line"></span><br><span class="line">         retf</span><br><span class="line"></span><br><span class="line">;-------------------------------------------------------------------------------</span><br><span class="line">set_up_gdt_descriptor:                      ;在GDT内安装一个新的描述符</span><br><span class="line">                                            ;输入：EDX:EAX=描述符 </span><br><span class="line">                                            ;输出：CX=描述符的选择子</span><br><span class="line">         push eax</span><br><span class="line">         push ebx</span><br><span class="line">         push edx</span><br><span class="line"></span><br><span class="line">         push ds</span><br><span class="line">         push es</span><br><span class="line"></span><br><span class="line">         mov ebx,core_data_seg_sel          ;切换到核心数据段</span><br><span class="line">         mov ds,ebx</span><br><span class="line"></span><br><span class="line">         sgdt [pgdt]                        ;以便开始处理GDT</span><br><span class="line"></span><br><span class="line">         mov ebx,mem_0_4_gb_seg_sel</span><br><span class="line">         mov es,ebx</span><br><span class="line"></span><br><span class="line">         movzx ebx,word [pgdt]              ;GDT界限</span><br><span class="line">         inc bx                             ;GDT总字节数，也是下一个描述符偏移</span><br><span class="line">         add ebx,[pgdt+2]                   ;下一个描述符的线性地址</span><br><span class="line"></span><br><span class="line">         mov [es:ebx],eax</span><br><span class="line">         mov [es:ebx+4],edx</span><br><span class="line"></span><br><span class="line">         add word [pgdt],8                  ;增加一个描述符的大小</span><br><span class="line"></span><br><span class="line">         lgdt [pgdt]                        ;对GDT的更改生效</span><br><span class="line"></span><br><span class="line">         mov ax,[pgdt]                      ;得到GDT界限值</span><br><span class="line">         xor dx,dx</span><br><span class="line">         mov bx,8</span><br><span class="line">         div bx                             ;除以8，去掉余数</span><br><span class="line">         mov cx,ax</span><br><span class="line">         shl cx,3                           ;将索引号移到正确位置</span><br><span class="line"></span><br><span class="line">         pop es</span><br><span class="line">         pop ds</span><br><span class="line"></span><br><span class="line">         pop edx</span><br><span class="line">         pop ebx</span><br><span class="line">         pop eax</span><br><span class="line"></span><br><span class="line">         retf</span><br><span class="line">;-------------------------------------------------------------------------------</span><br><span class="line">make_seg_descriptor:                        ;构造存储器和系统的段描述符</span><br><span class="line">                                            ;输入：EAX=线性基地址</span><br><span class="line">                                            ;      EBX=段界限</span><br><span class="line">                                            ;      ECX=属性。各属性位都在原始</span><br><span class="line">                                            ;          位置，无关的位清零 </span><br><span class="line">                                            ;返回：EDX:EAX=描述符</span><br><span class="line">         mov edx,eax</span><br><span class="line">         shl eax,16</span><br><span class="line">         or ax,bx                           ;描述符前32位(EAX)构造完毕</span><br><span class="line"></span><br><span class="line">         and edx,0xffff0000                 ;清除基地址中无关的位</span><br><span class="line">         rol edx,8</span><br><span class="line">         bswap edx                          ;装配基址的31~24和23~16  (80486+)</span><br><span class="line"></span><br><span class="line">         xor bx,bx</span><br><span class="line">         or edx,ebx                         ;装配段界限的高4位</span><br><span class="line"></span><br><span class="line">         or edx,ecx                         ;装配属性</span><br><span class="line"></span><br><span class="line">         retf</span><br><span class="line"></span><br><span class="line">;-------------------------------------------------------------------------------</span><br><span class="line">make_gate_descriptor:                       ;构造门的描述符（调用门等）</span><br><span class="line">                                            ;输入：EAX=门代码在段内偏移地址</span><br><span class="line">                                            ;       BX=门代码所在段的选择子 </span><br><span class="line">                                            ;       CX=段类型及属性等（各属</span><br><span class="line">                                            ;          性位都在原始位置）</span><br><span class="line">                                            ;返回：EDX:EAX=完整的描述符</span><br><span class="line">         push ebx</span><br><span class="line">         push ecx</span><br><span class="line">      </span><br><span class="line">         mov edx,eax</span><br><span class="line">         and edx,0xffff0000                 ;得到偏移地址高16位 </span><br><span class="line">         or dx,cx                           ;组装属性部分到EDX</span><br><span class="line">       </span><br><span class="line">         and eax,0x0000ffff                 ;得到偏移地址低16位 </span><br><span class="line">         shl ebx,16                          </span><br><span class="line">         or eax,ebx                         ;组装段选择子部分</span><br><span class="line">      </span><br><span class="line">         pop ecx</span><br><span class="line">         pop ebx</span><br><span class="line">      </span><br><span class="line">         retf                                   </span><br><span class="line">                             </span><br><span class="line">sys_routine_end:</span><br><span class="line"></span><br><span class="line">;===============================================================================</span><br><span class="line">SECTION core_data vstart=0                  ;系统核心的数据段 </span><br><span class="line">;------------------------------------------------------------------------------- </span><br><span class="line">         pgdt             dw  0             ;用于设置和修改GDT </span><br><span class="line">                          dd  0</span><br><span class="line"></span><br><span class="line">         ram_alloc        dd  0x00100000    ;下次分配内存时的起始地址</span><br><span class="line"></span><br><span class="line">         ;符号地址检索表</span><br><span class="line">         salt:</span><br><span class="line">         salt_1           db  &#x27;@PrintString&#x27;</span><br><span class="line">                     times 256-($-salt_1) db 0</span><br><span class="line">                          dd  put_string</span><br><span class="line">                          dw  sys_routine_seg_sel</span><br><span class="line"></span><br><span class="line">         salt_2           db  &#x27;@ReadDiskData&#x27;</span><br><span class="line">                     times 256-($-salt_2) db 0</span><br><span class="line">                          dd  read_hard_disk_0</span><br><span class="line">                          dw  sys_routine_seg_sel</span><br><span class="line"></span><br><span class="line">         salt_3           db  &#x27;@PrintDwordAsHexString&#x27;</span><br><span class="line">                     times 256-($-salt_3) db 0</span><br><span class="line">                          dd  put_hex_dword</span><br><span class="line">                          dw  sys_routine_seg_sel</span><br><span class="line"></span><br><span class="line">         salt_4           db  &#x27;@TerminateProgram&#x27;</span><br><span class="line">                     times 256-($-salt_4) db 0</span><br><span class="line">                          dd  return_point</span><br><span class="line">                          dw  core_code_seg_sel</span><br><span class="line"></span><br><span class="line">         salt_item_len   equ $-salt_4</span><br><span class="line">         salt_items      equ ($-salt)/salt_item_len</span><br><span class="line"></span><br><span class="line">         message_1        db  &#x27;  If you seen this message,that means we &#x27;</span><br><span class="line">                          db  &#x27;are now in protect mode,and the system &#x27;</span><br><span class="line">                          db  &#x27;core is loaded,and the video display &#x27;</span><br><span class="line">                          db  &#x27;routine works perfectly.&#x27;,0x0d,0x0a,0</span><br><span class="line"></span><br><span class="line">         message_2        db  &#x27;  System wide CALL-GATE mounted.&#x27;,0x0d,0x0a,0</span><br><span class="line">         </span><br><span class="line">         message_3        db  0x0d,0x0a,&#x27;  Loading user program...&#x27;,0</span><br><span class="line">         </span><br><span class="line">         do_status        db  &#x27;Done.&#x27;,0x0d,0x0a,0</span><br><span class="line">         </span><br><span class="line">         message_6        db  0x0d,0x0a,0x0d,0x0a,0x0d,0x0a</span><br><span class="line">                          db  &#x27;  User program terminated,control returned.&#x27;,0</span><br><span class="line"></span><br><span class="line">         bin_hex          db &#x27;0123456789ABCDEF&#x27;</span><br><span class="line">                                            ;put_hex_dword子过程用的查找表 </span><br><span class="line"></span><br><span class="line">         core_buf   times 2048 db 0         ;内核用的缓冲区</span><br><span class="line"></span><br><span class="line">         esp_pointer      dd 0              ;内核用来临时保存自己的栈指针     </span><br><span class="line"></span><br><span class="line">         cpu_brnd0        db 0x0d,0x0a,&#x27;  &#x27;,0</span><br><span class="line">         cpu_brand  times 52 db 0</span><br><span class="line">         cpu_brnd1        db 0x0d,0x0a,0x0d,0x0a,0</span><br><span class="line"></span><br><span class="line">         ;任务控制块链</span><br><span class="line">         tcb_chain        dd  0</span><br><span class="line"></span><br><span class="line">core_data_end:</span><br><span class="line">               </span><br><span class="line">;===============================================================================</span><br><span class="line">SECTION core_code vstart=0</span><br><span class="line">;-------------------------------------------------------------------------------</span><br><span class="line">fill_descriptor_in_ldt:                     ;在LDT内安装一个新的描述符</span><br><span class="line">                                            ;输入：EDX:EAX=描述符</span><br><span class="line">                                            ;          EBX=TCB基地址</span><br><span class="line">                                            ;输出：CX=描述符的选择子</span><br><span class="line">         push eax</span><br><span class="line">         push edx</span><br><span class="line">         push edi</span><br><span class="line">         push ds</span><br><span class="line"></span><br><span class="line">         mov ecx,mem_0_4_gb_seg_sel</span><br><span class="line">         mov ds,ecx</span><br><span class="line"></span><br><span class="line">         mov edi,[ebx+0x0c]                 ;获得LDT基地址</span><br><span class="line">         </span><br><span class="line">         xor ecx,ecx</span><br><span class="line">         mov cx,[ebx+0x0a]                  ;获得LDT界限</span><br><span class="line">         inc cx                             ;LDT的总字节数，即新描述符偏移地址</span><br><span class="line">         </span><br><span class="line">         mov [edi+ecx+0x00],eax</span><br><span class="line">         mov [edi+ecx+0x04],edx             ;安装描述符</span><br><span class="line"></span><br><span class="line">         add cx,8                           </span><br><span class="line">         dec cx                             ;得到新的LDT界限值 </span><br><span class="line"></span><br><span class="line">         mov [ebx+0x0a],cx                  ;更新LDT界限值到TCB</span><br><span class="line"></span><br><span class="line">         mov ax,cx</span><br><span class="line">         xor dx,dx</span><br><span class="line">         mov cx,8</span><br><span class="line">         div cx</span><br><span class="line">         </span><br><span class="line">         mov cx,ax</span><br><span class="line">         shl cx,3                           ;左移3位，并且</span><br><span class="line">         or cx,0000_0000_0000_0100B         ;使TI位=1，指向LDT，最后使RPL=00 </span><br><span class="line"></span><br><span class="line">         pop ds</span><br><span class="line">         pop edi</span><br><span class="line">         pop edx</span><br><span class="line">         pop eax</span><br><span class="line">     </span><br><span class="line">         ret</span><br><span class="line">      </span><br><span class="line">;------------------------------------------------------------------------------- </span><br><span class="line">load_relocate_program:                      ;加载并重定位用户程序</span><br><span class="line">                                            ;输入: PUSH 逻辑扇区号</span><br><span class="line">                                            ;      PUSH 任务控制块基地址</span><br><span class="line">                                            ;输出：无 </span><br><span class="line">         pushad</span><br><span class="line">      </span><br><span class="line">         push ds</span><br><span class="line">         push es</span><br><span class="line">      </span><br><span class="line">         mov ebp,esp                        ;为访问通过堆栈传递的参数做准备</span><br><span class="line">      </span><br><span class="line">         mov ecx,mem_0_4_gb_seg_sel</span><br><span class="line">         mov es,ecx</span><br><span class="line">      </span><br><span class="line">         mov esi,[ebp+11*4]                 ;从堆栈中取得TCB的基地址</span><br><span class="line"></span><br><span class="line">         ;以下申请创建LDT所需要的内存</span><br><span class="line">         mov ecx,160                        ;允许安装20个LDT描述符</span><br><span class="line">         call sys_routine_seg_sel:allocate_memory</span><br><span class="line">         mov [es:esi+0x0c],ecx              ;登记LDT基地址到TCB中</span><br><span class="line">         mov word [es:esi+0x0a],0xffff      ;登记LDT初始的界限到TCB中 </span><br><span class="line"></span><br><span class="line">         ;以下开始加载用户程序 </span><br><span class="line">         mov eax,core_data_seg_sel</span><br><span class="line">         mov ds,eax                         ;切换DS到内核数据段</span><br><span class="line">       </span><br><span class="line">         mov eax,[ebp+12*4]                 ;从堆栈中取出用户程序起始扇区号 </span><br><span class="line">         mov ebx,core_buf                   ;读取程序头部数据     </span><br><span class="line">         call sys_routine_seg_sel:read_hard_disk_0</span><br><span class="line"></span><br><span class="line">         ;以下判断整个程序有多大</span><br><span class="line">         mov eax,[core_buf]                 ;程序尺寸</span><br><span class="line">         mov ebx,eax</span><br><span class="line">         and ebx,0xfffffe00                 ;使之512字节对齐（能被512整除的数低 </span><br><span class="line">         add ebx,512                        ;9位都为0 </span><br><span class="line">         test eax,0x000001ff                ;程序的大小正好是512的倍数吗? </span><br><span class="line">         cmovnz eax,ebx                     ;不是。使用凑整的结果</span><br><span class="line">      </span><br><span class="line">         mov ecx,eax                        ;实际需要申请的内存数量</span><br><span class="line">         call sys_routine_seg_sel:allocate_memory</span><br><span class="line">         mov [es:esi+0x06],ecx              ;登记程序加载基地址到TCB中</span><br><span class="line">      </span><br><span class="line">         mov ebx,ecx                        ;ebx -&gt; 申请到的内存首地址</span><br><span class="line">         xor edx,edx</span><br><span class="line">         mov ecx,512</span><br><span class="line">         div ecx</span><br><span class="line">         mov ecx,eax                        ;总扇区数 </span><br><span class="line">      </span><br><span class="line">         mov eax,mem_0_4_gb_seg_sel         ;切换DS到0-4GB的段</span><br><span class="line">         mov ds,eax</span><br><span class="line"></span><br><span class="line">         mov eax,[ebp+12*4]                 ;起始扇区号 </span><br><span class="line">  .b1:</span><br><span class="line">         call sys_routine_seg_sel:read_hard_disk_0</span><br><span class="line">         inc eax</span><br><span class="line">         loop .b1                           ;循环读，直到读完整个用户程序</span><br><span class="line"></span><br><span class="line">         mov edi,[es:esi+0x06]              ;获得程序加载基地址</span><br><span class="line"></span><br><span class="line">         ;建立程序头部段描述符</span><br><span class="line">         mov eax,edi                        ;程序头部起始线性地址</span><br><span class="line">         mov ebx,[edi+0x04]                 ;段长度</span><br><span class="line">         dec ebx                            ;段界限</span><br><span class="line">         mov ecx,0x0040f200                 ;字节粒度的数据段描述符，特权级3 </span><br><span class="line">         call sys_routine_seg_sel:make_seg_descriptor</span><br><span class="line">      </span><br><span class="line">         ;安装头部段描述符到LDT中 </span><br><span class="line">         mov ebx,esi                        ;TCB的基地址</span><br><span class="line">         call fill_descriptor_in_ldt</span><br><span class="line"></span><br><span class="line">         or cx,0000_0000_0000_0011B         ;设置选择子的特权级为3</span><br><span class="line">         mov [es:esi+0x44],cx               ;登记程序头部段选择子到TCB </span><br><span class="line">         mov [edi+0x04],cx                  ;和头部内 </span><br><span class="line">      </span><br><span class="line">         ;建立程序代码段描述符</span><br><span class="line">         mov eax,edi</span><br><span class="line">         add eax,[edi+0x14]                 ;代码起始线性地址</span><br><span class="line">         mov ebx,[edi+0x18]                 ;段长度</span><br><span class="line">         dec ebx                            ;段界限</span><br><span class="line">         mov ecx,0x0040f800                 ;字节粒度的代码段描述符，特权级3</span><br><span class="line">         call sys_routine_seg_sel:make_seg_descriptor</span><br><span class="line">         mov ebx,esi                        ;TCB的基地址</span><br><span class="line">         call fill_descriptor_in_ldt</span><br><span class="line">         or cx,0000_0000_0000_0011B         ;设置选择子的特权级为3</span><br><span class="line">         mov [edi+0x14],cx                  ;登记代码段选择子到头部</span><br><span class="line"></span><br><span class="line">         ;建立程序数据段描述符</span><br><span class="line">         mov eax,edi</span><br><span class="line">         add eax,[edi+0x1c]                 ;数据段起始线性地址</span><br><span class="line">         mov ebx,[edi+0x20]                 ;段长度</span><br><span class="line">         dec ebx                            ;段界限 </span><br><span class="line">         mov ecx,0x0040f200                 ;字节粒度的数据段描述符，特权级3</span><br><span class="line">         call sys_routine_seg_sel:make_seg_descriptor</span><br><span class="line">         mov ebx,esi                        ;TCB的基地址</span><br><span class="line">         call fill_descriptor_in_ldt</span><br><span class="line">         or cx,0000_0000_0000_0011B         ;设置选择子的特权级为3</span><br><span class="line">         mov [edi+0x1c],cx                  ;登记数据段选择子到头部</span><br><span class="line"></span><br><span class="line">         ;建立程序堆栈段描述符</span><br><span class="line">         mov ecx,[edi+0x0c]                 ;4KB的倍率 </span><br><span class="line">         mov ebx,0x000fffff</span><br><span class="line">         sub ebx,ecx                        ;得到段界限</span><br><span class="line">         mov eax,4096                        </span><br><span class="line">         mul ecx                         </span><br><span class="line">         mov ecx,eax                        ;准备为堆栈分配内存 </span><br><span class="line">         call sys_routine_seg_sel:allocate_memory</span><br><span class="line">         add eax,ecx                        ;得到堆栈的高端物理地址 </span><br><span class="line">         mov ecx,0x00c0f600                 ;字节粒度的堆栈段描述符，特权级3</span><br><span class="line">         call sys_routine_seg_sel:make_seg_descriptor</span><br><span class="line">         mov ebx,esi                        ;TCB的基地址</span><br><span class="line">         call fill_descriptor_in_ldt</span><br><span class="line">         or cx,0000_0000_0000_0011B         ;设置选择子的特权级为3</span><br><span class="line">         mov [edi+0x08],cx                  ;登记堆栈段选择子到头部</span><br><span class="line"></span><br><span class="line">         ;重定位SALT </span><br><span class="line">         mov eax,mem_0_4_gb_seg_sel         ;这里和前一章不同，头部段描述符</span><br><span class="line">         mov es,eax                         ;已安装，但还没有生效，故只能通</span><br><span class="line">                                            ;过4GB段访问用户程序头部          </span><br><span class="line">         mov eax,core_data_seg_sel</span><br><span class="line">         mov ds,eax</span><br><span class="line">      </span><br><span class="line">         cld</span><br><span class="line"></span><br><span class="line">         mov ecx,[es:edi+0x24]              ;U-SALT条目数(通过访问4GB段取得) </span><br><span class="line">         add edi,0x28                       ;U-SALT在4GB段内的偏移 </span><br><span class="line">  .b2: </span><br><span class="line">         push ecx</span><br><span class="line">         push edi</span><br><span class="line">      </span><br><span class="line">         mov ecx,salt_items</span><br><span class="line">         mov esi,salt</span><br><span class="line">  .b3:</span><br><span class="line">         push edi</span><br><span class="line">         push esi</span><br><span class="line">         push ecx</span><br><span class="line"></span><br><span class="line">         mov ecx,64                         ;检索表中，每条目的比较次数 </span><br><span class="line">         repe cmpsd                         ;每次比较4字节 </span><br><span class="line">         jnz .b4</span><br><span class="line">         mov eax,[esi]                      ;若匹配，则esi恰好指向其后的地址</span><br><span class="line">         mov [es:edi-256],eax               ;将字符串改写成偏移地址 </span><br><span class="line">         mov ax,[esi+4]</span><br><span class="line">         or ax,0000000000000011B            ;以用户程序自己的特权级使用调用门</span><br><span class="line">                                            ;故RPL=3 </span><br><span class="line">         mov [es:edi-252],ax                ;回填调用门选择子 </span><br><span class="line">  .b4:</span><br><span class="line">      </span><br><span class="line">         pop ecx</span><br><span class="line">         pop esi</span><br><span class="line">         add esi,salt_item_len</span><br><span class="line">         pop edi                            ;从头比较 </span><br><span class="line">         loop .b3</span><br><span class="line">      </span><br><span class="line">         pop edi</span><br><span class="line">         add edi,256</span><br><span class="line">         pop ecx</span><br><span class="line">         loop .b2</span><br><span class="line"></span><br><span class="line">         mov esi,[ebp+11*4]                 ;从堆栈中取得TCB的基地址</span><br><span class="line"></span><br><span class="line">         ;创建0特权级堆栈</span><br><span class="line">         mov ecx,4096</span><br><span class="line">         mov eax,ecx                        ;为生成堆栈高端地址做准备 </span><br><span class="line">         mov [es:esi+0x1a],ecx</span><br><span class="line">         shr dword [es:esi+0x1a],12         ;登记0特权级堆栈尺寸到TCB </span><br><span class="line">         call sys_routine_seg_sel:allocate_memory</span><br><span class="line">         add eax,ecx                        ;堆栈必须使用高端地址为基地址</span><br><span class="line">         mov [es:esi+0x1e],eax              ;登记0特权级堆栈基地址到TCB </span><br><span class="line">         mov ebx,0xffffe                    ;段长度（界限）</span><br><span class="line">         mov ecx,0x00c09600                 ;4KB粒度，读写，特权级0</span><br><span class="line">         call sys_routine_seg_sel:make_seg_descriptor</span><br><span class="line">         mov ebx,esi                        ;TCB的基地址</span><br><span class="line">         call fill_descriptor_in_ldt</span><br><span class="line">         ;or cx,0000_0000_0000_0000          ;设置选择子的特权级为0</span><br><span class="line">         mov [es:esi+0x22],cx               ;登记0特权级堆栈选择子到TCB</span><br><span class="line">         mov dword [es:esi+0x24],0          ;登记0特权级堆栈初始ESP到TCB</span><br><span class="line">      </span><br><span class="line">         ;创建1特权级堆栈</span><br><span class="line">         mov ecx,4096</span><br><span class="line">         mov eax,ecx                        ;为生成堆栈高端地址做准备</span><br><span class="line">         mov [es:esi+0x28],ecx</span><br><span class="line">         shr [es:esi+0x28],12               ;登记1特权级堆栈尺寸到TCB</span><br><span class="line">         call sys_routine_seg_sel:allocate_memory</span><br><span class="line">         add eax,ecx                        ;堆栈必须使用高端地址为基地址</span><br><span class="line">         mov [es:esi+0x2c],eax              ;登记1特权级堆栈基地址到TCB</span><br><span class="line">         mov ebx,0xffffe                    ;段长度（界限）</span><br><span class="line">         mov ecx,0x00c0b600                 ;4KB粒度，读写，特权级1</span><br><span class="line">         call sys_routine_seg_sel:make_seg_descriptor</span><br><span class="line">         mov ebx,esi                        ;TCB的基地址</span><br><span class="line">         call fill_descriptor_in_ldt</span><br><span class="line">         or cx,0000_0000_0000_0001          ;设置选择子的特权级为1</span><br><span class="line">         mov [es:esi+0x30],cx               ;登记1特权级堆栈选择子到TCB</span><br><span class="line">         mov dword [es:esi+0x32],0          ;登记1特权级堆栈初始ESP到TCB</span><br><span class="line"></span><br><span class="line">         ;创建2特权级堆栈</span><br><span class="line">         mov ecx,4096</span><br><span class="line">         mov eax,ecx                        ;为生成堆栈高端地址做准备</span><br><span class="line">         mov [es:esi+0x36],ecx</span><br><span class="line">         shr [es:esi+0x36],12               ;登记2特权级堆栈尺寸到TCB</span><br><span class="line">         call sys_routine_seg_sel:allocate_memory</span><br><span class="line">         add eax,ecx                        ;堆栈必须使用高端地址为基地址</span><br><span class="line">         mov [es:esi+0x3a],ecx              ;登记2特权级堆栈基地址到TCB</span><br><span class="line">         mov ebx,0xffffe                    ;段长度（界限）</span><br><span class="line">         mov ecx,0x00c0d600                 ;4KB粒度，读写，特权级2</span><br><span class="line">         call sys_routine_seg_sel:make_seg_descriptor</span><br><span class="line">         mov ebx,esi                        ;TCB的基地址</span><br><span class="line">         call fill_descriptor_in_ldt</span><br><span class="line">         or cx,0000_0000_0000_0010          ;设置选择子的特权级为2</span><br><span class="line">         mov [es:esi+0x3e],cx               ;登记2特权级堆栈选择子到TCB</span><br><span class="line">         mov dword [es:esi+0x40],0          ;登记2特权级堆栈初始ESP到TCB</span><br><span class="line">      </span><br><span class="line">         ;在GDT中登记LDT描述符</span><br><span class="line">         mov eax,[es:esi+0x0c]              ;LDT的起始线性地址</span><br><span class="line">         movzx ebx,word [es:esi+0x0a]       ;LDT段界限</span><br><span class="line">         mov ecx,0x00408200                 ;LDT描述符，特权级0</span><br><span class="line">         call sys_routine_seg_sel:make_seg_descriptor</span><br><span class="line">         call sys_routine_seg_sel:set_up_gdt_descriptor</span><br><span class="line">         mov [es:esi+0x10],cx               ;登记LDT选择子到TCB中</span><br><span class="line">       </span><br><span class="line">         ;创建用户程序的TSS</span><br><span class="line">         mov ecx,104                        ;tss的基本尺寸</span><br><span class="line">         mov [es:esi+0x12],cx              </span><br><span class="line">         dec word [es:esi+0x12]             ;登记TSS界限值到TCB </span><br><span class="line">         call sys_routine_seg_sel:allocate_memory</span><br><span class="line">         mov [es:esi+0x14],ecx              ;登记TSS基地址到TCB</span><br><span class="line">      </span><br><span class="line">         ;登记基本的TSS表格内容</span><br><span class="line">         mov word [es:ecx+0],0              ;反向链=0</span><br><span class="line">      </span><br><span class="line">         mov edx,[es:esi+0x24]              ;登记0特权级堆栈初始ESP</span><br><span class="line">         mov [es:ecx+4],edx                 ;到TSS中</span><br><span class="line">      </span><br><span class="line">         mov dx,[es:esi+0x22]               ;登记0特权级堆栈段选择子</span><br><span class="line">         mov [es:ecx+8],dx                  ;到TSS中</span><br><span class="line">      </span><br><span class="line">         mov edx,[es:esi+0x32]              ;登记1特权级堆栈初始ESP</span><br><span class="line">         mov [es:ecx+12],edx                ;到TSS中</span><br><span class="line"></span><br><span class="line">         mov dx,[es:esi+0x30]               ;登记1特权级堆栈段选择子</span><br><span class="line">         mov [es:ecx+16],dx                 ;到TSS中</span><br><span class="line"></span><br><span class="line">         mov edx,[es:esi+0x40]              ;登记2特权级堆栈初始ESP</span><br><span class="line">         mov [es:ecx+20],edx                ;到TSS中</span><br><span class="line"></span><br><span class="line">         mov dx,[es:esi+0x3e]               ;登记2特权级堆栈段选择子</span><br><span class="line">         mov [es:ecx+24],dx                 ;到TSS中</span><br><span class="line"></span><br><span class="line">         mov dx,[es:esi+0x10]               ;登记任务的LDT选择子</span><br><span class="line">         mov [es:ecx+96],dx                 ;到TSS中</span><br><span class="line">      </span><br><span class="line">         mov dx,[es:esi+0x12]               ;登记任务的I/O位图偏移</span><br><span class="line">         mov [es:ecx+102],dx                ;到TSS中 </span><br><span class="line">      </span><br><span class="line">         mov word [es:ecx+100],0            ;T=0</span><br><span class="line">       </span><br><span class="line">         ;在GDT中登记TSS描述符</span><br><span class="line">         mov eax,[es:esi+0x14]              ;TSS的起始线性地址</span><br><span class="line">         movzx ebx,word [es:esi+0x12]       ;段长度（界限）</span><br><span class="line">         mov ecx,0x00408900                 ;TSS描述符，特权级0</span><br><span class="line">         call sys_routine_seg_sel:make_seg_descriptor</span><br><span class="line">         call sys_routine_seg_sel:set_up_gdt_descriptor</span><br><span class="line">         mov [es:esi+0x18],cx               ;登记TSS选择子到TCB</span><br><span class="line"></span><br><span class="line">         pop es                             ;恢复到调用此过程前的es段 </span><br><span class="line">         pop ds                             ;恢复到调用此过程前的ds段</span><br><span class="line">      </span><br><span class="line">         popad</span><br><span class="line">      </span><br><span class="line">         ret 8                              ;丢弃调用本过程前压入的参数 </span><br><span class="line">      </span><br><span class="line">;-------------------------------------------------------------------------------</span><br><span class="line">append_to_tcb_link:                         ;在TCB链上追加任务控制块</span><br><span class="line">                                            ;输入：ECX=TCB线性基地址</span><br><span class="line">         push eax</span><br><span class="line">         push edx</span><br><span class="line">         push ds</span><br><span class="line">         push es</span><br><span class="line">         </span><br><span class="line">         mov eax,core_data_seg_sel          ;令DS指向内核数据段 </span><br><span class="line">         mov ds,eax</span><br><span class="line">         mov eax,mem_0_4_gb_seg_sel         ;令ES指向0..4GB段</span><br><span class="line">         mov es,eax</span><br><span class="line">         </span><br><span class="line">         mov dword [es: ecx+0x00],0         ;当前TCB指针域清零，以指示这是最</span><br><span class="line">                                            ;后一个TCB</span><br><span class="line">                                             </span><br><span class="line">         mov eax,[tcb_chain]                ;TCB表头指针</span><br><span class="line">         or eax,eax                         ;链表为空？</span><br><span class="line">         jz .notcb </span><br><span class="line">         </span><br><span class="line">  .searc:</span><br><span class="line">         mov edx,eax</span><br><span class="line">         mov eax,[es: edx+0x00]</span><br><span class="line">         or eax,eax               </span><br><span class="line">         jnz .searc</span><br><span class="line">         </span><br><span class="line">         mov [es: edx+0x00],ecx</span><br><span class="line">         jmp .retpc</span><br><span class="line">         </span><br><span class="line">  .notcb:       </span><br><span class="line">         mov [tcb_chain],ecx                ;若为空表，直接令表头指针指向TCB</span><br><span class="line">         </span><br><span class="line">  .retpc:</span><br><span class="line">         pop es</span><br><span class="line">         pop ds</span><br><span class="line">         pop edx</span><br><span class="line">         pop eax</span><br><span class="line">         </span><br><span class="line">         ret</span><br><span class="line">         </span><br><span class="line">;-------------------------------------------------------------------------------</span><br><span class="line">start:</span><br><span class="line">         mov ecx,core_data_seg_sel          ;使ds指向核心数据段 </span><br><span class="line">         mov ds,ecx</span><br><span class="line"></span><br><span class="line">         mov ebx,message_1                    </span><br><span class="line">         call sys_routine_seg_sel:put_string</span><br><span class="line">                                         </span><br><span class="line">         ;显示处理器品牌信息 </span><br><span class="line">         mov eax,0x80000002</span><br><span class="line">         cpuid</span><br><span class="line">         mov [cpu_brand + 0x00],eax</span><br><span class="line">         mov [cpu_brand + 0x04],ebx</span><br><span class="line">         mov [cpu_brand + 0x08],ecx</span><br><span class="line">         mov [cpu_brand + 0x0c],edx</span><br><span class="line">      </span><br><span class="line">         mov eax,0x80000003</span><br><span class="line">         cpuid</span><br><span class="line">         mov [cpu_brand + 0x10],eax</span><br><span class="line">         mov [cpu_brand + 0x14],ebx</span><br><span class="line">         mov [cpu_brand + 0x18],ecx</span><br><span class="line">         mov [cpu_brand + 0x1c],edx</span><br><span class="line"></span><br><span class="line">         mov eax,0x80000004</span><br><span class="line">         cpuid</span><br><span class="line">         mov [cpu_brand + 0x20],eax</span><br><span class="line">         mov [cpu_brand + 0x24],ebx</span><br><span class="line">         mov [cpu_brand + 0x28],ecx</span><br><span class="line">         mov [cpu_brand + 0x2c],edx</span><br><span class="line"></span><br><span class="line">         mov ebx,cpu_brnd0                  ;显示处理器品牌信息 </span><br><span class="line">         call sys_routine_seg_sel:put_string</span><br><span class="line">         mov ebx,cpu_brand</span><br><span class="line">         call sys_routine_seg_sel:put_string</span><br><span class="line">         mov ebx,cpu_brnd1</span><br><span class="line">         call sys_routine_seg_sel:put_string</span><br><span class="line"></span><br><span class="line">         ;以下开始安装为整个系统服务的调用门。特权级之间的控制转移必须使用门</span><br><span class="line">         mov edi,salt                       ;C-SALT表的起始位置 </span><br><span class="line">         mov ecx,salt_items                 ;C-SALT表的条目数量 </span><br><span class="line">  .b3:</span><br><span class="line">         push ecx   </span><br><span class="line">         mov eax,[edi+256]                  ;该条目入口点的32位偏移地址 </span><br><span class="line">         mov bx,[edi+260]                   ;该条目入口点的段选择子 </span><br><span class="line">         mov cx,1_11_0_1100_000_00000B      ;特权级3的调用门(3以上的特权级才</span><br><span class="line">                                            ;允许访问)，0个参数(因为用寄存器</span><br><span class="line">                                            ;传递参数，而没有用栈) </span><br><span class="line">         call sys_routine_seg_sel:make_gate_descriptor</span><br><span class="line">         call sys_routine_seg_sel:set_up_gdt_descriptor</span><br><span class="line">         mov [edi+260],cx                   ;将返回的门描述符选择子回填</span><br><span class="line">         add edi,salt_item_len              ;指向下一个C-SALT条目 </span><br><span class="line">         pop ecx</span><br><span class="line">         loop .b3</span><br><span class="line"></span><br><span class="line">         ;对门进行测试 </span><br><span class="line">         mov ebx,message_2</span><br><span class="line">         call far [salt_1+256]              ;通过门显示信息(偏移量将被忽略) </span><br><span class="line">      </span><br><span class="line">         mov ebx,message_3                    </span><br><span class="line">         call sys_routine_seg_sel:put_string ;在内核中调用例程不需要通过门</span><br><span class="line">      </span><br><span class="line">         ;创建任务控制块。这不是处理器的要求，而是我们自己为了方便而设立的</span><br><span class="line">         mov ecx,0x46</span><br><span class="line">         call sys_routine_seg_sel:allocate_memory</span><br><span class="line">         call append_to_tcb_link            ;将任务控制块追加到TCB链表 </span><br><span class="line">      </span><br><span class="line">         push dword 50                      ;用户程序位于逻辑50扇区</span><br><span class="line">         push ecx                           ;压入任务控制块起始线性地址 </span><br><span class="line">       </span><br><span class="line">         call load_relocate_program</span><br><span class="line">      </span><br><span class="line">         mov ebx,do_status</span><br><span class="line">         call sys_routine_seg_sel:put_string</span><br><span class="line">      </span><br><span class="line">         mov eax,mem_0_4_gb_seg_sel</span><br><span class="line">         mov ds,eax</span><br><span class="line">      </span><br><span class="line">         ltr [ecx+0x18]                     ;加载任务状态段 </span><br><span class="line">         lldt [ecx+0x10]                    ;加载LDT</span><br><span class="line">      </span><br><span class="line">         mov eax,[ecx+0x44]</span><br><span class="line">         mov ds,eax                         ;切换到用户程序头部段 </span><br><span class="line"></span><br><span class="line">         ;以下假装是从调用门返回。摹仿处理器压入返回参数 </span><br><span class="line">         push dword [0x08]                  ;调用前的堆栈段选择子</span><br><span class="line">         push dword 0                       ;调用前的esp</span><br><span class="line"></span><br><span class="line">         push dword [0x14]                  ;调用前的代码段选择子 </span><br><span class="line">         push dword [0x10]                  ;调用前的eip</span><br><span class="line">      </span><br><span class="line">         retf</span><br><span class="line"></span><br><span class="line">return_point:                               ;用户程序返回点</span><br><span class="line">         mov eax,core_data_seg_sel          ;因为c14.asm是以JMP的方式使用调 </span><br><span class="line">         mov ds,eax                         ;用门@TerminateProgram，回到这 </span><br><span class="line">                                            ;里时，特权级为3，会导致异常。 </span><br><span class="line">         mov ebx,message_6</span><br><span class="line">         call sys_routine_seg_sel:put_string</span><br><span class="line"></span><br><span class="line">         hlt</span><br><span class="line">            </span><br><span class="line">core_code_end:</span><br><span class="line"></span><br><span class="line">;-------------------------------------------------------------------------------</span><br><span class="line">SECTION core_trail</span><br><span class="line">;-------------------------------------------------------------------------------</span><br><span class="line">core_end:</span><br></pre></td></tr></table></figure>



<h3 id="加载内核程序"><a href="#加载内核程序" class="headerlink" title="加载内核程序"></a>加载内核程序</h3><p>加载的是内核程序，而内核应当工作在 0 特权级，所以主引导程序在初始化内核时，所创建的描述符，其目标特权级 DPL 都为 0，</p>
<p><img src="/images/image-20220218002702032.png" alt="image-20220218002702032"></p>
<p>这些描述符所指向的段，有的是代码段，有的是数据段。</p>
<ul>
<li>对于数据段，只有内核自己才能访问，因为其描述符的 DPL 是 0；</li>
<li>对于代码段，通常只有 0 特权级的程序才能将控制转移到该段，也就是说，只能从内核其他正在执行的部分转移到该段执行，因为它们的特权级别相同。</li>
</ul>
<h3 id="调用门"><a href="#调用门" class="headerlink" title="调用门"></a>调用门</h3><p>例程是由内核提供的，它们的特权级通常就是内核的特权级。在上一章里，内核赋予用户程序的特权级别是 0，所以用户程序是在 0 特权级上运行的。也正是因为如此，当用户程序通过 U-SALT 表中的符号地址直接调用内核例程时，才会通过特权级检查。</p>
<p>在本章里，将用户程序的特权级定为 3，为了让用户程序也能顺利调用例程，需要安装<code>调用门</code>。</p>
<p>调用门（Call-Gate）<strong>用于在不同特权级的程序之间进行控制转移</strong>。 本质上，它只是一个描述符，可以安装在 GDT 或者 LDT 中。</p>
<h4 id="为什么门描述符存储的是选择子而不是线性地址"><a href="#为什么门描述符存储的是选择子而不是线性地址" class="headerlink" title="为什么门描述符存储的是选择子而不是线性地址"></a>为什么门描述符存储的是选择子而不是线性地址</h4><p>对比一下段描述符，里面储存了段基地址和段界限：</p>
<p><img src="/images/f3725cc8-image-20220212222908156.png" alt="image-20220212222908156"></p>
<p>但是门描述符中储存的却是例程所在代码段的选择子，以及段内偏移等信息：</p>
<p><img src="/images/9a86b136-f55a1c902a8cd3c6c362a8f0c07a21e2.jpg" alt="img"></p>
<p>原因：</p>
<p>目的决定结构。<strong>段描述符用于描述内存段，门描述符用于描述可执行的代码</strong>。</p>
<ol>
<li>因为门描述符存储了例程所在代码段的选择子，所以可以在通过调用门进行控制转移时，进行代码段描述符有效性、段界限和特权级的检查。</li>
<li>同时因为门描述符里面已经存储了选择子和段内偏移，在通过调用门调用例程时，不需要指令中给出的偏移量。方便使用。</li>
</ol>
<h4 id="门描述符的属性位"><a href="#门描述符的属性位" class="headerlink" title="门描述符的属性位"></a>门描述符的属性位</h4><ul>
<li>TYPE 字段用于标识门的类型，共 4 比特，值 1100 表示调用门。</li>
<li>P 位是有效位，通常应该是 1。当它为 0 时，调用这样的门会导致处理器产生异常中断。</li>
</ul>
<h4 id="通过调用门进行控制转移"><a href="#通过调用门进行控制转移" class="headerlink" title="通过调用门进行控制转移"></a>通过调用门进行控制转移</h4><p>要想通过调用门进行控制转移，可以使用 jmp far 或者 call far 指令，并把调用门描述符的选择子作为操作数。</p>
<ul>
<li>使用 jmp far 指令，可以将控制通过门转移到比当前特权级高的代码段，但<strong>不改变当前特权级别</strong>。</li>
<li>使用 call far 指令，则当前特权级会<strong>提升到目标代码段的特权级别</strong>。也就是说，处理器是在目标代码段的特权级上执行的。</li>
</ul>
<p>为什么 call for 指令会提升特权级别？</p>
<p>答：因为栈段的特权级必须同当前特权级保持一致，因此需要从低特权级的栈切换到高特权级的栈。</p>
<p>为了切换栈，每个任务除了自己固有的栈之外，还必须额外定义几套栈，具体数量取决于任务的特权级别。</p>
<ul>
<li>0 特权级任务不需要额外的栈， 它自己固有的栈就足够使用，因为除了调用返回外，不可能将控制转移到低特权级的段；</li>
<li>1 特权级的任务需要额外定义 1 个描述符特权级 DPL 为 0 的栈，以便将控制转移到 0 特权级时使用；</li>
<li>2 特权级的任务需要额外定义 2 个栈，描述符特权级 DPL 分别是 0 和 1，在控制转移到 0 特权级和 1 特权级时使用；</li>
<li>3 特权级的任务最多额外定义 3 个栈，描述符特权级 分别是 0、1 和 2，在控制转移到 0、1 和 2 特权级时使用。</li>
</ul>
<p>这些额外的栈，也会由操作系统加载程序时自动创建。这些栈的描述符位于任务自己的 LDT 中。同时，还要在任务的 TSS 中登记，原因是，栈切换是由处理器固件自动完成的，处理器需要根据 TSS 中的信息来完成这一过程。</p>
<p>回顾 TSS 的结构：</p>
<p><img src="/images/e1e151c7-image-20220217122115613.png" alt="image-20220217122115613"></p>
<ul>
<li>从偏移 4～24 处登记有特权级 0 到 2 的栈段选择子，以及相应的 ESP 初始值。</li>
<li>任务自己固有的栈信息则位于偏移量为 56（ESP）和 80（SS） 的地方。</li>
</ul>
<p>在切换栈时，处理器可以用 TR 找到当前任务的 TSS，并从 TSS 中获取新栈的信息：</p>
<ol>
<li>栈切换前，段寄存器 SS 指向的是旧栈，ESP 指向旧栈的栈顶，即最后一个被压入的过程参数；</li>
<li>栈切换后，处理器自动替换 SS 和 ESP 寄存器的内容，使它们分别为新栈的选择子和新栈的栈顶。</li>
</ol>
<p>这一切，对程序的编写者来说是透明的。就是说，程序员不用关心栈的切换和参数的复制，他即使不知道还有栈切换这回事，也不会影响程序编写工作。</p>
<h4 id="哪些程序可以访问门"><a href="#哪些程序可以访问门" class="headerlink" title="哪些程序可以访问门"></a>哪些程序可以访问门</h4><p>调用门描述符中的 DPL 和目标代码（就是门描述符指向的代码）段描述符的 DPL 用于决定哪些特权级的程序可以访问此门：</p>
<ul>
<li><p>当前特权级 CPL 和 请求特权级 RPL 都要高于或等于调用门描述符特权级的 DPL。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CPL &lt;= 调用门描述符的DPL</span><br><span class="line">PRL &lt;= 调用门描述符的DPL</span><br></pre></td></tr></table></figure></li>
<li><p>当前特权级 CPL 低于或等于目标代码段描述符特权级的 DPL。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CPL &gt;= 目标代码段描述符的DPL</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="调用门的安装和测试"><a href="#调用门的安装和测试" class="headerlink" title="调用门的安装和测试"></a>调用门的安装和测试</h3><p>调用门描述符可以在 GDT 中创建的，4 个调用门安装之后，GDT 的布局如图：</p>
<p><img src="/images/image-20220218121822627.png" alt="image-20220218121822627"></p>
<h2 id="加载用户程序并创建任务"><a href="#加载用户程序并创建任务" class="headerlink" title="加载用户程序并创建任务"></a>加载用户程序并创建任务</h2><h3 id="任务控制块和-TCB-链"><a href="#任务控制块和-TCB-链" class="headerlink" title="任务控制块和 TCB 链"></a>任务控制块和 TCB 链</h3><p>在内核初始化完成后，接下来的工作就是加载和重定位用户程序（ 应用程序），并移交控制权。</p>
<p>一个程序成为“任务”，并且能够参与任务切换和调度，必须要有 LDT 和 TSS。</p>
<p>有点吃力，沉淀一下再看。</p>
<p>To be continue…</p>
<p><a target="_blank" rel="noopener" href="https://github.com/liracle/codeOfAssembly/tree/master/booktool">https://github.com/liracle/codeOfAssembly/tree/master/booktool</a></p>
</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>