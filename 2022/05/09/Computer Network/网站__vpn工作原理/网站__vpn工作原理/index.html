<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;vpn-的原理&quot;&gt;&lt;a href=&quot;#vpn-的原理&quot; class=&quot;headerlink&quot; title=&quot;vpn 的原理&quot;&gt;&lt;/a&gt;vpn 的原理&lt;/h2&gt;&lt;p&gt;vpn：Virtual Private Network，虚拟专用网络。"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>vpn工作原理 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Computer-Network/" rel="tag">Computer Network</a></div><div class="post-time">2022-05-09</div></div></div><div class="container post-header"><h1>vpn工作原理</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#vpn-%E7%9A%84%E5%8E%9F%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">vpn 的原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-vpn-%E7%BF%BB%E5%A2%99"><span class="toc-number">2.</span> <span class="toc-text">使用 vpn 翻墙</span></a></li></ol></details></div><div class="container post-content"><h2 id="vpn-的原理"><a href="#vpn-的原理" class="headerlink" title="vpn 的原理"></a>vpn 的原理</h2><p>vpn：Virtual Private Network，虚拟专用网络。</p>
<p>vpn 通常拿来做 2 个事情，一个是可以让世界上任意 2 台机器进入一个虚拟的局域网中（当然这个局域网的数据通讯是加密的，很安全，用起来和一个家庭局域网没有区别），一个是可以用来翻墙。</p>
<p>vpn 比 shadowsocks 更加底层，它通过操作系统的接口直接<strong>虚拟出一张网卡，后续整个操作系统的网络通讯都将通过这张虚拟的网卡进行收发</strong>。这和任何一个代理的实现思路都差不多，应用层并不知道网卡是虚拟的，这样 vpn 虚拟网卡将以中间人的身份对数据进行加工，从而实现各种神奇的效果。具体来说，vpn 是通过编写一套网卡驱动并注册到操作系统实现的虚拟网卡，这样数据只要经过网卡收发就可以进行拦截处理。</p>
<p>一句话，<strong>vpn 在 IP 层工作，而 shadowsocks 在 TCP 层工作</strong>。</p>
<h2 id="使用-vpn-翻墙"><a href="#使用-vpn-翻墙" class="headerlink" title="使用 vpn 翻墙"></a>使用 vpn 翻墙</h2><p><img src="/images/image-20220509170922467.png" alt="image-20220509170922467"></p>
<p>使用 vpn 翻墙需要使用 vps 中转流量。在 vps 上部署 vpn server，客户端所有数据将经过虚拟网卡的加密封装后都转发给 vps 上的 vpn server，由它来转发给目标服务器，这和 shadowsocks server 原理类似，由 vpn 协议加密从而绕过 GFW 实现访问墙外网站，下面将以 pptp vpn 协议为例说明。</p>
<p>假设要访问谷歌，那么客户端发出的数据包首先通过协议栈处理封装成 IP 包，其源地址是虚拟网卡的地址，例如：192.168.0.2，而目标地址是谷歌的 IP。</p>
<p>原始 IP 包交给虚拟网卡发送时，PPTP 网卡驱动会按 PPP 协议对这个 IP 包整体加密封装作为新的 payload，用一层新的 IP 头封装这个 payload 发送出去，这个新 IP 头的目标地址是 vpn server，源地址是客户端的外网 IP。</p>
<p>vpn server 的协议栈会剥离掉新 IP 头，将内部 PPP 协议的 payload 交给 pptpd 进程处理，pptpd 进程会按 PPP 协议解包得到原始的 IP 包，我们知道这个 IP 包的源地址是 192.168.0.2，目标地址 google。因此，pptpd 进程需要做的是将这个 IP 包的源 IP 地址改为 vps 的地址，然后将 IP 包发给谷歌，从而和谷歌进行数据交换。最终，pptpd 理所应当将谷歌的应答 IP 包的目标 IP 地址换成 192.168.0.2，然后经过 PPP 协议封装并添加新的 IP 头后发回给客户端既可。</p>
<p>不过要注意在 pptpd 的实现里，这个源地址修改是通过 iptables 实现的，也就是添加通过 iptables 添加一个 NAT 规则，实现来源地址的映射转换，这个在你配置 pptp 的过程中就会看到。</p>
</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>