<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;断点续传原理和协议&quot;&gt;&lt;a href=&quot;#断点续传原理和协议&quot; class=&quot;headerlink&quot; title=&quot;断点续传原理和协议&quot;&gt;&lt;/a&gt;断点续传原理和协议&lt;/h2&gt;&lt;p&gt;下载文件时暂停后可以继续接着下载，&lt;strong&gt;在线看视频时可以随意拖动进度条&lt;/strong&gt;，这些都是断点续传所实现的应用。"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>GO语言实现断点续传和多线程下载 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Golang/" rel="tag">Golang</a></div><div class="post-time">2022-05-10</div></div></div><div class="container post-header"><h1>GO语言实现断点续传和多线程下载</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0%E5%8E%9F%E7%90%86%E5%92%8C%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.</span> <span class="toc-text">断点续传原理和协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E5%88%B0%E7%9A%84-Headers"><span class="toc-number">1.1.</span> <span class="toc-text">用到的 Headers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Accept-Ranges"><span class="toc-number">1.2.</span> <span class="toc-text">Accept-Ranges</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Range"><span class="toc-number">1.3.</span> <span class="toc-text">Range</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Content-Range"><span class="toc-number">1.4.</span> <span class="toc-text">Content-Range</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#example"><span class="toc-number">2.</span> <span class="toc-text">example</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-HTTP-%E7%9A%84%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8B%E8%BD%BD%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">3.</span> <span class="toc-text">基于 HTTP 的断点续传多线程下载的客户端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-HTTP-%E7%9A%84%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8B%E8%BD%BD%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-number">4.</span> <span class="toc-text">基于 HTTP 的断点续传多线程下载的服务端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-HTTP-%E7%9A%84%E6%96%AD%E7%82%B9%E4%B8%8A%E4%BC%A0%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-number">5.</span> <span class="toc-text">基于 HTTP 的断点上传的服务端</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AE%A9%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%88%9D%E5%A7%8B%E5%8C%96%E5%BD%93%E5%89%8D%E6%96%87%E4%BB%B6%E7%9A%84%E5%88%86%E5%9D%97%E4%BF%A1%E6%81%AF%E6%8E%A5%E5%8F%A3"><span class="toc-number">5.1.</span> <span class="toc-text">客户端让服务端初始化当前文件的分块信息接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E5%88%86%E5%9D%97%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.2.</span> <span class="toc-text">上传文件分块接口实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%80%9A%E7%9F%A5%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%B8%8A%E4%BC%A0%E5%85%A8%E9%83%A8%E5%AE%8C%E6%88%90%EF%BC%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8A%8A%E5%88%86%E5%9D%97%E5%90%88%E5%B9%B6%E6%88%90%E4%B8%80%E4%B8%AA%E6%96%87%E4%BB%B6"><span class="toc-number">5.3.</span> <span class="toc-text">客户端通知服务端上传全部完成，服务端把分块合并成一个文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E7%9A%84%E7%AE%80%E6%98%93%E6%96%87%E4%BB%B6%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0"><span class="toc-number">6.</span> <span class="toc-text">基于自定义协议的简易文件断点续传</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#reference"><span class="toc-number"></span> <span class="toc-text">reference</span></a></details></div><div class="container post-content"><h2 id="断点续传原理和协议"><a href="#断点续传原理和协议" class="headerlink" title="断点续传原理和协议"></a>断点续传原理和协议</h2><p>下载文件时暂停后可以继续接着下载，<strong>在线看视频时可以随意拖动进度条</strong>，这些都是断点续传所实现的应用。</p>
<p> 断点续传是一种人为切分传输文件，采用多线程进行部分上传 / 下载操作的文件传输技术。当网络出现状况，文件传输中断的时候，用户可以从已经上传 / 下载的部分继续进行传输而不必从头开始，减少资源和时间消耗。</p>
<p>以下载为例：当我进行下载的时候，我并不会一次性的去请求所有的资源，而是用多个线程，每个线程去请求一部分资源。当所有文件下载完成后，将它们拼接成一个完整的文件并对它做<strong>完整性校验</strong>，如果通过的话，那我们这个资源便成功下载了的。</p>
<h3 id="用到的-Headers"><a href="#用到的-Headers" class="headerlink" title="用到的 Headers"></a>用到的 Headers</h3><ul>
<li><code>Accept-Ranges</code>：服务器用此 header 说明是否支持范围请求</li>
<li><code>Range</code>：客户端发送请求时，指定请求的范围</li>
<li><code>Content-Range</code>：服务器端响应时，表示数据在整个文件中的位置</li>
</ul>
<h3 id="Accept-Ranges"><a href="#Accept-Ranges" class="headerlink" title="Accept-Ranges"></a>Accept-Ranges</h3><p>此规范来自 <code>RFC 7233</code>，服务器使用 HTTP 响应头 <code>Accept-Ranges</code> 标识<strong>服务器支持范围请求</strong> (partial requests)。如果存在 <code>Accept-Ranges</code> ，浏览器可能会尝试恢复中断的下载，而不是从头再次开始。</p>
<p>字段的具体值用于定义范围请求的单位，属于禁止修改的响应头类型。 其语法规则如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Accept-Ranges: bytes</span><br><span class="line">Accept-Ranges: none</span><br></pre></td></tr></table></figure>

<ul>
<li><code>none</code> 表示不接受范围请求，一些响应会显式的写出标明，而另一些则不包含，</li>
<li><code>bytes</code> 表示范围请求的单位是 bytes。</li>
</ul>
<h3 id="Range"><a href="#Range" class="headerlink" title="Range"></a>Range</h3><p>此规范来自 <code>RFC 7233</code>， Range 是一个请求首部，<strong>告知服务器返回文件的哪一部分</strong>。</p>
<p>在一个 Range 中，<strong>可以一次性请求多个部分，服务器会以 multipart 文件的形式将其返回</strong>。</p>
<ul>
<li>如果服务器返回的是范围响应，需要使用 <code>206 Partial Content</code> 状态码。</li>
<li>假如所请求的范围不合法，那么服务器会返回 <code>416 Range Not Satisfiable</code> 状态码，表示客户端错误。</li>
<li>服务器允许忽略 Range 首部，从而返回整个文件，状态码用 <code>200</code>。 </li>
</ul>
<p>其语法规则如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Range: &lt;unit&gt;=&lt;range-start&gt;-</span><br><span class="line">Range: &lt;unit&gt;=&lt;range-start&gt;-&lt;range-end&gt;</span><br><span class="line">Range: &lt;unit&gt;=&lt;range-start&gt;-&lt;range-end&gt;, &lt;range-start&gt;-&lt;range-end&gt;</span><br><span class="line">Range: &lt;unit&gt;=&lt;range-start&gt;-&lt;range-end&gt;, &lt;range-start&gt;-&lt;range-end&gt;, &lt;range-start&gt;-&lt;range-end&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>unit</code> 表示范围采用单位，常为 bytes</li>
<li><code>range-start</code> 整数表示范围的起始值</li>
<li><code>range-end</code> 整数表示范围的结束值，若不存在，则表示范围延伸到文件末尾。</li>
</ul>
<p>eg：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Range: bytes=200-1000, 2000-6576, 19000-</span><br></pre></td></tr></table></figure>



<h3 id="Content-Range"><a href="#Content-Range" class="headerlink" title="Content-Range"></a>Content-Range</h3><p>此规范来自 <code>RFC 7233</code>，响应首部 Content-Range 显示的是<strong>一个数据片段在整个文件中的位置</strong>。 其语法规则如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Content-Range: &lt;unit&gt; &lt;range-start&gt;-&lt;range-end&gt;/&lt;size&gt;</span><br><span class="line">Content-Range: &lt;unit&gt; &lt;range-start&gt;-&lt;range-end&gt;/*</span><br><span class="line">Content-Range: &lt;unit&gt; */&lt;size&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>unit</code> 表示范围采用单位，常为 bytes</li>
<li><code>range-start</code> 整数，表示范围的起始值</li>
<li><code>range-end</code> 整数，表示范围的结束值，若不存在，则表示范围延伸到文件末尾。</li>
<li><code>size</code> 为整个文件的大小（如果大小未知则用 <code>*</code> 表示）。</li>
</ul>
<p>eg：表示当前 http 报文的 body 数据是 200-1000，文件一共有 <code>67589</code> 个字节。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Range: bytes 200-1000/67589</span><br></pre></td></tr></table></figure>



<h2 id="example"><a href="#example" class="headerlink" title="example"></a>example</h2><p><img src="/images/download.jpg" alt="img"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ curl --location --head <span class="string">&#x27;https://download.jetbrains.com/go/goland-2020.2.2.exe&#x27;</span></span><br><span class="line">date: Sat, 15 Aug 2020 02:44:09 GMT</span><br><span class="line">content-type: text/html</span><br><span class="line">content-length: 138</span><br><span class="line">location: https://download-cf.jetbrains.com/go/goland-2020.2.2.exe</span><br><span class="line">server: nginx</span><br><span class="line">strict-transport-security: max-age=31536000; includeSubdomains;</span><br><span class="line">x-frame-options: DENY</span><br><span class="line">x-content-type-options: nosniff</span><br><span class="line">x-xss-protection: 1; mode=block;</span><br><span class="line">x-geocountry: United States</span><br><span class="line">x-geocode: US</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: binary/octet-stream</span><br><span class="line">Content-Length: 338589968</span><br><span class="line">Connection: keep-alive</span><br><span class="line">x-amz-replication-status: COMPLETED</span><br><span class="line">Last-Modified: Wed, 12 Aug 2020 13:01:03 GMT</span><br><span class="line">x-amz-version-id: p7a4LsL6K1MJ7UioW7HIz_..LaZptIUP</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line">Server: AmazonS3</span><br><span class="line">Date: Fri, 14 Aug 2020 21:27:08 GMT</span><br><span class="line">ETag: <span class="string">&quot;1312fd0956b8cd529df1100d5e01837f-41&quot;</span></span><br><span class="line">X-Cache: Hit from cloudfront</span><br><span class="line">Via: 1.1 8de6b68254cf659df39a819631940126.cloudfront.net (CloudFront)</span><br><span class="line">X-Amz-Cf-Pop: PHX50-C1</span><br><span class="line">X-Amz-Cf-Id: LF_ZIrTnDKrYwXHxaOrWQbbaL58uW9Y5n993ewQpMZih0zmYi9JdIQ==</span><br><span class="line">Age: 19023</span><br></pre></td></tr></table></figure>

<p>发现，响应的 Header 中存在 Accept-Ranges 首部（并且它的值不为 “none”），那么表示该服务器支持范围请求 (支持断点续传)。</p>
<p>使用 cURL 发送一个 <code>HEADER</code> 请求来进行检测：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -I http://i.imgur.com/z4d4kWk.jpg</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">...</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line">Content-Length: 146515</span><br></pre></td></tr></table></figure>

<p>在上面的响应中，<code>Accept-Ranges: bytes</code> 表示界定范围的单位是 bytes，这里 <code>Content-Length</code> 说明了要检索的图片的完整大小。</p>
<p>如果站点返回的 Header 中不包括 Accept-Ranges，那么它有可能不支持范围请求。一些站点会明确将其值设置为 “none”，以此来表明不支持。在这种情况下，<strong>某些应用的下载管理器会将暂停按钮禁用</strong>。</p>
<h2 id="基于-HTTP-的断点续传多线程下载的客户端"><a href="#基于-HTTP-的断点续传多线程下载的客户端" class="headerlink" title="基于 HTTP 的断点续传多线程下载的客户端"></a>基于 HTTP 的断点续传多线程下载的客户端</h2><p>通过以下代码可以了解到多线程下载的原理，同时给您突破百度网盘下载提供思路。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;crypto/sha256&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/hex&quot;</span></span><br><span class="line">	<span class="string">&quot;errors&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;mime&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;path/filepath&quot;</span></span><br><span class="line">	<span class="string">&quot;strconv&quot;</span></span><br><span class="line">	<span class="string">&quot;sync&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//filePart 文件分片</span></span><br><span class="line"><span class="keyword">type</span> filePart <span class="keyword">struct</span> &#123;</span><br><span class="line">	Index <span class="keyword">int</span>    <span class="comment">// 文件分片的序号</span></span><br><span class="line">	From  <span class="keyword">int</span>    <span class="comment">// 开始byte</span></span><br><span class="line">	To    <span class="keyword">int</span>    <span class="comment">// 解决byte</span></span><br><span class="line">	Data  []<span class="keyword">byte</span> <span class="comment">// http下载得到的文件内容</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FileDownloader 文件下载器</span></span><br><span class="line"><span class="keyword">type</span> FileDownloader <span class="keyword">struct</span> &#123;</span><br><span class="line">	url            <span class="keyword">string</span>     <span class="comment">// 下载源链接</span></span><br><span class="line">	fileSize       <span class="keyword">int</span>        <span class="comment">// 待下载文件总大小</span></span><br><span class="line">	outputDir      <span class="keyword">string</span>     <span class="comment">// 保存文件的目录</span></span><br><span class="line">	outputFileName <span class="keyword">string</span>     <span class="comment">// 保存文件的文件名</span></span><br><span class="line">	totalPart      <span class="keyword">int</span>        <span class="comment">// 文件切片数，对应为下载线程</span></span><br><span class="line">	doneFilePart   []filePart <span class="comment">// 已完成文件切片</span></span><br><span class="line">	md5            <span class="keyword">string</span>     <span class="comment">// 文件下载完成校验，例如md5, SHA-256等</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewFileDownloader</span><span class="params">(url, outputFileName, outputDir <span class="keyword">string</span>, totalPart <span class="keyword">int</span>)</span> *<span class="title">FileDownloader</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> outputDir == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		wd, err := os.Getwd() <span class="comment">//获取当前工作目录</span></span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(err)</span><br><span class="line">		&#125;</span><br><span class="line">		outputDir = wd</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;FileDownloader&#123;</span><br><span class="line">		fileSize:       <span class="number">0</span>,</span><br><span class="line">		url:            url,</span><br><span class="line">		outputFileName: outputFileName,</span><br><span class="line">		outputDir:      outputDir,</span><br><span class="line">		totalPart:      totalPart,</span><br><span class="line">		doneFilePart:   <span class="built_in">make</span>([]filePart, totalPart),</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// newRequest 创建一个request</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d FileDownloader)</span> <span class="title">newRequest</span><span class="params">(method <span class="keyword">string</span>)</span> <span class="params">(*http.Request, error)</span></span> &#123;</span><br><span class="line">	r, err := http.NewRequest(</span><br><span class="line">		method,</span><br><span class="line">		d.url,</span><br><span class="line">		<span class="literal">nil</span>,</span><br><span class="line">	)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	r.Header.Set(<span class="string">&quot;User-Agent&quot;</span>, <span class="string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.127 Safari/537.36&quot;</span>)</span><br><span class="line">	<span class="keyword">return</span> r, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//head 获取要下载的文件的基本信息(header) 使用HTTP Method Head</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *FileDownloader)</span> <span class="title">head</span><span class="params">()</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</span><br><span class="line">	req, err := d.newRequest(<span class="string">&quot;HEAD&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	resp, err := http.DefaultClient.Do(req)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> resp.StatusCode &gt; <span class="number">299</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, errors.New(fmt.Sprintf(<span class="string">&quot;Can&#x27;t process, response is %v&quot;</span>, resp.StatusCode))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//检查是否支持 断点续传</span></span><br><span class="line">	<span class="keyword">if</span> resp.Header.Get(<span class="string">&quot;Accept-Ranges&quot;</span>) != <span class="string">&quot;bytes&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">&quot;服务器不支持文件断点续传&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	d.outputFileName = parseFileInfoFrom(resp)</span><br><span class="line">	<span class="keyword">return</span> strconv.Atoi(resp.Header.Get(<span class="string">&quot;Content-Length&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//下载分片</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d FileDownloader)</span> <span class="title">downloadPart</span><span class="params">(c filePart)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	r, err := d.newRequest(<span class="string">&quot;GET&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	log.Printf(<span class="string">&quot;开始[%d]下载from:%d to:%d\n&quot;</span>, c.Index, c.From, c.To)</span><br><span class="line">	r.Header.Set(<span class="string">&quot;Range&quot;</span>, fmt.Sprintf(<span class="string">&quot;bytes=%v-%v&quot;</span>, c.From, c.To))</span><br><span class="line">	resp, err := http.DefaultClient.Do(r)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> resp.StatusCode &gt; <span class="number">299</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(fmt.Sprintf(<span class="string">&quot;服务器错误状态码: %v&quot;</span>, resp.StatusCode))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line">	bs, err := ioutil.ReadAll(resp.Body)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(bs) != (c.To - c.From + <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">&quot;下载文件分片长度错误&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	c.Data = bs</span><br><span class="line">	d.doneFilePart[c.Index] = c</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//mergeFileParts 合并下载的文件</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d FileDownloader)</span> <span class="title">mergeFileParts</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	log.Println(<span class="string">&quot;开始合并文件&quot;</span>)</span><br><span class="line">	path := filepath.Join(d.outputDir, d.outputFileName)</span><br><span class="line">	mergedFile, err := os.Create(path)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> mergedFile.Close()</span><br><span class="line"></span><br><span class="line">	hash := sha256.New()</span><br><span class="line">	totalSize := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> _, s := <span class="keyword">range</span> d.doneFilePart &#123;</span><br><span class="line">		mergedFile.Write(s.Data)</span><br><span class="line">		hash.Write(s.Data)</span><br><span class="line">		totalSize += <span class="built_in">len</span>(s.Data)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> totalSize != d.fileSize &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">&quot;文件不完整&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//https://download.jetbrains.com/go/goland-2020.2.2.dmg.sha256?_ga=2.223142619.1968990594.1597453229-1195436307.1493100134</span></span><br><span class="line">	<span class="keyword">if</span> hex.EncodeToString(hash.Sum(<span class="literal">nil</span>)) != <span class="string">&quot;3af4660ef22f805008e6773ac25f9edbc17c2014af18019b7374afbed63d4744&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">&quot;文件损坏&quot;</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		log.Println(<span class="string">&quot;文件SHA-256校验成功&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Run 开始下载任务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *FileDownloader)</span> <span class="title">Run</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	fileTotalSize, err := d.head()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	d.fileSize = fileTotalSize</span><br><span class="line"></span><br><span class="line">	jobs := <span class="built_in">make</span>([]filePart, d.totalPart)</span><br><span class="line">	eachSize := fileTotalSize / d.totalPart</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> jobs &#123;</span><br><span class="line">		jobs[i].Index = i</span><br><span class="line">		<span class="keyword">if</span> i == <span class="number">0</span> &#123;</span><br><span class="line">			jobs[i].From = <span class="number">0</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			jobs[i].From = jobs[i<span class="number">-1</span>].To + <span class="number">1</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> i &lt; d.totalPart<span class="number">-1</span> &#123;</span><br><span class="line">			jobs[i].To = jobs[i].From + eachSize</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">//the last filePart</span></span><br><span class="line">			jobs[i].To = fileTotalSize - <span class="number">1</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">	<span class="keyword">for</span> _, j := <span class="keyword">range</span> jobs &#123;</span><br><span class="line">		wg.Add(<span class="number">1</span>)</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(job filePart)</span></span> &#123;</span><br><span class="line">			<span class="keyword">defer</span> wg.Done()</span><br><span class="line">			err := d.downloadPart(job)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Println(<span class="string">&quot;下载文件失败:&quot;</span>, err, job)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;(j)</span><br><span class="line">	&#125;</span><br><span class="line">	wg.Wait()</span><br><span class="line">	<span class="keyword">return</span> d.mergeFileParts()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parseFileInfoFrom</span><span class="params">(resp *http.Response)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	contentDisposition := resp.Header.Get(<span class="string">&quot;Content-Disposition&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> contentDisposition != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		_, params, err := mime.ParseMediaType(contentDisposition)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="built_in">panic</span>(err)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> params[<span class="string">&quot;filename&quot;</span>]</span><br><span class="line">	&#125;</span><br><span class="line">	filename := filepath.Base(resp.Request.URL.Path)</span><br><span class="line">	<span class="keyword">return</span> filename</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	startTime := time.Now()</span><br><span class="line">	<span class="comment">// 下载文件的地址</span></span><br><span class="line">	url := <span class="string">&quot;https://download.jetbrains.com/go/goland-2020.2.2.dmg&quot;</span></span><br><span class="line">	downloader := NewFileDownloader(url, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="number">10</span>)</span><br><span class="line">	err := downloader.Run()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;\n 文件下载完成耗时: %f second\n&quot;</span>, time.Now().Sub(startTime).Seconds())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Run go run main.go</span><br><span class="line">2020/08/15 02:15:31 开始[9]下载from:376446150 to:418273495</span><br><span class="line">2020/08/15 02:15:31 开始[0]下载from:0 to:41827349</span><br><span class="line">2020/08/15 02:15:31 开始[1]下载from:41827350 to:83654699</span><br><span class="line">2020/08/15 02:15:31 开始[5]下载from:209136750 to:250964099</span><br><span class="line">2020/08/15 02:15:31 开始[6]下载from:250964100 to:292791449</span><br><span class="line">2020/08/15 02:15:31 开始[7]下载from:292791450 to:334618799</span><br><span class="line">2020/08/15 02:15:31 开始[2]下载from:83654700 to:125482049</span><br><span class="line">2020/08/15 02:15:31 开始[8]下载from:334618800 to:376446149</span><br><span class="line">2020/08/15 02:15:31 开始[4]下载from:167309400 to:209136749</span><br><span class="line">2020/08/15 02:15:31 开始[3]下载from:125482050 to:167309399</span><br><span class="line">2020/08/15 02:15:36 开始合并文件</span><br><span class="line">2020/08/15 02:15:38 文件SHA-256校验成功</span><br><span class="line"></span><br><span class="line"> 文件下载完成耗时: 7.169149 second</span><br></pre></td></tr></table></figure>



<h2 id="基于-HTTP-的断点续传多线程下载的服务端"><a href="#基于-HTTP-的断点续传多线程下载的服务端" class="headerlink" title="基于 HTTP 的断点续传多线程下载的服务端"></a>基于 HTTP 的断点续传多线程下载的服务端</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> send_file</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;io&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;strconv&quot;</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sendFile</span><span class="params">(writer http.ResponseWriter, request *http.Request, f *os.File)</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> f.Close()</span><br><span class="line">	info, err := f.Stat()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(<span class="string">&quot;sendFile1&quot;</span>, err.Error())</span><br><span class="line">		http.NotFound(writer, request)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	writer.Header().Add(<span class="string">&quot;Accept-Ranges&quot;</span>, <span class="string">&quot;bytes&quot;</span>)</span><br><span class="line">	writer.Header().Add(<span class="string">&quot;Content-Disposition&quot;</span>, <span class="string">&quot;attachment; filename=&quot;</span>+info.Name())</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> start, end <span class="keyword">int64</span></span><br><span class="line">	<span class="keyword">if</span> r := request.Header.Get(<span class="string">&quot;Range&quot;</span>); r != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> strings.Contains(r, <span class="string">&quot;bytes=&quot;</span>) &amp;&amp; strings.Contains(r, <span class="string">&quot;-&quot;</span>) &#123;</span><br><span class="line">			fmt.Sscanf(r, <span class="string">&quot;bytes=%d-%d&quot;</span>, &amp;start, &amp;end)</span><br><span class="line">			<span class="keyword">if</span> end == <span class="number">0</span> &#123;</span><br><span class="line">				end = info.Size() - <span class="number">1</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> start &gt; end || start &lt; <span class="number">0</span> || end &lt; <span class="number">0</span> || end &gt;= info.Size() &#123;</span><br><span class="line">				writer.WriteHeader(http.StatusRequestedRangeNotSatisfiable)</span><br><span class="line">				log.Println(<span class="string">&quot;sendFile2 start:&quot;</span>, start, <span class="string">&quot;end:&quot;</span>, end, <span class="string">&quot;size:&quot;</span>, info.Size())</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">			writer.Header().Add(<span class="string">&quot;Content-Length&quot;</span>, strconv.FormatInt(end-start+<span class="number">1</span>, <span class="number">10</span>))</span><br><span class="line">			writer.Header().Add(<span class="string">&quot;Content-Range&quot;</span>, fmt.Sprintf(<span class="string">&quot;bytes %v-%v/%v&quot;</span>, start, end, info.Size()))</span><br><span class="line">			writer.WriteHeader(http.StatusPartialContent)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			writer.WriteHeader(http.StatusBadRequest)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		writer.Header().Add(<span class="string">&quot;Content-Length&quot;</span>, strconv.FormatInt(info.Size(), <span class="number">10</span>))</span><br><span class="line">		start = <span class="number">0</span></span><br><span class="line">		end = info.Size() - <span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line">	_, err = f.Seek(start, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(<span class="string">&quot;sendFile3&quot;</span>, err.Error())</span><br><span class="line">		writer.WriteHeader(http.StatusInternalServerError)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	n := <span class="number">512</span></span><br><span class="line">	buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, n)</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> end-start+<span class="number">1</span> &lt; <span class="keyword">int64</span>(n) &#123;</span><br><span class="line">			n = <span class="keyword">int</span>(end - start + <span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		_, err := f.Read(buf[:n])</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(<span class="string">&quot;1:&quot;</span>, err)</span><br><span class="line">			<span class="keyword">if</span> err != io.EOF &#123;</span><br><span class="line">				log.Println(<span class="string">&quot;error:&quot;</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		err = <span class="literal">nil</span></span><br><span class="line">		_, err = writer.Write(buf[:n])</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="comment">//log.Println(err, start, end, info.Size(), n)</span></span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		start += <span class="keyword">int64</span>(n)</span><br><span class="line">		<span class="keyword">if</span> start &gt;= end+<span class="number">1</span> &#123;</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>待改进：如果在断点后再继续传输并且对象发生变化，那么会出现错误，所以要加上 <code>Last-Modified</code> 或者 <code>ETag</code> 来判断对象是否已经改变。</p>
<h2 id="基于-HTTP-的断点上传的服务端"><a href="#基于-HTTP-的断点上传的服务端" class="headerlink" title="基于 HTTP 的断点上传的服务端"></a>基于 HTTP 的断点上传的服务端</h2><h3 id="客户端让服务端初始化当前文件的分块信息接口"><a href="#客户端让服务端初始化当前文件的分块信息接口" class="headerlink" title="客户端让服务端初始化当前文件的分块信息接口"></a>客户端让服务端初始化当前文件的分块信息接口</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//客户端让服务端初始化当前文件的分块信息</span></span><br><span class="line">http.HandleFunc(<span class="string">&quot;/file/mpupload/init&quot;</span>, handler.HTTPInterceptor(handler.InitialMultipartUploadHandler))</span><br><span class="line"></span><br><span class="line"><span class="comment">// InitialMultipartUploadHandler : 初始化分块信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitialMultipartUploadHandler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">   <span class="comment">// 1. 解析用户请求参数</span></span><br><span class="line">   r.ParseForm()</span><br><span class="line">   username := r.Form.Get(<span class="string">&quot;username&quot;</span>)</span><br><span class="line">   filehash := r.Form.Get(<span class="string">&quot;filehash&quot;</span>)</span><br><span class="line">   filesize, err := strconv.Atoi(r.Form.Get(<span class="string">&quot;filesize&quot;</span>))</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      w.Write(util.NewRespMsg(<span class="number">-1</span>, <span class="string">&quot;params invalid&quot;</span>, <span class="literal">nil</span>).JSONBytes())</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 2. 获得redis的一个连接</span></span><br><span class="line">   rConn := rPool.RedisPool().Get()</span><br><span class="line">   <span class="keyword">defer</span> rConn.Close()</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 3. 生成分块上传的初始化信息</span></span><br><span class="line">   upInfo := MultipartUploadInfo&#123;</span><br><span class="line">      FileHash:   filehash, <span class="comment">//文件哈希值</span></span><br><span class="line">      FileSize:   filesize, <span class="comment">//文件总代销</span></span><br><span class="line">      UploadID:   username + fmt.Sprintf(<span class="string">&quot;%x&quot;</span>, time.Now().UnixNano()), <span class="comment">//生成一个上传ID</span></span><br><span class="line">      ChunkSize:  <span class="number">5</span> * <span class="number">1024</span> * <span class="number">1024</span>, <span class="comment">// 5MB</span></span><br><span class="line">      ChunkCount: <span class="keyword">int</span>(math.Ceil(<span class="keyword">float64</span>(filesize) / (<span class="number">5</span> * <span class="number">1024</span> * <span class="number">1024</span>))), <span class="comment">//块数</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 4. 将初始化信息写入到redis缓存</span></span><br><span class="line">   rConn.Do(<span class="string">&quot;HSET&quot;</span>, <span class="string">&quot;MP_&quot;</span>+upInfo.UploadID, <span class="string">&quot;chunkcount&quot;</span>, upInfo.ChunkCount)</span><br><span class="line">   rConn.Do(<span class="string">&quot;HSET&quot;</span>, <span class="string">&quot;MP_&quot;</span>+upInfo.UploadID, <span class="string">&quot;filehash&quot;</span>, upInfo.FileHash)</span><br><span class="line">   rConn.Do(<span class="string">&quot;HSET&quot;</span>, <span class="string">&quot;MP_&quot;</span>+upInfo.UploadID, <span class="string">&quot;filesize&quot;</span>, upInfo.FileSize)</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 5. 将响应初始化数据返回到客户端</span></span><br><span class="line">   w.Write(util.NewRespMsg(<span class="number">0</span>, <span class="string">&quot;OK&quot;</span>, upInfo).JSONBytes())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="上传文件分块接口实现"><a href="#上传文件分块接口实现" class="headerlink" title="上传文件分块接口实现"></a>上传文件分块接口实现</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UploadPartHandler : 上传文件分块</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UploadPartHandler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">   <span class="comment">// 1. 解析用户请求参数</span></span><br><span class="line">   r.ParseForm()</span><br><span class="line">   <span class="comment">// username := r.Form.Get(&quot;username&quot;)</span></span><br><span class="line">   uploadID := r.Form.Get(<span class="string">&quot;uploadid&quot;</span>)</span><br><span class="line">   chunkIndex := r.Form.Get(<span class="string">&quot;index&quot;</span>) <span class="comment">//分块编号</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// 2. 获得redis连接池中的一个连接</span></span><br><span class="line">   rConn := rPool.RedisPool().Get()</span><br><span class="line">   <span class="keyword">defer</span> rConn.Close()</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 3. 获得文件句柄，用于存储分块内容</span></span><br><span class="line">   fpath := <span class="string">&quot;/data/&quot;</span> + uploadID + <span class="string">&quot;/&quot;</span> + chunkIndex</span><br><span class="line">   os.MkdirAll(path.Dir(fpath), <span class="number">0744</span>)</span><br><span class="line">   fd, err := os.Create(fpath)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      w.Write(util.NewRespMsg(<span class="number">-1</span>, <span class="string">&quot;Upload part failed&quot;</span>, <span class="literal">nil</span>).JSONBytes())</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">defer</span> fd.Close()</span><br><span class="line"></span><br><span class="line">   buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">1024</span>*<span class="number">1024</span>)</span><br><span class="line">   <span class="keyword">for</span> &#123;</span><br><span class="line">      n, err := r.Body.Read(buf) <span class="comment">//把上传的文件流写入到server的本地分块文件句柄中</span></span><br><span class="line">      fd.Write(buf[:n])</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">         <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 4. 更新redis缓存状态，表示当前分块已上传完成</span></span><br><span class="line">   rConn.Do(<span class="string">&quot;HSET&quot;</span>, <span class="string">&quot;MP_&quot;</span>+uploadID, <span class="string">&quot;chkidx_&quot;</span>+chunkIndex, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 5. 返回处理结果到客户端</span></span><br><span class="line">   w.Write(util.NewRespMsg(<span class="number">0</span>, <span class="string">&quot;OK&quot;</span>, <span class="literal">nil</span>).JSONBytes())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="客户端通知服务端上传全部完成，服务端把分块合并成一个文件"><a href="#客户端通知服务端上传全部完成，服务端把分块合并成一个文件" class="headerlink" title="客户端通知服务端上传全部完成，服务端把分块合并成一个文件"></a>客户端通知服务端上传全部完成，服务端把分块合并成一个文件</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CompleteUploadHandler : 客户端通知服务端上传全部完成,服务端把分块合并成一个文件</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CompleteUploadHandler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">   <span class="comment">// 1. 解析请求参数</span></span><br><span class="line">   r.ParseForm()</span><br><span class="line">   upid := r.Form.Get(<span class="string">&quot;uploadid&quot;</span>)</span><br><span class="line">   username := r.Form.Get(<span class="string">&quot;username&quot;</span>)</span><br><span class="line">   filehash := r.Form.Get(<span class="string">&quot;filehash&quot;</span>)</span><br><span class="line">   filesize := r.Form.Get(<span class="string">&quot;filesize&quot;</span>)</span><br><span class="line">   filename := r.Form.Get(<span class="string">&quot;filename&quot;</span>)</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 2. 获得redis连接池中的一个连接</span></span><br><span class="line">   rConn := rPool.RedisPool().Get()</span><br><span class="line">   <span class="keyword">defer</span> rConn.Close()</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 3. 通过uploadid查询redis并判断是否所有分块上传完成</span></span><br><span class="line">   data, err := redis.Values(rConn.Do(<span class="string">&quot;HGETALL&quot;</span>, <span class="string">&quot;MP_&quot;</span>+upid))</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      w.Write(util.NewRespMsg(<span class="number">-1</span>, <span class="string">&quot;complete upload failed&quot;</span>, <span class="literal">nil</span>).JSONBytes())</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line">   totalCount := <span class="number">0</span></span><br><span class="line">   chunkCount := <span class="number">0</span></span><br><span class="line">   <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(data); i += <span class="number">2</span> &#123;</span><br><span class="line">      k := <span class="keyword">string</span>(data[i].([]<span class="keyword">byte</span>))</span><br><span class="line">      v := <span class="keyword">string</span>(data[i+<span class="number">1</span>].([]<span class="keyword">byte</span>))</span><br><span class="line">      <span class="keyword">if</span> k == <span class="string">&quot;chunkcount&quot;</span> &#123;</span><br><span class="line">         totalCount, _ = strconv.Atoi(v)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> strings.HasPrefix(k, <span class="string">&quot;chkidx_&quot;</span>) &amp;&amp; v == <span class="string">&quot;1&quot;</span> &#123;</span><br><span class="line">         chunkCount++</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> totalCount != chunkCount &#123;</span><br><span class="line">      w.Write(util.NewRespMsg(<span class="number">-2</span>, <span class="string">&quot;invalid request&quot;</span>, <span class="literal">nil</span>).JSONBytes())</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 4. TODO：合并分块</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// 5. 更新唯一文件表及用户文件表</span></span><br><span class="line">   fsize, _ := strconv.Atoi(filesize)</span><br><span class="line">   dblayer.OnFileUploadFinished(filehash, filename, <span class="keyword">int64</span>(fsize), <span class="string">&quot;&quot;</span>)</span><br><span class="line">   dblayer.OnUserFileUploadFinished(username, filehash, filename, <span class="keyword">int64</span>(fsize))</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 6. 响应处理结果</span></span><br><span class="line">   w.Write(util.NewRespMsg(<span class="number">0</span>, <span class="string">&quot;OK&quot;</span>, <span class="literal">nil</span>).JSONBytes())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="基于自定义协议的简易文件断点续传"><a href="#基于自定义协议的简易文件断点续传" class="headerlink" title="基于自定义协议的简易文件断点续传"></a>基于自定义协议的简易文件断点续传</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// client</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;io&quot;</span></span><br><span class="line">    <span class="string">&quot;net&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    <span class="string">&quot;strconv&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">clientRead</span><span class="params">(conn net.Conn)</span> <span class="title">int</span></span>&#123;</span><br><span class="line">    buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">10</span>)</span><br><span class="line">    n, err := conn.Read(buf)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;conn.Read err:&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    off, err := strconv.Atoi(<span class="keyword">string</span>(buf[:n]))</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;strconv.Atoi err:&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> off</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//发送数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">clientWrite</span><span class="params">(conn net.Conn, data []<span class="keyword">byte</span>)</span></span>&#123;</span><br><span class="line">    _, err := conn.Write(data)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;conn.Write err:&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(<span class="string">&quot;写入数据:&quot;</span>, <span class="keyword">string</span>(data))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">clientConn</span><span class="params">(conn net.Conn)</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> conn.Close()</span><br><span class="line">    clientWrite(conn, []<span class="keyword">byte</span>(<span class="string">&quot;start--&gt;&quot;</span>))</span><br><span class="line">    off := clientRead(conn)</span><br><span class="line">    fp, err := os.OpenFile(<span class="string">&quot;file.txt&quot;</span>, os.O_RDONLY, <span class="number">0777</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;os.OpenFile err:&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> fp.Close()</span><br><span class="line"></span><br><span class="line">    _, err = fp.Seek(<span class="keyword">int64</span>(off), <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;Seek err:&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>&#123;</span><br><span class="line">        data := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">10</span>)</span><br><span class="line">        n, err := fp.Read(data)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> err == io.EOF&#123;</span><br><span class="line">                time.Sleep(time.Second)</span><br><span class="line">                <span class="comment">//clientWrite(conn, []byte(&quot;&lt;--end&quot;))</span></span><br><span class="line">                fmt.Println(<span class="string">&quot;文件发送结束！&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//time.Sleep(time.Second)</span></span><br><span class="line">        clientWrite(conn, data[:n])</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    conn, err := net.DialTimeout(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;127.0.0.1:8848&quot;</span>, time.Second*<span class="number">10</span>)</span><br><span class="line">    <span class="comment">//conn, err := net.Dial(&quot;tcp&quot;, &quot;127.0.0.1:8848&quot;)</span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;Dial err:&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    clientConn(conn)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;io&quot;</span></span><br><span class="line">	<span class="string">&quot;net&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;strconv&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//追加</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WriteFile</span><span class="params">(content []<span class="keyword">byte</span>)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(content) &gt; <span class="number">0</span>&#123;</span><br><span class="line">		fp, err := os.OpenFile(<span class="string">&quot;file_out.txt&quot;</span>, os.O_CREATE|os.O_WRONLY|os.O_APPEND, <span class="number">0777</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(<span class="string">&quot;OpenFile err:&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">defer</span> fp.Close()</span><br><span class="line">		_, err = fp.Write(content)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(<span class="string">&quot;fp.Write err:&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Println(<span class="string">&quot;fp.Write ok&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//判断文件是否存在</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getFileState</span><span class="params">()</span> <span class="title">int64</span></span>&#123;</span><br><span class="line">	stat, err := os.Stat(<span class="string">&quot;file_out.txt&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> os.IsNotExist(err)&#123;</span><br><span class="line">			fmt.Println(<span class="string">&quot;文件不存在&quot;</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> stat.Size()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">serverConn</span><span class="params">(conn net.Conn)</span></span>&#123;</span><br><span class="line">	<span class="keyword">defer</span> conn.Close()</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">var</span> buf = <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">10</span>)</span><br><span class="line">		n, err := conn.Read(buf)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err == io.EOF&#123;</span><br><span class="line">				fmt.Println(<span class="string">&quot;server is EOF&quot;</span>)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">			fmt.Println(<span class="string">&quot;conn.read err:&quot;</span>, err)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		fmt.Println(<span class="string">&quot;收到数据：&quot;</span>, <span class="keyword">string</span>(buf[:n]))</span><br><span class="line">		<span class="keyword">switch</span> <span class="keyword">string</span>(buf[:n]) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;start--&gt;&quot;</span>:</span><br><span class="line">			off := getFileState()</span><br><span class="line">			stroff := strconv.FormatInt(off, <span class="number">10</span>)</span><br><span class="line">			_, err := conn.Write([]<span class="keyword">byte</span>(stroff))</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				fmt.Println(<span class="string">&quot;conn.Write err:&quot;</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">			<span class="comment">//case &quot;&lt;--end&quot;:</span></span><br><span class="line">			<span class="comment">//    fmt.Println(&quot;文件写入完毕！&quot;)</span></span><br><span class="line">			<span class="comment">//    return</span></span><br><span class="line">		&#125;</span><br><span class="line">		WriteFile(buf[:n])</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	listen, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;127.0.0.1:8848&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;net.Listen err:&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">&quot;正在监听...&quot;</span>)</span><br><span class="line">	<span class="keyword">defer</span> listen.Close()</span><br><span class="line">	conn, err := listen.Accept()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;Accept err:&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	serverConn(conn)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果需要更加严谨一些的话，可以让 server 传递文件的 md5 给 client，让 client 合并之后进行校验。</p>
<h1 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h1><ul>
<li><a target="_blank" rel="noopener" href="https://jasonkayzk.github.io/2020/09/28/Go%E5%AE%9E%E7%8E%B0HTTP%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8B%E8%BD%BD/">Go 实现 HTTP 断点续传多线程下载</a></li>
<li><a target="_blank" rel="noopener" href="https://mojotv.cn/go/go-range-download">HTTP 断点续传多线程下载原理</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000039990513">Go 语言实现文件的断点续传</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/peteremperor/p/14081050.html">Golang 断点续传</a></li>
<li><a target="_blank" rel="noopener" href="http://zz666zz.com/article/info/22601">go 分布式存储系统 基于 Redis 实现分块上传和断点上传</a></li>
</ul>
</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>