<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;一切皆文件&quot;&gt;&lt;a href=&quot;#一切皆文件&quot; class=&quot;headerlink&quot; title=&quot;一切皆文件&quot;&gt;&lt;/a&gt;一切皆文件&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;在 linux 中，一切皆为文件，所有不同种类的类型都被抽象成文件。如：普通文件、目录、字符设备、块设备、套接字等&lt;/li&gt;
&lt;li&gt;当一个文件被进程打开，就会创建一个文件描述符。这时候，文件的路径就成为了寻址系统，&lt;strong&gt;文件描述符成为了字节流的接口&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;相对于普通文件这类真实存在于文件系统中的文件，tcp socket、unix domain socket 等这些存在于内存中的特殊文件在被进程打开的时候，也会创建文件描述符。所以 “一切皆文件” 更准确的描述应该是 “一切皆文件描述符”&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;文件描述符概述&quot;&gt;&lt;a href=&quot;#文件描述符概述&quot; class=&quot;headerlink&quot; title=&quot;文件描述符概述&quot;&gt;&lt;/a&gt;文件描述符概述&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;在Linux系统中一切皆可以看成是文件，文件又可分为：&lt;code&gt;普通文件&lt;/code&gt;、&lt;code&gt;目录文件&lt;/code&gt;、&lt;code&gt;链接文件&lt;/code&gt;和&lt;code&gt;设备文件&lt;/code&gt;。&lt;/li&gt;
&lt;li&gt;文件描述符（file descriptor）是内核为了高效管理&lt;strong&gt;已被打开的文件&lt;/strong&gt;所创建的索引，其是一个非负整数（通常是小整数），用于&lt;strong&gt;指代被打开的文件&lt;/strong&gt;，&lt;/li&gt;
&lt;li&gt;所有执行I/O操作的系统调用都通过文件描述符。&lt;/li&gt;
&lt;li&gt;程序刚刚启动的时候，0是标准输入，1是标准输出，2是标准错误。如果此时去打开一个新的文件，它的文件描述符会是3。&lt;strong&gt;POSIX标准要求每次打开文件时（含socket）必须使用当前进程中最小可用的文件描述符号码，因此，在网络通信过程中稍不注意就有可能造成串话&lt;/strong&gt;。&lt;/li&gt;
&lt;/ul&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;文件描述符&lt;/th&gt;
&lt;th&gt;用途&lt;/th&gt;
&lt;th&gt;POSIX名称&lt;/th&gt;
&lt;th&gt;stdio流&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td&gt;0&lt;/td&gt;
&lt;td&gt;标准输入&lt;/td&gt;
&lt;td&gt;STDIN_FILENO&lt;/td&gt;
&lt;td&gt;stdin&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;标准输出&lt;/td&gt;
&lt;td&gt;STDONT_FILENO&lt;/td&gt;
&lt;td&gt;stdout&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;标准错误&lt;/td&gt;
&lt;td&gt;STDERR_FILENO&lt;/td&gt;
&lt;td&gt;stderr&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;p&gt;即："><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>文件描述符 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Linux/" rel="tag">Linux</a></div><div class="post-time">2022-05-25</div></div></div><div class="container post-header"><h1>文件描述符</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E5%88%87%E7%9A%86%E6%96%87%E4%BB%B6"><span class="toc-number">1.</span> <span class="toc-text">一切皆文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E6%A6%82%E8%BF%B0"><span class="toc-number">2.</span> <span class="toc-text">文件描述符概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E4%B8%8E%E6%89%93%E5%BC%80%E7%9A%84%E6%96%87%E4%BB%B6%E5%AF%B9%E5%BA%94%E6%A8%A1%E5%9E%8B"><span class="toc-number">2.1.</span> <span class="toc-text">文件描述与打开的文件对应模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E5%90%88%E6%89%93%E5%BC%80%E6%96%87%E4%BB%B6%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">2.2.</span> <span class="toc-text">文件描述符合打开文件之间的关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E3%80%81%E6%89%93%E5%BC%80%E7%9A%84%E6%96%87%E4%BB%B6%E5%8F%A5%E6%9F%84%E4%BB%A5%E5%8F%8Ai-node%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">2.3.</span> <span class="toc-text">文件描述符、打开的文件句柄以及i-node之间的关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E-python-%E6%84%9F%E7%9F%A5-fd"><span class="toc-number">2.4.</span> <span class="toc-text">从 python 感知 fd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">2.5.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Unix-domain-socket-%E6%8F%8F%E8%BF%B0%E7%AC%A6"><span class="toc-number">3.</span> <span class="toc-text">Unix domain socket 描述符</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C-server-py"><span class="toc-number">3.1.</span> <span class="toc-text">运行 server.py</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C-client-py"><span class="toc-number">3.2.</span> <span class="toc-text">运行 client.py</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#server-py-%E5%8F%91%E7%94%9F%E7%9A%84%E5%8F%98%E5%8C%96"><span class="toc-number">3.3.</span> <span class="toc-text">server.py 发生的变化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tmp-server-sock-%E5%88%B0%E5%BA%95%E4%BD%9C%E7%94%A8%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">3.4.</span> <span class="toc-text">&#x2F;tmp&#x2F;server.sock 到底作用是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#server-%E4%B8%8E-client-%E6%98%AF%E6%80%8E%E4%B9%88%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E9%80%9A%E4%BF%A1%E7%9A%84"><span class="toc-number">3.5.</span> <span class="toc-text">server 与 client 是怎么进行数据通信的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">3.6.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tcp-socket-%E6%8F%8F%E8%BF%B0%E7%AC%A6"><span class="toc-number">4.</span> <span class="toc-text">tcp socket 描述符</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-1"><span class="toc-number">4.1.</span> <span class="toc-text">小结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#reference"><span class="toc-number"></span> <span class="toc-text">reference</span></a></details></div><div class="container post-content"><h2 id="一切皆文件"><a href="#一切皆文件" class="headerlink" title="一切皆文件"></a>一切皆文件</h2><ol>
<li>在 linux 中，一切皆为文件，所有不同种类的类型都被抽象成文件。如：普通文件、目录、字符设备、块设备、套接字等</li>
<li>当一个文件被进程打开，就会创建一个文件描述符。这时候，文件的路径就成为了寻址系统，<strong>文件描述符成为了字节流的接口</strong></li>
<li>相对于普通文件这类真实存在于文件系统中的文件，tcp socket、unix domain socket 等这些存在于内存中的特殊文件在被进程打开的时候，也会创建文件描述符。所以 “一切皆文件” 更准确的描述应该是 “一切皆文件描述符”</li>
</ol>
<h2 id="文件描述符概述"><a href="#文件描述符概述" class="headerlink" title="文件描述符概述"></a>文件描述符概述</h2><ul>
<li>在Linux系统中一切皆可以看成是文件，文件又可分为：<code>普通文件</code>、<code>目录文件</code>、<code>链接文件</code>和<code>设备文件</code>。</li>
<li>文件描述符（file descriptor）是内核为了高效管理<strong>已被打开的文件</strong>所创建的索引，其是一个非负整数（通常是小整数），用于<strong>指代被打开的文件</strong>，</li>
<li>所有执行I/O操作的系统调用都通过文件描述符。</li>
<li>程序刚刚启动的时候，0是标准输入，1是标准输出，2是标准错误。如果此时去打开一个新的文件，它的文件描述符会是3。<strong>POSIX标准要求每次打开文件时（含socket）必须使用当前进程中最小可用的文件描述符号码，因此，在网络通信过程中稍不注意就有可能造成串话</strong>。</li>
</ul>
<table>
<thead>
<tr>
<th>文件描述符</th>
<th>用途</th>
<th>POSIX名称</th>
<th>stdio流</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>标准输入</td>
<td>STDIN_FILENO</td>
<td>stdin</td>
</tr>
<tr>
<td>1</td>
<td>标准输出</td>
<td>STDONT_FILENO</td>
<td>stdout</td>
</tr>
<tr>
<td>2</td>
<td>标准错误</td>
<td>STDERR_FILENO</td>
<td>stderr</td>
</tr>
</tbody></table>
<p>即：</p>
<ul>
<li><strong>文件描述符是一个抽象索引，它指向普通的文件或者 I/O 设备</strong>。</li>
<li>文件描述符是一个非负整数，它是连接用户空间和内核空间纽带。</li>
</ul>
<p><img src="/images/1416773-20181114140900090-673022445.png" alt="img"></p>
<h3 id="文件描述与打开的文件对应模型"><a href="#文件描述与打开的文件对应模型" class="headerlink" title="文件描述与打开的文件对应模型"></a>文件描述与打开的文件对应模型</h3><p><img src="/images/20140831225117905.png" alt="img"></p>
<h3 id="文件描述符合打开文件之间的关系"><a href="#文件描述符合打开文件之间的关系" class="headerlink" title="文件描述符合打开文件之间的关系"></a>文件描述符合打开文件之间的关系</h3><ul>
<li><strong>每一个文件描述符会与一个打开文件相对应，同时，不同的文件描述符也会指向同一个文件</strong>。相同的文件可以被不同的进程打开也可以在同一个进程中被多次打开。</li>
<li><strong>系统</strong>为每一个进程维护了一个文件描述符表，该表的值都是从0开始的，所以在不同的进程中你会看到相同的文件描述符，这种情况下相同文件描述符有可能指向同一个文件，也有可能指向不同的文件。具体情况要具体分析，要理解具体其概况如何，需要查看由内核维护的3个数据结构。<ol>
<li>进程级的文件描述符表</li>
<li>系统级的打开文件描述符表</li>
<li>文件系统的i-node表</li>
</ol>
</li>
</ul>
<p>进程级的描述符表的每一条目记录了单个文件描述符的相关信息。</p>
<ol>
<li>控制文件描述符操作的一组标志。（目前，此类标志仅定义了一个，即close-on-exec标志）</li>
<li>对打开文件句柄的引用</li>
</ol>
<p>内核对所有打开的文件的文件维护有一个系统级的<code>描述符表格</code>（open file description table）。有时，也称之为打开文件表（open file table），并将表格中各条目称为打开文件句柄（open file handle）。</p>
<p>一个打开文件句柄存储了与一个打开文件相关的全部信息，如下所示：</p>
<ol>
<li><p>当前文件偏移量（调用read()和write()时更新，或使用lseek()直接修改）</p>
</li>
<li><p>打开文件时所使用的状态标识（即，open()的flags参数）</p>
</li>
<li><p>文件访问模式（如调用open()时所设置的只读模式、只写模式或读写模式）</p>
</li>
<li><p>与信号驱动相关的设置</p>
</li>
<li><p>对该文件i-node对象的引用</p>
</li>
<li><p>文件类型（例如：常规文件、套接字或FIFO）和访问权限</p>
</li>
<li><p>一个指针，指向该文件所持有的锁列表</p>
</li>
<li><p>文件的各种属性，包括文件大小以及与不同类型操作相关的时间戳</p>
</li>
</ol>
<h3 id="文件描述符、打开的文件句柄以及i-node之间的关系"><a href="#文件描述符、打开的文件句柄以及i-node之间的关系" class="headerlink" title="文件描述符、打开的文件句柄以及i-node之间的关系"></a>文件描述符、打开的文件句柄以及i-node之间的关系</h3><p><img src="/images/20140831224917875.png" alt="img"></p>
<ul>
<li>图中，两个进程拥有诸多打开的文件描述符。</li>
<li>在进程A中，文件描述符1和30都指向了同一个打开的文件句柄（标号23）。这可能是通过调用dup()、dup2()、fcntl()或者对<strong>同一个文件多次调用了open()函数</strong>而形成的。</li>
<li>进程A的文件描述符2和进程B的文件描述符2都指向了同一个打开的文件句柄（标号73）。这种情形可能是在调用fork()后出现的（即，进程A、B是父子进程关系），或者当某进程通过UNIX域套接字将一个打开的文件描述符传递给另一个进程时，也会发生。再者是<strong>不同的进程独自去调用open函数打开了同一个文件</strong>，此时进程内部的描述符正好分配到与其他进程打开该文件的描述符一样。</li>
<li>此外，进程A的描述符0和进程B的描述符3分别指向不同的打开文件句柄，但这些句柄均指向i-node表的相同条目（1976），换言之，指向同一个文件。发生这种情况是因为<strong>每个进程各自对同一个文件发起了open()调用</strong>。同一个进程两次打开同一个文件，也会发生类似情况。</li>
</ul>
<h3 id="从-python-感知-fd"><a href="#从-python-感知-fd" class="headerlink" title="从 python 感知 fd"></a>从 python 感知 fd</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import os</span><br><span class="line">&gt;&gt;&gt; fd = os.open(&quot;/Users/heyingliang/myTemp/api.json&quot;,os.O_RDONLY)</span><br><span class="line">&gt;&gt;&gt; fd</span><br><span class="line">3</span><br><span class="line">&gt;&gt;&gt; fd2 = os.open(&quot;/Users/heyingliang/myTemp/ones-wechat-api.log&quot;,os.O_RDONLY)</span><br><span class="line">&gt;&gt;&gt; fd2</span><br><span class="line">4</span><br><span class="line">&gt;&gt;&gt; fd3 = os.open(&quot;/Users/heyingliang/myTemp/response222.png&quot;,os.O_RDONLY)</span><br><span class="line">&gt;&gt;&gt; fd3</span><br><span class="line">5</span><br></pre></td></tr></table></figure>



<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ol>
<li>由于进程级文件描述符表的存在，不同的进程中会出现相同的文件描述符，它们可能指向同一个文件，也可能指向不同的文件</li>
<li>两个不同的文件描述符，若指向同一个打开文件句柄，将共享同一文件偏移量。因此，如果通过其中一个文件描述符来修改文件偏移量（由调用read()、write()或lseek()所致），那么从另一个描述符中也会观察到变化，无论这两个文件描述符是否属于不同进程，还是同一个进程，情况都是如此。</li>
<li>要获取和修改打开的文件标志（例如：O_APPEND、O_NONBLOCK和O_ASYNC），可执行fcntl()的F_GETFL和F_SETFL操作，其对作用域的约束与上一条颇为类似。</li>
<li>文件描述符标志（即，close-on-exec）为进程和文件描述符所私有。对这一标志的修改将不会影响同一进程或不同进程中的其他文件描述符</li>
</ol>
<h2 id="Unix-domain-socket-描述符"><a href="#Unix-domain-socket-描述符" class="headerlink" title="Unix domain socket 描述符"></a>Unix domain socket 描述符</h2><ul>
<li>Unix domain socket 描述符主要用于：<strong>运行在同一台机器上的 2 个进程相互之间的数据通信</strong></li>
<li>Unix domain socket 描述符和网络文件描述符非常相似（比如：TCP socket），他们的通信发生在操作系统内核</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># server.py</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">server_addr = <span class="string">&#x27;/tmp/server.sock&#x27;</span></span><br><span class="line"></span><br><span class="line">sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)</span><br><span class="line">sock.bind(server_addr)</span><br><span class="line">sock.listen(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    conn, clientAddr = sock.accept()</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = conn.recv(<span class="number">100</span>)</span><br><span class="line">        conn.sendall(data)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># client.py</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">server_addr = <span class="string">&#x27;/tmp/server.sock&#x27;</span></span><br><span class="line"></span><br><span class="line">sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)</span><br><span class="line">sock.connect(server_addr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    message = <span class="string">&#x27;hello world!&#x27;</span></span><br><span class="line">    sock.sendall(message)</span><br><span class="line">    sock.recv(<span class="number">100</span>)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">sock.close()</span><br></pre></td></tr></table></figure>



<h3 id="运行-server-py"><a href="#运行-server-py" class="headerlink" title="运行 server.py"></a>运行 server.py</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># python /tmp/server.py &amp;d</span></span><br><span class="line">[1] 2554</span><br><span class="line">[root@localhost ~]<span class="comment"># ls -l /proc/2554/fd</span></span><br><span class="line">total 0</span><br><span class="line">lrwx------ 1 root root 64 Nov  5 02:39 0 -&gt; /dev/pts/0</span><br><span class="line">lrwx------ 1 root root 64 Nov  5 02:39 1 -&gt; /dev/pts/0</span><br><span class="line">lrwx------ 1 root root 64 Nov  5 02:39 2 -&gt; /dev/pts/0</span><br><span class="line">lrwx------ 1 root root 64 Nov  5 02:39 3 -&gt; socket:[28724]</span><br><span class="line">[root@localhost ~]<span class="comment"># grep 28724 /proc/net/unix</span></span><br><span class="line">ffff90d8ba564000: 00000002 00000000 00010000 0001 01 28724 /tmp/server.sock</span><br><span class="line">[root@localhost ~]<span class="comment"># lsof -n | grep 28724</span></span><br><span class="line">python    2554         root    3u     unix 0xffff90d8ba564000       0t0      28724 /tmp/server.sock</span><br><span class="line">[root@localhost ~]<span class="comment"># netstat -anp | grep 28724</span></span><br><span class="line">unix  2      [ ACC ]     STREAM     LISTENING     28724    2554/python         /tmp/server.sock</span><br></pre></td></tr></table></figure>

<p><strong>进程 2554 创建了打开了 unix domain socket 描述符（<code>3 -&gt; socket:[28724]</code>），并且通过该描述符，打开了 /tmp/server.sock 文件，其主要作用是用于监听该文件</strong>。</p>
<h3 id="运行-client-py"><a href="#运行-client-py" class="headerlink" title="运行 client.py"></a>运行 client.py</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># python /tmp/client.py &amp;</span></span><br><span class="line">[2] 2555</span><br><span class="line">[root@localhost ~]<span class="comment"># ls -l /proc/2555/fd</span></span><br><span class="line">total 0</span><br><span class="line">lrwx------ 1 root root 64 Nov  5 02:39 0 -&gt; /dev/pts/0</span><br><span class="line">lrwx------ 1 root root 64 Nov  5 02:39 1 -&gt; /dev/pts/0</span><br><span class="line">lrwx------ 1 root root 64 Nov  5 02:39 2 -&gt; /dev/pts/0</span><br><span class="line">lrwx------ 1 root root 64 Nov  5 02:39 3 -&gt; socket:[28728]</span><br><span class="line">[root@localhost ~]<span class="comment"># grep 28728 /proc/net/unix</span></span><br><span class="line">ffff90d8b95b0400: 00000003 00000000 00000000 0001 03 28728</span><br><span class="line">[root@localhost ~]<span class="comment"># lsof -n | grep 28728</span></span><br><span class="line">python    2555         root    3u     unix 0xffff90d8b95b0400       0t0      28728 socket</span><br></pre></td></tr></table></figure>

<p><strong>client.py 创建了 unix domain socket 描述符 <code>3 -&gt; socket:[28728]</code>，通过 <code>socket:[28728]</code>，找到一条 socket</strong>。</p>
<h3 id="server-py-发生的变化"><a href="#server-py-发生的变化" class="headerlink" title="server.py 发生的变化"></a>server.py 发生的变化</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ls -l /proc/<span class="number">2554</span>/fd</span><br><span class="line">total <span class="number">0</span></span><br><span class="line">lrwx------ <span class="number">1</span> root root <span class="number">64</span> Nov  <span class="number">5</span> <span class="number">02</span>:<span class="number">39</span> <span class="number">0</span> -&gt; /dev/pts/<span class="number">0</span></span><br><span class="line">lrwx------ <span class="number">1</span> root root <span class="number">64</span> Nov  <span class="number">5</span> <span class="number">02</span>:<span class="number">39</span> <span class="number">1</span> -&gt; /dev/pts/<span class="number">0</span></span><br><span class="line">lrwx------ <span class="number">1</span> root root <span class="number">64</span> Nov  <span class="number">5</span> <span class="number">02</span>:<span class="number">39</span> <span class="number">2</span> -&gt; /dev/pts/<span class="number">0</span></span><br><span class="line">lrwx------ <span class="number">1</span> root root <span class="number">64</span> Nov  <span class="number">5</span> <span class="number">02</span>:<span class="number">39</span> <span class="number">3</span> -&gt; socket:[<span class="number">28724</span>]</span><br><span class="line">lrwx------ <span class="number">1</span> root root <span class="number">64</span> Nov  <span class="number">5</span> <span class="number">02</span>:<span class="number">39</span> <span class="number">4</span> -&gt; socket:[<span class="number">28725</span>]</span><br></pre></td></tr></table></figure>

<p>server.py 新增了一个 <code>4 -&gt; socket:[28725]</code>，这是刚才 client.py 连接成功之后 server.py 新打开的描述符</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">root@localhost ~</span>]<span class="meta"># lsof -n | grep -E &#x27;28728|28724|28725&#x27;</span></span><br><span class="line">python    <span class="number">2554</span>         root    <span class="number">3u</span>     unix <span class="number">0xffff90d8ba564000</span>       <span class="number">0</span>t0      <span class="number">28724</span> /tmp/server.sock</span><br><span class="line">python    <span class="number">2554</span>         root    <span class="number">4u</span>     unix <span class="number">0xffff90d8b95b0000</span>       <span class="number">0</span>t0      <span class="number">28725</span> /tmp/server.sock</span><br><span class="line">python    <span class="number">2555</span>         root    <span class="number">3u</span>     unix <span class="number">0xffff90d8b95b0400</span>       <span class="number">0</span>t0      <span class="number">28728</span> socket</span><br><span class="line">[<span class="meta">root@localhost ~</span>]<span class="meta"># netstat -anp | grep unix | grep -E &#x27;28728|28724|28725&#x27;</span></span><br><span class="line">unix  <span class="number">2</span>      [ ACC ]     STREAM     LISTENING     <span class="number">28724</span>    <span class="number">2554</span>/python          /tmp/server.sock</span><br><span class="line">unix  <span class="number">3</span>      [ ]         STREAM     CONNECTED     <span class="number">28725</span>    <span class="number">2554</span>/python          /tmp/server.sock</span><br><span class="line">unix  <span class="number">3</span>      [ ]         STREAM     CONNECTED     <span class="number">28728</span>    <span class="number">2555</span>/python</span><br></pre></td></tr></table></figure>

<p>到目前为止，整个 unix domain socket 的通信过程已经比较清晰的展现了：</p>
<ul>
<li>server.py 启动之后，打开监听的描述符，等待来自客户端的连接请求</li>
<li>client.py 启动之后，与 server 连接成功，打开一个描述符用于与 server.py 通信</li>
<li>server.py 会再打开一个描述符用于与 client.py 进行数据通信</li>
</ul>
<h3 id="tmp-server-sock-到底作用是什么"><a href="#tmp-server-sock-到底作用是什么" class="headerlink" title="/tmp/server.sock 到底作用是什么"></a>/tmp/server.sock 到底作用是什么</h3><p>/tmp/server.sock 是操作系统的实体文件，拥有一个全局的文件系统描述符，这个描述符在操作系统中是唯一的。</p>
<p>server.py 启动时打开了 server.sock，声明了与 server.py 建立连接就只能通过 server.sock 文件。这就相当于 TCP socket 中四元组中的两元（<code>server_ip:server_port</code>）</p>
<h3 id="server-与-client-是怎么进行数据通信的"><a href="#server-与-client-是怎么进行数据通信的" class="headerlink" title="server 与 client 是怎么进行数据通信的"></a>server 与 client 是怎么进行数据通信的</h3><p>我们来使用 strace 命令看看 server.py 的内核调用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost tmp]<span class="meta"># strace -p 2554</span></span><br><span class="line">strace: Process <span class="number">2554</span> <span class="function">attached</span></span><br><span class="line"><span class="function"><span class="title">recvfrom</span><span class="params">(<span class="number">4</span>, <span class="string">&quot;hello world!&quot;</span>, <span class="number">100</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>)</span> </span>= <span class="number">12</span></span><br><span class="line"><span class="built_in">sendto</span>(<span class="number">4</span>, <span class="string">&quot;hello world!&quot;</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>) = <span class="number">12</span></span><br><span class="line"><span class="built_in">recvfrom</span>(<span class="number">4</span>, <span class="string">&quot;hello world!&quot;</span>, <span class="number">100</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>) = <span class="number">12</span></span><br><span class="line"><span class="built_in">sendto</span>(<span class="number">4</span>, <span class="string">&quot;hello world!&quot;</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>) = <span class="number">12</span></span><br></pre></td></tr></table></figure>

<p>server.py 在接收客户端数据的时候，使用了 <code>4 -&gt; socket:[28725]</code> 这个文件描述符</p>
<p>再看 client.py 的内核调用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost tmp]<span class="meta"># strace -p 2555</span></span><br><span class="line">strace: Process <span class="number">2555</span> <span class="function">attached</span></span><br><span class="line"><span class="function"><span class="title">select</span><span class="params">(<span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &#123;<span class="number">0</span>, <span class="number">996991</span>&#125;)</span> </span>= <span class="number">0</span> (Timeout)</span><br><span class="line"><span class="built_in">sendto</span>(<span class="number">3</span>, <span class="string">&quot;hello world!&quot;</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>) = <span class="number">12</span></span><br><span class="line"><span class="built_in">recvfrom</span>(<span class="number">3</span>, <span class="string">&quot;hello world!&quot;</span>, <span class="number">100</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>) = <span class="number">12</span></span><br><span class="line"><span class="built_in">select</span>(<span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &#123;<span class="number">1</span>, <span class="number">0</span>&#125;)     = <span class="number">0</span> (Timeout)</span><br><span class="line"><span class="built_in">sendto</span>(<span class="number">3</span>, <span class="string">&quot;hello world!&quot;</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>) = <span class="number">12</span></span><br></pre></td></tr></table></figure>

<p>client.py 在与 server.py 通信的时候使用了 <code>3 -&gt; socket:[28728]</code></p>
<p>结论：</p>
<ol>
<li>server.py 与 client.py 连接建立成功之后，都会各自在自己的进程下打开 unix domain socket 描述符，该描述符来指向对应的 socket 内存空间（下面简称 <code>s_mem</code>）</li>
<li>client.py 通过 <code>3 -&gt; socket:[28728]</code>，找到 <code>s_mem</code>，然后写入数据 <code>hello world!</code></li>
<li>server.py 通过 <code>4 -&gt; socket:[28725]</code>，找到 <code>s_mem</code>，读取数据 <code>hello world!</code>，并且原封不动的发送这串数据给 client.py</li>
<li>client.py 通过读取 <code>s_mem</code>，获取从 server.py 传来的数据</li>
<li>循环往复</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">           client.py                         server.py</span><br><span class="line">           +---------------+                 +---------------+</span><br><span class="line">           |pid:2555       |                 |pid:2554       |</span><br><span class="line">           |    +-----+    |                 |    +-----+    |</span><br><span class="line">           |    |fd:3 |    |                 |    |fd:4 |    |</span><br><span class="line">           |    +-----+    |                 |    +-----+    |</span><br><span class="line">           +---------------+                 +---------------+</span><br><span class="line">                   |                                 |</span><br><span class="line">user space         |                                 |</span><br><span class="line">+---------------------------------------------------------------------+</span><br><span class="line">kernel space       |                                 |</span><br><span class="line">                   |                                 |</span><br><span class="line">                   v                                 v</span><br><span class="line">            +--------------+                  +--------------+</span><br><span class="line">            |socket:[28728]|                  |socket:[28725]|</span><br><span class="line">            +------+-------+                  +------+-------+</span><br><span class="line">                   |                                 |</span><br><span class="line">                   |                                 |</span><br><span class="line">                   v                                 v</span><br><span class="line">                 +------------------------------------+</span><br><span class="line">                 |              socket                |</span><br><span class="line">                 +------------------------------------+</span><br></pre></td></tr></table></figure>



<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><ul>
<li>/tmp/server.sock 作为建立 unix domain socket 连接的唯一标识符</li>
<li>unix domain socket 连接建立完成之后在内存开辟一块空间，而 server 与 client 在这块内存空间中进行数据传输</li>
<li>在同一台机器上的进程通信，unix domain socket 比 tcp socket 更快，因为它不需要网络协议栈，不需要打包拆包、计算校验和、维护序号和应答等等过程</li>
</ul>
<h2 id="tcp-socket-描述符"><a href="#tcp-socket-描述符" class="headerlink" title="tcp socket 描述符"></a>tcp socket 描述符</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># server.py</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">server_addr = (<span class="string">&#x27;127.0.0.1&#x27;</span> , <span class="number">22222</span>)</span><br><span class="line">sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">sock.bind(server_addr)</span><br><span class="line">sock.listen(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    conn, clientAddr = sock.accept()</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = conn.recv(<span class="number">100</span>)</span><br><span class="line">        conn.sendall(data)</span><br><span class="line">        </span><br><span class="line">sock.close()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># client.py</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">server_addr = (<span class="string">&#x27;127.0.0.1&#x27;</span> , <span class="number">22222</span>)</span><br><span class="line"></span><br><span class="line">sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">sock.connect(server_addr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    message = <span class="string">&#x27;hello world!&#x27;</span></span><br><span class="line">    sock.send(message)</span><br><span class="line">    sock.recv(<span class="number">100</span>)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">sock.close()</span><br></pre></td></tr></table></figure>



<p>分别启动 server.py 与 client.py</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">root@localhost ~</span>]<span class="meta"># python /tmp/server.py  &amp;</span></span><br><span class="line">[<span class="meta">1</span>] <span class="number">14199</span></span><br><span class="line">[<span class="meta">root@localhost ~</span>]<span class="meta"># python /tmp/client.py  &amp;</span></span><br><span class="line">[<span class="meta">2</span>] <span class="number">14202</span></span><br></pre></td></tr></table></figure>

<p>查看 server.py 打开的文件描述符</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># ls -l /proc/14199/fd</span></span><br><span class="line">total <span class="number">0</span></span><br><span class="line">lrwx------ <span class="number">1</span> root root <span class="number">64</span> Nov  <span class="number">7</span> <span class="number">07</span>:<span class="number">42</span> <span class="number">0</span> -&gt; <span class="regexp">/dev/p</span>ts/<span class="number">0</span></span><br><span class="line">lrwx------ <span class="number">1</span> root root <span class="number">64</span> Nov  <span class="number">7</span> <span class="number">07</span>:<span class="number">42</span> <span class="number">1</span> -&gt; <span class="regexp">/dev/p</span>ts/<span class="number">0</span></span><br><span class="line">lrwx------ <span class="number">1</span> root root <span class="number">64</span> Nov  <span class="number">7</span> <span class="number">07</span>:<span class="number">42</span> <span class="number">2</span> -&gt; <span class="regexp">/dev/p</span>ts/<span class="number">0</span></span><br><span class="line">lrwx------ <span class="number">1</span> root root <span class="number">64</span> Nov  <span class="number">7</span> <span class="number">07</span>:<span class="number">42</span> <span class="number">3</span> -&gt; <span class="keyword">socket</span>:[<span class="number">99154</span>]</span><br><span class="line">lrwx------ <span class="number">1</span> root root <span class="number">64</span> Nov  <span class="number">7</span> <span class="number">07</span>:<span class="number">42</span> <span class="number">4</span> -&gt; <span class="keyword">socket</span>:[<span class="number">99155</span>]</span><br><span class="line">[root@localhost ~]<span class="comment"># lsof -n | grep -E &#x27;99154|99155&#x27;</span></span><br><span class="line">python    <span class="number">14199</span>         root    <span class="number">3</span>u     IPv4              <span class="number">99154</span>       0t<span class="number">0</span>        TCP <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">22222</span> (LISTEN)</span><br><span class="line">python    <span class="number">14199</span>         root    <span class="number">4</span>u     IPv4              <span class="number">99155</span>       0t<span class="number">0</span>        TCP <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">22222</span>-&gt;<span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">56946</span> (ESTABLISHED)</span><br></pre></td></tr></table></figure>

<p>我们主要关注 <code>ESTABLISHED</code> 状态的 socket 描述符，也就是 <code>4 -&gt; socket:[99155]</code></p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@localhost fd]</span># <span class="selector-tag">more</span> /<span class="selector-tag">proc</span>/<span class="selector-tag">net</span>/<span class="selector-tag">tcp</span></span><br><span class="line">  <span class="selector-tag">sl</span>  <span class="selector-tag">local_address</span> <span class="selector-tag">rem_address</span>   <span class="selector-tag">st</span> <span class="selector-tag">tx_queue</span> <span class="selector-tag">rx_queue</span> <span class="selector-tag">tr</span> <span class="selector-tag">tm-</span>&gt;<span class="keyword">when</span> retrnsmt   uid  timeout inode</span><br><span class="line">  ...</span><br><span class="line">   <span class="number">4</span>: <span class="number">0100007</span><span class="attribute">F</span>:<span class="number">56</span>CE <span class="number">0100007</span><span class="attribute">F</span>:DE72 <span class="number">01</span> <span class="number">00000000</span>:<span class="number">00000000</span> <span class="number">00</span>:<span class="number">00000000</span> <span class="number">00000000</span>     <span class="number">0</span>        <span class="number">0</span> <span class="number">99155</span> <span class="number">1</span> ffff90d8bb0145c0 <span class="number">20</span> <span class="number">4</span> <span class="number">31</span> <span class="number">10</span> -<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>进程打开了 tcp socket 描述符 <code>4 -&gt; socket:[99155]</code>，socket 描述符指向内存中的 socket 结构体，该结构体详细描述了这个 socket 的详细信息</p>
<p>最重要的是 TCP 四元组（<code>local_ip:local_port --&gt; remote_ip:remote_port</code>），拆分转换成 10 进制</p>
<p>0100007F:56CE</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">root@localhost ~</span>]<span class="meta"># ((d=0x01))</span></span><br><span class="line">[<span class="meta">root@localhost ~</span>]<span class="meta"># ((c=0x00))</span></span><br><span class="line">[<span class="meta">root@localhost ~</span>]<span class="meta"># ((b=0x00))</span></span><br><span class="line">[<span class="meta">root@localhost ~</span>]<span class="meta"># ((a=0x7F))</span></span><br><span class="line">[<span class="meta">root@localhost ~</span>]<span class="meta"># ((e=0x56CE))</span></span><br><span class="line">[<span class="meta">root@localhost ~</span>]<span class="meta"># echo &quot;$a.$b.$c.$d:$e&quot;</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">22222</span></span><br></pre></td></tr></table></figure>

<p>0100007F:DE72</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">root@localhost ~</span>]<span class="meta"># ((d=0x01))</span></span><br><span class="line">[<span class="meta">root@localhost ~</span>]<span class="meta"># ((c=0x00))</span></span><br><span class="line">[<span class="meta">root@localhost ~</span>]<span class="meta"># ((b=0x00))</span></span><br><span class="line">[<span class="meta">root@localhost ~</span>]<span class="meta"># ((a=0x7F))</span></span><br><span class="line">[<span class="meta">root@localhost ~</span>]<span class="meta"># ((e=0xDE72))</span></span><br><span class="line">[<span class="meta">root@localhost ~</span>]<span class="meta"># echo &quot;$a.$b.$c.$d:$e&quot;</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">56946</span></span><br></pre></td></tr></table></figure>

<p>在 /proc/net/tcp 包含了 tcp 连接的重要状态信息：<br>00000000:00000000 ： 发送队列与接收队列 （正数第四个字段）<br>-1 ： 慢启动门限 （倒数第一个字段）<br>10 ： 拥塞窗口 （倒数第二个字段）</p>
<p>client.py 也存在同样的行为：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># ls -l /proc/14202/fd</span></span><br><span class="line">total <span class="number">0</span></span><br><span class="line">lrwx------ <span class="number">1</span> root root <span class="number">64</span> Nov <span class="number">19</span> <span class="number">04</span>:<span class="number">43</span> <span class="number">0</span> -&gt; <span class="regexp">/dev/p</span>ts/<span class="number">0</span></span><br><span class="line">lrwx------ <span class="number">1</span> root root <span class="number">64</span> Nov <span class="number">19</span> <span class="number">04</span>:<span class="number">43</span> <span class="number">1</span> -&gt; <span class="regexp">/dev/p</span>ts/<span class="number">0</span></span><br><span class="line">lrwx------ <span class="number">1</span> root root <span class="number">64</span> Nov <span class="number">19</span> <span class="number">04</span>:<span class="number">43</span> <span class="number">2</span> -&gt; <span class="regexp">/dev/p</span>ts/<span class="number">0</span></span><br><span class="line">lrwx------ <span class="number">1</span> root root <span class="number">64</span> Nov <span class="number">19</span> <span class="number">04</span>:<span class="number">43</span> <span class="number">3</span> -&gt; <span class="keyword">socket</span>:[<span class="number">28728</span>]</span><br><span class="line">[root@localhost ~]<span class="comment"># lsof -n | grep 28728</span></span><br><span class="line">python    <span class="number">14202</span>         root    <span class="number">3</span>u     IPv4              <span class="number">28728</span>       0t<span class="number">0</span>        TCP <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">56946</span>-&gt;<span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">22222</span> (ESTABLISHED)</span><br><span class="line">[root@localhost fd]<span class="comment"># more /proc/net/tcp</span></span><br><span class="line">  sl  local_address rem_address   st tx_queue rx_queue <span class="keyword">tr</span> tm-&gt;<span class="keyword">when</span> retrnsmt   uid  timeout inode</span><br><span class="line">  ...</span><br><span class="line"><span class="number">3</span>: <span class="number">0100007</span>F:C31A <span class="number">0100007</span>F:DE72 <span class="number">01</span> <span class="number">00000000</span>:<span class="number">00000000</span> <span class="number">00</span>:<span class="number">00000000</span> <span class="number">00000000</span>     <span class="number">0</span>        <span class="number">0</span> <span class="number">28728</span> <span class="number">3</span> ffff8a74ba1a0f8<span class="number">0</span> <span class="number">20</span> <span class="number">4</span> <span class="number">30</span> <span class="number">10</span> -<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>0100007F:56CE</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">root@localhost ~</span>]<span class="meta"># ((d=0x01))</span></span><br><span class="line">[<span class="meta">root@localhost ~</span>]<span class="meta"># ((c=0x00))</span></span><br><span class="line">[<span class="meta">root@localhost ~</span>]<span class="meta"># ((b=0x00))</span></span><br><span class="line">[<span class="meta">root@localhost ~</span>]<span class="meta"># ((a=0x7F))</span></span><br><span class="line">[<span class="meta">root@localhost ~</span>]<span class="meta"># ((e=0x56CE))</span></span><br><span class="line">[<span class="meta">root@localhost ~</span>]<span class="meta"># echo &quot;$a.$b.$c.$d:$e&quot;</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">22222</span></span><br></pre></td></tr></table></figure>

<p>0100007F:DE72</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">root@localhost ~</span>]<span class="meta"># ((d=0x01))</span></span><br><span class="line">[<span class="meta">root@localhost ~</span>]<span class="meta"># ((c=0x00))</span></span><br><span class="line">[<span class="meta">root@localhost ~</span>]<span class="meta"># ((b=0x00))</span></span><br><span class="line">[<span class="meta">root@localhost ~</span>]<span class="meta"># ((a=0x7F))</span></span><br><span class="line">[<span class="meta">root@localhost ~</span>]<span class="meta"># ((e=0xDE72))</span></span><br><span class="line">[<span class="meta">root@localhost ~</span>]<span class="meta"># echo &quot;$a.$b.$c.$d:$e&quot;</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">56946</span></span><br></pre></td></tr></table></figure>



<p>总结一下：</p>
<ul>
<li>server.py 与 client.py 各自打开 tcp socket 描述符，该描述符指向内存中的 socket 结构体</li>
<li>socket 结构体描述了关于 TCP 的所有信息，其中通过 TCP 4 元组找到对端的通信节点</li>
<li>socket 将用户数据以及自身结构数据封装完成之后会交给底层的 TCP 协议，然后是 IP 协议、链路层信息，最后通过物理链路到达对端</li>
<li>对端也会依次解包，直至将发送端数据写入到指定的内存当中，最终由应用程序读取（本文中的 server.py 或 client.py）</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">           client.py                         server.py</span><br><span class="line">           +---------------+                 +---------------+</span><br><span class="line">           |pid:14202      |                 |pid:14199      |</span><br><span class="line">           |    +-----+    |                 |    +-----+    |</span><br><span class="line">           |    |fd:3 |    |                 |    |fd:4 |    |</span><br><span class="line">           |    +-----+    |                 |    +-----+    |</span><br><span class="line">           +---------------+                 +---------------+</span><br><span class="line">                   |                                 |</span><br><span class="line">user space         |                                 |</span><br><span class="line">+---------------------------------------------------------------------+</span><br><span class="line">kernel space       |                                 |</span><br><span class="line">                   |                                 |</span><br><span class="line">                   v                                 v</span><br><span class="line">            +------+-------+                  +------+-------+</span><br><span class="line">            |socket:[28728]|                  |socket:[99155]|</span><br><span class="line">            +------+-------+                  +------+-------+</span><br><span class="line">                   |                                 |</span><br><span class="line">                   |                                 |</span><br><span class="line">                   v                                 v</span><br><span class="line">              +----+----+                       +----+----+</span><br><span class="line">              | socket  |                       | socket  |</span><br><span class="line">              +----+----+                       +----+----+</span><br><span class="line">                   |                                 |</span><br><span class="line">                   |                                 |</span><br><span class="line">                   v                                 v</span><br><span class="line">                  ++---------------------------------+-</span><br><span class="line">                  |                tcp                |</span><br><span class="line">                  +------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h3><ul>
<li>TCP 连接中最重要的是 TCP 四元组，而进程打开 TCP socket 描述符可以找到四元组信息，从而确定双方的 IP 和 port</li>
<li>通过 socket 文件描述符可以找到内存中的 socket 结构体，获取到 TCP 连接的详细信息，包括必备四元组、文件的 inode、时间、出队入队状态等等</li>
<li>1 个进程可以创建多个 TCP 连接，也就是创建多个 socket 文件描述符，这由该进程能够打开的文件数量限制（<code>ulimit -n</code>）</li>
</ul>
<h1 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h1><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/sybnfkn040601/article/details/73718332">Linux中的文件描述符(fd)与打开文件之间的关系</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/MrVolleyball/p/9957679.html">linux 一切皆文件之文件描述符（一）</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/MrVolleyball/p/9961793.html">linux 一切皆文件之 Unix domain socket 描述符（二）</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/MrVolleyball/p/9987208.html">linux 一切皆文件之 tcp socket 描述符（三） </a></li>
</ul>
</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>