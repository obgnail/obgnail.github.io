<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;谈谈-ORM-框架&quot;&gt;&lt;a href=&quot;#谈谈-ORM-框架&quot; class=&quot;headerlink&quot; title=&quot;谈谈 ORM 框架&quot;&gt;&lt;/a&gt;谈谈 ORM 框架&lt;/h2&gt;&lt;p&gt;那对象和数据库是如何映射的呢？"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>7 天用 Go 从零实现 ORM 框架 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Golang/" rel="tag">Golang</a></div><div class="post-time">2022-03-31</div></div></div><div class="container post-header"><h1>7 天用 Go 从零实现 ORM 框架</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%88%E8%B0%88-ORM-%E6%A1%86%E6%9E%B6"><span class="toc-number">1.</span> <span class="toc-text">谈谈 ORM 框架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E6%96%87%E7%9B%AE%E6%A0%87%E6%94%AF%E6%8C%81%E7%9A%84%E7%89%B9%E6%80%A7"><span class="toc-number">2.</span> <span class="toc-text">本文目标支持的特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%81%E8%A3%85-database-sql"><span class="toc-number">3.</span> <span class="toc-text">封装 database&#x2F;sql</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#database-sql-%E6%A0%87%E5%87%86%E5%BA%93"><span class="toc-number">3.1.</span> <span class="toc-text">database&#x2F;sql 标准库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E7%BB%93%E6%9E%84-Session"><span class="toc-number">3.2.</span> <span class="toc-text">核心结构 Session</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E7%BB%93%E6%9E%84-Engine"><span class="toc-number">3.3.</span> <span class="toc-text">核心结构 Engine</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E8%A1%A8%E7%BB%93%E6%9E%84%E6%98%A0%E5%B0%84"><span class="toc-number">4.</span> <span class="toc-text">对象表结构映射</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Dialect"><span class="toc-number">4.1.</span> <span class="toc-text">Dialect</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Schema"><span class="toc-number">4.2.</span> <span class="toc-text">Schema</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Session"><span class="toc-number">4.3.</span> <span class="toc-text">Session</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E6%96%B0%E5%A2%9E%E5%92%8C%E6%9F%A5%E8%AF%A2"><span class="toc-number">5.</span> <span class="toc-text">记录新增和查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Clause-%E6%9E%84%E9%80%A0-SQL-%E8%AF%AD%E5%8F%A5"><span class="toc-number">5.1.</span> <span class="toc-text">Clause 构造 SQL 语句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-Insert-%E5%8A%9F%E8%83%BD"><span class="toc-number">5.2.</span> <span class="toc-text">实现 Insert 功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-Find-%E5%8A%9F%E8%83%BD"><span class="toc-number">5.3.</span> <span class="toc-text">实现 Find 功能</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%93%BE%E5%BC%8F%E6%93%8D%E4%BD%9C%E4%B8%8E%E6%9B%B4%E6%96%B0%E5%88%A0%E9%99%A4"><span class="toc-number">6.</span> <span class="toc-text">链式操作与更新删除</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%AF%E6%8C%81-Update%E3%80%81Delete-%E5%92%8C-Count"><span class="toc-number">6.1.</span> <span class="toc-text">支持 Update、Delete 和 Count</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8-chain"><span class="toc-number">6.2.</span> <span class="toc-text">链式调用 (chain)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#First-%E5%8F%AA%E8%BF%94%E5%9B%9E%E4%B8%80%E6%9D%A1%E8%AE%B0%E5%BD%95"><span class="toc-number">6.3.</span> <span class="toc-text">First 只返回一条记录</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%92%A9%E5%AD%90-Hooks"><span class="toc-number">7.</span> <span class="toc-text">钩子 (Hooks)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Hook-%E6%9C%BA%E5%88%B6"><span class="toc-number">7.1.</span> <span class="toc-text">Hook 机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E9%92%A9%E5%AD%90"><span class="toc-number">7.2.</span> <span class="toc-text">实现钩子</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%AF%E6%8C%81%E4%BA%8B%E5%8A%A1-Transaction"><span class="toc-number">8.</span> <span class="toc-text">支持事务 (Transaction)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SQLite-%E5%92%8C-Go-%E6%A0%87%E5%87%86%E5%BA%93%E4%B8%AD%E7%9A%84%E4%BA%8B%E5%8A%A1"><span class="toc-number">8.1.</span> <span class="toc-text">SQLite 和 Go 标准库中的事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%AF%E6%8C%81%E4%BA%8B%E5%8A%A1"><span class="toc-number">8.2.</span> <span class="toc-text">支持事务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%81%E7%A7%BB-Migrate"><span class="toc-number">9.</span> <span class="toc-text">数据库迁移 (Migrate)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-SQL-%E8%AF%AD%E5%8F%A5-Migrate"><span class="toc-number">9.1.</span> <span class="toc-text">使用 SQL 语句 Migrate</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-Migrate"><span class="toc-number">9.2.</span> <span class="toc-text">实现 Migrate</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#reference"><span class="toc-number"></span> <span class="toc-text">reference</span></a></details></div><div class="container post-content"><h2 id="谈谈-ORM-框架"><a href="#谈谈-ORM-框架" class="headerlink" title="谈谈 ORM 框架"></a>谈谈 ORM 框架</h2><p>那对象和数据库是如何映射的呢？</p>
<table>
<thead>
<tr>
<th align="left">数据库</th>
<th align="left">面向对象的编程语言</th>
</tr>
</thead>
<tbody><tr>
<td align="left">表 (table)</td>
<td align="left">类 (class/struct)</td>
</tr>
<tr>
<td align="left">记录 (record, row)</td>
<td align="left">对象 (object)</td>
</tr>
<tr>
<td align="left">字段 (field, column)</td>
<td align="left">对象属性 (attribute)</td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `<span class="keyword">User</span>` (`Name` text, `Age` <span class="type">integer</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `<span class="keyword">User</span>` (`Name`, `Age`) <span class="keyword">VALUES</span> (&quot;Tom&quot;, <span class="number">18</span>);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `<span class="keyword">User</span>`;</span><br></pre></td></tr></table></figure>

<p>对应 ORM 的接口：</p>
<ul>
<li><code>CreateTable</code> 方法需要从参数 <code>&amp;User&#123;&#125;</code> 得到对应的结构体的名称 User 作为表名，成员变量 Name, Age 作为列名，同时还需要知道成员变量对应的类型。</li>
<li><code>Save</code> 方法则需要知道每个成员变量的值。</li>
<li><code>Find</code> 方法仅从传入的空切片 <code>&amp;[]User</code>，得到对应的结构体名也就是表名 User，并从数据库中取到所有的记录，将其转换成 User 对象，添加到切片中。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name <span class="keyword">string</span></span><br><span class="line">    Age  <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">orm.CreateTable(&amp;User&#123;&#125;)</span><br><span class="line">orm.Save(&amp;User&#123;<span class="string">&quot;Tom&quot;</span>, <span class="number">18</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> users []User</span><br><span class="line">orm.Find(&amp;users)</span><br></pre></td></tr></table></figure>



<h2 id="本文目标支持的特性"><a href="#本文目标支持的特性" class="headerlink" title="本文目标支持的特性"></a>本文目标支持的特性</h2><ul>
<li>表的创建、删除、迁移。</li>
<li>记录的增删查改，查询条件的链式操作。</li>
<li>单一主键的设置 (primary key)。</li>
<li>钩子 (在创建 / 更新 / 删除 / 查找之前或之后)</li>
<li>事务 (transaction)。</li>
</ul>
<h2 id="封装-database-sql"><a href="#封装-database-sql" class="headerlink" title="封装 database/sql"></a>封装 database/sql</h2><h3 id="database-sql-标准库"><a href="#database-sql-标准库" class="headerlink" title="database/sql 标准库"></a>database/sql 标准库</h3><p>database/sql 标准库</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;database/sql&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	</span><br><span class="line">	_ <span class="string">&quot;github.com/mattn/go-sqlite3&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	db, _ := sql.Open(<span class="string">&quot;sqlite3&quot;</span>, <span class="string">&quot;gee.db&quot;</span>)</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; _ = db.Close() &#125;()</span><br><span class="line"></span><br><span class="line">	_, _ = db.Exec(<span class="string">&quot;DROP TABLE IF EXISTS User;&quot;</span>)</span><br><span class="line">	_, _ = db.Exec(<span class="string">&quot;CREATE TABLE User(Name text);&quot;</span>)</span><br><span class="line">	result, err := db.Exec(<span class="string">&quot;INSERT INTO User(`Name`) values (?), (?)&quot;</span>, <span class="string">&quot;Tom&quot;</span>, <span class="string">&quot;Sam&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">		affected, _ := result.RowsAffected()</span><br><span class="line">		log.Println(affected)</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">	row := db.QueryRow(<span class="string">&quot;SELECT Name FROM User LIMIT 1&quot;</span>)</span><br><span class="line">	<span class="keyword">var</span> name <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">if</span> err := row.Scan(&amp;name); err == <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(name)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用 <code>sql.Open()</code> 连接数据库，第一个参数是驱动名称，import 语句 <code>_ &quot;github.com/mattn/go-sqlite3&quot;</code> 包导入时会注册 sqlite3 的驱动，第二个参数是数据库的名称，对于 SQLite 来说，也就是文件名，不存在会新建。返回一个 <code>sql.DB</code> 实例的指针。</li>
<li><code>Exec()</code> 用于执行 SQL 语句，如果是查询语句，不会返回相关的记录。所以查询语句通常使用 <code>Query()</code> 和 <code>QueryRow()</code>，前者可以返回多条记录，后者只返回一条记录。</li>
<li><code>Exec()</code>、<code>Query()</code>、<code>QueryRow()</code> 接受 1 或多个入参，第一个入参是 SQL 语句，后面的入参是 SQL 语句中的占位符 <code>?</code> 对应的值，占位符一般用来防 SQL 注入。</li>
<li><code>QueryRow()</code> 的返回值类型是 <code>*sql.Row</code>，<code>row.Scan()</code> 接受 1 或多个指针作为参数，可以获取对应列 (column) 的值，在这个示例中，只有 <code>Name</code> 一列，因此传入字符串指针 <code>&amp;name</code> 即可获取到查询的结果。</li>
</ul>
<h3 id="核心结构-Session"><a href="#核心结构-Session" class="headerlink" title="核心结构 Session"></a>核心结构 Session</h3><p>session，用于实现与数据库的交互。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> session</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;database/sql&quot;</span></span><br><span class="line">	<span class="string">&quot;geeorm/log&quot;</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Session <span class="keyword">struct</span> &#123;</span><br><span class="line">	db      *sql.DB          <span class="comment">// 使用 sql.Open() 方法连接数据库成功之后返回的指针。</span></span><br><span class="line">  <span class="comment">// 第二个和第三个成员变量用来拼接 SQL 语句和 SQL 语句中占位符的对应值。用户调用 Raw() 方法即可改变这两个变量的值。</span></span><br><span class="line">	sql     strings.Builder</span><br><span class="line">	sqlVars []<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(db *sql.DB)</span> *<span class="title">Session</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;Session&#123;db: db&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Session)</span> <span class="title">Clear</span><span class="params">()</span></span> &#123;</span><br><span class="line">	s.sql.Reset()</span><br><span class="line">	s.sqlVars = <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Session)</span> <span class="title">DB</span><span class="params">()</span> *<span class="title">sql</span>.<span class="title">DB</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> s.db</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Session)</span> <span class="title">Raw</span><span class="params">(sql <span class="keyword">string</span>, values ...<span class="keyword">interface</span>&#123;&#125;)</span> *<span class="title">Session</span></span> &#123;</span><br><span class="line">	s.sql.WriteString(sql)</span><br><span class="line">	s.sql.WriteString(<span class="string">&quot; &quot;</span>)</span><br><span class="line">	s.sqlVars = <span class="built_in">append</span>(s.sqlVars, values...)</span><br><span class="line">	<span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Exec raw sql with sqlVars</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Session)</span> <span class="title">Exec</span><span class="params">()</span> <span class="params">(result sql.Result, err error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> s.Clear()</span><br><span class="line">	log.Info(s.sql.String(), s.sqlVars)</span><br><span class="line">	<span class="keyword">if</span> result, err = s.DB().Exec(s.sql.String(), s.sqlVars...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Error(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// QueryRow gets a record from db</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Session)</span> <span class="title">QueryRow</span><span class="params">()</span> *<span class="title">sql</span>.<span class="title">Row</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> s.Clear()</span><br><span class="line">	log.Info(s.sql.String(), s.sqlVars)</span><br><span class="line">	<span class="keyword">return</span> s.DB().QueryRow(s.sql.String(), s.sqlVars...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// QueryRows gets a list of records from db</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Session)</span> <span class="title">QueryRows</span><span class="params">()</span> <span class="params">(rows *sql.Rows, err error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> s.Clear()</span><br><span class="line">	log.Info(s.sql.String(), s.sqlVars)</span><br><span class="line">	<span class="keyword">if</span> rows, err = s.DB().Query(s.sql.String(), s.sqlVars...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Error(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="核心结构-Engine"><a href="#核心结构-Engine" class="headerlink" title="核心结构 Engine"></a>核心结构 Engine</h3><p>Session 负责与数据库的交互，那交互前的准备工作（比如连接 / 测试数据库），交互后的收尾工作（关闭连接）等就交给 Engine 来负责了。<strong>Engine 是 GeeORM 与用户交互的入口</strong>。代码位于根目录的 <code>geeorm.go</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> geeorm</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;database/sql&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;geeorm/log&quot;</span></span><br><span class="line">	<span class="string">&quot;geeorm/session&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Engine <span class="keyword">struct</span> &#123;</span><br><span class="line">	db *sql.DB</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewEngine</span><span class="params">(driver, source <span class="keyword">string</span>)</span> <span class="params">(e *Engine, err error)</span></span> &#123;</span><br><span class="line">	db, err := sql.Open(driver, source)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Error(err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Send a ping to make sure the database connection is alive.</span></span><br><span class="line">	<span class="keyword">if</span> err = db.Ping(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Error(err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	e = &amp;Engine&#123;db: db&#125;</span><br><span class="line">	log.Info(<span class="string">&quot;Connect database success&quot;</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(engine *Engine)</span> <span class="title">Close</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> err := engine.db.Close(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Error(<span class="string">&quot;Failed to close database&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Info(<span class="string">&quot;Close database success&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(engine *Engine)</span> <span class="title">NewSession</span><span class="params">()</span> *<span class="title">session</span>.<span class="title">Session</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> session.New(engine.db)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="对象表结构映射"><a href="#对象表结构映射" class="headerlink" title="对象表结构映射"></a>对象表结构映射</h2><ul>
<li>为适配不同的数据库，映射数据类型和特定的 SQL 语句，创建 Dialect 层屏蔽数据库差异。</li>
<li>设计 Schema，利用反射 (reflect) 完成结构体和数据库表结构的映射，包括表名、字段名、字段类型、字段 tag 等。</li>
<li>构造创建 (create)、删除 (drop)、存在性 (table exists) 的 SQL 语句完成数据库表的基本操作。</li>
</ul>
<h3 id="Dialect"><a href="#Dialect" class="headerlink" title="Dialect"></a>Dialect</h3><p>将 Go 语言的类型映射为数据库中的类型。不同数据库支持的数据类型也是有差异的，需要支持。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> dialect</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;reflect&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dialectsMap = <span class="keyword">map</span>[<span class="keyword">string</span>]Dialect&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Dialect <span class="keyword">interface</span> &#123;</span><br><span class="line">	DataTypeOf(typ reflect.Value) <span class="keyword">string</span>   <span class="comment">// 用于将 Go 语言的类型转换为该数据库的数据类型</span></span><br><span class="line">	TableExistSQL(tableName <span class="keyword">string</span>) (<span class="keyword">string</span>, []<span class="keyword">interface</span>&#123;&#125;)  <span class="comment">// 返回某个表是否存在的 SQL 语句，参数是表名 (table)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RegisterDialect</span><span class="params">(name <span class="keyword">string</span>, dialect Dialect)</span></span> &#123;</span><br><span class="line">	dialectsMap[name] = dialect</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetDialect</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="params">(dialect Dialect, ok <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">	dialect, ok = dialectsMap[name]</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> dialect</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;reflect&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> sqlite3 <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _ Dialect = (*sqlite3)(<span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	RegisterDialect(<span class="string">&quot;sqlite3&quot;</span>, &amp;sqlite3&#123;&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get Data Type for sqlite3 Dialect</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *sqlite3)</span> <span class="title">DataTypeOf</span><span class="params">(typ reflect.Value)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">switch</span> typ.Kind() &#123;</span><br><span class="line">	<span class="keyword">case</span> reflect.Bool:</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;bool&quot;</span></span><br><span class="line">	<span class="keyword">case</span> reflect.Int, reflect.Int8, reflect.Int16, reflect.Int32,</span><br><span class="line">		reflect.Uint, reflect.Uint8, reflect.Uint16, reflect.Uint32, reflect.Uintptr:</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">	<span class="keyword">case</span> reflect.Int64, reflect.Uint64:</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;bigint&quot;</span></span><br><span class="line">	<span class="keyword">case</span> reflect.Float32, reflect.Float64:</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;real&quot;</span></span><br><span class="line">	<span class="keyword">case</span> reflect.String:</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;text&quot;</span></span><br><span class="line">	<span class="keyword">case</span> reflect.Array, reflect.Slice:</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;blob&quot;</span></span><br><span class="line">	<span class="keyword">case</span> reflect.Struct:</span><br><span class="line">		<span class="keyword">if</span> _, ok := typ.Interface().(time.Time); ok &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;datetime&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">panic</span>(fmt.Sprintf(<span class="string">&quot;invalid sql type %s (%s)&quot;</span>, typ.Type().Name(), typ.Kind()))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TableExistSQL returns SQL that judge whether the table exists in database</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *sqlite3)</span> <span class="title">TableExistSQL</span><span class="params">(tableName <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, []<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	args := []<span class="keyword">interface</span>&#123;&#125;&#123;tableName&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;SELECT name FROM sqlite_master WHERE type=&#x27;table&#x27; and name = ?&quot;</span>, args</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Schema"><a href="#Schema" class="headerlink" title="Schema"></a>Schema</h3><p>Dialect 实现了一些特定的 SQL 语句的转换，接下来我们将要实现 ORM 框架中最为核心的转换 —— 对象 (object) 和表 (table) 的转换。给定一个任意的对象，转换为关系型数据库中的表结构。</p>
<p>在数据库中创建一张表需要哪些要素呢？</p>
<ul>
<li>表名 (table name) —— 结构体名 (struct name)</li>
<li>字段名和字段类型 —— 成员变量和类型。</li>
<li>额外的约束条件 (例如非空、主键等) —— 成员变量的 Tag（Go 语言通过 Tag 实现，Java、Python 等语言通过注解实现）</li>
</ul>
<p>举一个实际的例子：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name <span class="keyword">string</span> <span class="string">`geeorm:&quot;PRIMARY KEY&quot;`</span></span><br><span class="line">    Age  <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>期望对应的 schema 语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `<span class="keyword">User</span>` (`Name` text <span class="keyword">PRIMARY</span> KEY, `Age` <span class="type">integer</span>);</span><br></pre></td></tr></table></figure>



<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> schema</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;geeorm/dialect&quot;</span></span><br><span class="line">	<span class="string">&quot;go/ast&quot;</span></span><br><span class="line">	<span class="string">&quot;reflect&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Field represents a column of database</span></span><br><span class="line"><span class="keyword">type</span> Field <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name <span class="keyword">string</span>  <span class="comment">// 字段名</span></span><br><span class="line">	Type <span class="keyword">string</span>  <span class="comment">// 类型</span></span><br><span class="line">	Tag  <span class="keyword">string</span>  <span class="comment">// 约束条件</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Schema represents a table of database</span></span><br><span class="line"><span class="keyword">type</span> Schema <span class="keyword">struct</span> &#123;</span><br><span class="line">	Model      <span class="keyword">interface</span>&#123;&#125;   <span class="comment">// 被映射的对象</span></span><br><span class="line">	Name       <span class="keyword">string</span>        <span class="comment">// 表名</span></span><br><span class="line">	Fields     []*Field      <span class="comment">// 字段</span></span><br><span class="line">	FieldNames []<span class="keyword">string</span></span><br><span class="line">	fieldMap   <span class="keyword">map</span>[<span class="keyword">string</span>]*Field</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(schema *Schema)</span> <span class="title">GetField</span><span class="params">(name <span class="keyword">string</span>)</span> *<span class="title">Field</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> schema.fieldMap[name]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Parse 函数，将任意的对象解析为 Schema 实例。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ITableName <span class="keyword">interface</span> &#123;</span><br><span class="line">	TableName() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Parse</span><span class="params">(dest <span class="keyword">interface</span>&#123;&#125;, d dialect.Dialect)</span> *<span class="title">Schema</span></span> &#123;</span><br><span class="line">	modelType := reflect.Indirect(reflect.ValueOf(dest)).Type()</span><br><span class="line">	schema := &amp;Schema&#123;</span><br><span class="line">		Model:    dest,</span><br><span class="line">		Name:     modelType.Name(),</span><br><span class="line">		fieldMap: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*Field),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; modelType.NumField(); i++ &#123;</span><br><span class="line">		p := modelType.Field(i)</span><br><span class="line">		<span class="keyword">if</span> !p.Anonymous &amp;&amp; ast.IsExported(p.Name) &#123;</span><br><span class="line">			field := &amp;Field&#123;</span><br><span class="line">				Name: p.Name,</span><br><span class="line">				Type: d.DataTypeOf(reflect.Indirect(reflect.New(p.Type))),</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> v, ok := p.Tag.Lookup(<span class="string">&quot;geeorm&quot;</span>); ok &#123;</span><br><span class="line">				field.Tag = v</span><br><span class="line">			&#125;</span><br><span class="line">			schema.Fields = <span class="built_in">append</span>(schema.Fields, field)</span><br><span class="line">			schema.FieldNames = <span class="built_in">append</span>(schema.FieldNames, p.Name)</span><br><span class="line">			schema.fieldMap[p.Name] = field</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> schema</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>验证 Parse：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// schema_test.go</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name <span class="keyword">string</span> <span class="string">`geeorm:&quot;PRIMARY KEY&quot;`</span></span><br><span class="line">	Age  <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> TestDial, _ = dialect.GetDialect(<span class="string">&quot;sqlite3&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestParse</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	schema := Parse(&amp;User&#123;&#125;, TestDial)</span><br><span class="line">	<span class="keyword">if</span> schema.Name != <span class="string">&quot;User&quot;</span> || <span class="built_in">len</span>(schema.Fields) != <span class="number">2</span> &#123;</span><br><span class="line">		t.Fatal(<span class="string">&quot;failed to parse User struct&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> schema.GetField(<span class="string">&quot;Name&quot;</span>).Tag != <span class="string">&quot;PRIMARY KEY&quot;</span> &#123;</span><br><span class="line">		t.Fatal(<span class="string">&quot;failed to parse primary key&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h3><p>Session 的核心功能是与数据库进行交互。因此，我们将数据库表的增 / 删操作实现在子包 session 中。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Session keep a pointer to sql.DB and provides all execution of all</span></span><br><span class="line"><span class="comment">// kind of database operations.</span></span><br><span class="line"><span class="keyword">type</span> Session <span class="keyword">struct</span> &#123;</span><br><span class="line">	db       *sql.DB</span><br><span class="line">	dialect  dialect.Dialect</span><br><span class="line">	refTable *schema.Schema    <span class="comment">// 解析操作是比较耗时的，因此将解析的结果保存在成员变量 refTable 中</span></span><br><span class="line">	sql      strings.Builder</span><br><span class="line">	sqlVars  []<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(db *sql.DB, dialect dialect.Dialect)</span> *<span class="title">Session</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;Session&#123;</span><br><span class="line">		db:      db,</span><br><span class="line">		dialect: dialect,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Model assigns refTable</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Session)</span> <span class="title">Model</span><span class="params">(value <span class="keyword">interface</span>&#123;&#125;)</span> *<span class="title">Session</span></span> &#123;</span><br><span class="line">	<span class="comment">// nil or different model, update refTable</span></span><br><span class="line">	<span class="keyword">if</span> s.refTable == <span class="literal">nil</span> || reflect.TypeOf(value) != reflect.TypeOf(s.refTable.Model) &#123;</span><br><span class="line">		s.refTable = schema.Parse(value, s.dialect)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RefTable returns a Schema instance that contains all parsed fields</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Session)</span> <span class="title">RefTable</span><span class="params">()</span> *<span class="title">schema</span>.<span class="title">Schema</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> s.refTable == <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Error(<span class="string">&quot;Model is not set&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> s.refTable</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CreateTable create a table in database with a model</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Session)</span> <span class="title">CreateTable</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	table := s.RefTable()</span><br><span class="line">	<span class="keyword">var</span> columns []<span class="keyword">string</span></span><br><span class="line">	<span class="keyword">for</span> _, field := <span class="keyword">range</span> table.Fields &#123;</span><br><span class="line">		columns = <span class="built_in">append</span>(columns, fmt.Sprintf(<span class="string">&quot;%s %s %s&quot;</span>, field.Name, field.Type, field.Tag))</span><br><span class="line">	&#125;</span><br><span class="line">	desc := strings.Join(columns, <span class="string">&quot;,&quot;</span>)</span><br><span class="line">	_, err := s.Raw(fmt.Sprintf(<span class="string">&quot;CREATE TABLE %s (%s);&quot;</span>, table.Name, desc)).Exec()</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DropTable drops a table with the name of model</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Session)</span> <span class="title">DropTable</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	_, err := s.Raw(fmt.Sprintf(<span class="string">&quot;DROP TABLE IF EXISTS %s&quot;</span>, s.RefTable().Name)).Exec()</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HasTable returns true of the table exists</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Session)</span> <span class="title">HasTable</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	sql, values := s.dialect.TableExistSQL(s.RefTable().Name)</span><br><span class="line">	row := s.Raw(sql, values...).QueryRow()</span><br><span class="line">	<span class="keyword">var</span> tmp <span class="keyword">string</span></span><br><span class="line">	_ = row.Scan(&amp;tmp)</span><br><span class="line">	<span class="keyword">return</span> tmp == s.RefTable().Name</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name <span class="keyword">string</span> <span class="string">`geeorm:&quot;PRIMARY KEY&quot;`</span></span><br><span class="line">	Age  <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestSession_CreateTable</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	s := NewSession().Model(&amp;User&#123;&#125;)</span><br><span class="line">	_ = s.DropTable()</span><br><span class="line">	_ = s.CreateTable()</span><br><span class="line">	<span class="keyword">if</span> !s.HasTable() &#123;</span><br><span class="line">		t.Fatal(<span class="string">&quot;Failed to create table User&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="记录新增和查询"><a href="#记录新增和查询" class="headerlink" title="记录新增和查询"></a>记录新增和查询</h2><ul>
<li>实现新增 (insert) 记录的功能。</li>
<li>使用反射 (reflect) 将数据库的记录转换为对应的结构体实例，实现查询 (select) 功能。</li>
</ul>
<h3 id="Clause-构造-SQL-语句"><a href="#Clause-构造-SQL-语句" class="headerlink" title="Clause 构造 SQL 语句"></a>Clause 构造 SQL 语句</h3><p>查询语句一般由很多个子句 (clause) 构成。SELECT 语句的构成通常是这样的：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> col1, col2, ...</span><br><span class="line">    <span class="keyword">FROM</span> table_name</span><br><span class="line">    <span class="keyword">WHERE</span> [ conditions ]</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> col1</span><br><span class="line">    <span class="keyword">HAVING</span> [ conditions ]</span><br></pre></td></tr></table></figure>

<p>也就是说，如果想一次构造出完整的 SQL 语句是比较困难的，因此我们将构造 SQL 语句这一部分独立出来，放在子 package clause 中实现。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> clause</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> generator <span class="function"><span class="keyword">func</span><span class="params">(values ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(<span class="keyword">string</span>, []<span class="keyword">interface</span>&#123;&#125;)</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> generators <span class="keyword">map</span>[Type]generator</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	generators = <span class="built_in">make</span>(<span class="keyword">map</span>[Type]generator)</span><br><span class="line">	generators[INSERT] = _insert</span><br><span class="line">	generators[VALUES] = _values</span><br><span class="line">	generators[SELECT] = _select</span><br><span class="line">	generators[LIMIT] = _limit</span><br><span class="line">	generators[WHERE] = _where</span><br><span class="line">	generators[ORDERBY] = _orderBy</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">genBindVars</span><span class="params">(num <span class="keyword">int</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> vars []<span class="keyword">string</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; num; i++ &#123;</span><br><span class="line">		vars = <span class="built_in">append</span>(vars, <span class="string">&quot;?&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> strings.Join(vars, <span class="string">&quot;, &quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> _<span class="title">insert</span><span class="params">(values ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(<span class="keyword">string</span>, []<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	<span class="comment">// INSERT INTO $tableName ($fields)</span></span><br><span class="line">	tableName := values[<span class="number">0</span>]</span><br><span class="line">	fields := strings.Join(values[<span class="number">1</span>].([]<span class="keyword">string</span>), <span class="string">&quot;,&quot;</span>)</span><br><span class="line">	<span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;INSERT INTO %s (%v)&quot;</span>, tableName, fields), []<span class="keyword">interface</span>&#123;&#125;&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> _<span class="title">values</span><span class="params">(values ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(<span class="keyword">string</span>, []<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	<span class="comment">// VALUES ($v1), ($v2), ...</span></span><br><span class="line">	<span class="keyword">var</span> bindStr <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">var</span> sql strings.Builder</span><br><span class="line">	<span class="keyword">var</span> vars []<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	sql.WriteString(<span class="string">&quot;VALUES &quot;</span>)</span><br><span class="line">	<span class="keyword">for</span> i, value := <span class="keyword">range</span> values &#123;</span><br><span class="line">		v := value.([]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">		<span class="keyword">if</span> bindStr == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">			bindStr = genBindVars(<span class="built_in">len</span>(v))</span><br><span class="line">		&#125;</span><br><span class="line">		sql.WriteString(fmt.Sprintf(<span class="string">&quot;(%v)&quot;</span>, bindStr))</span><br><span class="line">		<span class="keyword">if</span> i+<span class="number">1</span> != <span class="built_in">len</span>(values) &#123;</span><br><span class="line">			sql.WriteString(<span class="string">&quot;, &quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		vars = <span class="built_in">append</span>(vars, v...)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> sql.String(), vars</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> _<span class="title">select</span><span class="params">(values ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(<span class="keyword">string</span>, []<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	<span class="comment">// SELECT $fields FROM $tableName</span></span><br><span class="line">	tableName := values[<span class="number">0</span>]</span><br><span class="line">	fields := strings.Join(values[<span class="number">1</span>].([]<span class="keyword">string</span>), <span class="string">&quot;,&quot;</span>)</span><br><span class="line">	<span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;SELECT %v FROM %s&quot;</span>, fields, tableName), []<span class="keyword">interface</span>&#123;&#125;&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> _<span class="title">limit</span><span class="params">(values ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(<span class="keyword">string</span>, []<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	<span class="comment">// LIMIT $num</span></span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;LIMIT ?&quot;</span>, values</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> _<span class="title">where</span><span class="params">(values ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(<span class="keyword">string</span>, []<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	<span class="comment">// WHERE $desc</span></span><br><span class="line">	desc, vars := values[<span class="number">0</span>], values[<span class="number">1</span>:]</span><br><span class="line">	<span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;WHERE %s&quot;</span>, desc), vars</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> _<span class="title">orderBy</span><span class="params">(values ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(<span class="keyword">string</span>, []<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;ORDER BY %s&quot;</span>, values[<span class="number">0</span>]), []<span class="keyword">interface</span>&#123;&#125;&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>拼接各个独立的子句：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> clause</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;strings&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Clause <span class="keyword">struct</span> &#123;</span><br><span class="line">	sql     <span class="keyword">map</span>[Type]<span class="keyword">string</span></span><br><span class="line">	sqlVars <span class="keyword">map</span>[Type][]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Type <span class="keyword">int</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	INSERT Type = <span class="literal">iota</span></span><br><span class="line">	VALUES</span><br><span class="line">	SELECT</span><br><span class="line">	LIMIT</span><br><span class="line">	WHERE</span><br><span class="line">	ORDERBY</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set 方法根据 Type 调用对应的 generator，生成该子句对应的 SQL 语句。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Clause)</span> <span class="title">Set</span><span class="params">(name Type, vars ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> c.sql == <span class="literal">nil</span> &#123;</span><br><span class="line">		c.sql = <span class="built_in">make</span>(<span class="keyword">map</span>[Type]<span class="keyword">string</span>)</span><br><span class="line">		c.sqlVars = <span class="built_in">make</span>(<span class="keyword">map</span>[Type][]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">	sql, vars := generators[name](vars...)</span><br><span class="line">	c.sql[name] = sql</span><br><span class="line">	c.sqlVars[name] = vars</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Build 方法根据传入的 Type 的顺序，构造出最终的 SQL 语句。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Clause)</span> <span class="title">Build</span><span class="params">(orders ...Type)</span> <span class="params">(<span class="keyword">string</span>, []<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> sqls []<span class="keyword">string</span></span><br><span class="line">	<span class="keyword">var</span> vars []<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	<span class="keyword">for</span> _, order := <span class="keyword">range</span> orders &#123;</span><br><span class="line">		<span class="keyword">if</span> sql, ok := c.sql[order]; ok &#123;</span><br><span class="line">			sqls = <span class="built_in">append</span>(sqls, sql)</span><br><span class="line">			vars = <span class="built_in">append</span>(vars, c.sqlVars[order]...)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> strings.Join(sqls, <span class="string">&quot; &quot;</span>), vars</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试用例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">testSelect</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> clause Clause</span><br><span class="line">	clause.Set(LIMIT, <span class="number">3</span>)</span><br><span class="line">	clause.Set(SELECT, <span class="string">&quot;User&quot;</span>, []<span class="keyword">string</span>&#123;<span class="string">&quot;*&quot;</span>&#125;)</span><br><span class="line">	clause.Set(WHERE, <span class="string">&quot;Name = ?&quot;</span>, <span class="string">&quot;Tom&quot;</span>)</span><br><span class="line">	clause.Set(ORDERBY, <span class="string">&quot;Age ASC&quot;</span>)</span><br><span class="line">	sql, vars := clause.Build(SELECT, WHERE, ORDERBY, LIMIT)</span><br><span class="line">	t.Log(sql, vars)</span><br><span class="line">	<span class="keyword">if</span> sql != <span class="string">&quot;SELECT * FROM User WHERE Name = ? ORDER BY Age ASC LIMIT ?&quot;</span> &#123;</span><br><span class="line">		t.Fatal(<span class="string">&quot;failed to build SQL&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> !reflect.DeepEqual(vars, []<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;Tom&quot;</span>, <span class="number">3</span>&#125;) &#123;</span><br><span class="line">		t.Fatal(<span class="string">&quot;failed to build SQLVars&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestClause_Build</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	t.Run(<span class="string">&quot;select&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">		testSelect(t)</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="实现-Insert-功能"><a href="#实现-Insert-功能" class="headerlink" title="实现 Insert 功能"></a>实现 Insert 功能</h3><p>NSERT 对应的 SQL 语句一般是这样的：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> table_name(col1, col2, col3, ...) <span class="keyword">VALUES</span></span><br><span class="line">    (A1, A2, A3, ...),</span><br><span class="line">    (B1, B2, B3, ...),</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>在 ORM 框架中期望 Insert 的调用方式如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">session := geeorm.NewEngine(<span class="string">&quot;sqlite3&quot;</span>, <span class="string">&quot;gee.db&quot;</span>).NewSession()</span><br><span class="line">u1 := &amp;User&#123;Name: <span class="string">&quot;Tom&quot;</span>, Age: <span class="number">18</span>&#125;</span><br><span class="line">u2 := &amp;User&#123;Name: <span class="string">&quot;Sam&quot;</span>, Age: <span class="number">25</span>&#125;</span><br><span class="line">session.Insert(u1, u2, ...)</span><br></pre></td></tr></table></figure>

<p>也就是说，我们需要一个步骤，根据数据库中列的顺序，从对象中找到对应的值，按顺序平铺。即 <code>u1</code>、<code>u2</code> 转换为 <code>(&quot;Tom&quot;, 18), (&quot;Same&quot;, 25)</code> 这样的格式。因此就有了下面的函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(schema *Schema)</span> <span class="title">RecordValues</span><span class="params">(dest <span class="keyword">interface</span>&#123;&#125;)</span> []<span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line">	destValue := reflect.Indirect(reflect.ValueOf(dest))</span><br><span class="line">	<span class="keyword">var</span> fieldValues []<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	<span class="keyword">for</span> _, field := <span class="keyword">range</span> schema.Fields &#123;</span><br><span class="line">		fieldValues = <span class="built_in">append</span>(fieldValues, destValue.FieldByName(field.Name).Interface())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> fieldValues</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Session <span class="keyword">struct</span> &#123;</span><br><span class="line">	db       *sql.DB</span><br><span class="line">	dialect  dialect.Dialect</span><br><span class="line">	refTable *schema.Schema</span><br><span class="line">	clause   clause.Clause    <span class="comment">// 为 Session 添加成员变量 clause</span></span><br><span class="line">	sql      strings.Builder</span><br><span class="line">	sqlVars  []<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Session)</span> <span class="title">Clear</span><span class="params">()</span></span> &#123;</span><br><span class="line">	s.sql.Reset()</span><br><span class="line">	s.sqlVars = <span class="literal">nil</span></span><br><span class="line">	s.clause = clause.Clause&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Session)</span> <span class="title">Insert</span><span class="params">(values ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(<span class="keyword">int64</span>, error)</span></span> &#123;</span><br><span class="line">	recordValues := <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> _, value := <span class="keyword">range</span> values &#123;</span><br><span class="line">		table := s.Model(value).RefTable()</span><br><span class="line">		s.clause.Set(clause.INSERT, table.Name, table.FieldNames)</span><br><span class="line">		recordValues = <span class="built_in">append</span>(recordValues, table.RecordValues(value))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	s.clause.Set(clause.VALUES, recordValues...)</span><br><span class="line">	sql, vars := s.clause.Build(clause.INSERT, clause.VALUES)</span><br><span class="line">	result, err := s.Raw(sql, vars...).Exec()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> result.RowsAffected()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后续所有构造 SQL 语句的方式都将与 <code>Insert</code> 中构造 SQL 语句的方式一致。分两步：</p>
<ul>
<li>多次调用 clause.Set() 构造好每一个子句。</li>
<li>调用一次 <code>clause.Build()</code> 按照传入的顺序构造出最终的 SQL 语句。</li>
</ul>
<p>构造完成后，调用 <code>Raw().Exec()</code> 方法执行。</p>
<h3 id="实现-Find-功能"><a href="#实现-Find-功能" class="headerlink" title="实现 Find 功能"></a>实现 Find 功能</h3><p>期望的调用方式是这样的：传入一个切片指针，查询的结果保存在切片中。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s := geeorm.NewEngine(<span class="string">&quot;sqlite3&quot;</span>, <span class="string">&quot;gee.db&quot;</span>).NewSession()</span><br><span class="line"><span class="keyword">var</span> users []User</span><br><span class="line">s.Find(&amp;users);</span><br></pre></td></tr></table></figure>

<p>Find 功能的难点和 Insert 恰好反了过来。Insert 需要将已经存在的对象的每一个字段的值平铺开来，而 Find 则是需要根据平铺开的字段的值构造出对象。同样，也需要用到反射。</p>
<p>Find 的代码实现比较复杂，主要分为以下几步：</p>
<ol>
<li><code>destSlice.Type().Elem()</code> 获取切片的单个元素的类型 <code>destType</code>，使用 <code>reflect.New()</code> 方法创建一个 <code>destType</code> 的实例，作为 <code>Model()</code> 的入参，映射出表结构 <code>RefTable()</code>。</li>
<li>根据表结构，使用 clause 构造出 SELECT 语句，查询到所有符合条件的记录 <code>rows</code>。</li>
<li>遍历每一行记录，利用反射创建 <code>destType</code> 的实例 <code>dest</code>，将 <code>dest</code> 的所有字段平铺开，构造切片 <code>values</code>。</li>
<li>调用 <code>rows.Scan()</code> 将该行记录每一列的值依次赋值给 values 中的每一个字段。</li>
<li>将 <code>dest</code> 添加到切片 <code>destSlice</code> 中。循环直到所有的记录都添加到切片 <code>destSlice</code> 中。</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Session)</span> <span class="title">Find</span><span class="params">(values <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	destSlice := reflect.Indirect(reflect.ValueOf(values))</span><br><span class="line">	destType := destSlice.Type().Elem()</span><br><span class="line">	table := s.Model(reflect.New(destType).Elem().Interface()).RefTable()</span><br><span class="line"></span><br><span class="line">	s.clause.Set(clause.SELECT, table.Name, table.FieldNames)</span><br><span class="line">	sql, vars := s.clause.Build(clause.SELECT, clause.WHERE, clause.ORDERBY, clause.LIMIT)</span><br><span class="line">	rows, err := s.Raw(sql, vars...).QueryRows()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line">		dest := reflect.New(destType).Elem()</span><br><span class="line">		<span class="keyword">var</span> values []<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">		<span class="keyword">for</span> _, name := <span class="keyword">range</span> table.FieldNames &#123;</span><br><span class="line">			values = <span class="built_in">append</span>(values, dest.FieldByName(name).Addr().Interface())</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> err := rows.Scan(values...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		destSlice.Set(reflect.Append(destSlice, dest))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> rows.Close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> session</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;testing&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	user1 = &amp;User&#123;<span class="string">&quot;Tom&quot;</span>, <span class="number">18</span>&#125;</span><br><span class="line">	user2 = &amp;User&#123;<span class="string">&quot;Sam&quot;</span>, <span class="number">25</span>&#125;</span><br><span class="line">	user3 = &amp;User&#123;<span class="string">&quot;Jack&quot;</span>, <span class="number">25</span>&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">testRecordInit</span><span class="params">(t *testing.T)</span> *<span class="title">Session</span></span> &#123;</span><br><span class="line">	t.Helper()</span><br><span class="line">	s := NewSession().Model(&amp;User&#123;&#125;)</span><br><span class="line">	err1 := s.DropTable()</span><br><span class="line">	err2 := s.CreateTable()</span><br><span class="line">	_, err3 := s.Insert(user1, user2)</span><br><span class="line">	<span class="keyword">if</span> err1 != <span class="literal">nil</span> || err2 != <span class="literal">nil</span> || err3 != <span class="literal">nil</span> &#123;</span><br><span class="line">		t.Fatal(<span class="string">&quot;failed init test records&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestSession_Insert</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	s := testRecordInit(t)</span><br><span class="line">	affected, err := s.Insert(user3)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> || affected != <span class="number">1</span> &#123;</span><br><span class="line">		t.Fatal(<span class="string">&quot;failed to create record&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestSession_Find</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	s := testRecordInit(t)</span><br><span class="line">	<span class="keyword">var</span> users []User</span><br><span class="line">	<span class="keyword">if</span> err := s.Find(&amp;users); err != <span class="literal">nil</span> || <span class="built_in">len</span>(users) != <span class="number">2</span> &#123;</span><br><span class="line">		t.Fatal(<span class="string">&quot;failed to query all&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="链式操作与更新删除"><a href="#链式操作与更新删除" class="headerlink" title="链式操作与更新删除"></a>链式操作与更新删除</h2><ul>
<li>通过链式 (chain) 操作，支持查询条件 (where, order by, limit 等) 的叠加。</li>
<li>实现记录的更新 (update)、删除 (delete) 和统计 (count) 功能。</li>
</ul>
<h3 id="支持-Update、Delete-和-Count"><a href="#支持-Update、Delete-和-Count" class="headerlink" title="支持 Update、Delete 和 Count"></a>支持 Update、Delete 和 Count</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	generators = <span class="built_in">make</span>(<span class="keyword">map</span>[Type]generator)</span><br><span class="line">	generators[INSERT] = _insert</span><br><span class="line">	generators[VALUES] = _values</span><br><span class="line">	generators[SELECT] = _select</span><br><span class="line">	generators[LIMIT] = _limit</span><br><span class="line">	generators[WHERE] = _where</span><br><span class="line">	generators[ORDERBY] = _orderBy</span><br><span class="line">	generators[UPDATE] = _update</span><br><span class="line">	generators[DELETE] = _delete</span><br><span class="line">	generators[COUNT] = _count</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> _<span class="title">update</span><span class="params">(values ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(<span class="keyword">string</span>, []<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	tableName := values[<span class="number">0</span>]</span><br><span class="line">	m := values[<span class="number">1</span>].(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">	<span class="keyword">var</span> keys []<span class="keyword">string</span></span><br><span class="line">	<span class="keyword">var</span> vars []<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	<span class="keyword">for</span> k, v := <span class="keyword">range</span> m &#123;</span><br><span class="line">		keys = <span class="built_in">append</span>(keys, k+<span class="string">&quot; = ?&quot;</span>)</span><br><span class="line">		vars = <span class="built_in">append</span>(vars, v)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;UPDATE %s SET %s&quot;</span>, tableName, strings.Join(keys, <span class="string">&quot;, &quot;</span>)), vars</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> _<span class="title">delete</span><span class="params">(values ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(<span class="keyword">string</span>, []<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;DELETE FROM %s&quot;</span>, values[<span class="number">0</span>]), []<span class="keyword">interface</span>&#123;&#125;&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> _<span class="title">count</span><span class="params">(values ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(<span class="keyword">string</span>, []<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> _select(values[<span class="number">0</span>], []<span class="keyword">string</span>&#123;<span class="string">&quot;count(*)&quot;</span>&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>_update</code> 设计入参是 2 个，第一个参数是表名 (table)，第二个参数是 map 类型，表示待更新的键值对。</li>
<li><code>_delete</code> 只有一个入参，即表名。</li>
<li><code>_count</code> 只有一个入参，即表名，并复用了 <code>_select</code> 生成器。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Update 接受 2 种入参，平铺开来的键值对和 map 类型的键值对。</span></span><br><span class="line"><span class="comment">// support map[string]interface&#123;&#125;</span></span><br><span class="line"><span class="comment">// also support kv list: &quot;Name&quot;, &quot;Tom&quot;, &quot;Age&quot;, 18, ....</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Session)</span> <span class="title">Update</span><span class="params">(kv ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(<span class="keyword">int64</span>, error)</span></span> &#123;</span><br><span class="line">	m, ok := kv[<span class="number">0</span>].(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		m = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(kv); i += <span class="number">2</span> &#123;</span><br><span class="line">			m[kv[i].(<span class="keyword">string</span>)] = kv[i+<span class="number">1</span>]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	s.clause.Set(clause.UPDATE, s.RefTable().Name, m)</span><br><span class="line">	sql, vars := s.clause.Build(clause.UPDATE, clause.WHERE)</span><br><span class="line">	result, err := s.Raw(sql, vars...).Exec()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result.RowsAffected()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Delete records with where clause</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Session)</span> <span class="title">Delete</span><span class="params">()</span> <span class="params">(<span class="keyword">int64</span>, error)</span></span> &#123;</span><br><span class="line">	s.clause.Set(clause.DELETE, s.RefTable().Name)</span><br><span class="line">	sql, vars := s.clause.Build(clause.DELETE, clause.WHERE)</span><br><span class="line">	result, err := s.Raw(sql, vars...).Exec()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result.RowsAffected()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Count records with where clause</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Session)</span> <span class="title">Count</span><span class="params">()</span> <span class="params">(<span class="keyword">int64</span>, error)</span></span> &#123;</span><br><span class="line">	s.clause.Set(clause.COUNT, s.RefTable().Name)</span><br><span class="line">	sql, vars := s.clause.Build(clause.COUNT, clause.WHERE)</span><br><span class="line">	row := s.Raw(sql, vars...).QueryRow()</span><br><span class="line">	<span class="keyword">var</span> tmp <span class="keyword">int64</span></span><br><span class="line">	<span class="keyword">if</span> err := row.Scan(&amp;tmp); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> tmp, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="链式调用-chain"><a href="#链式调用-chain" class="headerlink" title="链式调用 (chain)"></a>链式调用 (chain)</h3><p>通常来说，当某个对象需要一次调用多个方法来设置其属性时，就非常适合改造为链式调用了。</p>
<p>SQL 语句的构造过程就非常符合这个条件。SQL 语句由多个子句构成，典型的例如 SELECT 语句，往往需要设置查询条件（WHERE）、限制返回行数（LIMIT）等。理想的调用方式应该是这样的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s := geeorm.NewEngine(<span class="string">&quot;sqlite3&quot;</span>, <span class="string">&quot;gee.db&quot;</span>).NewSession()</span><br><span class="line"><span class="keyword">var</span> users []User</span><br><span class="line">s.Where(<span class="string">&quot;Age &gt; 18&quot;</span>).Limit(<span class="number">3</span>).Find(&amp;users)</span><br></pre></td></tr></table></figure>

<p>从上面的示例中，可以看出，<code>WHERE</code>、<code>LIMIT</code>、<code>ORDER BY</code> 等查询条件语句非常适合链式调用。这几个子句的 generator 在之前就已经实现了，那我们接下来在 <code>session/record.go</code> 中添加对应的方法即可。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Limit adds limit condition to clause</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Session)</span> <span class="title">Limit</span><span class="params">(num <span class="keyword">int</span>)</span> *<span class="title">Session</span></span> &#123;</span><br><span class="line">	s.clause.Set(clause.LIMIT, num)</span><br><span class="line">	<span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Where adds limit condition to clause</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Session)</span> <span class="title">Where</span><span class="params">(desc <span class="keyword">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</span> *<span class="title">Session</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> vars []<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	s.clause.Set(clause.WHERE, <span class="built_in">append</span>(<span class="built_in">append</span>(vars, desc), args...)...)</span><br><span class="line">	<span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// OrderBy adds order by condition to clause</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Session)</span> <span class="title">OrderBy</span><span class="params">(desc <span class="keyword">string</span>)</span> *<span class="title">Session</span></span> &#123;</span><br><span class="line">	s.clause.Set(clause.ORDERBY, desc)</span><br><span class="line">	<span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="First-只返回一条记录"><a href="#First-只返回一条记录" class="headerlink" title="First 只返回一条记录"></a>First 只返回一条记录</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Session)</span> <span class="title">First</span><span class="params">(value <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	dest := reflect.Indirect(reflect.ValueOf(value))</span><br><span class="line">	destSlice := reflect.New(reflect.SliceOf(dest.Type())).Elem()</span><br><span class="line">	<span class="keyword">if</span> err := s.Limit(<span class="number">1</span>).Find(destSlice.Addr().Interface()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> destSlice.Len() == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">&quot;NOT FOUND&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	dest.Set(destSlice.Index(<span class="number">0</span>))</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>测试用例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> session</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;testing&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	user1 = &amp;User&#123;<span class="string">&quot;Tom&quot;</span>, <span class="number">18</span>&#125;</span><br><span class="line">	user2 = &amp;User&#123;<span class="string">&quot;Sam&quot;</span>, <span class="number">25</span>&#125;</span><br><span class="line">	user3 = &amp;User&#123;<span class="string">&quot;Jack&quot;</span>, <span class="number">25</span>&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">testRecordInit</span><span class="params">(t *testing.T)</span> *<span class="title">Session</span></span> &#123;</span><br><span class="line">	t.Helper()</span><br><span class="line">	s := NewSession().Model(&amp;User&#123;&#125;)</span><br><span class="line">	err1 := s.DropTable()</span><br><span class="line">	err2 := s.CreateTable()</span><br><span class="line">	_, err3 := s.Insert(user1, user2)</span><br><span class="line">	<span class="keyword">if</span> err1 != <span class="literal">nil</span> || err2 != <span class="literal">nil</span> || err3 != <span class="literal">nil</span> &#123;</span><br><span class="line">		t.Fatal(<span class="string">&quot;failed init test records&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestSession_Limit</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	s := testRecordInit(t)</span><br><span class="line">	<span class="keyword">var</span> users []User</span><br><span class="line">	err := s.Limit(<span class="number">1</span>).Find(&amp;users)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> || <span class="built_in">len</span>(users) != <span class="number">1</span> &#123;</span><br><span class="line">		t.Fatal(<span class="string">&quot;failed to query with limit condition&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestSession_Update</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	s := testRecordInit(t)</span><br><span class="line">	affected, _ := s.Where(<span class="string">&quot;Name = ?&quot;</span>, <span class="string">&quot;Tom&quot;</span>).Update(<span class="string">&quot;Age&quot;</span>, <span class="number">30</span>)</span><br><span class="line">	u := &amp;User&#123;&#125;</span><br><span class="line">	_ = s.OrderBy(<span class="string">&quot;Age DESC&quot;</span>).First(u)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> affected != <span class="number">1</span> || u.Age != <span class="number">30</span> &#123;</span><br><span class="line">		t.Fatal(<span class="string">&quot;failed to update&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestSession_DeleteAndCount</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	s := testRecordInit(t)</span><br><span class="line">	affected, _ := s.Where(<span class="string">&quot;Name = ?&quot;</span>, <span class="string">&quot;Tom&quot;</span>).Delete()</span><br><span class="line">	count, _ := s.Count()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> affected != <span class="number">1</span> || count != <span class="number">1</span> &#123;</span><br><span class="line">		t.Fatal(<span class="string">&quot;failed to delete or count&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="钩子-Hooks"><a href="#钩子-Hooks" class="headerlink" title="钩子 (Hooks)"></a>钩子 (Hooks)</h2><ul>
<li>通过反射 (reflect) 获取结构体绑定的钩子 (hooks)，并调用。</li>
<li>支持增删查改 (CRUD) 前后调用钩子。</li>
</ul>
<h3 id="Hook-机制"><a href="#Hook-机制" class="headerlink" title="Hook 机制"></a>Hook 机制</h3><p>Hook 主要思想是提前在可能增加功能的地方埋好 (预设) 一个钩子，当我们需要重新修改或者增加这个地方的逻辑的时候，把扩展的类或者方法挂载到这个点即可。</p>
<p>钩子的应用非常广泛，</p>
<ul>
<li>Github 支持的 travis 持续集成服务，当有 <code>git push</code> 事件发生时，会触发 travis 拉取新的代码进行构建。</li>
<li>IDE 中钩子也非常常见，当按下 <code>Ctrl + s</code> 后，自动格式化代码。</li>
<li>前端常用的 <code>hot reload</code> 机制，前端代码发生变更时，自动编译打包，通知浏览器自动刷新页面，实现所写即所得。</li>
</ul>
<p>钩子机制设计的好坏，取决于扩展点选择的是否合适。例如对于持续集成来说，代码如果不发生变更，反复构建是没有意义的，因此钩子应设计在代码可能发生变更的地方，比如 MR、PR 合并前后。</p>
<p>那对于 ORM 框架来说，合适的扩展点在哪里呢？很显然，<strong>记录的增删查改前后</strong>都是非常合适的。</p>
<p>比如，我们设计一个 <code>Account</code> 类，<code>Account</code> 包含有一个隐私字段 <code>Password</code>，那么每次查询后都需要做脱敏处理，才能继续使用。如果提供了 <code>AfterQuery</code> 的钩子，查询后，自动地将 <code>Password</code> 字段的值脱敏，是不是能省去很多冗余的代码呢？</p>
<h3 id="实现钩子"><a href="#实现钩子" class="headerlink" title="实现钩子"></a>实现钩子</h3><p>GeeORM 的钩子与结构体绑定，即每个结构体需要实现各自的钩子。</p>
<p>钩子机制同样是通过反射来实现的，<code>s.RefTable().Model</code> 或 <code>value</code> 即当前会话正在操作的对象，使用 <code>MethodByName</code> 方法反射得到该对象的方法。</p>
<p>将 <code>s *Session</code> 作为入参调用。每一个钩子的入参类型均是 <code>*Session</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> session</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;geeorm/log&quot;</span></span><br><span class="line">	<span class="string">&quot;reflect&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hooks constants</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	BeforeQuery  = <span class="string">&quot;BeforeQuery&quot;</span></span><br><span class="line">	AfterQuery   = <span class="string">&quot;AfterQuery&quot;</span></span><br><span class="line">	BeforeUpdate = <span class="string">&quot;BeforeUpdate&quot;</span></span><br><span class="line">	AfterUpdate  = <span class="string">&quot;AfterUpdate&quot;</span></span><br><span class="line">	BeforeDelete = <span class="string">&quot;BeforeDelete&quot;</span></span><br><span class="line">	AfterDelete  = <span class="string">&quot;AfterDelete&quot;</span></span><br><span class="line">	BeforeInsert = <span class="string">&quot;BeforeInsert&quot;</span></span><br><span class="line">	AfterInsert  = <span class="string">&quot;AfterInsert&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// CallMethod calls the registered hooks</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Session)</span> <span class="title">CallMethod</span><span class="params">(method <span class="keyword">string</span>, value <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	fm := reflect.ValueOf(s.RefTable().Model).MethodByName(method)</span><br><span class="line">	<span class="keyword">if</span> value != <span class="literal">nil</span> &#123;</span><br><span class="line">		fm = reflect.ValueOf(value).MethodByName(method)</span><br><span class="line">	&#125;</span><br><span class="line">	param := []reflect.Value&#123;reflect.ValueOf(s)&#125;</span><br><span class="line">	<span class="keyword">if</span> fm.IsValid() &#123;</span><br><span class="line">		<span class="keyword">if</span> v := fm.Call(param); <span class="built_in">len</span>(v) &gt; <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err, ok := v[<span class="number">0</span>].Interface().(error); ok &#123;</span><br><span class="line">				log.Error(err)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来，将 <code>CallMethod()</code> 方法在 Find、Insert、Update、Delete 方法内部调用即可。例如，<code>Insert</code> 方法修改为：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Insert one or more records in database</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Session)</span> <span class="title">Insert</span><span class="params">(values ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(<span class="keyword">int64</span>, error)</span></span> &#123;</span><br><span class="line">	recordValues := <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">for</span> _, value := <span class="keyword">range</span> values &#123;</span><br><span class="line">		s.CallMethod(BeforeInsert, value)</span><br><span class="line">		table := s.Model(value).RefTable()</span><br><span class="line">		s.clause.Set(clause.INSERT, table.Name, table.FieldNames)</span><br><span class="line">		recordValues = <span class="built_in">append</span>(recordValues, table.RecordValues(value))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	s.clause.Set(clause.VALUES, recordValues...)</span><br><span class="line">	sql, vars := s.clause.Build(clause.INSERT, clause.VALUES)</span><br><span class="line">	result, err := s.Raw(sql, vars...).Exec()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	s.CallMethod(AfterInsert, <span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">return</span> result.RowsAffected()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>测试用例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> session</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;geeorm/log&quot;</span></span><br><span class="line">	<span class="string">&quot;testing&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Account <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID       <span class="keyword">int</span> <span class="string">`geeorm:&quot;PRIMARY KEY&quot;`</span></span><br><span class="line">	Password <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(account *Account)</span> <span class="title">BeforeInsert</span><span class="params">(s *Session)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	log.Info(<span class="string">&quot;before inert&quot;</span>, account)</span><br><span class="line">	account.ID += <span class="number">1000</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(account *Account)</span> <span class="title">AfterQuery</span><span class="params">(s *Session)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	log.Info(<span class="string">&quot;after query&quot;</span>, account)</span><br><span class="line">	account.Password = <span class="string">&quot;******&quot;</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestSession_CallMethod</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	s := NewSession().Model(&amp;Account&#123;&#125;)</span><br><span class="line">	_ = s.DropTable()</span><br><span class="line">	_ = s.CreateTable()</span><br><span class="line">	_, _ = s.Insert(&amp;Account&#123;<span class="number">1</span>, <span class="string">&quot;123456&quot;</span>&#125;, &amp;Account&#123;<span class="number">2</span>, <span class="string">&quot;qwerty&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">	u := &amp;Account&#123;&#125;</span><br><span class="line"></span><br><span class="line">	err := s.First(u)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> || u.ID != <span class="number">1001</span> || u.Password != <span class="string">&quot;******&quot;</span> &#123;</span><br><span class="line">		t.Fatal(<span class="string">&quot;Failed to call hooks after query, got&quot;</span>, u)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="支持事务-Transaction"><a href="#支持事务-Transaction" class="headerlink" title="支持事务 (Transaction)"></a>支持事务 (Transaction)</h2><h3 id="SQLite-和-Go-标准库中的事务"><a href="#SQLite-和-Go-标准库中的事务" class="headerlink" title="SQLite 和 Go 标准库中的事务"></a>SQLite 和 Go 标准库中的事务</h3><p>SQLite 中创建一个事务的原生 SQL：<code>BEGIN</code> 开启事务，<code>COMMIT</code> 提交事务，<code>ROLLBACK</code> 回滚事务。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BEGIN;</span><br><span class="line">DELETE FROM User WHERE Age &gt; 25;</span><br><span class="line">INSERT INTO User VALUES (&quot;Tom&quot;, 25), (&quot;Jack&quot;, 18);</span><br><span class="line">COMMIT;</span><br></pre></td></tr></table></figure>

<p>任何一个事务，均以 <code>BEGIN</code> 开始，<code>COMMIT</code> 或 <code>ROLLBACK</code> 结束。</p>
<p>Go 语言标准库 database/sql 提供了支持事务的接口。Go 语言中实现事务和 SQL 原生语句其实是非常接近的。调用 <code>db.Begin()</code> 得到 <code>*sql.Tx</code> 对象，使用 <code>tx.Exec()</code> 执行一系列操作，如果发生错误，通过 <code>tx.Rollback()</code> 回滚，如果没有发生错误，则通过 <code>tx.Commit()</code> 提交。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;database/sql&quot;</span></span><br><span class="line">	_ <span class="string">&quot;github.com/mattn/go-sqlite3&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	db, _ := sql.Open(<span class="string">&quot;sqlite3&quot;</span>, <span class="string">&quot;gee.db&quot;</span>)</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; _ = db.Close() &#125;()</span><br><span class="line">	_, _ = db.Exec(<span class="string">&quot;CREATE TABLE IF NOT EXISTS User(`Name` text);&quot;</span>)</span><br><span class="line"></span><br><span class="line">	tx, _ := db.Begin()</span><br><span class="line">	_, err1 := tx.Exec(<span class="string">&quot;INSERT INTO User(`Name`) VALUES (?)&quot;</span>, <span class="string">&quot;Tom&quot;</span>)</span><br><span class="line">	_, err2 := tx.Exec(<span class="string">&quot;INSERT INTO User(`Name`) VALUES (?)&quot;</span>, <span class="string">&quot;Jack&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err1 != <span class="literal">nil</span> || err2 != <span class="literal">nil</span> &#123;</span><br><span class="line">		_ = tx.Rollback()</span><br><span class="line">		log.Println(<span class="string">&quot;Rollback&quot;</span>, err1, err2)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		_ = tx.Commit()</span><br><span class="line">		log.Println(<span class="string">&quot;Commit&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="支持事务"><a href="#支持事务" class="headerlink" title="支持事务"></a>支持事务</h3><p>GeeORM 之前的操作均是执行完即自动提交的，每个操作是相互独立的。</p>
<p>之前直接使用 <code>sql.DB</code> 对象执行 SQL 语句，如果要支持事务，需要更改为 <code>sql.Tx</code> 执行。</p>
<p>在 Session 结构体中新增成员变量 <code>tx *sql.Tx</code>，当 <code>tx</code> 不为空时，则使用 <code>tx</code> 执行 SQL 语句，否则使用 <code>db</code> 执行 SQL 语句。这样既兼容了原有的执行方式，又提供了对事务的支持。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Session <span class="keyword">struct</span> &#123;</span><br><span class="line">	db       *sql.DB</span><br><span class="line">	dialect  dialect.Dialect</span><br><span class="line">	tx       *sql.Tx</span><br><span class="line">	refTable *schema.Schema</span><br><span class="line">	clause   clause.Clause</span><br><span class="line">	sql      strings.Builder</span><br><span class="line">	sqlVars  []<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CommonDB is a minimal function set of db</span></span><br><span class="line"><span class="keyword">type</span> CommonDB <span class="keyword">interface</span> &#123;</span><br><span class="line">	Query(query <span class="keyword">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;) (*sql.Rows, error)</span><br><span class="line">	QueryRow(query <span class="keyword">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;) *sql.Row</span><br><span class="line">	Exec(query <span class="keyword">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;) (sql.Result, error)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _ CommonDB = (*sql.DB)(<span class="literal">nil</span>)</span><br><span class="line"><span class="keyword">var</span> _ CommonDB = (*sql.Tx)(<span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// DB returns tx if a tx begins. otherwise return *sql.DB</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Session)</span> <span class="title">DB</span><span class="params">()</span> <span class="title">CommonDB</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> s.tx != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> s.tx</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> s.db</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用 <code>s.db.Begin()</code> 得到 <code>*sql.Tx</code> 对象，赋值给 s.tx。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Session)</span> <span class="title">Begin</span><span class="params">()</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	log.Info(<span class="string">&quot;transaction begin&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> s.tx, err = s.db.Begin(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Error(err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Session)</span> <span class="title">Commit</span><span class="params">()</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	log.Info(<span class="string">&quot;transaction commit&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err = s.tx.Commit(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Error(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Session)</span> <span class="title">Rollback</span><span class="params">()</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	log.Info(<span class="string">&quot;transaction rollback&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err = s.tx.Rollback(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Error(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为用户提供傻瓜式 / 一键式使用的接口：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> TxFunc <span class="function"><span class="keyword">func</span><span class="params">(*session.Session)</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(engine *Engine)</span> <span class="title">Transaction</span><span class="params">(f TxFunc)</span> <span class="params">(result <span class="keyword">interface</span>&#123;&#125;, err error)</span></span> &#123;</span><br><span class="line">	s := engine.NewSession()</span><br><span class="line">	<span class="keyword">if</span> err := s.Begin(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> p := <span class="built_in">recover</span>(); p != <span class="literal">nil</span> &#123;</span><br><span class="line">			_ = s.Rollback()</span><br><span class="line">			<span class="built_in">panic</span>(p) <span class="comment">// re-throw panic after Rollback</span></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			_ = s.Rollback() <span class="comment">// err is non-nil; don&#x27;t change it</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			err = s.Commit() <span class="comment">// err is nil; if Commit returns error update err</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> f(s)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>测试用例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">OpenDB</span><span class="params">(t *testing.T)</span> *<span class="title">Engine</span></span> &#123;</span><br><span class="line">	t.Helper()</span><br><span class="line">	engine, err := NewEngine(<span class="string">&quot;sqlite3&quot;</span>, <span class="string">&quot;gee.db&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		t.Fatal(<span class="string">&quot;failed to connect&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> engine</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name <span class="keyword">string</span> <span class="string">`geeorm:&quot;PRIMARY KEY&quot;`</span></span><br><span class="line">	Age  <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestEngine_Transaction</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	t.Run(<span class="string">&quot;rollback&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">		transactionRollback(t)</span><br><span class="line">	&#125;)</span><br><span class="line">	t.Run(<span class="string">&quot;commit&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">		transactionCommit(t)</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">transactionRollback</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	engine := OpenDB(t)</span><br><span class="line">	<span class="keyword">defer</span> engine.Close()</span><br><span class="line">	s := engine.NewSession()</span><br><span class="line">	_ = s.Model(&amp;User&#123;&#125;).DropTable()</span><br><span class="line">	_, err := engine.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(s *session.Session)</span> <span class="params">(result <span class="keyword">interface</span>&#123;&#125;, err error)</span></span> &#123;</span><br><span class="line">		_ = s.Model(&amp;User&#123;&#125;).CreateTable()</span><br><span class="line">		_, err = s.Insert(&amp;User&#123;<span class="string">&quot;Tom&quot;</span>, <span class="number">18</span>&#125;)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;Error&quot;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> || s.HasTable() &#123;</span><br><span class="line">		t.Fatal(<span class="string">&quot;failed to rollback&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">transactionCommit</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	engine := OpenDB(t)</span><br><span class="line">	<span class="keyword">defer</span> engine.Close()</span><br><span class="line">	s := engine.NewSession()</span><br><span class="line">	_ = s.Model(&amp;User&#123;&#125;).DropTable()</span><br><span class="line">	_, err := engine.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(s *session.Session)</span> <span class="params">(result <span class="keyword">interface</span>&#123;&#125;, err error)</span></span> &#123;</span><br><span class="line">		_ = s.Model(&amp;User&#123;&#125;).CreateTable()</span><br><span class="line">		_, err = s.Insert(&amp;User&#123;<span class="string">&quot;Tom&quot;</span>, <span class="number">18</span>&#125;)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;)</span><br><span class="line">	u := &amp;User&#123;&#125;</span><br><span class="line">	_ = s.First(u)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> || u.Name != <span class="string">&quot;Tom&quot;</span> &#123;</span><br><span class="line">		t.Fatal(<span class="string">&quot;failed to commit&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="数据库迁移-Migrate"><a href="#数据库迁移-Migrate" class="headerlink" title="数据库迁移 (Migrate)"></a>数据库迁移 (Migrate)</h2><ul>
<li>结构体 (struct) 变更时，数据库表的字段 (field) 自动迁移 (migrate)。</li>
<li>仅支持字段新增与删除，不支持字段类型变更。</li>
</ul>
<h3 id="使用-SQL-语句-Migrate"><a href="#使用-SQL-语句-Migrate" class="headerlink" title="使用 SQL 语句 Migrate"></a>使用 SQL 语句 Migrate</h3><p>我们先看看如何使用原生的 SQL 语句的 Migrate。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-- 使用 `ALTER` 关键字新增字段，或者重命名字段。</span><br><span class="line">ALTER TABLE table_name ADD COLUMN col_name, col_type;</span><br><span class="line"></span><br><span class="line">-- 删除字段</span><br><span class="line">-- 第一步：从 old_table 中挑选需要保留的字段到 new_table 中。</span><br><span class="line">-- 第二步：删除 old_table。</span><br><span class="line">-- 第三步：重命名 new_table 为 old_table。</span><br><span class="line">CREATE TABLE new_table AS SELECT col1, col2, ... from old_table</span><br><span class="line">DROP TABLE old_table</span><br><span class="line">ALTER TABLE new_table RENAME TO old_table;</span><br></pre></td></tr></table></figure>



<h3 id="实现-Migrate"><a href="#实现-Migrate" class="headerlink" title="实现 Migrate"></a>实现 Migrate</h3><ul>
<li><code>difference</code> 用来计算前后两个字段切片的差集。新表 - 旧表 = 新增字段，旧表 - 新表 = 删除字段。</li>
<li>使用 <code>ALTER</code> 语句新增字段。</li>
<li>使用创建新表并重命名的方式删除字段。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// difference returns a - b</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">difference</span><span class="params">(a []<span class="keyword">string</span>, b []<span class="keyword">string</span>)</span> <span class="params">(diff []<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	mapB := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span>)</span><br><span class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> b &#123;</span><br><span class="line">		mapB[v] = <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> a &#123;</span><br><span class="line">		<span class="keyword">if</span> _, ok := mapB[v]; !ok &#123;</span><br><span class="line">			diff = <span class="built_in">append</span>(diff, v)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Migrate table</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(engine *Engine)</span> <span class="title">Migrate</span><span class="params">(value <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	_, err := engine.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(s *session.Session)</span> <span class="params">(result <span class="keyword">interface</span>&#123;&#125;, err error)</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> !s.Model(value).HasTable() &#123;</span><br><span class="line">			log.Infof(<span class="string">&quot;table %s doesn&#x27;t exist&quot;</span>, s.RefTable().Name)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, s.CreateTable()</span><br><span class="line">		&#125;</span><br><span class="line">		table := s.RefTable()</span><br><span class="line">		rows, _ := s.Raw(fmt.Sprintf(<span class="string">&quot;SELECT * FROM %s LIMIT 1&quot;</span>, table.Name)).QueryRows()</span><br><span class="line">		columns, _ := rows.Columns()</span><br><span class="line">		addCols := difference(table.FieldNames, columns)</span><br><span class="line">		delCols := difference(columns, table.FieldNames)</span><br><span class="line">		log.Infof(<span class="string">&quot;added cols %v, deleted cols %v&quot;</span>, addCols, delCols)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> _, col := <span class="keyword">range</span> addCols &#123;</span><br><span class="line">			f := table.GetField(col)</span><br><span class="line">			sqlStr := fmt.Sprintf(<span class="string">&quot;ALTER TABLE %s ADD COLUMN %s %s;&quot;</span>, table.Name, f.Name, f.Type)</span><br><span class="line">			<span class="keyword">if</span> _, err = s.Raw(sqlStr).Exec(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(delCols) == <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		tmp := <span class="string">&quot;tmp_&quot;</span> + table.Name</span><br><span class="line">		fieldStr := strings.Join(table.FieldNames, <span class="string">&quot;, &quot;</span>)</span><br><span class="line">		s.Raw(fmt.Sprintf(<span class="string">&quot;CREATE TABLE %s AS SELECT %s from %s;&quot;</span>, tmp, fieldStr, table.Name))</span><br><span class="line">		s.Raw(fmt.Sprintf(<span class="string">&quot;DROP TABLE %s;&quot;</span>, table.Name))</span><br><span class="line">		s.Raw(fmt.Sprintf(<span class="string">&quot;ALTER TABLE %s RENAME TO %s;&quot;</span>, tmp, table.Name))</span><br><span class="line">		_, err = s.Exec()</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>测试用例：</p>
<ul>
<li>首先假设原有的 <code>User</code> 包含两个字段 <code>Name</code> 和 <code>XXX</code>，在一次业务变更之后，<code>User</code> 结构体的字段变更为 <code>Name</code> 和 <code>Age</code>。</li>
<li>即需要删除原有字段 <code>XXX</code>，并新增字段 <code>Age</code>。</li>
<li>调用 <code>Migrate(&amp;User&#123;&#125;)</code> 之后，新表的结构为 <code>Name</code>，<code>Age</code></li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name <span class="keyword">string</span> <span class="string">`geeorm:&quot;PRIMARY KEY&quot;`</span></span><br><span class="line">	Age  <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestEngine_Migrate</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	engine := OpenDB(t)</span><br><span class="line">	<span class="keyword">defer</span> engine.Close()</span><br><span class="line">	s := engine.NewSession()</span><br><span class="line">	_, _ = s.Raw(<span class="string">&quot;DROP TABLE IF EXISTS User;&quot;</span>).Exec()</span><br><span class="line">	_, _ = s.Raw(<span class="string">&quot;CREATE TABLE User(Name text PRIMARY KEY, XXX integer);&quot;</span>).Exec()</span><br><span class="line">	_, _ = s.Raw(<span class="string">&quot;INSERT INTO User(`Name`) values (?), (?)&quot;</span>, <span class="string">&quot;Tom&quot;</span>, <span class="string">&quot;Sam&quot;</span>).Exec()</span><br><span class="line">	engine.Migrate(&amp;User&#123;&#125;)</span><br><span class="line"></span><br><span class="line">	rows, _ := s.Raw(<span class="string">&quot;SELECT * FROM User&quot;</span>).QueryRows()</span><br><span class="line">	columns, _ := rows.Columns()</span><br><span class="line">	<span class="keyword">if</span> !reflect.DeepEqual(columns, []<span class="keyword">string</span>&#123;<span class="string">&quot;Name&quot;</span>, <span class="string">&quot;Age&quot;</span>&#125;) &#123;</span><br><span class="line">		t.Fatal(<span class="string">&quot;Failed to migrate table User, got columns&quot;</span>, columns)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h1><ul>
<li><a target="_blank" rel="noopener" href="https://geektutu.com/post/geeorm.html">7 天用 Go 从零实现 ORM 框架 GeeORM</a></li>
</ul>
</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>