<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;数据库预编译起源&quot;&gt;&lt;a href=&quot;#数据库预编译起源&quot; class=&quot;headerlink&quot; title=&quot;数据库预编译起源&quot;&gt;&lt;/a&gt;数据库预编译起源&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;数据库 SQL 语句编译特性：数据库接受到 sql 语句之后，需要词法和语义解析，优化 sql 语句，制定执行计划。这需要花费一些时间。但是很多情况，我们的一条 sql 语句可能会反复执行，或者&lt;strong&gt;每次执行的时候只有个别的值不同&lt;/strong&gt;（比如 query 的 where 子句值不同，update 的 set 子句值不同，insert 的 values 值不同）。&lt;/li&gt;
&lt;li&gt;减少编译的方法：如果每次都需要经过上面的词法语义解析、语句优化、制定执行计划等，则效率就明显不行了。为了解决上面的问题，于是就有了&lt;code&gt;预编译&lt;/code&gt;，预编译语句就是将这类语句中的&lt;strong&gt;值用占位符替代&lt;/strong&gt;，可以视为将 &lt;code&gt;sql 语句模板化&lt;/code&gt;或者说&lt;code&gt;参数化&lt;/code&gt;。一次编译、多次运行，省去了解析优化等过程。&lt;/li&gt;
&lt;li&gt;缓存预编译：预编译语句被 DB 的编译器编译后的执行代码被缓存下来，那么下次调用时只要是相同的预编译语句就不需要编译，只要将参数直接传入编译过的语句执行代码中 (相当于一个函数) 就会得到执行。 &lt;strong&gt;并不是所有预编译语句都一定会被缓存&lt;/strong&gt;，数据库本身会用一种策略（内部机制）。&lt;/li&gt;
&lt;li&gt;预编译的实现方法：预编译是通过 PreparedStatement 和占位符来实现的。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;预编译作用&quot;&gt;&lt;a href=&quot;#预编译作用&quot; class=&quot;headerlink&quot; title=&quot;预编译作用&quot;&gt;&lt;/a&gt;预编译作用&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;预编译阶段可以优化 sql 的执行：预编译之后的 sql 多数情况下可以直接执行，DBMS 不需要再次编译，越复杂的 sql，编译的复杂度将越大，预编译阶段可以合并多次操作为一个操作。可以提升性能。&lt;/li&gt;
&lt;li&gt;防止 SQL 注入：使用预编译，而其后注入的参数将&lt;code&gt;不会再进行SQL编译&lt;/code&gt;。也就是说其后注入进来的参数系统将不会认为它会是一条 SQL 语句，而默认其是&lt;code&gt;一个参数&lt;/code&gt;，参数中的 or 或者 and 等就不是 SQL 语法保留字了。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;预处理&quot;&gt;&lt;a href=&quot;#预处理&quot; class=&quot;headerlink&quot; title=&quot;预处理&quot;&gt;&lt;/a&gt;预处理&lt;/h2&gt;&lt;p&gt;预处理是 MySQL 为了防止客户端频繁请求的一种技术，是对相同处理语句进行预先加载在 MySQL 中，将操作变量数据用占位符来代替，减少对 MySQL 的频繁请求，使得服务器高效运行。"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>SQL预编译 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/MySQL/" rel="tag">MySQL</a></div><div class="post-time">2022-03-11</div></div></div><div class="container post-header"><h1>SQL预编译</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E9%A2%84%E7%BC%96%E8%AF%91%E8%B5%B7%E6%BA%90"><span class="toc-number">1.</span> <span class="toc-text">数据库预编译起源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%84%E7%BC%96%E8%AF%91%E4%BD%9C%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">预编译作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%84%E5%A4%84%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">预处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%84%E5%A4%84%E7%90%86%E4%BC%98%E7%82%B9"><span class="toc-number">4.</span> <span class="toc-text">预处理优点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Go-%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.</span> <span class="toc-text">Go 语言实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%84%E5%A4%84%E7%90%86%E6%9F%A5%E8%AF%A2%E7%A4%BA%E4%BE%8B"><span class="toc-number">5.1.</span> <span class="toc-text">预处理查询示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%84%E5%A4%84%E7%90%86%E6%9B%B4%E6%96%B0%E7%A4%BA%E4%BE%8B"><span class="toc-number">5.2.</span> <span class="toc-text">预处理更新示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%84%E5%A4%84%E7%90%86%E6%8F%92%E5%85%A5%E7%A4%BA%E4%BE%8B"><span class="toc-number">5.3.</span> <span class="toc-text">预处理插入示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%84%E5%A4%84%E7%90%86%E5%88%A0%E9%99%A4%E7%A4%BA%E4%BE%8B"><span class="toc-number">5.4.</span> <span class="toc-text">预处理删除示例</span></a></li></ol></li></ol></details></div><div class="container post-content"><h2 id="数据库预编译起源"><a href="#数据库预编译起源" class="headerlink" title="数据库预编译起源"></a>数据库预编译起源</h2><ul>
<li>数据库 SQL 语句编译特性：数据库接受到 sql 语句之后，需要词法和语义解析，优化 sql 语句，制定执行计划。这需要花费一些时间。但是很多情况，我们的一条 sql 语句可能会反复执行，或者<strong>每次执行的时候只有个别的值不同</strong>（比如 query 的 where 子句值不同，update 的 set 子句值不同，insert 的 values 值不同）。</li>
<li>减少编译的方法：如果每次都需要经过上面的词法语义解析、语句优化、制定执行计划等，则效率就明显不行了。为了解决上面的问题，于是就有了<code>预编译</code>，预编译语句就是将这类语句中的<strong>值用占位符替代</strong>，可以视为将 <code>sql 语句模板化</code>或者说<code>参数化</code>。一次编译、多次运行，省去了解析优化等过程。</li>
<li>缓存预编译：预编译语句被 DB 的编译器编译后的执行代码被缓存下来，那么下次调用时只要是相同的预编译语句就不需要编译，只要将参数直接传入编译过的语句执行代码中 (相当于一个函数) 就会得到执行。 <strong>并不是所有预编译语句都一定会被缓存</strong>，数据库本身会用一种策略（内部机制）。</li>
<li>预编译的实现方法：预编译是通过 PreparedStatement 和占位符来实现的。</li>
</ul>
<h2 id="预编译作用"><a href="#预编译作用" class="headerlink" title="预编译作用"></a>预编译作用</h2><ul>
<li>预编译阶段可以优化 sql 的执行：预编译之后的 sql 多数情况下可以直接执行，DBMS 不需要再次编译，越复杂的 sql，编译的复杂度将越大，预编译阶段可以合并多次操作为一个操作。可以提升性能。</li>
<li>防止 SQL 注入：使用预编译，而其后注入的参数将<code>不会再进行SQL编译</code>。也就是说其后注入进来的参数系统将不会认为它会是一条 SQL 语句，而默认其是<code>一个参数</code>，参数中的 or 或者 and 等就不是 SQL 语法保留字了。</li>
</ul>
<h2 id="预处理"><a href="#预处理" class="headerlink" title="预处理"></a>预处理</h2><p>预处理是 MySQL 为了防止客户端频繁请求的一种技术，是对相同处理语句进行预先加载在 MySQL 中，将操作变量数据用占位符来代替，减少对 MySQL 的频繁请求，使得服务器高效运行。</p>
<p>在这里客户端并不是前台后台之间的 C/S 架构，而是后台程序对数据库服务器进行操作的 C/S 架构，这样就可以简要地理解了后台程序作为 Client 向 MySQL Server 请求并处理结果了。</p>
<p>普通 SQL 执行处理过程：</p>
<ol>
<li>在客户端准备 SQL 语句；</li>
<li>发送 SQL 语句到 MySQL 服务器；</li>
<li>在 MySQL 服务器执行该 SQL 语句；</li>
<li>服务器将执行结果返回给客户端。</li>
</ol>
<p>预处理执行处理过程：</p>
<ol>
<li>将 SQL 拆分为<strong>结构部分与数据部分</strong>；</li>
<li>在执行 SQL 语句的时候，首先将前面相同的命令和结构部分发送给 MySQL 服务器，让 MySQL 服务器事先进行一次预处理（此时并没有真正的执行 SQL 语句）；</li>
<li>为了保证 SQL 语句的结构完整性，在第一次发送 SQL 语句的时候将其中可变的数据部分都用一个数据占位符来表示；</li>
<li>然后把数据部分发送给 MySQL 服务端，MySQL 服务端对 SQL 语句进行占位符替换；</li>
<li>MySQL 服务端执行完整的 SQL 语句并将结果返回给客户端。</li>
</ol>
<h2 id="预处理优点"><a href="#预处理优点" class="headerlink" title="预处理优点"></a>预处理优点</h2><ul>
<li>预处理语句大大<strong>减少了分析时间</strong>，只做了一次查询（虽然语句多次执行）；</li>
<li>绑定参数<strong>减少了服务器带宽</strong>，只需发送查询的参数，而不是整个语句；</li>
<li>预处理语句针对 <strong>SQL 注入</strong>是非常有用的，因为参数值发送后使用不同的协议，保证了数据的合法性。</li>
</ul>
<h2 id="Go-语言实现"><a href="#Go-语言实现" class="headerlink" title="Go 语言实现"></a>Go 语言实现</h2><p>在 Go 语言中，使用 <code>db.Prepare()</code> 方法实现预处理：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span> <span class="title">Prepare</span><span class="params">(query <span class="keyword">string</span>)</span> <span class="params">(*Stmt, error)</span></span></span><br></pre></td></tr></table></figure>

<p>Prepare 执行预处理 SQL 语句，并返回 Stmt 结构体指针，进行数据绑定操作。</p>
<p>查询操作使用 <code>db.Prepare()</code> 方法声明预处理 SQL，使用 <code>stmt.Query()</code> 将数据替换占位符进行查询，更新、插入、删除操作使用 <code>stmt.Exec()</code> 来操作。</p>
<h3 id="预处理查询示例"><a href="#预处理查询示例" class="headerlink" title="预处理查询示例"></a>预处理查询示例</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 预处理查询数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">prepareQuery</span><span class="params">()</span></span> &#123;</span><br><span class="line">    sqlStr := <span class="string">&quot;SELECT id,name,age FROM user WHERE id &gt; ?&quot;</span></span><br><span class="line">    stmt, err := db.Prepare(sqlStr)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;prepare sql failed, err:%v\n&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    rows, err := stmt.Query(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;exec failed, err:%v\n&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> rows.Close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line">        <span class="keyword">var</span> u user</span><br><span class="line">        err := rows.Scan(&amp;u.id, &amp;u.name, &amp;u.age)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Printf(<span class="string">&quot;scan data failed, err:%v\n&quot;</span>, err)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;id:%d, name:%s, age:%d\n&quot;</span>, u.id, u.name, u.age)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="预处理更新示例"><a href="#预处理更新示例" class="headerlink" title="预处理更新示例"></a>预处理更新示例</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 预处理更新数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">prepareUpdate</span><span class="params">()</span></span> &#123;</span><br><span class="line">    sqlStr := <span class="string">&quot;UPDATE user SET age = ? WHERE id = ?&quot;</span></span><br><span class="line">    stmt, err := db.Prepare(sqlStr)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;prepare sql failed, err:%v\n&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    _, err = stmt.Exec(<span class="number">18</span>, <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;exec failed, err:%v\n&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;prepare update data success&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="预处理插入示例"><a href="#预处理插入示例" class="headerlink" title="预处理插入示例"></a>预处理插入示例</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 预处理更新数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">prepareUpdate</span><span class="params">()</span></span> &#123;</span><br><span class="line">    sqlStr := <span class="string">&quot;UPDATE user SET age = ? WHERE id = ?&quot;</span></span><br><span class="line">    stmt, err := db.Prepare(sqlStr)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;prepare sql failed, err:%v\n&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    _, err = stmt.Exec(<span class="number">18</span>, <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;exec failed, err:%v\n&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;prepare update data success&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="预处理删除示例"><a href="#预处理删除示例" class="headerlink" title="预处理删除示例"></a>预处理删除示例</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 预处理删除数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">prepareDelete</span><span class="params">()</span></span> &#123;</span><br><span class="line">    sqlStr := <span class="string">&quot;DELETE FROM user WHERE id = ?&quot;</span></span><br><span class="line">    stmt, err := db.Prepare(sqlStr)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;prepare sql failed, err:%v\n&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    result, err := stmt.Exec(<span class="number">3</span>)</span><br><span class="line">    n, err := result.RowsAffected()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;delete rows failed, err:%v\n&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> n &gt; <span class="number">0</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;delete data success&quot;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;delete data error&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>