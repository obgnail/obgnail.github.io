<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;物理机搭建环境&quot;&gt;&lt;a href=&quot;#物理机搭建环境&quot; class=&quot;headerlink&quot; title=&quot;物理机搭建环境&quot;&gt;&lt;/a&gt;物理机搭建环境&lt;/h2&gt;&lt;p&gt;流程："><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>MySQL5.7集群管理 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/MySQL/" rel="tag">MySQL</a></div><div class="post-time">2022-03-02</div></div></div><div class="container post-header"><h1>MySQL5.7集群管理</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%A9%E7%90%86%E6%9C%BA%E6%90%AD%E5%BB%BA%E7%8E%AF%E5%A2%83"><span class="toc-number">1.</span> <span class="toc-text">物理机搭建环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E7%94%A8binlog"><span class="toc-number">1.1.</span> <span class="toc-text">启用binlog</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#master"><span class="toc-number">1.1.1.</span> <span class="toc-text">master</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#slave"><span class="toc-number">1.1.2.</span> <span class="toc-text">slave</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%A4%8D%E5%88%B6%E4%B8%93%E7%94%A8%E8%B4%A6%E5%8F%B7-%E5%8F%AF%E9%80%89"><span class="toc-number">1.2.</span> <span class="toc-text">创建复制专用账号(可选)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-Salve-%E7%AB%AF%E7%9A%84%E8%BF%9E%E6%8E%A5"><span class="toc-number">1.3.</span> <span class="toc-text">配置 Salve 端的连接</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8docker%E6%90%AD%E5%BB%BA%E7%8E%AF%E5%A2%83"><span class="toc-number">2.</span> <span class="toc-text">使用docker搭建环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E7%BA%BF%E7%A8%8B"><span class="toc-number">3.</span> <span class="toc-text">主从服务器的线程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">4.</span> <span class="toc-text">常用命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E5%85%B3%E9%94%AE%E5%9B%A0%E7%B4%A0%E5%8F%8A%E5%8E%9F%E7%90%86"><span class="toc-number">5.</span> <span class="toc-text">复制关键因素及原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E6%A0%BC%E5%BC%8F"><span class="toc-number">5.1.</span> <span class="toc-text">复制格式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SBR%E4%B8%8ERBR%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-number">5.1.1.</span> <span class="toc-text">SBR与RBR的优缺点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF%E4%B8%BE%E4%BE%8B"><span class="toc-number">5.1.2.</span> <span class="toc-text">场景举例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E7%BB%A7%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6"><span class="toc-number">5.2.</span> <span class="toc-text">中继日志文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%B0%E7%9A%84%E4%B8%AD%E7%BB%A7%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E7%9A%84%E6%97%B6%E6%9C%BA"><span class="toc-number">5.2.1.</span> <span class="toc-text">创建新的中继日志文件的时机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E4%B8%AD%E7%BB%A7%E6%97%A5%E5%BF%97"><span class="toc-number">5.2.2.</span> <span class="toc-text">为什么需要中继日志</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E6%96%87%E4%BB%B6"><span class="toc-number">5.3.</span> <span class="toc-text">状态文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#master-info"><span class="toc-number">5.3.1.</span> <span class="toc-text">master.info</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#relay-log-info"><span class="toc-number">5.3.2.</span> <span class="toc-text">relay-log.info</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86"><span class="toc-number">5.4.</span> <span class="toc-text">复制原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E8%BF%87%E6%BB%A4%E8%A7%84%E5%88%99"><span class="toc-number">6.</span> <span class="toc-text">复制过滤规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E6%96%B9%E5%BC%8F"><span class="toc-number">7.</span> <span class="toc-text">复制方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E5%A4%8D%E5%88%B6"><span class="toc-number">7.1.</span> <span class="toc-text">异步复制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6"><span class="toc-number">7.2.</span> <span class="toc-text">同步复制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%8A%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6"><span class="toc-number">7.3.</span> <span class="toc-text">半同步复制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E6%8D%9F%E5%A4%8D%E5%88%B6"><span class="toc-number">7.4.</span> <span class="toc-text">无损复制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AFTER-COMMIT"><span class="toc-number">7.4.1.</span> <span class="toc-text">AFTER_COMMIT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AFTER-SYNC"><span class="toc-number">7.4.2.</span> <span class="toc-text">AFTER_SYNC</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%8A%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6%E4%B8%8E%E6%97%A0%E6%8D%9F%E5%A4%8D%E5%88%B6%E7%9A%84%E5%AF%B9%E6%AF%94"><span class="toc-number">7.5.</span> <span class="toc-text">半同步复制与无损复制的对比</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E4%B8%BB%E4%BB%8E%E5%88%87%E6%8D%A2"><span class="toc-number">8.</span> <span class="toc-text">手动主从切换</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A3%E5%B8%B8%E5%88%87%E6%8D%A2"><span class="toc-number">8.1.</span> <span class="toc-text">正常切换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E6%9C%BA%E5%AE%95%E6%9C%BA%E5%88%87%E6%8D%A2"><span class="toc-number">8.2.</span> <span class="toc-text">主机宕机切换</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E6%8A%A5%E9%94%99%E5%A4%84%E7%90%86"><span class="toc-number">9.</span> <span class="toc-text">主从同步报错处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GTID"><span class="toc-number">10.</span> <span class="toc-text">GTID</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GTID%E6%A6%82%E5%BF%B5%E3%80%81%E7%BB%84%E6%88%90"><span class="toc-number">10.1.</span> <span class="toc-text">GTID概念、组成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GTID-event%E7%BB%93%E6%9E%84"><span class="toc-number">10.2.</span> <span class="toc-text">GTID event结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GTID%E5%92%8Cbinlog%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">10.3.</span> <span class="toc-text">GTID和binlog的关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GTID%E7%9A%84%E5%A4%8D%E5%88%B6%E5%8D%8F%E8%AE%AE%EF%BC%88COM-BINLOG-DUMP-GTID%EF%BC%89"><span class="toc-number">10.4.</span> <span class="toc-text">GTID的复制协议（COM_BINLOG_DUMP_GTID）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E5%A4%8D%E5%88%B6%E4%B8%8EGTID%E5%AF%B9%E6%AF%94"><span class="toc-number">10.5.</span> <span class="toc-text">传统复制与GTID对比</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E5%A4%8D%E5%88%B6"><span class="toc-number">10.5.1.</span> <span class="toc-text">传统复制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GTID-%E5%A4%8D%E5%88%B6"><span class="toc-number">10.5.2.</span> <span class="toc-text">GTID 复制</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%9F%BA%E4%BA%8EGTID%E7%9A%84%E5%A4%8D%E5%88%B6"><span class="toc-number">11.</span> <span class="toc-text">配置基于GTID的复制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E0%E5%BC%80%E5%A7%8B%E6%90%AD%E5%BB%BA"><span class="toc-number">11.1.</span> <span class="toc-text">从0开始搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E5%A4%8D%E5%88%B6%E5%8D%87%E7%BA%A7%E4%B8%BAGTID%E5%A4%8D%E5%88%B6"><span class="toc-number">11.2.</span> <span class="toc-text">传统复制升级为GTID复制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GTID%E7%9B%B8%E5%85%B3%E5%8F%82%E6%95%B0"><span class="toc-number">11.3.</span> <span class="toc-text">GTID相关参数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86"><span class="toc-number">12.</span> <span class="toc-text">同步故障处理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#reference"><span class="toc-number"></span> <span class="toc-text">reference</span></a></details></div><div class="container post-content"><h2 id="物理机搭建环境"><a href="#物理机搭建环境" class="headerlink" title="物理机搭建环境"></a>物理机搭建环境</h2><p>流程：</p>
<ol>
<li>Master 端启用二进制日志(binlog)，指定唯一的 server_id</li>
<li>Slave 端启用二进制日志(binlog)，指定唯一的 server_id，指定中继文件路径</li>
<li>创建复制专用账号</li>
<li>配置 Salve 端的连接</li>
</ol>
<h3 id="启用binlog"><a href="#启用binlog" class="headerlink" title="启用binlog"></a>启用binlog</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/mysql/conf.d/my.cnf</span><br></pre></td></tr></table></figure>

<h4 id="master"><a href="#master" class="headerlink" title="master"></a>master</h4><p>第一种方式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#开启binlog日志</span></span><br><span class="line">log_bin=ON</span><br><span class="line"><span class="comment">#binlog日志的基本文件名</span></span><br><span class="line">log_bin_basename=/var/lib/mysql/mysql-bin</span><br><span class="line"><span class="comment">#binlog文件的索引文件，管理所有binlog文件</span></span><br><span class="line">log_bin_index=/var/lib/mysql/mysql-bin.index</span><br><span class="line"><span class="comment">#配置serverid</span></span><br><span class="line">server-id=1</span><br></pre></td></tr></table></figure>

<p>第二种方式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#此一行等同于上面前三行</span></span><br><span class="line">log-bin=/var/lib/mysql/mysql-bin</span><br><span class="line"><span class="comment">#配置serverid</span></span><br><span class="line">server-id=1</span><br></pre></td></tr></table></figure>

<p>重启 MySQL 生效。</p>
<p>检验：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW VARIABLES LIKE &#x27;log_bin&#x27;;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| log_bin       | ON    |</span><br><span class="line">+---------------+-------+</span><br></pre></td></tr></table></figure>



<h4 id="slave"><a href="#slave" class="headerlink" title="slave"></a>slave</h4><p>比起 master 端，slave 端还需要在配置文件指定中继文件路径：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">relay_log = /mysql/3306/relaylog/relay-bin</span><br></pre></td></tr></table></figure>



<h3 id="创建复制专用账号-可选"><a href="#创建复制专用账号-可选" class="headerlink" title="创建复制专用账号(可选)"></a>创建复制专用账号(可选)</h3><p>在 master 端创建账号：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grant replication salve on *.* to &#x27;slave_account_name&#x27; @ &#x27;192.168.2.%&#x27; identified by &#x27;slave_account_password&#x27;;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>

<p>之后可以检验账号：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uslave_account_name -pslave_account_password</span><br></pre></td></tr></table></figure>



<h3 id="配置-Salve-端的连接"><a href="#配置-Salve-端的连接" class="headerlink" title="配置 Salve 端的连接"></a>配置 Salve 端的连接</h3><p>master 执行<code>show maste status</code>，可找到<code>MASTER_LOG_FILE</code>，<code>MASTER_LOG_POS</code>二者的值。</p>
<p>在slave执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">change master to</span><br><span class="line">MASTER_HOST=&#x27;192.168.2.100&#x27;,</span><br><span class="line">MASTER_USER=&#x27;slave_account_name&#x27;,</span><br><span class="line">MASTER_PASSWORD=&#x27;slave_account_password&#x27;,</span><br><span class="line">MASTER_PORT=3306,</span><br><span class="line">MASTER_LOG_FILE=&#x27;mysql-bin.000002&#x27;,</span><br><span class="line">MASTER_LOG_POS=985056,</span><br><span class="line">MASTER_CONNECT_RETRY=30;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start slave;</span><br></pre></td></tr></table></figure>



<p>检验：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 172.17.0.2</span><br><span class="line">                  Master_User: root</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 30</span><br><span class="line">              Master_Log_File: mysql-bin.000007</span><br><span class="line">          Read_Master_Log_Pos: 313</span><br><span class="line">               Relay_Log_File: 83419d42d521-relay-bin.000005</span><br><span class="line">                Relay_Log_Pos: 320</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000007</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error:</span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 313</span><br><span class="line">              Relay_Log_Space: 534</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error:</span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: 1</span><br><span class="line">                  Master_UUID: 203d9c50-95eb-11ec-ab8e-0242ac110002</span><br><span class="line">             Master_Info_File: /var/lib/mysql/master.info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind:</span><br><span class="line">      Last_IO_Error_Timestamp:</span><br><span class="line">     Last_SQL_Error_Timestamp:</span><br><span class="line">               Master_SSL_Crl:</span><br><span class="line">           Master_SSL_Crlpath:</span><br><span class="line">           Retrieved_Gtid_Set:</span><br><span class="line">            Executed_Gtid_Set:</span><br><span class="line">                Auto_Position: 0</span><br><span class="line">         Replicate_Rewrite_DB:</span><br><span class="line">                 Channel_Name:</span><br><span class="line">           Master_TLS_Version:</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p><code>Slave_IO_Running</code>，<code>Slave_SQL_Running</code> 均为 YES 则说明成功。同时我们也可以找到<code>master.info</code>的位置。</p>
<blockquote>
<ul>
<li><code>Slave_IO_Running</code>：从主库中拉取数据</li>
<li><code>Slave_SQL_Running</code>：将拉取的数据在从库中执行</li>
</ul>
</blockquote>
<h2 id="使用docker搭建环境"><a href="#使用docker搭建环境" class="headerlink" title="使用docker搭建环境"></a>使用docker搭建环境</h2><p>创建配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /d/volume/mysql-cluster/master/conf/my.cnf</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">server-id=1 </span><br><span class="line">log-bin=mysql-bin</span><br><span class="line">log-bin-index = binlog.index</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /d/volume/mysql-cluster/slave1/conf/my.cnf</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">server-id=2</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line">log-bin-index = binlog.index</span><br></pre></td></tr></table></figure>



<p>启动 master 和 slave：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=root \</span><br><span class="line">-v /d/volume/mysql-cluster/master/data:/var/lib/mysql \</span><br><span class="line">-v /d/volume/mysql-cluster/master/conf:/etc/mysql/conf.d \</span><br><span class="line">-v /d/volume/mysql-cluster/master/logs:/logs \</span><br><span class="line">--name mysql-master mysql:5.7</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 3307:3306 -e MYSQL_ROOT_PASSWORD=root \</span><br><span class="line">-v /d/volume/mysql-cluster/slave1/data:/var/lib/mysql \</span><br><span class="line">-v /d/volume/mysql-cluster/slave1/conf:/etc/mysql/conf.d \</span><br><span class="line">-v /d/volume/mysql-cluster/slave1/logs:/logs \</span><br><span class="line">--name mysql-slave  mysql:5.7</span><br></pre></td></tr></table></figure>



<p>关联两个容器网络：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker network create mysql-cluster-bridge</span><br><span class="line">docker network connect mysql-cluster-bridge mysql-master</span><br><span class="line">docker network connect mysql-cluster-bridge mysql-slave</span><br></pre></td></tr></table></figure>



<p>进入 master，执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">show master status;</span><br><span class="line"></span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| mysql-bin.000007 |      313 |              |                  |                   |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br></pre></td></tr></table></figure>



<p>进入 slave，执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER TO</span><br><span class="line">MASTER_HOST=&#x27;172.17.0.2&#x27;,</span><br><span class="line">MASTER_USER=&#x27;root&#x27;,</span><br><span class="line">MASTER_PASSWORD=&#x27;root&#x27;,</span><br><span class="line">MASTER_PORT=3306,</span><br><span class="line">MASTER_LOG_FILE=&#x27;mysql-bin.000007&#x27;,</span><br><span class="line">MASTER_LOG_POS=313,</span><br><span class="line">MASTER_CONNECT_RETRY=30;</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li><code>MASTER_HOST</code>：可从 <code>docker network inspect mysql-master</code> 获取。</li>
<li><code>MASTER_LOG_FILE</code>，<code>MASTER_LOG_POS</code>：可从 master 执行 <code>show master status;</code> 获取。</li>
</ul>
</blockquote>
<p>最终 slave 可以使用 <code>show slave status</code> 进行校验。</p>
<h2 id="主从服务器的线程"><a href="#主从服务器的线程" class="headerlink" title="主从服务器的线程"></a>主从服务器的线程</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># master</span><br><span class="line">mysql&gt; show processlist;</span><br><span class="line">+----+------+------------------+------+-------------+-------+---------------------------------------------------------------+------------------+</span><br><span class="line">| Id | User | Host             | db   | Command     | Time  | State                                                         | Info             |</span><br><span class="line">+----+------+------------------+------+-------------+-------+---------------------------------------------------------------+------------------+</span><br><span class="line">|  4 | root | 172.17.0.3:46814 | NULL | Binlog Dump | 22662 | Master has sent all binlog to slave; waiting for more updates | NULL             |</span><br><span class="line">|  5 | root | localhost        | NULL | Sleep       |   115 |                                                               | NULL             |</span><br><span class="line">|  6 | root | localhost        | NULL | Query       |     0 | starting                                                      | show processlist |</span><br><span class="line">+----+------+------------------+------+-------------+-------+---------------------------------------------------------------+------------------+</span><br><span class="line"></span><br><span class="line"># slave</span><br><span class="line">mysql&gt; show processlist;</span><br><span class="line">+----+-------------+-----------+------+---------+-------+--------------------------------------------------------+------------------+</span><br><span class="line">| Id | User        | Host      | db   | Command | Time  | State                                                  | Info             |</span><br><span class="line">+----+-------------+-----------+------+---------+-------+--------------------------------------------------------+------------------+</span><br><span class="line">|  9 | system user |           | NULL | Connect | 22643 | Slave has read all relay log; waiting for more updates | NULL             |</span><br><span class="line">| 23 | root        | localhost | NULL | Sleep   |    30 |                                                        | NULL             |</span><br><span class="line">| 24 | system user |           | NULL | Connect | 22653 | Waiting for master to send event                       | NULL             |</span><br><span class="line">| 25 | root        | localhost | NULL | Query   |     0 | starting                                               | show processlist |</span><br><span class="line">+----+-------------+-----------+------+---------+-------+--------------------------------------------------------+------------------+</span><br></pre></td></tr></table></figure>

<p>发现 master 有 1 个线程，slave 有 2 个线程：</p>
<ul>
<li><code>log_dump_thread</code>：master 向 slave 发送 binlog 数据。</li>
<li><code>io_thread</code>：slave 接收从 master 中获取的数据。</li>
<li><code>sql_thread</code>：slave 执行这些数据。</li>
</ul>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><ul>
<li>show master status; 查看主的状态</li>
<li>show slave status\G; 查看从的状态</li>
<li>show slave hosts; 查看所有的从</li>
<li>show processlist; 查看 mysql 的进程状态信息</li>
<li>show master logs; 查看主的日志</li>
<li>start/stop io_thread; 开启/关闭 io_thread</li>
<li>start/stop sql_thread; 开启/关闭 sql_thread</li>
<li>start/stop slave: 开启关闭从</li>
<li>reset slave; 慎用，清除日志同时会清空从的配置信息</li>
</ul>
<h2 id="复制关键因素及原理"><a href="#复制关键因素及原理" class="headerlink" title="复制关键因素及原理"></a>复制关键因素及原理</h2><h3 id="复制格式"><a href="#复制格式" class="headerlink" title="复制格式"></a>复制格式</h3><p>即 binlog 的格式，由系统变量 binlog_format 控制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;binlog_format&#x27;;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| binlog_format | ROW   |</span><br><span class="line">+---------------+-------+</span><br></pre></td></tr></table></figure>

<ul>
<li>基于语句记录（Statement-Based Logging，SBL），对应的参数值为statement。二进制日志文件中保存的是执行过的SQL语句。</li>
<li>基于行格式记录（Row-Based Logging，RBL），对应的参数值为row。二进制日志文件中记录的是变更的行的信息。</li>
<li>混合模式（Mixed-BasedLogging，MBL），对应的参数值为mixed。在记录事件到二进制日志时，MySQL服务根据需要，动态修改日志记录的格式。</li>
</ul>
<h4 id="SBR与RBR的优缺点"><a href="#SBR与RBR的优缺点" class="headerlink" title="SBR与RBR的优缺点"></a>SBR与RBR的优缺点</h4><p>SBR优点：</p>
<ol>
<li>生成日志少</li>
<li>可读性高（mysqlbinlog）</li>
</ol>
<p>SBR缺点：</p>
<ol>
<li>不严谨，如SQL语句包含now等函数。</li>
<li>执行insert..select语句时需要持有更多的锁（相比RBR）</li>
<li>对于InnoDB引擎，INSERT语句使用AUTOINCREMENT会阻塞其他INSERT语句</li>
</ol>
<p>RBR优点：</p>
<ol>
<li>所有修改都能被安全地复制到Slave节点</li>
<li>Master端执行修改操作时，仅需极少的锁，可以获得更高的并发性。</li>
<li>Slave节点执行IDU时也仅需持有少量锁</li>
</ol>
<p>RBR缺点：</p>
<ol>
<li>可能会生成更多的日志。</li>
<li>日志可读性降低（mysqlbinlog）。</li>
<li>对于非事务存储引擎，比如MyISAM表对象，Slave节点应用INSERT操作时，使用RBR模式要比使用SBR模式持有更强的锁</li>
</ol>
<h4 id="场景举例"><a href="#场景举例" class="headerlink" title="场景举例"></a>场景举例</h4><p>有条复杂的SQL语句，在Master节点执行了一个小时，最终成功修改了两条记录。</p>
<ul>
<li>采用SBR模式，二进制日志中记录的事件就是这条SQL语句，那么，这个记录被复制到Slave节点后，也要一个小时时间执行。</li>
<li>采用RBR模式，不管Master节点执行了多长时间，最终变更记录只有两条，那么二进制日志中记录的事件，就是这两条记录的更新，日志被同步到Slave节点后，秒级别就执行完了。</li>
</ul>
<p>有条简单的SQL语句，在Master节点执行时，要更新一千万条记录。</p>
<ul>
<li>采用SBR模式，二进制日志文件中就记录了该SQL语句，Slave节点可以迅速接受该语句，然后再执行，执行可能耗费一定时间，但总体时间开销还是要比RBR小。</li>
<li>采用RBR模式，这一千万条记录会生成较大的二进制日志文件，数据在网络传输过程就要耗费一定时间，Slave接收完数据，还得花费相当长的时间慢慢应用到库中。</li>
</ul>
<h3 id="中继日志文件"><a href="#中继日志文件" class="headerlink" title="中继日志文件"></a>中继日志文件</h3><p>MySQL数据库中有二进制日志文件，用于记录所有执行的变更事件，复制特性正是基于这类文件实现“复制”操作。Slaves节点中有两个线程，其中IO_THREAD线程用于接收和保存二进制日志，IO_THREAD将接收的二进制日志就保存在本端的中继日志中。<strong>中继日志格式和binlog文件格式是一样的</strong>，所以也可以使用 mysqlbinlog 目录查看。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;%relay%&#x27;;</span><br><span class="line">+---------------------------+---------------------------------------------+</span><br><span class="line">| Variable_name             | Value                                       |</span><br><span class="line">+---------------------------+---------------------------------------------+</span><br><span class="line">| max_relay_log_size        | 0                                           |</span><br><span class="line">| relay_log                 |                                             |</span><br><span class="line">| relay_log_basename        | /var/lib/mysql/83419d42d521-relay-bin       |</span><br><span class="line">| relay_log_index           | /var/lib/mysql/83419d42d521-relay-bin.index |</span><br><span class="line">| relay_log_info_file       | relay-log.info                              |</span><br><span class="line">| relay_log_info_repository | FILE                                        |</span><br><span class="line">| relay_log_purge           | ON                                          |</span><br><span class="line">| relay_log_recovery        | OFF                                         |</span><br><span class="line">| relay_log_space_limit     | 0                                           |</span><br><span class="line">| sync_relay_log            | 10000                                       |</span><br><span class="line">| sync_relay_log_info       | 10000                                       |</span><br><span class="line">+---------------------------+---------------------------------------------+</span><br></pre></td></tr></table></figure>



<h4 id="创建新的中继日志文件的时机"><a href="#创建新的中继日志文件的时机" class="headerlink" title="创建新的中继日志文件的时机"></a>创建新的中继日志文件的时机</h4><p>Slaves节点会在满足下列条件时，触发创建新的中继日志文件：</p>
<ol>
<li>启动Slaves节点IO线程时。</li>
<li>执行日志刷新命令：flush logs</li>
<li>中继日志文件达到指定最大值<ul>
<li>如果max_relay_log_size参数值大于0，则日志文件超过该值后即会重建</li>
<li>如果max_relay_log_size参数值为0，则通过max_binlog_size确定单个中继日志文件的最大值</li>
</ul>
</li>
</ol>
<h4 id="为什么需要中继日志"><a href="#为什么需要中继日志" class="headerlink" title="为什么需要中继日志"></a>为什么需要中继日志</h4><p>relay log 其实和 binlog 没有太大的区别，在 MySQL 4.0 之前是没有 Relay Log 这部分的，整个过程中只有两个线程。但是这样也带来一个问题，那就是复制的过程需要同步的进行，很容易被影响，而且效率不高。例如主库必须要等待从库读取完了才能发送下一个 binlog 事件。这就有点类似于一个阻塞的信道和非阻塞的信道。</p>
<p>阻塞信道就跟你在柜台一样，你要递归柜员一个东西，但是你和柜员之间没有可以放东西的地方，你就只能一直把文件拿着，直到柜员接手；而非阻塞信道就像你们之间有个地方可以放文件，你就直接放上去就好了，不用等柜员接手。</p>
<p>引入了 Relay Log 之后，让原本同步的获取事件、重放事件解耦了，两个步骤可以异步的进行，Relay Log 充当了缓冲区的作用。Relay Log 有一个 relay-log.info 的文件，用于记录当前复制的进度，下一个事件从什么 Pos 开始写入，该文件由 SQL 线程负责更新。</p>
<h3 id="状态文件"><a href="#状态文件" class="headerlink" title="状态文件"></a>状态文件</h3><p>Slave节点会创建两个状态文件：即master.info和relay-log.info，这两个文件默认保存在data目录，可以通过–master-info-file和–relay-log-info-file参数修改文件的名称和保存路径。</p>
<h4 id="master-info"><a href="#master-info" class="headerlink" title="master.info"></a>master.info</h4><p>master.info：<strong>和 io_thread 有关</strong>，记录了连接信息和binlog的位置信息。<strong>io_thread 通过读取 master.info 获取连接信息，去 master 请求连接</strong>。</p>
<blockquote>
<p>master.info 文件或者 mysql.slave_master_info 表：用于保存从库的 IO 线程连接主库的连接状态、帐号、IP、端口、密码以及 IO 线程当前读取主库 binlog 的 file 和 position 等信息（被称为 IO 线程信息日志。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">root@83419d42d521:/var/lib/mysql# cat master.info</span><br><span class="line">25</span><br><span class="line">mysql-bin.000007</span><br><span class="line">649</span><br><span class="line">172.17.0.2</span><br><span class="line">root</span><br><span class="line">root</span><br><span class="line">3306</span><br><span class="line">30</span><br><span class="line">0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">0</span><br><span class="line">30.000</span><br><span class="line"></span><br><span class="line">0</span><br><span class="line">203d9c50-95eb-11ec-ab8e-0242ac110002</span><br><span class="line">86400</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="relay-log-info"><a href="#relay-log-info" class="headerlink" title="relay-log.info"></a>relay-log.info</h4><p>realy-log.info：<strong>和 sql_thread 有关</strong>，记录<strong>执行到 binlog 的哪个位置</strong>，所以这个位置之前的 binlog 都是可以删除的。</p>
<blockquote>
<p>relay-log.info 文件或者 mysql.slave_relay_log_info 表： 从库的 IO 线程从主库获取到最新的 binlog 事件信息会先写入到从库本地的 relay log 中，SQL 线程再去读取 relay log 解析并重放，而 relay_log.info 文件或者 mysql.slave_relay_log_info 表就是用于记录最新的 relay log 的 file 和 position 以及 SQL 线程当前重放的事件对应主库 binlog 的 file 和 position。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@83419d42d521:/var/lib/mysql# cat relay-log.info</span><br><span class="line">7</span><br><span class="line">./83419d42d521-relay-bin.000005</span><br><span class="line">656</span><br><span class="line">mysql-bin.000007</span><br><span class="line">649</span><br><span class="line">0</span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>回顾一下 show slave status，这里也储存了 master.info 和 relay-log.info 的信息。实际上 MySQL 会定期将这里的信息刷新到 master.info 和 relay-log.info 两个文件中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 172.17.0.2</span><br><span class="line">                  Master_User: root</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 30</span><br><span class="line">              Master_Log_File: mysql-bin.000007</span><br><span class="line">          Read_Master_Log_Pos: 649</span><br><span class="line">               Relay_Log_File: 83419d42d521-relay-bin.000005</span><br><span class="line">                Relay_Log_Pos: 656</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000007</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error:</span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 649</span><br><span class="line">              Relay_Log_Space: 870</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error:</span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: 1</span><br><span class="line">                  Master_UUID: 203d9c50-95eb-11ec-ab8e-0242ac110002</span><br><span class="line">             Master_Info_File: /var/lib/mysql/master.info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind:</span><br><span class="line">      Last_IO_Error_Timestamp:</span><br><span class="line">     Last_SQL_Error_Timestamp:</span><br><span class="line">               Master_SSL_Crl:</span><br><span class="line">           Master_SSL_Crlpath:</span><br><span class="line">           Retrieved_Gtid_Set:</span><br><span class="line">            Executed_Gtid_Set:</span><br><span class="line">                Auto_Position: 0</span><br><span class="line">         Replicate_Rewrite_DB:</span><br><span class="line">                 Channel_Name:</span><br><span class="line">           Master_TLS_Version:</span><br></pre></td></tr></table></figure>



<h3 id="复制原理"><a href="#复制原理" class="headerlink" title="复制原理"></a>复制原理</h3><p>三个步骤：</p>
<ol>
<li>Master 将数据改变记录到二进制日志 (binary log) 中，也就是配置文件 log-bin 指定的文件，这些记录叫做二进制日志事件 (binary log events)</li>
<li>Slave 通过 I/O 线程读取 Master 中的 binary log events 并写入到它的中继日志 (relay log)</li>
<li>Slave 重做中继日志中的事件，把中继日志中的事件信息一条一条的在本地执行一次，完成数据在本地的存储，从而实现将改变反映到它自己的数据 (数据重放)</li>
</ol>
<p>三个线程：</p>
<ol>
<li>主节点 binary log dump 线程（IO 线程）：当从节点连接主节点时，主节点会创建一个 log dump 线程，用于发送 bin-log 的内容。在读取 bin-log 中的操作时，此线程会对主节点上的 bin-log 加锁，当读取完成，甚至在发动给从节点之前，锁会被释放。</li>
<li>从节点 I/O 线程：当从节点上执行 <code>start slave</code> 命令之后，从节点会创建一个 I/O 线程用来连接主节点，请求主库中更新的 bin-log。I/O 线程接收到主节点 binlog dump 进程发来的更新之后，保存在本地 relay-log 中。</li>
<li>从节点 SQL 线程：SQL 线程负责读取 relay log 中的内容，解析成具体的操作并执行，最终保证主从数据的一致性。</li>
</ol>
<p><img src="/images/1446087-4a37bbc9d7cca56b.png" alt="img"></p>
<p>整个主从复制的过程：</p>
<ol>
<li>Master 记录二进制日志， 每次<strong>提交事务完成数据更新前，Master 将数据更新的时间记录到二进制日志中</strong>，MySQL 会按事务提交的顺序而非每条语句的执行顺序来记录二进制日志。<strong>记录二进制日志后，主库会告诉存储引擎可以提交事务了。</strong></li>
<li>在 Slave 服务器上执行 <strong>start slave 命令</strong>开启主从复制开关，开始进行主从复制。</li>
<li>此时，Slave 服务器的 IO 线程会通过在 master 上已经授权的复制用户权限请求连接 Master 服务器，并请求从执行 binlog 日志文件中的指定位置（日志文件名和位置就是在配置主从复制服务时执行 change master 命令指定的）之后开始发送 binlog 日志内容。</li>
<li>Master 服务器接收来自 Slave 服务器的 IO 线程的请求后，其负责复制的 IO 线程会根据 Slave 服务器的 IO 线程请求的信息分批读取指定 binlog 日志文件指定位置之后的 binlog 日志信息，然后返回给 Slave 端的 IO 线程。返回的信息中除了 binlog 日志内容外，还有在 Master 服务器端记录的 IO 线程。返回的信息中除了 binlog 中的下一个指定更新位置。</li>
<li>当 Slave 服务器的 IO 线程获取到 Master 服务器上 IO 线程发送的日志内容、日志文件及位置点后，<strong>会将 binlog 日志内容依次写到 Slave 端自身的 Relay Log（即中继日志）</strong>文件（Mysql-relay-bin.xxx）的最末端，并将新的 binlog 文件名和位置记录到 master-info 文件中，以便下一次读取 master 端新 binlog 日志时能告诉 Master 服务器从新 binlog 日志的指定文件及位置开始读取新的 binlog 日志内容。</li>
<li>Slave 服务器端的 <strong>SQL 线程会实时检测本地 Relay Log 中 IO 线程新增的日志内容，然后及时把 Relay LOG 文件中的内容解析成 sql 语句</strong>，并在自身 Slave 服务器上按解析 SQL 语句的位置顺序执行应用这样 sql 语句，并在 relay-log.info 中记录当前应用中继日志的文件名和位置点。</li>
</ol>
<blockquote>
<p>这种复制架构实现了<strong>获取事件</strong>和<strong>重放事件</strong>的解偶，一个是获取 binlog 的 IO 线程，一个是重放中继日志的 SQL 线程，允许这两个过程异步进行。也就是说 I/O 线程能够独立于 SQL 线程之外工作。但这种架构也限制了复制的过程，其中最重要的一点是主库上并发运行的查询再从库只能串行化执行，因为只有一个 SQL 线程重放中继日志中的事件。这是很多工作负载的性能瓶颈所在。因为始终受限于单线程。</p>
</blockquote>
<p><img src="/images/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6.png" alt="img"></p>
<ol>
<li>从库执行 change master to , 所有信息会被保存到master.info文件中。</li>
<li>从库执行 start slave，启动IO和SQL线程。</li>
<li>从库IO线程工作，获取master.info文件信息，生成指针（mi）。</li>
<li>从库IO线程，连接主库。</li>
<li>主库连接层，接收请求，验证用户、权限，并生成binlog_dump线程。</li>
<li>从库IO线程和主库binlog_dump线程交互，验证server_id、server_uuid、时间等，从库正式注册到主库中。</li>
<li>主库binlog_dump线程一直监控着binlog状态，有新的日志就返回给从库IO线程。</li>
<li>从库IO线程通过MI指针中的binlog位置点，向binlog_dump线程请求最新日志。</li>
<li>从库IO线程接收主库binlog_dump线程发送的新的日志，mi指针自动更新，并写入master.info中。</li>
<li>从库IO线程线程最终会将接收到的binlog信息，写入到relay log中继日志中。</li>
<li>从库SQL线程，读取relay-log.info信息，获取到上次已经应用过的relay log的位置点信息，生成一个rli指针，与relay log中继日志中的pos进行对比。</li>
<li>如果有新的中继日志生成，就执行到数据库中，执行完成更新rli指针，并写入到relay-log.info中。</li>
</ol>
<h2 id="复制过滤规则"><a href="#复制过滤规则" class="headerlink" title="复制过滤规则"></a>复制过滤规则</h2><p>默认情况下，Master节点生成的所有二进制日志，都将发送至Slave节点，哪怕Slave节点只想同步一张表中的数据，也得把所有的二进制日志都接收到本地，MySQL为灵活控制复制过滤规则，提供了一些参数。</p>
<p>Master端：</p>
<p>在Master端进行复制过滤会导致主服务器上的二进制日志记录不完整一旦主服务器崩溃将无法做到还原所有数据。</p>
<ul>
<li>–binlog-do-db：指定对某数据库的操作事件被记录</li>
<li>–binlog-ignore-db：指定对某数据库的操作事件不被记录</li>
<li>set sql_log_bin=0：会话级别所做操作不被记录</li>
</ul>
<p>Slave端：</p>
<p>Slave节点在接收日志时没有选择权，Master节点写过的日志它全部接收到本地，保存在中继日志文件中。但Slave节点在应用哪些数据库哪些表时具有选择权的。MySQL提供了一系列参数用于Slave节点定义过滤规则。</p>
<ul>
<li>–replicate-do-db=name</li>
<li>–replicate-ignore-db=name</li>
<li>–replicate-do-table=name</li>
<li>–replicate-ignore-table=name</li>
<li>–replicate-wild-do-table=foo%.bar%</li>
<li>–replicate-wild-ignore-table=foo%.bar</li>
</ul>
<h2 id="复制方式"><a href="#复制方式" class="headerlink" title="复制方式"></a>复制方式</h2><h3 id="异步复制"><a href="#异步复制" class="headerlink" title="异步复制"></a>异步复制</h3><p>MySQL 默认的方式。在异步复制下，主库不会主动的向从库发送消息，而是等待从库的 I/O 线程建立连接，然后主库创建 <code>binlog dump</code> 线程，把 binlog event 发送给 I/O 线程，流程如下图。</p>
<p><img src="/images/1460000038967232" alt="MySQL复制模式"></p>
<p>主库在执行完自己的事务、记录完 binlog 之后就会直接返回给客户端，不会与客户端确认任何结果（无需等待binlog传给从库）。然后后续由 binlog dump 线程异步的读取 binlog，然后发送给从库。<strong>处理请求</strong>和<strong>主从复制</strong>是两个完全异步化的过程。</p>
<p>异步方式的危险在于：如果从库落后，主库不幸crash，那么就会导致数据丢失。</p>
<h3 id="同步复制"><a href="#同步复制" class="headerlink" title="同步复制"></a>同步复制</h3><p>同步模式：主库执行一个事务，那么主库必须等待所有的从库全部执行完事务返回 commit 之后才能给客户端返回成功。</p>
<p><img src="/images/1460000038967226" alt="同步复制"></p>
<p>值得注意的是，主库会直接提交事务，而不是等待所有从库返回之后再提交。MySQL 只是延迟了对客户端的返回，并没有延后事务的提交。</p>
<p>同步模式导致性能大打折扣，它把客户端的请求和主从复制耦合在了一起，如果有某个从库复制线程执行的慢，那么对客户端的响应也会慢很多。</p>
<h3 id="半同步复制"><a href="#半同步复制" class="headerlink" title="半同步复制"></a>半同步复制</h3><p>半同步相对于同步的区别在于，<strong>同步需要等待所有的从库 commit，而半同步只需要一个从库 commit 就可以返回了</strong>。如果超过默认的时间仍然没有从库 commit，就会切换为异步模式再提交。客户端也不会一直去等待了。</p>
<p>主库在每次事务提交时，并不及时反馈给前端用户，而是等待其中一个从库也接收到binlog并成功写入中继日志后，主库才返回给客户端。此时，至少有两份日志记录，一份在主库的binlog上，另一份在至少一个从库的中继日志上，从而保证了数据的完整性。</p>
<p><img src="/images/1460000038967233" alt="MySQL复制模式"></p>
<p>因为即使后面主库宕机了，也能至少保证有一个从库节点是可以用的，此外还减少了同步时的等待时间。</p>
<h3 id="无损复制"><a href="#无损复制" class="headerlink" title="无损复制"></a>无损复制</h3><p>rpl_semi_sync_master_wait_point参数有两个值：<code>AFTER_COMMIT</code>和<code>AFTER_SYNC</code></p>
<h4 id="AFTER-COMMIT"><a href="#AFTER-COMMIT" class="headerlink" title="AFTER_COMMIT"></a>AFTER_COMMIT</h4><p>master将每个事务写入binlog（sync_binlog=1），传递到slave刷新到磁盘（synerelay=1），同时主库提交事务（即：提交commit和写入binlog是同时进行的）。master等待slave反馈收到relaylog，只有收到ACK后master才将commit Ok结果反馈给客户端。</p>
<p><img src="/images/image-20220302152421203.png" alt="image-20220302152421203"></p>
<p>在使用after_commit的模式下，客户端事务在存储引擎层提交后，在得到从库确认的过程中，主库宕机了。此时，即主库在等待Slave ACK的时候，虽然没有返回当前客户端，但事务已经提交，其他客户端会读取到已提交事务。如果Slave端还没有读到该事务的events同时主库发生了crash，然后切换到备库。那么之前读到的事务就不见了，出现了幻读。</p>
<p><img src="/images/image-20220302152849192.png" alt="image-20220302152849192"></p>
<h4 id="AFTER-SYNC"><a href="#AFTER-SYNC" class="headerlink" title="AFTER_SYNC"></a>AFTER_SYNC</h4><p>master将每个事务写入binlog，传递到slave刷新到磁盘（relaylog）。master等待slave反馈接收到relaylog的ack之后，再提交事务并且返回commitOK结果给客户端。</p>
<p><img src="/images/image-20220302153624568.png" alt="image-20220302153624568"></p>
<h3 id="半同步复制与无损复制的对比"><a href="#半同步复制与无损复制的对比" class="headerlink" title="半同步复制与无损复制的对比"></a>半同步复制与无损复制的对比</h3><ol>
<li>ACK的时间点不同：<ul>
<li>一个先engine commit后再接收ACK</li>
<li>一个在接收ACK后再engine commit。</li>
</ul>
</li>
<li>主从数据一致性：<ul>
<li>半同步复制意味着在Master节点上，这个刚刚提交的事物对数据库的修改，对其他事物是可见的。因此，如果在等待SlaveACK的时候crash了，那么会对其他事务出现幻读，数据丢失。</li>
<li>无损复制在write binlog完成后，就传输binlog，但还没有去写commit log，意味着当前这个事物对数据库的修改，其他事物也是不可见的。因此，不会出现幻读，数据丢失风险。</li>
</ul>
</li>
</ol>
<h2 id="手动主从切换"><a href="#手动主从切换" class="headerlink" title="手动主从切换"></a>手动主从切换</h2><h3 id="正常切换"><a href="#正常切换" class="headerlink" title="正常切换"></a>正常切换</h3><ol>
<li><p>对主库全库锁定：flush tables with read lock</p>
</li>
<li><p>在master执行：showprocesslist；显示 Master has sent all binlog to slave；waiting for binlog to be updated</p>
</li>
<li><p>在slave执行：showprocesslist；显示 slave has read all relay log； waiting for more updates</p>
</li>
<li><p>停止slave io线程：stop slave io_thread；</p>
</li>
<li><p>把slave提升为master</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stop slave；</span><br><span class="line">reset master；#删除所有的binglog日志文件，并将日志索引文件清空，重新开始所有新的日志文件。</span><br><span class="line">reset slave；#删除master.info文件和relay-log.info文件以及所有的relay.1og文件并重新启用一个新的relaylog文件。</span><br><span class="line">reset slave all；#相对于RESET SLAVE，RESET SLAVE ALL还会删除内存中的连接信息</span><br></pre></td></tr></table></figure></li>
<li><p>查看slave是否只读模式：show variables like ‘read_only’；<br>如果为 ON，则需要修改my.cnf文件，注释掉read-only=1并重启mysg1服务。或者不重启使用命令关闭只读，但下次重启后失效：set global read_only=off；</p>
</li>
<li><p>将原来master变为slave</p>
<ol>
<li><p>在新的master上创建同步用户：<code>grant replication slave on *.* to repl@&#39;192.168.2.%&#39;  identified by &#39;123456&#39;；</code></p>
</li>
<li><p>将新的slave设置为只读模式：set global read_only=on；</p>
</li>
<li><p>将新的slave上释放全局锁：unlock tables;</p>
</li>
<li><p>在配置中设置中继日志目录及名称</p>
</li>
<li><p>在新的slave上重置binlog：Reset master；</p>
</li>
<li><p>在新的slave上配置连接信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER TO</span><br><span class="line">MASTER_HOST=&#x27;192.168.2.10&#x27;,</span><br><span class="line">MASTER_USER=&#x27;repl&#x27;,</span><br><span class="line">MASTER_PASSWORD=&#x27;123456&#x27;，</span><br><span class="line">MASTER_PORT=3306，</span><br><span class="line">MASTER_LOG_FILE=&#x27;mysgl-bin.000001&#x27;,</span><br><span class="line">MASTER_LOG_POS=599，</span><br><span class="line">MASTER_CONNECT_RETRY=10；</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
<h3 id="主机宕机切换"><a href="#主机宕机切换" class="headerlink" title="主机宕机切换"></a>主机宕机切换</h3><ol>
<li><p>在salve执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stop slave;</span><br><span class="line">Reset master;</span><br><span class="line">Reset slave all;</span><br></pre></td></tr></table></figure></li>
<li><p>查看是否只读模式：show variables like ‘read_only’；<br>只读模式需要修改my.cnf文件，注释read-only=1并重启mysql服务。或不重启使用命令关闭只读，但下次重启后失效：set global read_only=off</p>
</li>
<li><p>查看新主状态：show master status</p>
</li>
<li><p>修改应用中间件的IP</p>
</li>
</ol>
<h2 id="主从同步报错处理"><a href="#主从同步报错处理" class="headerlink" title="主从同步报错处理"></a>主从同步报错处理</h2><ul>
<li>第一种：在master上删除一条记录，而slave上找不到。</li>
<li>第二种：主键重复，在slave已经有该记录，又在master上插入了同一条记录。</li>
<li>第三种：在master上更新条记录，而slave上找不到，丢失了数据。</li>
<li>第四种：slave的中继日志relay-bin损坏</li>
</ul>
<p>第一种解决方法：<br>由于master要删除一条记录，而slave上找不到故报错，主都将其删除了，那么从机可以直接跳过。可用命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stop slave；</span><br><span class="line">set global sql_slave_skip_counter=1；# 跳过一个错误</span><br><span class="line">start slave；</span><br></pre></td></tr></table></figure>

<p>或在my.cnf中配置，需要重启服务：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 一旦发送1032错误，就跳过</span><br><span class="line">slave-skip-errors = 1032</span><br></pre></td></tr></table></figure>



<p>第二种解决方法：</p>
<p>登陆到从库，删除重复数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stop slave；</span><br><span class="line">delete from t key where id=1；</span><br><span class="line">start slave；</span><br></pre></td></tr></table></figure>



<p>第三种解决方法：</p>
<p>在master上，用mysqlbinlog分析下出错的binlog日志在干什么</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysglbinlog --no-defaults --base64-output=DECODE-ROWS -v -v mysql-bin.000013 | grep -A 20 <span class="string">&#x27;end_log_pos 4852&#x27;</span></span><br></pre></td></tr></table></figure>


<p>在slave上，查找下更新后的那条记录，应该是不存在的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select * from t_upd where id=1;</span><br><span class="line">Empty set (0.00 sec）</span><br></pre></td></tr></table></figure>

<p>然后再到master查看：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">select * from t_upd wher id=1;</span><br><span class="line">+-----+-------+</span><br><span class="line">| id  | Value |</span><br><span class="line">+-----+-------+</span><br><span class="line">|  1  | XXXX  |</span><br><span class="line">+-----+-------+</span><br></pre></td></tr></table></figure>

<p>把丢失的数据在slave上填补上即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stop slave;</span><br><span class="line">insert into t_upd(id,value)values(11,&#x27;aa&#x27;);</span><br><span class="line">start slave；</span><br></pre></td></tr></table></figure>



<p>第四种解决方法：</p>
<ol>
<li><p>确认同步的binlog和POS点：show slave status;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Slave_IO_Running：#接收master的binlog信息</span><br><span class="line">Master_Log_File/Read_Master_Log_Pos：#显示当前读取的Master节点binlog文件和位置。</span><br><span class="line"></span><br><span class="line">slave_SQL_Running：#执行写操作</span><br><span class="line">Relay_Log_File/Relay_Log_Pos：#显示当前slave节点正在处理的中继日志文件和位置。</span><br><span class="line">Relay_Master_Log_File/Exec_Master_Log_Pos：#显示当前slave节点正在处理的中继日志文件和位置 在Mater中对应的binlog文件和位置</span><br></pre></td></tr></table></figure></li>
<li><p>重新同步：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">stop slave；</span><br><span class="line"># 假设此时：</span><br><span class="line"># Relay_Master_Log_File：mysal-bin.000008</span><br><span class="line"># Exec_Master_Log_Pos: 47230640</span><br><span class="line">CHANGE MASTER TO MASTER LOG FILE=&#x27;mysal-bin.000008&#x27;，MASTER LOG POS=47230640;</span><br><span class="line">start slave；</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="GTID"><a href="#GTID" class="headerlink" title="GTID"></a>GTID</h2><h3 id="GTID概念、组成"><a href="#GTID概念、组成" class="headerlink" title="GTID概念、组成"></a>GTID概念、组成</h3><ol>
<li>全局事务标识：global transaction identifiers。</li>
<li>GTID与事务一一对应，并且全局唯一ID。</li>
<li>一个GTID在一个服务器上只执行一次。</li>
<li>MySQL-5.6.5开始支持GTID。</li>
<li><code>GTID = server_uuid: transaction_id</code>。eg：3E11FA47-71CA-11E1-9E33-C80AA9429562:23</li>
</ol>
<h3 id="GTID-event结构"><a href="#GTID-event结构" class="headerlink" title="GTID event结构"></a>GTID event结构</h3><p><img src="/images/image-20220302171556983.png" alt="image-20220302171556983"></p>
<h3 id="GTID和binlog的关系"><a href="#GTID和binlog的关系" class="headerlink" title="GTID和binlog的关系"></a>GTID和binlog的关系</h3><p>binlog 文件格式如下：</p>
<p><img src="/images/image-20220302171218641.png" alt="image-20220302171218641"></p>
<blockquote>
<p><code>PREVIOUS_GTIDS_LOG_EVENT</code>：用于表示当前binlog文件之前已经执行过的GTID集合，记录在Binlog文件头。</p>
</blockquote>
<p>假设有4个binlog：bin.001，bin.002，bin.003，bin.004</p>
<ul>
<li>bin.001：Previous-GTIDs=empty；binlog_event有：1-40</li>
<li>bin.002：Previous-GTIDs=1-40；binlog_event有：41-80</li>
<li>bin.003：Previous-GTIDs=1-80；binlog_event有：81-120</li>
<li>bin.004：Previous-GTIDs=1-120；binlog event有：121-160</li>
</ul>
<p>对应的binlog文件结构：</p>
<p><img src="/images/image-20220302172049734.png" alt="image-20220302172049734"></p>
<p>如何找到GTID=？对应的binlog文件：</p>
<ol>
<li>假设现在我们要找GTID=$A，那么MySQL的扫描顺序为：从最后一个binlog开始扫描（即：bin.004）。</li>
<li>bin.004的Previous-GTIDs=1-120，如果$A=140，大于Previous-GTIDs，那么肯定在bin.004中。</li>
<li>bin.004的Previous-GTIDs=1-120，如果$A=88，包含在Previous-GTIDs中，那么继续对比上一个binlog文件bin.003，然后再循环前面2的步骤，直到找到为止。</li>
</ol>
<h3 id="GTID的复制协议（COM-BINLOG-DUMP-GTID）"><a href="#GTID的复制协议（COM-BINLOG-DUMP-GTID）" class="headerlink" title="GTID的复制协议（COM_BINLOG_DUMP_GTID）"></a>GTID的复制协议（COM_BINLOG_DUMP_GTID）</h3><ol>
<li>从服务器向主服务器发送已经执行过的GTID。</li>
<li>主服务器将所有接下来的GTID发送给从服务器。</li>
<li>同样的GTID不能被执行两次，如果有同样的GTID，会自动被skip掉</li>
</ol>
<p><img src="/images/image-20220302172703328.png" alt="image-20220302172703328"></p>
<h3 id="传统复制与GTID对比"><a href="#传统复制与GTID对比" class="headerlink" title="传统复制与GTID对比"></a>传统复制与GTID对比</h3><h4 id="传统复制"><a href="#传统复制" class="headerlink" title="传统复制"></a>传统复制</h4><p><img src="/images/image-20220302172901287.png" alt="image-20220302172901287"></p>
<p>Master服务器宕机，需要将业务切换到Slave1上。同时，我们又需要将Slave2的复制源改成Slave1。</p>
<p>这种方式的难点在于，由于同一个事务在每台机器上所在的binlog名字和位置都不一样，那么怎么找到Slave2当前同步停止点对应Slavel上master_log_file和master_log_pos的位置就成为了难题。</p>
<h4 id="GTID-复制"><a href="#GTID-复制" class="headerlink" title="GTID 复制"></a>GTID 复制</h4><p><img src="/images/image-20220302173157992.png" alt="image-20220302173157992"></p>
<p>由于同一事务的GTID在所有节点上的值一致，那么根据slave2当前停止点的GTID就能定位到slave1上的GTID。直接使用<code>CHANGE MASTER TO MASTER_HOST=&#39;xxx&#39;，MASTER_AUTO_POSITION=1</code>命令就可以直接完成failover的工作。</p>
<h2 id="配置基于GTID的复制"><a href="#配置基于GTID的复制" class="headerlink" title="配置基于GTID的复制"></a>配置基于GTID的复制</h2><h3 id="从0开始搭建"><a href="#从0开始搭建" class="headerlink" title="从0开始搭建"></a>从0开始搭建</h3><ol>
<li>配置主从my.cnf文件</li>
<li>创建复制专用账户</li>
<li>使用changemaster更新主从配置</li>
</ol>
<h3 id="传统复制升级为GTID复制"><a href="#传统复制升级为GTID复制" class="headerlink" title="传统复制升级为GTID复制"></a>传统复制升级为GTID复制</h3><ol>
<li>配置主从my.cnf文件</li>
<li>所有服务设置read_only模式，等待主从服务器同步完毕</li>
<li>依次重启主从服务器</li>
<li>使用change master更新主从配置</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;%gtid%&#x27;;</span><br><span class="line">+----------------------------------+-----------+</span><br><span class="line">| Variable_name                    | Value     |</span><br><span class="line">+----------------------------------+-----------+</span><br><span class="line">| binlog_gtid_simple_recovery      | ON        |</span><br><span class="line">| enforce_gtid_consistency         | OFF       |</span><br><span class="line">| gtid_executed_compression_period | 1000      |</span><br><span class="line">| gtid_mode                        | OFF       |</span><br><span class="line">| gtid_next                        | AUTOMATIC |</span><br><span class="line">| gtid_owned                       |           |</span><br><span class="line">| gtid_purged                      |           |</span><br><span class="line">| session_track_gtids              | OFF       |</span><br><span class="line">+----------------------------------+-----------+</span><br></pre></td></tr></table></figure>



<p>master的my.cnf：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server_id</span>=<span class="number">1</span>  <span class="comment">#服务器id</span></span><br><span class="line"><span class="attr">gtid_mode</span>=<span class="literal">on</span> <span class="comment">#开启gtia模式（必选）</span></span><br><span class="line"><span class="attr">enforce_gtidv_consistency</span>=<span class="literal">on</span> <span class="comment">#强制gtid一致性（必选）</span></span><br><span class="line"></span><br><span class="line"><span class="attr">log_bin</span>=master-binlog <span class="comment">#（必选）</span></span><br><span class="line"><span class="attr">log-slave-updates</span>=<span class="number">1</span> <span class="comment">#实现级联同步时，需要开启该参数（必选）。默认情况，SQL线程读取relay-1og而执行的SQL语句并不会记录到bin-log，无法实现三级级联同步（A&gt;B&gt;C）</span></span><br><span class="line"><span class="attr">binlog_format</span>=row <span class="comment">#强烈建议，其他格式可能造成数据不一致</span></span><br><span class="line"></span><br><span class="line"><span class="attr">skip-slave-start</span>=<span class="number">1</span> <span class="comment">#禁止复制线程随mysql服务自动启动</span></span><br></pre></td></tr></table></figure>



<p>slave的my.cnf：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">gtid_mode</span>=<span class="literal">on</span></span><br><span class="line"><span class="attr">enforce_gtid_consistency</span>=<span class="literal">on</span></span><br><span class="line"><span class="attr">server_id</span>=<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">1og-bin</span>=slave-binlog</span><br><span class="line"><span class="attr">log-slave-updates</span>=l</span><br><span class="line"><span class="attr">binlog_format</span>=row <span class="comment">#强烈建议，其他格式可能造成数据不一致</span></span><br><span class="line"></span><br><span class="line"><span class="attr">skip-slave-start</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure>



<h3 id="GTID相关参数"><a href="#GTID相关参数" class="headerlink" title="GTID相关参数"></a>GTID相关参数</h3><ul>
<li>gtid_executed：执行过的所有GTID</li>
<li>gtid_purged：丢弃掉的GTID</li>
<li>gtid_mode：gtid模式</li>
<li>gtid_next：session级别的变量，下一个gtic</li>
<li>gtid_owned：正在运行的gtid</li>
<li>enforce_gtid_consistency：保证GTID安全的参数</li>
</ul>
<h2 id="同步故障处理"><a href="#同步故障处理" class="headerlink" title="同步故障处理"></a>同步故障处理</h2><ul>
<li>主库新增记录，从库提示主键冲突</li>
<li>主库对象可更新，从库无对应的对象可更新</li>
<li>主库对象可删除，从库无对应的对象可删除</li>
<li>主库日志被purged</li>
</ul>
<p>第三种解决方案：</p>
<p>通过注入空事务来跳过：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">stop slave；</span><br><span class="line">set gtid_next=&#x27;jb6a07d2-a357-11e9-b47f-080027ff22e5:88&#x27; # 在gtid为88时出现问题</span><br><span class="line">begin;commit； # 产生一个空事务</span><br><span class="line">set gtid_next=&#x27;AUTOMATIC&#x27;;</span><br><span class="line">start slave;</span><br></pre></td></tr></table></figure>



<h1 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1rr4y1Q7uy">MySQL5.7 集群管理（主从复制、MHA、GTID、PXC）</a></li>
</ul>
</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>