<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="&gt;
&lt;li&gt;&lt;p&gt;&lt;a href=&quot;https://juejin.im/post/5af03345f265da0b7964cf50&quot;&gt;react长列表优化方案: react-virtualized&lt;/a&gt;"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>react-virtualized | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/React/" rel="tag">React</a></div><div class="post-time">2020-09-17</div></div></div><div class="container post-header"><h1>react-virtualized</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E4%B8%80"><span class="toc-number">1.</span> <span class="toc-text">参考一</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E5%85%A5"><span class="toc-number">1.1.</span> <span class="toc-text">引入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8react-virtualized%E4%BC%98%E5%8C%96"><span class="toc-number">1.2.</span> <span class="toc-text">使用react-virtualized优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.2.1.</span> <span class="toc-text">具体实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C"><span class="toc-number">1.2.2.</span> <span class="toc-text">方法二</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E5%88%97%E8%A1%A8%E4%BC%98%E5%8C%96%E9%95%BF%E5%88%97%E8%A1%A8%E7%9A%84%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.</span> <span class="toc-text">虚拟列表优化长列表的原理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E4%BA%8C"><span class="toc-number">2.</span> <span class="toc-text">参考二</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#react-virtualized%E7%AE%80%E4%BB%8B"><span class="toc-number">2.1.</span> <span class="toc-text">react-virtualized简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#react-virtualized%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">2.2.</span> <span class="toc-text">react-virtualized基础组件的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Grid"><span class="toc-number">2.2.1.</span> <span class="toc-text">Grid</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#List"><span class="toc-number">2.2.2.</span> <span class="toc-text">List</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#react-virtualized%E9%AB%98%E9%98%B6%E7%BB%84%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">2.3.</span> <span class="toc-text">react-virtualized高阶组件的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AutoSizer"><span class="toc-number">2.3.1.</span> <span class="toc-text">AutoSizer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CellMeasurer"><span class="toc-number">2.3.2.</span> <span class="toc-text">CellMeasurer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#InfiniteLoader"><span class="toc-number">2.3.3.</span> <span class="toc-text">InfiniteLoader</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E4%B8%89"><span class="toc-number">3.</span> <span class="toc-text">参考三</span></a></li></ol></details></div><div class="container post-content"><ul>
<li><p><a target="_blank" rel="noopener" href="https://juejin.im/post/5af03345f265da0b7964cf50">react长列表优化方案: react-virtualized</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000017233625">在React项目中，如何优雅的优化长列表</a></p>
</li>
</ul>
<h1 id="参考一"><a href="#参考一" class="headerlink" title="参考一"></a>参考一</h1><h2 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h2><p>有教室1/2/3, 每间教室下有1000+个学生.</p>
<p>学生组件为:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Student</span>(<span class="params">&#123;student&#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;student.name&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果我们直接把整个列表渲染出来, 仅仅学生列表就会生成1000+个div标签.</p>
<p>往往, 我们的学生组件都会是:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Student</span>(<span class="params">&#123;student, ...rest&#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">            ...</span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;student.name&#125; ....<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">            ...</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个时候的DOM数量就会变得难以想象.</p>
<p>我们都知道, DOM结构如果过大, 网页就会出现用户操作体验上的问题, 比如滚动, 点击等常用操作. 同时, 对react的虚拟DOM计算以及<strong>虚拟DOM反映到真实DOM的压力</strong>也会很大. 当用户点击切换教室时, 就会出现秒级的卡顿.</p>
<h2 id="使用react-virtualized优化"><a href="#使用react-virtualized优化" class="headerlink" title="使用react-virtualized优化"></a>使用react-virtualized优化</h2><p>解决以上问题的核心思想就是: <strong>只加载可见区域的组件</strong></p>
<ul>
<li>react-virtualized将我们的滚动场景区分为<code>viewport内的局部滚动</code>, 和<code>基于viewport的滚动</code>, </li>
<li>前者相当于在页面中开辟了一个独立的滚动区域，属于内部滚动, 这跟和iscroll的滚动很类似, </li>
<li>而后者则把滚动作为了window滚动的一部分(对于移动端而言，这种更为常见). </li>
<li>基于此计算出当前所需要显示的组件.</li>
</ul>
<h3 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h3><p>学生组件修改为:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Student</span>(<span class="params">&#123;student, style, ...rest&#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;style&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">            ...</span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;student.name&#125; ....<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">            ...</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>学生列表组件:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; AutoSizer &#125; <span class="keyword">from</span> <span class="string">&#x27;react-virtualized/dist/commonjs/AutoSizer&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; List <span class="keyword">as</span> VList &#125; <span class="keyword">from</span> <span class="string">&#x27;react-virtualized/dist/commonjs/List&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StudentList</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(props)</span><br><span class="line">        <span class="built_in">this</span>.state = &#123;</span><br><span class="line">            <span class="attr">list</span>: []</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    getList = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        api.getList.then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">                <span class="attr">list</span>: res</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.getList()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; list &#125; = <span class="built_in">this</span>.state  </span><br><span class="line">        <span class="keyword">const</span> renderItem = <span class="function">(<span class="params">&#123; index, key, style &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Student</span> <span class="attr">key</span>=<span class="string">&#123;key&#125;</span> <span class="attr">student</span>=<span class="string">&#123;list[index]&#125;</span> <span class="attr">style</span>&#123;<span class="attr">style</span>&#125; /&gt;</span></span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;height:</span> <span class="attr">1000</span>&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">AutoSizer</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    &#123;(&#123; width, height &#125;) =&gt; (</span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">VList</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                            <span class="attr">width</span>=<span class="string">&#123;width&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                            <span class="attr">height</span>=<span class="string">&#123;height&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                            <span class="attr">overscanRowCount</span>=<span class="string">&#123;10&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                            <span class="attr">rowCount</span>=<span class="string">&#123;list.length&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                            <span class="attr">rowHeight</span>=<span class="string">&#123;100&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                            <span class="attr">rowRenderer</span>=<span class="string">&#123;renderItem&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                        /&gt;</span></span></span><br><span class="line"><span class="xml">                    )&#125;</span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">AutoSizer</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(外层div样式中的高度不是必须的, 比如你的网页是flex布局, 你可以用flex: 1来让react-virtualized计算出这个高度)</p>
<p>这个时候, 如果每个Student的高度相同的话, 问题基本上就解决啦!</p>
<p>可是, 问题又来了, 有时候我们的Student会是不确定高度的, 可以有两种方法解决问题, 推荐react-virtualized的CellMeasurer组件解决方案</p>
<h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><p>学生列表组件修改为:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; AutoSizer &#125; <span class="keyword">from</span> <span class="string">&#x27;react-virtualized/dist/commonjs/AutoSizer&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; List <span class="keyword">as</span> VList &#125; <span class="keyword">from</span> <span class="string">&#x27;react-virtualized/dist/commonjs/List&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; CellMeasurerCache, CellMeasurer &#125; <span class="keyword">from</span> <span class="string">&#x27;react-virtualized/dist/commonjs/CellMeasurer&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StudentList</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(props)</span><br><span class="line">        <span class="built_in">this</span>.state = &#123;</span><br><span class="line">            <span class="attr">list</span>: []</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    measureCache = <span class="keyword">new</span> CellMeasurerCache(&#123;</span><br><span class="line">        <span class="attr">fixedWidth</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">minHeight</span>: <span class="number">58</span></span><br><span class="line">    &#125;)</span><br><span class="line">    getList = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        api.getList.then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">                <span class="attr">list</span>: res</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.getList()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; list &#125; = <span class="built_in">this</span>.state  </span><br><span class="line">        <span class="keyword">const</span> renderItem = <span class="function">(<span class="params">&#123; index, key, parent, style &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (</span><br><span class="line">                <span class="xml"><span class="tag">&lt;<span class="name">CellMeasurer</span> <span class="attr">cache</span>=<span class="string">&#123;this.measureCache&#125;</span> <span class="attr">columnIndex</span>=<span class="string">&#123;0&#125;</span> <span class="attr">key</span>=<span class="string">&#123;key&#125;</span> <span class="attr">parent</span>=<span class="string">&#123;parent&#125;</span> <span class="attr">rowIndex</span>=<span class="string">&#123;index&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">Student</span> <span class="attr">key</span>=<span class="string">&#123;key&#125;</span> <span class="attr">student</span>=<span class="string">&#123;list[index]&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">CellMeasurer</span>&gt;</span></span></span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;height:</span> <span class="attr">1000</span>&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">AutoSizer</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    &#123;(&#123; width, height &#125;) =&gt; (</span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">VList</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                            <span class="attr">ref</span>=<span class="string">&#123;ref</span> =&gt;</span> this.VList = ref&#125;</span></span><br><span class="line"><span class="xml">                            width=&#123;width&#125;</span></span><br><span class="line"><span class="xml">                            height=&#123;height&#125;</span></span><br><span class="line"><span class="xml">                            overscanRowCount=&#123;10&#125;</span></span><br><span class="line"><span class="xml">                            rowCount=&#123;list.length&#125;</span></span><br><span class="line"><span class="xml">                            rowHeight=&#123;this.getRowHeight&#125;</span></span><br><span class="line"><span class="xml">                            rowRenderer=&#123;renderItem&#125;</span></span><br><span class="line"><span class="xml">                            deferredMeasurementCache=&#123;this.measureCache&#125;</span></span><br><span class="line"><span class="xml">                            rowHeight=&#123;this.measureCache.rowHeight&#125;</span></span><br><span class="line"><span class="xml">                        /&gt;</span></span><br><span class="line"><span class="xml">                    )&#125;</span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">AutoSizer</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h2 id="虚拟列表优化长列表的原理"><a href="#虚拟列表优化长列表的原理" class="headerlink" title="虚拟列表优化长列表的原理"></a>虚拟列表优化长列表的原理</h2><ul>
<li><strong>用数组保存所有列表元素的位置，只渲染可视区内的列表元素，当可视区滚动时，根据滚动的offset大小以及所有列表元素的位置，计算在可视区应该渲染哪些元素。</strong></li>
</ul>
<p>具体实现步骤如下所示：</p>
<ol>
<li>首先确定长列表所在父元素的大小，父元素的大小决定了可视区的宽和高</li>
<li>确定长列表每一个列表元素的宽和高，同时初始的条件下计算好长列表每一个元素相对于父元素的位置，并用一个数组来保存所有列表元素的位置信息</li>
<li>首次渲染时，只展示相对于父元素可视区内的子列表元素，在滚动时，根据父元素的滚动的offset重新计算应该在可视区内的子列表元素。这样保证了无论如何滚动，真实渲染出的dom节点只有可视区内的列表元素。</li>
<li>假设可视区内能展示5个子列表元素，及时长列表总共有1000个元素，但是每时每刻，真实渲染出来的dom节点只有5个。</li>
<li>补充说明，这种情况下，父元素一般使用position：relative，子元素的定位一般使用：position：absolute或sticky</li>
</ol>
<h1 id="参考二"><a href="#参考二" class="headerlink" title="参考二"></a>参考二</h1><h2 id="react-virtualized简介"><a href="#react-virtualized简介" class="headerlink" title="react-virtualized简介"></a>react-virtualized简介</h2><ul>
<li>react-virtualized是一个以高效渲染大型列表和表格数据的响应式组件</li>
<li>react-virtualized是一个实现虚拟列表较为优秀的组件库，react-virtualized提供了一些基础组件用于实现虚拟列表，虚拟网格，虚拟表格等等，它们都可以减小不必要的dom渲染。此外还提供了几个高阶组件，可以实现动态子元素高度，以及自动填充可视区等等。</li>
</ul>
<p>react-virtualized的基础组件包含：</p>
<ul>
<li>Grid：用于优化构建任意网状的结构，传入一个二维的数组，渲染出类似棋盘的结构。</li>
<li>List：List是基于Grid来实现的，但是是一个维的列表，而不是网状。</li>
<li>Table：Table也是基于Grid来实现，表格具有固定的头部，并且可以在垂直方向上滚动</li>
<li>Masonry：同样可以在水平方向，也可以在垂直方向滚动，不同于Grid的是可以自定义每个元素的大小，或者子元素的大小也可以是动态变化的</li>
<li>Collection：类似于瀑布流的形式，同样可以水平和垂直方向滚动。</li>
</ul>
<p>值得注意的是这些基础组件都是继承于React中的PureComponent，因此当state变化的时候，只会做一个<strong>浅比较</strong>来确定重新渲染与否。</p>
<p>除了这几个基础组件外，react-virtualized还提供了几个高阶组件，比如ArrowKeyStepper、AutoSizer、CellMeasurer、InfiniteLoader等，本文具体介绍常用的AutoSizer、CellMeasurer和InfiniteLoader。</p>
<ul>
<li>AutoSizer：用于一个子元素的情况，通过AutoSizer包含的子元素会根据父元素Resize的变化，自动调节该子元素的可视区的宽度和高度，同时调节的还有该子元素可视区真实渲染的dom元素的数目。</li>
<li>CellMeasurer：这个高阶组件可以动态的改变子元素的高度，适用于提前不知道长列表中每一个子元素高度的情况。</li>
<li>InfiniteLoader：这个高阶组件用于Table或者List的无限滚动，适用于滚动时异步请求等情况</li>
</ul>
<h2 id="react-virtualized基础组件的使用"><a href="#react-virtualized基础组件的使用" class="headerlink" title="react-virtualized基础组件的使用"></a>react-virtualized基础组件的使用</h2><h3 id="Grid"><a href="#Grid" class="headerlink" title="Grid"></a>Grid</h3><ul>
<li>所有基础组件基本上都是基于Grid构成的，</li>
<li>一个简单的Grid的例子如下：</li>
</ul>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Grid &#125; <span class="keyword">from</span> <span class="string">&#x27;react-virtualized&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> list = [</span><br><span class="line">  [<span class="string">&#x27;Jony yu&#x27;</span>, <span class="string">&#x27;Software Engineer&#x27;</span>, <span class="string">&#x27;Shenzhen&#x27;</span>, <span class="string">&#x27;CHINA&#x27;</span>, <span class="string">&#x27;GUANGZHOU&#x27;</span>],</span><br><span class="line">  [<span class="string">&#x27;Jony yu&#x27;</span>, <span class="string">&#x27;Software Engineer&#x27;</span>, <span class="string">&#x27;Shenzhen&#x27;</span>, <span class="string">&#x27;CHINA&#x27;</span>, <span class="string">&#x27;GUANGZHOU&#x27;</span>],</span><br><span class="line">  [<span class="string">&#x27;Jony yu&#x27;</span>, <span class="string">&#x27;Software Engineer&#x27;</span>, <span class="string">&#x27;Shenzhen&#x27;</span>, <span class="string">&#x27;CHINA&#x27;</span>, <span class="string">&#x27;GUANGZHOU&#x27;</span>],</span><br><span class="line">  [<span class="string">&#x27;Jony yu&#x27;</span>, <span class="string">&#x27;Software Engineer&#x27;</span>, <span class="string">&#x27;Shenzhen&#x27;</span>, <span class="string">&#x27;CHINA&#x27;</span>, <span class="string">&#x27;GUANGZHOU&#x27;</span>],</span><br><span class="line">  [<span class="string">&#x27;Jony yu&#x27;</span>, <span class="string">&#x27;Software Engineer&#x27;</span>, <span class="string">&#x27;Shenzhen&#x27;</span>, <span class="string">&#x27;CHINA&#x27;</span>, <span class="string">&#x27;GUANGZHOU&#x27;</span>],</span><br><span class="line">  [<span class="string">&#x27;Jony yu&#x27;</span>, <span class="string">&#x27;Software Engineer&#x27;</span>, <span class="string">&#x27;Shenzhen&#x27;</span>, <span class="string">&#x27;CHINA&#x27;</span>, <span class="string">&#x27;GUANGZHOU&#x27;</span>]</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cellRenderer</span> (<span class="params">&#123; columnIndex, key, rowIndex, style &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="name">div</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">      <span class="attr">key</span>=<span class="string">&#123;key&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">      <span class="attr">style</span>=<span class="string">&#123;style&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">    &gt;</span></span></span><br><span class="line"><span class="xml">      &#123;list[rowIndex][columnIndex]&#125;</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line">render(</span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">Grid</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">   <span class="attr">cellRenderer</span>=<span class="string">&#123;cellRenderer&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">    </span></span></span><br><span class="line"><span class="tag"><span class="xml">   <span class="attr">columnCount</span>=<span class="string">&#123;list[0].length&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">   <span class="attr">rowCount</span>=<span class="string">&#123;list.length&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">    </span></span></span><br><span class="line"><span class="tag"><span class="xml">   <span class="attr">columnWidth</span>=<span class="string">&#123;100&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">   <span class="attr">rowHeight</span>=<span class="string">&#123;80&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">    </span></span></span><br><span class="line"><span class="tag"><span class="xml">   <span class="attr">height</span>=<span class="string">&#123;300&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">   <span class="attr">width</span>=<span class="string">&#123;300&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">  /&gt;</span></span>,</span><br><span class="line">  rootEl</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<ul>
<li>渲染网格也是只渲染可视区的dom节点，</li>
<li>有个有趣的现象是滚动条的大小，这里Grid做了一个细节优化，只有滚动的时候才会显示滚动条，停止滚动后会隐藏滚动条。</li>
</ul>
<h3 id="List"><a href="#List" class="headerlink" title="List"></a>List</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; List &#125; <span class="keyword">from</span> <span class="string">&#x27;react-virtualized&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span>  loremIpsum <span class="keyword">from</span> <span class="string">&quot;lorem-ipsum&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rowCount = <span class="number">1000</span>;</span><br><span class="line"><span class="keyword">const</span> list = <span class="built_in">Array</span>(rowCount).fill().map(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> loremIpsum(&#123;</span><br><span class="line">        <span class="attr">count</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">units</span>: <span class="string">&#x27;sentences&#x27;</span>,</span><br><span class="line">        <span class="attr">sentenceLowerBound</span>: <span class="number">3</span>,</span><br><span class="line">        <span class="attr">sentenceUpperBound</span>: <span class="number">3</span></span><br><span class="line">      &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rowRenderer</span> (<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">  key,         </span></span></span><br><span class="line"><span class="params"><span class="function">  index,      </span></span></span><br><span class="line"><span class="params"><span class="function">  isScrolling, </span></span></span><br><span class="line"><span class="params"><span class="function">  isVisible,   </span></span></span><br><span class="line"><span class="params"><span class="function">  style      </span></span></span><br><span class="line"><span class="params"><span class="function">&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="name">div</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">      <span class="attr">key</span>=<span class="string">&#123;key&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">      <span class="attr">style</span>=<span class="string">&#123;style&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">    &gt;</span></span></span><br><span class="line"><span class="xml">      &#123;list[index]&#125;</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">TestList</span> <span class="keyword">extends</span> <span class="title">Component</span></span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;height:</span>&quot;<span class="attr">300px</span>&quot;,<span class="attr">width:</span>&quot;<span class="attr">200px</span>&quot;&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">List</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">              <span class="attr">width</span>=<span class="string">&#123;300&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">              <span class="attr">height</span>=<span class="string">&#123;300&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">              <span class="attr">rowCount</span>=<span class="string">&#123;list.length&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">              <span class="attr">rowHeight</span>=<span class="string">&#123;20&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">              <span class="attr">rowRenderer</span>=<span class="string">&#123;rowRenderer&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">             /&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>List的使用方法也是极简，指定列表总条数rowCount，每一条的高度rowHeight以及每次渲染的函数rowRenderer，就可以构建一个渲染列表。</p>
<h2 id="react-virtualized高阶组件的使用"><a href="#react-virtualized高阶组件的使用" class="headerlink" title="react-virtualized高阶组件的使用"></a>react-virtualized高阶组件的使用</h2><h3 id="AutoSizer"><a href="#AutoSizer" class="headerlink" title="AutoSizer"></a>AutoSizer</h3><ul>
<li>首先来看使用不使用AutoSizer的缺点，List只能指定固定的大小，如果其所在的父元素的大小resize了，那么List是不会主动填满父元素的可视区的：</li>
<li>List是无法自动填充父元素的。因此我们这里需要使用AutoSizer。AutoSizer的使用也很简单，我们只需要在List的基础上：</li>
<li>增加了AutoSizer可以动态的适应父元素宽度和高度的变化。</li>
</ul>
<h3 id="CellMeasurer"><a href="#CellMeasurer" class="headerlink" title="CellMeasurer"></a>CellMeasurer</h3><ul>
<li><strong>上面代码也有问题，子元素太长，换行后改变了子元素的高度后无法子适应，也就是说仅仅通过基础的组件List是不支持子元素的高度动态改变的场景</strong>。</li>
<li>为了解决上述的子元素可以动态变化的问题，我们可以利用高阶组件CellMeasurer：</li>
</ul>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; List,AutoSizer,CellMeasurer, CellMeasurerCache&#125; <span class="keyword">from</span> <span class="string">&#x27;react-virtualized&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> cache = <span class="keyword">new</span> CellMeasurerCache(&#123; <span class="attr">defaultHeight</span>: <span class="number">30</span>,<span class="attr">fixedWidth</span>: <span class="literal">true</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cellRenderer</span> (<span class="params">&#123; index, key, parent, style &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(index)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="name">CellMeasurer</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">      <span class="attr">cache</span>=<span class="string">&#123;cache&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">      <span class="attr">columnIndex</span>=<span class="string">&#123;0&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">      <span class="attr">key</span>=<span class="string">&#123;key&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">      <span class="attr">parent</span>=<span class="string">&#123;parent&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">      <span class="attr">rowIndex</span>=<span class="string">&#123;index&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">    &gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">div</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">        <span class="attr">style</span>=<span class="string">&#123;style&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">      &gt;</span></span></span><br><span class="line"><span class="xml">        &#123;list[index]&#125;</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">CellMeasurer</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>对于需要渲染的List，如下所示：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestList</span> <span class="keyword">extends</span> <span class="title">Component</span></span>&#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">             <span class="tag">&lt;<span class="name">AutoSizer</span>&gt;</span></span></span><br><span class="line"><span class="xml">              &#123;(&#123; height, width &#125;) =&gt; (</span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">List</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                  <span class="attr">height</span>=<span class="string">&#123;height&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                  <span class="attr">rowCount</span>=<span class="string">&#123;list.length&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                  <span class="attr">rowHeight</span>=<span class="string">&#123;cache.rowHeight&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                  <span class="attr">deferredMeasurementCache</span>=<span class="string">&#123;cache&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                  <span class="attr">rowRenderer</span>=<span class="string">&#123;cellRenderer&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                  <span class="attr">width</span>=<span class="string">&#123;width&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                /&gt;</span></span></span><br><span class="line"><span class="xml">              )&#125;</span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">AutoSizer</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>子列表元素的高度可以动态变化，通过CellMeasurer可以实现子元素的动态高度。</p>
<h3 id="InfiniteLoader"><a href="#InfiniteLoader" class="headerlink" title="InfiniteLoader"></a>InfiniteLoader</h3><p>最后我们来考虑这种无限滚动的场景，很多情况下我们可能需要分页加载，就是常见的在可视区内无限滚动的场景。react-virtualized提供了一个高阶组件InfiniteLoader用于实现无限滚动。</p>
<p>InfiniteLoader的使用很简单，只要按着文档来即可，就是分页的去在家下一页，滚动分页所调用的函数为：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadMoreRows</span> (<span class="params">&#123; startIndex, stopIndex &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve,reject</span>)</span>&#123;</span><br><span class="line">    resolve()</span><br><span class="line">  &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//模拟ajax请求</span></span><br><span class="line">    <span class="keyword">let</span> temList = <span class="built_in">Array</span>(<span class="number">10</span>).fill(<span class="number">1</span>).map(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> loremIpsum(&#123;</span><br><span class="line">            <span class="attr">count</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">units</span>: <span class="string">&#x27;sentences&#x27;</span>,</span><br><span class="line">            <span class="attr">sentenceLowerBound</span>:<span class="number">3</span>,</span><br><span class="line">            <span class="attr">sentenceUpperBound</span>:<span class="number">3</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    list = list.concat(temList)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看起来跟基础组件List一样，其实唯一的区别就是会在滚动的时候自动执行loadMoreRows函数去更新list</p>
<h1 id="参考三"><a href="#参考三" class="headerlink" title="参考三"></a>参考三</h1><p>主要功能可以从两方面概括：</p>
<ul>
<li>布局<ul>
<li>Collection</li>
<li>Grid</li>
<li>List</li>
<li>Masonry（堆砌）</li>
<li>Table</li>
</ul>
</li>
<li>可组装功能<ul>
<li>Arrow Key Stepper，单元格的方向键导航</li>
<li>AutoSizer，自动管理列表/表格的宽度和高度</li>
<li>CellMeasurer，自动计算单元格的高度，适用于动态高度的数据行</li>
<li>ColumnSizer，设定列宽的宽高管理</li>
<li>InfiniteLoader，支持分页预读取的无限滚动</li>
<li>MultiGrid, 类似冻结行列的组合Grid</li>
<li>ScrollSync，用于同步多个Grid之间的滚动的工具组件</li>
<li>WindowScroller，用于把滚动事件绑定在列表之上的容器（div或window）</li>
</ul>
</li>
</ul>
<p>这里以搜索界面的代码为例，这是一个包含了分页数据、外部容器滚动、动态高度列表。在这个例子里，我们用到了以下这些类（按嵌套的层级关系列出）：</p>
<ul>
<li>InfiniteLoader，用于分页取结果<ul>
<li>WindowScroller，用于将滚动事件绑定在外部容器上<ul>
<li>List，列表数据的呈现<ul>
<li>CellMeasurer，计算单元格高度</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>CellMeasurerCache，用于计算和缓存不同的单元格的高度</li>
</ul>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 列表的渲染方法：renderSearchResult()</span></span><br><span class="line"><span class="function"><span class="title">renderSearchResult</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; recordPerPage, onFetchMore, refLayoutMain &#125; = <span class="built_in">this</span>.props;</span><br><span class="line">    <span class="keyword">const</span> remoteRowCount = <span class="built_in">this</span>.state.result.total;</span><br><span class="line">    <span class="keyword">const</span> cache = <span class="built_in">this</span>.cellMeasurerCache;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!refLayoutMain) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="name">InfiniteLoader</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">        <span class="attr">isRowLoaded</span>=<span class="string">&#123;this.isResultRowLoaded&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">        <span class="attr">loadMoreRows</span>=<span class="string">&#123;onFetchMore&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">        <span class="attr">rowCount</span>=<span class="string">&#123;remoteRowCount&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">        <span class="attr">threshold</span>=<span class="string">&#123;recordPerPage</span> <span class="attr">-</span> <span class="attr">PAGE_PREFETCH_THRESHOLD</span>&#125;</span></span></span><br><span class="line"><span class="tag"><span class="xml">      &gt;</span></span></span><br><span class="line"><span class="xml">        &#123;(&#123; onRowsRendered, registerChild &#125;) =&gt; &#123;</span></span><br><span class="line"><span class="xml">          // logger.debug(&#x27;render window scroller with ref:&#x27;, refLayoutMain);</span></span><br><span class="line"><span class="xml">          const listMinHeight = 40;</span></span><br><span class="line"><span class="xml">          const defaultPanelWidth = 896;</span></span><br><span class="line"><span class="xml">          const mockOnRowsRendered = (...args) =&gt; &#123;</span></span><br><span class="line"><span class="xml">            const ret = onRowsRendered(...args);</span></span><br><span class="line"><span class="xml">            // logger.debug(&#x27;onRowsRendered:&#x27;, ...args, &#x27;return value:&#x27;, ret);</span></span><br><span class="line"><span class="xml">            return ret;</span></span><br><span class="line"><span class="xml">          &#125;;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">          return (<span class="tag">&lt;<span class="name">WindowScroller</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">scrollElement</span>=<span class="string">&#123;refLayoutMain&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">          &gt;</span></span></span><br><span class="line"><span class="xml">            &#123;(&#123; height, isScrolling, onChildScroll, scrollTop &#125;) =&gt; &#123;</span></span><br><span class="line"><span class="xml">              // logger.debug(</span></span><br><span class="line"><span class="xml">              // &#x27;Window scroller render with height:&#x27;, height, &#x27;container:&#x27;, refLayoutMain);</span></span><br><span class="line"><span class="xml">              return (</span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">List</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                  <span class="attr">ref</span>=<span class="string">&#123;(node)</span> =&gt;</span> &#123; this.refResultList = node; registerChild(node); &#125;&#125;</span></span><br><span class="line"><span class="xml">                  onRowsRendered=&#123;mockOnRowsRendered&#125;</span></span><br><span class="line"><span class="xml">                  className=&quot;setting-main-custom-card search-result-scroller&quot;</span></span><br><span class="line"><span class="xml">                  autoHeight</span></span><br><span class="line"><span class="xml">                  height=&#123;height || listMinHeight&#125;</span></span><br><span class="line"><span class="xml">                  width=&#123;this.panelWidth || defaultPanelWidth&#125;</span></span><br><span class="line"><span class="xml">                  isScrolling=&#123;isScrolling&#125;</span></span><br><span class="line"><span class="xml">                  onScroll=&#123;onChildScroll&#125;</span></span><br><span class="line"><span class="xml">                  scrollTop=&#123;scrollTop&#125;</span></span><br><span class="line"><span class="xml">                  deferredMeasurementCache=&#123;cache&#125;</span></span><br><span class="line"><span class="xml">                  rowHeight=&#123;cache.rowHeight&#125;</span></span><br><span class="line"><span class="xml">                  rowCount=&#123;remoteRowCount&#125;</span></span><br><span class="line"><span class="xml">                  rowRenderer=&#123;this.renderListCell&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">                /&gt;</span></span><br><span class="line"><span class="xml">              );</span></span><br><span class="line"><span class="xml">            &#125;&#125;</span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;/<span class="name">WindowScroller</span>&gt;</span>);</span></span><br><span class="line"><span class="xml">        &#125;&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">InfiniteLoader</span>&gt;</span></span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 单元格的渲染方法：renderListCell()</span></span><br><span class="line">renderListCell = <span class="function">(<span class="params">&#123; index, key, parent, style &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// logger.debug(&#x27;render list cell:&#x27;, index, key, style);</span></span><br><span class="line">  <span class="keyword">const</span> resultList = <span class="built_in">this</span>.state.result.list;</span><br><span class="line">  <span class="keyword">const</span> data = (index === resultList.length &amp;&amp; <span class="built_in">this</span>.props.searchResult.has_next) ?</span><br><span class="line">        loadingResultData.list[<span class="number">0</span>] : resultList[index]; <span class="comment">// loading or record</span></span><br><span class="line">  <span class="keyword">const</span> cache = <span class="built_in">this</span>.cellMeasurerCache;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">  	<span class="xml"><span class="tag">&lt;<span class="name">CellMeasurer</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">      <span class="attr">cache</span>=<span class="string">&#123;cache&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">      <span class="attr">columnIndex</span>=<span class="string">&#123;0&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">      <span class="attr">key</span>=<span class="string">&#123;key&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">      <span class="attr">parent</span>=<span class="string">&#123;parent&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">      <span class="attr">rowIndex</span>=<span class="string">&#123;index&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">    &gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">SearchResultItemRenderer</span> <span class="attr">data</span>=<span class="string">&#123;data&#125;</span> <span class="attr">style</span>=<span class="string">&#123;style&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">CellMeasurer</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



















</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>