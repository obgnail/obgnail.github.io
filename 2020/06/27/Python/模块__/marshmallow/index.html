<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="地址 : &lt;a href=&quot;https://www.cnblogs.com/ChangAn223/p/11305376.html&quot;&gt;Marshmallow详解&lt;/a&gt;"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>marshmallow | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Python/" rel="tag">Python</a></div><div class="post-time">2020-06-27</div></div></div><div class="container post-header"><h1>marshmallow</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A5%E9%97%A8%E4%BD%BF%E7%94%A8"><span class="toc-number">1.</span> <span class="toc-text">入门使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Schema"><span class="toc-number">2.</span> <span class="toc-text">Schema</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Serializing%EF%BC%88%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%89"><span class="toc-number">3.</span> <span class="toc-text">Serializing（序列化）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deserializing%EF%BC%88%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%89"><span class="toc-number">4.</span> <span class="toc-text">Deserializing（反序列化）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Objects-lt-gt-List-%E5%BA%8F%E5%88%97%E5%8C%96%E5%B5%8C%E5%A5%97%E5%AF%B9%E8%B1%A1"><span class="toc-number">5.</span> <span class="toc-text">Objects &lt;-&gt; List(序列化嵌套对象)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Validation%E9%AA%8C%E8%AF%81"><span class="toc-number">6.</span> <span class="toc-text">Validation验证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E8%A3%85%E9%A5%B0%E5%99%A8%E6%B3%A8%E5%86%8C%E9%AA%8C%E8%AF%81%E6%96%B9%E6%B3%95"><span class="toc-number">6.1.</span> <span class="toc-text">使用装饰器注册验证方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Fields%E7%9A%84required%E5%8F%82%E6%95%B0-default%E5%8F%82%E6%95%B0%E5%92%8Cerror-messages%E5%8F%82%E6%95%B0"><span class="toc-number">6.2.</span> <span class="toc-text">Fields的required参数,default参数和error_messages参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%BD%E7%95%A5required-True%E7%9A%84%E5%AD%97%E6%AE%B5"><span class="toc-number">6.3.</span> <span class="toc-text">忽略required&#x3D;True的字段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E6%9C%AA%E7%9F%A5%E5%AD%97%E6%AE%B5"><span class="toc-number">6.4.</span> <span class="toc-text">处理未知字段</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Schema-validate-%E5%8D%95%E7%BA%AF%E7%9A%84%E6%A0%A1%E9%AA%8C%E6%95%B0%E6%8D%AE"><span class="toc-number">7.</span> <span class="toc-text">Schema.validate(单纯的校验数据)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E5%BA%8F%E5%88%97%E5%8C%96-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%94%AE"><span class="toc-number">8.</span> <span class="toc-text">指定序列化&#x2F;反序列化键</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#fields%E7%9A%84attribute%E6%8C%87%E5%AE%9A%E5%BA%8F%E5%88%97%E5%8C%96%E9%94%AE"><span class="toc-number">8.1.</span> <span class="toc-text">fields的attribute指定序列化键</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fields%E7%9A%84load-from%E6%8C%87%E5%AE%9A%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%94%AE"><span class="toc-number">8.2.</span> <span class="toc-text">fields的load_from指定反序列化键</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fileds%E7%9A%84data-key%E5%90%8C%E6%97%B6%E6%BB%A1%E8%B6%B3%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">8.3.</span> <span class="toc-text">fileds的data_key同时满足序列化与反序列化的方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8fields-Function%E5%88%9B%E5%BB%BA%E6%96%B0%E7%9A%84%E5%AD%97%E6%AE%B5"><span class="toc-number">9.</span> <span class="toc-text">使用fields.Function创建新的字段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8ordered%E9%80%89%E9%A1%B9%E8%BF%9B%E8%A1%8C%E6%8E%92%E5%BA%8F"><span class="toc-number">10.</span> <span class="toc-text">使用ordered选项进行排序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AD%97%E6%AE%B5"><span class="toc-number">11.</span> <span class="toc-text">自定义字段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E6%89%A9%E5%B1%95"><span class="toc-number">12.</span> <span class="toc-text">数据处理扩展</span></a></li></ol></details></div><div class="container post-content"><p>地址 : <a target="_blank" rel="noopener" href="https://www.cnblogs.com/ChangAn223/p/11305376.html">Marshmallow详解</a></p>
<p>marshmallow是一个用来将复杂的orm对象<strong>与python原生数据类型之间相互转换</strong>的库，</p>
<blockquote>
<p>简而言之，就是实现<code>object -&gt; dict</code>， <code>objects -&gt; list</code>， <code>string -&gt; dict</code>和 <code>string -&gt; list</code>。</p>
</blockquote>
<h2 id="入门使用"><a href="#入门使用" class="headerlink" title="入门使用"></a>入门使用</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> marshmallow <span class="keyword">import</span> Schema, fields, pprint</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, email</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.email = email</span><br><span class="line">        self.created_at = datetime.datetime.now()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&lt;User(name=&#123;self.name!r&#125;)&gt;&#x27;</span>.<span class="built_in">format</span>(self=self)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSchema</span>(<span class="params">Schema</span>):</span></span><br><span class="line">    name = fields.Str()</span><br><span class="line">    email = fields.Email()</span><br><span class="line">    created_at = fields.DateTime()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 序列化</span></span><br><span class="line">user = User(name=<span class="string">&quot;Monty&quot;</span>, email=<span class="string">&quot;monty@python.org&quot;</span>)</span><br><span class="line">schema = UserSchema()</span><br><span class="line">result = schema.dump(user)  <span class="comment"># dump()方法实现obj -&gt; dict</span></span><br><span class="line">pprint(result)</span><br><span class="line"><span class="comment"># &#123;&#x27;created_at&#x27;: &#x27;2020-06-27T11:24:27.546501&#x27;,</span></span><br><span class="line"><span class="comment">#  &#x27;email&#x27;: &#x27;monty@python.org&#x27;,</span></span><br><span class="line"><span class="comment">#  &#x27;name&#x27;: &#x27;Monty&#x27;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 过滤输出</span></span><br><span class="line"><span class="comment"># only参数用来指定输出的字段，也可以用exclude参数来排除不输出的字段，达到一样的效果。</span></span><br><span class="line">summary_schema = UserSchema(only=(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;email&#x27;</span>))</span><br><span class="line">pprint(summary_schema.dump(user))  <span class="comment"># &#123;&#x27;email&#x27;: &#x27;monty@python.org&#x27;, &#x27;name&#x27;: &#x27;Monty&#x27;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 反序列化</span></span><br><span class="line">user_data = &#123;</span><br><span class="line">    <span class="string">&#x27;created_at&#x27;</span>: <span class="string">&#x27;2014-08-11T05:26:03.869245&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;email&#x27;</span>: <span class="string">u&#x27;ken@yahoo.com&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">u&#x27;Ken&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">schema = UserSchema()</span><br><span class="line">result = schema.load(user_data)</span><br><span class="line">pprint(result)</span><br><span class="line"><span class="comment"># &#123;&#x27;created_at&#x27;: datetime.datetime(2014, 8, 11, 5, 26, 3, 869245),</span></span><br><span class="line"><span class="comment">#  &#x27;email&#x27;: &#x27;ken@yahoo.com&#x27;,</span></span><br><span class="line"><span class="comment">#  &#x27;name&#x27;: &#x27;Ken&#x27;&#125;</span></span><br></pre></td></tr></table></figure>



<h2 id="Schema"><a href="#Schema" class="headerlink" title="Schema"></a>Schema</h2><ul>
<li>要<strong>对一个类或者一个json数据实现相互转换</strong>（即序列化和反序列化，序列化的意思是将数据转化为可存储或可传输的数据类型），需要一个中间载体，这个载体就是Schema。</li>
<li>除了转换以外，Schema还可以用来做数据校验。每个需要转换的类，都需要一个对应的Schema：</li>
</ul>
<h2 id="Serializing（序列化）"><a href="#Serializing（序列化）" class="headerlink" title="Serializing（序列化）"></a>Serializing（序列化）</h2><p>序列化使用schema中的<code>dump()</code>或<code>dumps()</code>方法，其中，<code>dump()</code> 方法实现<code>obj -&gt; dict</code>，<code>dumps()</code>方法实现 <code>obj -&gt; string</code>，由于Flask能直接序列化dict（使用jsonify），而且你肯定还会对dict进一步处理，没必要现在转化成string，所以通常Flask与Marshmallow配合序列化时，用 <code>dump()</code>方法即可：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> marshmallow <span class="keyword">import</span> pprint</span><br><span class="line"></span><br><span class="line">user = User(name=<span class="string">&quot;Monty&quot;</span>, email=<span class="string">&quot;monty@python.org&quot;</span>)</span><br><span class="line">schema = UserSchema()</span><br><span class="line">result = schema.dump(user)</span><br><span class="line">pprint(result.data)</span><br><span class="line"><span class="comment"># &#123;&quot;name&quot;: &quot;Monty&quot;,</span></span><br><span class="line"><span class="comment">#  &quot;email&quot;: &quot;monty@python.org&quot;,</span></span><br><span class="line"><span class="comment">#  &quot;created_at&quot;: &quot;2014-08-17T14:54:16.049594+00:00&quot;&#125;</span></span><br></pre></td></tr></table></figure>



<h2 id="Deserializing（反序列化）"><a href="#Deserializing（反序列化）" class="headerlink" title="Deserializing（反序列化）"></a>Deserializing（反序列化）</h2><p>相对<code>dump()</code>的方法就是<code>load()</code>了，可以将字典等类型转换成应用层的数据结构，即orm对象：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 反序列化为字典</span></span><br><span class="line">user_data = &#123;</span><br><span class="line">    <span class="string">&#x27;created_at&#x27;</span>: <span class="string">&#x27;2014-08-11T05:26:03.869245&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;email&#x27;</span>: <span class="string">u&#x27;ken@yahoo.com&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">u&#x27;Ken&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">schema = UserSchema()</span><br><span class="line">result = schema.load(user_data)</span><br><span class="line">pprint(result)</span><br><span class="line"><span class="comment"># &#123;&#x27;name&#x27;: &#x27;Ken&#x27;,</span></span><br><span class="line"><span class="comment">#  &#x27;email&#x27;: &#x27;ken@yahoo.com&#x27;,</span></span><br><span class="line"><span class="comment">#  &#x27;created_at&#x27;: datetime.datetime(2014, 8, 11, 5, 26, 3, 869245)&#125;,</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 反序列化为object</span></span><br><span class="line"><span class="keyword">from</span> marshmallow <span class="keyword">import</span> Schema, fields, post_load</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, email</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.email = email</span><br><span class="line">        self.created_at = datetime.datetime.now()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSchema</span>(<span class="params">Schema</span>):</span></span><br><span class="line">    name = fields.Str()</span><br><span class="line">    email = fields.Email()</span><br><span class="line">    created_at = fields.DateTime()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @post_load</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">make_user</span>(<span class="params">self, data, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> User(**data)</span><br><span class="line"></span><br><span class="line">user_data = &#123;</span><br><span class="line">    <span class="string">&#x27;email&#x27;</span>: <span class="string">u&#x27;ken@yahoo.com&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">u&#x27;Ken&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">schema = UserSchema()</span><br><span class="line">result = schema.load(user_data)</span><br><span class="line">pprint(result)  <span class="comment"># &lt;User(name=&#x27;Ken&#x27;)&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="Objects-lt-gt-List-序列化嵌套对象"><a href="#Objects-lt-gt-List-序列化嵌套对象" class="headerlink" title="Objects &lt;-&gt; List(序列化嵌套对象)"></a>Objects &lt;-&gt; List(序列化嵌套对象)</h2><p>如果多个对象的集合如果是<strong>可迭代的</strong> , 只需在schema中增加一个参数：<code>many=True</code>，即：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">user1 = User(name=<span class="string">&quot;Mick&quot;</span>, email=<span class="string">&quot;mick@stones.com&quot;</span>)</span><br><span class="line">user2 = User(name=<span class="string">&quot;Keith&quot;</span>, email=<span class="string">&quot;keith@stones.com&quot;</span>)</span><br><span class="line">users = [user1, user2]</span><br><span class="line"></span><br><span class="line"><span class="comment"># option 1:</span></span><br><span class="line">schema = UserSchema(many=<span class="literal">True</span>)</span><br><span class="line">result = schema.dump(users)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Option 2:</span></span><br><span class="line">schema = UserSchema()</span><br><span class="line">result = schema.dump(users, many=<span class="literal">True</span>)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure>



<h2 id="Validation验证"><a href="#Validation验证" class="headerlink" title="Validation验证"></a>Validation验证</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> marshmallow <span class="keyword">import</span> ValidationError</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    result = UserSchema().load(&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;John&quot;</span>, <span class="string">&quot;email&quot;</span>: <span class="string">&quot;foo&quot;</span>&#125;)</span><br><span class="line"><span class="keyword">except</span> ValidationError <span class="keyword">as</span> err:</span><br><span class="line">    <span class="comment"># 错误信息</span></span><br><span class="line">    pprint(err.messages)  <span class="comment"># &#123;&quot;email&quot;: [&#x27;&quot;foo&quot; is not a valid email address.&#x27;]&#125;</span></span><br><span class="line">    <span class="comment"># 验证通过的字段</span></span><br><span class="line">    pprint(err.valid_data)  <span class="comment"># &#123;&quot;name&quot;: &quot;John&quot;&#125;</span></span><br></pre></td></tr></table></figure>



<p>你可以向内建的<code>field</code>中传入<code>validate</code> 参数来定制验证的逻辑，<code>validate</code>的值可以是函数，匿名函数<code>lambda</code>，或者是定义了<code>__call__</code>的对象:</p>
<blockquote>
<p>简单来说 , <code>validate</code> 的值是必须是可调用对象</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">validate_func</span>(<span class="params">age</span>):</span></span><br><span class="line">    <span class="keyword">if</span> age &lt; <span class="number">18</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValidationError(<span class="string">&#x27;年龄必须大于等于18&#x27;</span>)  <span class="comment"># 自定义错误信息</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSchema</span>(<span class="params">Schema</span>):</span></span><br><span class="line">    name = fields.Str()</span><br><span class="line">    email = fields.Email()</span><br><span class="line">    age = fields.Number(validate=validate_func)  <span class="comment"># 年龄必须大于等于18</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    in_data = &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Mick&#x27;</span>, <span class="string">&#x27;email&#x27;</span>: <span class="string">&#x27;mick@stones.com&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">16</span>&#125;</span><br><span class="line">    result = UserSchema().load(in_data)</span><br><span class="line"><span class="keyword">except</span> ValidationError <span class="keyword">as</span> err:</span><br><span class="line">    pprint(err.messages)  <span class="comment"># &#123;&#x27;age&#x27;: [&#x27;年龄必须大于等于18&#x27;]&#125;</span></span><br><span class="line">    pprint(err.valid_data)  <span class="comment"># &#123;&#x27;email&#x27;: &#x27;mick@stones.com&#x27;, &#x27;name&#x27;: &#x27;Mick&#x27;&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="使用装饰器注册验证方法"><a href="#使用装饰器注册验证方法" class="headerlink" title="使用装饰器注册验证方法"></a>使用装饰器注册验证方法</h3><p>也可以使用<code>validates</code> 装饰器注册验证方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSchema</span>(<span class="params">Schema</span>):</span></span><br><span class="line">    name = fields.Str()</span><br><span class="line">    email = fields.Email()</span><br><span class="line">    age = fields.Number()  <span class="comment"># 年龄必须大于等于18</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @validates(<span class="params"><span class="string">&#x27;age&#x27;</span></span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_func</span>(<span class="params">self, age</span>):</span></span><br><span class="line">        <span class="keyword">if</span> age &lt; <span class="number">18</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">&#x27;年龄必须大于等于18&#x27;</span>)  <span class="comment"># 自定义错误信息</span></span><br><span class="line"></span><br><span class="line">            </span><br><span class="line"><span class="comment"># 等同于</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">validate_func</span>(<span class="params">age</span>):</span></span><br><span class="line">    <span class="keyword">if</span> age &lt; <span class="number">18</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValidationError(<span class="string">&#x27;年龄必须大于等于18&#x27;</span>)  <span class="comment"># 自定义错误信息</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSchema</span>(<span class="params">Schema</span>):</span></span><br><span class="line">    name = fields.Str()</span><br><span class="line">    email = fields.Email()</span><br><span class="line">    age = fields.Number(validate=validate_func)  <span class="comment"># 年龄必须大于等于18</span></span><br></pre></td></tr></table></figure>



<h3 id="Fields的required参数-default参数和error-messages参数"><a href="#Fields的required参数-default参数和error-messages参数" class="headerlink" title="Fields的required参数,default参数和error_messages参数"></a>Fields的required参数,default参数和error_messages参数</h3><p>和<code>webargs</code>差不多</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSchema</span>(<span class="params">Schema</span>):</span></span><br><span class="line">    name = fields.String(</span><br><span class="line">        required=<span class="literal">True</span></span><br><span class="line">    )</span><br><span class="line">    age = fields.Integer(</span><br><span class="line">        required=<span class="literal">True</span>,</span><br><span class="line">        error_messages=&#123;<span class="string">&#x27;required&#x27;</span>: <span class="string">&#x27;Age is required.&#x27;</span>&#125;</span><br><span class="line">    )</span><br><span class="line">    city = fields.String(</span><br><span class="line">        required=<span class="literal">True</span>,</span><br><span class="line">        error_messages=&#123;<span class="string">&quot;required&quot;</span>: &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;City required&quot;</span>, <span class="string">&quot;code&quot;</span>: <span class="number">400</span>&#125;&#125;,</span><br><span class="line">    )</span><br><span class="line">    email = fields.Email()</span><br><span class="line">    birthdate = fields.DateTime(</span><br><span class="line">    	default=datetime.datetime(<span class="number">2020</span>, <span class="number">9</span>, <span class="number">9</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    result = UserSchema().load(&#123;<span class="string">&quot;email&quot;</span>: <span class="string">&quot;foo@bar.com&quot;</span>&#125;)</span><br><span class="line"><span class="keyword">except</span> ValidationError <span class="keyword">as</span> err:</span><br><span class="line">    pprint(err.messages)</span><br><span class="line">    <span class="comment"># &#123;&#x27;age&#x27;: [&#x27;Age is required.&#x27;],</span></span><br><span class="line">    <span class="comment">#  &#x27;city&#x27;: &#123;&#x27;code&#x27;: 400, &#x27;message&#x27;: &#x27;City required&#x27;&#125;,</span></span><br><span class="line">    <span class="comment">#  &#x27;name&#x27;: [&#x27;Missing data for required field.&#x27;]&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="忽略required-True的字段"><a href="#忽略required-True的字段" class="headerlink" title="忽略required=True的字段"></a>忽略required=True的字段</h3><p>使用<code>partial</code>参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSchema</span>(<span class="params">Schema</span>):</span></span><br><span class="line">    name = fields.String(required=<span class="literal">True</span>)</span><br><span class="line">    age = fields.Integer(required=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者 result = UserSchema(partial=(&#x27;name&#x27;,)).load(&#123;&#x27;age&#x27;: 42&#125;)</span></span><br><span class="line"><span class="comment"># 虽然name为required=True,但是还是能顺利执行</span></span><br><span class="line">result = UserSchema().load(&#123;<span class="string">&quot;age&quot;</span>: <span class="number">42</span>&#125;, partial=(<span class="string">&quot;name&quot;</span>,))</span><br><span class="line"></span><br><span class="line">pprint(result)  <span class="comment"># &#123;&#x27;age&#x27;: 42&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="处理未知字段"><a href="#处理未知字段" class="headerlink" title="处理未知字段"></a>处理未知字段</h3><p>默认情况下，如果传入了未知的字段（Schema里没有的字段），执行load()方法会抛出一个 ValidationError 异常。这种行为可以通过更改 unknown 选项来修改。</p>
<p>unknown 有三个值：</p>
<ul>
<li><code>EXCLUDE</code>: 直接扔掉未知字段</li>
<li><code>INCLUDE</code>: 接受未知字段</li>
<li><code>RAISE</code>: 抛出异常 , 默认</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSchema</span>(<span class="params">Schema</span>):</span></span><br><span class="line">    email = fields.Email()</span><br><span class="line">    created_time = fields.DateTime()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        unknown = INCLUDE</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">user_data = &#123;</span><br><span class="line">    <span class="string">&#x27;email&#x27;</span>: <span class="string">u&#x27;ken@yahoo.com&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;未知字段&quot;</span>: <span class="string">&quot;123&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">schema = UserSchema()</span><br><span class="line">result = schema.load(user_data)</span><br><span class="line">pprint(result)  <span class="comment"># &#123;&#x27;email&#x27;: &#x27;ken@yahoo.com&#x27;, &#x27;未知字段&#x27;: &#x27;123&#x27;&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法二：在实例化Schema类的时候设置参数unknown的值</span></span><br><span class="line">shema = UserSchema(unknown=EXCLUDE)</span><br></pre></td></tr></table></figure>



<h2 id="Schema-validate-单纯的校验数据"><a href="#Schema-validate-单纯的校验数据" class="headerlink" title="Schema.validate(单纯的校验数据)"></a>Schema.validate(单纯的校验数据)</h2><p>如果只是想用Schema去验证数据, 而不进行反序列化生成对象, 可以使用Schema.validate()</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSchema</span>(<span class="params">Schema</span>):</span></span><br><span class="line">    name = fields.Str(required=<span class="literal">True</span>, error_messages=&#123;<span class="string">&quot;required&quot;</span>: <span class="string">&quot;name字段必须填写&quot;</span>&#125;)</span><br><span class="line">    email = fields.Email()</span><br><span class="line">    created_time = fields.DateTime()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">user = &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;tty&quot;</span>, <span class="string">&quot;email&quot;</span>: <span class="string">&quot;tty@python&quot;</span>&#125;</span><br><span class="line">schema = UserSchema()</span><br><span class="line">res = schema.validate(user)</span><br><span class="line"><span class="built_in">print</span>(res)  <span class="comment"># &#123;&#x27;email&#x27;: [&#x27;Not a valid email address.&#x27;]&#125;</span></span><br><span class="line"></span><br><span class="line">user1 = &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;tty&quot;</span>, <span class="string">&quot;email&quot;</span>: <span class="string">&quot;tty@python.org&quot;</span>&#125;</span><br><span class="line">schema = UserSchema()</span><br><span class="line">res1 = schema.validate(user1)</span><br><span class="line"><span class="built_in">print</span>(res1)  <span class="comment"># &#123;&#125;</span></span><br></pre></td></tr></table></figure>



<h2 id="指定序列化-反序列化键"><a href="#指定序列化-反序列化键" class="headerlink" title="指定序列化/反序列化键"></a>指定序列化/反序列化键</h2><h3 id="fields的attribute指定序列化键"><a href="#fields的attribute指定序列化键" class="headerlink" title="fields的attribute指定序列化键"></a>fields的attribute指定序列化键</h3><p>简单来说就是 : <strong>明确定义fields将从什么属性名取值</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, email</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.email = email</span><br><span class="line">        self.created_time = datetime.datetime.now()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSchema</span>(<span class="params">Schema</span>):</span></span><br><span class="line">    full_name = fields.String(attribute=<span class="string">&quot;name&quot;</span>)</span><br><span class="line">    email_address = fields.Email(attribute=<span class="string">&quot;email&quot;</span>)  <span class="comment"># 指定序列化键 , 降重email属性中取值</span></span><br><span class="line">    created_at = fields.DateTime(attribute=<span class="string">&quot;created_time&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">user = User(<span class="string">&quot;ttty&quot;</span>, email=<span class="string">&quot;ttty@python.org&quot;</span>)</span><br><span class="line">schema = UserSchema()</span><br><span class="line">res = schema.dump(user)</span><br><span class="line"><span class="built_in">print</span>(res)  <span class="comment"># &#123;&#x27;full_name&#x27;: &#x27;ttty&#x27;, &#x27;created_at&#x27;: &#x27;2020-06-27T12:56:16.822442&#x27;, &#x27;email_address&#x27;: &#x27;ttty@python.org&#x27;&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="fields的load-from指定反序列化键"><a href="#fields的load-from指定反序列化键" class="headerlink" title="fields的load_from指定反序列化键"></a>fields的load_from指定反序列化键</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSchema</span>(<span class="params">Schema</span>):</span></span><br><span class="line">    full_name = fields.String(load_from=<span class="string">&quot;name&quot;</span>)</span><br><span class="line">    email_address = fields.Email(load_from=<span class="string">&quot;email&quot;</span>)</span><br><span class="line">    created_at = fields.DateTime(load_from=<span class="string">&quot;created_time&quot;</span>)</span><br><span class="line"></span><br><span class="line">user = &#123;<span class="string">&quot;full_name&quot;</span>: <span class="string">&quot;ttty&quot;</span>, <span class="string">&quot;email_address&quot;</span>: <span class="string">&quot;ttty@python.org&quot;</span>&#125;</span><br><span class="line">schema = UserSchema()</span><br><span class="line">res = schema.load(user)</span><br><span class="line"><span class="built_in">print</span>(res)</span><br><span class="line"><span class="comment"># &#123;&#x27;email_address&#x27;: &#x27;ttty@python.org&#x27;, &#x27;full_name&#x27;: &#x27;ttty&#x27;&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="fileds的data-key同时满足序列化与反序列化的方法"><a href="#fileds的data-key同时满足序列化与反序列化的方法" class="headerlink" title="fileds的data_key同时满足序列化与反序列化的方法"></a>fileds的data_key同时满足序列化与反序列化的方法</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSchema</span>(<span class="params">Schema</span>):</span></span><br><span class="line">    full_name = fields.String(data_key=<span class="string">&quot;name&quot;</span>)</span><br><span class="line">    email_address = fields.Email(data_key=<span class="string">&quot;email&quot;</span>)</span><br><span class="line">    created_at = fields.DateTime(data_key=<span class="string">&quot;created_time&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 序列化</span></span><br><span class="line">user = &#123;<span class="string">&quot;full_name&quot;</span>: <span class="string">&quot;ttty&quot;</span>, <span class="string">&quot;email_address&quot;</span>: <span class="string">&quot;ttty@python.org&quot;</span>&#125;</span><br><span class="line">schema = UserSchema()</span><br><span class="line">res = schema.dump(user)</span><br><span class="line"><span class="built_in">print</span>(res) <span class="comment"># &#123;&#x27;name&#x27;: &#x27;ttty&#x27;, &#x27;email&#x27;: &#x27;ttty@python.org&#x27;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 反序列化</span></span><br><span class="line">user1 = &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;ttty&quot;</span>, <span class="string">&quot;email&quot;</span>: <span class="string">&quot;ttty@python.org&quot;</span>&#125;</span><br><span class="line">schema = UserSchema()</span><br><span class="line">res = schema.load(user1)</span><br><span class="line"><span class="built_in">print</span>(res) <span class="comment"># &#123;&#x27;email_address&#x27;: &#x27;ttty@python.org&#x27;, &#x27;full_name&#x27;: &#x27;ttty&#x27;&#125;</span></span><br></pre></td></tr></table></figure>



<h2 id="使用fields-Function创建新的字段"><a href="#使用fields-Function创建新的字段" class="headerlink" title="使用fields.Function创建新的字段"></a>使用fields.Function创建新的字段</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, email</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.email = email</span><br><span class="line">        self.created_at = datetime.datetime.now()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSchema</span>(<span class="params">Schema</span>):</span></span><br><span class="line">    uppername = fields.Function(<span class="keyword">lambda</span> obj: obj.name.upper())</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        fields = (<span class="string">&quot;name&quot;</span>, <span class="string">&quot;email&quot;</span>, <span class="string">&quot;created_at&quot;</span>, <span class="string">&quot;uppername&quot;</span>)</span><br><span class="line"></span><br><span class="line">user = User(name=<span class="string">&quot;Monty&quot;</span>, email=<span class="string">&quot;monty@python.org&quot;</span>)</span><br><span class="line">schema = UserSchema()</span><br><span class="line">result = schema.dump(user)</span><br><span class="line">pprint(result)</span><br><span class="line"><span class="comment"># &#123;&#x27;created_at&#x27;: &#x27;2020-06-27T17:30:08.231909&#x27;,</span></span><br><span class="line"><span class="comment">#  &#x27;email&#x27;: &#x27;monty@python.org&#x27;,</span></span><br><span class="line"><span class="comment">#  &#x27;name&#x27;: &#x27;Monty&#x27;,</span></span><br><span class="line"><span class="comment">#  &#x27;uppername&#x27;: &#x27;MONTY&#x27;&#125;</span></span><br></pre></td></tr></table></figure>



<h2 id="使用ordered选项进行排序"><a href="#使用ordered选项进行排序" class="headerlink" title="使用ordered选项进行排序"></a>使用ordered选项进行排序</h2><p>将<code>ordered</code>选项设置为true。这将指示marshmallow将数据序列化到collections.OrderedDict</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, email</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.email = email</span><br><span class="line">        self.created_time = datetime.datetime.now()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSchema</span>(<span class="params">Schema</span>):</span></span><br><span class="line">    uppername = fields.Function(<span class="keyword">lambda</span> obj: obj.name.upper())</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        fields = (<span class="string">&quot;name&quot;</span>, <span class="string">&quot;email&quot;</span>, <span class="string">&quot;created_time&quot;</span>, <span class="string">&quot;uppername&quot;</span>)</span><br><span class="line">        ordered = <span class="literal">True</span>  <span class="comment"># 开启排序</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">u = User(<span class="string">&quot;Charlie&quot;</span>, <span class="string">&quot;charlie@stones.com&quot;</span>)</span><br><span class="line">schema = UserSchema()</span><br><span class="line">res = schema.dump(u)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>(res, OrderedDict))  <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(res)</span><br><span class="line"><span class="comment"># OrderedDict([</span></span><br><span class="line"><span class="comment"># (&#x27;name&#x27;, &#x27;Charlie&#x27;),</span></span><br><span class="line"><span class="comment"># (&#x27;email&#x27;, &#x27;charlie@stones.com&#x27;),</span></span><br><span class="line"><span class="comment"># (&#x27;created_time&#x27;, &#x27;2019-08-05T20:22:05.788540+00:00&#x27;),</span></span><br><span class="line"><span class="comment"># (&#x27;uppername&#x27;, &#x27;CHARLIE&#x27;)</span></span><br><span class="line"><span class="comment"># ])</span></span><br></pre></td></tr></table></figure>



<h2 id="自定义字段"><a href="#自定义字段" class="headerlink" title="自定义字段"></a>自定义字段</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> marshmallow <span class="keyword">import</span> Schema, fields</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">String128</span>(<span class="params">fields.String</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    长度为128的字符串类型</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    default_error_messages = &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;该字段只能是字符串类型&quot;</span>,</span><br><span class="line">        <span class="string">&quot;invalid&quot;</span>: <span class="string">&quot;该字符串长度必须大于6&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_deserialize</span>(<span class="params">self, value, attr, data, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(value, <span class="built_in">str</span>):</span><br><span class="line">            self.fail(<span class="string">&quot;type&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(value) &lt; <span class="number">6</span>:</span><br><span class="line">            self.fail(<span class="string">&quot;invalid&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppSchema</span>(<span class="params">Schema</span>):</span></span><br><span class="line">    name = String128(required=<span class="literal">True</span>)</span><br><span class="line">    priority = fields.Integer()</span><br><span class="line">    obj_type = String128()</span><br><span class="line">    link = String128()</span><br><span class="line">    deploy = fields.<span class="type">Dict</span>()</span><br><span class="line">    description = fields.String()</span><br><span class="line">    projects = fields.<span class="type">List</span>(cls_or_instance=fields.<span class="type">Dict</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;app11&quot;</span>,</span><br><span class="line">    <span class="string">&quot;priority&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">&quot;obj_type&quot;</span>: <span class="string">&quot;web&quot;</span>,</span><br><span class="line">    <span class="string">&quot;link&quot;</span>: <span class="string">&quot;123.123.00.2&quot;</span>,</span><br><span class="line">    <span class="string">&quot;deploy&quot;</span>: &#123;<span class="string">&quot;deploy1&quot;</span>: <span class="string">&quot;deploy1&quot;</span>, <span class="string">&quot;deploy2&quot;</span>: <span class="string">&quot;deploy2&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;app111 test111&quot;</span>,</span><br><span class="line">    <span class="string">&quot;projects&quot;</span>: [&#123;<span class="string">&quot;id&quot;</span>: <span class="number">2</span>&#125;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">schema = AppSchema()</span><br><span class="line">res = schema.validate(app)</span><br><span class="line"><span class="built_in">print</span>(res)  <span class="comment"># &#123;&#x27;obj_type&#x27;: [&#x27;该字符串长度必须大于6&#x27;], &#x27;name&#x27;: [&#x27;该字符串长度必须大于6&#x27;]&#125;</span></span><br></pre></td></tr></table></figure>



<h2 id="数据处理扩展"><a href="#数据处理扩展" class="headerlink" title="数据处理扩展"></a>数据处理扩展</h2><ul>
<li><code>pre_load(self,value)</code>:序列化之前的操作</li>
<li><code>post_load(self,value)</code>:序列化之后的操作</li>
<li><code>pre_dump(self,value)</code>:反序列化之前的操作</li>
<li><code>post_dump(self,value)</code>:反序列化后的操作</li>
</ul>
<ul>
<li>在<code>pre</code>和<code>post</code>的处理中，可以出发<code>ValidationError</code>。</li>
<li>当有多个处理的时候应该让其他的处理在第一个处理中调用，而<strong>不是使用这些装饰器多次</strong>。</li>
<li>处理在<code>dump</code>和<code>load</code>中触发的<code>ValidationError</code>：定义<code>handle_error(self, exc, data)</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSchema</span>(<span class="params">Schema</span>):</span></span><br><span class="line">    name = fields.Str()</span><br><span class="line">    slug = fields.Str()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @pre_load</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">slugify_name</span>(<span class="params">self, in_data, **kwargs</span>):</span></span><br><span class="line">        in_data[<span class="string">&#x27;slug&#x27;</span>] = in_data[<span class="string">&#x27;slug&#x27;</span>].lower().strip().replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> in_data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">schema = UserSchema()</span><br><span class="line">result = schema.load(&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Steve&#x27;</span>, <span class="string">&#x27;slug&#x27;</span>: <span class="string">&#x27;Steve Loria &#x27;</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(result)  <span class="comment"># =&gt; &#123;&#x27;name&#x27;: &#x27;Steve&#x27;, &#x27;slug&#x27;: &#x27;steve-loria&#x27;&#125;</span></span><br></pre></td></tr></table></figure>













</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>