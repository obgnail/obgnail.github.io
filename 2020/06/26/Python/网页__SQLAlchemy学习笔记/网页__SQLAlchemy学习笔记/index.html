<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="地址 : "><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>SQLAlchemy学习笔记 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Python/" rel="tag">Python</a></div><div class="post-time">2020-06-26</div></div></div><div class="container post-header"><h1>SQLAlchemy学习笔记</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">1.</span> <span class="toc-text">连接数据库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#declarative-base%E7%B1%BB"><span class="toc-number">2.</span> <span class="toc-text">declarative_base类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A5%E9%97%A8%E4%BD%BF%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">入门使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Session"><span class="toc-number">4.</span> <span class="toc-text">Session</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E5%AF%B9%E5%A4%9A-one-to-many%EF%BC%89"><span class="toc-number">5.</span> <span class="toc-text">一对多(one to many）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E5%AF%B9%E4%B8%80-many-to-one"><span class="toc-number">6.</span> <span class="toc-text">多对一(many to one)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E5%AF%B9%E4%B8%80-one-to-one"><span class="toc-number">7.</span> <span class="toc-text">一对一(one to one)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E5%AF%B9%E5%A4%9A-many-to-many"><span class="toc-number">8.</span> <span class="toc-text">多对多(many to many)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E8%81%94%E6%9F%A5%E8%AF%A2"><span class="toc-number">9.</span> <span class="toc-text">关联查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%8F%82%E6%95%B0%E8%A7%A3%E9%87%8A"><span class="toc-number">10.</span> <span class="toc-text">常用参数解释</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hybrid-property"><span class="toc-number">11.</span> <span class="toc-text">hybrid_property</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%BD%E8%B1%A1%E8%A1%A8%E4%B8%8E%E8%A1%A8%E7%9A%84%E7%BB%A7%E6%89%BF"><span class="toc-number">12.</span> <span class="toc-text">抽象表与表的继承</span></a></li></ol></details></div><div class="container post-content"><p>地址 : </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/u011521019/article/details/50793996/">SQLAlchemy 学习笔记</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/lzjun567/note/blob/master/note/python/sqlalchemy.md">https://github.com/lzjun567/note/blob/master/note/python/sqlalchemy.md</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/27400862">SQLAlchemy入门和进阶</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/wenxuansoft/article/details/50233557">抽象表与表的继承</a></li>
</ul>
<p>SQLAlchemy两个主要的组件： SQLAlchemy ORM 和 SQLAlchemy Core 。</p>
<p><img src="/images/20160304005104895" alt="这里写图片描述"></p>
<h2 id="连接数据库"><a href="#连接数据库" class="headerlink" title="连接数据库"></a>连接数据库</h2><p>连接MySQL数据库(需要MySQLdb支持)：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line">DB_CONNECT_STRING = <span class="string">&#x27;mysql+mysqldb://root:@localhost/test2?charset=utf8&#x27;</span></span><br><span class="line">engine = create_engine(DB_CONNECT_STRING,echo=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>Engine实例只有直到触发数据库事件时才真正去连接数据库。</li>
<li>echo参数是设置 SQLAlchemy 日志记录，这通过 Python 的标准logging模块的快捷方式。启用它，我们会看到产生的所有生成的 SQL，sqlalchemy与数据库通信的命令都将打印出来</li>
</ul>
<h2 id="declarative-base类"><a href="#declarative-base类" class="headerlink" title="declarative_base类"></a>declarative_base类</h2><p>declarative_base类维持了一个<strong>从类到表</strong>的关系，通常一个应用使用一个base实例，所有实体类都应该继承此类对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line">Base = declarative_base()</span><br></pre></td></tr></table></figure>



<h2 id="入门使用"><a href="#入门使用" class="headerlink" title="入门使用"></a>入门使用</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"></span><br><span class="line">DB_CONNECT_STRING = <span class="string">&#x27;mysql+mysqldb://root:password@localhost/test?charset=utf8&#x27;</span></span><br><span class="line">engine = create_engine(DB_CONNECT_STRING,echo=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span>  <span class="comment"># __tablename__属性定义数据库表名字</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer,primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">10</span>))</span><br><span class="line">    fullname = Column(String(<span class="number">20</span>))</span><br><span class="line">    password = Column(String(<span class="number">20</span>)) <span class="comment">#可以设定长度</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,name,fullname,password</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.fullname = fullname</span><br><span class="line">        self.password = password</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&lt;User(&#x27;%s&#x27;,&#x27;%s&#x27;,&#x27;%s&#x27;)&gt;&quot;</span>%(self.name,self.fullname,self.password)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Base.metadata返回sqlalchemy.schema.MetaData对象，它是所有Table对象的集合，</span></span><br><span class="line"><span class="comment"># 调用create_all()该对象会触发CREATE TABLE语句，如果数据库还不存在这些表的话。</span></span><br><span class="line">Base.metadata.create_all(engine)</span><br></pre></td></tr></table></figure>



<h2 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h2><ul>
<li>Session 使用 connection发送query，把返回的result row 填充到一个object中，该对象同时还会保存在Session中，</li>
<li>Session内部有一个叫<code>Identity Map</code>的数据结构，为每一个对象维持了唯一的副本。primary key 作为 key ，value就是该object。</li>
<li>session刚开始无状态，直到有query发起时。对象的变化会被session的跟踪维持着，在数据库做下一次查询后者当前的事务已经提交了时，它将所有挂起的更改都转移到数据库中。这就是传说中的 Unit of work 模式</li>
</ul>
<h2 id="一对多-one-to-many）"><a href="#一对多-one-to-many）" class="headerlink" title="一对多(one to many）"></a>一对多(one to many）</h2><p>一个parent有多个child:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Parent</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;parent&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer,primary_key = <span class="literal">True</span>)</span><br><span class="line">    children = relationship(<span class="string">&quot;Child&quot;</span>,backref=<span class="string">&#x27;parent&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;child&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer,primary_key = <span class="literal">True</span>)</span><br><span class="line">    parent_id = Column(Integer,ForeignKey(<span class="string">&#x27;parent.id&#x27;</span>))</span><br></pre></td></tr></table></figure>



<h2 id="多对一-many-to-one"><a href="#多对一-many-to-one" class="headerlink" title="多对一(many to one)"></a>多对一(many to one)</h2><p>一个child可能有多个parent(父亲和母亲)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Parent</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;parent&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    child_id = Column(Integer, ForeignKey(<span class="string">&#x27;child.id&#x27;</span>))</span><br><span class="line">    child = relationship(<span class="string">&quot;Child&quot;</span>, backref=<span class="string">&quot;parents&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;child&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>



<h2 id="一对一-one-to-one"><a href="#一对一-one-to-one" class="headerlink" title="一对一(one to one)"></a>一对一(one to one)</h2><ul>
<li>一对一就是<code>多对一</code>和<code>一对多</code>的一个特例,</li>
<li>只需在relationship加上一个参数uselist=False替换多的一端就是一对一:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Parent</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;parent&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    child_id = Column(Integer, ForeignKey(<span class="string">&#x27;child.id&#x27;</span>))</span><br><span class="line">    child = relationship(<span class="string">&quot;Child&quot;</span>, backref=backref(<span class="string">&quot;parent&quot;</span>, uselist=<span class="literal">False</span>))</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;child&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>



<h2 id="多对多-many-to-many"><a href="#多对多-many-to-many" class="headerlink" title="多对多(many to many)"></a>多对多(many to many)</h2><p>多对多关系需要一个中间关联表,通过参数secondary来指定</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Table,Text</span><br><span class="line">post_keywords = Table(<span class="string">&#x27;post_keywords&#x27;</span>,Base.metadata,</span><br><span class="line">        Column(<span class="string">&#x27;post_id&#x27;</span>,Integer,ForeignKey(<span class="string">&#x27;posts.id&#x27;</span>)),</span><br><span class="line">        Column(<span class="string">&#x27;keyword_id&#x27;</span>,Integer,ForeignKey(<span class="string">&#x27;keywords.id&#x27;</span>))</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlogPost</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;posts&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer,primary_key=<span class="literal">True</span>)</span><br><span class="line">    body = Column(Text)</span><br><span class="line">    keywords = relationship(<span class="string">&#x27;Keyword&#x27;</span>,secondary=post_keywords,backref=<span class="string">&#x27;posts&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Keyword</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;keywords&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer,primary_key = <span class="literal">True</span>)</span><br><span class="line">    keyword = Column(String(<span class="number">50</span>),nullable=<span class="literal">False</span>,unique=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>



<h2 id="关联查询"><a href="#关联查询" class="headerlink" title="关联查询"></a>关联查询</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> u, a <span class="keyword">in</span> session.query(User, Address).\</span><br><span class="line"><span class="meta">... </span>                    <span class="built_in">filter</span>(User.<span class="built_in">id</span>==Address.user_id).\</span><br><span class="line"><span class="meta">... </span>                    <span class="built_in">filter</span>(Address.email_address==<span class="string">&#x27;jack@google.com&#x27;</span>).\</span><br><span class="line"><span class="meta">... </span>                    <span class="built_in">all</span>():</span><br><span class="line"><span class="meta">... </span>    <span class="built_in">print</span>(u)</span><br><span class="line"><span class="meta">... </span>    <span class="built_in">print</span>(a)</span><br><span class="line">&lt;User(name=<span class="string">&#x27;jack&#x27;</span>, fullname=<span class="string">&#x27;Jack Bean&#x27;</span>, password=<span class="string">&#x27;gjffdd&#x27;</span>)&gt;</span><br><span class="line">&lt;Address(email_address=<span class="string">&#x27;jack@google.com&#x27;</span>)&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line"><span class="comment"># 因为这里的外键就一个，系统知道如何去关联</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>session.query(User).join(Address).\</span><br><span class="line"><span class="meta">... </span>        <span class="built_in">filter</span>(Address.email_address==<span class="string">&#x27;jack@google.com&#x27;</span>).\</span><br><span class="line"><span class="meta">... </span>        <span class="built_in">all</span>()</span><br><span class="line">[&lt;User(name=<span class="string">&#x27;jack&#x27;</span>, fullname=<span class="string">&#x27;Jack Bean&#x27;</span>, password=<span class="string">&#x27;gjffdd&#x27;</span>)&gt;]</span><br></pre></td></tr></table></figure>



<h2 id="常用参数解释"><a href="#常用参数解释" class="headerlink" title="常用参数解释"></a>常用参数解释</h2><p>relationship():函数接收的参数非常多，比如：backref，secondary，primaryjoin，等等。</p>
<ul>
<li><p><code>backref</code>:在一对多或多对一之间建立双向关系</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Parent</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;parent&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    children = relationship(<span class="string">&quot;Child&quot;</span>, backref=<span class="string">&quot;parent&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;child&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    parent_id = Column(Integer, ForeignKey(<span class="string">&#x27;parent.id&#x27;</span>))</span><br></pre></td></tr></table></figure>

<ul>
<li>Prarent对象获取children : <code>parent.children</code>,</li>
<li>反过来Child对象可以获取parent : <code>child.parent</code>.</li>
</ul>
</li>
<li><p><code>lazy</code> : 默认值是True,关联对象只有到真正访问的时候才会去查询数据库,比如有parent对象,只有知道访问parent.children的时候才做关联查询.</p>
</li>
<li><p><code>remote_side</code>:表中的外键引用的是自身时,如Node类,如果想表示多对一的关系,那么就可以使用remote_side</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;node&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    parent_id = Column(Integer, ForeignKey(<span class="string">&#x27;node.id&#x27;</span>))</span><br><span class="line">    data = Column(String(<span class="number">50</span>))</span><br><span class="line">    parent = relationship(<span class="string">&quot;Node&quot;</span>, remote_side=[<span class="built_in">id</span>])</span><br></pre></td></tr></table></figure>

<p>如果是想建立一种双向的关系,那么还是结合backref:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span>(<span class="params">Base</span>):</span></span><br><span class="line">__tablename__ = <span class="string">&#x27;node&#x27;</span></span><br><span class="line"><span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">parent_id = Column(Integer, ForeignKey(<span class="string">&#x27;node.id&#x27;</span>))</span><br><span class="line">data = Column(String(<span class="number">50</span>))</span><br><span class="line">children = relationship(<span class="string">&quot;Node&quot;</span>,backref=backref(<span class="string">&#x27;parent&#x27;</span>, remote_side=[<span class="built_in">id</span>]))</span><br></pre></td></tr></table></figure></li>
<li><p><code>primaryjoin</code> : 用在一对多或者多对一的关系中,默认情况连接条件就是主键与另一端的外键,用primaryjoin参数<strong>可以用来指定连接条件</strong> ,比如:下面user的address必须现address是一’tony’开头:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;user&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String)</span><br><span class="line">    addresses = relationship(<span class="string">&quot;Address&quot;</span>,</span><br><span class="line">                    primaryjoin=<span class="string">&quot;and_(User.id==Address.user_id, &quot;</span></span><br><span class="line">                        <span class="string">&quot;Address.email.startswith(&#x27;tony&#x27;))&quot;</span>,</span><br><span class="line">                    backref=<span class="string">&quot;user&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Address</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;address&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    email = Column(String)</span><br><span class="line">    user_id = Column(Integer, ForeignKey(<span class="string">&#x27;user.id&#x27;</span>))</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="hybrid-property"><a href="#hybrid-property" class="headerlink" title="hybrid_property"></a>hybrid_property</h2><p>解决自己写的<code>property</code>属性无法进行<code>filter_by</code>的问题</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Interval</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;interval&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    start = Column(Integer, nullable=<span class="literal">False</span>)</span><br><span class="line">    end = Column(Integer, nullable=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, start, end</span>):</span></span><br><span class="line">        self.start = start</span><br><span class="line">        self.end = end</span><br><span class="line"></span><br><span class="line"><span class="meta">    @hybrid_property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">length</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.end - self.start</span><br><span class="line">    <span class="comment">#下面这个写着玩的。。</span></span><br><span class="line"><span class="meta">    @length.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">length</span>(<span class="params">self, value</span>):</span></span><br><span class="line">        self._value = value</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>i1 = Interval(<span class="number">5</span>, <span class="number">10</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>i1.length</span><br><span class="line"><span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span> Session().query(Interval).filter_by(length=<span class="number">5</span>)</span><br><span class="line">SELECT interval.<span class="built_in">id</span> AS interval_id, interval.start AS interval_start,</span><br><span class="line">interval.<span class="string">&quot;end&quot;</span> AS interval_end</span><br><span class="line">FROM interval</span><br><span class="line">WHERE interval.<span class="string">&quot;end&quot;</span> - interval.start = :param_1</span><br></pre></td></tr></table></figure>

<p>hybrid_property支持：</p>
<ol>
<li>comparator 扩展Interval.length在各种比较符(&gt;&lt;=)的行为</li>
<li>deleter/setter 顾名思义</li>
<li>expression 可以扩展最后展开的SQL表达式，例如展开成SUM(xxx):</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> func</span><br><span class="line"><span class="meta">    @length.expression</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">length</span>(<span class="params">self, expr</span>):</span></span><br><span class="line">        <span class="keyword">return</span> func.<span class="built_in">sum</span>(self.end, expr)</span><br></pre></td></tr></table></figure>

<h2 id="抽象表与表的继承"><a href="#抽象表与表的继承" class="headerlink" title="抽象表与表的继承"></a>抽象表与表的继承</h2><ol>
<li>继承基本上就是共享字段定义和方法</li>
<li>一般情况下基类不创建表，但如果你在基类中定义了<code>__tablename__</code>，那也会创建表，但创建的表是没用的。</li>
<li>基类创建的字段和方法会被继承类继承。</li>
<li>所有继承类均独立建表。</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Employee</span>(<span class="params">AbstractConcreteBase, Base</span>):</span></span><br><span class="line">    <span class="built_in">id</span> =Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = Column(String(<span class="number">50</span>))</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span> self.name</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Manager</span>(<span class="params">Employee</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;manager&#x27;</span></span><br><span class="line">    manager_data = Column(String(<span class="number">40</span>))</span><br><span class="line">    __mapper_args__ = &#123;</span><br><span class="line">                    <span class="string">&#x27;polymorphic_identity&#x27;</span>:<span class="string">&#x27;manager&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;concrete&#x27;</span>:<span class="literal">True</span>&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Engineer</span>(<span class="params">Employee</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;engineer&#x27;</span></span><br><span class="line">    engineer_name = Column(String(<span class="number">40</span>))</span><br><span class="line">    __mapper_args__ = &#123;<span class="string">&#x27;polymorphic_identity&#x27;</span>:<span class="string">&#x27;engineer&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;concrete&#x27;</span>:<span class="literal">True</span>&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>在上例中，基类Employee是属于抽象类，不会在数据库中创建表，但类中定义的字段id,name会被Manager和Engineer两个类继承。</li>
<li>polymorphic_identity和concrete两个参数需要配置，polymorphic_identity的值同样可以是任意唯一标识，一般使用类名称。<ul>
<li>polymorphic_identity=”employee”则说明，如果你新建一个Employee(name=”员工”)时，Employee.type=”employee”，说明只是普通的员工。</li>
<li>polymorphic_identity配置值可以是任意值，不一定是上述例子中的，比如你可以让engineer类的polymorphic_identity=“a”，而Manager类的polymorphic_identity=“b”</li>
</ul>
</li>
</ul>
</blockquote>
<p>在上例中，当您新增加一个Enginner实例时：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">e=Enginner(name=<span class="string">&quot;张三&quot;</span>,emgineer_name=<span class="string">&quot;高级工程师&quot;</span>)</span><br><span class="line">session.add(e)</span><br><span class="line">session.commit()</span><br></pre></td></tr></table></figure>

<p>SQLAlchemy会在数据库表Employee中添加一行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id         name         type</span><br><span class="line">---------------------------------------------</span><br><span class="line">1         张三           engineer</span><br></pre></td></tr></table></figure>

<p>然后在数据库表Enginner中添加一行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id         engineer_name</span><br><span class="line">---------------------------------------------</span><br><span class="line">1         高级工程师</span><br></pre></td></tr></table></figure>

<p>两个表是通过一个外键关联起来的。</p>
<p>当你使用查询Engineer时，返回的Engineer具有完整的字段：id, name,engineer_name , 其中name值是从Employee表中取的。</p>
</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>