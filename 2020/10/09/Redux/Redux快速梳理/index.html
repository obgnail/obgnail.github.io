<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="&gt;
&lt;li&gt;&lt;a href=&quot;https://www.cnblogs.com/vvjiang/p/9505646.html&quot;&gt;Redux与它的中间件：redux-thunk，redux-actions，redux-promise，redux-saga&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.jianshu.com/p/1fcef4c892ba&quot;&gt;react-redux性能优化之reselect&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.jianshu.com/p/6e38c66366cd&quot;&gt;翻译|Redux的中间件-Reselect&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;redux是一个用于JS状态容器，提供可预测化的状态管理&lt;/li&gt;
&lt;li&gt;redux可以让你够贱一致化的应用，运行于不同的环境，并且易于测试&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
&lt;li&gt;在这里我们首先要明白的是什么叫可预测？什么叫状态容器？&lt;/li&gt;
&lt;li&gt;什么叫状态？实际上就是变量，对话框显示或隐藏的变量，一杯奶茶多少钱的变量。那么这个状态容器，实际上就是一个存放这些变量的变量。&lt;/li&gt;
&lt;li&gt;你创建了一个全局变量叫Store，然后将代码中控制各个状态的变量存放在里面，那么现在Store就叫做状态容器。&lt;/li&gt;
&lt;li&gt;什么叫可预测？&lt;/li&gt;
&lt;li&gt;你在操作这个Store的时候，总是用Store.price的方式来设置值，这种操作数据的方式很原始，对于复杂的系统而言永远都不知道程序在运行的过程中发生了什么。&lt;/li&gt;
&lt;li&gt;那么现在我们都通过发送一个Action去做修改，而Store在接收到Action后会使用Reducer对Action传递的数据做处理，最后应用到Store中。&lt;/li&gt;
&lt;li&gt;相对于Store.price的方式来修改者，这种方式无疑更麻烦，但是这种方式的好处就是，&lt;strong&gt;每一个Action里面都可以写日志，可以记录各种状态的变动，这就是可预测。&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;所以如果你的程序很简单，你完全没有必要去用Redux。&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;Redux工作流&quot;&gt;&lt;a href=&quot;#Redux工作流&quot; class=&quot;headerlink&quot; title=&quot;Redux工作流&quot;&gt;&lt;/a&gt;Redux工作流&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;/images/746209-20180820150429301-794171230.jpg&quot; alt=&quot;123&quot;&gt;"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>Redux快速梳理 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-none-link" href="/tags/Redux/" rel="tag">Redux</a></div><div class="post-time">2020-10-09</div></div></div><div class="container post-header"><h1>Redux快速梳理</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redux%E5%B7%A5%E4%BD%9C%E6%B5%81"><span class="toc-number">2.</span> <span class="toc-text">Redux工作流</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mapStateToProps%E5%92%8CmapDispatchToProps%E6%A2%B3%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">mapStateToProps和mapDispatchToProps梳理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redux%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">4.</span> <span class="toc-text">Redux的中间件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redux-logger%EF%BC%9A%E6%97%A5%E5%BF%97%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">5.</span> <span class="toc-text">redux-logger：日志中间件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redux-thunk%EF%BC%9A%E5%A4%84%E7%90%86%E5%BC%82%E6%AD%A5action"><span class="toc-number">6.</span> <span class="toc-text">redux-thunk：处理异步action</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redux-actions%EF%BC%9A%E7%AE%80%E5%8C%96redux%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">7.</span> <span class="toc-text">redux-actions：简化redux的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redux-promise%EF%BC%9Aredux-actions%E7%9A%84%E5%A5%BD%E5%9F%BA%E5%8F%8B%EF%BC%8C%E8%BD%BB%E6%9D%BE%E5%88%9B%E5%BB%BA%E5%92%8C%E5%A4%84%E7%90%86%E5%BC%82%E6%AD%A5action"><span class="toc-number">8.</span> <span class="toc-text">redux-promise：redux-actions的好基友，轻松创建和处理异步action</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#react-redux%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%B9%8Breselect"><span class="toc-number">9.</span> <span class="toc-text">react-redux性能优化之reselect</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98"><span class="toc-number">9.1.</span> <span class="toc-text">性能问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%87%E7%94%A8-reselect%EF%BC%8C%E6%9B%B4%E6%96%B0-App-%E7%BB%84%E4%BB%B6"><span class="toc-number">9.2.</span> <span class="toc-text">采用 reselect，更新 App 组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E9%87%8A"><span class="toc-number">9.3.</span> <span class="toc-text">解释</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%81%9A%E5%90%88selectors"><span class="toc-number">9.4.</span> <span class="toc-text">聚合selectors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E4%B8%80%E4%B8%AASelector%E5%88%B0Redux-Store"><span class="toc-number">9.5.</span> <span class="toc-text">连接一个Selector到Redux Store</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">10.</span> <span class="toc-text">总结</span></a></li></ol></details></div><div class="container post-content"><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/vvjiang/p/9505646.html">Redux与它的中间件：redux-thunk，redux-actions，redux-promise，redux-saga</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/1fcef4c892ba">react-redux性能优化之reselect</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/6e38c66366cd">翻译|Redux的中间件-Reselect</a></li>
</ul>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><ul>
<li>redux是一个用于JS状态容器，提供可预测化的状态管理</li>
<li>redux可以让你够贱一致化的应用，运行于不同的环境，并且易于测试</li>
</ul>
<ol>
<li>在这里我们首先要明白的是什么叫可预测？什么叫状态容器？</li>
<li>什么叫状态？实际上就是变量，对话框显示或隐藏的变量，一杯奶茶多少钱的变量。那么这个状态容器，实际上就是一个存放这些变量的变量。</li>
<li>你创建了一个全局变量叫Store，然后将代码中控制各个状态的变量存放在里面，那么现在Store就叫做状态容器。</li>
<li>什么叫可预测？</li>
<li>你在操作这个Store的时候，总是用Store.price的方式来设置值，这种操作数据的方式很原始，对于复杂的系统而言永远都不知道程序在运行的过程中发生了什么。</li>
<li>那么现在我们都通过发送一个Action去做修改，而Store在接收到Action后会使用Reducer对Action传递的数据做处理，最后应用到Store中。</li>
<li>相对于Store.price的方式来修改者，这种方式无疑更麻烦，但是这种方式的好处就是，<strong>每一个Action里面都可以写日志，可以记录各种状态的变动，这就是可预测。</strong></li>
<li>所以如果你的程序很简单，你完全没有必要去用Redux。</li>
</ol>
<h2 id="Redux工作流"><a href="#Redux工作流" class="headerlink" title="Redux工作流"></a>Redux工作流</h2><p><img src="/images/746209-20180820150429301-794171230.jpg" alt="123"></p>
<h2 id="mapStateToProps和mapDispatchToProps梳理"><a href="#mapStateToProps和mapDispatchToProps梳理" class="headerlink" title="mapStateToProps和mapDispatchToProps梳理"></a>mapStateToProps和mapDispatchToProps梳理</h2><p>mapStateToProps（state, ownProps）：</p>
<ul>
<li>mapStateToProps是一个函数，用于<strong>建立组件跟 store 的 state 的映射关系</strong></li>
<li>作为一个函数，它可以传入两个参数，结果一定要返回一个 object。</li>
<li>传入mapStateToProps之后，会订阅store的状态改变，在每次 store 的 state 发生变化的时候，都会被调用</li>
<li><strong>ownProps代表组件本身的props</strong>，如果写了第二个参数ownProps，那么当prop发生变化的时候，mapStateToProps也会被调用。例如，当 props接收到来自父组件一个小小的改动，那么你所使用的ownProps 参数，mapStateToProps 都会被重新计算）。</li>
<li>mapStateToProps可以不传，如果不传，组件不会监听store的变化，也就是说Store的更新不会引起UI的更新</li>
</ul>
<h2 id="Redux的中间件"><a href="#Redux的中间件" class="headerlink" title="Redux的中间件"></a>Redux的中间件</h2><p>Redux是个可预测的状态容器，这个可预测在于对数据的每一次修改都可以进行相应的处理和记录。</p>
<p>假如现在我们需要在每次修改数据时，记录修改的内容，我们可以在每一个dispatch前面加上一个console.info记录修改的内容。</p>
<p>但是这样太繁琐了，所以我们可以<strong>直接修改store.dispatch</strong>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> next = store.dispatch</span><br><span class="line">store.dispatch = <span class="function">(<span class="params">action</span>)=&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.info(<span class="string">&#x27;修改内容为：&#x27;</span>, action)</span><br><span class="line">  next(action)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Redux中也有同样的功能，那就是applyMiddleware。直译过来就是“应用中间件”，它的作用就是<strong>改造dispatch函数</strong>，跟上面的玩法基本雷同。</p>
<ul>
<li>applyMiddleware的作用：修改store.dipatch的行为</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> reducer <span class="keyword">from</span> <span class="string">&#x27;./reducers&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = createStore(reducer, applyMiddleware(<span class="function"><span class="params">curStore</span> =&gt;</span> <span class="function"><span class="params">next</span> =&gt;</span> <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.info(curStore.getState(), action);</span><br><span class="line">  <span class="keyword">return</span> next(action);</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>



<h2 id="redux-logger：日志中间件"><a href="#redux-logger：日志中间件" class="headerlink" title="redux-logger：日志中间件"></a>redux-logger：日志中间件</h2><p>通常我们没有必要自己写中间件，比如日志的记录就已经有了成熟的中间件：<code>redux-logger</code>，这里给一个简单的例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; applyMiddleware, createStore &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> createLogger <span class="keyword">from</span> <span class="string">&#x27;redux-logger&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> reducer <span class="keyword">from</span> <span class="string">&#x27;./reducers&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> logger = createLogger();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = createStore(</span><br><span class="line">  reducer,</span><br><span class="line">  applyMiddleware(logger)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>这样就可以记录所有action及其发送前后的state的日志</p>
<h2 id="redux-thunk：处理异步action"><a href="#redux-thunk：处理异步action" class="headerlink" title="redux-thunk：处理异步action"></a>redux-thunk：处理异步action</h2><p>下面代码点击按钮后，直接修改了按钮的文本，这个文本是个固定的值。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// action.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> CHANGE_BTN_TEXT = <span class="string">&#x27;CHANGE_BTN_TEXT&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> changeBtnText = <span class="function">(<span class="params">text</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">type</span>: T.CHANGE_BTN_TEXT,</span><br><span class="line">    <span class="attr">payload</span>: text</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<p>但是在我们实际生产的过程中，很多情况都是需要去请求服务端拿到数据再修改的，这个过程是一个异步的过程。又或者需要setTimeout去做一些事情。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">changeText</span>: <span class="function">(<span class="params">text</span>) =&gt;</span> &#123;</span><br><span class="line">      dispatch(changeBtnText(<span class="string">&#x27;正在加载中&#x27;</span>));</span><br><span class="line">      axios.get(<span class="string">&#x27;http://test.com&#x27;</span>).then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        dispatch(changeBtnText(<span class="string">&#x27;加载完毕&#x27;</span>));</span><br><span class="line">      &#125;).catch(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        dispatch(changeBtnText(<span class="string">&#x27;加载有误&#x27;</span>));</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<ul>
<li>问题来了，当请求后台的过程非常快，导致加载完毕先出现，然后再展示加载中。</li>
<li>这个时候我们需要去<strong>通过store.getState获取当前状态，从而判断到底是展示正在加载中还是展示加载完毕</strong>。</li>
<li>这个过程就不能放在mapDispatchToProps中了，而需要放在中间件中，因为中间件中可以拿到store。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 首先创造store的时候需要应用react-thunk</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> thunk <span class="keyword">from</span> <span class="string">&#x27;redux-thunk&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> reducer <span class="keyword">from</span> <span class="string">&#x27;./reducers&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = createStore(</span><br><span class="line">  reducer,</span><br><span class="line">  applyMiddleware(thunk)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> T <span class="keyword">from</span> <span class="string">&#x27;./actionTypes&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> changeBtnText = <span class="function">(<span class="params">text</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">type</span>: T.CHANGE_BTN_TEXT,</span><br><span class="line">    <span class="attr">payload</span>: text</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> changeBtnTextAsync = <span class="function">(<span class="params">text</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">dispatch, getState</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!getState().isLoading) &#123;</span><br><span class="line">      dispatch(changeBtnText(<span class="string">&#x27;正在加载中&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    axios.get(<span class="string">`http://test.com/<span class="subst">$&#123;text&#125;</span>`</span>).then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (getState().isLoading) &#123;</span><br><span class="line">        dispatch(changeBtnText(<span class="string">&#x27;加载完毕&#x27;</span>));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).catch(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      dispatch(changeBtnText(<span class="string">&#x27;加载有误&#x27;</span>));</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">changeText</span>: <span class="function">(<span class="params">text</span>) =&gt;</span> &#123;</span><br><span class="line">      dispatch(changeBtnTextAsync(text));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>thunk的源码超级简单：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createThunkMiddleware</span>(<span class="params">extraArgument</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">&#123; dispatch, getState &#125;</span>) =&gt;</span> <span class="function"><span class="params">next</span> =&gt;</span> <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> action === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> action(dispatch, getState, extraArgument);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> next(action);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> thunk = createThunkMiddleware();</span><br><span class="line">thunk.withExtraArgument = createThunkMiddleware;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> thunk;</span><br></pre></td></tr></table></figure>

<p>createThunkMiddleware加强了dispatch的功能，在dispatch一个action之前，去判断action是否是一个函数，如果是函数，那么就执行这个函数。</p>
</blockquote>
<p>通过redux-thunk我们可以简单地进行异步操作，并且可以获取到各个异步操作时期状态的值。</p>
<h2 id="redux-actions：简化redux的使用"><a href="#redux-actions：简化redux的使用" class="headerlink" title="redux-actions：简化redux的使用"></a>redux-actions：简化redux的使用</h2><p>简化工作主要集中在构造action和处理reducers方面。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 先来看看原先的actions</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> T <span class="keyword">from</span> <span class="string">&#x27;./actionTypes&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> changeBtnText = <span class="function">(<span class="params">text</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">type</span>: T.CHANGE_BTN_TEXT,</span><br><span class="line">    <span class="attr">payload</span>: text</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> changeBtnTextAsync = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">dispatch, getState</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!getState().isLoading) &#123;</span><br><span class="line">      dispatch(changeBtnText(<span class="string">&#x27;正在加载中&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    axios.get(<span class="string">&#x27;http://test.com&#x27;</span>).then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (getState().isLoading) &#123;</span><br><span class="line">        dispatch(changeBtnText(<span class="string">&#x27;加载完毕&#x27;</span>));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).catch(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      dispatch(changeBtnText(<span class="string">&#x27;加载有误&#x27;</span>));</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改后的：</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> T <span class="keyword">from</span> <span class="string">&#x27;./actionTypes&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createAction &#125; <span class="keyword">from</span> <span class="string">&#x27;redux-actions&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> changeBtnText = createAction(T.CHANGE_BTN_TEXT, <span class="function"><span class="params">text</span> =&gt;</span> text);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> changeBtnTextAsync = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">dispatch, getState</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!getState().isLoading) &#123;</span><br><span class="line">      dispatch(changeBtnText(<span class="string">&#x27;正在加载中&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    axios.get(<span class="string">&#x27;http://test.com&#x27;</span>).then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (getState().isLoading) &#123;</span><br><span class="line">        dispatch(changeBtnText(<span class="string">&#x27;加载完毕&#x27;</span>));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).catch(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      dispatch(changeBtnText(<span class="string">&#x27;加载有误&#x27;</span>));</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>异步的action就不要用createAction，因为这个createAction返回的是一个对象，而不是一个函数，就会导致redux-thunk的代码没有起到作用。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 先来看看原先的reducers</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> T <span class="keyword">from</span> <span class="string">&#x27;./actionTypes&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">  <span class="attr">btnText</span>: <span class="string">&#x27;我是按钮&#x27;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pageMainReducer = <span class="function">(<span class="params">state = initialState, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> T.CHANGE_BTN_TEXT:</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        <span class="attr">btnText</span>: action.payload</span><br><span class="line">      &#125;;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> pageMainReducer;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用handleActions来处理</span></span><br><span class="line"><span class="keyword">import</span> &#123; handleActions &#125; <span class="keyword">from</span> <span class="string">&#x27;redux-actions&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> T <span class="keyword">from</span> <span class="string">&#x27;./actionTypes&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">  <span class="attr">btnText</span>: <span class="string">&#x27;我是按钮&#x27;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pageMainReducer = handleActions(&#123;</span><br><span class="line">  [T.CHANGE_BTN_TEXT]: &#123;</span><br><span class="line">    <span class="function"><span class="title">next</span>(<span class="params">state, action</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        <span class="attr">btnText</span>: action.payload,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">throw</span>(state) &#123;</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;, initialState);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> pageMainReducer;</span><br></pre></td></tr></table></figure>



<h2 id="redux-promise：redux-actions的好基友，轻松创建和处理异步action"><a href="#redux-promise：redux-actions的好基友，轻松创建和处理异步action" class="headerlink" title="redux-promise：redux-actions的好基友，轻松创建和处理异步action"></a>redux-promise：redux-actions的好基友，轻松创建和处理异步action</h2><ul>
<li>上面在使用redux-actions的createAction时，我们对异步的action无法处理。</li>
<li>因为我们使用createAction后返回的是一个对象，而不是一个函数，就会导致redux-thunk的代码没有起到作用。</li>
<li>而现在我们将使用redux-promise来处理这类情况。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// createAction</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> changeBtnText = createAction(T.CHANGE_BTN_TEXT, <span class="function"><span class="params">text</span> =&gt;</span> text);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加入redux-promise中间件</span></span><br><span class="line"><span class="keyword">import</span> thunk <span class="keyword">from</span> <span class="string">&#x27;redux-thunk&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> createLogger <span class="keyword">from</span> <span class="string">&#x27;redux-logger&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> promiseMiddleware <span class="keyword">from</span> <span class="string">&#x27;redux-promise&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> reducer <span class="keyword">from</span> <span class="string">&#x27;./reducers&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = createStore(reducer, applyMiddleware(thunk, createLogger, promiseMiddleware));</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 再处理异步action:</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> changeBtnTextAsync = createAction(T.CHANGE_BTN_TEXT_ASYNC, <span class="function">(<span class="params">text</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> axios.get(<span class="string">`http://test.com/<span class="subst">$&#123;text&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>可以看到我们这里返回的是一个Promise对象.(axios的get方法结果就是Promise对象)</p>
<p>我们还记得redux-thunk中间件，它会去判断action是否是一个函数，如果是就执行。</p>
<p>而我们这里的redux-promise中间件，他会在dispatch时，判断如果action不是类似</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  type：<span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  payload： <span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样的结构，也就是 <a target="_blank" rel="noopener" href="https://github.com/redux-utilities/flux-standard-action">FSA</a>,那么就去判断是否为promise对象，如果是就执行action.then的玩法。</p>
<p>很明显，我们createAction后的结果是FSA，所以会走下面这个分支，它会去判断action.payload是否为promise对象，是的话那就</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">action.payload</span><br><span class="line">  .then(<span class="function"><span class="params">result</span> =&gt;</span> dispatch(&#123; ...action, <span class="attr">payload</span>: result &#125;))</span><br><span class="line">  .catch(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    dispatch(&#123; ...action, <span class="attr">payload</span>: error, <span class="attr">error</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(error);</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<p>也就是说我们的代码最后会转变为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">axios.get(<span class="string">`http://test.com/<span class="subst">$&#123;text&#125;</span>`</span>)</span><br><span class="line">  .then(<span class="function"><span class="params">result</span> =&gt;</span> dispatch(&#123; ...action, <span class="attr">payload</span>: result &#125;))</span><br><span class="line">  .catch(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    dispatch(&#123; ...action, <span class="attr">payload</span>: error, <span class="attr">error</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(error);</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>



<h2 id="react-redux性能优化之reselect"><a href="#react-redux性能优化之reselect" class="headerlink" title="react-redux性能优化之reselect"></a>react-redux性能优化之reselect</h2><p>selector 的作用：<strong>将多个 state 进行计算后生成新的 state</strong></p>
<h3 id="性能问题"><a href="#性能问题" class="headerlink" title="性能问题"></a>性能问题</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> propTypes = &#123;&#125;;  <span class="comment">// 省略</span></span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; visibleTodos, visibilityFilter, onAddClick, onTodoClick, onFilterChange &#125; = <span class="built_in">this</span>.props;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">AddTodo</span> <span class="attr">onAddClick</span>=<span class="string">&#123;(text)</span> =&gt;</span> onAddClick(text)&#125; /&gt;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">TodoList</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                    <span class="attr">todos</span>=<span class="string">&#123;visibleTodos&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                    <span class="attr">onTodoClick</span>=<span class="string">&#123;(index)</span> =&gt;</span> onTodoClick(index)&#125; /&gt;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">Footer</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                    <span class="attr">filter</span>=<span class="string">&#123;visibilityFilter&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                    <span class="attr">onFilterChange</span>=<span class="string">&#123;(nextFilter)</span> =&gt;</span> onFilterChange(nextFilter)&#125; /&gt;</span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 一个 state 计算函数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> selectTodos = <span class="function">(<span class="params">todos, filter</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (filter) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;SHOW_ALL&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> todos</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;SHOW_COMPLETED&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> todos.filter(<span class="function"><span class="params">todo</span> =&gt;</span> todo.completed)</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;SHOW_ACTIVE&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> todos.filter(<span class="function"><span class="params">todo</span> =&gt;</span> !todo.completed)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// mapStateToProps 就是一个 selector，每次组件更新的时候就会被调用</span></span><br><span class="line"><span class="comment">// 【缺点】每次组件更新的时候都会重新计算 visibleTodos，如果计算量比较大，会造成性能问题</span></span><br><span class="line"><span class="keyword">const</span> mapStateToProps = <span class="function">(<span class="params">state</span>) =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">visibleTodos</span>: selectTodos(state.todos, state.visibilityFilter),</span><br><span class="line">    <span class="attr">visibilityFilter</span>: state.visibilityFilter</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function">(<span class="params">dispatch</span>) =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">onAddClick</span>: <span class="function">(<span class="params">text</span>) =&gt;</span> dispatch(addTodo(text)),</span><br><span class="line">    <span class="attr">onTodoClick</span>: <span class="function">(<span class="params">index</span>) =&gt;</span> dispatch(toggleTodo(index)),</span><br><span class="line">    <span class="attr">onFilterChange</span>: <span class="function">(<span class="params">nextFilter</span>) =&gt;</span> dispatch(setVisibilityFilter(nextFilter))</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(mapStateToProps, mapDispatchToProps)(App);</span><br></pre></td></tr></table></figure>



<p>connect 函数实现的时候，我们知道<strong>映射 <code>props</code> 的函数被 <code>store.subscribe()</code> 了，因此每次组件更新的时候，无论 state 是否改变，都会调用 <code>mapStateToProps</code>，</strong>而 <code>mapStateToProps</code> 在计算 state 的时候就会调用 state 计算函数，<strong>过程</strong> 如下：</p>
<ol>
<li><code>store.subscribe()</code>（注册事件） </li>
<li>状态更新时调用 <code>mapStateToProps</code>（一个selector，返回 state） </li>
<li>调用 state 计算函数 <code>selectTodos</code></li>
</ol>
<p>那么，<strong>问题</strong> 来了，如果 selector 的计算量比较大，每次更新的重新计算就会造成性能问题。而解决性能问题的 <strong>出发点</strong> 就是：<strong>避免不必要的计算</strong>。</p>
<p><strong>解决问题的方式</strong>：从 selector 着手，即 <code>mapStateToProps</code>，<strong>如果 selector 接受的状态参数不变，那么就不调用计算函数，直接利用之前的结果。</strong></p>
<ul>
<li>reselect 其实就是 redux 的一个中间件，它通过计算获得新的 state，然后传递到 Redux Store。</li>
<li>其主要就是进行了中间的那一步计算，使得计算的状态被缓存，从而根据传入的 state 判断是否需要调用计算函数，而不用在组件每次更新的时候都进行调用，从而更加高效。</li>
</ul>
<p>不使用Selector：</p>
<p><img src="/images/d2ba211f-WechatIMG55.png" alt="WechatIMG55"></p>
<p>使用Selector：</p>
<p><img src="/images/dc7efae8-WechatIMG56.png" alt="WechatIMG56"></p>
<h3 id="采用-reselect，更新-App-组件"><a href="#采用-reselect，更新-App-组件" class="headerlink" title="采用 reselect，更新 App 组件"></a>采用 reselect，更新 App 组件</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不用 reselect 的缺点：每次组件更新的时候都会重新计算 visibleTodos</span></span><br><span class="line"><span class="comment">/*const mapStateToProps = (state) =&gt; (&#123;</span></span><br><span class="line"><span class="comment">    visibleTodos: selectTodos(state.todos, state.visibilityFilter),</span></span><br><span class="line"><span class="comment">    visibilityFilter: state.visibilityFilter</span></span><br><span class="line"><span class="comment">&#125;);*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 采用 reselect 后，相当于记忆缓存，会缓存状态</span></span><br><span class="line"><span class="comment">// 如果 state.todos 和 state.visibilityFilter 发生变化，它会重新计算 state</span></span><br><span class="line"><span class="comment">// 但是发生在其他部分的 state 变化，就不会重新计算</span></span><br><span class="line"><span class="keyword">const</span> getTodos = <span class="function">(<span class="params">state</span>) =&gt;</span> state.todos;</span><br><span class="line"><span class="keyword">const</span> getVisibilityFilter = <span class="function">(<span class="params">state</span>) =&gt;</span> state.visibilityFilter;</span><br><span class="line"></span><br><span class="line"><span class="comment">// reducer</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> selectTodos = <span class="function">(<span class="params">todos, filter</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (filter) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;SHOW_ALL&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> todos</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;SHOW_COMPLETED&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> todos.filter(<span class="function"><span class="params">todo</span> =&gt;</span> todo.completed)</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;SHOW_ACTIVE&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> todos.filter(<span class="function"><span class="params">todo</span> =&gt;</span> !todo.completed)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// getTodos 和 getVisibilityFilter 返回的参数将传入 selectTodos</span></span><br><span class="line"><span class="keyword">const</span> getVisibleTodos = createSelector(</span><br><span class="line">	[getTodos, getVisibilityFilter], </span><br><span class="line">  selectTodos</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapStateToProps = <span class="function">(<span class="params">state</span>) =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">visibleTodos</span>: getVisibleTodos(state),</span><br><span class="line">    <span class="attr">visibilityFilter</span>: state.visibilityFilter</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function">(<span class="params">dispatch</span>) =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">onAddClick</span>: <span class="function">(<span class="params">text</span>) =&gt;</span> dispatch(addTodo(text)),</span><br><span class="line">    <span class="attr">onTodoClick</span>: <span class="function">(<span class="params">index</span>) =&gt;</span> dispatch(toggleTodo(index)),</span><br><span class="line">    <span class="attr">onFilterChange</span>: <span class="function">(<span class="params">nextFilter</span>) =&gt;</span> dispatch(setVisibilityFilter(nextFilter))</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * connect用法：connect(selectors)(App); // selectors 即是一个对象，包含了状态属性和方法</span></span><br><span class="line"><span class="comment"> * connect作用：即使 Dumb 组件从 store 中获取数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// export default connect(mapStateToProps)(App);</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(mapStateToProps, mapDispatchToProps)(App);</span><br></pre></td></tr></table></figure>



<h3 id="解释"><a href="#解释" class="headerlink" title="解释"></a>解释</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">&#x27;react-redux&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; toggleTodo &#125; <span class="keyword">from</span> <span class="string">&#x27;../actions&#x27;</span></span><br><span class="line"><span class="keyword">import</span> TodoList <span class="keyword">from</span> <span class="string">&#x27;../components/TodoList&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//下面这段代码是根据过滤器的state来改变日程state的函数</span></span><br><span class="line"><span class="keyword">const</span> getVisibleTodos = <span class="function">(<span class="params">todos, filter</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (filter) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;SHOW_ALL&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> todos</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;SHOW_COMPLETED&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> todos.filter(<span class="function"><span class="params">t</span> =&gt;</span> t.completed)</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;SHOW_ACTIVE&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> todos.filter(<span class="function"><span class="params">t</span> =&gt;</span> !t.completed)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapStateToProps = <span class="function">(<span class="params">state</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="comment">//todos是根据过滤函数返回的state，传入两个实参</span></span><br><span class="line">    <span class="attr">todos</span>: getVisibleTodos(state.todos, state.visibilityFilter)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//mapDispatchToProps来传递dispatch的方法</span></span><br><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">onTodoClick</span>: <span class="function">(<span class="params">id</span>) =&gt;</span> &#123;</span><br><span class="line">      dispatch(toggleTodo(id))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//使用Redux的connect函数注入state,到TodoList组件</span></span><br><span class="line"><span class="keyword">const</span> VisibleTodoList = connect(</span><br><span class="line">  mapStateToProps,</span><br><span class="line">  mapDispatchToProps</span><br><span class="line">)(TodoList)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> VisibleTodoList</span><br></pre></td></tr></table></figure>

<ul>
<li><p>在上面的例子中,<code>mapStateToProps</code>调用<code>getVisibleTodos</code>去计算<code>todos</code>.这个函数设计的是相当好的,</p>
</li>
<li><p>但是有个缺点：<code>todos</code>在每一次组件更新的时候都会重新计算.如果state树的结构比较大,或者计算比较昂贵,每一次组件更新的时候都进行计算的话,将会导致性能问题.</p>
</li>
<li><p><code>Reselect</code>能够帮助redux来避免不必要的重新计算过程.</p>
</li>
<li><p>我们可以<strong>使用记忆缓存selector代替<code>getVisibleTodos</code></strong>,如果<code>state.todos</code>和<code>state.visibilityFilter</code>发生变化,他会重新计算<code>state</code>,但是发生在其他部分的state变化,就不会重新计算.</p>
</li>
<li><p>Reslect提供一个函数<code>createSelector</code>来创建一个记忆selectors.</p>
<ul>
<li><code>createSelector</code>接受一个<code>input-selectors</code>和一个变换函数作为参数.</li>
<li>如果Redux的<strong>state发生改变造成<code>input-selector</code>的值发生改变</strong>,selector会调用变换函数,依据<code>input-selector</code>做参数,返回一个结果.</li>
<li>如果<code>input-selector</code>返回的结果和前面的一样,那么就会直接返回有关state,会省略变换函数的调用.</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createSelector &#125; <span class="keyword">from</span> <span class="string">&#x27;reselect&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getVisibilityFilter = <span class="function">(<span class="params">state</span>) =&gt;</span> state.visibilityFilter</span><br><span class="line"><span class="keyword">const</span> getTodos = <span class="function">(<span class="params">state</span>) =&gt;</span> state.todos</span><br><span class="line"></span><br><span class="line"><span class="comment">//下面的函数是经过包装的</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getVisibleTodos = createSelector(</span><br><span class="line">  [ getVisibilityFilter, getTodos ],</span><br><span class="line">  <span class="function">(<span class="params">visibilityFilter, todos</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (visibilityFilter) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;SHOW_ALL&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> todos</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;SHOW_COMPLETED&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> todos.filter(<span class="function"><span class="params">t</span> =&gt;</span> t.completed)</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;SHOW_ACTIVE&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> todos.filter(<span class="function"><span class="params">t</span> =&gt;</span> !t.completed)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>上面的的实例中,<code>getVisibilityfilter</code>和<code>getTodos</code>是input-selectors.这两个函数是普通的非记忆selector函数,因为他们没有变换他们select的数据.</p>
</li>
<li><p><code>getVisibleTodos</code>另一方面是一个记忆selector.他接收<code>getVisibilityfilter</code>和<code>getTodos</code>作为input-selectors,并且作为一个变换函数计算筛选的todo list.</p>
</li>
</ul>
</li>
</ul>
<h3 id="聚合selectors"><a href="#聚合selectors" class="headerlink" title="聚合selectors"></a>聚合selectors</h3><p>一个记忆性selector本身也可以作为另一个记忆性selector的input-selector.这里<code>getVisibleTodos</code>可以作为input-selector作为关键字筛选的input-selector:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getKeyword = <span class="function">(<span class="params">state</span>) =&gt;</span> state.keyword</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getVisibleTodosFilteredByKeyword = createSelector(</span><br><span class="line">  [ getVisibleTodos, getKeyword ],</span><br><span class="line">  <span class="function">(<span class="params">visibleTodos, keyword</span>) =&gt;</span> visibleTodos.filter(</span><br><span class="line">    <span class="function"><span class="params">todo</span> =&gt;</span> todo.text.indexOf(keyword) &gt; -<span class="number">1</span></span><br><span class="line">  )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<h3 id="连接一个Selector到Redux-Store"><a href="#连接一个Selector到Redux-Store" class="headerlink" title="连接一个Selector到Redux Store"></a>连接一个Selector到Redux Store</h3><p>如果你正在使用 <a target="_blank" rel="noopener" href="https://link.jianshu.com/?t=https://github.com/reactjs/react-redux">React Redux</a>, 你可以直接传递selector到 <code>mapStateToProps()</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">&#x27;react-redux&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; toggleTodo &#125; <span class="keyword">from</span> <span class="string">&#x27;../actions&#x27;</span></span><br><span class="line"><span class="keyword">import</span> TodoList <span class="keyword">from</span> <span class="string">&#x27;../components/TodoList&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; getVisibleTodos &#125; <span class="keyword">from</span> <span class="string">&#x27;../selectors&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapStateToProps = <span class="function">(<span class="params">state</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">todos</span>: getVisibleTodos(state)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">onTodoClick</span>: <span class="function">(<span class="params">id</span>) =&gt;</span> &#123;</span><br><span class="line">      dispatch(toggleTodo(id))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> VisibleTodoList = connect(</span><br><span class="line">  mapStateToProps,</span><br><span class="line">  mapDispatchToProps</span><br><span class="line">)(TodoList)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> VisibleTodoList</span><br></pre></td></tr></table></figure>



<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>redux是一个可预测的状态容器，</li>
<li>react-redux是将store和react结合起来，使得数据展示和修改对于react项目而言更简单</li>
<li>redux中间件就是在dispatch action前对action做一些处理</li>
<li>redux-thunk用于对异步做操作</li>
<li>redux-actions用于简化redux操作</li>
<li>redux-promise可以配合redux-actions用来处理Promise对象，使得异步操作更简单</li>
</ul>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>