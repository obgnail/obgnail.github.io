<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;流程&quot;&gt;&lt;a href=&quot;#流程&quot; class=&quot;headerlink&quot; title=&quot;流程&quot;&gt;&lt;/a&gt;流程&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;/images/v2-0f7d1056f7466488a86e59967a03491c_1440w.jpg&quot; alt=&quot;img&quot;&gt;"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>用Python编写简单的gRPC服务 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Golang/" rel="tag">Golang</a></div><div class="post-time">2020-10-27</div></div></div><div class="container post-header"><h1>用Python编写简单的gRPC服务</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">2.</span> <span class="toc-text">环境准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.</span> <span class="toc-text">定义服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%92%8C%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%A0%B7%E4%BE%8B"><span class="toc-number">4.</span> <span class="toc-text">服务端和客户端样例</span></a></li></ol></details></div><div class="container post-content"><h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><p><img src="/images/v2-0f7d1056f7466488a86e59967a03491c_1440w.jpg" alt="img"></p>
<p><img src="/images/v2-e5d9e0a5978e74fe5cd2a3fd40bb5cc4_1440w.jpg" alt="img"></p>
<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install grpcio grpcio-tools</span><br></pre></td></tr></table></figure>



<h2 id="定义服务"><a href="#定义服务" class="headerlink" title="定义服务"></a>定义服务</h2><p>使用<a href="https://link.zhihu.com/?target=https://github.com/protocolbuffers/protobuf">protocolbuffers/protobuf</a>格式来创建结构化数据文件<code>SimpleCal.proto</code>，内容如下：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">Cal</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> Add(AddRequest) <span class="keyword">returns</span> (ResultReply) </span>&#123;&#125;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> Multiply(MultiplyRequest) <span class="keyword">returns</span> (ResultReply) </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">AddRequest</span> </span>&#123;</span><br><span class="line">  <span class="built_in">int32</span> number1  = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">int32</span> number2  = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">MultiplyRequest</span> </span>&#123;</span><br><span class="line">  <span class="built_in">int32</span> number1  = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">int32</span> number2  = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">ResultReply</span> </span>&#123;</span><br><span class="line">  <span class="built_in">int32</span> number = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在<code>SimpleCal.proto</code> 文件中定义了一个服务<code>Cal</code>，定义了2个RPC方法：<code>Add</code>和<code>Multiply</code>，需要分别在gRPC的服务端中实现加法和乘法。</li>
<li>同时我们也定义了2个方法的参数，<code>Add</code>方法的参数是<code>AddRequest</code>，包含number1和number2两个整数参数。 <code>Multiply</code>方法的参数是<code>MultiplyRequest</code>，里面也有number1和number2两个整数参数。两个函数的返回结构都是<code>ResultReply</code>，内容是一个整数。</li>
</ul>
<blockquote>
<p><code>message</code> 是代表数据结构（里面可以包括不同类型的成员变量，包括字符串、数字、数组、字典……），<code>service</code>代表 RPC 接口。变量后面的数字是代表进行二进制编码时候的提示信息，1~15 表示热变量，会用较少的字节来编码。</p>
</blockquote>
<p>根据上面的定义，生成Python代码：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> python3 -m grpc_tools.protoc -I. --python_out=. --grpc_python_out=. ./SimpleCal.proto</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls</span></span><br><span class="line">SimpleCal_pb2_grpc.py  SimpleCal_pb2.py  SimpleCal.proto</span><br></pre></td></tr></table></figure>

<ul>
<li>使用<code>python3 -m grpc_tools.protoc --hel</code>能获得命令的参数含义。</li>
<li><code>ls</code>可以看到<code>grpc_tools</code> 帮我们自动生成了 <code>SimpleCal_pb2_grpc.py</code>， <code>SimpleCal_pb2.py</code>这2个文件。这2个文件会在后面的客户端和服务端代码中被引用。</li>
</ul>
<h2 id="服务端和客户端样例"><a href="#服务端和客户端样例" class="headerlink" title="服务端和客户端样例"></a>服务端和客户端样例</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务端代码 cal_server.py：</span></span><br><span class="line"><span class="keyword">from</span> concurrent <span class="keyword">import</span> futures</span><br><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"><span class="keyword">import</span> SimpleCal_pb2</span><br><span class="line"><span class="keyword">import</span> SimpleCal_pb2_grpc</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CalServicer</span>(<span class="params">SimpleCal_pb2_grpc.CalServicer</span>):</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">Add</span>(<span class="params">self, request, context</span>):</span>   <span class="comment"># Add函数的实现逻辑</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Add function called&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> SimpleCal_pb2.ResultReply(number=request.number1 + request.number2)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">Multiply</span>(<span class="params">self, request, context</span>):</span>   <span class="comment"># Multiply函数的实现逻辑</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Multiply service called&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> SimpleCal_pb2.ResultReply(number=request.number1 * request.number2)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">serve</span>():</span></span><br><span class="line">  server = grpc.server(futures.ThreadPoolExecutor(max_workers=<span class="number">5</span>))</span><br><span class="line">  SimpleCal_pb2_grpc.add_CalServicer_to_server(CalServicer(),server)</span><br><span class="line">  server.add_insecure_port(<span class="string">&quot;[::]:50051&quot;</span>)</span><br><span class="line">  server.start()</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;grpc server start...&quot;</span>)</span><br><span class="line">  server.wait_for_termination()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  serve()</span><br></pre></td></tr></table></figure>

<ul>
<li>这里的重点在于<code>CalServicer</code>类中对<code>Add</code>和<code>Multiply</code>两个方法的实现。</li>
<li>逻辑很简单，从<code>request</code>中读取number1和number2，然后相加。注意，这里的所有变量都需要完整名称：request.number1和request.number2， <strong>不能使用位置参数</strong>。<code>Multiply</code> 的实现和<code>Add</code>一样，不多说了。</li>
<li> <code>serve</code>函数里定义了gRPC的运行方式，使用5个worker的线程池。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 客户端代码 cal_client.py ：</span></span><br><span class="line"><span class="keyword">import</span> SimpleCal_pb2</span><br><span class="line"><span class="keyword">import</span> SimpleCal_pb2_grpc</span><br><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">n, m</span>):</span></span><br><span class="line">  channel = grpc.insecure_channel(<span class="string">&#x27;localhost:50051&#x27;</span>) <span class="comment"># 连接上gRPC服务端</span></span><br><span class="line">  stub = SimpleCal_pb2_grpc.CalStub(channel)</span><br><span class="line">  response = stub.Add(SimpleCal_pb2.AddRequest(number1=n, number2=m))  <span class="comment"># 执行计算命令</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;n&#125;</span> + <span class="subst">&#123;m&#125;</span> = <span class="subst">&#123;response.number&#125;</span>&quot;</span>)</span><br><span class="line">  response = stub.Multiply(SimpleCal_pb2.MultiplyRequest(number1=n, number2=m))</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;n&#125;</span> * <span class="subst">&#123;m&#125;</span> = <span class="subst">&#123;response.number&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">  run(<span class="number">100</span>, <span class="number">300</span>)</span><br></pre></td></tr></table></figure>

<p>客户端的逻辑更加简单，就连上gRPC服务，然后发起调用。</p>
<p>下面开启服务端，并执行客户端代码调用gRPC服务，结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ python3 cal_server.py  &amp;</span><br><span class="line">$ python3 cal_client.py </span><br><span class="line">100 + 300 = 400</span><br><span class="line">100 * 300 = 30000</span><br></pre></td></tr></table></figure>











</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>