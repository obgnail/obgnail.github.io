<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;时间管理&quot;&gt;&lt;a href=&quot;#时间管理&quot; class=&quot;headerlink&quot; title=&quot;时间管理&quot;&gt;&lt;/a&gt;时间管理&lt;/h2&gt;&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; datetime&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; collections &lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; namedtuple&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;_Time = namedtuple(&lt;span class=&quot;string&quot;&gt;&amp;quot;Time&amp;quot;&lt;/span&gt;, (&lt;span class=&quot;string&quot;&gt;&amp;quot;timestamp&amp;quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;date&amp;quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;datetime&amp;quot;&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;get_all_time&lt;/span&gt;():&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    now = datetime.datetime.now()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    timestamp = &lt;span class=&quot;built_in&quot;&gt;int&lt;/span&gt;(now.strftime(&lt;span class=&quot;string&quot;&gt;&amp;quot;%s&amp;quot;&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; _Time(timestamp=timestamp, date=now.date(), datetime=now)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;这样, 就可以通过"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>note2 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/zhangkun-internship/" rel="tag">zhangkun_internship</a></div><div class="post-time">2020-01-19</div></div></div><div class="container post-header"><h1>note2</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E7%AE%A1%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">时间管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">2.</span> <span class="toc-text">Redis实现分布式锁</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E4%BA%8E%E4%B8%8D%E6%95%8F%E6%84%9F%E7%9A%84%E6%95%B0%E6%8D%AE-%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8js%E5%86%99%E5%85%A5cookies-%E7%84%B6%E5%90%8E%E8%AF%BB%E5%8F%96"><span class="toc-number">3.</span> <span class="toc-text">对于不敏感的数据 , 我们可以使用js写入cookies ,然后读取</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Flask%E8%A7%86%E5%9B%BE%E5%87%BD%E6%95%B0%E4%BD%BF%E7%94%A8%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="toc-number">4.</span> <span class="toc-text">Flask视图函数使用装饰器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LocalStorage"><span class="toc-number">5.</span> <span class="toc-text">LocalStorage</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#localStorage"><span class="toc-number">6.</span> <span class="toc-text">localStorage</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A6%81%E5%A4%9A%E5%A4%9A%E4%BD%BF%E7%94%A8or%E6%9D%A5%E4%BB%A3%E6%9B%BFIf"><span class="toc-number">7.</span> <span class="toc-text">要多多使用or来代替If</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E5%8F%B0%E9%AA%8C%E8%AF%81"><span class="toc-number">8.</span> <span class="toc-text">后台验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E4%BA%8EFlask-login-%E5%A6%82%E6%9E%9CPK%E4%B8%8D%E6%98%AFID-%E9%9C%80%E8%A6%81%E9%87%8D%E5%86%99get-id"><span class="toc-number">9.</span> <span class="toc-text">对于Flask_login , 如果PK不是ID ,需要重写get_id</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Flask-login%E5%86%85%E9%83%A8%E9%80%BB%E8%BE%91"><span class="toc-number">10.</span> <span class="toc-text">Flask-login内部逻辑</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A6%96%E6%AC%A1%E7%99%BB%E9%99%86"><span class="toc-number">10.1.</span> <span class="toc-text">首次登陆</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%9E%E9%A6%96%E6%AC%A1%E7%99%BB%E9%99%86"><span class="toc-number">10.2.</span> <span class="toc-text">非首次登陆</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#login-required%E8%A3%85%E9%A5%B0%E5%99%A8%E6%98%AF%E6%80%8E%E4%B9%88%E5%81%9A%E5%88%B0%E4%BF%9D%E6%8A%A4%E8%B7%AF%E7%94%B1%E5%87%BD%E6%95%B0"><span class="toc-number">11.</span> <span class="toc-text">@login_required装饰器是怎么做到保护路由函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Debug%E6%96%B9%E6%B3%95"><span class="toc-number">12.</span> <span class="toc-text">Debug方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#flask%E7%9A%84%E8%87%AA%E5%A2%9E%E5%88%97%E5%8D%83%E4%B8%87%E4%B8%8D%E8%83%BD%E8%87%AA%E5%B7%B1%E6%B7%BB%E5%85%A5-%E5%BF%85%E9%A1%BB%E4%BA%A4%E7%BB%99sql%E8%87%AA%E5%B7%B1%E8%87%AA%E5%A2%9E%E5%A1%AB%E5%85%A5"><span class="toc-number">13.</span> <span class="toc-text">flask的自增列千万不能自己添入,必须交给sql自己自增填入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#flask%E7%BB%9D%E5%AF%B9%E4%B8%8D%E8%83%BD%E8%87%AA%E5%B7%B1%E6%89%8B%E5%8A%A8%E5%88%9B%E5%BB%BA%E8%A1%A8"><span class="toc-number">14.</span> <span class="toc-text">flask绝对不能自己手动创建表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#flask%E7%9A%84Form%E4%B8%AD%E5%8F%82%E6%95%B0%E4%B8%8D%E8%A6%81%E4%BD%BF%E7%94%A8default"><span class="toc-number">15.</span> <span class="toc-text">flask的Form中参数不要使用default</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%A4%8D%E7%94%A8%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">16.</span> <span class="toc-text">代码复用的方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#api%E6%96%87%E6%A1%A3"><span class="toc-number">17.</span> <span class="toc-text">api文档</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#python%E4%BF%AE%E6%94%B9%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">18.</span> <span class="toc-text">python修改环境变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pytest%E4%BB%A5%E7%B1%BB%E7%9A%84%E5%BD%A2%E5%BC%8F%E7%BC%96%E5%86%99%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B"><span class="toc-number">19.</span> <span class="toc-text">pytest以类的形式编写测试用例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Flask%E4%BD%BF%E7%94%A8redis%E4%BD%9C%E4%B8%BA%E7%BC%93%E5%AD%98%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="toc-number">20.</span> <span class="toc-text">Flask使用redis作为缓存装饰器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%87%E6%8D%A2redis%E7%9A%84%E6%97%B6%E5%80%99%E6%8A%A5UnicodeDecodeError-%E9%94%99%E8%AF%AF"><span class="toc-number">21.</span> <span class="toc-text">切换redis的时候报UnicodeDecodeError 错误</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3updtae%E6%97%B6%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">22.</span> <span class="toc-text">解决updtae时的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BD%93if%E6%83%B3%E7%9D%80%E8%A6%81%E5%B5%8C%E5%A5%97%E7%9A%84%E6%97%B6%E5%80%99%E5%8F%AF%E4%BB%A5%E8%80%83%E8%99%91%E4%BE%8B%E5%A4%96"><span class="toc-number">23.</span> <span class="toc-text">当if想着要嵌套的时候可以考虑例外</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Serialize%E7%9A%84%E4%BC%98%E7%A7%80%E5%AE%9E%E8%B7%B5"><span class="toc-number">24.</span> <span class="toc-text">Serialize的优秀实践</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mixin%E7%B1%BB%E7%9A%84%E5%B8%B8%E7%94%A8%E8%AE%BE%E8%AE%A1%E6%80%BB%E7%BB%93"><span class="toc-number">25.</span> <span class="toc-text">Mixin类的常用设计总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sqlalchemy%E7%9A%84remote-side"><span class="toc-number">26.</span> <span class="toc-text">Sqlalchemy的remote_side</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#db-create-all-%E6%98%AF%E5%BB%BA%E8%A1%A8-%E4%B8%8D%E6%98%AF%E5%BB%BA%E5%BA%93"><span class="toc-number">27.</span> <span class="toc-text">db.create_all()是建表 , 不是建库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%99%BB%E5%BD%95psql"><span class="toc-number">28.</span> <span class="toc-text">命令行登录psql</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pytest%E5%8C%B9%E9%85%8D%E9%83%A8%E5%88%86%E5%87%BD%E6%95%B0"><span class="toc-number">29.</span> <span class="toc-text">pytest匹配部分函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pytest%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">30.</span> <span class="toc-text">pytest常用命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A3%E5%88%99%E8%8E%B7%E5%8F%96%E8%A1%A8%E6%A0%BC%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">31.</span> <span class="toc-text">正则获取表格的最佳实践</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#re-findall"><span class="toc-number">32.</span> <span class="toc-text">re.findall</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#boostrap%E5%93%8D%E5%BA%94click%E4%BA%8B%E4%BB%B6"><span class="toc-number">33.</span> <span class="toc-text">boostrap响应click事件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E5%AE%9E%E4%B8%8D%E9%9C%80%E8%A6%81%E4%BD%BF%E7%94%A8debugtool-%E7%9B%B4%E6%8E%A5%E5%9C%A8network%E9%87%8C%E6%9F%A5%E7%9C%8B%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="toc-number">34.</span> <span class="toc-text">其实不需要使用debugtool , 直接在network里查看返回值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E6%84%8Fjquery%E7%9A%84trigger%E5%87%BD%E6%95%B0-%E7%9B%B4%E6%8E%A5%E8%A7%A6%E5%8F%91%E6%9F%90%E4%B8%AA%E4%BA%8B%E4%BB%B6"><span class="toc-number">35.</span> <span class="toc-text">注意jquery的trigger函数 , 直接触发某个事件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8%E5%89%8D%E7%AB%AF%E8%87%AA%E5%B7%B1%E5%86%99%E4%B8%80%E4%B8%AAflash"><span class="toc-number">36.</span> <span class="toc-text">在前端自己写一个flash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E6%80%81%E6%A1%86%E7%9A%84%E6%98%BE%E7%A4%BA%E4%B8%8E%E6%B6%88%E5%A4%B1"><span class="toc-number">37.</span> <span class="toc-text">模态框的显示与消失</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E4%BA%8E%E5%83%8F%E5%89%8D%E7%AB%AF%E4%B8%8D%E8%83%BD%E8%AE%BE%E7%BD%AE%E4%BC%A0%E9%80%92%E5%8F%98%E9%87%8F%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">38.</span> <span class="toc-text">对于像前端不能设置传递变量的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E4%BA%8Ewtform"><span class="toc-number">39.</span> <span class="toc-text">对于wtform</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%90%E7%A4%BA%E6%A1%86%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%9E%E7%94%A8"><span class="toc-number">40.</span> <span class="toc-text">提示框的简单实用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8boostrap%E7%9A%84%E5%9B%BE%E6%A0%87"><span class="toc-number">41.</span> <span class="toc-text">使用boostrap的图标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#marshmallow%E9%AA%8C%E8%AF%81"><span class="toc-number">42.</span> <span class="toc-text">marshmallow验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">43.</span> <span class="toc-text">序列化与反序列化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#falsk%E4%BD%BF%E7%94%A8join"><span class="toc-number">44.</span> <span class="toc-text">falsk使用join</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#group-by-%E5%92%8C-join%E4%B8%80%E8%B5%B7%E4%BD%BF%E7%94%A8"><span class="toc-number">45.</span> <span class="toc-text">group_by 和 join一起使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#flask-query"><span class="toc-number">46.</span> <span class="toc-text">flask-query</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8WTF"><span class="toc-number">47.</span> <span class="toc-text">常用WTF</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8Modal"><span class="toc-number">48.</span> <span class="toc-text">常用Modal</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#group-by"><span class="toc-number">49.</span> <span class="toc-text">group_by</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#html%E5%A4%8D%E5%88%B6%E5%8A%9F%E8%83%BD"><span class="toc-number">50.</span> <span class="toc-text">html复制功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B0%E5%A2%9Ewtform%E4%B8%8D%E5%AD%98%E5%9C%A8%E7%9A%84%E5%AD%97%E6%AE%B5"><span class="toc-number">51.</span> <span class="toc-text">新增wtform不存在的字段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#select-%E5%AE%9E%E7%8E%B0placeholder-%E6%95%88%E6%9E%9C"><span class="toc-number">52.</span> <span class="toc-text">select 实现placeholder 效果</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3app-choices%E4%B8%8D%E6%96%AD%E8%A2%ABappend%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">53.</span> <span class="toc-text">解决app_choices不断被append的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8QueryClass"><span class="toc-number">54.</span> <span class="toc-text">使用QueryClass</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E7%9A%84%E4%BD%BF%E7%94%A8%E4%BD%BF%E7%94%A8%E7%9A%84filter"><span class="toc-number">55.</span> <span class="toc-text">查询的使用使用的filter</span></a></li></ol></details></div><div class="container post-content"><h2 id="时间管理"><a href="#时间管理" class="headerlink" title="时间管理"></a>时间管理</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</span><br><span class="line"></span><br><span class="line">_Time = namedtuple(<span class="string">&quot;Time&quot;</span>, (<span class="string">&quot;timestamp&quot;</span>, <span class="string">&quot;date&quot;</span>, <span class="string">&quot;datetime&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_all_time</span>():</span></span><br><span class="line">    now = datetime.datetime.now()</span><br><span class="line">    timestamp = <span class="built_in">int</span>(now.strftime(<span class="string">&quot;%s&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span> _Time(timestamp=timestamp, date=now.date(), datetime=now)</span><br></pre></td></tr></table></figure>

<p>这样, 就可以通过</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">t = get_all_time()</span><br><span class="line">t.timestamp</span><br><span class="line">t.data</span><br><span class="line">t.datetime</span><br></pre></td></tr></table></figure>

<p>来获取</p>
<h2 id="Redis实现分布式锁"><a href="#Redis实现分布式锁" class="headerlink" title="Redis实现分布式锁"></a>Redis实现分布式锁</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisLock</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;redis dist lock</span></span><br><span class="line"><span class="string">    @param name 锁名称</span></span><br><span class="line"><span class="string">    @param client redis连接</span></span><br><span class="line"><span class="string">    @param timeout 超过多少ms锁不释放，则自动过期</span></span><br><span class="line"><span class="string">    @param retries 重试次数</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, client, timeout=<span class="number">2000</span>, retries=<span class="number">0</span></span>):</span></span><br><span class="line">        <span class="keyword">assert</span> retries &gt;= <span class="number">0</span>, <span class="string">&#x27;retries must &gt;= 0&#x27;</span></span><br><span class="line">        self.key = <span class="string">&quot;distributed-redis-lock:%s&quot;</span> % name</span><br><span class="line">        self.client = client</span><br><span class="line">        self.timeout = timeout</span><br><span class="line">        self.retries = retries</span><br><span class="line">        self.has_lock = <span class="literal">False</span></span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            is_ok = self.client.<span class="built_in">set</span>(self.key, <span class="number">1</span>, ex=self.timeout, nx=<span class="literal">True</span>)</span><br><span class="line">            <span class="keyword">if</span> is_ok:</span><br><span class="line">                self.has_lock = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">return</span> self</span><br><span class="line">            <span class="keyword">if</span> self.retries == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            self.retries -= <span class="number">1</span></span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span>(<span class="params">self, exc_type, exc_val, exc_tb</span>):</span></span><br><span class="line">        self.client.delete(self.key)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 锁调用示例</span></span><br><span class="line">redis_url = <span class="string">&quot;redis://@127.0.0.1:6379/0&quot;</span></span><br><span class="line">client = redis.StrictRedis.from_url(redis_url)</span><br><span class="line"> </span><br><span class="line">uname = <span class="string">&quot;test001&quot;</span> <span class="comment"># 注册用户名</span></span><br><span class="line"><span class="keyword">with</span> RedisLock(<span class="string">&quot;reg:uname:%s&quot;</span> % uname, client) <span class="keyword">as</span> lock:</span><br><span class="line">    <span class="keyword">if</span> lock.has_lock:</span><br><span class="line">        <span class="comment"># 注册逻辑</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>



<h2 id="对于不敏感的数据-我们可以使用js写入cookies-然后读取"><a href="#对于不敏感的数据-我们可以使用js写入cookies-然后读取" class="headerlink" title="对于不敏感的数据 , 我们可以使用js写入cookies ,然后读取"></a>对于不敏感的数据 , 我们可以使用js写入cookies ,然后读取</h2><p>这样就不需要经过后端</p>
<h2 id="Flask视图函数使用装饰器"><a href="#Flask视图函数使用装饰器" class="headerlink" title="Flask视图函数使用装饰器"></a>Flask视图函数使用装饰器</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cookies_hander</span>(<span class="params">func</span>):</span></span><br><span class="line"><span class="meta">    @functools.wraps(<span class="params">func</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">        res = func(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(res,werkzeug.wrappers.response.Response):</span><br><span class="line">            res = Response(res)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> request.cookies.get(<span class="string">&#x27;collapse&#x27;</span>):</span><br><span class="line">            res.set_cookie(<span class="string">&#x27;collapse&#x27;</span>, <span class="string">&#x27;True&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    <span class="keyword">return</span> inner</span><br><span class="line"></span><br><span class="line"><span class="meta">@index_router.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>, ]</span>)</span></span><br><span class="line"><span class="meta">@cookies_hander</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    登录页</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    form = UserOauthForm()</span><br><span class="line">    <span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">        user = UserOauth.get_user(form.data.get(<span class="string">&#x27;eid&#x27;</span>))</span><br><span class="line">        <span class="comment"># 登录用户</span></span><br><span class="line">        <span class="keyword">if</span> form.data.get(<span class="string">&#x27;remember_me&#x27;</span>):</span><br><span class="line">            login_user(user, remember=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            login_user(user)</span><br><span class="line">        flash(<span class="string">f&quot;欢迎登陆: 工号<span class="subst">&#123;user.<span class="built_in">id</span>&#125;</span>&quot;</span>, category=<span class="string">&quot;success&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(request.args.get(<span class="string">&#x27;next&#x27;</span>) <span class="keyword">or</span> url_for(<span class="string">&quot;emp.emp_detail&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;user/login.html&#x27;</span>, form=form)</span><br></pre></td></tr></table></figure>



<h2 id="LocalStorage"><a href="#LocalStorage" class="headerlink" title="LocalStorage"></a>LocalStorage</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">handleLocalStorage</span>(<span class="params">method, key, value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (method) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;get&#x27;</span> : &#123;</span><br><span class="line">      <span class="keyword">let</span> temp = <span class="built_in">window</span>.localStorage.getItem(key);</span><br><span class="line">      <span class="keyword">if</span> (temp) &#123;</span><br><span class="line">        <span class="keyword">return</span> temp</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;set&#x27;</span> : &#123;</span><br><span class="line">      <span class="built_in">window</span>.localStorage.setItem(key, value);</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;remove&#x27;</span>: &#123;</span><br><span class="line">      <span class="built_in">window</span>.localStorage.removeItem(key);</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attr">default</span> : &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 存储</span></span><br><span class="line">handleLocalStorage(<span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;userName&#x27;</span>, <span class="string">&#x27;Tom&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取</span></span><br><span class="line">handleLocalStorage(<span class="string">&#x27;get&#x27;</span>, <span class="string">&#x27;userName&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除</span></span><br><span class="line">handleLocalStorage(<span class="string">&#x27;remove&#x27;</span>, <span class="string">&#x27;userName&#x27;</span>);</span><br></pre></td></tr></table></figure>



<h2 id="localStorage"><a href="#localStorage" class="headerlink" title="localStorage"></a>localStorage</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">     <span class="keyword">var</span> if_collapse = <span class="built_in">localStorage</span>.getItem(<span class="string">&#x27;if_collapse&#x27;</span>);</span></span><br><span class="line"><span class="javascript">     <span class="keyword">if</span> (!if_collapse || if_collapse === <span class="string">&quot;0&quot;</span>) &#123;</span></span><br><span class="line"><span class="javascript">         $(<span class="string">`body`</span>).attr(<span class="string">`class`</span>, <span class="string">`sidebar-mini sidebar-open`</span>)</span></span><br><span class="line"><span class="javascript">     &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">         $(<span class="string">`body`</span>).attr(<span class="string">`class`</span>, <span class="string">`sidebar-mini sidebar-collapse`</span>)</span></span><br><span class="line"><span class="javascript">     &#125;</span></span><br><span class="line"><span class="javascript">     $(<span class="string">`#sidebar-collapse-ctrl`</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">         <span class="keyword">if</span> (!if_collapse || if_collapse === <span class="string">&quot;0&quot;</span>) &#123;</span></span><br><span class="line"><span class="javascript">             <span class="built_in">localStorage</span>.setItem(<span class="string">&quot;if_collapse&quot;</span>, <span class="string">&quot;1&quot;</span>);</span></span><br><span class="line"><span class="javascript">         &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">             <span class="built_in">localStorage</span>.setItem(<span class="string">&quot;if_collapse&quot;</span>, <span class="string">&quot;0&quot;</span>);</span></span><br><span class="line"><span class="javascript">         &#125;</span></span><br><span class="line"><span class="javascript">     &#125;)</span></span><br><span class="line"><span class="javascript"> </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="要多多使用or来代替If"><a href="#要多多使用or来代替If" class="headerlink" title="要多多使用or来代替If"></a>要多多使用or来代替If</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> collapse = localStoIfrage.getItem(<span class="string">&quot;collapse&quot;</span>) || <span class="string">&quot;sidebar-collapse&quot;</span>;</span></span><br><span class="line"><span class="javascript">    $(<span class="string">`body`</span>).attr(<span class="string">`class`</span>, <span class="string">`sidebar-mini <span class="subst">$&#123;collapse&#125;</span>`</span>);</span></span><br><span class="line"><span class="javascript">    $(<span class="string">`.nav-link[data-widget=&quot;pushmenu&quot;]`</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> t = collapse === <span class="string">&quot;sidebar-collapse&quot;</span> ? <span class="string">&quot;sidebar-open&quot;</span>:<span class="string">&quot;sidebar-collapse&quot;</span>;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">localStorage</span>.setItem(<span class="string">&quot;collapse&quot;</span>, t);</span></span><br><span class="line"><span class="javascript">    &#125;)</span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="后台验证"><a href="#后台验证" class="headerlink" title="后台验证"></a>后台验证</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">site_id,login_username,login_password</span>)</span></span><br><span class="line"><span class="function">    <span class="title">req</span> = &#123;</span></span><br><span class="line"><span class="function">            &#x27;<span class="title">site_id</span>&#x27;:</span> site_id,</span><br><span class="line">            <span class="string">&#x27;login_username&#x27;</span>: login_username,</span><br><span class="line">            <span class="string">&#x27;login_password&#x27;</span>: login_password,</span><br><span class="line">            <span class="string">&#x27;time&#x27;</span>: <span class="built_in">int</span>(time.time())</span><br><span class="line">        &#125;</span><br><span class="line">        req[<span class="string">&#x27;sign&#x27;</span>] = generate_signature(req)</span><br><span class="line">        res = requests.post(url, json=req)</span><br><span class="line">        <span class="keyword">if</span> res.status_code != <span class="number">200</span> <span class="keyword">or</span> res.json()[<span class="string">&#x27;state&#x27;</span>] != <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">return</span> res.json()[<span class="string">&#x27;data&#x27;</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_signature</span>(<span class="params">req</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;生成签名</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        req (dict): 包含请求参数的字典</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        str: 使用请求参数生成的签名</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    req_str = <span class="string">&#x27;&amp;&#x27;</span>.join([<span class="string">&#x27;&#123;&#125;=&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(k, v) <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">sorted</span>(req.items())])</span><br><span class="line">    secret_key = current_app.config[<span class="string">&#x27;ZK_LOGIN_SECRET_KEY&#x27;</span>]</span><br><span class="line">    unsign_str = req_str + secret_key</span><br><span class="line">    sign = md5(unsign_str.encode()).hexdigest()</span><br><span class="line">    <span class="keyword">return</span> sign</span><br></pre></td></tr></table></figure>

<ul>
<li>传递的参数包含一个sign</li>
<li>sign是由site_id,login_username,login_password,time和screct_key组成</li>
</ul>
<h2 id="对于Flask-login-如果PK不是ID-需要重写get-id"><a href="#对于Flask-login-如果PK不是ID-需要重写get-id" class="headerlink" title="对于Flask_login , 如果PK不是ID ,需要重写get_id"></a>对于Flask_login , 如果PK不是ID ,需要重写get_id</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_id</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;重写了UserMixin的get_id()&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(self.uid)</span><br></pre></td></tr></table></figure>

<p>get_id()</p>
<ul>
<li>返回一个能唯一识别用户的，并能用于从 user_loader 回调中加载用户的 unicode 。</li>
<li>注意着 必须 是一个 unicode   , 如果 ID 原本是 一个 int 或其它类型，你需要把它转换为 unicode 。</li>
</ul>
<h2 id="Flask-login内部逻辑"><a href="#Flask-login内部逻辑" class="headerlink" title="Flask-login内部逻辑"></a>Flask-login内部逻辑</h2><h3 id="首次登陆"><a href="#首次登陆" class="headerlink" title="首次登陆"></a>首次登陆</h3><p><img src="/images/3959253-b34989af4a0d0b2c.webp" alt="img"></p>
<p>Flask-Login在登录过程中主要负责：</p>
<ul>
<li>将用户对象存入request context中</li>
<li>将用户ID，Session ID等信息存入Session中</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login_user</span>(<span class="params">user, remember=<span class="literal">False</span>, force=<span class="literal">False</span>, fresh=<span class="literal">True</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> force <span class="keyword">and</span> <span class="keyword">not</span> user.is_active:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    user_id = <span class="built_in">getattr</span>(user, current_app.login_manager.id_attribute)()</span><br><span class="line">    session[<span class="string">&#x27;user_id&#x27;</span>] = user_id</span><br><span class="line">    session[<span class="string">&#x27;_fresh&#x27;</span>] = fresh</span><br><span class="line">    session[<span class="string">&#x27;_id&#x27;</span>] = current_app.login_manager._session_identifier_generator()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> remember:</span><br><span class="line">        session[<span class="string">&#x27;remember&#x27;</span>] = <span class="string">&#x27;set&#x27;</span></span><br><span class="line"></span><br><span class="line">    _request_ctx_stack.top.user = user</span><br><span class="line">    user_logged_in.send(current_app._get_current_object(), user=_get_user())</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li><p><code>getattr(user, current_app.login_manager.id_attribute)()</code> 这里<code>login_manager.id_attribute</code>是一个字符串<code>&#39;get_id&#39;</code>。因此这句的意思是获取User对象的get_id method，然后执行，从而获取到用户的ID</p>
</li>
<li><p>通过<code>session[&#39;user_id&#39;] = user_id</code>来将用户的ID存储进Session当中，后面紧跟着将fresh信息，session id信息，remember信息存储进session。</p>
</li>
<li><p><code>_request_ctx_stack.top.user = user</code>这里是将user对象存储进当前的request context中，_request_ctx_stack是一个LocalStack对象，top属性指向的就是当前的request context</p>
</li>
<li><p><code>user_logged_in.send(current_app._get_current_object(), user=_get_user())</code> 此句中<code>user_logged_in</code>是Flask-Login定义的signal，此处通过send来发射此signal，当注册监听此signal的回调函数收到此signal之后就会执行函数。</p>
<p>这里send有两个参数，</p>
<ul>
<li>第一个参数是sender对象，此处通过<code>current_app._get_current_object()</code>来获取当前的app对象，即此signal的sender设为当前的应用；</li>
<li>第二个参数是该signal携带的数据，此处将user对象做为signal的数据传递给相应的回调函数。</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="非首次登陆"><a href="#非首次登陆" class="headerlink" title="非首次登陆"></a>非首次登陆</h3><p><img src="/images/3959253-7ea20e139da6e2ae.webp" alt="img"></p>
<p>在这个流程图中，Flask-Login主要起如下作用：</p>
<ol>
<li>从session中获取用户ID</li>
<li>当用户的请求访问的是受登录保护的路由时，就要通过用户ID重新<code>load user</code>(重新写入session值,将user重新写入请求上下文)，如果load user失败则进入鉴权失败处理流程，如果成功，则允许正常处理请求</li>
</ol>
<h2 id="login-required装饰器是怎么做到保护路由函数"><a href="#login-required装饰器是怎么做到保护路由函数" class="headerlink" title="@login_required装饰器是怎么做到保护路由函数"></a><code>@login_required</code>装饰器是怎么做到保护路由函数</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># flask_login/utils.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login_required</span>(<span class="params">func</span>):</span></span><br><span class="line"><span class="meta">    @wraps(<span class="params">func</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorated_view</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 如果request method为例外method，即在EXEMPT_METHODS中的method，可以不必鉴权</span></span><br><span class="line">        <span class="keyword">if</span> request.method <span class="keyword">in</span> EXEMPT_METHODS:</span><br><span class="line">            <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 如果_login_disabled为True则不必鉴权</span></span><br><span class="line">        <span class="keyword">elif</span> current_app.login_manager._login_disabled:</span><br><span class="line">            <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 正常鉴权</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="keyword">not</span> current_user.is_authenticated:</span><br><span class="line">            <span class="keyword">return</span> current_app.login_manager.unauthorized()</span><br><span class="line">        <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> decorated_view</span><br></pre></td></tr></table></figure>

<p>默认情况下只有<em>OPTIONS</em> method在EXEMPT_METHODS set中，而GET、PUT、POST等常见的methods都需要鉴权</p>
<p> <code>_login_disabled</code>默认为False</p>
<p>正常鉴权的关键在于<code>current_user.is_authenticated</code>是否为True，为True则正常处理请求，为False则进入unauthorized处理流程。</p>
<p>这个current_user到底怎么就能鉴权了？它是怎么来的呢？来看下定义：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># flask_login/utils.py</span></span><br><span class="line">current_user = LocalProxy(<span class="keyword">lambda</span>: _get_user())</span><br></pre></td></tr></table></figure>

<ul>
<li>current_user是一个LocalProxy对象，其代理的对象需要通过<code>_get_user()</code>来获取，简单来说_get_user()会返回两种用户，一种是正常的用户对象(鉴权成功)，一种是anonymous用户对象(鉴权失败)。而正常的用户对象其<code>is_authenticated</code>属性总是为True，相对的anonymous用户对象的<code>is_authenticated</code>属性总是为False</li>
</ul>
<blockquote>
<p>LocalProxy对象每次操作都会重新获取代理的对象从而实现动态更新</p>
</blockquote>
<p>而要实现动态更新的关键就在于<code>_get_user</code>函数，接下来我们看下<code>_get_user</code>函数是如何获取user对象的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># flask_login/utils.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_get_user</span>():</span></span><br><span class="line">    <span class="keyword">if</span> has_request_context() <span class="keyword">and</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(_request_ctx_stack.top, <span class="string">&#x27;user&#x27;</span>):</span><br><span class="line">        current_app.login_manager._load_user()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">getattr</span>(_request_ctx_stack.top, <span class="string">&#x27;user&#x27;</span>, <span class="literal">None</span>)</span><br></pre></td></tr></table></figure>

<p>在之前的首次登陆那小节中，我们已经知道用户鉴权成功后，会将User对象保存在当前的request context当中，这时我们调用<code>_get_user</code>函数时就会直接从request context中获取user对象<code>return getattr(_request_ctx_stack.top, &#39;user&#39;, None)</code><br> 但如果是非首次登陆，当前request context中并没有保存user对象，就需要调用<code>current_app.login_manager._load_user()</code>来去load user对象</p>
<p>接下来再看看如何去load：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># flask_login/login_manager.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_load_user</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;Loads user from session or remember_me cookie as applicable&#x27;&#x27;&#x27;</span></span><br><span class="line">        user_accessed.send(current_app._get_current_object())</span><br><span class="line"></span><br><span class="line">        <span class="comment"># first check SESSION_PROTECTION</span></span><br><span class="line">        config = current_app.config</span><br><span class="line">        <span class="keyword">if</span> config.get(<span class="string">&#x27;SESSION_PROTECTION&#x27;</span>, self.session_protection):</span><br><span class="line">            deleted = self._session_protection()</span><br><span class="line">            <span class="keyword">if</span> deleted:</span><br><span class="line">                <span class="keyword">return</span> self.reload_user()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># If a remember cookie is set, and the session is not, move the</span></span><br><span class="line">        <span class="comment"># cookie user ID to the session.</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment"># However, the session may have been set if the user has been</span></span><br><span class="line">        <span class="comment"># logged out on this request, &#x27;remember&#x27; would be set to clear,</span></span><br><span class="line">        <span class="comment"># so we should check for that and not restore the session.</span></span><br><span class="line">        is_missing_user_id = <span class="string">&#x27;user_id&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> session</span><br><span class="line">        <span class="keyword">if</span> is_missing_user_id:</span><br><span class="line">            cookie_name = config.get(<span class="string">&#x27;REMEMBER_COOKIE_NAME&#x27;</span>, COOKIE_NAME)</span><br><span class="line">            header_name = config.get(<span class="string">&#x27;AUTH_HEADER_NAME&#x27;</span>, AUTH_HEADER_NAME)</span><br><span class="line">            has_cookie = (cookie_name <span class="keyword">in</span> request.cookies <span class="keyword">and</span></span><br><span class="line">                          session.get(<span class="string">&#x27;remember&#x27;</span>) != <span class="string">&#x27;clear&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> has_cookie:</span><br><span class="line">                <span class="keyword">return</span> self._load_from_cookie(request.cookies[cookie_name])</span><br><span class="line">            <span class="keyword">elif</span> self.request_callback:</span><br><span class="line">                <span class="keyword">return</span> self._load_from_request(request)</span><br><span class="line">            <span class="keyword">elif</span> header_name <span class="keyword">in</span> request.headers:</span><br><span class="line">                <span class="keyword">return</span> self._load_from_header(request.headers[header_name])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self.reload_user()</span><br></pre></td></tr></table></figure>

<p><code>_load_user</code>大体的过程是</p>
<ol>
<li>首先检查<em>SESSION_PROTECTION</em>设置，如果<em>SESSION_PROTECTION</em> 为strong或者basic类型，那么就会执行<code>_session_protection()</code>动作，否则不执行此操作。</li>
<li><code>_session_protection</code>在session_id不一致的时候(比如IP变化会导致session id的变化)才真正有用，这时，如果为basic类型或者session permanent为True时，只标注session为非新鲜的(not fresh)；而如果为strong，则会删除session中的用户信息，并重新load user，即调用<code>reload_user</code>。</li>
<li>接下来的代码是说当session中没有用户信息时(这里通过是否能获取到<code>user_id</code>来判断)，如果有则直接<code>reload_user</code>,如果没有，则有三种方式来load user，一种是通过remember cookie，一种通过request，一种是通过request header，依次尝试。</li>
</ol>
<blockquote>
<p>remember cookie是指，当用户勾选’remember me’复选框时，Flask-Login会将用户信息放入到指定的cookie当中，同样也是加密的。这就是为什么当session中没有携带用户信息时，我们可以通过remember cookie来获取用户的信息</p>
</blockquote>
<p>而<code>reload_user</code>是如何获取用户的呢，来看下源代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># flask_login/login_manager.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reload_user</span>(<span class="params">self, user=<span class="literal">None</span></span>):</span></span><br><span class="line">        ctx = _request_ctx_stack.top</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            user_id = session.get(<span class="string">&#x27;user_id&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> user_id <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="comment"># 当无法获取到有效的用户id时，就认为是anonymous user</span></span><br><span class="line">                ctx.user = self.anonymous_user()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># user callback就是我们通过@login_manager.user_loader装饰的函数，用于获取user object</span></span><br><span class="line">                <span class="keyword">if</span> self.user_callback <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    <span class="keyword">raise</span> Exception(</span><br><span class="line">                        <span class="string">&quot;No user_loader has been installed for this &quot;</span></span><br><span class="line">                        <span class="string">&quot;LoginManager. Add one with the &quot;</span></span><br><span class="line">                        <span class="string">&quot;&#x27;LoginManager.user_loader&#x27; decorator.&quot;</span>)</span><br><span class="line">                user = self.user_callback(user_id)</span><br><span class="line">                <span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    ctx.user = self.anonymous_user()</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    ctx.user = user</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            ctx.user = user</span><br></pre></td></tr></table></figure>

<ol>
<li>首先获取user id，如果获取不到有效的id，就将user设为anonymous user</li>
<li>获取到id后，再通过@login_manager.user_loader装饰的函数获取到user对象，如果没有获取到有效的user对象，就认为是anonymous user</li>
<li>最后将user保存于request context中（无论是正常的用户还是anonymous用户）</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/5ba6a956d504">https://www.jianshu.com/p/5ba6a956d504</a></p>
<ol>
<li>load_user(),被reload_user()调用,将load_user返回的Model实例写入上下文的user属性</li>
<li>reload_user(),每次请求被保护的视图函数时都会被调用,更新请求上下文的user属性 , 和session</li>
<li>current_user : 从请求上下文获取user属性</li>
<li>login_required : 判断current_user.is_authenticated,是否返回current_app.login_manager.unauthorized()</li>
</ol>
<h2 id="Debug方法"><a href="#Debug方法" class="headerlink" title="Debug方法"></a>Debug方法</h2><ul>
<li>就像要请求别人一样,跟自己讲述自己的操作 , 然后审视这些操作真的没有错误吗</li>
<li>别人发出的提问 ,说自己的错误操作 ,不要总想着反驳 , 审视自己真的没有这么做吗</li>
</ul>
<h2 id="flask的自增列千万不能自己添入-必须交给sql自己自增填入"><a href="#flask的自增列千万不能自己添入-必须交给sql自己自增填入" class="headerlink" title="flask的自增列千万不能自己添入,必须交给sql自己自增填入"></a>flask的自增列千万不能自己添入,必须交给sql自己自增填入</h2><h2 id="flask绝对不能自己手动创建表"><a href="#flask绝对不能自己手动创建表" class="headerlink" title="flask绝对不能自己手动创建表"></a>flask绝对不能自己手动创建表</h2><p>必须使用<code>create_all()</code>创建</p>
<h2 id="flask的Form中参数不要使用default"><a href="#flask的Form中参数不要使用default" class="headerlink" title="flask的Form中参数不要使用default"></a>flask的Form中参数不要使用default</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">status = SelectField(</span><br><span class="line">    <span class="string">&#x27;状态&#x27;</span>,</span><br><span class="line">    coerce=<span class="built_in">int</span>,</span><br><span class="line">    choices=[],</span><br><span class="line">    <span class="comment">#default=1  不要使用default</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>他会自动按照<code>从零到大</code>排序</p>
<h2 id="代码复用的方法"><a href="#代码复用的方法" class="headerlink" title="代码复用的方法"></a>代码复用的方法</h2><ul>
<li>装饰器</li>
<li>钩子函数</li>
<li>封装函数</li>
<li>创建父类</li>
</ul>
<h2 id="api文档"><a href="#api文档" class="headerlink" title="api文档"></a>api文档</h2><ul>
<li>接口功能</li>
<li>接口地址</li>
<li>接口所需参数<ul>
<li>必须参数 ,</li>
<li>非必须参数</li>
<li>通用参数</li>
</ul>
</li>
<li>接口返回数据<ul>
<li>数据字段</li>
<li>状态码</li>
<li>错误码</li>
</ul>
</li>
</ul>
<h2 id="python修改环境变量"><a href="#python修改环境变量" class="headerlink" title="python修改环境变量"></a>python修改环境变量</h2><ul>
<li>若没有特别设定，<strong>环境变量继承自父进程</strong>。</li>
<li>因此，你在 python 里面修改了环境变量，只能影响自身，及由它创建的子进程（若没有显式设定）。</li>
<li>要影响当前登录用户下的所有进程，你得从 “系统设置” - “高级” - “环境变量” 中设置，并重新登录（或重启）。</li>
</ul>
<h2 id="pytest以类的形式编写测试用例"><a href="#pytest以类的形式编写测试用例" class="headerlink" title="pytest以类的形式编写测试用例"></a>pytest以类的形式编写测试用例</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pytest以类形式的测试用例</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestAPI</span>:</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setup_class</span>(<span class="params">cls</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;\nsetup_class()&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">teardown_class</span>(<span class="params">cls</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;teardown_class()&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setup_method</span>(<span class="params">self, method</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;\nsetup_method()&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">teardown_method</span>(<span class="params">self, method</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;\nteardown_method()&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_1</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;- test_1()&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_2</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;- test_2()&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="Flask使用redis作为缓存装饰器"><a href="#Flask使用redis作为缓存装饰器" class="headerlink" title="Flask使用redis作为缓存装饰器"></a>Flask使用redis作为缓存装饰器</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_redis <span class="keyword">import</span> FlaskRedis</span><br><span class="line">cache_client = FlaskRedis(config_prefix=<span class="string">&quot;cache&quot;</span>)</span><br><span class="line">REDIS_HOST = os.environ.get(<span class="string">&#x27;REDIS_HOST&#x27;</span>, <span class="string">&#x27;127.0.0.1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cache_client.init(app)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> oa_app.extensions <span class="keyword">import</span> cache_client</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cache_table_data</span>(<span class="params">cache_time=<span class="number">60</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorator</span>(<span class="params">func</span>):</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">warpper</span>(<span class="params">cls, *args, **kwargs</span>):</span></span><br><span class="line">            <span class="string">&quot;&quot;&quot; redis 缓存装饰器 &quot;&quot;&quot;</span></span><br><span class="line">            args_key = <span class="string">&quot;.&quot;</span>.join([<span class="built_in">str</span>(k) <span class="keyword">for</span> k <span class="keyword">in</span> args])</span><br><span class="line">            redis_key = <span class="string">&quot;table:&#123;&#125;:&#123;&#125;:&#123;&#125;-&#123;&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">                cls.__name__,</span><br><span class="line">                func.__name__,</span><br><span class="line">                args_key,</span><br><span class="line">                json.dumps(kwargs)</span><br><span class="line">            )</span><br><span class="line">            <span class="comment"># 获取缓存</span></span><br><span class="line">            cache_data = cache_client.get(redis_key)</span><br><span class="line">            <span class="keyword">if</span> cache_data:</span><br><span class="line">                data = pickle.loads(cache_data)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                data = func(cls, *args, **kwargs)</span><br><span class="line">                cache_data = pickle.dumps(data)</span><br><span class="line">                cache_client.<span class="built_in">set</span>(redis_key, cache_data, cache_time)</span><br><span class="line">            <span class="keyword">return</span> data</span><br><span class="line">        <span class="keyword">return</span> warpper</span><br><span class="line">    <span class="keyword">return</span> decorator</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CRUDMixin</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    __table_args__ = &#123;<span class="string">&#x27;extend_existing&#x27;</span>: <span class="literal">True</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, autoincrement=<span class="literal">True</span>, primary_key=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line"><span class="meta">    @cache_table_data()</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_by_id</span>(<span class="params">cls, <span class="built_in">id</span></span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">any</span>((<span class="built_in">isinstance</span>(<span class="built_in">id</span>, <span class="built_in">str</span>) <span class="keyword">and</span> <span class="built_in">id</span>.isdigit(),</span><br><span class="line">                <span class="built_in">isinstance</span>(<span class="built_in">id</span>, (<span class="built_in">int</span>, <span class="built_in">float</span>))), ):</span><br><span class="line">            <span class="keyword">return</span> cls.query.get(<span class="built_in">int</span>(<span class="built_in">id</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line"><span class="meta">    @cache_table_data()</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_all</span>(<span class="params">cls</span>):</span></span><br><span class="line">        <span class="keyword">return</span> cls.query.<span class="built_in">all</span>()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_with_condition</span>(<span class="params">cls, condition</span>):</span></span><br><span class="line">        <span class="keyword">return</span> cls.query.<span class="built_in">filter</span>(condition).<span class="built_in">all</span>()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">cls, **kwargs</span>):</span></span><br><span class="line">        instance = cls(**kwargs)</span><br><span class="line">        <span class="keyword">return</span> instance.save()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">self, commit=<span class="literal">True</span>, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">for</span> attr, value <span class="keyword">in</span> kwargs.items():</span><br><span class="line">            <span class="built_in">setattr</span>(self, attr, value)</span><br><span class="line">        <span class="keyword">return</span> commit <span class="keyword">and</span> self.save() <span class="keyword">or</span> self</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save</span>(<span class="params">self, commit=<span class="literal">True</span></span>):</span></span><br><span class="line">        <span class="keyword">if</span> commit:</span><br><span class="line">            db.session.add(self)</span><br><span class="line">            db.session.commit()</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">self, commit=<span class="literal">True</span></span>):</span></span><br><span class="line">        <span class="keyword">if</span> commit:</span><br><span class="line">            db.session.delete(self)</span><br><span class="line">            <span class="keyword">return</span> db.session.commit()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">rollback</span>(<span class="params">self</span>):</span></span><br><span class="line">        db.session.rollback(self)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dump</span>(<span class="params">self, <span class="built_in">filter</span>=[]</span>):</span></span><br><span class="line">        d = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> self.__table__.columns:</span><br><span class="line">            value = <span class="built_in">getattr</span>(self, c.name, <span class="literal">None</span>)</span><br><span class="line">            <span class="keyword">if</span> c.name <span class="keyword">in</span> <span class="built_in">filter</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(value, datetime.date):</span><br><span class="line">                d[c.name] = value.strftime(<span class="string">&#x27;%Y-%m-%d&#x27;</span>)</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(value, datetime.datetime):</span><br><span class="line">                d[c.name] = value.strftime(<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                d[c.name] = value</span><br><span class="line">        <span class="keyword">return</span> d</span><br></pre></td></tr></table></figure>



<h2 id="切换redis的时候报UnicodeDecodeError-错误"><a href="#切换redis的时候报UnicodeDecodeError-错误" class="headerlink" title="切换redis的时候报UnicodeDecodeError 错误"></a>切换redis的时候报UnicodeDecodeError 错误</h2><p>将原生的redis库改为使用flask_redis插件时 报UnicodeDecodeError  . 此时<strong>重启即可</strong></p>
<ul>
<li>有可能是redis中存在相关持久化文件，记住了前面的任务和配置信息，使得redis在进行get和set的时候出现混乱，造成错误</li>
<li>同理使用celery的时候也可能与此错误</li>
</ul>
<blockquote>
<p>如果还是不行 , 那就将</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cache_client = FlaskRedis(config_prefix=<span class="string">&quot;cache&quot;</span>, decode_responses=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>改为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cache_client = FlaskRedis(config_prefix=<span class="string">&quot;cache&quot;</span>)</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="解决updtae时的问题"><a href="#解决updtae时的问题" class="headerlink" title="解决updtae时的问题"></a>解决updtae时的问题</h2><ol>
<li>工号eid必须保持唯一(但是可以修改 , 也就是说必能和别人一样)</li>
<li>update的时候 , 要想修改eid,就必须检测<code>emp = Employee.query.filter(Employee.eid == eid).filter(Employee.id != id).first()</code>不存在 , </li>
<li>但是form里拿不到view里中的id , 这时就可以使用g</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># view.py</span></span><br><span class="line"><span class="meta">@emp_router.route(<span class="params"><span class="string">&#x27;/editEmp/&lt;int:id&gt;&#x27;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>, ]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">emp_edit</span>(<span class="params"><span class="built_in">id</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    员工编辑页</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    g.<span class="built_in">id</span> = <span class="built_in">id</span></span><br><span class="line">    emp = Employee.get_by_id(<span class="built_in">id</span>)</span><br><span class="line">    form = EmployeeEditForm(request.form, obj=emp)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">        emp.update(<span class="built_in">id</span>=<span class="built_in">id</span>, **form.dump())</span><br><span class="line">        flash(<span class="string">&quot;修改成功&quot;</span>, category=<span class="string">&quot;success&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;emp.emp_detail&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;emp/emp_edit.html&#x27;</span>, form=form, <span class="built_in">id</span>=<span class="built_in">id</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># form.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmployeeEditForm</span>(<span class="params">EmployeeForm, PhoneValidateMixin</span>):</span></span><br><span class="line">    submit = SubmitField(<span class="string">&#x27;修改&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_eid</span>(<span class="params">self, field</span>):</span></span><br><span class="line">        <span class="built_in">id</span> = g.<span class="built_in">id</span></span><br><span class="line">        eid = field.data</span><br><span class="line">        emp = Employee.query.<span class="built_in">filter</span>(Employee.eid == eid).<span class="built_in">filter</span>(Employee.<span class="built_in">id</span> != <span class="built_in">id</span>).first()</span><br><span class="line">        <span class="keyword">if</span> emp:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">&#x27;工号已存在&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="当if想着要嵌套的时候可以考虑例外"><a href="#当if想着要嵌套的时候可以考虑例外" class="headerlink" title="当if想着要嵌套的时候可以考虑例外"></a>当if想着要嵌套的时候可以考虑例外</h2><p>考虑例外 , 直接让他return , 其他的继续运行</p>
<h2 id="Serialize的优秀实践"><a href="#Serialize的优秀实践" class="headerlink" title="Serialize的优秀实践"></a>Serialize的优秀实践</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Serialize</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    __SERIAL_INCLUDE__ = ()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">serialize</span>(<span class="params">self</span>):</span></span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> self.__SERIAL_INCLUDE__:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">hasattr</span>(self, k):</span><br><span class="line">                result[k] = <span class="built_in">getattr</span>(self, k)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_property</span>(<span class="params">self, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> kwargs.items():</span><br><span class="line">            <span class="built_in">setattr</span>(self, k, v)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserUser</span>(<span class="params">db.Model, Serialize</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&quot;user_user&quot;</span></span><br><span class="line">    __bind_key__ = <span class="string">&quot;userdb&quot;</span></span><br><span class="line">    __SERIAL_INCLUDE__ = (<span class="string">&quot;user_id&quot;</span>, <span class="string">&quot;game_id&quot;</span>, <span class="string">&quot;package_id&quot;</span>,</span><br><span class="line">                          <span class="string">&quot;chl_id&quot;</span>, <span class="string">&quot;raw_user_id&quot;</span>,)</span><br><span class="line">    query_class = UserUserQuery</span><br><span class="line"></span><br><span class="line">    user_id = db.Column(db.String(<span class="number">60</span>), primary_key=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    game_id = db.Column(db.SmallInteger, nullable=<span class="literal">False</span>)</span><br><span class="line">    package_id = db.Column(db.Integer, nullable=<span class="literal">False</span>)</span><br><span class="line">    chl_id = db.Column(db.Integer, nullable=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    chl_user_id = db.Column(db.String(<span class="number">50</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    reg_time = db.Column(db.Integer, nullable=<span class="literal">False</span>)</span><br><span class="line">    reg_date = db.Column(db.Date, nullable=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update_or_add_user</span>(<span class="params">cls, data</span>):</span></span><br><span class="line">        insert_stmt = insert(cls).values(**data)</span><br><span class="line">        do_nothing_stmt = insert_stmt.on_conflict_do_nothing(index_elements=[cls.user_id])</span><br><span class="line">        db.session.execute(do_nothing_stmt)</span><br><span class="line">        db.session.commit()</span><br></pre></td></tr></table></figure>



<h2 id="Mixin类的常用设计总结"><a href="#Mixin类的常用设计总结" class="headerlink" title="Mixin类的常用设计总结"></a>Mixin类的常用设计总结</h2><p>所以 , 我们可以总结Mixin类的常用设计</p>
<ol>
<li>Mixin类不能用<code>__init__</code> , 配置写成类属性 . 如<code>__SERIAL_INCLUDE__</code></li>
<li>方法可以是类方法,也可以是实例方法</li>
<li>继承时,覆盖原先的类属性<code>__SERIAL_INCLUDE__</code></li>
</ol>
<h2 id="Sqlalchemy的remote-side"><a href="#Sqlalchemy的remote-side" class="headerlink" title="Sqlalchemy的remote_side"></a>Sqlalchemy的remote_side</h2><p><code>remote_side</code> : 表中的外键引用的是自身时,如Node类,如果想表示多对一的关系,那么就可以使用remote_side</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;node&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    parent_id = Column(Integer, ForeignKey(<span class="string">&#x27;node.id&#x27;</span>))</span><br><span class="line">    data = Column(String(<span class="number">50</span>))</span><br><span class="line">    parent = relationship(<span class="string">&quot;Node&quot;</span>, remote_side=[<span class="built_in">id</span>])</span><br></pre></td></tr></table></figure>

<p>如果是想建立一种双向的关系,那么还是结合backref:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&#x27;node&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    parent_id = Column(Integer, ForeignKey(<span class="string">&#x27;node.id&#x27;</span>))</span><br><span class="line">    data = Column(String(<span class="number">50</span>))</span><br><span class="line">    children = relationship(</span><br><span class="line">        <span class="string">&quot;Node&quot;</span>,</span><br><span class="line">                backref=backref(<span class="string">&#x27;parent&#x27;</span>, remote_side=[<span class="built_in">id</span>])</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<p>多级部门</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Department</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&quot;oa_department&quot;</span></span><br><span class="line"></span><br><span class="line">    dept_id = db.Column(db.Integer, autoincrement=<span class="literal">True</span>, primary_key=<span class="literal">True</span>, comment=<span class="string">&quot;部门id&quot;</span>)</span><br><span class="line">    dept_name = db.Column(db.VARCHAR(<span class="number">20</span>), nullable=<span class="literal">False</span>, comment=<span class="string">&quot;部门名称&quot;</span>)</span><br><span class="line">    dept_pid = db.Column(db.Integer, db.ForeignKey(dept_id, ondelete=<span class="string">&quot;SET NULL&quot;</span>), comment=<span class="string">&quot;上级部门id&quot;</span>)</span><br><span class="line">    children = db.relationship(<span class="string">&quot;Department&quot;</span>, backref=db.backref(<span class="string">&quot;parent&quot;</span>, remote_side=dept_id))</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hier_dept_down</span>(<span class="params">cls</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;部门取最后一层级，用于员工所属部门。&quot;&quot;&quot;</span></span><br><span class="line">        d = &#123;<span class="string">&quot;dept_list&quot;</span>: []&#125;</span><br><span class="line">        _pids = cls.query.with_entities(cls.dept_pid).<span class="built_in">all</span>()</span><br><span class="line">        pids = <span class="built_in">set</span>([pid[<span class="number">0</span>] <span class="keyword">for</span> pid <span class="keyword">in</span> _pids])</span><br><span class="line">        pids.remove(<span class="literal">None</span>)</span><br><span class="line">        depts = cls.query.<span class="built_in">filter</span>(~cls.dept_id.in_(pids)).<span class="built_in">all</span>()</span><br><span class="line">        <span class="keyword">for</span> dept <span class="keyword">in</span> depts:</span><br><span class="line">            d[<span class="string">&quot;dept_list&quot;</span>].append(dept.to_dict)</span><br><span class="line">        <span class="keyword">return</span> d</span><br></pre></td></tr></table></figure>

<p>上面的函数看着这张图想</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> dept_id | dept_name | dept_pid</span><br><span class="line">---------+-----------+----------</span><br><span class="line">       1 | 技术部    |</span><br><span class="line">       2 | 市场部    |</span><br><span class="line">       3 | 市场一部  |        2</span><br><span class="line">       4 | 人事部    |</span><br></pre></td></tr></table></figure>



<h2 id="db-create-all-是建表-不是建库"><a href="#db-create-all-是建表-不是建库" class="headerlink" title="db.create_all()是建表 , 不是建库"></a>db.create_all()是建表 , 不是建库</h2><p>所以我们必须要有一个库才能执行成功</p>
<h2 id="命令行登录psql"><a href="#命令行登录psql" class="headerlink" title="命令行登录psql"></a>命令行登录psql</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -h 172.16.35.179 -U username -d dbname</span><br></pre></td></tr></table></figure>

<ul>
<li>username为数据库用户名，</li>
<li>dbname为要连接的数据库名</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U postgres</span><br></pre></td></tr></table></figure>



<h2 id="pytest匹配部分函数"><a href="#pytest匹配部分函数" class="headerlink" title="pytest匹配部分函数"></a>pytest匹配部分函数</h2><p>运行所有名字中含有的<code>answer1</code>的方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pytest -k answer1</span><br></pre></td></tr></table></figure>

<ul>
<li><code>py.test -k method -v</code> : 将会运行所有的方法（四个）</li>
<li><code>py.test -k methods -v</code> : 不会运行任何的方法</li>
</ul>
<p>运行同一个<code>marked</code>的用例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">py.test -m case1</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pytest</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="keyword">return</span> x + <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@pytest.mark.case1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_file2_answer1</span>():</span></span><br><span class="line">    <span class="keyword">assert</span> func(<span class="number">4</span>) == <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@pytest.mark.case1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_file2_answer2</span>():</span></span><br><span class="line">    <span class="keyword">assert</span> func(<span class="number">6</span>) == <span class="number">5</span></span><br></pre></td></tr></table></figure>



<h2 id="pytest常用命令"><a href="#pytest常用命令" class="headerlink" title="pytest常用命令"></a>pytest常用命令</h2><table>
<thead>
<tr>
<th>命令行</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>pytest –fixtures</td>
<td>显示可用的内置函数</td>
</tr>
<tr>
<td>pytest –lf</td>
<td>运行上一次运行失败的用例</td>
</tr>
<tr>
<td>pytest -x | –exitfirst</td>
<td>第一次失败后停止</td>
</tr>
<tr>
<td>pytest –maxfail=2</td>
<td>第二（n）次失败后停止</td>
</tr>
<tr>
<td>pytest test_mod.py</td>
<td>运行单个文件中的用例</td>
</tr>
<tr>
<td>pytest testing/</td>
<td>运行文件夹下的用例</td>
</tr>
<tr>
<td>pytest test_mod.py::test_func</td>
<td>运行模块内特指的方法</td>
</tr>
<tr>
<td>pytest test_mod.py::TestClass::test_method</td>
<td>运行模块下类内特指的方法</td>
</tr>
<tr>
<td>pytest -m slow</td>
<td>运行所有被装饰器标记@pytest.mark.slow的用例</td>
</tr>
<tr>
<td>pytest -v pytest1.py</td>
<td>-v 用于显示每个测试函数的执行结果</td>
</tr>
<tr>
<td>pytest -s pytest1.py</td>
<td>-s 用于显示测试函数中print()函数输出</td>
</tr>
</tbody></table>
<h2 id="正则获取表格的最佳实践"><a href="#正则获取表格的最佳实践" class="headerlink" title="正则获取表格的最佳实践"></a>正则获取表格的最佳实践</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">x=<span class="string">&#x27;&#x27;&#x27;UID        PID  PPID  C STIME TTY          TIME CMD</span></span><br><span class="line"><span class="string">root         2     0  0 Nov30 ?        00:00:00 [kthreadd]</span></span><br><span class="line"><span class="string">root         3     2  0 Nov30 ?        00:00:14 [ksoftirqd/0]</span></span><br><span class="line"><span class="string">root         5     2  0 Nov30 ?        00:00:00 [kworker/0:0H]</span></span><br><span class="line"><span class="string">root         7     2  0 Nov30 ?        00:00:00 [migration/0]</span></span><br><span class="line"><span class="string">root         8     2  0 Nov30 ?        00:00:00 [rcu_bh]</span></span><br><span class="line"><span class="string">root         9     2  0 Nov30 ?        00:00:57 [rcu_sched]&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> re.split(<span class="string">r&#x27;\n&#x27;</span>,x):</span><br><span class="line">	res = re.split(<span class="string">r&#x27;\s\s+&#x27;</span>,line)</span><br><span class="line">	<span class="built_in">print</span>(res)</span><br><span class="line"><span class="comment"># [&#x27;UID&#x27;, &#x27;PID&#x27;, &#x27;PPID&#x27;, &#x27;C STIME TTY&#x27;, &#x27;TIME CMD&#x27;]</span></span><br><span class="line"><span class="comment"># [&#x27;root&#x27;, &#x27;2&#x27;, &#x27;0&#x27;, &#x27;0 Nov30 ?&#x27;, &#x27;00:00:00 [kthreadd]&#x27;]</span></span><br><span class="line"><span class="comment"># [&#x27;root&#x27;, &#x27;3&#x27;, &#x27;2&#x27;, &#x27;0 Nov30 ?&#x27;, &#x27;00:00:14 [ksoftirqd/0]&#x27;]</span></span><br><span class="line"><span class="comment"># [&#x27;root&#x27;, &#x27;5&#x27;, &#x27;2&#x27;, &#x27;0 Nov30 ?&#x27;, &#x27;00:00:00 [kworker/0:0H]&#x27;]</span></span><br><span class="line"><span class="comment"># [&#x27;root&#x27;, &#x27;7&#x27;, &#x27;2&#x27;, &#x27;0 Nov30 ?&#x27;, &#x27;00:00:00 [migration/0]&#x27;]</span></span><br><span class="line"><span class="comment"># [&#x27;root&#x27;, &#x27;8&#x27;, &#x27;2&#x27;, &#x27;0 Nov30 ?&#x27;, &#x27;00:00:00 [rcu_bh]&#x27;]</span></span><br><span class="line"><span class="comment"># [&#x27;root&#x27;, &#x27;9&#x27;, &#x27;2&#x27;, &#x27;0 Nov30 ?&#x27;, &#x27;00:00:57 [rcu_sched]&#x27;]</span></span><br></pre></td></tr></table></figure>

<ol>
<li>先使用<code>\n</code>分行</li>
<li>再使用<code>\s\s+</code>分列</li>
</ol>
<h2 id="re-findall"><a href="#re-findall" class="headerlink" title="re.findall"></a>re.findall</h2><p>注意 : re.findall本质就是非贪婪匹配</p>
<blockquote>
<p>match 和 search 方法都是一次匹配，<strong>只要找到了一个匹配的结果就返回</strong></p>
</blockquote>
<h2 id="boostrap响应click事件"><a href="#boostrap响应click事件" class="headerlink" title="boostrap响应click事件"></a>boostrap响应click事件</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">&#x27;#dataTable tbody&#x27;</span>).on(<span class="string">&#x27;click&#x27;</span>, <span class="string">&#x27;button[action=&quot;UpdateUser&quot;]&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    $(<span class="string">&#x27;#update-user&#x27;</span>).modal(<span class="string">&#x27;show&#x27;</span>);</span><br></pre></td></tr></table></figure>



<h2 id="其实不需要使用debugtool-直接在network里查看返回值"><a href="#其实不需要使用debugtool-直接在network里查看返回值" class="headerlink" title="其实不需要使用debugtool , 直接在network里查看返回值"></a>其实不需要使用debugtool , 直接在network里查看返回值</h2><h2 id="注意jquery的trigger函数-直接触发某个事件"><a href="#注意jquery的trigger函数-直接触发某个事件" class="headerlink" title="注意jquery的trigger函数 , 直接触发某个事件"></a>注意jquery的trigger函数 , 直接触发某个事件</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;username&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;触发text的focus&quot;</span> <span class="attr">id</span>=<span class="string">&quot;btn1&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/jquery/3.4.1/jquery.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">    $(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        $(<span class="string">&quot;#username&quot;</span>).focus(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">&quot;text focus 被触发了&quot;</span>)</span></span><br><span class="line"><span class="javascript">        &#125;)</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">        $(<span class="string">&quot;#bn1&quot;</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">&#x27;1111&#x27;</span>);</span></span><br><span class="line"><span class="javascript">            <span class="comment">// 触发text的focus</span></span></span><br><span class="line"><span class="javascript">            $(<span class="string">&quot;#username&quot;</span>).trigger(<span class="string">&quot;focus&quot;</span>);</span></span><br><span class="line"><span class="javascript">        &#125;)</span></span><br><span class="line"><span class="javascript">    &#125;)</span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>trigger : 根据绑定到匹配元素的给定的事件类型执行所有的处理程序和行为。</p>
</blockquote>
<ul>
<li>trigger : 触发事件 , 但是会执行类似浏览将光标移到输入框内的这种浏览器默认行为</li>
<li>triggerHandler : 仅仅只会触发事件所对应的函数</li>
</ul>
<blockquote>
<p>trigger 经常用于处理相同逻辑的时候 :<br>例如监控密码框必须长度大于6 , 监控的时候有键入 , 失去焦点 , 那么我们只需要做一个逻辑给失去焦点 , 对键入的判断逻辑 我们只要使用trigger就好了</p>
</blockquote>
<h2 id="在前端自己写一个flash"><a href="#在前端自己写一个flash" class="headerlink" title="在前端自己写一个flash"></a>在前端自己写一个flash</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flash</span>(<span class="params">msg, category</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> alert = <span class="string">&#x27;&lt;div class=&quot;alert alert-&#x27;</span> + category + <span class="string">&#x27; alert-dismissible&quot; role=&quot;alert&quot;&gt;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&lt;button class=&quot;close&quot; aria-label=&quot;Close&quot; type=&quot;button&quot; data-dismiss=&quot;alert&quot;&gt;&lt;span aria-hidden=&quot;true&quot;&gt;×&lt;/span&gt;&lt;/button&gt;&#x27;</span> +</span><br><span class="line">                msg +</span><br><span class="line">              <span class="string">&#x27;&lt;/div&gt;&#x27;</span>;</span><br><span class="line">  $(<span class="string">&quot;section.content&quot;</span>).prepend(alert);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="模态框的显示与消失"><a href="#模态框的显示与消失" class="headerlink" title="模态框的显示与消失"></a>模态框的显示与消失</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">&quot;#ban-modal&quot;</span>).modal();</span><br><span class="line">$(<span class="string">&quot;#ban-modal&quot;</span>).modal(<span class="string">&quot;hide&quot;</span>);</span><br></pre></td></tr></table></figure>



<h2 id="对于像前端不能设置传递变量的问题"><a href="#对于像前端不能设置传递变量的问题" class="headerlink" title="对于像前端不能设置传递变量的问题"></a>对于像前端不能设置传递变量的问题</h2><p>我们可以将两个事件(如<code>click</code>事件)设置成函数 , 然后只要trigger并且传值就可以了</p>
<h2 id="对于wtform"><a href="#对于wtform" class="headerlink" title="对于wtform"></a>对于wtform</h2><p>我们可以使用<code>form.errors</code>获取全部的验证错误</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@emp_router.route(<span class="params"><span class="string">&#x27;/addEmp/&#x27;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>, ]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">emp_add</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    员工添加页</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    form = EmployeeAddForm(request.form)</span><br><span class="line">    <span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">        Employee.create(**form.dump())</span><br><span class="line">        flash(<span class="string">&quot;添加成功&quot;</span>, category=<span class="string">&quot;success&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;emp.emp_detail&quot;</span>))</span><br><span class="line">    <span class="built_in">print</span>(form.errors)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;emp/emp_add.html&#x27;</span>, form=form)</span><br></pre></td></tr></table></figure>



<h2 id="提示框的简单实用"><a href="#提示框的简单实用" class="headerlink" title="提示框的简单实用"></a>提示框的简单实用</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=&quot;&#123;&#123; url_for(&#x27;static&#x27;, filename=&#x27;js/toastr.min.js&#x27;) &#125;&#125;&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;link href=&quot;&#123;&#123; url_for(&#x27;static&#x27;, filename=&#x27;css/toastr.min.css&#x27;) &#125;&#125;&quot; rel=&quot;stylesheet&quot;/&gt;</span><br><span class="line"></span><br><span class="line">&#123;# 初始化信息提示框 #&#125;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">    toastr.options.positionClass = &#x27;toast-top-right&#x27;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>触发</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">toastr.success(<span class="string">&#x27;提交数据成功&#x27;</span>);</span><br><span class="line">toastr.error(<span class="string">&#x27;提交数据成功&#x27;</span>);</span><br></pre></td></tr></table></figure>



<h2 id="使用boostrap的图标"><a href="#使用boostrap的图标" class="headerlink" title="使用boostrap的图标"></a>使用boostrap的图标</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-info btn-lg&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;glyphicon glyphicon-asterisk&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span> Asterisk</span><br><span class="line"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-default btn-sm&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;glyphicon glyphicon-asterisk&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span> Asterisk</span><br><span class="line"><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="marshmallow验证"><a href="#marshmallow验证" class="headerlink" title="marshmallow验证"></a>marshmallow验证</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> marshmallow <span class="keyword">import</span> fields, Schema, validates, ValidationError</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ItemSchema</span>(<span class="params">Schema</span>):</span></span><br><span class="line">    quantity = fields.Integer()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @validates(<span class="params"><span class="string">&#x27;quantity&#x27;</span></span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_quantity</span>(<span class="params">self, value</span>):</span></span><br><span class="line">        <span class="keyword">if</span> value &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">&#x27;Quantity must be greater than 0.&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> value &gt; <span class="number">30</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">&#x27;Quantity must not be greater than 30.&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>如果将<code>strict=True</code>传入<code>Schema</code>构造器或者<code>class</code>的<code>Meta</code>参数里，则仅会在传入无效数据是报错。可以使用<code>ValidationError.messages</code>变量来获取验证错误的<code>dictionary</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSchema</span>(<span class="params">Schema</span>):</span></span><br><span class="line">    name = fields.Str()</span><br><span class="line">    email = fields.Email()</span><br><span class="line">    created_at = fields.DateTime()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @post_load</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">make_user</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="keyword">return</span> User(**data)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">name, email, created_at</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.email = email</span><br><span class="line">        self.created_at = created_at</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> webargs <span class="keyword">import</span> fields</span><br><span class="line"><span class="keyword">from</span> webargs.flaskparser <span class="keyword">import</span> parser</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    argmap = &#123;<span class="string">&quot;age&quot;</span>: fields.Int(), <span class="string">&quot;years_employed&quot;</span>: fields.Int()&#125;</span><br><span class="line">    result = parser.parse(</span><br><span class="line">        argmap,</span><br><span class="line">        <span class="comment"># 配置全局验证，返回 False 或抛出 ValidationError 异常表示验证失败</span></span><br><span class="line">        validate=<span class="keyword">lambda</span> args: args[<span class="string">&quot;years_employed&quot;</span>] &lt; args[<span class="string">&quot;age&quot;</span>]</span><br><span class="line">    )</span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># app.run()</span></span><br><span class="line">    <span class="keyword">with</span> app.test_client() <span class="keyword">as</span> client:</span><br><span class="line">        response = client.get(<span class="string">&#x27;/?age=1&amp;years_employed=2&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(response)  <span class="comment"># &lt;Response streamed [422 UNPROCESSABLE ENTITY]&gt;</span></span><br><span class="line">        <span class="keyword">assert</span> response.status_code == <span class="number">422</span></span><br><span class="line"></span><br><span class="line">        response2 = client.get(<span class="string">&#x27;/?age=2&amp;years_employed=1&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(response2)  <span class="comment"># &lt;Response streamed [200 OK]&gt;</span></span><br><span class="line">        <span class="keyword">assert</span> response2.status_code == <span class="number">200</span></span><br></pre></td></tr></table></figure>



<h2 id="序列化与反序列化"><a href="#序列化与反序列化" class="headerlink" title="序列化与反序列化"></a>序列化与反序列化</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReportSchema</span>(<span class="params">ma.Schema</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;Report数据Schema&#x27;&#x27;&#x27;</span></span><br><span class="line">    page = fields.Integer(allow_none=<span class="literal">True</span>, missing=<span class="number">1</span>)</span><br><span class="line">    pn = fields.Integer(allow_none=<span class="literal">True</span>, missing=<span class="number">10</span>)</span><br><span class="line">    filtertime = fields.String(allow_none=<span class="literal">True</span>)</span><br><span class="line">    emp = fields.String(allow_none=<span class="literal">True</span>)</span><br><span class="line">    app = fields.String(allow_none=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    begin_time = fields.Method(<span class="string">&#x27;get_begin_time&#x27;</span>,deserialize=<span class="string">&#x27;load_begin_time&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_begin_time</span>(<span class="params">self,obj</span>):</span></span><br><span class="line">        <span class="keyword">return</span> obj.filtertime</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">load_begin_time</span>(<span class="params">self,obj</span>):</span></span><br><span class="line">        <span class="keyword">return</span> obj.value</span><br></pre></td></tr></table></figure>

<ul>
<li>get_begin_time功能就是 , dump到外面的时候多生成一个begin_time字段</li>
<li>load_begin_time功能就是 , 从外面load进来的时候就begin_time字段的进行修改(也就是说, 外面传进来的时候就有了begin_time这个字段 , 我们只是修改它的值而已)</li>
</ul>
<h2 id="falsk使用join"><a href="#falsk使用join" class="headerlink" title="falsk使用join"></a>falsk使用join</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">query = db.session.query(</span><br><span class="line">    ReportPersonConsumeTsf, ReportSummaryConsumeTsf,</span><br><span class="line">    ReportProfitDaily, ReportSummaryProfit</span><br><span class="line">).<span class="built_in">filter</span>(</span><br><span class="line">    ReportProfitDaily.report_date == ReportPersonConsumeTsf.report_date</span><br><span class="line">).<span class="built_in">filter</span>(</span><br><span class="line">    ReportProfitDaily.report_date == ReportSummaryConsumeTsf.report_date</span><br><span class="line">).<span class="built_in">filter</span>(</span><br><span class="line">    ReportProfitDaily.report_date == ReportSummaryProfit.report_date</span><br><span class="line">).<span class="built_in">filter</span>(</span><br><span class="line">    ReportProfitDaily.app_id == ReportPersonConsumeTsf.app_id</span><br><span class="line">).<span class="built_in">filter</span>(</span><br><span class="line">    ReportProfitDaily.app_id == ReportSummaryConsumeTsf.app_id</span><br><span class="line">).<span class="built_in">filter</span>(</span><br><span class="line">    ReportProfitDaily.app_id == ReportSummaryProfit.app_id</span><br><span class="line">).order_by(ReportPersonConsumeTsf.report_date.desc())</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.session.query(ReportProfitDaily, ReportSummaryConsumeTsf).join(</span><br><span class="line">    ReportSummaryConsumeTsf,ReportSummaryConsumeTsf.app_id==ReportProfitDaily.app_id,</span><br><span class="line">        ).<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">x = db.session.query(ReportProfitDaily, ReportSummaryConsumeTsf).join(</span><br><span class="line">            ReportSummaryConsumeTsf,</span><br><span class="line">            and_(</span><br><span class="line">                ReportSummaryConsumeTsf.app_id == ReportProfitDaily.app_id,</span><br><span class="line">                ReportSummaryConsumeTsf.report_date == ReportProfitDaily.report_date</span><br><span class="line">            )</span><br><span class="line">        ).<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure>



<h2 id="group-by-和-join一起使用"><a href="#group-by-和-join一起使用" class="headerlink" title="group_by 和 join一起使用"></a>group_by 和 join一起使用</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> （<span class="keyword">select</span> <span class="built_in">sum</span>(qty) <span class="keyword">from</span> a1 <span class="keyword">group</span> <span class="keyword">by</span> a1.name） <span class="keyword">as</span> A</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">Join</span> (<span class="keyword">select</span> <span class="built_in">sum</span>(qty) <span class="keyword">from</span> b1 <span class="keyword">group</span> <span class="keyword">by</span> b1.name) <span class="keyword">as</span> B</span><br><span class="line"><span class="keyword">on</span> A.id<span class="operator">=</span>B.id</span><br></pre></td></tr></table></figure>



<h2 id="flask-query"><a href="#flask-query" class="headerlink" title="flask-query"></a>flask-query</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">query = (session</span><br><span class="line">         .query(User)</span><br><span class="line">         .<span class="built_in">filter</span>(User.username == <span class="string">&quot;asd&quot;</span>)</span><br><span class="line">         .filter_by(username=<span class="string">&quot;asd&quot;</span>)</span><br><span class="line">         <span class="comment">#上面两个都是添加where</span></span><br><span class="line">         .join(Addreess)<span class="comment">#使用ForeignKey</span></span><br><span class="line">         .join(Addreess,Addreess.user_id==User.<span class="built_in">id</span>)<span class="comment">#使用显式声明</span></span><br><span class="line">         .limit(<span class="number">10</span>)</span><br><span class="line">         .offset(<span class="number">0</span>)</span><br><span class="line">         )</span><br></pre></td></tr></table></figure>



<h2 id="常用WTF"><a href="#常用WTF" class="headerlink" title="常用WTF"></a>常用WTF</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line">&#123;% macro form_errors(form, hiddens=True) %&#125;</span><br><span class="line">	&#123;%- if form.errors %&#125;</span><br><span class="line">		&#123;%- for fieldname, errors in form.errors.items() %&#125;</span><br><span class="line">			&#123;%- if is_hidden_wtf_field(form[fieldname]) and hiddens or</span><br><span class="line">             not is_hidden_wtf_field(form[fieldname]) and hiddens != &#x27;only&#x27; %&#125;</span><br><span class="line">				&#123;%- for error in errors %&#125;</span><br><span class="line">					&lt;div class=&quot;invalid-feedback&quot;&gt;&#123;&#123; error &#125;&#125;&lt;/div&gt;</span><br><span class="line">				&#123;%- endfor %&#125;</span><br><span class="line">			&#123;%- endif %&#125;</span><br><span class="line">		&#123;%- endfor %&#125;</span><br><span class="line">	&#123;%- endif %&#125;</span><br><span class="line">&#123;%- endmacro %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% macro _hz_form_wrap(horizontal_columns, form_type, add_group=False, required=False) %&#125;</span><br><span class="line">	&#123;% if form_type == &quot;horizontal&quot; %&#125;</span><br><span class="line">		&#123;% if add_group %&#125;</span><br><span class="line">			&lt;div class=&quot;form-group row&#123;% if required %&#125; required&#123;% endif %&#125;&quot;&gt;&#123;% endif %&#125;</span><br><span class="line">		&lt;div class=&quot;offset-&#123;&#123; horizontal_columns[0] &#125;&#125;-&#123;&#123; horizontal_columns[1] &#125;&#125;</span><br><span class="line">              col-&#123;&#123; horizontal_columns[0] &#125;&#125;-&#123;&#123; horizontal_columns[2] &#125;&#125;</span><br><span class="line">             &quot;&gt;</span><br><span class="line">	&#123;% endif %&#125;</span><br><span class="line">&#123;&#123; caller() &#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;% if form_type == &quot;horizontal&quot; %&#125;</span><br><span class="line">	&#123;% if add_group %&#125;&lt;/div&gt;&#123;% endif %&#125;</span><br><span class="line">	&lt;/div&gt;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&#123;% endmacro %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% macro form_field(field,</span><br><span class="line">                    form_type=&quot;basic&quot;,</span><br><span class="line">                    horizontal_columns=(&#x27;lg&#x27;, 2, 10),</span><br><span class="line">                    button_map=&#123;&#125;) %&#125;</span><br><span class="line"></span><br><span class="line">	&#123;# this is a workaround hack for the more straightforward-code of just passing required=required parameter. older versions of wtforms do not have</span><br><span class="line">the necessary fix for required=False attributes, but will also not set the required flag in the first place. we skirt the issue using the code below #&#125;</span><br><span class="line">	&#123;% if field.flags.required and not required in kwargs %&#125;</span><br><span class="line">		&#123;% set kwargs = dict(required=True, **kwargs) %&#125;</span><br><span class="line">	&#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">	&#123;% if field.widget.input_type == &#x27;checkbox&#x27; %&#125;</span><br><span class="line">		&#123;% call _hz_form_wrap(horizontal_columns, form_type, True, required=required) %&#125;</span><br><span class="line">			&lt;div class=&quot;form-check&#123;% if form_type == &quot;inline&quot; %&#125; form-check-inline&#123;% endif %&#125;&quot;&gt;</span><br><span class="line">				&lt;label class=&quot;form-check-label&quot;&gt;</span><br><span class="line">					&#123;&#123; field(class_=&quot;form-check-input&quot;)|safe &#125;&#125; &#123;&#123; field.label.text|safe &#125;&#125;</span><br><span class="line">				&lt;/label&gt;</span><br><span class="line">			&lt;/div&gt;</span><br><span class="line">		&#123;% endcall %&#125;</span><br><span class="line">	&#123;%- elif field.type == &#x27;RadioField&#x27; -%&#125;</span><br><span class="line">		&#123;# note: A cleaner solution would be rendering depending on the widget,</span><br><span class="line">     this is just a hack for now, until I can think of something better #&#125;</span><br><span class="line">		&#123;% call _hz_form_wrap(horizontal_columns, form_type, True, required=required) %&#125;</span><br><span class="line">			&#123;% for item in field -%&#125;</span><br><span class="line">				&lt;div class=&quot;form-check&#123;% if form_type == &quot;inline&quot; %&#125; form-check-inline&#123;% endif %&#125;&quot;&gt;</span><br><span class="line">					&lt;label class=&quot;form-check-label&quot;&gt;</span><br><span class="line">						&#123;&#123; item(class_=&quot;form-check-input&quot;)|safe &#125;&#125; &#123;&#123; item.label.text|safe &#125;&#125;</span><br><span class="line">					&lt;/label&gt;</span><br><span class="line">				&lt;/div&gt;</span><br><span class="line">			&#123;% endfor %&#125;</span><br><span class="line">		&#123;% endcall %&#125;</span><br><span class="line">	&#123;%- elif field.type == &#x27;SubmitField&#x27; -%&#125;</span><br><span class="line">		&#123;# deal with jinja scoping issues? #&#125;</span><br><span class="line">		&#123;% set field_kwargs = kwargs %&#125;</span><br><span class="line"></span><br><span class="line">		&#123;# note: same issue as above - should check widget, not field type #&#125;</span><br><span class="line">		&#123;% call _hz_form_wrap(horizontal_columns, form_type, True, required=required) %&#125;</span><br><span class="line">			&#123;&#123; field(class=&#x27;btn btn-%s&#x27; % button_map.get(field.name, &#x27;primary&#x27;),</span><br><span class="line">            **field_kwargs) &#125;&#125;</span><br><span class="line">		&#123;% endcall %&#125;</span><br><span class="line">	&#123;%- elif field.type == &#x27;FormField&#x27; -%&#125;</span><br><span class="line">		&#123;# note: FormFields are tricky to get right and complex setups requiring</span><br><span class="line">   these are probably beyond the scope of what this macro tries to do.</span><br><span class="line">   the code below ensures that things don&#x27;t break horribly if we run into</span><br><span class="line">   one, but does not try too hard to get things pretty. #&#125;</span><br><span class="line">		&lt;fieldset&gt;</span><br><span class="line">			&lt;legend&gt;&#123;&#123; field.label &#125;&#125;&lt;/legend&gt;</span><br><span class="line">			&#123;%- for subfield in field %&#125;</span><br><span class="line">				&#123;% if not is_hidden_wtf_field(subfield) -%&#125;</span><br><span class="line">					&#123;&#123; form_field(subfield,</span><br><span class="line">                      form_type=form_type,</span><br><span class="line">                      horizontal_columns=horizontal_columns,</span><br><span class="line">                      button_map=button_map) &#125;&#125;</span><br><span class="line">				&#123;%- endif %&#125;</span><br><span class="line">			&#123;%- endfor %&#125;</span><br><span class="line">		&lt;/fieldset&gt;</span><br><span class="line">	&#123;% else -%&#125;</span><br><span class="line">		&#123;# Note: Bootstrap 4 no longer supports has-danger. Flask-Bootstrap4 has an issue. #&#125;</span><br><span class="line">		&lt;div class=&quot;form-group &#123;%- if form_type == &quot;horizontal&quot; %&#125; row&#123;% endif -%&#125;</span><br><span class="line">                         &#123;%- if field.flags.required %&#125; required&#123;% endif -%&#125;</span><br><span class="line">  &quot;&gt;</span><br><span class="line">			&#123;%- if form_type == &quot;inline&quot; %&#125;</span><br><span class="line">				&#123;&#123; field.label(class=&quot;sr-only&quot;)|safe &#125;&#125;</span><br><span class="line">				&#123;% if field.type == &#x27;FileField&#x27; %&#125;</span><br><span class="line">					&#123;&#123; field(class=&quot;form-control-file&quot;, **kwargs)|safe &#125;&#125;</span><br><span class="line">				&#123;% else %&#125;</span><br><span class="line">					&#123;&#123; field(class=&quot;form-control mb-2 mr-sm-2 mb-sm-0&quot; + (&quot; is-invalid&quot; if field.errors else &quot;&quot;), **kwargs)|safe &#125;&#125;</span><br><span class="line">				&#123;% endif %&#125;</span><br><span class="line">			&#123;% elif form_type == &quot;horizontal&quot; %&#125;</span><br><span class="line">				&#123;&#123; field.label(class=&quot;form-control-label &quot; + (</span><br><span class="line">          &quot; col-%s-%s&quot; % horizontal_columns[0:2]</span><br><span class="line">        ))|safe &#125;&#125;</span><br><span class="line">				&lt;div class=&quot; col-&#123;&#123; horizontal_columns[0] &#125;&#125;-&#123;&#123; horizontal_columns[2] &#125;&#125;&quot;&gt;</span><br><span class="line">					&#123;% if field.type == &#x27;FileField&#x27; %&#125;</span><br><span class="line">						&#123;&#123; field(class=&quot;form-control-file&quot;, **kwargs)|safe &#125;&#125;</span><br><span class="line">					&#123;% else %&#125;</span><br><span class="line">						&#123;&#123; field(class=&quot;form-control&quot; + (&quot; is-invalid&quot; if field.errors else &quot;&quot;), **kwargs)|safe &#125;&#125;</span><br><span class="line">					&#123;% endif %&#125;</span><br><span class="line">				&lt;/div&gt;</span><br><span class="line">				&#123;%- if field.errors %&#125;</span><br><span class="line">					&#123;%- for error in field.errors %&#125;</span><br><span class="line">						&#123;% call _hz_form_wrap(horizontal_columns, form_type, required=required) %&#125;</span><br><span class="line">							&lt;div class=&quot;invalid-feedback&quot;&gt;&#123;&#123; error &#125;&#125;&lt;/div&gt;</span><br><span class="line">						&#123;% endcall %&#125;</span><br><span class="line">					&#123;%- endfor %&#125;</span><br><span class="line">				&#123;%- elif field.description -%&#125;</span><br><span class="line">					&#123;% call _hz_form_wrap(horizontal_columns, form_type, required=required) %&#125;</span><br><span class="line">						&lt;small class=&quot;form-text text-muted&quot;&gt;&#123;&#123; field.description|safe &#125;&#125;&lt;/small&gt;</span><br><span class="line">					&#123;% endcall %&#125;</span><br><span class="line">				&#123;%- endif %&#125;</span><br><span class="line">			&#123;%- else -%&#125;</span><br><span class="line">				&#123;&#123; field.label(class=&quot;form-control-label&quot;)|safe &#125;&#125;</span><br><span class="line">				&#123;% if field.type == &#x27;FileField&#x27; %&#125;</span><br><span class="line">					&#123;&#123; field(class=&quot;form-control-file&quot;, **kwargs)|safe &#125;&#125;</span><br><span class="line">				&#123;% else %&#125;</span><br><span class="line">					&#123;&#123; field(class=&quot;form-control&quot; + (&quot; is-invalid&quot; if field.errors else &quot;&quot;), **kwargs)|safe &#125;&#125;</span><br><span class="line">				&#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">				&#123;%- if field.errors %&#125;</span><br><span class="line">					&#123;%- for error in field.errors %&#125;</span><br><span class="line">						&lt;div class=&quot;invalid-feedback&quot;&gt;&#123;&#123; error &#125;&#125;&lt;/div&gt;</span><br><span class="line">					&#123;%- endfor %&#125;</span><br><span class="line">				&#123;%- elif field.description -%&#125;</span><br><span class="line">					&lt;small class=&quot;form-text text-muted&quot;&gt;&#123;&#123; field.description|safe &#125;&#125;&lt;/small&gt;</span><br><span class="line">				&#123;%- endif %&#125;</span><br><span class="line">			&#123;%- endif %&#125;</span><br><span class="line">		&lt;/div&gt;</span><br><span class="line">	&#123;% endif %&#125;</span><br><span class="line">&#123;% endmacro %&#125;</span><br><span class="line"></span><br><span class="line">&#123;# valid form types are &quot;basic&quot;, &quot;inline&quot; and &quot;horizontal&quot; #&#125;</span><br><span class="line">&#123;% macro quick_form(form,</span><br><span class="line">                    action=&quot;&quot;,</span><br><span class="line">                    method=&quot;post&quot;,</span><br><span class="line">                    extra_classes=None,</span><br><span class="line">                    role=&quot;form&quot;,</span><br><span class="line">                    form_type=&quot;basic&quot;,</span><br><span class="line">                    horizontal_columns=(&#x27;lg&#x27;, 2, 10),</span><br><span class="line">                    enctype=None,</span><br><span class="line">                    button_map=&#123;&#125;,</span><br><span class="line">                    id=&quot;&quot;,</span><br><span class="line">                    novalidate=False,</span><br><span class="line">                    render_kw=&#123;&#125;) %&#125;</span><br><span class="line">	&#123;#-</span><br><span class="line">action=&quot;&quot; is what we want, from http://www.ietf.org/rfc/rfc2396.txt:</span><br><span class="line"></span><br><span class="line">4.2. Same-document References</span><br><span class="line"></span><br><span class="line">   A URI reference that does not contain a URI is a reference to the</span><br><span class="line">   current document.  In other words, an empty URI reference within a</span><br><span class="line">   document is interpreted as a reference to the start of that document,</span><br><span class="line">   and a reference containing only a fragment identifier is a reference</span><br><span class="line">   to the identified fragment of that document.  Traversal of such a</span><br><span class="line">   reference should not result in an additional retrieval action.</span><br><span class="line">   However, if the URI reference occurs in a context that is always</span><br><span class="line">   intended to result in a new request, as in the case of HTML&#x27;s FORM</span><br><span class="line">   element, then an empty URI reference represents the base URI of the</span><br><span class="line">   current document and should be replaced by that URI when transformed</span><br><span class="line">   into a request.</span><br><span class="line"></span><br><span class="line"> -#&#125;</span><br><span class="line">	&#123;#- if any file fields are inside the form and enctype is automatic, adjust</span><br><span class="line">    if file fields are found. could really use the equalto test of jinja2</span><br><span class="line">    here, but latter is not available until 2.8</span><br><span class="line"></span><br><span class="line">    warning: the code below is guaranteed to make you cry =(</span><br><span class="line">#&#125;</span><br><span class="line">	&#123;%- set _enctype = [] %&#125;</span><br><span class="line">	&#123;%- if enctype is none -%&#125;</span><br><span class="line">		&#123;%- for field in form %&#125;</span><br><span class="line">			&#123;%- if field.type == &#x27;FileField&#x27; %&#125;</span><br><span class="line">				&#123;#- for loops come with a fairly watertight scope, so this list-hack is</span><br><span class="line">          used to be able to set values outside of it #&#125;</span><br><span class="line">				&#123;%- set _ = _enctype.append(&#x27;multipart/form-data&#x27;) -%&#125;</span><br><span class="line">			&#123;%- endif %&#125;</span><br><span class="line">		&#123;%- endfor %&#125;</span><br><span class="line">	&#123;%- else %&#125;</span><br><span class="line">		&#123;% set _ = _enctype.append(enctype) %&#125;</span><br><span class="line">	&#123;%- endif %&#125;</span><br><span class="line">	&lt;form</span><br><span class="line">		&#123;%- if action != None %&#125; action=&quot;&#123;&#123; action &#125;&#125;&quot;&#123;% endif -%&#125;</span><br><span class="line">		&#123;%- if id %&#125; id=&quot;&#123;&#123; id &#125;&#125;&quot;&#123;% endif -%&#125;</span><br><span class="line">		&#123;%- if method %&#125; method=&quot;&#123;&#123; method &#125;&#125;&quot;&#123;% endif %&#125;</span><br><span class="line">		                         class=&quot;form</span><br><span class="line">    &#123;%- if extra_classes %&#125; &#123;&#123; extra_classes &#125;&#125;&#123;% endif -%&#125;</span><br><span class="line">    &#123;%- if form_type == &quot;inline&quot; %&#125; form-inline&#123;% endif -%&#125;</span><br><span class="line">  &quot;</span><br><span class="line">		&#123;%- if _enctype[0] %&#125; enctype=&quot;&#123;&#123; _enctype[0] &#125;&#125;&quot;&#123;% endif -%&#125;</span><br><span class="line">		&#123;%- if role %&#125; role=&quot;&#123;&#123; role &#125;&#125;&quot;&#123;% endif -%&#125;</span><br><span class="line">		&#123;%- if novalidate %&#125; novalidate&#123;% endif -%&#125;</span><br><span class="line">		&#123;%- if render_kw %&#125; &#123;&#123; render_kw|xmlattr &#125;&#125;&#123;% endif -%&#125;</span><br><span class="line">	&gt;</span><br><span class="line">		&#123;&#123; form.hidden_tag() &#125;&#125;</span><br><span class="line">		&#123;&#123; form_errors(form, hiddens=&#x27;only&#x27;) &#125;&#125;</span><br><span class="line"></span><br><span class="line">		&#123;%- for field in form %&#125;</span><br><span class="line">			&#123;% if not is_hidden_wtf_field(field) -%&#125;</span><br><span class="line">				&#123;&#123; form_field(field,</span><br><span class="line">                    form_type=form_type,</span><br><span class="line">                    horizontal_columns=horizontal_columns,</span><br><span class="line">                    button_map=button_map) &#125;&#125;</span><br><span class="line">			&#123;%- endif %&#125;</span><br><span class="line">		&#123;%- endfor %&#125;</span><br><span class="line"></span><br><span class="line">	&lt;/form&gt;</span><br><span class="line">&#123;%- endmacro %&#125;</span><br></pre></td></tr></table></figure>



<h2 id="常用Modal"><a href="#常用Modal" class="headerlink" title="常用Modal"></a>常用Modal</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&#123;% macro modal(id, title, form, action) %&#125;</span><br><span class="line">	&lt;div class=&quot;modal fade&quot; id=&quot;&#123;&#123; id &#125;&#125;&quot; style=&quot;display: none;&quot;</span><br><span class="line">	     aria-hidden=&quot;true&quot;&gt;</span><br><span class="line">		&lt;div class=&quot;modal-dialog&quot;&gt;</span><br><span class="line">			&lt;div class=&quot;modal-content&quot;&gt;</span><br><span class="line">				&lt;div class=&quot;modal-header&quot;&gt;</span><br><span class="line">					&lt;h4 class=&quot;modal-title&quot;&gt;&#123;&#123; title &#125;&#125;&lt;/h4&gt;</span><br><span class="line">					&lt;button type=&quot;button&quot; class=&quot;close&quot; data-dismiss=&quot;modal&quot; aria-label=&quot;Close&quot;&gt;</span><br><span class="line">						&lt;span aria-hidden=&quot;true&quot;&gt;×&lt;/span&gt;</span><br><span class="line">					&lt;/button&gt;</span><br><span class="line">				&lt;/div&gt;</span><br><span class="line">				&lt;div class=&quot;modal-body&quot;&gt;</span><br><span class="line">					&#123;&#123; wtf.quick_form(form, action=action) &#125;&#125;</span><br><span class="line">				&lt;/div&gt;</span><br><span class="line">			&lt;/div&gt;</span><br><span class="line">			&lt;!-- /.modal-content --&gt;</span><br><span class="line">		&lt;/div&gt;</span><br><span class="line">		&lt;!-- /.modal-dialog --&gt;</span><br><span class="line">	&lt;/div&gt;</span><br><span class="line">&#123;% endmacro %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% macro modal_ajax(id, title, form, btn) %&#125;</span><br><span class="line">	&lt;div class=&quot;modal fade&quot; id=&quot;&#123;&#123; id &#125;&#125;&quot; style=&quot;display: none;&quot;</span><br><span class="line">	     aria-hidden=&quot;true&quot;&gt;</span><br><span class="line">		&lt;div class=&quot;modal-dialog&quot;&gt;</span><br><span class="line">			&lt;div class=&quot;modal-content&quot;&gt;</span><br><span class="line">				&lt;div class=&quot;modal-header&quot;&gt;</span><br><span class="line">					&lt;h4 class=&quot;modal-title&quot;&gt;&#123;&#123; title &#125;&#125;&lt;/h4&gt;</span><br><span class="line">					&lt;button type=&quot;button&quot; class=&quot;close&quot; data-dismiss=&quot;modal&quot; aria-label=&quot;Close&quot;&gt;</span><br><span class="line">						&lt;span aria-hidden=&quot;true&quot;&gt;×&lt;/span&gt;</span><br><span class="line">					&lt;/button&gt;</span><br><span class="line">				&lt;/div&gt;</span><br><span class="line">				&lt;div class=&quot;modal-body&quot;&gt;</span><br><span class="line">					&lt;form id=&quot;&#123;&#123; id &#125;&#125;&quot;&gt;</span><br><span class="line">						&#123;&#123; form.csrf_token() &#125;&#125;</span><br><span class="line">						&#123;&#123; wtf.form_field(form[&#x27;app_id&#x27;]) &#125;&#125;</span><br><span class="line">						&#123;&#123; wtf.form_field(form[&#x27;channel_num&#x27;]) &#125;&#125;</span><br><span class="line">						&#123;&#123; wtf.form_field(form[&#x27;remark&#x27;]) &#125;&#125;</span><br><span class="line">						&#123;&#123; wtf.form_field(form[&#x27;upload_file&#x27;]) &#125;&#125;</span><br><span class="line">					&lt;/form&gt;</span><br><span class="line">				&lt;/div&gt;</span><br><span class="line">				&lt;div class=&quot;modal-footer justify-content-between&quot;&gt;</span><br><span class="line">					&lt;button type=&quot;button&quot; class=&quot;btn btn-default&quot; data-dismiss=&quot;modal&quot;&gt;取消&lt;/button&gt;</span><br><span class="line">					&lt;button type=&quot;button&quot; class=&quot;btn btn-primary&quot; id=&quot;save-btn&quot;&gt;保存&lt;/button&gt;</span><br><span class="line">				&lt;/div&gt;</span><br><span class="line">			&lt;/div&gt;</span><br><span class="line">			&lt;!-- /.modal-content --&gt;</span><br><span class="line">		&lt;/div&gt;</span><br><span class="line">		&lt;!-- /.modal-dialog --&gt;</span><br><span class="line">	&lt;/div&gt;</span><br><span class="line">&#123;% endmacro %&#125;</span><br></pre></td></tr></table></figure>



<h2 id="group-by"><a href="#group-by" class="headerlink" title="group_by"></a>group_by</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">field = [</span><br><span class="line">            ReportPersonConsumeTsf.user_name, </span><br><span class="line">            ReportPersonConsumeTsf.report_date,</span><br><span class="line">            ReportPersonConsumeTsf.app_name</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">        table_fields = &#123;</span><br><span class="line">            ReportPersonConsumeTsf: [</span><br><span class="line">                <span class="string">&#x27;consume_jrtt&#x27;</span>, <span class="string">&#x27;consume_gdt&#x27;</span>, <span class="string">&#x27;consume_ks&#x27;</span>, <span class="string">&#x27;consume_qtt&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;consume_bd&#x27;</span>,<span class="string">&#x27;consume_aqy&#x27;</span>,<span class="string">&#x27;consume_xl&#x27;</span>,<span class="string">&#x27;transformation_jrtt&#x27;</span>, </span><br><span class="line">                <span class="string">&#x27;transformation_gdt&#x27;</span>, <span class="string">&#x27;transformation_ks&#x27;</span>, <span class="string">&#x27;transformation_qtt&#x27;</span>, <span class="string">&#x27;transformation_bd&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;transformation_aqy&#x27;</span>,<span class="string">&#x27;transformation_xl&#x27;</span></span><br><span class="line">            ],</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _sum_fields = [</span><br><span class="line">            <span class="built_in">getattr</span>(table, field)</span><br><span class="line">            <span class="keyword">for</span> table, fields <span class="keyword">in</span> table_fields.items()</span><br><span class="line">            <span class="keyword">for</span> field <span class="keyword">in</span> fields</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">        q = (</span><br><span class="line">            db.session.query(*field, *[func.<span class="built_in">sum</span>(f) <span class="keyword">for</span> f <span class="keyword">in</span> _sum_fields])</span><br><span class="line">                .<span class="built_in">filter</span>(ReportPersonConsumeTsf.app_name == ReportProfitDaily.app_name)</span><br><span class="line">                .<span class="built_in">filter</span>(ReportPersonConsumeTsf.report_date == ReportProfitDaily.report_date)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.starttime <span class="keyword">and</span> self.endtime:</span><br><span class="line">            q = (</span><br><span class="line">                q.<span class="built_in">filter</span>(ReportPersonConsumeTsf.report_date &lt;= self.endtime)</span><br><span class="line">                    .<span class="built_in">filter</span>(ReportPersonConsumeTsf.report_date &gt;= self.starttime)</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">return</span> q.group_by(*field)</span><br></pre></td></tr></table></figure>



<h2 id="html复制功能"><a href="#html复制功能" class="headerlink" title="html复制功能"></a>html复制功能</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-sm btn-secondary copy_btn&quot;</span> <span class="attr">data-clipboard-text</span>=<span class="string">&quot;http://127.0.0.1:50080\junhaiyouxi_kdfasdf_01.png&quot;</span>&gt;</span>复制</span><br><span class="line"><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="新增wtform不存在的字段"><a href="#新增wtform不存在的字段" class="headerlink" title="新增wtform不存在的字段"></a>新增wtform不存在的字段</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;% macro make_stringfield(field) %&#125;</span><br><span class="line">    &lt;div class=&quot;input-group&quot;&gt;</span><br><span class="line">        &lt;span class=&quot;input-group-text col-3&quot;&gt;&#123;&#123; field.label.text &#125;&#125;&lt;/span&gt;</span><br><span class="line">        &lt;input class=&quot;col-9&quot; type=&quot;text&quot; id=&quot;&#123;&#123; field.id &#125;&#125;&quot; name=&quot;&#123;&#123; field.name &#125;&#125;&quot;</span><br><span class="line">               value=&quot;&#123;&#123; field.data &#125;&#125;&quot;&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&#123;% endmacro %&#125;</span><br><span class="line"></span><br><span class="line">&lt;div class=&quot;col&quot;&gt;&#123;&#123; make_stringfield(form.app_name) &#125;&#125;&lt;/div&gt;</span><br></pre></td></tr></table></figure>



<p>使用html的layer</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">new</span> Clipboard(<span class="string">&#x27;.copy_btn&#x27;</span>).on(</span></span><br><span class="line"><span class="javascript">        <span class="string">&#x27;success&#x27;</span>,</span></span><br><span class="line"><span class="javascript">        <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            layer.msg(</span></span><br><span class="line"><span class="javascript">                <span class="string">&quot;复制成功!&quot;</span>,</span></span><br><span class="line"><span class="javascript">            );</span></span><br><span class="line"><span class="javascript">        &#125;);</span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="select-实现placeholder-效果"><a href="#select-实现placeholder-效果" class="headerlink" title="select 实现placeholder 效果"></a>select 实现placeholder 效果</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> <span class="attr">selected</span> <span class="attr">disabled</span> <span class="attr">style</span>=<span class="string">&quot;display: none;&quot;</span>&gt;</span>--请选择--<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span>&gt;</span>可乐<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;3&quot;</span>&gt;</span>橙汁<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;4&quot;</span>&gt;</span>雪碧<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;5&quot;</span>&gt;</span>牛奶<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>  <span class="attr">hidden</span>&gt;</span>--请选择--<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span>&gt;</span>可乐<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;3&quot;</span>&gt;</span>橙汁<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;4&quot;</span>&gt;</span>雪碧<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;5&quot;</span>&gt;</span>牛奶<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="解决app-choices不断被append的问题"><a href="#解决app-choices不断被append的问题" class="headerlink" title="解决app_choices不断被append的问题"></a>解决app_choices不断被append的问题</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AndroidPackageAddForm</span>(<span class="params">FlaskForm</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(AndroidPackageAddForm, self).__init__(*args, **kwargs)</span><br><span class="line">        app_choices = [(<span class="number">0</span>, <span class="string">u&quot;--请选择应用--&quot;</span>)]</span><br><span class="line">        app_choices.extend([(x.<span class="built_in">id</span>, x.app_name) <span class="keyword">for</span> x <span class="keyword">in</span> Application.query.<span class="built_in">all</span>()])</span><br><span class="line">        self.app_id.choices = app_choices</span><br></pre></td></tr></table></figure>



<h2 id="使用QueryClass"><a href="#使用QueryClass" class="headerlink" title="使用QueryClass"></a>使用QueryClass</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AndroidPackageQuery</span>(<span class="params">BaseQuery</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27; 查询类 &#x27;&#x27;&#x27;</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_data</span>(<span class="params">cls</span>):</span></span><br><span class="line">        data = AndroidPackage.query.order_by(AndroidPackage.<span class="built_in">id</span>.desc()).<span class="built_in">all</span>()</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fuzzy_channel_num</span>(<span class="params">cls, _list, channel_num</span>):</span></span><br><span class="line">        data = AndroidPackage.query.<span class="built_in">filter</span>(</span><br><span class="line">            AndroidPackage.channel_num.like(<span class="string">&#x27;%&#x27;</span> + channel_num + <span class="string">&#x27;%&#x27;</span>)).<span class="built_in">all</span>()</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">filter_app_name</span>(<span class="params">cls, _list, app_name</span>):</span></span><br><span class="line">        app = Application.get_by(app_name=app_name)</span><br><span class="line">        <span class="keyword">if</span> app <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        data = [item <span class="keyword">for</span> item <span class="keyword">in</span> _<span class="built_in">list</span> <span class="keyword">if</span> item.app_id == app.<span class="built_in">id</span>]</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AndroidPackage</span>(<span class="params">db.Model, DBOperationMixin</span>):</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27; 安卓包模型 &#x27;&#x27;&#x27;</span></span><br><span class="line">    __tablename__ = <span class="string">&quot;android_package&quot;</span></span><br><span class="line">    query_class = AndroidPackageQuery</span><br><span class="line"></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, autoincrement=<span class="literal">True</span>, primary_key=<span class="literal">True</span>)</span><br><span class="line">    app_id = db.Column(db.Integer, nullable=<span class="literal">False</span>, comment=<span class="string">&quot;应用id&quot;</span>)</span><br><span class="line">    link = db.Column(db.String(<span class="number">200</span>), nullable=<span class="literal">False</span>, comment=<span class="string">&quot;文件名&quot;</span>)</span><br><span class="line">    channel_num = db.Column(db.String(<span class="number">200</span>), nullable=<span class="literal">False</span>, comment=<span class="string">&quot;渠道号&quot;</span>)</span><br><span class="line">    status = db.Column(db.SMALLINT, nullable=<span class="literal">False</span>, comment=<span class="string">&quot;上传状态&quot;</span>)</span><br><span class="line">    remark = db.Column(db.Text, nullable=<span class="literal">False</span>, comment=<span class="string">&#x27;备注&#x27;</span>, default=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&lt;AndroidPackage %s&gt;:&#x27;</span> % self.<span class="built_in">id</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_app_name</span>(<span class="params">self</span>):</span></span><br><span class="line">        data = Application.query.get(self.app_id)</span><br><span class="line">        <span class="keyword">return</span> data.app_name</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_status</span>(<span class="params">self</span>):</span></span><br><span class="line">        STATUS_FORMAT = &#123;<span class="number">1</span>: <span class="string">&#x27;上传&#x27;</span>, <span class="number">2</span>: <span class="string">&#x27;未更新&#x27;</span>, <span class="number">3</span>: <span class="string">&#x27;正常&#x27;</span>, <span class="number">4</span>: <span class="string">&#x27;更新中&#x27;</span>, <span class="number">5</span>: <span class="string">&#x27;更新失败&#x27;</span>&#125;</span><br><span class="line">        data = STATUS_FORMAT[self.status]</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_link</span>(<span class="params">self</span>):</span></span><br><span class="line">        new_link = os.path.join(current_app.config[<span class="string">&#x27;CDN_HOST&#x27;</span>], self.link)</span><br><span class="line">        <span class="keyword">return</span> new_link</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_update_or_create</span>(<span class="params">cls, app_id, file</span>):</span></span><br><span class="line">        <span class="comment"># 应用和渠道号相同情况下更新</span></span><br><span class="line">        package = AndroidPackage.query.\</span><br><span class="line">            <span class="built_in">filter</span>(AndroidPackage.channel_num == file[<span class="string">&#x27;channel_num&#x27;</span>],</span><br><span class="line">                   AndroidPackage.app_id == app_id).first()</span><br><span class="line">        <span class="keyword">if</span> package:</span><br><span class="line">            <span class="keyword">return</span> package, <span class="string">&#x27;update&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> cls(), <span class="string">&#x27;create&#x27;</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check_file_name</span>(<span class="params">cls, app_id, file</span>):</span></span><br><span class="line">        app = Application.get_by_id(app_id)</span><br><span class="line">        file_name = file[<span class="string">&#x27;file_name&#x27;</span>]</span><br><span class="line">        _<span class="built_in">list</span> = file_name.split(<span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(_<span class="built_in">list</span>) &lt; <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;文件名%s格式错误，请按标准化名称输入&quot;</span> % file_name</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 对比文件名的应用包名是否相同</span></span><br><span class="line">        <span class="keyword">if</span> _<span class="built_in">list</span>[<span class="number">0</span>] != app.app_package_name:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;文件%s，应用包名缩写错误，正确应用包名应为%s&quot;</span> % (file_name, app.cp_check_name)</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_db</span>(<span class="params">self, **kwargs</span>):</span></span><br><span class="line">        app = Application.query.get(kwargs[<span class="string">&#x27;app_id&#x27;</span>])</span><br><span class="line">        self.app_id = kwargs[<span class="string">&#x27;app_id&#x27;</span>],</span><br><span class="line">        self.link = <span class="string">&#x27;/&#x27;</span>.join([app.app_package_name, kwargs[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;file_name&#x27;</span>]]),</span><br><span class="line">        self.channel_num = kwargs[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;channel_num&#x27;</span>],</span><br><span class="line">        self.remark = <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        self.status = STATUS_LEVEL[<span class="string">&#x27;NORMAL&#x27;</span>],</span><br><span class="line">        <span class="keyword">return</span> self.save()</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update_db</span>(<span class="params">self, file_name</span>):</span></span><br><span class="line">        app = Application.query.get(self.app_id)</span><br><span class="line">        self.link = <span class="string">&#x27;/&#x27;</span>.join([app.app_package_name, file_name]),</span><br><span class="line">        self.status = STATUS_LEVEL[<span class="string">&#x27;UPGRADE&#x27;</span>]</span><br><span class="line">        db.session.commit()</span><br></pre></td></tr></table></figure>



<h2 id="查询的使用使用的filter"><a href="#查询的使用使用的filter" class="headerlink" title="查询的使用使用的filter"></a>查询的使用使用的filter</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">filters = []</span><br><span class="line"><span class="keyword">if</span> form.app_name.data:</span><br><span class="line">    filters.append(Application.app_name.like(<span class="string">&#x27;%&#x27;</span> + form.app_name.data + <span class="string">&#x27;%&#x27;</span>))</span><br><span class="line"><span class="keyword">if</span> form.channel_num.data:</span><br><span class="line">    filters.append(AndroidPackage.channel_num.like(<span class="string">&#x27;%&#x27;</span> + form.channel_num.data + <span class="string">&#x27;%&#x27;</span>))</span><br><span class="line"><span class="keyword">if</span> filters:</span><br><span class="line">    query = query.<span class="built_in">filter</span>(*filters)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">query = BlockClient.query.<span class="built_in">filter</span>()</span><br><span class="line">filters = [</span><br><span class="line">    BlockClient.create_date &gt;= start_date,</span><br><span class="line">    BlockClient.create_date &lt;= end_date</span><br><span class="line">]</span><br><span class="line"><span class="keyword">if</span> client:</span><br><span class="line">    filters.append(BlockClient.block_value == client)</span><br><span class="line"></span><br><span class="line">    query = query.<span class="built_in">filter</span>(*filters)</span><br></pre></td></tr></table></figure>









</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>