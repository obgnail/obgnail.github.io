<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="&lt;a href=&quot;https://www.tangshuang.net/3839.html&quot;&gt;模拟代码帮助理解reselect的createSelector函数&lt;/a&gt;"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>reselect | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Tags</a><a class="sidebar-nav-item" href="/About">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/React/" rel="tag">React</a></div><div class="post-time">2020-07-29</div></div></div><div class="container post-header"><h1>reselect</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#react-redux%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%B9%8Breselect"><span class="toc-number">1.</span> <span class="toc-text">react-redux性能优化之reselect</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.</span> <span class="toc-text">性能问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%87%E7%94%A8-reselect%EF%BC%8C%E6%9B%B4%E6%96%B0-App-%E7%BB%84%E4%BB%B6"><span class="toc-number">1.2.</span> <span class="toc-text">采用 reselect，更新 App 组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E9%87%8A"><span class="toc-number">1.3.</span> <span class="toc-text">解释</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%81%9A%E5%90%88selectors"><span class="toc-number">1.4.</span> <span class="toc-text">聚合selectors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E4%B8%80%E4%B8%AASelector%E5%88%B0Redux-Store"><span class="toc-number">1.5.</span> <span class="toc-text">连接一个Selector到Redux Store</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#reselect%E7%BC%93%E5%AD%98%E8%A7%84%E5%88%99"><span class="toc-number">2.</span> <span class="toc-text">reselect缓存规则</span></a></li></ol></details></div><div class="container post-content"><p><a target="_blank" rel="noopener" href="https://www.tangshuang.net/3839.html">模拟代码帮助理解reselect的createSelector函数</a></p>
<h2 id="react-redux性能优化之reselect"><a href="#react-redux性能优化之reselect" class="headerlink" title="react-redux性能优化之reselect"></a>react-redux性能优化之reselect</h2><p>selector 的作用：<strong>将多个 state 进行计算后生成新的 state</strong></p>
<h3 id="性能问题"><a href="#性能问题" class="headerlink" title="性能问题"></a>性能问题</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> propTypes = &#123;&#125;;  <span class="comment">// 省略</span></span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; visibleTodos, visibilityFilter, onAddClick, onTodoClick, onFilterChange &#125; = <span class="built_in">this</span>.props;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">AddTodo</span> <span class="attr">onAddClick</span>=<span class="string">&#123;(text)</span> =&gt;</span> onAddClick(text)&#125; /&gt;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">TodoList</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                    <span class="attr">todos</span>=<span class="string">&#123;visibleTodos&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                    <span class="attr">onTodoClick</span>=<span class="string">&#123;(index)</span> =&gt;</span> onTodoClick(index)&#125; /&gt;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">Footer</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                    <span class="attr">filter</span>=<span class="string">&#123;visibilityFilter&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                    <span class="attr">onFilterChange</span>=<span class="string">&#123;(nextFilter)</span> =&gt;</span> onFilterChange(nextFilter)&#125; /&gt;</span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 一个 state 计算函数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> selectTodos = <span class="function">(<span class="params">todos, filter</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (filter) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;SHOW_ALL&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> todos</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;SHOW_COMPLETED&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> todos.filter(<span class="function"><span class="params">todo</span> =&gt;</span> todo.completed)</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;SHOW_ACTIVE&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> todos.filter(<span class="function"><span class="params">todo</span> =&gt;</span> !todo.completed)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// mapStateToProps 就是一个 selector，每次组件更新的时候就会被调用</span></span><br><span class="line"><span class="comment">// 【缺点】每次组件更新的时候都会重新计算 visibleTodos，如果计算量比较大，会造成性能问题</span></span><br><span class="line"><span class="keyword">const</span> mapStateToProps = <span class="function">(<span class="params">state</span>) =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">visibleTodos</span>: selectTodos(state.todos, state.visibilityFilter),</span><br><span class="line">    <span class="attr">visibilityFilter</span>: state.visibilityFilter</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function">(<span class="params">dispatch</span>) =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">onAddClick</span>: <span class="function">(<span class="params">text</span>) =&gt;</span> dispatch(addTodo(text)),</span><br><span class="line">    <span class="attr">onTodoClick</span>: <span class="function">(<span class="params">index</span>) =&gt;</span> dispatch(toggleTodo(index)),</span><br><span class="line">    <span class="attr">onFilterChange</span>: <span class="function">(<span class="params">nextFilter</span>) =&gt;</span> dispatch(setVisibilityFilter(nextFilter))</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(mapStateToProps, mapDispatchToProps)(App);</span><br></pre></td></tr></table></figure>



<p>connect 函数实现的时候，我们知道<strong>映射 <code>props</code> 的函数被 <code>store.subscribe()</code> 了，因此每次组件更新的时候，无论 state 是否改变，都会调用 <code>mapStateToProps</code>，</strong>而 <code>mapStateToProps</code> 在计算 state 的时候就会调用 state 计算函数，<strong>过程</strong> 如下：</p>
<ol>
<li><code>store.subscribe()</code>（注册事件） </li>
<li>状态更新时调用 <code>mapStateToProps</code>（一个selector，返回 state） </li>
<li>调用 state 计算函数 <code>selectTodos</code></li>
</ol>
<p>那么，<strong>问题</strong> 来了，如果 selector 的计算量比较大，每次更新的重新计算就会造成性能问题。而解决性能问题的 <strong>出发点</strong> 就是：<strong>避免不必要的计算</strong>。</p>
<p><strong>解决问题的方式</strong>：从 selector 着手，即 <code>mapStateToProps</code>，<strong>如果 selector 接受的状态参数不变，那么就不调用计算函数，直接利用之前的结果。</strong></p>
<ul>
<li>reselect 其实就是 redux 的一个中间件，它通过计算获得新的 state，然后传递到 Redux Store。</li>
<li>其主要就是进行了中间的那一步计算，使得计算的状态被缓存，从而根据传入的 state 判断是否需要调用计算函数，而不用在组件每次更新的时候都进行调用，从而更加高效。</li>
</ul>
<p>不使用Selector：</p>
<p><img src="/images/WechatIMG55.png" alt="WechatIMG55"></p>
<p>使用Selector：</p>
<p><img src="/images/WechatIMG56.png" alt="WechatIMG56"></p>
<h3 id="采用-reselect，更新-App-组件"><a href="#采用-reselect，更新-App-组件" class="headerlink" title="采用 reselect，更新 App 组件"></a>采用 reselect，更新 App 组件</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不用 reselect 的缺点：每次组件更新的时候都会重新计算 visibleTodos</span></span><br><span class="line"><span class="comment">/*const mapStateToProps = (state) =&gt; (&#123;</span></span><br><span class="line"><span class="comment">    visibleTodos: selectTodos(state.todos, state.visibilityFilter),</span></span><br><span class="line"><span class="comment">    visibilityFilter: state.visibilityFilter</span></span><br><span class="line"><span class="comment">&#125;);*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 采用 reselect 后，相当于记忆缓存，会缓存状态</span></span><br><span class="line"><span class="comment">// 如果 state.todos 和 state.visibilityFilter 发生变化，它会重新计算 state</span></span><br><span class="line"><span class="comment">// 但是发生在其他部分的 state 变化，就不会重新计算</span></span><br><span class="line"><span class="keyword">const</span> getTodos = <span class="function">(<span class="params">state</span>) =&gt;</span> state.todos;</span><br><span class="line"><span class="keyword">const</span> getVisibilityFilter = <span class="function">(<span class="params">state</span>) =&gt;</span> state.visibilityFilter;</span><br><span class="line"></span><br><span class="line"><span class="comment">// reducer</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> selectTodos = <span class="function">(<span class="params">todos, filter</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (filter) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;SHOW_ALL&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> todos</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;SHOW_COMPLETED&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> todos.filter(<span class="function"><span class="params">todo</span> =&gt;</span> todo.completed)</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;SHOW_ACTIVE&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> todos.filter(<span class="function"><span class="params">todo</span> =&gt;</span> !todo.completed)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// getTodos 和 getVisibilityFilter 返回的参数将传入 selectTodos</span></span><br><span class="line"><span class="keyword">const</span> getVisibleTodos = createSelector(</span><br><span class="line">	[getTodos, getVisibilityFilter], </span><br><span class="line">  selectTodos</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapStateToProps = <span class="function">(<span class="params">state</span>) =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">visibleTodos</span>: getVisibleTodos(state),</span><br><span class="line">    <span class="attr">visibilityFilter</span>: state.visibilityFilter</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function">(<span class="params">dispatch</span>) =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">onAddClick</span>: <span class="function">(<span class="params">text</span>) =&gt;</span> dispatch(addTodo(text)),</span><br><span class="line">    <span class="attr">onTodoClick</span>: <span class="function">(<span class="params">index</span>) =&gt;</span> dispatch(toggleTodo(index)),</span><br><span class="line">    <span class="attr">onFilterChange</span>: <span class="function">(<span class="params">nextFilter</span>) =&gt;</span> dispatch(setVisibilityFilter(nextFilter))</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * connect用法：connect(selectors)(App); // selectors 即是一个对象，包含了状态属性和方法</span></span><br><span class="line"><span class="comment"> * connect作用：即使 Dumb 组件从 store 中获取数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// export default connect(mapStateToProps)(App);</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(mapStateToProps, mapDispatchToProps)(App);</span><br></pre></td></tr></table></figure>



<h3 id="解释"><a href="#解释" class="headerlink" title="解释"></a>解释</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">&#x27;react-redux&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; toggleTodo &#125; <span class="keyword">from</span> <span class="string">&#x27;../actions&#x27;</span></span><br><span class="line"><span class="keyword">import</span> TodoList <span class="keyword">from</span> <span class="string">&#x27;../components/TodoList&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//下面这段代码是根据过滤器的state来改变日程state的函数</span></span><br><span class="line"><span class="keyword">const</span> getVisibleTodos = <span class="function">(<span class="params">todos, filter</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (filter) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;SHOW_ALL&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> todos</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;SHOW_COMPLETED&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> todos.filter(<span class="function"><span class="params">t</span> =&gt;</span> t.completed)</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;SHOW_ACTIVE&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> todos.filter(<span class="function"><span class="params">t</span> =&gt;</span> !t.completed)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapStateToProps = <span class="function">(<span class="params">state</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="comment">//todos是根据过滤函数返回的state，传入两个实参</span></span><br><span class="line">    <span class="attr">todos</span>: getVisibleTodos(state.todos, state.visibilityFilter)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//mapDispatchToProps来传递dispatch的方法</span></span><br><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">onTodoClick</span>: <span class="function">(<span class="params">id</span>) =&gt;</span> &#123;</span><br><span class="line">      dispatch(toggleTodo(id))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//使用Redux的connect函数注入state,到TodoList组件</span></span><br><span class="line"><span class="keyword">const</span> VisibleTodoList = connect(</span><br><span class="line">  mapStateToProps,</span><br><span class="line">  mapDispatchToProps</span><br><span class="line">)(TodoList)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> VisibleTodoList</span><br></pre></td></tr></table></figure>

<ul>
<li><p>在上面的例子中,<code>mapStateToProps</code>调用<code>getVisibleTodos</code>去计算<code>todos</code>.这个函数设计的是相当好的,</p>
</li>
<li><p>但是有个缺点：<code>todos</code>在每一次组件更新的时候都会重新计算.如果state树的结构比较大,或者计算比较昂贵,每一次组件更新的时候都进行计算的话,将会导致性能问题.</p>
</li>
<li><p><code>Reselect</code>能够帮助redux来避免不必要的重新计算过程.</p>
</li>
<li><p>我们可以<strong>使用记忆缓存selector代替<code>getVisibleTodos</code></strong>,如果<code>state.todos</code>和<code>state.visibilityFilter</code>发生变化,他会重新计算<code>state</code>,但是发生在其他部分的state变化,就不会重新计算.</p>
</li>
<li><p>Reslect提供一个函数<code>createSelector</code>来创建一个记忆selectors.</p>
<ul>
<li><code>createSelector</code>接受一个<code>input-selectors</code>和一个变换函数作为参数.</li>
<li>如果Redux的<strong>state发生改变造成<code>input-selector</code>的值发生改变</strong>,selector会调用变换函数,依据<code>input-selector</code>做参数,返回一个结果.</li>
<li>如果<code>input-selector</code>返回的结果和前面的一样,那么就会直接返回有关state,会省略变换函数的调用.</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">import</span> &#123; createSelector &#125; <span class="keyword">from</span> <span class="string">&#x27;reselect&#x27;</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> getVisibilityFilter = <span class="function">(<span class="params">state</span>) =&gt;</span> state.visibilityFilter</span><br><span class="line">  <span class="keyword">const</span> getTodos = <span class="function">(<span class="params">state</span>) =&gt;</span> state.todos</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//下面的函数是经过包装的</span></span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">const</span> getVisibleTodos = createSelector(</span><br><span class="line">    [ getVisibilityFilter, getTodos ],</span><br><span class="line">    <span class="function">(<span class="params">visibilityFilter, todos</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">switch</span> (visibilityFilter) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;SHOW_ALL&#x27;</span>:</span><br><span class="line">          <span class="keyword">return</span> todos</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;SHOW_COMPLETED&#x27;</span>:</span><br><span class="line">          <span class="keyword">return</span> todos.filter(<span class="function"><span class="params">t</span> =&gt;</span> t.completed)</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;SHOW_ACTIVE&#x27;</span>:</span><br><span class="line">          <span class="keyword">return</span> todos.filter(<span class="function"><span class="params">t</span> =&gt;</span> !t.completed)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 对比之前的getVisibleTodos函数：</span></span><br><span class="line">  <span class="keyword">const</span> getVisibleTodos = <span class="function">(<span class="params">todos, filter</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (filter) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;SHOW_ALL&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> todos</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;SHOW_COMPLETED&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> todos.filter(<span class="function"><span class="params">t</span> =&gt;</span> t.completed)</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;SHOW_ACTIVE&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> todos.filter(<span class="function"><span class="params">t</span> =&gt;</span> !t.completed)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>上面的的实例中,<code>getVisibilityfilter</code>和<code>getTodos</code>是input-selectors.这两个函数是普通的非记忆selector函数,因为他们没有变换他们select的数据.</p>
</li>
<li><p><code>getVisibleTodos</code>另一方面是一个记忆selector.他接收<code>getVisibilityfilter</code>和<code>getTodos</code>作为input-selectors,并且作为一个变换函数计算筛选的todo list.</p>
</li>
</ul>
</li>
</ul>
<h3 id="聚合selectors"><a href="#聚合selectors" class="headerlink" title="聚合selectors"></a>聚合selectors</h3><p>一个记忆性selector本身也可以作为另一个记忆性selector的input-selector.这里<code>getVisibleTodos</code>可以作为input-selector作为关键字筛选的input-selector:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getKeyword = <span class="function">(<span class="params">state</span>) =&gt;</span> state.keyword</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getVisibleTodosFilteredByKeyword = createSelector(</span><br><span class="line">  [ getVisibleTodos, getKeyword ],</span><br><span class="line">  <span class="function">(<span class="params">visibleTodos, keyword</span>) =&gt;</span> visibleTodos.filter(</span><br><span class="line">    <span class="function"><span class="params">todo</span> =&gt;</span> todo.text.indexOf(keyword) &gt; -<span class="number">1</span></span><br><span class="line">  )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<h3 id="连接一个Selector到Redux-Store"><a href="#连接一个Selector到Redux-Store" class="headerlink" title="连接一个Selector到Redux Store"></a>连接一个Selector到Redux Store</h3><p>如果你正在使用 <a target="_blank" rel="noopener" href="https://link.jianshu.com/?t=https://github.com/reactjs/react-redux">React Redux</a>, 你可以直接传递selector到 <code>mapStateToProps()</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">&#x27;react-redux&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; toggleTodo &#125; <span class="keyword">from</span> <span class="string">&#x27;../actions&#x27;</span></span><br><span class="line"><span class="keyword">import</span> TodoList <span class="keyword">from</span> <span class="string">&#x27;../components/TodoList&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; getVisibleTodos &#125; <span class="keyword">from</span> <span class="string">&#x27;../selectors&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapStateToProps = <span class="function">(<span class="params">state</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">todos</span>: getVisibleTodos(state)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">onTodoClick</span>: <span class="function">(<span class="params">id</span>) =&gt;</span> &#123;</span><br><span class="line">      dispatch(toggleTodo(id))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> VisibleTodoList = connect(</span><br><span class="line">  mapStateToProps,</span><br><span class="line">  mapDispatchToProps</span><br><span class="line">)(TodoList)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> VisibleTodoList</span><br></pre></td></tr></table></figure>



<h2 id="reselect缓存规则"><a href="#reselect缓存规则" class="headerlink" title="reselect缓存规则"></a>reselect缓存规则</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> selector = createSelector([fun1, fun2], fun3)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> someState = selector(state, props)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在mapStateToProps中这样用推导出</span></span><br><span class="line"><span class="comment">// 在使用selector的时候，把它当作一个函数，传入state和props作为参数。</span></span><br><span class="line"><span class="comment">// 这样就可以非常容易的理解，createSelector传入的参数中的函数，各自在什么时候执行，执行的结果拿来干什么。</span></span><br><span class="line"><span class="keyword">let</span> someState = (<span class="function"><span class="keyword">function</span>(<span class="params">state, props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> state1 = fun1(state, props)</span><br><span class="line">  <span class="keyword">let</span> state2 = fun2(state, props)</span><br><span class="line">  <span class="keyword">return</span> fun3(state1, state2)</span><br><span class="line">&#125;)(state, props)</span><br></pre></td></tr></table></figure>

<ul>
<li>reselect的记忆功能的规则是，fun3的实参如果不变，那么说明它的运算结果也不变，可以直接返回缓存起来的结果。</li>
<li>所以，要使记忆功能生效，你必须保证fun3的实参不变，说白了，就是fun1, fun2的计算结果不变，因此fun1, fun2必须是返回固定值的函数。这种函数比pure function还要硬性，即使参数不同，也要永远返回一个值。当然，我们是不可能做到这样的，如果fun1依赖的state发生来变化，那么它的结果自然就会变，这个时候，fun3就不再返回缓存，而是重新计算结果，同时缓存新的结果，下次就可以用这个缓存了。这样，就做到selector的响应式。</li>
<li>最后的问题是，如果fun1, fun2的结果会随着props的不同而返回不同的结果呢？这种情况普遍存在，一个react组件可能在一个页面里面被多次使用，每次使用的时候props可能不同。这就会导致reselect的记忆功能失效。</li>
</ul>
<p>解决的办法还是要从记忆功能的原理中去寻找。</p>
<p>每一个计算结果的缓存，与传入fun3的参数是一一对应的，fun3可以说是一个pure function，参数相同的情况下，得到的结果永远相同。有两种解决的想法：</p>
<ol>
<li>为每一个组件设置单独的映射，这个可以通过react-redux的connect来实现，当mapStateToProps返回的是一个函数时，那么这个函数的运算结果仅对组件的当前实例生效，也就是说，在我们写mapStateToProps函数时，不能直接返回映射关系，而是返回一个函数，这个函数里面去做一些处理后再返回映射关系。下面有例子。</li>
<li>既然fun3的计算结果是根据参数来缓存的，那么我们可以尝试对参数做hash，固定的参数对应固定的fun3函数体，不同的参数对应不同的fun3函数体，当在不同的参数之间切换时，如果发现这个hash有存在的fun3函数体，那么就立即用它的缓存。下面也有例子。</li>
</ol>
<p>想法1的例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> makeMapStateToProps = <span class="function">() =&gt;</span> &#123;</span><br><span class="line"> <span class="keyword">const</span> getSelector = makeSelector() <span class="comment">// 下一段代码看makeSelector是怎么写的</span></span><br><span class="line"> <span class="keyword">const</span> mapStateToProps = <span class="function">(<span class="params">state, props</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">   <span class="attr">todos</span>: getSelector(state, props)</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> mapStateToProps</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(makeMapStateToProps)(MyComponent)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createSelector &#125; <span class="keyword">from</span> <span class="string">&#x27;reselect&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getSelector</span>(<span class="params">state, props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> state[props.id]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">makeSelector</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> createSelector(</span><br><span class="line">    [ getSelector ],</span><br><span class="line">    <span class="function">(<span class="params">user</span>) =&gt;</span> &#123;</span><br><span class="line">      user.total_books = user.books.length</span><br><span class="line">      <span class="keyword">return</span> user</span><br><span class="line">    &#125;,</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过结合文章开头的推导代码，你会发现，每个组件的实例的props.id是一定的，因此对应的user也是一定的，那么每次都可以使用缓存起来的user。当然，如果props.id改变来，那么缓存就失效了。</p>
<p>想法2，对makeSelector做深度改造：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> selectors = &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeSelector</span>(<span class="params">uid</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (selectors[uid]) <span class="keyword">return</span> selectors[uid]</span><br><span class="line">  <span class="keyword">let</span> selector = createSelector(...)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deleteSelector</span>(<span class="params">uid</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">delete</span> selectors[uid]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在connect的时候，直接在makeSelector的时候传入props.id作为标记，mapStateToProps不再返回函数作为结果。当不再对uid对应的用户进行操作之后，要即时删除这个selector。</p>
</div></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>