<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;sql-的-语法&quot;&gt;&lt;a href=&quot;#sql-的-语法&quot; class=&quot;headerlink&quot; title=&quot;sql 的 =:语法&quot;&gt;&lt;/a&gt;sql 的 &lt;code&gt;=:&lt;/code&gt;语法&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;通过&lt;code&gt;=：变量名&lt;/code&gt;的方式，在具体调用的时候传入参数，是防止sql注入的写法&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;code&gt;user_id = 1&lt;/code&gt;"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>note3 | 凉薄的自动书记人偶</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-none-link" href="/tags/zhangkun-internship/" rel="tag">zhangkun_internship</a></div><div class="post-time">2020-04-17</div></div></div><div class="container post-header"><h1>note3</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#sql-%E7%9A%84-%E8%AF%AD%E6%B3%95"><span class="toc-number">1.</span> <span class="toc-text">sql 的 &#x3D;:语法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E5%88%9B%E5%BB%BAnamedtuple"><span class="toc-number">2.</span> <span class="toc-text">快速创建namedtuple</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Flask-Schema"><span class="toc-number">3.</span> <span class="toc-text">Flask Schema</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8schema%E5%A4%84%E7%90%86%E5%8F%82%E6%95%B0"><span class="toc-number">4.</span> <span class="toc-text">使用schema处理参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E4%B8%8A%E7%BA%BF%E4%B8%8B%E4%B8%8D%E5%90%8C%E9%85%8D%E7%BD%AE"><span class="toc-number">5.</span> <span class="toc-text">线上线下不同配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#coalesce%E8%AF%AD%E5%8F%A5"><span class="toc-number">6.</span> <span class="toc-text">coalesce语句</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sql%E7%9A%84%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-number">7.</span> <span class="toc-text">sql的执行顺序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#db-session-query-obj-%E7%9A%84%E6%89%81%E5%B9%B3%E5%8C%96%E5%A4%84%E7%90%86"><span class="toc-number">8.</span> <span class="toc-text">db.session.query(obj)的扁平化处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E4%B8%8A%E4%BC%A0%E7%9A%84%E9%80%9A%E7%94%A8%E6%93%8D%E4%BD%9C"><span class="toc-number">9.</span> <span class="toc-text">资源上传的通用操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sqlalchemy%E7%9A%84%E5%A4%8D%E6%9D%82%E6%93%8D%E4%BD%9C"><span class="toc-number">10.</span> <span class="toc-text">sqlalchemy的复杂操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E5%88%99"><span class="toc-number">11.</span> <span class="toc-text">原则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%BC%E6%8E%A5url%E5%8F%82%E6%95%B0%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">12.</span> <span class="toc-text">拼接url参数的方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E4%BA%8Erequest%E8%AF%B7%E6%B1%82-%E4%B8%8D%E8%A6%81%E5%9C%A8request%E5%87%BD%E6%95%B0%E9%87%8C%E6%B7%BB%E5%8A%A0status%E7%9A%84%E5%88%A4%E6%96%AD"><span class="toc-number">13.</span> <span class="toc-text">对于request请求 , 不要在request函数里添加status的判断</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E7%A9%BA%E7%9A%84%E5%AF%B9%E8%B1%A1"><span class="toc-number">14.</span> <span class="toc-text">返回空的对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8dict%E7%9A%84copy%E5%87%BD%E6%95%B0"><span class="toc-number">15.</span> <span class="toc-text">使用dict的copy函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%8F%98%E9%87%8F%E5%92%8C%E5%AE%9E%E4%BE%8B%E5%8F%98%E9%87%8F"><span class="toc-number">16.</span> <span class="toc-text">如何定义类变量和实例变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AA%E4%BD%BF%E7%94%A8%E4%B8%80%E6%AC%A1%E7%9A%84%E5%87%BD%E6%95%B0%E5%B0%B1%E6%B2%A1%E6%9C%89%E5%BF%85%E8%A6%81%E5%B0%81%E8%A3%85"><span class="toc-number">17.</span> <span class="toc-text">只使用一次的函数就没有必要封装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E6%84%8Fdivmod%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">18.</span> <span class="toc-text">注意divmod的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sqlalchemy%E7%9A%84%E5%A4%8D%E6%9D%82%E4%BD%BF%E7%94%A8"><span class="toc-number">19.</span> <span class="toc-text">Sqlalchemy的复杂使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Marshmallow"><span class="toc-number">20.</span> <span class="toc-text">Marshmallow</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A4%E6%96%AD%E6%98%AFlinux%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">21.</span> <span class="toc-text">判断是linux的方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#enter-%E5%92%8C-exit"><span class="toc-number">22.</span> <span class="toc-text">__enter__和__exit__</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#js%E5%88%A4%E6%96%AD%E6%98%AF%E5%90%A6%E5%8C%85%E5%90%AB%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-number">23.</span> <span class="toc-text">js判断是否包含的函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#posgresql%E6%8F%92%E5%85%A5%E6%95%B0%E7%BB%84"><span class="toc-number">24.</span> <span class="toc-text">posgresql插入数组</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#flask-wtf%E9%81%BF%E5%85%8Dchoices%E8%A2%AB%E6%97%A0%E9%99%90append%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">25.</span> <span class="toc-text">flask_wtf避免choices被无限append的方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#flask%E9%80%89%E6%8B%A9%E6%80%A7filter%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">26.</span> <span class="toc-text">flask选择性filter的最佳实践</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#flask%E7%9A%84model%E4%BD%BF%E7%94%A8property%E6%A8%A1%E4%BB%BF%E5%A4%96%E9%94%AE"><span class="toc-number">27.</span> <span class="toc-text">flask的model使用property模仿外键</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bind-key-%E7%BC%BA%E5%A4%B1%E9%97%AE%E9%A2%98"><span class="toc-number">28.</span> <span class="toc-text">__bind_key__缺失问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Flask-%E6%8A%A5%E9%94%99-422-%E9%94%99%E8%AF%AF"><span class="toc-number">29.</span> <span class="toc-text">Flask 报错 422 错误</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#html-%E4%BD%BF%E7%94%A8%E5%81%87%E8%A1%A8%E5%8D%95%E6%9D%A5%E6%8F%90%E4%BA%A4"><span class="toc-number">30.</span> <span class="toc-text">html 使用假表单来提交</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#input-%E7%9A%84-required-%E5%B1%9E%E6%80%A7%E5%A4%B1%E6%95%88"><span class="toc-number">31.</span> <span class="toc-text">input 的 required 属性失效</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Form-%E7%9A%84-name-%E5%B1%9E%E6%80%A7"><span class="toc-number">32.</span> <span class="toc-text">Form 的 name 属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sql%E7%9A%84%E5%86%99%E6%B3%95"><span class="toc-number">33.</span> <span class="toc-text">sql的写法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#python3%E4%BD%BF%E7%94%A8use-kwargs"><span class="toc-number">34.</span> <span class="toc-text">python3使用use_kwargs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#python2%E4%BD%BF%E7%94%A8use-kwargs"><span class="toc-number">35.</span> <span class="toc-text">python2使用use_kwargs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8SqlalchemyPages"><span class="toc-number">36.</span> <span class="toc-text">使用SqlalchemyPages</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#wtform%E7%9A%84%E6%89%80%E6%9C%89field"><span class="toc-number">37.</span> <span class="toc-text">wtform的所有field</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Wtform%E7%9A%84validate-on-submit-%E9%AA%8C%E8%AF%81%E9%97%AE%E9%A2%98"><span class="toc-number">38.</span> <span class="toc-text">Wtform的validate_on_submit()验证问题</span></a></li></ol></details></div><div class="container post-content"><h2 id="sql-的-语法"><a href="#sql-的-语法" class="headerlink" title="sql 的 =:语法"></a>sql 的 <code>=:</code>语法</h2><ul>
<li>通过<code>=：变量名</code>的方式，在具体调用的时候传入参数，是防止sql注入的写法</li>
</ul>
<p><code>user_id = 1</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WHERE</span> userv2_user.user_id <span class="operator">=</span> :user_id</span><br></pre></td></tr></table></figure>



<h2 id="快速创建namedtuple"><a href="#快速创建namedtuple" class="headerlink" title="快速创建namedtuple"></a>快速创建namedtuple</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user = namedtuple(<span class="string">&quot;User&quot;</span>, user_dict.keys())(*user_dict.values())</span><br></pre></td></tr></table></figure>



<h2 id="Flask-Schema"><a href="#Flask-Schema" class="headerlink" title="Flask Schema"></a>Flask Schema</h2><p>注意 可以自己创建使用<code>DateRangeField</code>,<code>OrderField</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;start_date&quot;</span>: DateRangeField(label=<span class="string">&quot;date_range&quot;</span>, first=<span class="literal">True</span>, missing=<span class="keyword">lambda</span>: <span class="string">&quot;&quot;</span>),</span><br><span class="line"><span class="string">&quot;end_date&quot;</span>: DateRangeField(label=<span class="string">&quot;date_range&quot;</span>, last=<span class="literal">True</span>, missing=<span class="keyword">lambda</span>: <span class="string">&quot;&quot;</span>),</span><br><span class="line"> <span class="string">&quot;order&quot;</span>: OrderField(</span><br><span class="line">        missing=<span class="string">&quot;user_all_recharge desc&quot;</span>,</span><br><span class="line">        _<span class="keyword">in</span>=[<span class="string">&quot;user_all_recharge&quot;</span>, <span class="string">&quot;recharge_money&quot;</span>, <span class="string">&quot;last_logindate&quot;</span>,</span><br><span class="line">             <span class="string">&quot;last_paydate&quot;</span>, <span class="string">&quot;role_money&quot;</span>]</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> marshmallow.fields <span class="keyword">import</span> Field</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DateRangeField</span>(<span class="params">Field</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;missing&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> kwargs:</span><br><span class="line">            kwargs.update(&#123;<span class="string">&quot;missing&quot;</span>: datetime.date.today&#125;)</span><br><span class="line">        <span class="built_in">super</span>(DateRangeField, self).__init__(required=<span class="literal">True</span>, *args, **kwargs)</span><br><span class="line">        self.is_first = kwargs.get(<span class="string">&quot;first&quot;</span>, <span class="literal">False</span>)</span><br><span class="line">        self.is_last = kwargs.get(<span class="string">&quot;last&quot;</span>, <span class="literal">False</span>)</span><br><span class="line">        self.label = kwargs.get(<span class="string">&quot;label&quot;</span>, <span class="string">&quot;date_range&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_deserialize</span>(<span class="params">self, value, attr, data</span>):</span></span><br><span class="line">        _data = request.args.to_dict()</span><br><span class="line">        _default = datetime.date.today()</span><br><span class="line">        v = _data.get(self.label, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> v:</span><br><span class="line">            <span class="keyword">return</span> self.missing()</span><br><span class="line">        <span class="keyword">if</span> self.is_first:</span><br><span class="line">            _index = <span class="number">0</span></span><br><span class="line">        <span class="keyword">elif</span> self.is_last:</span><br><span class="line">            _index = -<span class="number">1</span></span><br><span class="line"></span><br><span class="line">        v = v.split(<span class="string">u&quot;到&quot;</span>)[_index].strip()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            v = datetime.datetime.strptime(v, <span class="string">&quot;%Y-%m-%d&quot;</span>).date()</span><br><span class="line">        <span class="keyword">except</span> ValueError, e:</span><br><span class="line">            <span class="keyword">return</span> _default</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> v</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IntegerField</span>(<span class="params">Field</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;ID查询框</span></span><br><span class="line"><span class="string">    - 可以不填值, 不填值或者不合合法值一律None</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(IntegerField, self).__init__(missing=<span class="literal">None</span>, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_deserialize</span>(<span class="params">self, value, attr, data</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> value:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> value.isdigit():</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        value = <span class="built_in">int</span>(value)</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderField</span>(<span class="params">Field</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;排序字段</span></span><br><span class="line"><span class="string">    - 可以不填值, 不填值或者不合合法值一律None</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(OrderField, self).__init__(*args, **kwargs)</span><br><span class="line">        self.columns = kwargs.get(<span class="string">&quot;_in&quot;</span>, [])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_deserialize</span>(<span class="params">self, value, attr, data</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;order=id desc,create_time asc&quot;&quot;&quot;</span></span><br><span class="line">        value = [ item.split() <span class="keyword">for</span> item <span class="keyword">in</span> value.split(<span class="string">&quot;,&quot;</span>) ]</span><br><span class="line">        value = [</span><br><span class="line">            item <span class="keyword">for</span> item <span class="keyword">in</span> value</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(item) &lt; <span class="number">3</span></span><br><span class="line">                <span class="keyword">and</span> (</span><br><span class="line">                    <span class="built_in">len</span>(item) == <span class="number">1</span> <span class="keyword">or</span> (</span><br><span class="line">                        <span class="built_in">len</span>(item) == <span class="number">2</span> <span class="keyword">and</span></span><br><span class="line">                        item[-<span class="number">1</span>] <span class="keyword">in</span> (<span class="string">&quot;asc&quot;</span>, <span class="string">&quot;desc&quot;</span>)</span><br><span class="line">                    )</span><br><span class="line">                )</span><br><span class="line">                <span class="keyword">and</span> (</span><br><span class="line">                    self.columns <span class="keyword">and</span> item[<span class="number">0</span>] <span class="keyword">in</span> self.columns</span><br><span class="line">                )</span><br><span class="line">        ]</span><br><span class="line">        value = <span class="string">&quot;,&quot;</span>.join([ <span class="string">&quot; &quot;</span>.join(item) <span class="keyword">for</span> item <span class="keyword">in</span> value])</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span> <span class="keyword">if</span> value == <span class="string">&quot;&quot;</span> <span class="keyword">else</span> value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListField</span>(<span class="params">Field</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;多ID查询框</span></span><br><span class="line"><span class="string">    - 可以不填值, 不填值或者不合合法值一律None</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(ListField, self).__init__(missing=<span class="string">&quot;&quot;</span>, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_deserialize</span>(<span class="params">self, value, attr, data</span>):</span></span><br><span class="line">        result = []</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> value: <span class="keyword">return</span> []</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> value.split(<span class="string">&quot;,&quot;</span>):</span><br><span class="line">            <span class="keyword">if</span> item.isdigit():</span><br><span class="line">                result.append(<span class="built_in">int</span>(item))</span><br><span class="line">        <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>



<h2 id="使用schema处理参数"><a href="#使用schema处理参数" class="headerlink" title="使用schema处理参数"></a>使用schema处理参数</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderField</span>(<span class="params">Field</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;排序字段&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_deserialize</span>(<span class="params">self, value, attr, data, **kwargs</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;根据order , 生成sql中order的语句</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :return: str &quot;report_date desc,app_name,profit_bxm desc&quot;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        order_by_li = []</span><br><span class="line">        <span class="keyword">for</span> o <span class="keyword">in</span> value.split(<span class="string">&#x27;,&#x27;</span>):</span><br><span class="line">            field, mode = o.split(<span class="string">&#x27;+&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> mode == <span class="string">&#x27;desc&#x27;</span>:</span><br><span class="line">                order_by_li.append(<span class="string">f&#x27;<span class="subst">&#123;field&#125;</span> desc&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                order_by_li.append(field)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;,&#x27;</span>.join(order_by_li)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GroupField</span>(<span class="params">Field</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;组合字段&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_deserialize</span>(<span class="params">self, value, attr, data, **kwargs</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;根据group , 生成sql中group的字段</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :return: str</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        group_mapping = &#123;</span><br><span class="line">            <span class="string">&#x27;all&#x27;</span>: <span class="string">&#x27;all&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;user_name&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;app&#x27;</span>: <span class="string">&#x27;app_name&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;media&#x27;</span>: <span class="string">&#x27;media&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> group_mapping[value]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FilterField</span>(<span class="params">Field</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;过滤字段&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_deserialize</span>(<span class="params">self, value, attr, data, **kwargs</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;根据filter_string , 过滤的字典</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :return: dict &#123;&#x27;app&#x27;:&#x27;app1&#x27;, &#x27;user&#x27;:&#x27;user1&#x27;&#125;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        d = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> f <span class="keyword">in</span> value.split(<span class="string">&#x27;,&#x27;</span>):</span><br><span class="line">            field, val = f.split(<span class="string">&#x27;+&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> val == <span class="string">&#x27;all&#x27;</span>:</span><br><span class="line">                d[field] = val</span><br><span class="line">        <span class="keyword">return</span> d</span><br></pre></td></tr></table></figure>



<h2 id="线上线下不同配置"><a href="#线上线下不同配置" class="headerlink" title="线上线下不同配置"></a>线上线下不同配置</h2><p>对于线上线下不同的配置,我们可以使用<code>current_app.config.get(&quot;DEBUG&quot;, False)</code>来判别</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">role_required</span>(<span class="params">fail_msg,redirect_end_point</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapped</span>(<span class="params">func</span>):</span></span><br><span class="line"><span class="meta">        @wraps(<span class="params">func</span>)</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">decorated</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">            <span class="keyword">if</span> current_app.config.get(<span class="string">&quot;DEBUG&quot;</span>, <span class="literal">False</span>):</span><br><span class="line">                <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> current_user.is_authenticated <span class="keyword">or</span> current_user.uid <span class="keyword">not</span> <span class="keyword">in</span> ALLOWED_USERS:</span><br><span class="line">                flash(fail_msg, category=<span class="string">&#x27;error&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span> redirect(url_for(redirect_end_point))</span><br><span class="line">            <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> decorated</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapped</span><br></pre></td></tr></table></figure>



<h2 id="coalesce语句"><a href="#coalesce语句" class="headerlink" title="coalesce语句"></a>coalesce语句</h2><p>COALESCE是一个函数， (expression_1, expression_2, …,expression_n)依次参考各参数表达式，遇到非null值即停止并返回该值。如果所有的表达式都是空值，最终将返回一个空值。使用COALESCE在于大部分包含空值的表达式最终将返回空值。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">coalesce</span>(success_cnt, <span class="number">1</span>) <span class="keyword">from</span> tableA</span><br></pre></td></tr></table></figure>



<h2 id="sql的执行顺序"><a href="#sql的执行顺序" class="headerlink" title="sql的执行顺序"></a>sql的执行顺序</h2><p>mysql中的SQL语句执行是有一定顺序的，如下：</p>
<ol>
<li>from</li>
<li>on</li>
<li>join</li>
<li>where</li>
<li>group by</li>
<li>with</li>
<li>having</li>
<li><code>select</code></li>
<li>distinct</li>
<li>order by</li>
<li>limit</li>
</ol>
<p>一条SQL会经过这11步的，中间的每一步都会生成一张虚拟表，后面的步骤都是在上一张虚拟表中进行筛选与查询的</p>
<blockquote>
<p>select的执行顺序是排在第8步的，而select是针对以上几步生成的虚拟表进行操作的，所以你所要使用的字段，如果虚拟表中不存在，那么则会报错</p>
</blockquote>
<blockquote>
<p>错 :</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">SUM</span>(field1 <span class="operator">+</span> field2) <span class="keyword">AS</span> col1, col1 <span class="operator">+</span> field3 <span class="keyword">AS</span> col3 <span class="keyword">from</span> core</span><br></pre></td></tr></table></figure>

<p>对 :</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> col1,  col1 <span class="operator">+</span> field3 <span class="keyword">AS</span> col3 </span><br><span class="line"><span class="keyword">FROM</span>   (</span><br><span class="line">       <span class="keyword">SELECT</span>  field1 <span class="operator">+</span> field2 <span class="keyword">as</span> col1 ,  field3</span><br><span class="line">       <span class="keyword">from</span> core</span><br><span class="line">       ) <span class="keyword">as</span> SubQueryAlias</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="db-session-query-obj-的扁平化处理"><a href="#db-session-query-obj-的扁平化处理" class="headerlink" title="db.session.query(obj)的扁平化处理"></a>db.session.query(obj)的扁平化处理</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">appid_query = db.session.query(</span><br><span class="line">    func.distinct(VerifyEventLog.app_id),</span><br><span class="line">).<span class="built_in">filter</span>(</span><br><span class="line">    or_(VerifyEventLog.extra_hs[<span class="string">&#x27;sdk_version&#x27;</span>] == obj.version_code,</span><br><span class="line">        VerifyEventLog.extra_hs[<span class="string">&#x27;sdk_id&#x27;</span>] == <span class="built_in">str</span>(obj.<span class="built_in">id</span>))</span><br><span class="line">)</span><br><span class="line">appid_list = <span class="built_in">list</span>(chain(*appid_query.<span class="built_in">all</span>()))</span><br></pre></td></tr></table></figure>



<h2 id="资源上传的通用操作"><a href="#资源上传的通用操作" class="headerlink" title="资源上传的通用操作"></a>资源上传的通用操作</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@index_router.route(<span class="params"><span class="string">&quot;/upload&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>,]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;资源上传&quot;&quot;&quot;</span></span><br><span class="line">    upload_file = request.files.get(<span class="string">&quot;upload_file&quot;</span>)</span><br><span class="line">    fname_suffix = upload_file.filename.split(<span class="string">&quot;.&quot;</span>)[-<span class="number">1</span>].lower()</span><br><span class="line"></span><br><span class="line">    fname_prefix = <span class="string">&quot;upload&quot;</span></span><br><span class="line">    fname_md5 = hashlib.md5(upload_file.read()).hexdigest()</span><br><span class="line">    fname = <span class="string">&quot;.&quot;</span>.join([fname_prefix, fname_md5, fname_suffix])</span><br><span class="line">    fpath = current_app.config[<span class="string">&quot;STATIC_FILE_UPLOAD_PATH&quot;</span>] + fname</span><br><span class="line">    data = current_app.config[<span class="string">&quot;STATIC_FILE_HOST&quot;</span>] + fname</span><br><span class="line">    upload_file.seek(<span class="number">0</span>)</span><br><span class="line">    upload_file.save(fpath)</span><br><span class="line">    <span class="keyword">if</span> request.args.has_key(<span class="string">&quot;_is_wang_editor&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span> jsonify(</span><br><span class="line">            errno=<span class="number">0</span>,</span><br><span class="line">            data=[data]</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">elif</span> request.args.has_key(<span class="string">&quot;_jquery_file_upload&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span> jsonify(</span><br><span class="line">            errno=<span class="number">0</span>,</span><br><span class="line">            data=data</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> jsonify(</span><br><span class="line">            state=<span class="number">1</span>,</span><br><span class="line">            code=<span class="string">&quot;200&quot;</span>,</span><br><span class="line">            data=data</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>



<h2 id="sqlalchemy的复杂操作"><a href="#sqlalchemy的复杂操作" class="headerlink" title="sqlalchemy的复杂操作"></a>sqlalchemy的复杂操作</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> func, text</span><br><span class="line"></span><br><span class="line">query = db.session.query(</span><br><span class="line">    VerifyEventLog.idfa,</span><br><span class="line">    func.count(VerifyEventLog.<span class="built_in">id</span>).label(<span class="string">&quot;count&quot;</span>),</span><br><span class="line">    func.<span class="built_in">max</span>(VerifyEventLog.log_time).label(<span class="string">&quot;latest_time&quot;</span>),</span><br><span class="line">).<span class="built_in">filter</span>(</span><br><span class="line">    VerifyEventLog.idfa != <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">).group_by(</span><br><span class="line">    VerifyEventLog.idfa,</span><br><span class="line">).order_by(</span><br><span class="line">    text(<span class="string">&quot;count desc&quot;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">query = db.session.query(</span><br><span class="line">    func.distinct(VerifyEventLog.log_time).label(<span class="string">&#x27;log_time&#x27;</span>),</span><br><span class="line">    VerifyEventLog.idfa,</span><br><span class="line">    VerifyApp.bundle_id,</span><br><span class="line">    VerifyApp.bundle_name</span><br><span class="line">).join(</span><br><span class="line">    VerifyApp,</span><br><span class="line">    VerifyApp.app_id == VerifyEventLog.app_id</span><br><span class="line">).<span class="built_in">filter</span>(</span><br><span class="line">    VerifyEventLog.idfa == idfa</span><br><span class="line">).order_by(</span><br><span class="line">    VerifyEventLog.log_time.desc(),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意 上面两种<code>order_by</code>的方法</p>
</blockquote>
<h2 id="原则"><a href="#原则" class="headerlink" title="原则"></a>原则</h2><ol>
<li>可读性第一</li>
<li>快速失败，灵活使用断言保护代码。契约式编程(先验条件和后置条件)，越早失败，越容易排查错误。</li>
<li>隐藏复杂性。如果复杂性避免不了，应该尽让内部复杂，接口要保持简单易用</li>
<li>不要直接吞掉任何非预知错误和异常</li>
<li>命名尽量要可以看出类型，比如复数表示容器类型，nums，cnts等后缀表示数值(通过后缀和词性来使名称更容易被推断出来含义，比如是属性还是方法)</li>
<li>传入了一个嵌套字典需要注释</li>
<li>保持函数参数和返回值尽量使用简单数据类型</li>
<li>函数要么修改传入的可变参数，要么返回一个值。请不要两者同时做。尽量不要直接修改传入的可变参数而是返回一个新的结果。</li>
<li>返回多个值可以使用namedtuple封装，比用下标更直观。对于可能经常需要变动的返回值，返回字典或者对象要比返回tuple容易修改。</li>
<li>函数尽量返回相同的类型</li>
<li>参数过多的时候推荐调用的地方显示写出参数名 f(a=1,b=2)。建议一个函数传参 5 个以上以后参数就指定参数名进行传递，防止参数不匹配导致的 bug。</li>
<li>如果没有特殊的性能需求，函数返回值尽量使用marshmallow之类序列化，之前的很多项目直接搞一个 dict 各种往里边塞字段然后返回，很难看清楚返回的啥结构，维护起来很累。</li>
<li>保持类的继承层级简单，适当使用mixin。</li>
<li>注意尽量不要在非 <code>__init__</code> 方法中给类赋值属性，笔者在维护别人代码的过程中，发现经常在一些非 init 方法种赋值新的属性，导致后期难以维护，根本不知道这个对象包含哪些属性，删除一个属性的时候坑也多。</li>
<li>基于代码行为测试，不要片面追求测试覆盖率。</li>
<li>获取对象的时候尽量传入需要的字段(数据表列)，减少数据传输同时还能避免拼对象的时间消耗</li>
<li>数据库30条军规</li>
<li>一个类、函数等如果难以用一句话描述它的职责，很有可能就违背了SRP（单一职责原则）。</li>
<li>对于复杂的数据结构(比如嵌套类型)，可以适当注释出类型，比如最新的 tornado 源码里出现了这种注释 <code> __impl_kwargs = None # type: Dict[str, Any]</code> </li>
<li>当一个函数是另一个函数的私有函数的时候 , 可以设计成闭包</li>
<li>每个 commit 都是独立的小功能，可以单独回滚。</li>
<li>基本上代码的耗时是遵守2/8定律的，集中优化最耗时的代码，衡量成本和收益。</li>
<li><strong>优先从数据结构、算法、数据库、网络IO等层面优化</strong></li>
<li>不要频繁使用诸如data，info，result，handle，process等概念太广泛的词汇给变量命名</li>
<li>给函数命名的一个好办法：首先考虑应该给这个函数写上一句怎样的注释，然后想办法将注释变成函数名称。</li>
<li>用下划线前缀定义一个临时使用的变量</li>
<li>使用下划线开头区分是内部函数还是提供给外部调用</li>
</ol>
<h2 id="拼接url参数的方法"><a href="#拼接url参数的方法" class="headerlink" title="拼接url参数的方法"></a>拼接url参数的方法</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">nv = []</span><br><span class="line">nv += [_from_value(n, q) <span class="keyword">for</span> n, q <span class="keyword">in</span></span><br><span class="line">       [(<span class="string">&#x27;p&#x27;</span>, page), (<span class="string">&#x27;n&#x27;</span>, per_page), (<span class="string">&#x27;b&#x27;</span>, <span class="built_in">int</span>(banned)),</span><br><span class="line">        (<span class="string">&#x27;v&#x27;</span>, <span class="built_in">int</span>(suspected))] <span class="keyword">if</span> q]</span><br><span class="line">nv += [_from_dict(n, q) <span class="keyword">for</span> n, q <span class="keyword">in</span></span><br><span class="line">       [(<span class="string">&#x27;e&#x27;</span>, filters), (<span class="string">&#x27;k&#x27;</span>, keywords), (<span class="string">&#x27;l&#x27;</span>, lower), (<span class="string">&#x27;u&#x27;</span>, upper),</span><br><span class="line">        (<span class="string">&#x27;s&#x27;</span>, orders)] <span class="keyword">if</span> q]</span><br><span class="line">nv = [t <span class="keyword">for</span> t <span class="keyword">in</span> nv <span class="keyword">if</span> t]</span><br><span class="line"><span class="comment"># import</span></span><br><span class="line">qs = <span class="string">&#x27;?&#x27;</span> + <span class="string">&#x27;&amp;&#x27;</span>.join(nv)</span><br></pre></td></tr></table></figure>



<h2 id="对于request请求-不要在request函数里添加status的判断"><a href="#对于request请求-不要在request函数里添加status的判断" class="headerlink" title="对于request请求 , 不要在request函数里添加status的判断"></a>对于request请求 , 不要在request函数里添加status的判断</h2><p>因为如果在request方法里判断status , 就可能返回None , 然后在调用request的方法中还要判断是否返回的是None . 还不如如下使用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_request</span>(<span class="params">method, url, **kwargs</span>):</span></span><br><span class="line">    timeout = current_app.config[<span class="string">&#x27;GAME_REQUEST_TIMEOUT&#x27;</span>]</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        res = requests.request(method, url, timeout=timeout, **kwargs)</span><br><span class="line">        res.raise_for_status()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">url, params=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> _request(<span class="string">&#x27;GET&#x27;</span>, url, params=params)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request_failed</span>(<span class="params">res</span>):</span></span><br><span class="line">    <span class="keyword">return</span> res <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="keyword">not</span> res.json()[<span class="string">&#x27;state&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line"><span class="meta">@classmethod</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_blocked</span>(<span class="params">cls, <span class="built_in">id</span></span>):</span></span><br><span class="line">    res = get(cls.is_blocked_url.<span class="built_in">format</span>(<span class="built_in">id</span>))</span><br><span class="line">    <span class="keyword">if</span> request_failed(res):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> res.json()[<span class="string">&#x27;data&#x27;</span>]</span><br></pre></td></tr></table></figure>



<h2 id="返回空的对象"><a href="#返回空的对象" class="headerlink" title="返回空的对象"></a>返回空的对象</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pagination</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    total = <span class="literal">None</span></span><br><span class="line">    has_prev = <span class="literal">False</span></span><br><span class="line">    has_next = <span class="literal">False</span></span><br><span class="line">    page = <span class="number">1</span></span><br><span class="line">    per_page = <span class="number">20</span></span><br><span class="line">    items = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, data=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="keyword">if</span> data <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        self.items = data[<span class="string">&#x27;data&#x27;</span>]</span><br><span class="line">        self.has_prev = data[<span class="string">&#x27;prev&#x27;</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line">        self.has_next = data[<span class="string">&#x27;next&#x27;</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line">        self.page = data[<span class="string">&#x27;page&#x27;</span>]</span><br><span class="line">        self.per_page = data[<span class="string">&#x27;per_page&#x27;</span>]</span><br><span class="line">        self.total = data[<span class="string">&#x27;total&#x27;</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@classmethod</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">history</span>(<span class="params">cls, **kwargs</span>):</span></span><br><span class="line">    res = get(cls.history_url, params=kwargs)</span><br><span class="line">    <span class="keyword">if</span> request_failed(res):</span><br><span class="line">        <span class="comment"># 不是返回None</span></span><br><span class="line">        <span class="keyword">return</span> Pagination()</span><br><span class="line">    <span class="keyword">return</span> Pagination(res.json()[<span class="string">&#x27;data&#x27;</span>])</span><br></pre></td></tr></table></figure>



<h2 id="使用dict的copy函数"><a href="#使用dict的copy函数" class="headerlink" title="使用dict的copy函数"></a>使用dict的copy函数</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x = &#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;hyl&#x27;</span>&#125;</span><br><span class="line">y = x.copy()</span><br><span class="line"><span class="built_in">print</span>(y)</span><br></pre></td></tr></table></figure>



<h2 id="如何定义类变量和实例变量"><a href="#如何定义类变量和实例变量" class="headerlink" title="如何定义类变量和实例变量"></a>如何定义类变量和实例变量</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlockWord</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    base_url = BaseConfig.GAME_CHAT_API</span><br><span class="line">    search_url = base_url + <span class="string">&#x27;/words/block&#x27;</span></span><br><span class="line">    add_url = base_url + <span class="string">&#x27;/words/block&#x27;</span></span><br><span class="line">    remove_url = base_url + <span class="string">&#x27;/words/block&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">search</span>(<span class="params">cls, **kwargs</span>):</span></span><br><span class="line">        res = get(cls.search_url, params=kwargs)</span><br><span class="line">        <span class="keyword">if</span> request_failed(res):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">return</span> Pagination(res.json()[<span class="string">&#x27;data&#x27;</span>])</span><br></pre></td></tr></table></figure>

<p>定义变量的时候应该考虑 , 这个变量是属于类的 , 还是属于实例的 . </p>
<ul>
<li>如果是属于类的 , 就应该定义为类变量 , 如果是属于实例的 , 就应该定义在<code>__init__</code>里面 </li>
<li>如果在定义时就确定下来的变量, 就可以写成类变量 , 运行时才确定下来的 , 写成实例变量</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RefreshApp</span>:</span></span><br><span class="line">    __REDIS_KEY__ = <span class="string">&quot;app_data_game&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.config = current_app.config</span><br><span class="line">        self.client = self._init_redis()</span><br></pre></td></tr></table></figure>

<ul>
<li>redis_key , 就是好存储的键 , 这是已经确定下来的键 , 写成类变量</li>
<li>config要从current_app里拿 , client需要连接 , 都是在运行时才确定下来的 , 写成实例变量</li>
</ul>
<h2 id="只使用一次的函数就没有必要封装"><a href="#只使用一次的函数就没有必要封装" class="headerlink" title="只使用一次的函数就没有必要封装"></a>只使用一次的函数就没有必要封装</h2><h2 id="注意divmod的使用"><a href="#注意divmod的使用" class="headerlink" title="注意divmod的使用"></a>注意divmod的使用</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">to_natural_time</span>(<span class="params">seconds</span>):</span></span><br><span class="line">    result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    units = [(<span class="string">&#x27;天&#x27;</span>, <span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>), (<span class="string">&#x27;小时&#x27;</span>, <span class="number">60</span>*<span class="number">60</span>), (<span class="string">&#x27;分钟&#x27;</span>, <span class="number">60</span>), (<span class="string">&#x27;秒&#x27;</span>, <span class="number">1</span>)]</span><br><span class="line">    r = seconds</span><br><span class="line">    <span class="keyword">for</span> s, d <span class="keyword">in</span> units:</span><br><span class="line">        q, r = <span class="built_in">divmod</span>(r, d)</span><br><span class="line">        <span class="keyword">if</span> q &gt; <span class="number">0</span>:</span><br><span class="line">            result += <span class="string">&#x27;&#123;&#125;&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(q, s)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">x = to_natural_time(<span class="number">111111</span>)</span><br><span class="line"><span class="built_in">print</span>(x) <span class="comment"># 1天6小时51分钟51秒</span></span><br></pre></td></tr></table></figure>



<h2 id="Sqlalchemy的复杂使用"><a href="#Sqlalchemy的复杂使用" class="headerlink" title="Sqlalchemy的复杂使用"></a>Sqlalchemy的复杂使用</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">User.query.<span class="built_in">filter</span>(User.username.endswith(<span class="string">&#x27;@example.com&#x27;</span>)).<span class="built_in">all</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模糊查询</span></span><br><span class="line">User.query.<span class="built_in">filter</span>(User.name.like(<span class="string">&#x27;xxx%&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># and 查询</span></span><br><span class="line">User.query.<span class="built_in">filter</span>(and_(User.name == <span class="string">&#x27;Python&#x27;</span>,User.<span class="built_in">id</span>==<span class="number">2</span>))</span><br><span class="line"><span class="comment">#或者</span></span><br><span class="line">User.query.<span class="built_in">filter</span>(User.name == <span class="string">&#x27;Python&#x27;</span>, User.<span class="built_in">id</span> == <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 原生查询</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> text</span><br><span class="line">User.query.<span class="built_in">filter</span>(text(<span class="string">&#x27;id&gt;=:value1 and id &lt;:value2&#x27;</span>)).params(value1=<span class="number">2</span>,value2=<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 完整 sql 语句查询</span></span><br><span class="line">User.query.from_statement(text(<span class="string">&quot;select * from tags where id=:value&quot;</span>)).params(value=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 原生查询数据数量</span></span><br><span class="line">db.session.execute(<span class="string">&quot;SELECT COUNT(*) FROM table&quot;</span>).scalar()</span><br><span class="line"></span><br><span class="line"><span class="comment"># group by 统计数据</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> func</span><br><span class="line">db.session.query(Model).with_entities(Model.field, func.count(Model.field)).group_by(field).<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure>



<h2 id="Marshmallow"><a href="#Marshmallow" class="headerlink" title="Marshmallow"></a>Marshmallow</h2><ul>
<li><p>Marshmallow 很好的实现了 <code>object -&gt; dict</code> ， <code>objects -&gt; list</code>， <code>string -&gt; dict</code>和 <code>string -&gt; list</code>。</p>
</li>
<li><p>要对一个类（记为<code>Class_A</code>，以便表达）进行序列化和反序列化，首先要创建一个与之对应的类（记<code>Class_A&#39;</code>），负责实现<code>Class_A</code>的序列化、序列化和数据校验等，**<code>Class_A&#39;</code>就是schema**</p>
</li>
<li><p>Schema是序列化功能的载体，每个需要被序列化或反序列化的类，都要设计一个相应的Schema，以实现相关功能。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSchema</span>(<span class="params">Schema</span>):</span></span><br><span class="line">    name = fields.Str()</span><br><span class="line">    email = fields.Email()</span><br><span class="line">    created_at = fields.DateTime()</span><br></pre></td></tr></table></figure></li>
<li><p>序列化使用schema中的<code>dump()</code>或<code>dumps()</code>方法，</p>
<ul>
<li><code>dump()</code> 方法实现<code>obj -&gt; dict</code>，</li>
<li><code>dumps()</code>方法实现 <code>obj -&gt; string</code>，</li>
</ul>
</li>
<li><p>反序列化基于schema中的<code>load()</code>或<code>loads()</code>方法</p>
<p><code>load()</code>方法将一个传入的<code>dict</code>，结合schema的约定，再转换为一个<code>dict</code>，而<code>loads()</code>方法的传入参数是<code>json格式的string</code>，同样将传入数据转换为符合规范的<code>dict</code>。</p>
</li>
<li></li>
</ul>
<h2 id="判断是linux的方法"><a href="#判断是linux的方法" class="headerlink" title="判断是linux的方法"></a>判断是linux的方法</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sys.platform.startswith(<span class="string">&quot;linux&quot;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="enter-和-exit"><a href="#enter-和-exit" class="headerlink" title="__enter__和__exit__"></a><code>__enter__</code>和<code>__exit__</code></h2><ul>
<li><code>__enter(self)__</code> : 负责返回一个值，该返回值将赋值给as子句后面的var_name，通常返回对象自己，即“self”。函数优先于with后面的“代码块”(statements1,statements2,……)被执行。</li>
<li><code>__exit__(self, exc_type, exc_val, exc_tb)</code> : 执行完with后面的代码块后自动调用该函数。<strong>with语句后面的“代码块”中有异常(不包括因调用某函数,由被调用函数内部抛出的异常) ，会把异常类型，异常值，异常跟踪信息分别赋值给函数参数exc_type, exc_val, exc_tb</strong>，没有异常的情况下，exc_type, exc_val, exc_tb值都为None。<ul>
<li>如果该函数返回True、1类值的Boolean真值，那么将忽略“代码块”中的异常，停止执行“代码块”中剩余语句，但是会继续执行“代码块”后面的语句；</li>
<li>如果函数返回类似0，False类的Boolean假值、或者没返回值，将抛出“代码块”中的异常，那么在没有捕获异常的情况下，中断“代码块”及“代码块”之后语句的执行</li>
</ul>
</li>
</ul>
<h2 id="js判断是否包含的函数"><a href="#js判断是否包含的函数" class="headerlink" title="js判断是否包含的函数"></a>js判断是否包含的函数</h2><p>查看item这个字符串中 <code>abcd</code>这个子串的索引 , 如果索引不为-1 , 说明包含此子串</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myarr2.filter(<span class="function"><span class="params">item</span> =&gt;</span> item.indexOf(<span class="string">&#x27;abcd&#x27;</span>)&gt;-<span class="number">1</span>);</span><br></pre></td></tr></table></figure>



<h2 id="posgresql插入数组"><a href="#posgresql插入数组" class="headerlink" title="posgresql插入数组"></a>posgresql插入数组</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GameGame</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&quot;game_game&quot;</span></span><br><span class="line">    os_type = db.Column(db.ARRAY(db.SmallInteger), nullable=<span class="literal">False</span>, default=[])</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> home_game_group (</span><br><span class="line">	os_type <span class="type">smallint</span>[] <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#123;&#125;&#x27;</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> home_game_group(os_type) <span class="keyword">VALUES</span> (<span class="string">&#x27;&#123;1,2&#125;&#x27;</span>);</span><br></pre></td></tr></table></figure>



<h2 id="flask-wtf避免choices被无限append的方法"><a href="#flask-wtf避免choices被无限append的方法" class="headerlink" title="flask_wtf避免choices被无限append的方法"></a>flask_wtf避免choices被无限append的方法</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ActicleForm</span>(<span class="params">FlaskForm</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(XgNewsTitleForm, self).__init__(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">        news_title_choices = []</span><br><span class="line">        news_title_choices.extend([</span><br><span class="line">            (i.news_id, i.title)</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> XgNews.query.<span class="built_in">all</span>()]</span><br><span class="line">        )</span><br><span class="line">        self.news_title.choices = news_title_choices</span><br><span class="line"></span><br><span class="line">    news_title = SelectField(</span><br><span class="line">        label=<span class="string">u&quot;新闻标题&quot;</span>,</span><br><span class="line">        coerce=<span class="built_in">int</span>,</span><br><span class="line">        choices=[],</span><br><span class="line">    )</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="flask选择性filter的最佳实践"><a href="#flask选择性filter的最佳实践" class="headerlink" title="flask选择性filter的最佳实践"></a>flask选择性filter的最佳实践</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">filters = []</span><br><span class="line">query = XgKf_issue.query</span><br><span class="line"><span class="keyword">if</span> issue_type:</span><br><span class="line">    filters.append(XgKf_issue.issue_type == issue_type)</span><br><span class="line"><span class="keyword">if</span> title:</span><br><span class="line">    filters.append(XgKf_issue.title.like(<span class="string">&quot;%&quot;</span> + title + <span class="string">&quot;%&quot;</span>))</span><br><span class="line"><span class="keyword">if</span> filters:</span><br><span class="line">    query = query.<span class="built_in">filter</span>(*filters)</span><br></pre></td></tr></table></figure>



<h2 id="flask的model使用property模仿外键"><a href="#flask的model使用property模仿外键" class="headerlink" title="flask的model使用property模仿外键"></a>flask的model使用property模仿外键</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@property </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">config</span>(<span class="params">self</span>):</span> </span><br><span class="line">    config = GameConfigInfo.query.<span class="built_in">filter</span>( GameConfigInfo.game_id == self.game_id).first() </span><br><span class="line">    <span class="keyword">return</span> config</span><br></pre></td></tr></table></figure>



<h2 id="bind-key-缺失问题"><a href="#bind-key-缺失问题" class="headerlink" title="__bind_key__缺失问题"></a><code>__bind_key__</code>缺失问题</h2><p>在连接不到测试服线上的<code>__bind_key__</code>的时候 , 可以在本地创建 </p>
<p>一个数据库连接到<code>__bind_key__</code>对应的键上</p>
<h2 id="Flask-报错-422-错误"><a href="#Flask-报错-422-错误" class="headerlink" title="Flask 报错 422 错误"></a>Flask 报错 422 错误</h2><p>出现这段原因一般是在 web_args 获取时类型转化错误 , 如 </p>
<p>example.com/?args=2 , 后台使用 args:fields.Boolean()获取 , 这种错误的异常栈不会打 </p>
<p>印本行 , 很难 debug</p>
<h2 id="html-使用假表单来提交"><a href="#html-使用假表单来提交" class="headerlink" title="html 使用假表单来提交"></a>html 使用假表单来提交</h2><p>在 html 使用假表单来提交 , 不需要在 jinja2 前端里设置没有表单元素为 display:none , 而 </p>
<p>是在 form 中直接将其设置为 HiddenField</p>
<h2 id="input-的-required-属性失效"><a href="#input-的-required-属性失效" class="headerlink" title="input 的 required 属性失效"></a>input 的 required 属性失效</h2><p>Form 表单在 submit ,会验证各个字段,其中包括 required . 但是如果 </p>
<p>使用 Ajax 发送 $(form).serialize()的 data ,就不会触发字段的验证机制</p>
<h2 id="Form-的-name-属性"><a href="#Form-的-name-属性" class="headerlink" title="Form 的 name 属性"></a>Form 的 name 属性</h2><p>Form 字段 , form 在提交的时候 , input 其实就是将 name:value 构建成一个键值 </p>
<p>对 , 所以 input 标签中必须要用 name 属性 . 如果没有 name 属性 , 那么提交的表单将没 </p>
<p>有这个字段</p>
<h2 id="sql的写法"><a href="#sql的写法" class="headerlink" title="sql的写法"></a>sql的写法</h2><p>如果在join的基础上使用where , 很可能会产生歧义 , 必须使用table.filed方法<br>不过可以使用 join ( select * from … where ) on …<br>这样就将where放在了一张表里 , 就不会产生歧义了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">SELECT home_game_server.ogame_id,</span><br><span class="line">        home_game_server.open_server_time,</span><br><span class="line">        home_game_server.system_os,</span><br><span class="line">        server_name</span><br><span class="line">        FROM home_game_server</span><br><span class="line">        JOIN (</span><br><span class="line">            SELECT home_game_server.ogame_id <span class="keyword">as</span> ogame_id, </span><br><span class="line">            <span class="built_in">max</span>(open_server_time) <span class="keyword">as</span> open_server_time, system_os</span><br><span class="line">            FROM home_game_server </span><br><span class="line">            JOIN home_game_group </span><br><span class="line">            ON home_game_group.game_group_id = home_game_server.ogame_id </span><br><span class="line">            AND home_game_group.status = true</span><br><span class="line">            WHERE open_server_date &gt;= CURRENT_DATE - <span class="number">7</span></span><br><span class="line">            AND open_server_date &lt;= CURRENT_DATE</span><br><span class="line">            %s</span><br><span class="line">            GROUP BY ogame_id, system_os</span><br><span class="line">        ) t1 ON home_game_server.ogame_id = t1.ogame_id</span><br><span class="line">        AND home_game_server.open_server_time = t1.open_server_time</span><br><span class="line">        AND home_game_server.system_os = t1.system_os</span><br><span class="line">        LIMIT %s OFFSET %s;</span><br><span class="line">        <span class="string">&quot;&quot;&quot; % (</span></span><br><span class="line"><span class="string">            &quot; AND system_os = &#x27;%s&#x27;&quot; % os_type if os_type else &quot;&quot;,</span></span><br><span class="line"><span class="string">            page_size,</span></span><br><span class="line"><span class="string">            (page - 1) * page_size</span></span><br><span class="line"><span class="string">        )</span></span><br></pre></td></tr></table></figure>



<h2 id="python3使用use-kwargs"><a href="#python3使用use-kwargs" class="headerlink" title="python3使用use_kwargs"></a>python3使用use_kwargs</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> webargs <span class="keyword">import</span> fields, missing, validate</span><br><span class="line"><span class="keyword">from</span> webargs.flaskparser <span class="keyword">import</span> use_kwargs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@domain_router.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;DELETE&quot;</span>]</span>)</span></span><br><span class="line"><span class="meta">@use_kwargs(<span class="params">&#123;<span class="string">&quot;DomainName&quot;</span>: fields.Str(<span class="params"></span></span></span></span><br><span class="line"><span class="params"><span class="params"><span class="meta">    required=<span class="literal">True</span>,</span></span></span></span><br><span class="line"><span class="params"><span class="params"><span class="meta">    error_messages=&#123;<span class="string">&quot;required&quot;</span>: <span class="string">&quot;缺少域名&quot;</span>&#125;, </span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">&#125;, location=<span class="string">&quot;query&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_domain</span>(<span class="params">DomainName</span>):</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@domain_router.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="meta">@use_kwargs(<span class="params">&#123;<span class="string">&quot;cloud&quot;</span>: fields.Str(<span class="params">required=<span class="literal">False</span>, missing=<span class="string">&#x27;&#x27;</span></span>)&#125;, location=<span class="string">&quot;query&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_domains</span>(<span class="params">cloud</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;domains列表&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;ccccccccc&#x27;</span>, cloud)</span><br><span class="line">    <span class="keyword">if</span> cloud:</span><br><span class="line">        domains = Domains.get_domain_list(cloud)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        domains = Domains.query.<span class="built_in">all</span>()</span><br><span class="line">    data = [domain.to_dict() <span class="keyword">for</span> domain <span class="keyword">in</span> domains]</span><br><span class="line">    <span class="keyword">return</span> JsonpResp().success(data)</span><br></pre></td></tr></table></figure>



<h2 id="python2使用use-kwargs"><a href="#python2使用use-kwargs" class="headerlink" title="python2使用use_kwargs"></a>python2使用use_kwargs</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> webargs.flaskparser <span class="keyword">import</span> use_kwargs</span><br><span class="line"><span class="keyword">from</span> webargs <span class="keyword">import</span> fields, missing, validate</span><br><span class="line"></span><br><span class="line"><span class="meta">@news_router.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="meta">@use_kwargs(<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="meta">    <span class="string">&quot;page&quot;</span>: fields.Integer(<span class="params">missing=<span class="number">1</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">    <span class="string">&quot;title&quot;</span>: fields.Str(<span class="params">missing=<span class="string">&quot;&quot;</span></span>),</span></span></span><br><span class="line"><span class="params"><span class="meta">&#125;</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">news_index</span>(<span class="params">page, title</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;新闻公告列表&quot;&quot;&quot;</span></span><br><span class="line">    query = XgNews.query</span><br><span class="line">    <span class="keyword">if</span> title:</span><br><span class="line">        query = query.<span class="built_in">filter</span>(XgNews.title.like(<span class="string">&#x27;%&#x27;</span> + title + <span class="string">&#x27;%&#x27;</span>))</span><br><span class="line">    page_obj = SqlalchemyPages(query, page, <span class="number">100</span>)</span><br><span class="line">    <span class="keyword">return</span> render_template(</span><br><span class="line">        <span class="string">&quot;news/news_index.html&quot;</span>,</span><br><span class="line">        page_obj=page_obj,</span><br><span class="line">        title=title</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>



<h2 id="使用SqlalchemyPages"><a href="#使用SqlalchemyPages" class="headerlink" title="使用SqlalchemyPages"></a>使用SqlalchemyPages</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BasePages</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, Query, page, per_page</span>):</span></span><br><span class="line">        self.page = page</span><br><span class="line">        self.per_page = per_page</span><br><span class="line">        self.Query = Query</span><br><span class="line">        self.total_count = self._load_count()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_load_count</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pages</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">int</span>(ceil(self.total_count / <span class="built_in">float</span>(self.per_page)))</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">has_prev</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.page &gt; <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">has_next</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.page &lt; self.pages</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">iter_pages</span>(<span class="params">self, left_edge=<span class="number">2</span>, left_current=<span class="number">2</span>, right_current=<span class="number">5</span>, right_edge=<span class="number">2</span></span>):</span></span><br><span class="line">        last = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, self.pages + <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">if</span> num &lt;= left_edge <span class="keyword">or</span> \</span><br><span class="line">               (num &gt; self.page - left_current - <span class="number">1</span> <span class="keyword">and</span> \</span><br><span class="line">                num &lt; self.page + right_current) <span class="keyword">or</span> \</span><br><span class="line">               num &gt; self.pages - right_edge:</span><br><span class="line">                <span class="keyword">if</span> last + <span class="number">1</span> != num:</span><br><span class="line">                    <span class="keyword">yield</span> <span class="literal">None</span></span><br><span class="line">                <span class="keyword">yield</span> num</span><br><span class="line">                last = num</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">list</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SqlalchemyPages</span>(<span class="params">BasePages</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_load_count</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.Query.count()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">list</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.Query.offset((self.page-<span class="number">1</span>)*self.per_page).limit(self.per_page).<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">home_picture_unchecked</span>(<span class="params">page, ogame_id</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;玩家晒图列表(未审核)&quot;&quot;&quot;</span></span><br><span class="line">    query = HomeGamePicture.query.<span class="built_in">filter</span>(</span><br><span class="line">        HomeGamePicture.status == <span class="literal">False</span></span><br><span class="line">    )</span><br><span class="line">    filters = []</span><br><span class="line">    <span class="keyword">if</span> ogame_id:</span><br><span class="line">        filters.append(HomeGamePicture.ogame_id == ogame_id)</span><br><span class="line">    <span class="keyword">if</span> filters:</span><br><span class="line">        query = query.<span class="built_in">filter</span>(*filters)</span><br><span class="line"></span><br><span class="line">    page_obj = SqlalchemyPages(query, page, <span class="number">100</span>)</span><br><span class="line">    <span class="keyword">return</span> render_template(</span><br><span class="line">        <span class="string">&quot;home/home_strategy/home_picture_unchecked.html&quot;</span>, page_obj=page_obj)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; render_pagination(page_obj) &#125;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#123;% macro render_pagination(pagination) %&#125;</span><br><span class="line">    &lt;nav&gt;</span><br><span class="line">        &lt;ul class=&quot;pagination&quot;&gt;</span><br><span class="line">            &#123;% if pagination.has_prev %&#125;</span><br><span class="line">                &lt;li&gt;&lt;a href=&quot;?page=&#123;&#123; pagination.page - 1 &#125;&#125;&amp;&#123;&#123; request.args|page_args &#125;&#125;&quot;&gt;«&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">            &#123;% else %&#125;</span><br><span class="line">                &lt;li class=&quot;disabled&quot;&gt;&lt;a href=&quot;#&quot;&gt;«&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">            &#123;% endif %&#125;</span><br><span class="line">            &#123;%- for page in pagination.iter_pages() %&#125;</span><br><span class="line">                &#123;% if page %&#125;</span><br><span class="line">                    &#123;% if page != pagination.page %&#125;</span><br><span class="line">                        &lt;li class=&quot;&quot;&gt;</span><br><span class="line">                            &lt;a href=&quot;?page=&#123;&#123; page &#125;&#125;&amp;&#123;&#123; request.args|page_args &#125;&#125;&quot;&gt;&#123;&#123; page &#125;&#125;&lt;/a&gt;</span><br><span class="line">                        &lt;/li&gt;</span><br><span class="line">                    &#123;% else %&#125;</span><br><span class="line">                        &lt;li class=&quot;active&quot;&gt;</span><br><span class="line">                            &lt;a href=&quot;?page=&#123;&#123; page &#125;&#125;&amp;&#123;&#123; request.args|page_args &#125;&#125;&quot;&gt;&#123;&#123; page &#125;&#125;&lt;/a&gt;</span><br><span class="line">                        &lt;/li&gt;</span><br><span class="line">                    &#123;% endif %&#125;</span><br><span class="line">                &#123;% else %&#125;</span><br><span class="line">                    &lt;li class=&quot;disabled&quot;&gt;</span><br><span class="line">                        &lt;a&gt;......&lt;/a&gt;</span><br><span class="line">                    &lt;/li&gt;</span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">            &#123;%- endfor %&#125;</span><br><span class="line">            &#123;% if pagination.has_next %&#125;</span><br><span class="line">                &lt;li&gt;&lt;a href=&quot;?page=&#123;&#123; pagination.page + 1 &#125;&#125;&amp;&#123;&#123; request.args|page_args &#125;&#125;&quot;&gt;»&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">            &#123;% else %&#125;</span><br><span class="line">                &lt;li class=&quot;disabled&quot;&gt;&lt;a href=&quot;#&quot;&gt;»&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">            &#123;% endif %&#125;</span><br><span class="line">            &lt;li class=&quot;disabled&quot;&gt;</span><br><span class="line">                &lt;a style=&quot;color:black;&quot;&gt;共&#123;&#123; pagination.total_count &#125;&#125;条记录&lt;/a&gt;</span><br><span class="line">            &lt;/li&gt;</span><br><span class="line">        &lt;/ul&gt;</span><br><span class="line">    &lt;/nav&gt;</span><br><span class="line">&#123;% endmacro %&#125;</span><br></pre></td></tr></table></figure>



<h2 id="wtform的所有field"><a href="#wtform的所有field" class="headerlink" title="wtform的所有field"></a>wtform的所有field</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> TextAreaField, HiddenField, BooleanField, \</span><br><span class="line">    RadioField, PasswordField, SubmitField, TextField, \</span><br><span class="line">    DateField, IntegerField, SelectField, SelectMultipleField, \</span><br><span class="line">    FileField, DateTimeField, DecimalField, StringField, FloatField</span><br></pre></td></tr></table></figure>



<h2 id="Wtform的validate-on-submit-验证问题"><a href="#Wtform的validate-on-submit-验证问题" class="headerlink" title="Wtform的validate_on_submit()验证问题"></a>Wtform的validate_on_submit()验证问题</h2><ul>
<li>FlaskForm.validate_on_submit()验证问题 : FlaskForm使用validate()函数的时候FlaskForm.validators属性可能会失效</li>
<li>通过阅读源码得知 : FlaskForm.validate_on_submit()后台调用Field的validate() , 将extra_validators和FlaskForm的validators属性合成一个chain , 再调用_run_validation_chain()进行验证 . 所以当我们复写validate()的时候需要在函数里调用父类的validate(),保证FlaskForm.validators属性有效</li>
</ul>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>